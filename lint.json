[{"filePath":"D:\\zdqidongxiangmu\\app\\api\\analytics\\events\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[70,90],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[89,108],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type NextRequest, NextResponse } from \"next/server\"\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 重定向到统一的度量API\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const enrichedBody = {\n      ...body,\n      type: 'event'\n    }\n    \n    // 转发到新的统一API\n    const response = await fetch(new URL('/api/data/metrics', request.url).toString(), {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-forwarded-for': request.headers.get('x-forwarded-for') || '',\n        'x-real-ip': request.headers.get('x-real-ip') || ''\n      },\n      body: JSON.stringify(enrichedBody)\n    })\n    \n    const data = await response.json()\n    return NextResponse.json(data, { status: response.status })\n  } catch (error) {\n    void error\n    return NextResponse.json({ success: false, error: \"记录事件失败\" }, { status: 500 })\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  // 构建新的URL，添加type参数\n  const url = new URL('/api/data/metrics', request.url)\n  url.searchParams.set('type', 'event')\n  \n  // 复制原有参数\n  const { searchParams } = new URL(request.url)\n  searchParams.forEach((value, key) => {\n    if (key !== 'type') {\n      url.searchParams.set(key, value)\n    }\n  })\n  \n  // 重定向到新API\n  return NextResponse.redirect(url, 301)\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\analytics\\metrics\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[70,90],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[89,108],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type NextRequest, NextResponse } from \"next/server\"\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 重定向到统一的度量API\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const enrichedBody = {\n      ...body,\n      type: 'metric'\n    }\n    \n    // 转发到新的统一API\n    const response = await fetch(new URL('/api/data/metrics', request.url).toString(), {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(enrichedBody)\n    })\n    \n    const data = await response.json()\n    return NextResponse.json(data, { status: response.status })\n  } catch (error) {\n    void error\n    return NextResponse.json({ success: false, error: \"记录指标失败\" }, { status: 500 })\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  // 构建新的URL，添加type参数\n  const url = new URL('/api/data/metrics', request.url)\n  url.searchParams.set('type', 'metric')\n  \n  // 复制原有参数\n  const { searchParams } = new URL(request.url)\n  searchParams.forEach((value, key) => {\n    if (key !== 'type') {\n      url.searchParams.set(key, value)\n    }\n  })\n  \n  // 重定向到新API\n  return NextResponse.redirect(url, 301)\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\auth\\verify-invite-code\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[103,123],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[122,141],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\nimport { \n  getClientIP,\n  isIPLocked,\n  checkRateLimit,\n  recordFailedAttempt,\n  clearAttempts,\n  logVerificationAttempt,\n  validateInviteCodeFormat\n} from '@/lib/security/invite-code-security'\n\nexport async function POST(request: NextRequest) {\n  try {\n    // 1. 获取客户端IP（哈希处理）\n    const ipHash = getClientIP(request)\n    const userAgent = request.headers.get('user-agent') || ''\n    \n    // 2. 检查IP是否被锁定\n    if (isIPLocked(ipHash)) {\n      await logVerificationAttempt(ipHash, '***locked***', false, userAgent)\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Too many failed attempts. Please try again later.',\n          lockedUntil: new Date(Date.now() + 15 * 60 * 1000).toISOString()\n        },\n        { status: 403 }\n      )\n    }\n    \n    // 3. 检查速率限制\n    if (!checkRateLimit(ipHash)) {\n      await logVerificationAttempt(ipHash, '***rate-limited***', false, userAgent)\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Too many requests. Please slow down.',\n          retryAfter: 60 // 秒\n        },\n        { status: 429 }\n      )\n    }\n    \n    // 4. 获取请求数据\n    const { inviteCode, captchaToken } = await request.json()\n    void captchaToken // 为未来验证码功能预留，暂时未使用\n    \n    if (!inviteCode) {\n      return NextResponse.json(\n        { success: false, error: 'Invite code is required' },\n        { status: 400 }\n      )\n    }\n    \n    // 5. 验证邀请码格式（包括校验和）\n    if (!validateInviteCodeFormat(inviteCode)) {\n      recordFailedAttempt(ipHash)\n      await logVerificationAttempt(ipHash, inviteCode, false, userAgent)\n      \n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Invalid invite code format',\n          remainingAttempts: Math.max(0, 5 - (await getAttemptCount(ipHash)))\n        },\n        { status: 400 }\n      )\n    }\n    \n    // 6. TODO: 验证验证码（如果需要）\n    // if (captchaToken) {\n    //   const captchaValid = await verifyCaptcha(captchaToken)\n    //   if (!captchaValid) {\n    //     return NextResponse.json(\n    //       { success: false, error: 'Invalid captcha' },\n    //       { status: 400 }\n    //     )\n    //   }\n    // }\n    \n    // 7. 查询数据库验证邀请码\n    const invite = await prisma.inviteCode.findUnique({\n      where: { code: inviteCode },\n      select: {\n        id: true,\n        code: true,\n        isActive: true,\n        maxUses: true,\n        usedCount: true,\n        expiresAt: true,\n        defaultRole: true,\n        monthlyTokenLimit: true,\n        description: true\n      }\n    })\n    \n    // 8. 验证邀请码有效性\n    if (!invite) {\n      recordFailedAttempt(ipHash)\n      await logVerificationAttempt(ipHash, inviteCode, false, userAgent)\n      \n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Invalid or expired invite code',\n          remainingAttempts: Math.max(0, 5 - (await getAttemptCount(ipHash)))\n        },\n        { status: 400 }\n      )\n    }\n    \n    // 检查是否激活\n    if (!invite.isActive) {\n      recordFailedAttempt(ipHash)\n      await logVerificationAttempt(ipHash, inviteCode, false, userAgent)\n      \n      return NextResponse.json(\n        { success: false, error: 'This invite code has been deactivated' },\n        { status: 400 }\n      )\n    }\n    \n    // 检查使用次数\n    if (invite.usedCount >= invite.maxUses) {\n      recordFailedAttempt(ipHash)\n      await logVerificationAttempt(ipHash, inviteCode, false, userAgent)\n      \n      return NextResponse.json(\n        { success: false, error: 'This invite code has reached its usage limit' },\n        { status: 400 }\n      )\n    }\n    \n    // 检查过期时间\n    if (invite.expiresAt && new Date() > invite.expiresAt) {\n      recordFailedAttempt(ipHash)\n      await logVerificationAttempt(ipHash, inviteCode, false, userAgent)\n      \n      return NextResponse.json(\n        { success: false, error: 'This invite code has expired' },\n        { status: 400 }\n      )\n    }\n    \n    // 9. 验证成功，清除失败记录\n    clearAttempts(ipHash)\n    await logVerificationAttempt(ipHash, inviteCode, true, userAgent)\n    \n    // 10. 返回成功响应（不包含敏感信息）\n    return NextResponse.json({\n      success: true,\n      data: {\n        valid: true,\n        remainingUses: invite.maxUses - invite.usedCount,\n        description: invite.description,\n        // 生成临时令牌，用于注册时验证\n        registrationToken: generateRegistrationToken(invite.id, ipHash)\n      }\n    })\n    \n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n// 获取尝试次数（简化版，实际应从缓存获取）\nasync function getAttemptCount(_ipHash: string): Promise<number> {\n  // 这里应该从Redis或内存缓存获取\n  // 暂时返回模拟值\n  return 0\n}\n\n// 生成注册令牌\nfunction generateRegistrationToken(inviteId: string, ipHash: string): string {\n  // 生成一个临时令牌，包含邀请码ID和IP哈希\n  // 实际实现应该使用JWT或加密\n  const crypto = require('crypto')\n  const data = `${inviteId}:${ipHash}:${Date.now()}`\n  const signature = crypto\n    .createHash('sha256')\n    .update(data + process.env.NEXTAUTH_SECRET)\n    .digest('hex')\n  \n  return Buffer.from(`${data}:${signature}`).toString('base64')\n}\n\n// OPTIONS请求处理（CORS）\nexport async function OPTIONS(_request: NextRequest) {\n  return new NextResponse(null, {\n    status: 200,\n    headers: {\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'POST, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type',\n    },\n  })\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\chat\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'getTodayDate' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":40,"suggestions":[{"messageId":"removeVar","data":{"varName":"getTodayDate"},"fix":{"range":[317,331],"text":""},"desc":"Remove unused variable 'getTodayDate'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { NextRequest } from \"next/server\"\r\nimport { ALLOWED_MODEL_IDS } from \"@/lib/ai/models\"\r\nimport { validateModelId } from \"@/lib/model-validator\"\r\nimport { selectApiKey } from \"@/lib/ai/key-manager\"\r\nimport { prisma } from \"@/lib/prisma\"\r\nimport { getToken } from \"next-auth/jwt\"\r\nimport { getModelProvider, getTodayDate } from \"@/lib/ai/model-stats-helper\"\r\nimport { createSafeContextMessage, validateMessageContent } from \"@/lib/security/content-filter\"\r\nimport { checkMultipleRateLimits } from \"@/lib/security/rate-limiter\"\r\nimport { createErrorResponse } from \"@/lib/api/error-handler\"\r\nimport { recordUsageAsync } from \"@/lib/utils/usage-stats-helper\"\r\n\r\n// 支持 GET 方法用于健康检查\r\nexport async function GET() {\r\n  return new Response(JSON.stringify({ status: \"ok\" }), {\r\n    status: 200,\r\n    headers: { \"Content-Type\": \"application/json\" }\r\n  })\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  const startedAt = Date.now()\r\n  let conversationId: string | null = null\r\n  let userId: string | null = null\r\n  let _userMessage: any = null\r\n  let assistantMessage: any = null\r\n  let tokenUsage = { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 }\r\n  let model: string = 'unknown'\r\n  \r\n  try {\r\n    // 认证检查\r\n    const token = await getToken({ req: request as any })\r\n    if (!token?.sub) {\r\n      return new Response(JSON.stringify({ error: \"未认证\" }), { status: 401, headers: { \"Content-Type\": \"application/json\" } })\r\n    }\r\n\r\n    userId = String(token.sub)\r\n    \r\n    // 速率限制检查 - 检查聊天和全局IP限制\r\n    const rateLimitCheck = checkMultipleRateLimits(request, ['CHAT', 'GLOBAL_IP'], userId)\r\n    if (!rateLimitCheck.allowed && rateLimitCheck.error) {\r\n      return createErrorResponse(rateLimitCheck.error)\r\n    }\r\n\r\n    const requestBody = await request.json()\r\n    \r\n    const {\r\n      messages = [],\r\n      model: requestModel,\r\n      temperature,\r\n      editorExcerpt,\r\n      conversationId: reqConversationId\r\n    } = requestBody\r\n\r\n    conversationId = reqConversationId\r\n    model = requestModel || 'unknown'\r\n    // 使用新的模型验证器\r\n    const modelValidation = validateModelId(model)\r\n    if (!modelValidation.isValid) {\r\n      return new Response(\r\n        JSON.stringify({\r\n          error: `模型验证失败: ${modelValidation.errors.join(', ')}`,\r\n          allowedModels: ALLOWED_MODEL_IDS,\r\n          suggestions: modelValidation.warnings\r\n        }),\r\n        { status: 400, headers: { \"Content-Type\": \"application/json\" } }\r\n      )\r\n    }\r\n\r\n    const useModel: string = requestModel\r\n\r\n    // 若未提供 conversationId，自动为当前用户创建对话（容错，保证后续持久化）\r\n    if (userId && !conversationId) {\r\n      try {\r\n        const created = await prisma.conversation.create({\r\n          data: {\r\n            userId,\r\n            modelId: model, // 使用已通过白名单校验后的模型名\r\n            temperature: typeof temperature === 'number' ? temperature : 0.7,\r\n            lastMessageAt: new Date(),\r\n          },\r\n          select: { id: true },\r\n        })\r\n        conversationId = created.id\r\n      } catch (e) {\r\n        void e\r\n        // 自动创建失败不应阻断后续用量统计\r\n      }\r\n    }\r\n\r\n    // 如果提供了 userId 和 conversationId，验证对话权限\r\n    if (userId && conversationId) {\r\n      const conversation = await prisma.conversation.findUnique({\r\n        where: { id: conversationId },\r\n        include: { user: true }\r\n      })\r\n\r\n      if (!conversation || conversation.userId !== userId) {\r\n        return new Response(\r\n          JSON.stringify({ error: \"对话不存在或无权访问\" }),\r\n          { status: 404, headers: { \"Content-Type\": \"application/json\" } }\r\n        )\r\n      }\r\n\r\n      // 检查用户状态和配额\r\n      if (conversation.user.status !== 'ACTIVE') {\r\n        return new Response(\r\n          JSON.stringify({ error: \"用户账户异常\" }),\r\n          { status: 403, headers: { \"Content-Type\": \"application/json\" } }\r\n        )\r\n      }\r\n\r\n      if (conversation.user.currentMonthUsage >= conversation.user.monthlyTokenLimit) {\r\n        return new Response(\r\n          JSON.stringify({ error: \"月度配额已用完\" }),\r\n          { status: 429, headers: { \"Content-Type\": \"application/json\" } }\r\n        )\r\n      }\r\n    }\r\n\r\n    // 验证和处理用户消息\r\n    let validatedMessages = messages\r\n    if (messages.length > 0) {\r\n      validatedMessages = messages.map((msg: any) => {\r\n        if (msg.role === 'user') {\r\n          const validation = validateMessageContent(msg.content)\r\n          if (!validation.isValid) {\r\n            // Invalid user message filtered - validation warnings logged internally\r\n            return { ...msg, content: '消息内容不符合安全规范，已被过滤' }\r\n          }\r\n          return { ...msg, content: validation.filteredContent }\r\n        }\r\n        return msg\r\n      })\r\n    }\r\n\r\n    // 如果提供了对话信息，保存用户消息到数据库\r\n    if (userId && conversationId && validatedMessages.length > 0) {\r\n      const latestMessage = validatedMessages[validatedMessages.length - 1]\r\n      if (latestMessage.role === 'user') {\r\n        _userMessage = await prisma.message.create({\r\n          data: {\r\n            conversationId,\r\n            role: 'USER',\r\n            content: latestMessage.content,\r\n            modelId: useModel,\r\n            temperature: temperature || null,\r\n          }\r\n        })\r\n      }\r\n    }\r\n\r\n    // 安全处理编辑器上下文（使用内容过滤防止注入）\r\n    const safeContextMessage = editorExcerpt ? createSafeContextMessage(editorExcerpt) : null\r\n    const sysMessages = safeContextMessage ? [safeContextMessage] : []\r\n\r\n    const finalMessages = [...sysMessages, ...validatedMessages]\r\n\r\n    // 多KEY模式：根据模型自动选择最合适的API Key\r\n    const base = (process.env.LLM_API_BASE || \"https://api.302.ai/v1\").replace(/\\/$/, \"\")\r\n    const keySelection = selectApiKey(useModel)\r\n    \r\n    if (!keySelection.apiKey) {\r\n      const errorMsg = keySelection.keySource === 'none' \r\n        ? `未配置模型 ${useModel} 对应的API Key` \r\n        : \"后端API Key配置错误\"\r\n      return new Response(JSON.stringify({ \r\n        error: errorMsg,\r\n        modelId: useModel,\r\n        suggestion: `请配置 ${useModel} 对应供应商的API Key`\r\n      }), {\r\n        status: 500,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      })\r\n    }\r\n\r\n    const apiKey = keySelection.apiKey\r\n\r\n    // 默认使用 /chat/completions（Gemini 已验证可用；多数聚合模型也兼容）\r\n    let endpoint = `${base}/chat/completions`\r\n\r\n    // 若后续确认某些 Claude 需要走 /messages，可在此处根据前缀切换：\r\n    // if (useModel.startsWith(\"claude-\")) endpoint = `${base}/messages`\r\n\r\n    const payload: Record<string, any> = {\r\n      model: useModel,\r\n      messages: finalMessages,\r\n      stream: true,\r\n    }\r\n    if (typeof temperature === \"number\") payload.temperature = temperature\r\n    \r\n\r\n\r\n    // 添加超时控制\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), 25000) // 25秒超时\r\n\r\n    let upstream: Response\r\n    try {\r\n      upstream = await fetch(endpoint, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Authorization\": `Bearer ${apiKey}`,\r\n          \"Content-Type\": \"application/json\",\r\n          // 接受 SSE\r\n          \"Accept\": \"text/event-stream\",\r\n        },\r\n        body: JSON.stringify(payload),\r\n        signal: controller.signal,\r\n      })\r\n      clearTimeout(timeoutId)\r\n    } catch (fetchError: any) {\r\n      clearTimeout(timeoutId)\r\n      if (fetchError.name === 'AbortError') {\r\n        return new Response(JSON.stringify({ \r\n          error: \"AI服务响应超时，请稍后重试\", \r\n          retryable: true,\r\n          timeout: \"25s\"\r\n        }), {\r\n          status: 408,\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n        })\r\n      }\r\n      return new Response(JSON.stringify({ \r\n        error: \"AI服务连接失败，请检查网络\", \r\n        retryable: true \r\n      }), {\r\n        status: 502,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      })\r\n    }\r\n\r\n    // 非 2xx：尝试解析错误并向前端统一返回\r\n    if (!upstream.ok) {\r\n      let errBody: any = null\r\n      try {\r\n        errBody = await upstream.json()\r\n      } catch {\r\n        errBody = { error: `Upstream error ${upstream.status}` }\r\n      }\r\n      const status = upstream.status === 429 ? 429 : upstream.status || 500\r\n      return new Response(JSON.stringify(errBody), {\r\n        status,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      })\r\n    }\r\n\r\n    // 处理 SSE 流并收集响应内容\r\n    if (!upstream.body) {\r\n      return new Response(JSON.stringify({ error: \"上游无响应体\" }), {\r\n        status: 502,\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n      })\r\n    }\r\n\r\n    // 移除预记录，改为请求完成后统一记录\r\n    // 这样可以减少50%的数据库写入操作\r\n\r\n    const headers = new Headers()\r\n    headers.set(\"Content-Type\", upstream.headers.get(\"Content-Type\") || \"text/event-stream\")\r\n    headers.set(\"Cache-Control\", \"no-cache\")\r\n    headers.set(\"Connection\", \"keep-alive\")\r\n\r\n    // 创建转换流来拦截并保存响应\r\n    let assistantContent = \"\"\r\n    let isComplete = false\r\n\r\n    const transformStream = new TransformStream({\r\n      transform(chunk, controller) {\r\n        const text = new TextDecoder().decode(chunk)\r\n        const lines = text.split('\\n')\r\n        \r\n        for (const line of lines) {\r\n          if (line.startsWith('data: ')) {\r\n            try {\r\n              const data = line.slice(6).trim()\r\n              if (data === '[DONE]') {\r\n                isComplete = true\r\n              } else {\r\n                const parsed = JSON.parse(data)\r\n                if (parsed.choices && parsed.choices[0] && parsed.choices[0].delta) {\r\n                  const delta = parsed.choices[0].delta\r\n                  if (delta.content) {\r\n                    assistantContent += delta.content\r\n                  }\r\n                  if (parsed.choices[0].finish_reason) {\r\n                    isComplete = true\r\n                  }\r\n                }\r\n                // 保存 token 使用信息\r\n                if (parsed.usage) {\r\n                  tokenUsage = parsed.usage\r\n                }\r\n              }\r\n            } catch (e) {\r\n              void e\r\n              // 忽略解析错误\r\n            }\r\n          }\r\n        }\r\n        \r\n        controller.enqueue(chunk)\r\n      },\r\n      flush() {\r\n        // 流结束后保存 AI 响应到数据库\r\n        if (userId && assistantContent && isComplete) {\r\n          // 异步保存，不阻塞响应\r\n          saveAssistantMessage()\r\n        }\r\n      }\r\n    })\r\n\r\n    // 异步保存助手消息的函数\r\n    const saveAssistantMessage = async () => {\r\n      try {\r\n        if (!userId) return\r\n\r\n        // 保存 AI 响应（需要存在对话ID）\r\n        if (conversationId) {\r\n          assistantMessage = await prisma.message.create({\r\n            data: {\r\n              conversationId,\r\n              role: 'ASSISTANT',\r\n              content: assistantContent,\r\n              modelId: useModel,\r\n              temperature: temperature || null,\r\n              promptTokens: tokenUsage.prompt_tokens || 0,\r\n              completionTokens: tokenUsage.completion_tokens || 0,\r\n              totalTokens: tokenUsage.total_tokens || 0,\r\n              finishReason: 'stop',\r\n            }\r\n          })\r\n        }\r\n\r\n        // 更新用户用量统计\r\n        await prisma.user.update({\r\n          where: { id: userId },\r\n          data: {\r\n            currentMonthUsage: {\r\n              increment: tokenUsage.total_tokens || 0\r\n            },\r\n            totalTokenUsed: {\r\n              increment: tokenUsage.total_tokens || 0\r\n            },\r\n            lastActiveAt: new Date(),\r\n          }\r\n        })\r\n\r\n        // 若存在对话，则更新对话统计\r\n        if (conversationId) {\r\n          await prisma.conversation.update({\r\n            where: { id: conversationId },\r\n            data: {\r\n              messageCount: { increment: assistantMessage ? 2 : 1 }, // 用户消息 + AI 消息\r\n              totalTokens: { increment: tokenUsage.total_tokens || 0 },\r\n              lastMessageAt: new Date(),\r\n              updatedAt: new Date(),\r\n            }\r\n          })\r\n        }\r\n\r\n        // 异步记录使用量统计（简单优雅）\r\n        const modelProvider = getModelProvider(useModel)\r\n        recordUsageAsync(prisma, {\r\n          userId: userId,\r\n          modelId: useModel,\r\n          modelProvider: modelProvider,\r\n          promptTokens: tokenUsage.prompt_tokens || 0,\r\n          completionTokens: tokenUsage.completion_tokens || 0,\r\n          totalTokens: tokenUsage.total_tokens || 0,\r\n          messagesCreated: conversationId ? 2 : 0,\r\n          success: true\r\n        })\r\n\r\n      } catch (error) {\r\n        void error\r\n        // 不抛出错误，避免影响用户体验\r\n      }\r\n    }\r\n\r\n    return new Response(upstream.body.pipeThrough(transformStream), { \r\n      status: 200, \r\n      headers \r\n    })\r\n    \r\n    \r\n  } catch (error: any) {\r\n    // 记录失败统计（简单异步）\r\n    if (userId && model !== 'unknown') {\r\n      const modelProvider = getModelProvider(model)\r\n      recordUsageAsync(prisma, {\r\n        userId: userId,\r\n        modelId: model,\r\n        modelProvider: modelProvider,\r\n        success: false\r\n      })\r\n    }\r\n    \r\n    const payload = { error: error?.message || \"请求处理失败\" }\r\n    return new Response(JSON.stringify(payload), { status: 500, headers: { \"Content-Type\": \"application/json\" } })\r\n  } finally {\r\n    const _cost = Date.now() - startedAt\r\n    // Request completed - timing logged internally\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\conversations\\[id]\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[144,164],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[163,182],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { getToken } from 'next-auth/jwt'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 获取单个对话详情（包含消息，受保护）\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) return NextResponse.json({ error: '未认证' }, { status: 401 })\n    \n    const userId = String(token.sub)\n    const { id } = await params\n    const { searchParams } = new URL(request.url)\n    const includeMessages = searchParams.get('includeMessages') !== 'false'\n    \n    const conversation = await prisma.conversation.findUnique({\n      where: { id },\n      include: {\n        user: {\n          select: {\n            id: true,\n            displayName: true,\n            email: true,\n            status: true,\n          }\n        },\n        messages: includeMessages ? {\n          orderBy: { createdAt: 'asc' },\n          select: {\n            id: true,\n            role: true,\n            content: true,\n            promptTokens: true,\n            completionTokens: true,\n            totalTokens: true,\n            modelId: true,\n            temperature: true,\n            finishReason: true,\n            metadata: true,\n            createdAt: true,\n          }\n        } : false,\n        _count: {\n          select: {\n            messages: true\n          }\n        }\n      }\n    })\n    \n    if (!conversation) {\n      return NextResponse.json(\n        { error: '对话不存在' },\n        { status: 404 }\n      )\n    }\n    \n    // 验证用户权限\n    if (conversation.userId !== userId) {\n      return NextResponse.json(\n        { error: '无权限访问此对话' },\n        { status: 403 }\n      )\n    }\n    \n    // 检查用户状态\n    if (conversation.user.status === 'DELETED') {\n      return NextResponse.json(\n        { error: '对话所属用户已被删除' },\n        { status: 404 }\n      )\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: conversation\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '获取对话详情失败' },\n      { status: 500 }\n    )\n  }\n}\n\n// 更新对话\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) return NextResponse.json({ error: '未认证' }, { status: 401 })\n    \n    const userId = String(token.sub)\n    const { id } = await params\n    const body = await request.json()\n    const { title, modelId, temperature, maxTokens, contextAware } = body\n    \n    // 检查对话是否存在并验证所有权\n    const existingConversation = await prisma.conversation.findUnique({\n      where: { id },\n      include: {\n        user: {\n          select: { id: true, status: true }\n        }\n      }\n    })\n    \n    if (!existingConversation) {\n      return NextResponse.json(\n        { error: '对话不存在' },\n        { status: 404 }\n      )\n    }\n    \n    // 验证用户权限\n    if (existingConversation.userId !== userId) {\n      return NextResponse.json(\n        { error: '无权限操作此对话' },\n        { status: 403 }\n      )\n    }\n    \n    if (existingConversation.user.status === 'DELETED') {\n      return NextResponse.json(\n        { error: '对话所属用户已被删除' },\n        { status: 404 }\n      )\n    }\n    \n    // 更新对话\n    const updatedConversation = await prisma.conversation.update({\n      where: { id },\n      data: {\n        title,\n        modelId,\n        temperature,\n        maxTokens,\n        contextAware,\n        updatedAt: new Date(),\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            displayName: true,\n            email: true,\n          }\n        }\n      }\n    })\n    \n    return NextResponse.json({\n      success: true,\n      data: updatedConversation,\n      message: '对话更新成功'\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '更新对话失败' },\n      { status: 500 }\n    )\n  }\n}\n\n// 删除对话\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) return NextResponse.json({ error: '未认证' }, { status: 401 })\n    \n    const userId = String(token.sub)\n    const { id } = await params\n    \n    // 检查对话是否存在并验证所有权\n    const existingConversation = await prisma.conversation.findUnique({\n      where: { id },\n      include: {\n        user: {\n          select: { id: true, status: true }\n        }\n      }\n    })\n    \n    if (!existingConversation) {\n      return NextResponse.json(\n        { error: '对话不存在' },\n        { status: 404 }\n      )\n    }\n    \n    // 验证用户权限\n    if (existingConversation.userId !== userId) {\n      return NextResponse.json(\n        { error: '无权限操作此对话' },\n        { status: 403 }\n      )\n    }\n    \n    // 删除对话（级联删除消息）\n    await prisma.conversation.delete({\n      where: { id }\n    })\n    \n    return NextResponse.json({\n      success: true,\n      message: '对话删除成功'\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '删除对话失败' },\n      { status: 500 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\conversations\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[144,164],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[163,182],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { getToken } from 'next-auth/jwt'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 获取对话列表（受保护）\nexport async function GET(request: NextRequest) {\n  try {\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) return NextResponse.json({ error: '未认证' }, { status: 401 })\n\n    const { searchParams } = new URL(request.url)\n    const page = parseInt(searchParams.get('page') || '1')\n    const limit = parseInt(searchParams.get('limit') || '20')\n    const userId = String(token.sub)\n\n    // userId 从 token 解析，无需校验查询参数\n    \n    const skip = (page - 1) * limit\n    \n    // 获取对话列表\n    const conversations = await prisma.conversation.findMany({\n      where: {\n        userId,\n        user: {\n          status: { not: 'DELETED' }\n        }\n      },\n      select: {\n        id: true,\n        title: true,\n        modelId: true,\n        temperature: true,\n        messageCount: true,\n        totalTokens: true,\n        createdAt: true,\n        updatedAt: true,\n        lastMessageAt: true,\n        user: {\n          select: {\n            id: true,\n            displayName: true,\n            email: true,\n          }\n        }\n      },\n      orderBy: [\n        { lastMessageAt: 'desc' },\n        { updatedAt: 'desc' }\n      ],\n      skip,\n      take: limit,\n    })\n    \n    // 获取总数\n    const total = await prisma.conversation.count({\n      where: {\n        userId,\n        user: {\n          status: { not: 'DELETED' }\n        }\n      }\n    })\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        conversations,\n        pagination: {\n          page,\n          limit,\n          total,\n          pages: Math.ceil(total / limit)\n        }\n      }\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '获取对话列表失败' },\n      { status: 500 }\n    )\n  }\n}\n\n// 创建新对话（受保护）\nexport async function POST(request: NextRequest) {\n  try {\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) return NextResponse.json({ error: '未认证' }, { status: 401 })\n\n    const body = await request.json()\n    const {\n      title = '新对话',\n      modelId = 'gpt-3.5-turbo',\n      temperature = 0.7,\n      maxTokens = 2000,\n      contextAware = true\n    } = body\n\n    const userId = String(token.sub)\n\n    // 检查用户是否存在\n    const user = await prisma.user.findUnique({\n      where: { id: userId }\n    })\n    \n    if (!user || user.status === 'DELETED') {\n      return NextResponse.json(\n        { error: '用户不存在或已被删除' },\n        { status: 404 }\n      )\n    }\n    \n    // 创建对话\n    const conversation = await prisma.conversation.create({\n      data: {\n        title,\n        userId,\n        modelId,\n        temperature,\n        maxTokens,\n        contextAware,\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            displayName: true,\n            email: true,\n          }\n        }\n      }\n    })\n    \n    return NextResponse.json({\n      success: true,\n      data: conversation,\n      message: '对话创建成功'\n    }, { status: 201 })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '创建对话失败' },\n      { status: 500 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\data\\metrics\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[150,170],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[169,188],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { getServerSession } from 'next-auth';\nimport { authOptions } from '@/auth';\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 统一的度量存储（实际项目应使用数据库）\nconst metricsStore = {\n  events: [] as any[],\n  metrics: [] as any[],\n  maxEvents: 10000,\n  maxMetrics: 50000\n};\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getServerSession(authOptions);\n    const body = await request.json();\n    const { type, ...data } = body;\n\n    // 根据类型处理不同的度量\n    switch (type) {\n      case 'event':\n        return handleEvent(data, request);\n      case 'metric':\n      case 'performance':\n        return handleMetric(data);\n      case 'usage':\n        return handleUsage(data, session?.user?.id);\n      default:\n        // 兼容旧API：如果没有type，尝试自动识别\n        if (data.eventType || data.eventName) {\n          return handleEvent(data, request);\n        }\n        if (data.metricType || data.value !== undefined) {\n          return handleMetric(data);\n        }\n        // 默认作为日志处理\n        return NextResponse.json({ ok: true, success: true });\n    }\n  } catch (error) {\n    return NextResponse.json({ \n      success: false, \n      error: error instanceof Error ? error.message : '处理度量失败' \n    }, { status: 500 });\n  }\n}\n\nfunction handleEvent(data: any, request: NextRequest) {\n  const ip = request.headers.get('x-forwarded-for') || \n             request.headers.get('x-real-ip') || \n             'unknown';\n\n  const enrichedEvent = {\n    ...data,\n    ip,\n    id: `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    timestamp: data.timestamp || new Date().toISOString(),\n    type: 'event'\n  };\n\n  metricsStore.events.push(enrichedEvent);\n\n  // 限制存储大小\n  if (metricsStore.events.length > metricsStore.maxEvents) {\n    metricsStore.events.splice(0, metricsStore.events.length - metricsStore.maxEvents);\n  }\n\n  return NextResponse.json({ \n    success: true, \n    eventId: enrichedEvent.id,\n    ok: true // 兼容旧API\n  });\n}\n\nfunction handleMetric(data: any) {\n  const enrichedMetric = {\n    ...data,\n    id: `metric_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    timestamp: data.timestamp || new Date().toISOString(),\n    type: 'metric'\n  };\n\n  metricsStore.metrics.push(enrichedMetric);\n\n  // 限制存储大小\n  if (metricsStore.metrics.length > metricsStore.maxMetrics) {\n    metricsStore.metrics.splice(0, metricsStore.metrics.length - metricsStore.maxMetrics);\n  }\n\n  return NextResponse.json({ \n    success: true, \n    metricId: enrichedMetric.id,\n    ok: true // 兼容旧API\n  });\n}\n\nasync function handleUsage(data: any, userId?: string) {\n  // 使用量统计逻辑（后续可接入数据库）\n  const usageRecord = {\n    ...data,\n    userId,\n    id: `usage_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n    timestamp: new Date().toISOString(),\n    type: 'usage'\n  };\n\n  // 这里可以保存到数据库\n  // await prisma.dailyUsage.upsert(...)\n\n  return NextResponse.json({ \n    success: true, \n    usageId: usageRecord.id,\n    ok: true\n  });\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const dataType = searchParams.get('type') || searchParams.get('dataType');\n    const metricType = searchParams.get('metricType');\n    const eventType = searchParams.get('eventType');\n    const timeRange = searchParams.get('timeRange') || '24h';\n    const limit = parseInt(searchParams.get('limit') || '100');\n    const offset = parseInt(searchParams.get('offset') || '0');\n\n    // 计算时间范围\n    const now = new Date();\n    let startTime: Date;\n\n    switch (timeRange) {\n      case '1h':\n        startTime = new Date(now.getTime() - 60 * 60 * 1000);\n        break;\n      case '24h':\n        startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n        break;\n      case '7d':\n        startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n        break;\n      case '30d':\n        startTime = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n        break;\n      default:\n        startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n    }\n\n    let result: any = {\n      success: true,\n      ok: true,\n      data: {}\n    };\n\n    // 根据请求类型返回不同数据\n    if (dataType === 'event' || eventType) {\n      let filteredEvents = metricsStore.events.filter(\n        event => new Date(event.timestamp) >= startTime\n      );\n      \n      if (eventType) {\n        filteredEvents = filteredEvents.filter(e => e.eventType === eventType);\n      }\n\n      const paginatedEvents = filteredEvents\n        .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())\n        .slice(offset, offset + limit);\n\n      result.data = {\n        events: paginatedEvents,\n        total: filteredEvents.length,\n        hasMore: offset + limit < filteredEvents.length\n      };\n    } else if (dataType === 'metric' || metricType) {\n      let filteredMetrics = metricsStore.metrics.filter(\n        metric => new Date(metric.timestamp) >= startTime\n      );\n      \n      if (metricType) {\n        filteredMetrics = filteredMetrics.filter(m => m.metricType === metricType);\n      }\n\n      // 计算统计信息\n      const values = filteredMetrics.map(m => m.value || 0);\n      const stats = {\n        count: values.length,\n        avg: values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0,\n        min: values.length > 0 ? Math.min(...values) : 0,\n        max: values.length > 0 ? Math.max(...values) : 0\n      };\n\n      result.data = {\n        metrics: filteredMetrics.sort((a, b) => \n          new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()\n        ),\n        stats,\n        timeRange\n      };\n    } else {\n      // 返回所有数据的摘要\n      result.data = {\n        summary: {\n          totalEvents: metricsStore.events.length,\n          totalMetrics: metricsStore.metrics.length,\n          timeRange\n        }\n      };\n    }\n\n    return NextResponse.json(result);\n  } catch (error) {\n    return NextResponse.json({ \n      success: false,\n      ok: false,\n      error: error instanceof Error ? error.message : '获取数据失败' \n    }, { status: 500 });\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\debug\\ai-test\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'request' is defined but never used. Allowed unused args must match /^_/u.","line":5,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"request"},"fix":{"range":[139,159],"text":""},"desc":"Remove unused variable 'request'."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":20,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":20,"endColumn":16,"suggestions":[{"fix":{"range":[663,717],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":21,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":21,"endColumn":16,"suggestions":[{"fix":{"range":[723,784],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":22,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":22,"endColumn":16,"suggestions":[{"fix":{"range":[790,830],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":52,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":52,"endColumn":16,"suggestions":[{"fix":{"range":[1620,1705],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":93,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":93,"endColumn":18,"suggestions":[{"fix":{"range":[2696,2736],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest } from \"next/server\"\r\nimport { selectApiKey } from \"@/lib/ai/key-manager\"\r\n\r\n// 直接测试AI服务连接\r\nexport async function GET(request: NextRequest) {\r\n  if (process.env.NODE_ENV === 'production') {\r\n    return new Response('Not available in production', { status: 403 })\r\n  }\r\n\r\n  const model = 'claude-opus-4-1-20250805'\r\n  const testMessage = [{ role: 'user', content: '简单测试：1+1等于多少？' }]\r\n\r\n  try {\r\n    // 获取API配置\r\n    const base = (process.env.LLM_API_BASE || \"https://api.302.ai/v1\").replace(/\\/$/, \"\")\r\n    const keySelection = selectApiKey(model)\r\n    const apiKey = keySelection.apiKey\r\n    const endpoint = `${base}/chat/completions`\r\n\r\n    console.log(`[AI-TEST] Testing endpoint: ${endpoint}`)\r\n    console.log(`[AI-TEST] Using key: ${apiKey.slice(0, 10)}...`)\r\n    console.log(`[AI-TEST] Model: ${model}`)\r\n\r\n    const payload = {\r\n      model: model,\r\n      messages: testMessage,\r\n      stream: false, // 简单模式，不使用流\r\n      max_tokens: 100\r\n    }\r\n\r\n    const startTime = Date.now()\r\n    \r\n    // Windows环境下的Node.js fetch问题修复\r\n    const fetchOptions: RequestInit = {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Authorization\": `Bearer ${apiKey}`,\r\n        \"Content-Type\": \"application/json\",\r\n        \"User-Agent\": \"Mozilla/5.0 (compatible; ZhidianAI/1.0)\",\r\n      },\r\n      body: JSON.stringify(payload),\r\n      signal: AbortSignal.timeout(15000), // 15秒超时\r\n      keepalive: false,\r\n      redirect: 'follow',\r\n      // @ts-ignore - Node.js特定选项\r\n      agent: false\r\n    }\r\n    \r\n    const response = await fetch(endpoint, fetchOptions)\r\n\r\n    const duration = Date.now() - startTime\r\n    console.log(`[AI-TEST] Response status: ${response.status}, duration: ${duration}ms`)\r\n\r\n    if (!response.ok) {\r\n      let errorBody: any = null\r\n      try {\r\n        errorBody = await response.json()\r\n      } catch {\r\n        errorBody = await response.text()\r\n      }\r\n      \r\n      return new Response(JSON.stringify({\r\n        success: false,\r\n        status: response.status,\r\n        statusText: response.statusText,\r\n        duration,\r\n        error: errorBody,\r\n        endpoint,\r\n        model,\r\n        keyProvider: keySelection.provider\r\n      }, null, 2), {\r\n        status: 200,\r\n        headers: { 'Content-Type': 'application/json' }\r\n      })\r\n    }\r\n\r\n    const responseData = await response.json()\r\n    \r\n    return new Response(JSON.stringify({\r\n      success: true,\r\n      status: response.status,\r\n      duration,\r\n      response: responseData,\r\n      endpoint,\r\n      model,\r\n      keyProvider: keySelection.provider\r\n    }, null, 2), {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    })\r\n\r\n  } catch (error: any) {\r\n    console.error('[AI-TEST] Error:', error)\r\n    \r\n    return new Response(JSON.stringify({\r\n      success: false,\r\n      error: error.message,\r\n      stack: error.stack,\r\n      name: error.name,\r\n      cause: error.cause\r\n    }, null, 2), {\r\n      status: 200, // 返回200以便前端能看到错误信息\r\n      headers: { 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\debug\\env\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'request' is defined but never used. Allowed unused args must match /^_/u.","line":5,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"request"},"fix":{"range":[171,191],"text":""},"desc":"Remove unused variable 'request'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest } from \"next/server\"\r\nimport { selectApiKey, getKeyHealthStatus } from \"@/lib/ai/key-manager\"\r\n\r\n// 开发环境调试API - 检查环境变量加载状态\r\nexport async function GET(request: NextRequest) {\r\n  if (process.env.NODE_ENV === 'production') {\r\n    return new Response('Not available in production', { status: 403 })\r\n  }\r\n\r\n  try {\r\n    const model = 'claude-opus-4-1-20250805'\r\n    \r\n    // 检查环境变量原始值\r\n    const envCheck = {\r\n      LLM_API_BASE: process.env.LLM_API_BASE || 'NOT_SET',\r\n      LLM_API_KEY: process.env.LLM_API_KEY ? `${process.env.LLM_API_KEY.slice(0, 10)}...` : 'NOT_SET',\r\n      LLM_CLAUDE_API_KEY: process.env.LLM_CLAUDE_API_KEY ? `${process.env.LLM_CLAUDE_API_KEY.slice(0, 10)}...` : 'NOT_SET',\r\n      LLM_GEMINI_API_KEY: process.env.LLM_GEMINI_API_KEY ? `${process.env.LLM_GEMINI_API_KEY.slice(0, 10)}...` : 'NOT_SET',\r\n      MODEL_ALLOWLIST: process.env.MODEL_ALLOWLIST || 'NOT_SET',\r\n      NODE_ENV: process.env.NODE_ENV\r\n    }\r\n\r\n    // 检查Key选择逻辑\r\n    let keySelection = null\r\n    let keySelectionError = null\r\n    try {\r\n      keySelection = selectApiKey(model)\r\n    } catch (error) {\r\n      keySelectionError = error instanceof Error ? error.message : String(error)\r\n    }\r\n\r\n    // 检查健康状态\r\n    const healthStatus = getKeyHealthStatus()\r\n\r\n    const debugInfo = {\r\n      timestamp: new Date().toISOString(),\r\n      environment: envCheck,\r\n      keySelection,\r\n      keySelectionError,\r\n      healthStatus,\r\n      testModel: model\r\n    }\r\n\r\n    return new Response(JSON.stringify(debugInfo, null, 2), {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    })\r\n\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({\r\n      error: error instanceof Error ? error.message : String(error),\r\n      stack: error instanceof Error ? error.stack : undefined\r\n    }, null, 2), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json' }\r\n    })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\feedback\\[id]\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[217,237],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[236,255],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { NextRequest } from \"next/server\"\nimport { NextResponse } from \"next/server\"\nimport { prisma } from \"@/lib/prisma\"\nimport { FeedbackStatus, FeedbackType, FeedbackPriority } from \"@prisma/client\"\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 状态映射函数\nfunction mapStringToStatus(status: string): FeedbackStatus {\n  const mapping: Record<string, FeedbackStatus> = {\n    \"pending\": FeedbackStatus.OPEN,\n    \"in-progress\": FeedbackStatus.IN_PROGRESS,\n    \"resolved\": FeedbackStatus.RESOLVED,\n    \"closed\": FeedbackStatus.CLOSED,\n    \"rejected\": FeedbackStatus.REJECTED,\n  }\n  return mapping[status] || FeedbackStatus.OPEN\n}\n\nfunction mapStatusToString(status: FeedbackStatus): string {\n  const mapping: Record<FeedbackStatus, string> = {\n    [FeedbackStatus.OPEN]: \"pending\",\n    [FeedbackStatus.IN_PROGRESS]: \"in-progress\",\n    [FeedbackStatus.RESOLVED]: \"resolved\",\n    [FeedbackStatus.CLOSED]: \"closed\",\n    [FeedbackStatus.REJECTED]: \"rejected\",\n  }\n  return mapping[status]\n}\n\nfunction mapTypeToCategory(type: FeedbackType): string {\n  const mapping: Record<FeedbackType, string> = {\n    [FeedbackType.FEATURE_REQUEST]: \"功能建议\",\n    [FeedbackType.BUG_REPORT]: \"问题报告\",\n    [FeedbackType.IMPROVEMENT]: \"使用体验\",\n    [FeedbackType.COMPLAINT]: \"投诉\",\n    [FeedbackType.COMPLIMENT]: \"表扬\",\n    [FeedbackType.OTHER]: \"其他\",\n  }\n  return mapping[type] || \"其他\"\n}\n\nfunction mapPriorityToString(priority: FeedbackPriority): string {\n  return priority.toLowerCase()\n}\n\nexport async function GET(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {\n  try {\n    const { id } = await params\n\n    // 从数据库获取反馈详情\n    const feedback = await prisma.feedback.findUnique({\n      where: { id },\n      include: {\n        user: {\n          select: {\n            displayName: true,\n            email: true,\n          },\n        },\n      },\n    })\n\n    if (!feedback) {\n      return NextResponse.json(\n        { success: false, error: \"反馈不存在\" },\n        { status: 404 }\n      )\n    }\n\n    // 格式化返回数据\n    const formattedFeedback = {\n      id: feedback.id,\n      title: feedback.title,\n      content: feedback.content,\n      category: mapTypeToCategory(feedback.type),\n      priority: mapPriorityToString(feedback.priority),\n      status: mapStatusToString(feedback.status),\n      createdAt: feedback.createdAt.toISOString(),\n      updatedAt: feedback.updatedAt.toISOString(),\n      author: feedback.authorName || feedback.user?.displayName || \"匿名用户\",\n      contactInfo: feedback.contactInfo || feedback.user?.email || \"\",\n      upvotes: 0,\n      tags: [],\n      replies: feedback.response ? [{\n        id: \"response\",\n        content: feedback.response,\n        author: \"系统\",\n        createdAt: feedback.handledAt?.toISOString() || feedback.updatedAt.toISOString(),\n        isAdmin: true,\n      }] : [],\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: formattedFeedback,\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { success: false, error: \"获取反馈详情失败\" },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function PUT(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {\n  try {\n    const { id } = await params\n    const body = await request.json()\n    const { status, reply, priority } = body\n\n    // 构建更新数据\n    const updateData: any = {}\n\n    // 更新状态\n    if (status) {\n      updateData.status = mapStringToStatus(status)\n      \n      // 如果状态改为处理中、已解决或已关闭，记录处理时间\n      if ([\"in-progress\", \"resolved\", \"closed\"].includes(status)) {\n        updateData.handledAt = new Date()\n      }\n    }\n\n    // 添加回复\n    if (reply) {\n      updateData.response = reply\n      updateData.handledAt = new Date()\n      // 如果添加了回复但没有指定状态，自动设置为已解决\n      if (!status) {\n        updateData.status = FeedbackStatus.RESOLVED\n      }\n    }\n\n    // 更新优先级\n    if (priority) {\n      const priorityMapping: Record<string, FeedbackPriority> = {\n        \"low\": FeedbackPriority.LOW,\n        \"medium\": FeedbackPriority.MEDIUM,\n        \"high\": FeedbackPriority.HIGH,\n        \"urgent\": FeedbackPriority.URGENT,\n      }\n      updateData.priority = priorityMapping[priority] || FeedbackPriority.MEDIUM\n    }\n\n    // 更新数据库\n    const updatedFeedback = await prisma.feedback.update({\n      where: { id },\n      data: updateData,\n      include: {\n        user: {\n          select: {\n            displayName: true,\n            email: true,\n          },\n        },\n      },\n    })\n\n    // 格式化返回数据\n    const formattedFeedback = {\n      id: updatedFeedback.id,\n      title: updatedFeedback.title,\n      content: updatedFeedback.content,\n      category: mapTypeToCategory(updatedFeedback.type),\n      priority: mapPriorityToString(updatedFeedback.priority),\n      status: mapStatusToString(updatedFeedback.status),\n      createdAt: updatedFeedback.createdAt.toISOString(),\n      updatedAt: updatedFeedback.updatedAt.toISOString(),\n      author: updatedFeedback.authorName || updatedFeedback.user?.displayName || \"匿名用户\",\n      contactInfo: updatedFeedback.contactInfo || updatedFeedback.user?.email || \"\",\n      replies: updatedFeedback.response ? [{\n        id: \"response\",\n        content: updatedFeedback.response,\n        author: \"系统\",\n        createdAt: updatedFeedback.handledAt?.toISOString() || updatedFeedback.updatedAt.toISOString(),\n        isAdmin: true,\n      }] : [],\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: formattedFeedback,\n      message: \"反馈更新成功\",\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { success: false, error: \"更新反馈失败\" },\n      { status: 500 }\n    )\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\feedback\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[183,203],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[202,221],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\"\nimport { prisma } from \"@/lib/prisma\"\nimport { FeedbackType, FeedbackStatus, FeedbackPriority } from \"@prisma/client\"\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 类型映射函数\nfunction mapCategoryToType(category: string): FeedbackType {\n  const mapping: Record<string, FeedbackType> = {\n    \"功能建议\": FeedbackType.FEATURE_REQUEST,\n    \"问题报告\": FeedbackType.BUG_REPORT,\n    \"使用体验\": FeedbackType.IMPROVEMENT,\n    \"性能优化\": FeedbackType.IMPROVEMENT,\n    \"界面设计\": FeedbackType.IMPROVEMENT,\n  }\n  return mapping[category] || FeedbackType.OTHER\n}\n\nfunction mapTypeToCategory(type: FeedbackType): string {\n  const mapping: Record<FeedbackType, string> = {\n    [FeedbackType.FEATURE_REQUEST]: \"功能建议\",\n    [FeedbackType.BUG_REPORT]: \"问题报告\",\n    [FeedbackType.IMPROVEMENT]: \"使用体验\",\n    [FeedbackType.COMPLAINT]: \"投诉\",\n    [FeedbackType.COMPLIMENT]: \"表扬\",\n    [FeedbackType.OTHER]: \"其他\",\n  }\n  return mapping[type] || \"其他\"\n}\n\nfunction mapStatusToString(status: FeedbackStatus): string {\n  const mapping: Record<FeedbackStatus, string> = {\n    [FeedbackStatus.OPEN]: \"pending\",\n    [FeedbackStatus.IN_PROGRESS]: \"in-progress\",\n    [FeedbackStatus.RESOLVED]: \"resolved\",\n    [FeedbackStatus.CLOSED]: \"closed\",\n    [FeedbackStatus.REJECTED]: \"closed\",\n  }\n  return mapping[status]\n}\n\nfunction mapStringToStatus(status: string): FeedbackStatus {\n  const mapping: Record<string, FeedbackStatus> = {\n    \"pending\": FeedbackStatus.OPEN,\n    \"in-progress\": FeedbackStatus.IN_PROGRESS,\n    \"resolved\": FeedbackStatus.RESOLVED,\n    \"closed\": FeedbackStatus.CLOSED,\n  }\n  return mapping[status] || FeedbackStatus.OPEN\n}\n\nfunction mapPriorityToString(priority: FeedbackPriority): string {\n  return priority.toLowerCase()\n}\n\nfunction mapStringToPriority(priority: string): FeedbackPriority {\n  const mapping: Record<string, FeedbackPriority> = {\n    \"low\": FeedbackPriority.LOW,\n    \"medium\": FeedbackPriority.MEDIUM,\n    \"high\": FeedbackPriority.HIGH,\n    \"urgent\": FeedbackPriority.URGENT,\n  }\n  return mapping[priority] || FeedbackPriority.MEDIUM\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const category = searchParams.get(\"category\") || \"all\"\n    const status = searchParams.get(\"status\") || \"all\"\n    const page = parseInt(searchParams.get(\"page\") || \"1\")\n    const limit = parseInt(searchParams.get(\"limit\") || \"10\")\n\n    // 构建查询条件\n    const where: any = {}\n    \n    if (category !== \"all\") {\n      where.type = mapCategoryToType(category)\n    }\n    \n    if (status !== \"all\") {\n      where.status = mapStringToStatus(status)\n    }\n\n    // 获取总数\n    const total = await prisma.feedback.count({ where })\n\n    // 获取分页数据\n    const feedbacks = await prisma.feedback.findMany({\n      where,\n      include: {\n        user: {\n          select: {\n            displayName: true,\n            email: true,\n          },\n        },\n      },\n      orderBy: {\n        createdAt: \"desc\",\n      },\n      skip: (page - 1) * limit,\n      take: limit,\n    })\n\n    // 转换数据格式以适配前端\n    const formattedFeedbacks = feedbacks.map((feedback) => ({\n      id: feedback.id,\n      title: feedback.title,\n      content: feedback.content,\n      category: mapTypeToCategory(feedback.type),\n      priority: mapPriorityToString(feedback.priority),\n      status: mapStatusToString(feedback.status),\n      createdAt: feedback.createdAt.toISOString(),\n      updatedAt: feedback.updatedAt.toISOString(),\n      author: feedback.authorName || feedback.user?.displayName || \"匿名用户\",\n      contactInfo: feedback.contactInfo || feedback.user?.email || \"\",\n      upvotes: 0, // 简化版不实现点赞\n      tags: [], // 简化版不实现标签\n      replies: feedback.response ? [{\n        id: \"response\",\n        content: feedback.response,\n        author: \"系统\",\n        createdAt: feedback.handledAt?.toISOString() || feedback.updatedAt.toISOString(),\n        isAdmin: true,\n      }] : [],\n    }))\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        feedbacks: formattedFeedbacks,\n        total,\n        page,\n        limit,\n        totalPages: Math.ceil(total / limit),\n      },\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { success: false, error: \"获取反馈失败\" },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { title, content, category, priority, contactInfo, authorName } = await request.json()\n\n    // 验证必填字段\n    if (!title || !content) {\n      return NextResponse.json(\n        { success: false, error: \"标题和内容不能为空\" },\n        { status: 400 }\n      )\n    }\n\n    // 创建反馈\n    const feedback = await prisma.feedback.create({\n      data: {\n        title,\n        content,\n        type: mapCategoryToType(category),\n        priority: mapStringToPriority(priority),\n        status: FeedbackStatus.OPEN,\n        contactInfo,\n        authorName: authorName || \"匿名用户\",\n        userId: null, // 匿名反馈，不关联用户\n      },\n      include: {\n        user: {\n          select: {\n            displayName: true,\n            email: true,\n          },\n        },\n      },\n    })\n\n    // 格式化返回数据\n    const formattedFeedback = {\n      id: feedback.id,\n      title: feedback.title,\n      content: feedback.content,\n      category: mapTypeToCategory(feedback.type),\n      priority: mapPriorityToString(feedback.priority),\n      status: mapStatusToString(feedback.status),\n      createdAt: feedback.createdAt.toISOString(),\n      updatedAt: feedback.updatedAt.toISOString(),\n      author: feedback.authorName || feedback.user?.displayName || \"匿名用户\",\n      contactInfo: feedback.contactInfo || feedback.user?.email || \"\",\n      replies: [],\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: formattedFeedback,\n      message: \"反馈提交成功\",\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { \n        success: false, \n        error: \"提交反馈失败\",\n        message: error instanceof Error ? error.message : \"未知错误\",\n        details: JSON.stringify(error, null, 2)\n      },\n      { status: 500 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\import\\external-resources\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":13,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[405,425],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":13,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[424,443],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 外部资源导入API端点\n * POST /api/import/external-resources\n */\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { getServerSession } from 'next-auth'\nimport { authOptions } from '@/auth'\nimport { importExternalResources } from '../../../../lib/import/external-resource-importer'\nimport { writeFile, mkdir } from 'fs/promises'\nimport { existsSync } from 'fs'\nimport path from 'path'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\nexport async function POST(request: NextRequest) {\n  try {\n    // 验证用户身份\n    const session = await getServerSession(authOptions)\n    if (!session?.user?.id) {\n      return NextResponse.json(\n        { error: '未授权访问' },\n        { status: 401 }\n      )\n    }\n\n    // 解析表单数据\n    const formData = await request.formData()\n    const file = formData.get('file') as File\n    const categoryId = formData.get('categoryId') as string\n    const importedFrom = formData.get('importedFrom') as string\n    const fileType = formData.get('fileType') as string\n    const mapping = formData.get('mapping') as string\n\n    if (!file) {\n      return NextResponse.json(\n        { error: '未找到上传文件' },\n        { status: 400 }\n      )\n    }\n\n    // 验证文件大小 (50MB)\n    if (file.size > 50 * 1024 * 1024) {\n      return NextResponse.json(\n        { error: '文件大小不能超过50MB' },\n        { status: 400 }\n      )\n    }\n\n    // 验证文件类型\n    const allowedTypes = ['csv', 'json', 'txt', 'md']\n    const detectedType = fileType || getFileTypeFromName(file.name)\n    \n    if (!allowedTypes.includes(detectedType)) {\n      return NextResponse.json(\n        { error: `不支持的文件类型: ${detectedType}` },\n        { status: 400 }\n      )\n    }\n\n    // 创建临时目录\n    const tempDir = path.join(process.cwd(), 'temp')\n    if (!existsSync(tempDir)) {\n      await mkdir(tempDir, { recursive: true })\n    }\n\n    // 保存临时文件\n    const tempFilePath = path.join(tempDir, `import-${Date.now()}-${file.name}`)\n    const bytes = await file.arrayBuffer()\n    const buffer = Buffer.from(bytes)\n    await writeFile(tempFilePath, buffer)\n\n    try {\n      // 解析字段映射\n      let parsedMapping\n      try {\n        parsedMapping = mapping ? JSON.parse(mapping) : getDefaultMapping(detectedType)\n      } catch {\n        return NextResponse.json(\n          { error: '字段映射配置格式错误' },\n          { status: 400 }\n        )\n      }\n\n      // 执行导入\n      const result = await importExternalResources({\n        userId: session.user.id,\n        filePath: tempFilePath,\n        fileType: detectedType as any,\n        categoryId: categoryId || undefined,\n        source: 'UPLOADED',\n        importedFrom: importedFrom || file.name,\n        mapping: parsedMapping,\n        options: {\n          skipFirstRow: detectedType === 'csv' || detectedType === 'excel',\n          updateExisting: true,\n          chunkSize: 50\n        }\n      })\n\n      return NextResponse.json({\n        success: true,\n        data: result\n      })\n\n    } finally {\n      // 清理临时文件\n      try {\n        const fs = await import('fs')\n        if (fs.existsSync(tempFilePath)) {\n          fs.unlinkSync(tempFilePath)\n        }\n      } catch (error) {\n        void error\n        }\n    }\n\n  } catch (error) {\n    return NextResponse.json(\n      { \n        error: error instanceof Error ? error.message : '导入失败',\n        success: false\n      },\n      { status: 500 }\n    )\n  }\n}\n\n/**\n * 从文件名推断文件类型\n */\nfunction getFileTypeFromName(fileName: string): string {\n  const ext = path.extname(fileName).toLowerCase()\n  \n  switch (ext) {\n    case '.csv':\n      return 'csv'\n    case '.json':\n      return 'json'\n    case '.xlsx':\n    case '.xls':\n      return 'excel'\n    case '.md':\n      return 'md'\n    case '.txt':\n    default:\n      return 'txt'\n  }\n}\n\n/**\n * 获取默认字段映射\n */\nfunction getDefaultMapping(fileType: string) {\n  switch (fileType) {\n    case 'csv':\n    case 'excel':\n      return {\n        title: '标题',\n        content: '内容',\n        excerpt: '摘要',\n        tags: '标签',\n        externalId: 'ID'\n      }\n    \n    case 'json':\n      return {\n        title: 'title',\n        content: 'content',\n        excerpt: 'excerpt',\n        tags: 'tags',\n        externalId: 'id'\n      }\n    \n    default:\n      return {\n        title: 'title',\n        content: 'content'\n      }\n  }\n}\n\n// 支持的HTTP方法\nexport const runtime = 'nodejs'","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\invite-codes\\generate\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[103,123],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[122,141],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 批量生成邀请码\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { \n      count = 10,\n      prefix = 'ZHIDIAN',\n      maxUses = 1,\n      expiresInDays,\n      defaultRole = 'USER',\n      monthlyTokenLimit = 50000,\n      description = '批量生成的邀请码',\n      createdBy \n    } = body\n    \n    if (count > 100) {\n      return NextResponse.json(\n        { error: '单次最多生成100个邀请码' },\n        { status: 400 }\n      )\n    }\n    \n    // 计算过期时间\n    const expiresAt = expiresInDays \n      ? new Date(Date.now() + expiresInDays * 24 * 60 * 60 * 1000)\n      : null\n    \n    // 生成唯一邀请码函数\n    function generateCode(): string {\n      const randomStr = Math.random().toString(36).substring(2, 8).toUpperCase()\n      const timestamp = Date.now().toString(36).toUpperCase()\n      return `${prefix}${randomStr}${timestamp}`.substring(0, 20)\n    }\n    \n    // 批量创建邀请码\n    const inviteCodes = []\n    const existingCodes = new Set()\n    \n    for (let i = 0; i < count; i++) {\n      let code = generateCode()\n      \n      // 确保代码唯一性\n      while (existingCodes.has(code)) {\n        code = generateCode()\n      }\n      existingCodes.add(code)\n      \n      inviteCodes.push({\n        code,\n        description: `${description} (${i + 1}/${count})`,\n        maxUses,\n        expiresAt,\n        defaultRole,\n        monthlyTokenLimit,\n        createdBy,\n      })\n    }\n    \n    // 批量插入数据库\n    const result = await prisma.inviteCode.createMany({\n      data: inviteCodes\n    })\n    \n    // 获取创建的邀请码详情\n    const createdCodes = await prisma.inviteCode.findMany({\n      where: {\n        code: {\n          in: inviteCodes.map(invite => invite.code)\n        }\n      },\n      select: {\n        id: true,\n        code: true,\n        description: true,\n        maxUses: true,\n        expiresAt: true,\n        defaultRole: true,\n        monthlyTokenLimit: true,\n        createdAt: true,\n      },\n      orderBy: {\n        createdAt: 'desc'\n      }\n    })\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        count: result.count,\n        codes: createdCodes,\n      },\n      message: `成功生成 ${result.count} 个邀请码`\n    }, { status: 201 })\n    \n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '生成邀请码失败' },\n      { status: 500 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\invite-codes\\register\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[103,123],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[122,141],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 使用邀请码注册用户\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { \n      inviteCode, \n      email, \n      username, \n      displayName \n    } = body\n    \n    // 验证必填字段\n    if (!inviteCode || !email) {\n      return NextResponse.json(\n        { error: '邀请码和邮箱是必填项' },\n        { status: 400 }\n      )\n    }\n    \n    // 验证邮箱格式\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/\n    if (!emailRegex.test(email)) {\n      return NextResponse.json(\n        { error: '邮箱格式不正确' },\n        { status: 400 }\n      )\n    }\n    \n    // 开始事务\n    const result = await prisma.$transaction(async (tx) => {\n      // 1. 验证邀请码\n      const invite = await tx.inviteCode.findUnique({\n        where: { code: inviteCode.trim().toUpperCase() }\n      })\n      \n      if (!invite) {\n        throw new Error('邀请码不存在')\n      }\n      \n      if (!invite.isActive) {\n        throw new Error('邀请码已被禁用')\n      }\n      \n      if (invite.expiresAt && new Date() > invite.expiresAt) {\n        throw new Error('邀请码已过期')\n      }\n      \n      if (invite.usedCount >= invite.maxUses) {\n        throw new Error('邀请码使用次数已达上限')\n      }\n      \n      // 2. 检查邮箱是否已存在\n      const existingUser = await tx.user.findUnique({\n        where: { email },\n        select: { id: true }\n      })\n      \n      if (existingUser) {\n        throw new Error('邮箱已被注册')\n      }\n      \n      // 3. 检查用户名是否已存在\n      if (username) {\n        const existingUsername = await tx.user.findUnique({\n          where: { username },\n          select: { id: true }\n        })\n        \n        if (existingUsername) {\n          throw new Error('用户名已存在')\n        }\n      }\n      \n      // 4. 创建用户\n      const user = await tx.user.create({\n        data: {\n          email,\n          username,\n          displayName,\n          role: invite.defaultRole,\n          monthlyTokenLimit: invite.monthlyTokenLimit,\n          inviteCodeId: invite.id,\n        },\n        select: {\n          id: true,\n          email: true,\n          username: true,\n          displayName: true,\n          role: true,\n          status: true,\n          monthlyTokenLimit: true,\n          currentMonthUsage: true,\n          totalTokenUsed: true,\n          createdAt: true,\n          inviteCode: {\n            select: {\n              code: true,\n              description: true,\n            }\n          }\n        }\n      })\n      \n      // 5. 更新邀请码使用次数\n      await tx.inviteCode.update({\n        where: { id: invite.id },\n        data: {\n          usedCount: { increment: 1 }\n        }\n      })\n      \n      return user\n    })\n    \n    return NextResponse.json({\n      success: true,\n      data: result,\n      message: '用户注册成功'\n    }, { status: 201 })\n    \n  } catch (error) {\n    const message = error instanceof Error ? error.message : '注册失败'\n    return NextResponse.json(\n      { error: message },\n      { status: 400 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\invite-codes\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[103,123],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[122,141],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 获取邀请码列表\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const page = parseInt(searchParams.get('page') || '1')\n    const limit = parseInt(searchParams.get('limit') || '20')\n    const active = searchParams.get('active')\n    \n    const skip = (page - 1) * limit\n    \n    // 构建查询条件\n    const where: any = {}\n    if (active === 'true') {\n      where.isActive = true\n      where.OR = [\n        { expiresAt: null },\n        { expiresAt: { gt: new Date() } }\n      ]\n    } else if (active === 'false') {\n      where.OR = [\n        { isActive: false },\n        { expiresAt: { lte: new Date() } }\n      ]\n    }\n    \n    // 获取邀请码列表\n    const inviteCodes = await prisma.inviteCode.findMany({\n      where,\n      select: {\n        id: true,\n        code: true,\n        description: true,\n        maxUses: true,\n        usedCount: true,\n        isActive: true,\n        expiresAt: true,\n        defaultRole: true,\n        monthlyTokenLimit: true,\n        createdBy: true,\n        createdAt: true,\n        updatedAt: true,\n        _count: {\n          select: {\n            usedBy: true\n          }\n        }\n      },\n      orderBy: {\n        createdAt: 'desc'\n      },\n      skip,\n      take: limit,\n    })\n    \n    // 获取总数\n    const total = await prisma.inviteCode.count({ where })\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        inviteCodes,\n        pagination: {\n          page,\n          limit,\n          total,\n          pages: Math.ceil(total / limit)\n        }\n      }\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '获取邀请码列表失败' },\n      { status: 500 }\n    )\n  }\n}\n\n// 创建新邀请码\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { \n      code,\n      description,\n      maxUses = 1,\n      expiresAt,\n      defaultRole = 'USER',\n      monthlyTokenLimit = 50000,\n      createdBy \n    } = body\n    \n    // 验证邀请码格式（6-20位字母数字）\n    if (!code || !/^[A-Za-z0-9]{6,20}$/.test(code)) {\n      return NextResponse.json(\n        { error: '邀请码必须是6-20位字母或数字' },\n        { status: 400 }\n      )\n    }\n    \n    // 检查邀请码是否已存在\n    const existingCode = await prisma.inviteCode.findUnique({\n      where: { code }\n    })\n    \n    if (existingCode) {\n      return NextResponse.json(\n        { error: '邀请码已存在' },\n        { status: 409 }\n      )\n    }\n    \n    // 创建邀请码\n    const inviteCode = await prisma.inviteCode.create({\n      data: {\n        code,\n        description,\n        maxUses,\n        expiresAt: expiresAt ? new Date(expiresAt) : null,\n        defaultRole,\n        monthlyTokenLimit,\n        createdBy,\n      }\n    })\n    \n    return NextResponse.json({\n      success: true,\n      data: inviteCode,\n      message: '邀请码创建成功'\n    }, { status: 201 })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '创建邀请码失败' },\n      { status: 500 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\invite-codes\\verify\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[103,123],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[122,141],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 验证邀请码\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { code } = body\n    \n    if (!code) {\n      return NextResponse.json(\n        { error: '邀请码不能为空' },\n        { status: 400 }\n      )\n    }\n    \n    // 标准化邀请码为大写\n    const normalized = String(code).trim().toUpperCase()\n\n    // 查找邀请码\n    const inviteCode = await prisma.inviteCode.findUnique({\n      where: { code: normalized },\n      include: {\n        _count: {\n          select: {\n            usedBy: true\n          }\n        }\n      }\n    })\n    \n    if (!inviteCode) {\n      return NextResponse.json(\n        { error: '邀请码不存在' },\n        { status: 404 }\n      )\n    }\n    \n    // 检查邀请码状态\n    if (!inviteCode.isActive) {\n      return NextResponse.json(\n        { error: '邀请码已被禁用' },\n        { status: 403 }\n      )\n    }\n    \n    // 检查是否过期\n    if (inviteCode.expiresAt && new Date() > inviteCode.expiresAt) {\n      return NextResponse.json(\n        { error: '邀请码已过期' },\n        { status: 403 }\n      )\n    }\n    \n    // 检查使用次数\n    if (inviteCode.usedCount >= inviteCode.maxUses) {\n      return NextResponse.json(\n        { error: '邀请码使用次数已达上限' },\n        { status: 403 }\n      )\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        id: inviteCode.id,\n        code: inviteCode.code,\n        description: inviteCode.description,\n        defaultRole: inviteCode.defaultRole,\n        monthlyTokenLimit: inviteCode.monthlyTokenLimit,\n        remainingUses: inviteCode.maxUses - inviteCode.usedCount,\n        expiresAt: inviteCode.expiresAt,\n      },\n      message: '邀请码验证成功'\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '验证邀请码失败' },\n      { status: 500 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\keyword-data\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[118,138],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[137,156],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\"\nimport fs from \"fs/promises\"\nimport path from \"path\"\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const searchParams = request.nextUrl.searchParams\n    const keyword = searchParams.get(\"keyword\") || \"断桥铝门窗\"\n    \n    // 数据文件目录\n    const dataDir = path.join(process.cwd(), \"keyword_search_aggregated\")\n    \n    // 获取所有可用的关键字数据文件\n    const files = await fs.readdir(dataDir)\n    const jsonFiles = files.filter(file => file.endsWith(\".json\"))\n    \n    // 提取可用的关键字列表\n    const availableKeywords = jsonFiles.map(file => \n      file.replace(\"keyword_data_\", \"\").replace(\".json\", \"\")\n    )\n    \n    // 构建目标文件路径\n    const fileName = `keyword_data_${keyword}.json`\n    const filePath = path.join(dataDir, fileName)\n    \n    try {\n      // 读取指定关键字的数据文件\n      const fileContent = await fs.readFile(filePath, \"utf-8\")\n      const data = JSON.parse(fileContent)\n      \n      // 添加可用关键字列表到响应中\n      return NextResponse.json({\n        success: true,\n        data,\n        availableKeywords,\n        currentKeyword: keyword\n      })\n    } catch (error) {\n      void error\n      // 如果文件不存在，返回可用关键字列表\n      return NextResponse.json({\n        success: false,\n        message: `未找到关键字 \"${keyword}\" 的数据文件`,\n        availableKeywords,\n        currentKeyword: null\n      }, { status: 404 })\n    }\n    \n  } catch (error) {\n    return NextResponse.json({\n      success: false,\n      message: \"服务器错误\",\n      error: error instanceof Error ? error.message : \"未知错误\"\n    }, { status: 500 })\n  }\n}\n\n// 获取所有可用的关键字列表\nexport async function POST(_request: NextRequest) {\n  try {\n    const dataDir = path.join(process.cwd(), \"keyword_search_aggregated\")\n    const files = await fs.readdir(dataDir)\n    const jsonFiles = files.filter(file => file.endsWith(\".json\"))\n    \n    const keywordsWithStats = await Promise.all(\n      jsonFiles.map(async (file) => {\n        const keyword = file.replace(\"keyword_data_\", \"\").replace(\".json\", \"\")\n        const filePath = path.join(dataDir, file)\n        \n        try {\n          const content = await fs.readFile(filePath, \"utf-8\")\n          const data = JSON.parse(content)\n          \n          return {\n            keyword,\n            videoCount: data.videos?.length || 0,\n            totalComments: data.statistics?.实际评论总数 || 0,\n            lastUpdated: data.metadata?.last_updated || null\n          }\n        } catch (error) {\n          void error\n          return {\n            keyword,\n            videoCount: 0,\n            totalComments: 0,\n            lastUpdated: null\n          }\n        }\n      })\n    )\n    \n    return NextResponse.json({\n      success: true,\n      keywords: keywordsWithStats\n    })\n    \n  } catch (error) {\n    return NextResponse.json({\n      success: false,\n      message: \"服务器错误\",\n      error: error instanceof Error ? error.message : \"未知错误\"\n    }, { status: 500 })\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\mcp-test\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":230,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":230,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { NextRequest } from \"next/server\"\nimport { getToken } from \"next-auth/jwt\"\n\n// 模拟MCP服务器响应\nconst mockMCPServers = {\n  filesystem: {\n    name: \"文件系统服务器\",\n    available: true,\n    tools: [\"listFiles\", \"readFile\", \"writeFile\", \"deleteFile\"],\n    mockResponse: {\n      files: [\n        \"app/\",\n        \"components/\",\n        \"lib/\",\n        \"package.json\",\n        \"next.config.mjs\",\n        \"README.md\",\n        \"tailwind.config.ts\",\n        \"tsconfig.json\"\n      ],\n      totalFiles: 156,\n      totalDirectories: 23\n    }\n  },\n  database: {\n    name: \"数据库服务器\", \n    available: true,\n    tools: [\"queryUsers\", \"queryConversations\", \"queryDocuments\"],\n    mockResponse: {\n      users: 25,\n      conversations: 142,\n      documents: 89,\n      recentActivity: \"最近30天新增用户12人，对话增长35%\"\n    }\n  },\n  documents: {\n    name: \"文档服务器\",\n    available: true, \n    tools: [\"listDocuments\", \"searchDocuments\", \"createDocument\"],\n    mockResponse: {\n      totalDocuments: 89,\n      categories: [\"短视频文案\", \"产品介绍\", \"旅游攻略\", \"美食内容\"],\n      recentDocuments: [\n        \"AI写作助手使用指南\",\n        \"短视频脚本创作技巧\", \n        \"产品功能介绍模板\"\n      ]\n    }\n  },\n  \"web-search\": {\n    name: \"Web搜索服务器\",\n    available: true,\n    tools: [\"webSearch\", \"urlAnalysis\", \"contentExtraction\"],\n    mockResponse: {\n      searchResults: [\n        {\n          title: \"Model Context Protocol 官方文档\",\n          url: \"https://modelcontextprotocol.io/\",\n          summary: \"MCP标准化AI应用与外部工具的连接方式\"\n        },\n        {\n          title: \"AI SDK v5 MCP 集成指南\",\n          url: \"https://ai-sdk.dev/cookbook/next/mcp-tools\",\n          summary: \"Next.js应用中实现MCP工具集成的详细教程\"\n        }\n      ]\n    }\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    // 认证检查\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) {\n      return new Response(JSON.stringify({ error: \"未认证\" }), { \n        status: 401, \n        headers: { \"Content-Type\": \"application/json\" } \n      })\n    }\n\n    const { prompt, enabledServers } = await request.json()\n\n    // 验证输入\n    if (!prompt || !enabledServers || !Array.isArray(enabledServers)) {\n      return new Response(JSON.stringify({ \n        error: \"无效的请求参数\" \n      }), { \n        status: 400, \n        headers: { \"Content-Type\": \"application/json\" } \n      })\n    }\n\n    // 模拟MCP处理延迟\n    await new Promise(resolve => setTimeout(resolve, 1500))\n\n    // 生成模拟响应\n    let mcpResults: Record<string, any> = {}\n    \n    for (const serverId of enabledServers) {\n      const server = mockMCPServers[serverId as keyof typeof mockMCPServers]\n      if (server && server.available) {\n        mcpResults[serverId] = {\n          serverName: server.name,\n          status: \"success\",\n          tools: server.tools,\n          response: server.mockResponse\n        }\n      } else {\n        mcpResults[serverId] = {\n          serverName: serverId,\n          status: \"error\", \n          error: `MCP服务器 ${serverId} 不可用`\n        }\n      }\n    }\n\n    // 生成基于MCP结果的AI响应\n    const generateMockAIResponse = (results: Record<string, any>) => {\n      let response = \"基于MCP服务器查询结果：\\n\\n\"\n      \n      if (results.filesystem) {\n        const fs = results.filesystem.response\n        response += `📁 **文件系统分析**：\\n`\n        response += `- 项目包含 ${fs.totalFiles} 个文件，${fs.totalDirectories} 个目录\\n`\n        response += `- 主要目录结构：${fs.files.slice(0, 4).join(\", \")}\\n\\n`\n      }\n      \n      if (results.database) {\n        const db = results.database.response\n        response += `🗄️ **数据库统计**：\\n`\n        response += `- 用户总数：${db.users} 人\\n`\n        response += `- 对话数量：${db.conversations} 个\\n`\n        response += `- 文档数量：${db.documents} 个\\n`\n        response += `- ${db.recentActivity}\\n\\n`\n      }\n      \n      if (results.documents) {\n        const docs = results.documents.response\n        response += `📝 **文档管理分析**：\\n`\n        response += `- 文档总数：${docs.totalDocuments} 个\\n`\n        response += `- 主要分类：${docs.categories.join(\"、\")}\\n`\n        response += `- 最新文档：${docs.recentDocuments.join(\"、\")}\\n\\n`\n      }\n      \n      if (results[\"web-search\"]) {\n        const search = results[\"web-search\"].response\n        response += `🌐 **MCP集成相关资料**：\\n`\n        search.searchResults.forEach((result: any) => {\n          response += `- [${result.title}](${result.url})\\n  ${result.summary}\\n`\n        })\n      }\n      \n      response += `\\n✅ **MCP集成状态**: 成功连接 ${Object.keys(results).length} 个服务器，所有工具响应正常。`\n      \n      return response\n    }\n\n    const aiResponse = generateMockAIResponse(mcpResults)\n\n    const response = {\n      success: true,\n      timestamp: Date.now(),\n      prompt,\n      enabledServers,\n      mcpResults,\n      response: aiResponse,\n      metadata: {\n        serversUsed: enabledServers.length,\n        totalTools: Object.values(mcpResults)\n          .filter(r => r.status === 'success')\n          .reduce((acc, curr) => acc + (curr.tools?.length || 0), 0),\n        processingTime: \"1.5s\"\n      }\n    }\n\n    return new Response(JSON.stringify(response), {\n      status: 200,\n      headers: { \n        \"Content-Type\": \"application/json\",\n        \"Cache-Control\": \"no-cache\"\n      }\n    })\n\n  } catch (error: any) {\n    return new Response(JSON.stringify({ \n      success: false,\n      error: error?.message || \"MCP测试失败\",\n      timestamp: Date.now()\n    }), { \n      status: 500, \n      headers: { \"Content-Type\": \"application/json\" } \n    })\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  // MCP服务器状态检查\n  try {\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) {\n      return new Response(JSON.stringify({ error: \"未认证\" }), { \n        status: 401, \n        headers: { \"Content-Type\": \"application/json\" } \n      })\n    }\n\n    const serverStatus = Object.entries(mockMCPServers).map(([id, server]) => ({\n      id,\n      name: server.name,\n      available: server.available,\n      toolsCount: server.tools.length,\n      lastCheck: Date.now()\n    }))\n\n    return new Response(JSON.stringify({\n      success: true,\n      servers: serverStatus,\n      timestamp: Date.now(),\n      mcpVersion: \"1.0.0\",\n      aiSdkVersion: \"5.0.18\"\n    }), {\n      status: 200,\n      headers: { \n        \"Content-Type\": \"application/json\",\n        \"Cache-Control\": \"public, max-age=30\" \n      }\n    })\n\n  } catch (error) {\n    return new Response(JSON.stringify({ \n      success: false, \n      error: \"获取MCP状态失败\" \n    }), { \n      status: 500, \n      headers: { \"Content-Type\": \"application/json\" } \n    })\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\merchants\\[id]\\export\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'format' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":24,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 商家数据导出API路由\n * GET /api/merchants/[id]/export - 导出商家数据为CSV\n */\n\nimport { NextRequest, NextResponse } from 'next/server'\nimport { getToken } from 'next-auth/jwt'\nimport { PrismaClient } from '@prisma/client'\nimport { parseAndCleanTags } from '@/lib/utils/tag-parser'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\nconst prisma = new PrismaClient()\n\n// GET /api/merchants/[id]/export - 导出商家数据\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  const token = await getToken({ req: request as any })\n  if (!token?.sub) return NextResponse.json({ error: '未认证' }, { status: 401 })\n  try {\n    const { id } = await params\n    const { searchParams } = new URL(request.url)\n    const format = searchParams.get('format') || 'csv'\n    const type = searchParams.get('type') || 'content' // content | analytics | tags\n    \n    if (!id) {\n      return NextResponse.json(\n        { error: '商家ID不能为空' },\n        { status: 400 }\n      )\n    }\n\n    // 获取商家及其内容\n    const merchant = await prisma.merchant.findUnique({\n      where: { id },\n      include: {\n        category: true,\n        contents: {\n          orderBy: {\n            publishedAt: 'desc'\n          }\n        }\n      }\n    })\n\n    if (!merchant) {\n      return NextResponse.json(\n        { error: '商家不存在' },\n        { status: 404 }\n      )\n    }\n\n    let csvContent = ''\n    let filename = ''\n\n    if (type === 'content') {\n      // 导出内容数据\n      filename = `${merchant.name}_内容数据_${new Date().toISOString().split('T')[0]}.csv`\n      \n      // CSV 头部\n      const headers = [\n        '内容ID',\n        '标题',\n        '内容类型',\n        '发布时间',\n        '时长',\n        '点赞数',\n        '评论数',\n        '收藏数',\n        '分享数',\n        '互动评分',\n        '标签',\n        '是否有转录',\n        '分享链接'\n      ]\n      \n      csvContent = headers.join(',') + '\\n'\n      \n      // 内容数据行\n      merchant.contents.forEach(content => {\n        const engagementScore = content.diggCount + content.commentCount * 2 + \n                               content.collectCount * 3 + content.shareCount * 4\n        \n        const tags = parseAndCleanTags(content.tags).join(';')\n        \n        const row = [\n          content.externalId,\n          `\"${(content.title || '').replace(/\"/g, '\"\"')}\"`,\n          content.contentType,\n          content.publishedAt ? content.publishedAt.toISOString().split('T')[0] : '',\n          content.duration || '',\n          content.diggCount,\n          content.commentCount,\n          content.collectCount,\n          content.shareCount,\n          engagementScore,\n          `\"${tags.replace(/\"/g, '\"\"')}\"`,\n          content.hasTranscript ? '是' : '否',\n          content.shareUrl || ''\n        ]\n        \n        csvContent += row.join(',') + '\\n'\n      })\n    } else if (type === 'analytics') {\n      // 导出分析数据\n      filename = `${merchant.name}_分析数据_${new Date().toISOString().split('T')[0]}.csv`\n      \n      // 计算分析数据\n      const totalEngagement = merchant.totalDiggCount + merchant.totalCommentCount + \n                             merchant.totalCollectCount + merchant.totalShareCount\n      const avgEngagement = merchant.totalContentCount > 0 ? \n                            Math.round(totalEngagement / merchant.totalContentCount) : 0\n      \n      const videoCount = merchant.contents.filter(c => c.contentType === 'VIDEO').length\n      const withTranscript = merchant.contents.filter(c => c.hasTranscript).length\n      \n      // CSV 内容\n      const analyticsData = [\n        ['指标', '数值', '说明'],\n        ['商家名称', `\"${merchant.name}\"`, ''],\n        ['商家分类', merchant.category?.name || '未分类', ''],\n        ['业务类型', merchant.businessType, ''],\n        ['所在地区', merchant.location || '未指定', ''],\n        ['', '', ''], // 空行\n        ['内容统计', '', ''],\n        ['总内容数', merchant.totalContentCount.toString(), ''],\n        ['视频内容数', videoCount.toString(), ''],\n        ['其他内容数', (merchant.totalContentCount - videoCount).toString(), ''],\n        ['带转录内容', withTranscript.toString(), ''],\n        ['转录覆盖率', `${Math.round((withTranscript / merchant.totalContentCount) * 100)}%`, ''],\n        ['', '', ''], // 空行\n        ['互动统计', '', ''],\n        ['总点赞数', merchant.totalDiggCount.toString(), ''],\n        ['总评论数', merchant.totalCommentCount.toString(), ''],\n        ['总收藏数', merchant.totalCollectCount.toString(), ''],\n        ['总分享数', merchant.totalShareCount.toString(), ''],\n        ['总互动量', totalEngagement.toString(), ''],\n        ['平均互动量', avgEngagement.toString(), '每条内容平均'],\n        ['', '', ''], // 空行\n        ['时间信息', '', ''],\n        ['创建时间', merchant.createdAt.toISOString().split('T')[0], ''],\n        ['最后采集时间', merchant.lastCollectedAt ? merchant.lastCollectedAt.toISOString().split('T')[0] : '', '']\n      ]\n      \n      csvContent = analyticsData.map(row => row.join(',')).join('\\n')\n    } else if (type === 'tags') {\n      // 导出标签数据\n      filename = `${merchant.name}_标签数据_${new Date().toISOString().split('T')[0]}.csv`\n      \n      // 统计标签\n      const tagMap = new Map<string, { count: number; engagementSum: number }>()\n      \n      merchant.contents.forEach(content => {\n        const tags = parseAndCleanTags(content.tags)\n        const engagement = content.diggCount + content.commentCount + \n                          content.collectCount + content.shareCount\n        \n        tags.forEach(tag => {\n          const cleanTag = tag.toLowerCase()\n          const existing = tagMap.get(cleanTag) || { count: 0, engagementSum: 0 }\n          tagMap.set(cleanTag, {\n            count: existing.count + 1,\n            engagementSum: existing.engagementSum + engagement\n          })\n        })\n      })\n      \n      const tagStats = Array.from(tagMap.entries())\n        .map(([tag, stats]) => ({\n          tag,\n          count: stats.count,\n          engagementSum: stats.engagementSum,\n          avgEngagement: Math.round(stats.engagementSum / stats.count)\n        }))\n        .sort((a, b) => b.count - a.count)\n      \n      // CSV 头部和数据\n      const headers = ['标签', '使用次数', '总互动量', '平均互动量']\n      csvContent = headers.join(',') + '\\n'\n      \n      tagStats.forEach(tag => {\n        const row = [\n          `\"${tag.tag.replace(/\"/g, '\"\"')}\"`,\n          tag.count,\n          tag.engagementSum,\n          tag.avgEngagement\n        ]\n        csvContent += row.join(',') + '\\n'\n      })\n    }\n\n    // 添加UTF-8 BOM解决中文乱码问题\n    const BOM = '\\uFEFF'\n    const csvWithBOM = BOM + csvContent\n    \n    // 设置响应头\n    const response = new NextResponse(csvWithBOM, {\n      status: 200,\n      headers: {\n        'Content-Type': 'text/csv; charset=utf-8',\n        'Content-Disposition': `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`,\n        'Cache-Control': 'no-cache',\n      }\n    })\n\n    return response\n    \n  } catch (error) {\n    return createErrorResponse(error as Error, generateRequestId())\n  }\n}\n\nexport const dynamic = 'force-dynamic'","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\metrics\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":19,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\n\n// 重定向到统一的度量API\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json().catch(() => ({}))\n    \n    // 转发到新的统一API\n    const response = await fetch(new URL('/api/data/metrics', request.url).toString(), {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(body)\n    })\n    \n    const data = await response.json()\n    return NextResponse.json(data, { status: response.status })\n  } catch (e) {\n    return NextResponse.json({ ok: false }, { status: 400 })\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  // 重定向到新API\n  const url = new URL('/api/data/metrics', request.url)\n  return NextResponse.redirect(url, 301)\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\users\\[id]\\model-stats\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'createErrorResponse' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"createErrorResponse"},"fix":{"range":[65,85],"text":""},"desc":"Remove unused variable 'createErrorResponse'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'generateRequestId' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"generateRequestId"},"fix":{"range":[84,103],"text":""},"desc":"Remove unused variable 'generateRequestId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\"\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\nimport { getToken } from \"next-auth/jwt\"\nimport { prisma } from \"@/lib/prisma\"\nimport { \n  getModelDisplayName, \n  getModelProvider, \n  calculateUsagePercentage,\n  formatStatsNumber\n} from \"@/lib/ai/model-stats-helper\"\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // 验证用户身份\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) {\n      return NextResponse.json({ error: \"未认证\" }, { status: 401 })\n    }\n\n    const { id: userId } = await params  \n    const requesterId = String(token.sub)\n\n    // 验证权限：用户只能查看自己的统计\n    if (userId !== requesterId) {\n      return NextResponse.json({ error: \"无权限\" }, { status: 403 })\n    }\n\n    // 获取查询参数\n    const url = new URL(request.url)\n    const days = parseInt(url.searchParams.get('days') || '30')\n    const startDate = new Date()\n    startDate.setDate(startDate.getDate() - days)\n    startDate.setUTCHours(0, 0, 0, 0)\n\n    // 查询用户的统计数据（包括按模型分组的数据）\n    const usageStats = await prisma.usageStats.findMany({\n      where: {\n        userId,\n        date: {\n          gte: startDate\n        }\n      },\n      select: {\n        date: true,\n        modelId: true,\n        modelProvider: true,\n        totalTokens: true,\n        apiCalls: true,\n        promptTokens: true,\n        completionTokens: true,\n      },\n      orderBy: {\n        date: 'desc'\n      }\n    })\n\n    // 分离总量数据和模型数据\n    const totalStats = usageStats.filter(stat => stat.modelId === \"_total\")\n    const modelStats = usageStats.filter(stat => stat.modelId && stat.modelId !== \"_total\")\n\n    // 计算总体统计\n    const totalTokens = totalStats.reduce((sum, stat) => sum + stat.totalTokens, 0)\n    const totalRequests = totalStats.reduce((sum, stat) => sum + stat.apiCalls, 0)\n\n    // 按模型聚合统计\n    const modelAggregated: Record<string, {\n      totalTokens: number\n      requests: number\n      promptTokens: number\n      completionTokens: number\n      provider: string\n      displayName: string\n    }> = {}\n\n    modelStats.forEach(stat => {\n      if (!stat.modelId || stat.modelId === \"_total\") return\n      \n      if (!modelAggregated[stat.modelId]) {\n        modelAggregated[stat.modelId] = {\n          totalTokens: 0,\n          requests: 0,\n          promptTokens: 0,\n          completionTokens: 0,\n          provider: stat.modelProvider || getModelProvider(stat.modelId),\n          displayName: getModelDisplayName(stat.modelId)\n        }\n      }\n\n      modelAggregated[stat.modelId].totalTokens += stat.totalTokens\n      modelAggregated[stat.modelId].requests += stat.apiCalls\n      modelAggregated[stat.modelId].promptTokens += stat.promptTokens\n      modelAggregated[stat.modelId].completionTokens += stat.completionTokens\n    })\n\n    // 计算每个模型的使用量百分比\n    const modelStatsWithPercentage = Object.entries(modelAggregated).map(([modelId, stats]) => ({\n      modelId,\n      ...stats,\n      percentage: calculateUsagePercentage(stats.totalTokens, totalTokens),\n      formattedTokens: formatStatsNumber(stats.totalTokens),\n      formattedRequests: formatStatsNumber(stats.requests)\n    }))\n\n    // 按使用量排序\n    modelStatsWithPercentage.sort((a, b) => b.totalTokens - a.totalTokens)\n\n    // 按日期整理数据（用于图表）\n    const dailyStatsMap: Record<string, Record<string, { tokens: number; requests: number }>> = {}\n\n    modelStats.forEach(stat => {\n      if (!stat.modelId) return\n      \n      const dateKey = stat.date.toISOString().split('T')[0]\n      \n      if (!dailyStatsMap[dateKey]) {\n        dailyStatsMap[dateKey] = {}\n      }\n      \n      if (!dailyStatsMap[dateKey][stat.modelId]) {\n        dailyStatsMap[dateKey][stat.modelId] = { tokens: 0, requests: 0 }\n      }\n      \n      dailyStatsMap[dateKey][stat.modelId].tokens += stat.totalTokens\n      dailyStatsMap[dateKey][stat.modelId].requests += stat.apiCalls\n    })\n\n    const dailyStats = Object.entries(dailyStatsMap).map(([date, models]) => ({\n      date,\n      models\n    })).sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n\n    // 构造响应数据\n    const response = {\n      success: true,\n      data: {\n        totalStats: {\n          totalTokens,\n          totalRequests,\n          formattedTokens: formatStatsNumber(totalTokens),\n          formattedRequests: formatStatsNumber(totalRequests),\n          avgTokensPerRequest: totalRequests > 0 ? Math.round(totalTokens / totalRequests) : 0\n        },\n        modelStats: modelStatsWithPercentage.reduce((acc, model) => {\n          acc[model.modelId] = {\n            displayName: model.displayName,\n            provider: model.provider,\n            totalTokens: model.totalTokens,\n            requests: model.requests,\n            promptTokens: model.promptTokens,\n            completionTokens: model.completionTokens,\n            percentage: model.percentage,\n            formattedTokens: model.formattedTokens,\n            formattedRequests: model.formattedRequests\n          }\n          return acc\n        }, {} as Record<string, any>),\n        dailyStats,\n        summary: {\n          queryDays: days,\n          totalModels: Object.keys(modelAggregated).length,\n          mostUsedModel: modelStatsWithPercentage[0]?.modelId || null,\n          leastUsedModel: modelStatsWithPercentage[modelStatsWithPercentage.length - 1]?.modelId || null,\n          hasData: modelStatsWithPercentage.length > 0\n        }\n      }\n    }\n\n    return NextResponse.json(response)\n\n  } catch (error) {\n    return NextResponse.json(\n      { \n        success: false, \n        error: \"获取模型统计失败\", \n        details: process.env.NODE_ENV === 'development' ? String(error) : undefined \n      }, \n      { status: 500 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\api\\users\\[id]\\route.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'deletedUser' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":188,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":188,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { prisma } from '@/lib/prisma'\nimport { getToken } from 'next-auth/jwt'\nimport { createErrorResponse, generateRequestId } from '@/lib/api/error-handler'\n\n// 获取单个用户详情（受保护）\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const token = await getToken({ req: request as any })\n    if (!token?.sub) return NextResponse.json({ error: '未认证' }, { status: 401 })\n\n    const { id } = await params\n    \n    const user = await prisma.user.findUnique({\n      where: { id },\n      include: {\n        conversations: {\n          select: {\n            id: true,\n            title: true,\n            messageCount: true,\n            totalTokens: true,\n            createdAt: true,\n            updatedAt: true,\n          },\n          orderBy: { updatedAt: 'desc' },\n          take: 5, // 最近5个对话\n        },\n        documents: {\n          select: {\n            id: true,\n            title: true,\n            wordCount: true,\n            createdAt: true,\n            updatedAt: true,\n          },\n          orderBy: { updatedAt: 'desc' },\n          take: 5, // 最近5个文档\n        },\n        usageStats: {\n          select: {\n            date: true,\n            totalTokens: true,\n            apiCalls: true,\n            modelId: true,          // 新增\n            modelProvider: true,    // 新增\n          },\n          orderBy: { date: 'desc' },\n          take: 90, // 增加数量，因为有模型分组\n        },\n        _count: {\n          select: {\n            conversations: true,\n            documents: true,\n            feedbacks: true,\n          }\n        }\n      }\n    })\n    \n    if (!user) {\n      return NextResponse.json(\n        { error: '用户不存在' },\n        { status: 404 }\n      )\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: user\n    })\n  } catch (error) {\n    return createErrorResponse(error as Error, generateRequestId())\n  }\n}\n\n// 更新用户\nexport async function PATCH(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n    const body = await request.json()\n    const { \n      username, \n      displayName, \n      role, \n      status, \n      monthlyTokenLimit, \n      currentMonthUsage \n    } = body\n    \n    // 检查用户是否存在\n    const existingUser = await prisma.user.findUnique({\n      where: { id }\n    })\n    \n    if (!existingUser) {\n      return NextResponse.json(\n        { error: '用户不存在' },\n        { status: 404 }\n      )\n    }\n    \n    // 检查用户名冲突\n    if (username && username !== existingUser.username) {\n      const usernameExists = await prisma.user.findFirst({\n        where: {\n          username,\n          id: { not: id }\n        }\n      })\n      \n      if (usernameExists) {\n        return NextResponse.json(\n          { error: '用户名已存在' },\n          { status: 409 }\n        )\n      }\n    }\n    \n    // 更新用户\n    const updatedUser = await prisma.user.update({\n      where: { id },\n      data: {\n        username,\n        displayName,\n        role,\n        status,\n        monthlyTokenLimit,\n        currentMonthUsage,\n        updatedAt: new Date(),\n      },\n      select: {\n        id: true,\n        email: true,\n        username: true,\n        displayName: true,\n        role: true,\n        status: true,\n        monthlyTokenLimit: true,\n        currentMonthUsage: true,\n        totalTokenUsed: true,\n        createdAt: true,\n        updatedAt: true,\n      }\n    })\n    \n    return NextResponse.json({\n      success: true,\n      data: updatedUser,\n      message: '用户更新成功'\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '更新用户失败' },\n      { status: 500 }\n    )\n  }\n}\n\n// 删除用户\nexport async function DELETE(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n    \n    // 检查用户是否存在\n    const existingUser = await prisma.user.findUnique({\n      where: { id }\n    })\n    \n    if (!existingUser) {\n      return NextResponse.json(\n        { error: '用户不存在' },\n        { status: 404 }\n      )\n    }\n    \n    // 软删除：更新状态为 DELETED\n    const deletedUser = await prisma.user.update({\n      where: { id },\n      data: {\n        status: 'DELETED',\n        updatedAt: new Date(),\n      }\n    })\n    \n    return NextResponse.json({\n      success: true,\n      message: '用户删除成功'\n    })\n  } catch (error) {\n    void error\n    return NextResponse.json(\n      { error: '删除用户失败' },\n      { status: 500 }\n    )\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\documents\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CardDescription' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":44,"suggestions":[{"messageId":"removeVar","data":{"varName":"CardDescription"},"fix":{"range":[224,241],"text":""},"desc":"Remove unused variable 'CardDescription'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'ChevronDown' is defined but never used. Allowed unused vars must match /^_/u.","line":39,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"ChevronDown"},"fix":{"range":[1458,1473],"text":""},"desc":"Remove unused variable 'ChevronDown'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'mockFolders' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":72,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":28},{"ruleId":"no-unused-vars","severity":1,"message":"'mockDocuments' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":92,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":92,"endColumn":32},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":134,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":134,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":144,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":144,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":147,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":147,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'CATS_KEY' and 'DOCS_KEY'. Either include them or remove the dependency array.","line":149,"column":6,"nodeType":"ArrayExpression","endLine":149,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [CATS_KEY, DOCS_KEY]","fix":{"range":[4669,4671],"text":"[CATS_KEY, DOCS_KEY]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":156,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":156,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'DOCS_KEY'. Either include it or remove the dependency array.","line":158,"column":6,"nodeType":"ArrayExpression","endLine":158,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [DOCS_KEY, documents]","fix":{"range":[4906,4917],"text":"[DOCS_KEY, documents]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":165,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":165,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'CATS_KEY'. Either include it or remove the dependency array.","line":167,"column":6,"nodeType":"ArrayExpression","endLine":167,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [CATS_KEY, categories]","fix":{"range":[5141,5153],"text":"[CATS_KEY, categories]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from \"@/components/ui/dropdown-menu\"\nimport { Header } from \"@/components/header\"\nimport { PageTransition } from \"@/components/ui/page-transition\"\nimport { ConnectionStatus } from \"@/components/ui/connection-status\"\nimport dynamic from 'next/dynamic'\n\n// 懒加载重型组件\nconst MarkdownEditor = dynamic(() => import(\"@/components/documents/markdown-editor\").then(mod => ({ default: mod.MarkdownEditor })), {\n  loading: () => (\n    <div className=\"h-96 bg-muted animate-pulse rounded-lg flex items-center justify-center\">\n      <div className=\"text-muted-foreground\">加载编辑器中...</div>\n    </div>\n  ),\n  ssr: false // 编辑器不需要SSR\n})\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { ToastAction } from \"@/components/ui/toast\"\nimport { useToast } from \"@/hooks/use-toast\"\nimport {\n  Plus,\n  Search,\n  FileText,\n  Calendar,\n  Clock,\n  MoreHorizontal,\n  Edit,\n  Trash2,\n  Copy,\n  Download,\n  ChevronDown,\n  SortAsc,\n  ArrowLeft,\n  Folder,\n} from \"lucide-react\"\n\ntype ViewMode = \"grid\" | \"edit\" | \"create\"\ntype SortBy = \"recent\" | \"created\" | \"title\" | \"modified\"\n\ninterface Document {\n  id: string\n  title: string\n  content: string\n  category: string\n  tags: string[]\n  createdAt: string\n  updatedAt: string\n  version: number\n  wordCount: number\n  status: string\n  author: string\n  aiGenerated: boolean\n  folderId: string\n}\n\ninterface Folder {\n  id: string\n  name: string\n  icon: string\n  count: number\n  children?: Folder[]\n}\n\nconst mockFolders: Folder[] = [\n  { id: \"all\", name: \"所有文档\", icon: \"\", count: 24 },\n  { id: \"recent\", name: \"最近打开\", icon: \"\", count: 8 },\n  { id: \"favorites\", name: \"收藏夹\", icon: \"\", count: 5 },\n  { id: \"ai-generated\", name: \"AI生成\", icon: \"\", count: 12 },\n  {\n    id: \"categories\",\n    name: \"分类\",\n    icon: \"\",\n    count: 0,\n    children: [\n      { id: \"video-scripts\", name: \"短视频文案\", icon: \"\", count: 8 },\n      { id: \"product-intro\", name: \"产品介绍\", icon: \"\", count: 6 },\n      { id: \"travel-guides\", name: \"旅游攻略\", icon: \"\", count: 4 },\n      { id: \"food-content\", name: \"美食内容\", icon: \"\", count: 6 },\n    ],\n  },\n  { id: \"trash\", name: \"回收站\", icon: \"\", count: 3 },\n]\n\nconst mockDocuments: Document[] = []\n\nexport default function DocumentsPage() {\n  const [viewMode, setViewMode] = useState<ViewMode>(\"grid\")\n  const [selectedDocument, setSelectedDocument] = useState<Document | null>(null)\n  const [selectedFolder, setSelectedFolder] = useState(\"all\")\n  const [searchQuery, setSearchQuery] = useState(\"\")\n  const [sortBy, setSortBy] = useState<SortBy>(\"recent\")\n  // 本地状态管理：文档与分类（扁平）\n  const [documents, setDocuments] = useState<Document[]>([])\n  const [categories, setCategories] = useState<string[]>([])\n  const [newCategory, setNewCategory] = useState(\"\")\n  // 移动到分类对话框状态\n  const [moveDialogOpen, setMoveDialogOpen] = useState(false)\n  const [movingDoc, setMovingDoc] = useState<Document | null>(null)\n  const [targetCategory, setTargetCategory] = useState<string>(\"\")\n  const [moveNewCategory, setMoveNewCategory] = useState(\"\")\n  const [undoSnapshot, setUndoSnapshot] = useState<{ documents: Document[]; categories: string[] } | null>(null)\n  const { toast } = useToast()\n\n  // localStorage keys & version\n  const LS_VERSION = 1\n  const DOCS_KEY = `documents_v${LS_VERSION}`\n  const CATS_KEY = `categories_v${LS_VERSION}`\n\n  // 工具：捕获当前状态快照\n  const captureSnapshot = () => ({\n    documents: documents.map((d) => ({ ...d })),\n    categories: [...categories],\n  })\n  // 初始化：从 localStorage 读取\n  useEffect(() => {\n    try {\n      const rawDocs = typeof window !== 'undefined' ? window.localStorage.getItem(DOCS_KEY) : null\n      const rawCats = typeof window !== 'undefined' ? window.localStorage.getItem(CATS_KEY) : null\n\n      if (rawDocs) {\n        try {\n          const parsed = JSON.parse(rawDocs)\n          if (Array.isArray(parsed)) {\n            setDocuments(parsed)\n          }\n        } catch (e) {\n          }\n      }\n\n      if (rawCats) {\n        try {\n          const parsed = JSON.parse(rawCats)\n          if (Array.isArray(parsed)) {\n            setCategories(parsed)\n          }\n        } catch (e) {\n          }\n      }\n    } catch (err) {\n      }\n  }, [])\n\n  // 同步：documents 变化时写入 localStorage（节流可选，这里直接写入）\n  useEffect(() => {\n    try {\n      if (typeof window === 'undefined') return\n      window.localStorage.setItem(DOCS_KEY, JSON.stringify(documents))\n    } catch (err) {\n      }\n  }, [documents])\n\n  // 同步：categories 变化时写入 localStorage\n  useEffect(() => {\n    try {\n      if (typeof window === 'undefined') return\n      window.localStorage.setItem(CATS_KEY, JSON.stringify(categories))\n    } catch (err) {\n      }\n  }, [categories])\n\n\n  const handleCreateNew = () => {\n    setSelectedDocument(null)\n    setViewMode(\"create\")\n  }\n\n  const handleEdit = (document: Document) => {\n    setSelectedDocument(document)\n    setViewMode(\"edit\")\n  }\n\n  const handleSave = (doc: any) => {\n    // 快照：保存前状态（用于撤销编辑/保存）\n    setUndoSnapshot(captureSnapshot())\n\n    // 保存或更新文档\n    setDocuments((prev) => {\n      const exists = prev.some((d) => d.id === doc.id)\n      if (exists) {\n        return prev.map((d) => (d.id === doc.id ? { ...doc } : d))\n      }\n      return [{ ...doc }, ...prev]\n    })\n\n    // 同步分类（如有新分类则追加）\n    if (doc.category && !categories.includes(doc.category)) {\n      setCategories((prev) => [...prev, doc.category])\n    }\n\n    toast({\n      title: \"已保存\",\n      description: \"文档已保存（可撤销）\",\n      action: <ToastAction altText=\"撤销保存\" onClick={undoLast}>撤销</ToastAction>,\n    })\n\n    setViewMode(\"grid\")\n    setSelectedDocument(null)\n  }\n\n  const handleCancel = () => {\n    setViewMode(\"grid\")\n    setSelectedDocument(null)\n  }\n\n  const handleAddCategory = () => {\n    const name = newCategory.trim()\n    if (!name) return\n\n    // 快照\n    setUndoSnapshot(captureSnapshot())\n\n    if (!categories.includes(name)) {\n      setCategories((prev) => [...prev, name])\n    }\n    setNewCategory(\"\")\n\n    toast({\n      title: \"已添加分类\",\n      description: `已创建分类：${name}（可撤销）`,\n      action: <ToastAction altText=\"撤销创建分类\" onClick={() => undoLast()}>撤销</ToastAction>,\n    })\n  }\n\n  const undoLast = () => {\n    if (!undoSnapshot) return\n    setDocuments(undoSnapshot.documents)\n    setCategories(undoSnapshot.categories)\n    setUndoSnapshot(null)\n    toast({ title: \"已撤销\", description: \"操作已撤销\" })\n  }\n\n  const handleDelete = (id: string) => {\n    // 保存快照\n    const snapshot = { documents: documents.map((d) => ({ ...d })), categories: [...categories] }\n    setUndoSnapshot(snapshot)\n\n    // 删除文档\n    setDocuments((prev) => prev.filter((d) => d.id !== id))\n\n    // Toast 提供撤销\n    toast({\n      title: \"已删除\",\n      description: \"文档已删除（可撤销）\",\n      action: (\n        <ToastAction altText=\"撤销删除\" onClick={undoLast}>\n          撤销\n        </ToastAction>\n      ),\n    })\n  }\n\n  const filteredDocuments = documents.filter((doc) => {\n    const matchesSearch =\n      doc.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      doc.tags.some((tag) => tag.toLowerCase().includes(searchQuery.toLowerCase()))\n\n    const matchesCategory = selectedFolder === \"all\" || (doc.category || \"\") === selectedFolder\n\n    return matchesSearch && matchesCategory\n  })\n\n  const sortedDocuments = [...filteredDocuments].sort((a, b) => {\n    switch (sortBy) {\n      case \"recent\":\n        return new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime()\n      case \"created\":\n        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n      case \"title\":\n        return a.title.localeCompare(b.title)\n      case \"modified\":\n        return new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime()\n      default:\n        return 0\n    }\n  })\n\n\n\n  if (viewMode === \"edit\" || viewMode === \"create\") {\n    return (\n      <PageTransition>\n        <div className=\"min-h-screen bg-background\">\n          <Header />\n          <div className=\"container mx-auto py-4\">\n            <div className=\"flex items-center justify-end mb-4\">\n              <Button variant=\"outline\" onClick={() => setViewMode(\"grid\")} className=\"gap-2\">\n                <ArrowLeft className=\"h-4 w-4\" />\n                返回\n              </Button>\n            </div>\n          </div>\n          <MarkdownEditor document={selectedDocument || undefined} onSave={handleSave} onCancel={handleCancel} />\n        </div>\n      </PageTransition>\n    )\n  }\n\n  return (\n    <PageTransition>\n      <div className=\"min-h-screen bg-background\">\n        <Header />\n        \n        {/* 连接状态指示器 - 文档页面 */}\n        <ConnectionStatus\n          position=\"fixed\"\n          size=\"sm\"\n          className=\"top-20 right-4 z-[45]\"\n          animated={true}\n          showDetails={false}\n          autoHideWhenHealthy={true}\n        />\n\n        <div className=\"container mx-auto py-4\" />\n\n        <div className=\"flex h-[calc(100vh-120px)]\">\n          <div className=\"w-64 border-r border-border bg-background flex-shrink-0\">\n            <div className=\"p-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <h2 className=\"font-semibold text-sm\">分类</h2>\n                <Button size=\"sm\" onClick={handleCreateNew} className=\"gap-1 h-7 px-2\">\n                  <Plus className=\"h-3 w-3\" />\n                  <span className=\"text-xs\">新建文档</span>\n                </Button>\n              </div>\n\n              <div className=\"flex items-center gap-2 mb-3\">\n                <Input\n                  placeholder=\"新建分类...\"\n                  value={newCategory}\n                  onChange={(e) => setNewCategory(e.target.value)}\n                  className=\"h-8 text-xs\"\n                />\n                <Button size=\"sm\" variant=\"outline\" className=\"h-8 px-2\" onClick={handleAddCategory}>\n                  添加\n                </Button>\n              </div>\n\n              <ScrollArea className=\"h-[calc(100vh-170px)]\">\n                <div className=\"space-y-1\">\n                  <div\n                    className={`flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-colors hover:bg-muted/50 ${\n                      selectedFolder === \"all\" ? \"bg-muted\" : \"\"\n                    }`}\n                    onClick={() => setSelectedFolder(\"all\")}\n                  >\n                    <span className=\"text-sm flex-1\">全部</span>\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      {documents.length}\n                    </Badge>\n                  </div>\n\n                  {categories.map((cat) => {\n                    const count = documents.filter((d) => (d.category || \"\") === cat).length\n                    return (\n                      <div\n                        key={cat}\n                        className={`flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition-colors hover:bg-muted/50 ${\n                          selectedFolder === cat ? \"bg-muted\" : \"\"\n                        }`}\n                        onClick={() => setSelectedFolder(cat)}\n                      >\n                        <span className=\"text-sm flex-1\">{cat}</span>\n                        {count > 0 && (\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            {count}\n                          </Badge>\n                        )}\n                      </div>\n                    )\n                  })}\n                </div>\n              </ScrollArea>\n            </div>\n          </div>\n\n          <div className=\"flex-1 flex flex-col\">\n            {/* 工具栏 */}\n            <div className=\"border-b border-border p-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <div>\n                  <h1 className=\"text-xl font-semibold text-foreground\">\n                    {selectedFolder === \"all\" ? \"全部文档\" : selectedFolder || \"未分类\"}\n                  </h1>\n                  <p className=\"text-sm text-muted-foreground\">共 {sortedDocuments.length} 个文档</p>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"outline\" size=\"sm\" className=\"gap-2 bg-transparent\">\n                        <SortAsc className=\"h-4 w-4\" />\n                        排序\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent>\n                      <DropdownMenuItem onClick={() => setSortBy(\"recent\")}>\n                        <Clock className=\"h-4 w-4 mr-2\" />\n                        最近打开\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => setSortBy(\"created\")}>\n                        <Calendar className=\"h-4 w-4 mr-2\" />\n                        创建时间\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => setSortBy(\"title\")}>\n                        <FileText className=\"h-4 w-4 mr-2\" />\n                        标题\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => setSortBy(\"modified\")}>\n                        <Edit className=\"h-4 w-4 mr-2\" />\n                        修改时间\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n              </div>\n\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"搜索文档...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n            </div>\n\n            {/* 文档网格 */}\n            <ScrollArea className=\"flex-1 p-4\">\n              {sortedDocuments.length === 0 ? (\n                <div className=\"flex items-center justify-center h-64\">\n                  <div className=\"text-center\">\n                    <FileText className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                    <h3 className=\"font-medium text-foreground mb-2\">暂无文档</h3>\n                    <p className=\"text-sm text-muted-foreground mb-4\">\n                      {searchQuery ? \"未找到匹配的文档\" : \"开始创建您的第一个文档\"}\n                    </p>\n                    <Button onClick={handleCreateNew} className=\"gap-2\">\n                      <Plus className=\"h-4 w-4\" />\n                      新建文档\n                    </Button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n                  {sortedDocuments.map((document) => (\n                    <Card key={document.id} className=\"hover:shadow-md transition-shadow cursor-pointer group\">\n                      <CardHeader className=\"pb-3\">\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1 min-w-0\">\n                            <CardTitle className=\"text-sm font-medium truncate\">{document.title}</CardTitle>\n                            <div className=\"text-xs mt-1 flex items-center gap-2\">\n                              <Select\n                                value={(document.category && document.category.length > 0) ? document.category : \"__UNCATEGORIZED__\"}\n                                onValueChange={(v) => {\n                                  // 保存快照\n                                  setUndoSnapshot(captureSnapshot())\n                                  const newCategory = v === \"__UNCATEGORIZED__\" ? \"\" : v\n                                  setDocuments((prev) => prev.map((d) => d.id === document.id ? { ...d, category: newCategory } : d))\n                                  if (newCategory && !categories.includes(newCategory)) {\n                                    setCategories((prev) => [...prev, newCategory])\n                                  }\n                                  toast({\n                                    title: \"分类已更新\",\n                                    description: `已将文档分类设置为 ${newCategory || \"无分类\"}`,\n                                    action: (<ToastAction altText=\"撤销分类变更\" onClick={undoLast}>撤销</ToastAction>),\n                                  })\n                                }}\n                              >\n                                <SelectTrigger className=\"h-6 px-2 py-0 text-xs w-auto min-w-[80px]\">\n                                  <SelectValue placeholder=\"选择分类\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  <SelectItem value=\"__UNCATEGORIZED__\">无分类</SelectItem>\n                                  {categories.map((cat) => (\n                                    <SelectItem key={cat} value={cat}>\n                                      {cat}\n                                    </SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                            </div>\n                          </div>\n                          <DropdownMenu>\n                            <DropdownMenuTrigger asChild>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-6 w-6 p-0 opacity-0 group-hover:opacity-100\"\n                              >\n                                <MoreHorizontal className=\"h-4 w-4\" />\n                              </Button>\n                            </DropdownMenuTrigger>\n                            <DropdownMenuContent>\n                              <DropdownMenuItem onClick={() => handleEdit(document)}>\n                                <Edit className=\"h-4 w-4 mr-2\" />\n                                编辑\n                              </DropdownMenuItem>\n                              <DropdownMenuItem onClick={() => { setMovingDoc(document); setTargetCategory(document.category && document.category.length > 0 ? document.category : \"__UNCATEGORIZED__\"); setMoveDialogOpen(true) }}>\n                                <Folder className=\"h-4 w-4 mr-2\" />\n                                移动到分类\n                              </DropdownMenuItem>\n                              <DropdownMenuItem>\n                                <Copy className=\"h-4 w-4 mr-2\" />\n                                复制\n                              </DropdownMenuItem>\n                              <DropdownMenuItem>\n                                <Download className=\"h-4 w-4 mr-2\" />\n                                导出\n                              </DropdownMenuItem>\n                              <DropdownMenuItem className=\"text-destructive\" onClick={() => handleDelete(document.id)}>\n                                <Trash2 className=\"h-4 w-4 mr-2\" />\n                                删除\n                              </DropdownMenuItem>\n                            </DropdownMenuContent>\n                          </DropdownMenu>\n                        </div>\n                      </CardHeader>\n                      <CardContent className=\"pt-0\" onClick={() => handleEdit(document)}>\n                        <div className=\"space-y-3\">\n                          <div className=\"flex items-center gap-2 flex-wrap\">\n                            {document.tags.slice(0, 2).map((tag) => (\n                              <Badge key={tag} variant=\"secondary\" className=\"text-xs\">\n                                {tag}\n                              </Badge>\n                            ))}\n                            {document.aiGenerated && (\n                              <Badge variant=\"outline\" className=\"text-xs border-blue-500 text-blue-600\">\n                                AI\n                              </Badge>\n                            )}\n                          </div>\n\n                          <div className=\"text-xs text-muted-foreground space-y-1\">\n                            <div className=\"flex items-center justify-between\">\n                              <span>字数: {document.wordCount}</span>\n                              <span>v{document.version}</span>\n                            </div>\n                            <div className=\"flex items-center justify-between\">\n                              <span>{document.updatedAt}</span>\n                              <Badge\n                                variant={document.status === \"已发布\" ? \"default\" : \"secondary\"}\n                                className=\"text-xs\"\n                              >\n                                {document.status}\n                              </Badge>\n                            </div>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </ScrollArea>\n          </div>\n        </div>\n      </div>\n\n      {/* 移动到分类 对话框 */}\n      <Dialog open={moveDialogOpen} onOpenChange={setMoveDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>移动到分类</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <Input\n                placeholder=\"新建分类...\"\n                value={moveNewCategory}\n                onChange={(e) => setMoveNewCategory(e.target.value)}\n                className=\"h-9\"\n              />\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  const name = moveNewCategory.trim()\n                  if (!name) return\n                  // 快照\n                  setUndoSnapshot(captureSnapshot())\n\n                  if (!categories.includes(name)) {\n                    setCategories((prev) => [...prev, name])\n                  }\n                  setTargetCategory(name)\n                  setMoveNewCategory(\"\")\n                  toast({\n                    title: \"已添加分类\",\n                    description: `已创建分类：${name}（可撤销）`,\n                    action: (\n                      <ToastAction altText=\"撤销创建分类\" onClick={undoLast}>\n                        撤销\n                      </ToastAction>\n                    ),\n                  })\n                }}\n              >\n                添加新分类\n              </Button>\n            </div>\n\n            <Select value={targetCategory} onValueChange={(v) => setTargetCategory(v)}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"选择分类\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"__UNCATEGORIZED__\">无分类</SelectItem>\n                {categories.map((cat) => (\n                  <SelectItem key={cat} value={cat}>\n                    {cat}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n\n            <div className=\"flex justify-end gap-2 pt-2\">\n              <Button variant=\"outline\" onClick={() => setMoveDialogOpen(false)}>取消</Button>\n              <Button\n                onClick={() => {\n                  if (!movingDoc) return\n\n                  // 保存快照\n                  const snapshot = { documents: documents.map((d) => ({ ...d })), categories: [...categories] }\n                  setUndoSnapshot(snapshot)\n\n                  const newCategory = targetCategory === \"__UNCATEGORIZED__\" ? \"\" : targetCategory\n\n                  // 更新文档分类\n                  setDocuments((prev) => prev.map((d) => (d.id === movingDoc.id ? { ...d, category: newCategory } : d)))\n\n                  // 分类列表维护：目标分类若不存在且非空，加入；无需从列表删除旧分类（可能仍被其他文档使用）\n                  if (newCategory && !categories.includes(newCategory)) {\n                    setCategories((prev) => [...prev, newCategory])\n                  }\n\n                  setMoveDialogOpen(false)\n                  setMovingDoc(null)\n                  toast({\n                    title: \"已移动\",\n                    description: `文档已移动到 ${newCategory || \"无分类\"}`,\n                    action: (\n                      <ToastAction altText=\"撤销移动\" onClick={undoLast}>\n                        撤销\n                      </ToastAction>\n                    ),\n                  })\n                }}\n              >\n                确认移动\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </PageTransition>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\help\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'selectedCategory' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":104,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"selectedCategory"},"fix":{"range":[3138,3154],"text":""},"desc":"Remove unused variable 'selectedCategory'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setSelectedCategory' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":104,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"setSelectedCategory"},"fix":{"range":[3154,3175],"text":""},"desc":"Remove unused variable 'setSelectedCategory'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Input } from \"@/components/ui/input\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\"\nimport { Header } from \"@/components/header\"\nimport { PageTransition } from \"@/components/ui/page-transition\"\nimport { KeyboardShortcuts } from \"@/components/help/keyboard-shortcuts\"\nimport { Search, BookOpen, MessageSquare, FileText, TrendingUp, Lightbulb, HelpCircle, Video, Zap } from \"lucide-react\"\n\nconst helpCategories = [\n  {\n    id: \"getting-started\",\n    title: \"快速开始\",\n    icon: <Zap className=\"h-5 w-5\" />,\n    description: \"了解平台基础功能\",\n    articles: [\n      { title: \"平台介绍\", content: \"支点有星辰是一个专业的AI创作平台...\" },\n      { title: \"注册和登录\", content: \"如何创建账户和登录平台...\" },\n      { title: \"界面导览\", content: \"熟悉平台的主要界面和功能...\" },\n    ],\n  },\n  {\n    id: \"ai-chat\",\n    title: \"AI对话\",\n    icon: <MessageSquare className=\"h-5 w-5\" />,\n    description: \"AI对话功能使用指南\",\n    articles: [\n      { title: \"开始对话\", content: \"如何与AI开始对话并获得最佳回复...\" },\n      { title: \"模型选择\", content: \"不同AI模型的特点和使用场景...\" },\n      { title: \"提示词技巧\", content: \"如何编写有效的提示词...\" },\n      { title: \"对话管理\", content: \"如何管理和组织您的对话历史...\" },\n    ],\n  },\n  {\n    id: \"documents\",\n    title: \"文档管理\",\n    icon: <FileText className=\"h-5 w-5\" />,\n    description: \"文档创建和管理\",\n    articles: [\n      { title: \"创建文档\", content: \"如何创建和编辑Markdown文档...\" },\n      { title: \"版本控制\", content: \"文档版本管理和历史记录...\" },\n      { title: \"分类标签\", content: \"使用分类和标签组织文档...\" },\n      { title: \"导出分享\", content: \"如何导出和分享您的文档...\" },\n    ],\n  },\n  {\n    id: \"trending\",\n    title: \"热门数据\",\n    icon: <TrendingUp className=\"h-5 w-5\" />,\n    description: \"热门数据分析功能\",\n    articles: [\n      { title: \"数据概览\", content: \"了解热门数据的来源和更新频率...\" },\n      { title: \"筛选搜索\", content: \"如何筛选和搜索特定的数据...\" },\n      { title: \"数据导出\", content: \"导出数据进行进一步分析...\" },\n    ],\n  },\n  {\n    id: \"inspiration\",\n    title: \"灵感库\",\n    icon: <Lightbulb className=\"h-5 w-5\" />,\n    description: \"创作灵感收集和管理\",\n    articles: [\n      { title: \"浏览灵感\", content: \"如何浏览和发现创作灵感...\" },\n      { title: \"收藏管理\", content: \"收藏和管理您喜欢的灵感...\" },\n      { title: \"分类筛选\", content: \"按分类和标签筛选灵感内容...\" },\n    ],\n  },\n]\n\nconst faqData = [\n  {\n    question: \"如何开始使用AI对话功能？\",\n    answer: \"点击导航栏中的'对话'按钮，然后在输入框中输入您的问题或需求，AI会为您提供专业的回答和建议。\",\n  },\n  {\n    question: \"支持哪些AI模型？\",\n    answer: \"平台支持GPT-4、GPT-3.5 Turbo、Claude等多种先进的AI模型，您可以根据需要选择合适的模型。\",\n  },\n  {\n    question: \"如何保存和管理创作的内容？\",\n    answer: \"您可以使用文档管理功能来保存、编辑和组织您的创作内容。支持Markdown格式和版本控制。\",\n  },\n  {\n    question: \"热门数据多久更新一次？\",\n    answer: \"热门数据每天更新，确保您获得最新的趋势信息和创作灵感。\",\n  },\n  {\n    question: \"如何提高AI回复的质量？\",\n    answer: \"提供清晰、具体的问题描述，使用相关的关键词，并在必要时提供上下文信息。\",\n  },\n  {\n    question: \"是否支持移动端使用？\",\n    answer: \"是的，平台完全支持移动端访问，您可以在手机和平板上正常使用所有功能。\",\n  },\n]\n\nexport default function HelpPage() {\n  const [searchQuery, setSearchQuery] = useState(\"\")\n  const [selectedCategory, setSelectedCategory] = useState(\"getting-started\")\n\n  const filteredCategories = helpCategories.filter(\n    (category) =>\n      category.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      category.articles.some((article) => article.title.toLowerCase().includes(searchQuery.toLowerCase())),\n  )\n\n  const filteredFAQ = faqData.filter(\n    (faq) =>\n      faq.question.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      faq.answer.toLowerCase().includes(searchQuery.toLowerCase()),\n  )\n\n  return (\n    <PageTransition>\n      <div className=\"min-h-screen bg-background\">\n        <Header />\n\n        <main className=\"container mx-auto py-4 md:py-8 px-4\">\n          <div className=\"max-w-6xl mx-auto space-y-6\">\n\n            {/* 页面标题 */}\n            <div className=\"text-center\">\n              <h1 className=\"text-2xl md:text-3xl font-bold text-foreground mb-2\">帮助中心</h1>\n              <p className=\"text-sm md:text-base text-muted-foreground\">找到您需要的帮助信息，快速上手使用平台功能</p>\n            </div>\n\n            {/* 搜索栏 */}\n            <Card>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"relative flex-1\">\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"搜索帮助内容...\"\n                      value={searchQuery}\n                      onChange={(e) => setSearchQuery(e.target.value)}\n                      className=\"pl-10\"\n                    />\n                  </div>\n                  <KeyboardShortcuts />\n                </div>\n              </CardContent>\n            </Card>\n\n            <Tabs defaultValue=\"guides\" className=\"space-y-6\">\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"guides\">使用指南</TabsTrigger>\n                <TabsTrigger value=\"faq\">常见问题</TabsTrigger>\n                <TabsTrigger value=\"video\">视频教程</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"guides\" className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                  {filteredCategories.map((category) => (\n                    <Card key={category.id} className=\"hover:shadow-md transition-shadow cursor-pointer\">\n                      <CardHeader>\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"p-2 bg-primary/10 rounded-lg\">{category.icon}</div>\n                          <div>\n                            <CardTitle className=\"text-lg\">{category.title}</CardTitle>\n                            <CardDescription>{category.description}</CardDescription>\n                          </div>\n                        </div>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-2\">\n                          {category.articles.slice(0, 3).map((article, index) => (\n                            <div\n                              key={index}\n                              className=\"text-sm text-muted-foreground hover:text-foreground cursor-pointer\"\n                            >\n                              • {article.title}\n                            </div>\n                          ))}\n                          {category.articles.length > 3 && (\n                            <div className=\"text-sm text-primary\">查看更多 ({category.articles.length - 3})</div>\n                          )}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"faq\" className=\"space-y-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <HelpCircle className=\"h-5 w-5\" />\n                      常见问题\n                    </CardTitle>\n                    <CardDescription>快速找到常见问题的答案</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <Accordion type=\"single\" collapsible className=\"w-full\">\n                      {filteredFAQ.map((faq, index) => (\n                        <AccordionItem key={index} value={`item-${index}`}>\n                          <AccordionTrigger className=\"text-left\">{faq.question}</AccordionTrigger>\n                          <AccordionContent className=\"text-muted-foreground\">{faq.answer}</AccordionContent>\n                        </AccordionItem>\n                      ))}\n                    </Accordion>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"video\" className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  {[\n                    { title: \"平台快速入门\", duration: \"5:30\", thumbnail: \"入门教程\" },\n                    { title: \"AI对话最佳实践\", duration: \"8:15\", thumbnail: \"对话技巧\" },\n                    { title: \"文档管理详解\", duration: \"6:45\", thumbnail: \"文档管理\" },\n                    { title: \"数据分析功能\", duration: \"7:20\", thumbnail: \"数据分析\" },\n                  ].map((video, index) => (\n                    <Card key={index} className=\"hover:shadow-md transition-shadow cursor-pointer\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-4\">\n                          <div className=\"w-20 h-16 bg-muted rounded-lg flex items-center justify-center\">\n                            <Video className=\"h-6 w-6 text-muted-foreground\" />\n                          </div>\n                          <div className=\"flex-1\">\n                            <h3 className=\"font-medium\">{video.title}</h3>\n                            <div className=\"flex items-center gap-2 mt-1\">\n                              <Badge variant=\"secondary\" className=\"text-xs\">\n                                {video.duration}\n                              </Badge>\n                              <span className=\"text-xs text-muted-foreground\">{video.thumbnail}</span>\n                            </div>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              </TabsContent>\n            </Tabs>\n\n            {/* 联系支持 */}\n            <Card>\n              <CardHeader>\n                <CardTitle>需要更多帮助？</CardTitle>\n                <CardDescription>如果您没有找到需要的信息，请联系我们的支持团队</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex flex-col sm:flex-row gap-4\">\n                  <Button className=\"gap-2\">\n                    <MessageSquare className=\"h-4 w-4\" />\n                    在线客服\n                  </Button>\n                  <Button variant=\"outline\" className=\"gap-2 bg-transparent\">\n                    <BookOpen className=\"h-4 w-4\" />\n                    提交反馈\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </main>\n      </div>\n    </PageTransition>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\inspiration\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'Eye' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"Eye"},"fix":{"range":[609,614],"text":""},"desc":"Remove unused variable 'Eye'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Bookmark' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"Bookmark"},"fix":{"range":[629,639],"text":""},"desc":"Remove unused variable 'Bookmark'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Share2' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":54,"suggestions":[{"messageId":"removeVar","data":{"varName":"Share2"},"fix":{"range":[639,647],"text":""},"desc":"Remove unused variable 'Share2'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"TrendingUp"},"fix":{"range":[647,662],"text":""},"desc":"Remove unused variable 'TrendingUp'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'BarChart3' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"BarChart3"},"fix":{"range":[685,696],"text":""},"desc":"Remove unused variable 'BarChart3'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'PlayCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":51,"suggestions":[{"messageId":"removeVar","data":{"varName":"PlayCircle"},"fix":{"range":[742,754],"text":""},"desc":"Remove unused variable 'PlayCircle'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'FileText' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":11,"suggestions":[{"messageId":"removeVar","data":{"varName":"FileText"},"fix":{"range":[754,766],"text":""},"desc":"Remove unused variable 'FileText'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'selectedVideo' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":97,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":97,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"selectedVideo"},"fix":{"range":[2410,2423],"text":""},"desc":"Remove unused variable 'selectedVideo'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'setSelectedVideo' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":97,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":97,"endColumn":41,"suggestions":[{"messageId":"removeVar","data":{"varName":"setSelectedVideo"},"fix":{"range":[2423,2441],"text":""},"desc":"Remove unused variable 'setSelectedVideo'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'isMobile' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":100,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":100,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":116,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":116,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\"\nimport { Header } from \"@/components/header\"\nimport { PageTransition } from \"@/components/ui/page-transition\"\nimport { ConnectionStatus } from \"@/components/ui/connection-status\"\nimport { useMobile } from \"@/hooks/use-mobile\"\nimport { \n  Heart, Search, Eye, MessageSquare, Bookmark, Share2, \n  TrendingUp, Calendar, User, Clock, BarChart3, Hash,\n  ChevronDown, ChevronUp, ExternalLink, PlayCircle,\n  FileText, AlertCircle\n} from \"lucide-react\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\n\ninterface Comment {\n  评论ID: string\n  评论时间: string\n  评论内容: string\n  点赞数量: number\n  回复数量: number\n  IP归属地: string\n}\n\ninterface Video {\n  id: string\n  desc: string\n  create_time: string\n  nickname: string\n  digg_count: number\n  comment_count: number\n  collect_count: number\n  share_count: number\n  share_url: string\n  text_extra: string[]\n  视频时长: string\n  评论详细信息: Comment[]\n  comment_count_actual: number\n}\n\ninterface KeywordData {\n  keyword_info: {\n    keyword: string\n    category: string\n  }\n  videos: Video[]\n  statistics: {\n    总视频数: number\n    总点赞数: number\n    总评论数: number\n    总收藏数: number\n    总分享数: number\n    实际评论总数: number\n    平均点赞数: number\n    平均评论数: number\n    平均收藏数: number\n    平均分享数: number\n    最早发布: string\n    最新发布: string\n    主要标签: string[]\n    主要创作者: string[]\n  }\n  metadata: {\n    created_at: string\n    last_updated: string\n    total_videos: number\n  }\n}\n\ninterface ApiResponse {\n  success: boolean\n  data?: KeywordData\n  availableKeywords?: string[]\n  currentKeyword?: string\n  message?: string\n}\n\nexport default function InspirationPage() {\n  const [loading, setLoading] = useState(true)\n  const [keywordData, setKeywordData] = useState<KeywordData | null>(null)\n  const [availableKeywords, setAvailableKeywords] = useState<string[]>([])\n  const [selectedKeyword, setSelectedKeyword] = useState(\"断桥铝门窗\")\n  const [searchQuery, setSearchQuery] = useState(\"\")\n  const [selectedVideo, setSelectedVideo] = useState<Video | null>(null)\n  const [expandedComments, setExpandedComments] = useState<string[]>([])\n  const [activeTab, setActiveTab] = useState(\"videos\")\n  const isMobile = useMobile()\n\n  // 获取关键字数据\n  const fetchKeywordData = async (keyword: string) => {\n    setLoading(true)\n    try {\n      const response = await fetch(`/api/keyword-data?keyword=${encodeURIComponent(keyword)}`)\n      const result: ApiResponse = await response.json()\n      \n      if (result.success && result.data) {\n        setKeywordData(result.data)\n        if (result.availableKeywords) {\n          setAvailableKeywords(result.availableKeywords)\n        }\n      } else {\n        }\n    } catch (error) {\n      } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    fetchKeywordData(selectedKeyword)\n  }, [selectedKeyword])\n\n  // 搜索过滤\n  const filteredVideos = keywordData?.videos.filter(video => {\n    if (!searchQuery) return true\n    const query = searchQuery.toLowerCase()\n    return (\n      video.desc.toLowerCase().includes(query) ||\n      video.nickname.toLowerCase().includes(query) ||\n      video.text_extra.some(tag => tag.toLowerCase().includes(query))\n    )\n  }) || []\n\n  // 切换评论展开\n  const toggleComments = (videoId: string) => {\n    setExpandedComments(prev => \n      prev.includes(videoId) \n        ? prev.filter(id => id !== videoId)\n        : [...prev, videoId]\n    )\n  }\n\n  // 格式化数字\n  const formatNumber = (num: number) => {\n    if (num >= 10000) {\n      return (num / 10000).toFixed(1) + 'w'\n    }\n    if (num >= 1000) {\n      return (num / 1000).toFixed(1) + 'k'\n    }\n    return num.toString()\n  }\n\n  // 获取评论热点\n  const getCommentInsights = () => {\n    if (!keywordData) return { questions: [], topics: [] }\n    \n    const allComments = keywordData.videos.flatMap(v => v.评论详细信息)\n    \n    // 提取问题（包含问号的评论）\n    const questions = allComments\n      .filter(c => c.评论内容.includes('?') || c.评论内容.includes('？'))\n      .sort((a, b) => (b.点赞数量 || 0) - (a.点赞数量 || 0))\n      .slice(0, 5)\n    \n    // 提取高频词\n    const wordCount: Record<string, number> = {}\n    const stopWords = ['的', '了', '吗', '这个', '是', '有', '我', '你', '在', '和', '就', '都', '也', '还', '吧', '啊']\n    \n    allComments.forEach(comment => {\n      const words = comment.评论内容.match(/[\\u4e00-\\u9fa5]{2,}/g) || []\n      words.forEach(word => {\n        if (!stopWords.includes(word)) {\n          wordCount[word] = (wordCount[word] || 0) + 1\n        }\n      })\n    })\n    \n    const topics = Object.entries(wordCount)\n      .sort((a, b) => b[1] - a[1])\n      .slice(0, 10)\n      .map(([word, count]) => ({ word, count }))\n    \n    return { questions, topics }\n  }\n\n  const { questions, topics } = getCommentInsights()\n\n  if (loading) {\n    return (\n      <PageTransition>\n        <div className=\"min-h-screen bg-background\">\n          <Header />\n          <main className=\"container mx-auto py-8 px-4\">\n            <div className=\"space-y-4\">\n              <Skeleton className=\"h-8 w-64 mx-auto\" />\n              <Skeleton className=\"h-4 w-96 mx-auto\" />\n              <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                {[1, 2, 3].map(i => (\n                  <Skeleton key={i} className=\"h-64\" />\n                ))}\n              </div>\n            </div>\n          </main>\n        </div>\n      </PageTransition>\n    )\n  }\n\n  return (\n    <PageTransition>\n      <div className=\"min-h-screen bg-background\">\n        <Header />\n        \n        {/* 连接状态指示器 - 视频内容洞察页面 */}\n        <ConnectionStatus\n          position=\"fixed\"\n          size=\"sm\"\n          className=\"top-20 right-4 z-[45]\"\n          animated={true}\n          showDetails={false}\n          autoHideWhenHealthy={true}\n        />\n\n        <main className=\"container mx-auto py-4 md:py-8 px-4\">\n          <div className=\"max-w-7xl mx-auto space-y-6\">\n            \n            {/* 页面标题 */}\n            <div className=\"text-center\">\n              <h1 className=\"text-2xl md:text-3xl font-bold text-foreground mb-2\">视频内容洞察</h1>\n              <p className=\"text-sm md:text-base text-muted-foreground\">深度分析视频内容趋势，洞察用户需求与关注点</p>\n            </div>\n\n            {/* 关键字选择和搜索 */}\n            <div className=\"flex flex-col md:flex-row gap-4\">\n              <Select value={selectedKeyword} onValueChange={setSelectedKeyword}>\n                <SelectTrigger className=\"w-full md:w-64\">\n                  <SelectValue placeholder=\"选择关键字\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {availableKeywords.map(keyword => (\n                    <SelectItem key={keyword} value={keyword}>\n                      {keyword}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              \n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"搜索视频内容...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10\"\n                />\n              </div>\n            </div>\n\n            {keywordData && (\n              <>\n                {/* 数据统计卡片 */}\n                <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                        视频总数\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"text-2xl font-bold\">{keywordData.statistics.总视频数}</div>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {keywordData.statistics.最早发布} - {keywordData.statistics.最新发布}\n                      </p>\n                    </CardContent>\n                  </Card>\n                  \n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                        总互动量\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"text-2xl font-bold\">\n                        {formatNumber(keywordData.statistics.总点赞数 + keywordData.statistics.总评论数)}\n                      </div>\n                      <div className=\"flex gap-4 text-xs text-muted-foreground\">\n                        <span>❤️ {formatNumber(keywordData.statistics.总点赞数)}</span>\n                        <span>💬 {formatNumber(keywordData.statistics.总评论数)}</span>\n                      </div>\n                    </CardContent>\n                  </Card>\n                  \n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                        平均互动率\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"text-2xl font-bold\">\n                        {formatNumber(keywordData.statistics.平均点赞数)}\n                      </div>\n                      <p className=\"text-xs text-muted-foreground\">\n                        平均每个视频点赞数\n                      </p>\n                    </CardContent>\n                  </Card>\n                  \n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n                        主要创作者\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"text-sm font-medium truncate\">\n                        {keywordData.statistics.主要创作者[0] || '暂无'}\n                      </div>\n                      <p className=\"text-xs text-muted-foreground\">\n                        共 {keywordData.statistics.主要创作者.length} 位创作者\n                      </p>\n                    </CardContent>\n                  </Card>\n                </div>\n\n                {/* 标签云 */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-base\">热门标签</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {keywordData.statistics.主要标签.map(tag => (\n                        <Badge key={tag} variant=\"secondary\">\n                          <Hash className=\"h-3 w-3 mr-1\" />\n                          {tag}\n                        </Badge>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n\n                {/* 主要内容区域 */}\n                <Tabs value={activeTab} onValueChange={setActiveTab}>\n                  <TabsList className=\"grid w-full grid-cols-3\">\n                    <TabsTrigger value=\"videos\">视频列表</TabsTrigger>\n                    <TabsTrigger value=\"comments\">评论分析</TabsTrigger>\n                    <TabsTrigger value=\"insights\">热点洞察</TabsTrigger>\n                  </TabsList>\n                  \n                  <TabsContent value=\"videos\" className=\"space-y-4\">\n                    {filteredVideos.length === 0 ? (\n                      <Card>\n                        <CardContent className=\"text-center py-8\">\n                          <AlertCircle className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                          <p className=\"text-muted-foreground\">未找到相关视频</p>\n                        </CardContent>\n                      </Card>\n                    ) : (\n                      filteredVideos.map((video) => (\n                        <Card key={video.id} className=\"overflow-hidden\">\n                          <CardHeader>\n                            <div className=\"flex items-start justify-between\">\n                              <div className=\"flex-1\">\n                                <div className=\"flex items-center gap-2 mb-2\">\n                                  <Badge variant=\"outline\">\n                                    <User className=\"h-3 w-3 mr-1\" />\n                                    {video.nickname}\n                                  </Badge>\n                                  <Badge variant=\"outline\">\n                                    <Clock className=\"h-3 w-3 mr-1\" />\n                                    {video.视频时长}\n                                  </Badge>\n                                  <Badge variant=\"outline\">\n                                    <Calendar className=\"h-3 w-3 mr-1\" />\n                                    {video.create_time.split(' ')[0]}\n                                  </Badge>\n                                </div>\n                                <p className=\"text-sm line-clamp-2\">{video.desc}</p>\n                              </div>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                asChild\n                              >\n                                <a href={video.share_url} target=\"_blank\" rel=\"noopener noreferrer\">\n                                  <ExternalLink className=\"h-4 w-4\" />\n                                </a>\n                              </Button>\n                            </div>\n                          </CardHeader>\n                          <CardContent>\n                            {/* 标签 */}\n                            <div className=\"flex flex-wrap gap-1 mb-4\">\n                              {video.text_extra.slice(0, 5).map((tag, idx) => (\n                                <Badge key={idx} variant=\"secondary\" className=\"text-xs\">\n                                  {tag}\n                                </Badge>\n                              ))}\n                            </div>\n                            \n                            {/* 数据统计 */}\n                            <div className=\"grid grid-cols-4 gap-2 mb-4\">\n                              <div className=\"text-center\">\n                                <div className=\"text-lg font-semibold\">{formatNumber(video.digg_count)}</div>\n                                <div className=\"text-xs text-muted-foreground\">点赞</div>\n                              </div>\n                              <div className=\"text-center\">\n                                <div className=\"text-lg font-semibold\">{formatNumber(video.comment_count)}</div>\n                                <div className=\"text-xs text-muted-foreground\">评论</div>\n                              </div>\n                              <div className=\"text-center\">\n                                <div className=\"text-lg font-semibold\">{formatNumber(video.collect_count)}</div>\n                                <div className=\"text-xs text-muted-foreground\">收藏</div>\n                              </div>\n                              <div className=\"text-center\">\n                                <div className=\"text-lg font-semibold\">{formatNumber(video.share_count)}</div>\n                                <div className=\"text-xs text-muted-foreground\">分享</div>\n                              </div>\n                            </div>\n                            \n                            {/* 评论展示 */}\n                            {video.comment_count_actual > 0 && (\n                              <div>\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  className=\"w-full\"\n                                  onClick={() => toggleComments(video.id)}\n                                >\n                                  <MessageSquare className=\"h-4 w-4 mr-2\" />\n                                  {expandedComments.includes(video.id) ? '收起' : '查看'} {video.comment_count_actual} 条评论\n                                  {expandedComments.includes(video.id) ? (\n                                    <ChevronUp className=\"h-4 w-4 ml-2\" />\n                                  ) : (\n                                    <ChevronDown className=\"h-4 w-4 ml-2\" />\n                                  )}\n                                </Button>\n                                \n                                {expandedComments.includes(video.id) && (\n                                  <ScrollArea className=\"h-64 mt-4 rounded-md border p-4\">\n                                    <div className=\"space-y-3\">\n                                      {video.评论详细信息.map((comment) => (\n                                        <div key={comment.评论ID} className=\"border-b pb-3 last:border-0\">\n                                          <div className=\"flex items-center gap-2 mb-1 text-xs text-muted-foreground\">\n                                            <span>{comment.IP归属地}</span>\n                                            <span>·</span>\n                                            <span>{comment.评论时间}</span>\n                                            {comment.点赞数量 > 0 && (\n                                              <>\n                                                <span>·</span>\n                                                <span className=\"flex items-center gap-1\">\n                                                  <Heart className=\"h-3 w-3\" />\n                                                  {comment.点赞数量}\n                                                </span>\n                                              </>\n                                            )}\n                                          </div>\n                                          <p className=\"text-sm\">{comment.评论内容}</p>\n                                        </div>\n                                      ))}\n                                    </div>\n                                  </ScrollArea>\n                                )}\n                              </div>\n                            )}\n                          </CardContent>\n                        </Card>\n                      ))\n                    )}\n                  </TabsContent>\n                  \n                  <TabsContent value=\"comments\" className=\"space-y-4\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-base\">用户常见问题</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-3\">\n                          {questions.length === 0 ? (\n                            <p className=\"text-sm text-muted-foreground\">暂无用户问题</p>\n                          ) : (\n                            questions.map((comment, idx) => (\n                              <div key={idx} className=\"border-l-2 border-primary pl-3\">\n                                <p className=\"text-sm\">{comment.评论内容}</p>\n                                <div className=\"flex items-center gap-3 mt-1 text-xs text-muted-foreground\">\n                                  <span>{comment.IP归属地}</span>\n                                  {comment.点赞数量 > 0 && (\n                                    <span className=\"flex items-center gap-1\">\n                                      <Heart className=\"h-3 w-3\" />\n                                      {comment.点赞数量}\n                                    </span>\n                                  )}\n                                </div>\n                              </div>\n                            ))\n                          )}\n                        </div>\n                      </CardContent>\n                    </Card>\n                    \n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-base\">全部评论</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <ScrollArea className=\"h-96\">\n                          <div className=\"space-y-3\">\n                            {keywordData.videos.flatMap(v => v.评论详细信息).map((comment) => (\n                              <div key={comment.评论ID} className=\"border-b pb-3 last:border-0\">\n                                <p className=\"text-sm mb-1\">{comment.评论内容}</p>\n                                <div className=\"flex items-center gap-3 text-xs text-muted-foreground\">\n                                  <span>{comment.IP归属地}</span>\n                                  <span>{comment.评论时间}</span>\n                                  {comment.点赞数量 > 0 && (\n                                    <span className=\"flex items-center gap-1\">\n                                      <Heart className=\"h-3 w-3\" />\n                                      {comment.点赞数量}\n                                    </span>\n                                  )}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </ScrollArea>\n                      </CardContent>\n                    </Card>\n                  </TabsContent>\n                  \n                  <TabsContent value=\"insights\" className=\"space-y-4\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-base\">高频词汇分析</CardTitle>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-2\">\n                          {topics.map((topic, idx) => (\n                            <div key={idx} className=\"flex items-center justify-between\">\n                              <span className=\"text-sm font-medium\">{topic.word}</span>\n                              <div className=\"flex items-center gap-2\">\n                                <div className=\"w-32 bg-secondary rounded-full h-2\">\n                                  <div \n                                    className=\"bg-primary h-2 rounded-full\"\n                                    style={{ width: `${(topic.count / topics[0]?.count) * 100}%` }}\n                                  />\n                                </div>\n                                <span className=\"text-xs text-muted-foreground w-8 text-right\">\n                                  {topic.count}\n                                </span>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                    \n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-base\">内容洞察总结</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-3\">\n                        <div>\n                          <h4 className=\"text-sm font-medium mb-1\">发布时间分布</h4>\n                          <p className=\"text-sm text-muted-foreground\">\n                            最早发布: {keywordData.statistics.最早发布}<br />\n                            最新发布: {keywordData.statistics.最新发布}\n                          </p>\n                        </div>\n                        \n                        <div>\n                          <h4 className=\"text-sm font-medium mb-1\">创作者分布</h4>\n                          <div className=\"flex flex-wrap gap-2 mt-1\">\n                            {keywordData.statistics.主要创作者.map(creator => (\n                              <Badge key={creator} variant=\"outline\">\n                                {creator}\n                              </Badge>\n                            ))}\n                          </div>\n                        </div>\n                        \n                        <div>\n                          <h4 className=\"text-sm font-medium mb-1\">互动表现</h4>\n                          <div className=\"grid grid-cols-2 gap-2 text-sm text-muted-foreground\">\n                            <div>平均点赞: {formatNumber(keywordData.statistics.平均点赞数)}</div>\n                            <div>平均评论: {formatNumber(keywordData.statistics.平均评论数)}</div>\n                            <div>平均收藏: {formatNumber(keywordData.statistics.平均收藏数)}</div>\n                            <div>平均分享: {formatNumber(keywordData.statistics.平均分享数)}</div>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </TabsContent>\n                </Tabs>\n              </>\n            )}\n          </div>\n        </main>\n      </div>\n    </PageTransition>\n  )\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\merchants\\[id]\\analytics\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'Users' is defined but never used. Allowed unused vars must match /^_/u.","line":22,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":8,"suggestions":[{"messageId":"removeVar","data":{"varName":"Users"},"fix":{"range":[678,688],"text":""},"desc":"Remove unused variable 'Users'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Calendar' is defined but never used. Allowed unused vars must match /^_/u.","line":27,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":11,"suggestions":[{"messageId":"removeVar","data":{"varName":"Calendar"},"fix":{"range":[736,749],"text":""},"desc":"Remove unused variable 'Calendar'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Tag' is defined but never used. Allowed unused vars must match /^_/u.","line":28,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":6,"suggestions":[{"messageId":"removeVar","data":{"varName":"Tag"},"fix":{"range":[749,757],"text":""},"desc":"Remove unused variable 'Tag'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Clock' is defined but never used. Allowed unused vars must match /^_/u.","line":29,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":8,"suggestions":[{"messageId":"removeVar","data":{"varName":"Clock"},"fix":{"range":[757,767],"text":""},"desc":"Remove unused variable 'Clock'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":90,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":90,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchAnalytics'. Either include it or remove the dependency array.","line":100,"column":6,"nodeType":"ArrayExpression","endLine":100,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchAnalytics, params.id]","fix":{"range":[2369,2380],"text":"[fetchAnalytics, params.id]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 商家数据分析页面\r\n * /merchants/[id]/analytics\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { useParams, useRouter } from 'next/navigation'\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Skeleton } from '@/components/ui/skeleton'\r\nimport { Separator } from '@/components/ui/separator'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { \r\n  ArrowLeft,\r\n  BarChart3, \r\n  TrendingUp, \r\n  TrendingDown,\r\n  Users,\r\n  Heart,\r\n  MessageCircle,\r\n  Share2,\r\n  Star,\r\n  Calendar,\r\n  Tag,\r\n  Clock,\r\n  Eye\r\n} from 'lucide-react'\r\nimport type { MerchantWithDetails } from '@/types/merchant'\r\n\r\n// 分析数据类型\r\ninterface AnalyticsData {\r\n  merchant: MerchantWithDetails\r\n  engagementStats: {\r\n    totalEngagement: number\r\n    avgEngagementPerContent: number\r\n    engagementTrend: number // 增长率\r\n  }\r\n  contentStats: {\r\n    totalContent: number\r\n    videoCount: number\r\n    otherCount: number\r\n    withTranscript: number\r\n  }\r\n  timelineStats: {\r\n    date: string\r\n    diggCount: number\r\n    commentCount: number\r\n    collectCount: number\r\n    shareCount: number\r\n    contentCount: number\r\n  }[]\r\n  topContent: Array<{\r\n    id: string\r\n    title: string\r\n    diggCount: number\r\n    commentCount: number\r\n    collectCount: number\r\n    shareCount: number\r\n    engagementScore: number\r\n    publishedAt: string | null\r\n  }>\r\n  tagStats: Array<{\r\n    tag: string\r\n    count: number\r\n    engagementSum: number\r\n  }>\r\n}\r\n\r\nexport default function MerchantAnalyticsPage() {\r\n  const params = useParams()\r\n  const router = useRouter()\r\n  const [analytics, setAnalytics] = useState<AnalyticsData | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  // 获取分析数据\r\n  const fetchAnalytics = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const response = await fetch(`/api/merchants/${params.id}/analytics`)\r\n      const data = await response.json()\r\n      \r\n      if (response.ok) {\r\n        setAnalytics(data)\r\n      } else {\r\n        }\r\n    } catch (error) {\r\n      } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (params.id) {\r\n      fetchAnalytics()\r\n    }\r\n  }, [params.id])\r\n\r\n  // 格式化数字\r\n  const formatNumber = (num: number) => {\r\n    if (num >= 10000) {\r\n      return `${(num / 10000).toFixed(1)}万`\r\n    }\r\n    return num.toLocaleString()\r\n  }\r\n\r\n  // 计算互动评分\r\n  const getEngagementScore = (content: any) => {\r\n    return content.diggCount + content.commentCount * 2 + content.collectCount * 3 + content.shareCount * 4\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"container mx-auto p-6 space-y-6\">\r\n        <Skeleton className=\"h-8 w-64\" />\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n          {Array.from({ length: 4 }).map((_, i) => (\r\n            <Skeleton key={i} className=\"h-32\" />\r\n          ))}\r\n        </div>\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n          <Skeleton className=\"h-96\" />\r\n          <Skeleton className=\"h-96\" />\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (!analytics) {\r\n    return (\r\n      <div className=\"container mx-auto p-6 text-center\">\r\n        <h1 className=\"text-2xl font-bold text-muted-foreground\">数据分析加载失败</h1>\r\n        <Button className=\"mt-4\" onClick={() => router.back()}>\r\n          返回\r\n        </Button>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const { merchant, engagementStats, contentStats, topContent, tagStats } = analytics\r\n\r\n  return (\r\n    <div className=\"container mx-auto p-6 space-y-6\">\r\n      {/* 页面头部 */}\r\n      <div className=\"flex items-center gap-4\">\r\n        <Button variant=\"ghost\" size=\"sm\" onClick={() => router.back()}>\r\n          <ArrowLeft className=\"h-4 w-4\" />\r\n          返回\r\n        </Button>\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold\">{merchant.name} - 数据分析</h1>\r\n          <p className=\"text-muted-foreground mt-1\">\r\n            深度分析商家内容表现和用户互动数据\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* 核心指标卡片 */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">总互动量</CardTitle>\r\n            <Heart className=\"h-4 w-4 text-red-500\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatNumber(engagementStats.totalEngagement)}</div>\r\n            <div className=\"flex items-center text-xs text-muted-foreground\">\r\n              {engagementStats.engagementTrend >= 0 ? (\r\n                <TrendingUp className=\"h-3 w-3 text-green-500 mr-1\" />\r\n              ) : (\r\n                <TrendingDown className=\"h-3 w-3 text-red-500 mr-1\" />\r\n              )}\r\n              <span className={engagementStats.engagementTrend >= 0 ? \"text-green-500\" : \"text-red-500\"}>\r\n                {engagementStats.engagementTrend >= 0 ? '+' : ''}{engagementStats.engagementTrend.toFixed(1)}%\r\n              </span>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">平均互动率</CardTitle>\r\n            <BarChart3 className=\"h-4 w-4 text-blue-500\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatNumber(engagementStats.avgEngagementPerContent)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">每条内容平均互动</p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">内容总量</CardTitle>\r\n            <Eye className=\"h-4 w-4 text-purple-500\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{contentStats.totalContent}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              视频 {contentStats.videoCount} · 其他 {contentStats.otherCount}\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">转录覆盖率</CardTitle>\r\n            <MessageCircle className=\"h-4 w-4 text-green-500\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">\r\n              {contentStats.totalContent > 0 \r\n                ? Math.round((contentStats.withTranscript / contentStats.totalContent) * 100)\r\n                : 0\r\n              }%\r\n            </div>\r\n            <Progress \r\n              value={contentStats.totalContent > 0 \r\n                ? (contentStats.withTranscript / contentStats.totalContent) * 100 \r\n                : 0\r\n              } \r\n              className=\"mt-2\" \r\n            />\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      <Tabs defaultValue=\"engagement\" className=\"w-full\">\r\n        <TabsList className=\"grid w-full grid-cols-3\">\r\n          <TabsTrigger value=\"engagement\">互动分析</TabsTrigger>\r\n          <TabsTrigger value=\"content\">内容分析</TabsTrigger>\r\n          <TabsTrigger value=\"tags\">标签分析</TabsTrigger>\r\n        </TabsList>\r\n\r\n        <TabsContent value=\"engagement\" className=\"space-y-6\">\r\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n            {/* 互动分布 */}\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>互动类型分布</CardTitle>\r\n                <CardDescription>不同互动行为的统计分析</CardDescription>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-4\">\r\n                <div className=\"space-y-3\">\r\n                  <div className=\"flex justify-between items-center\">\r\n                    <span className=\"text-sm flex items-center gap-2\">\r\n                      <Heart className=\"h-3 w-3 text-red-500\" />\r\n                      点赞\r\n                    </span>\r\n                    <span className=\"font-medium\">{formatNumber(merchant.totalDiggCount)}</span>\r\n                  </div>\r\n                  <Progress value={(merchant.totalDiggCount / engagementStats.totalEngagement) * 100} />\r\n                  \r\n                  <div className=\"flex justify-between items-center\">\r\n                    <span className=\"text-sm flex items-center gap-2\">\r\n                      <MessageCircle className=\"h-3 w-3 text-blue-500\" />\r\n                      评论\r\n                    </span>\r\n                    <span className=\"font-medium\">{formatNumber(merchant.totalCommentCount)}</span>\r\n                  </div>\r\n                  <Progress value={(merchant.totalCommentCount / engagementStats.totalEngagement) * 100} />\r\n                  \r\n                  <div className=\"flex justify-between items-center\">\r\n                    <span className=\"text-sm flex items-center gap-2\">\r\n                      <Star className=\"h-3 w-3 text-yellow-500\" />\r\n                      收藏\r\n                    </span>\r\n                    <span className=\"font-medium\">{formatNumber(merchant.totalCollectCount)}</span>\r\n                  </div>\r\n                  <Progress value={(merchant.totalCollectCount / engagementStats.totalEngagement) * 100} />\r\n                  \r\n                  <div className=\"flex justify-between items-center\">\r\n                    <span className=\"text-sm flex items-center gap-2\">\r\n                      <Share2 className=\"h-3 w-3 text-green-500\" />\r\n                      分享\r\n                    </span>\r\n                    <span className=\"font-medium\">{formatNumber(merchant.totalShareCount)}</span>\r\n                  </div>\r\n                  <Progress value={(merchant.totalShareCount / engagementStats.totalEngagement) * 100} />\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* 热门内容 */}\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>热门内容 TOP 5</CardTitle>\r\n                <CardDescription>按互动评分排名的高表现内容</CardDescription>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"space-y-4\">\r\n                  {topContent.slice(0, 5).map((content, index) => (\r\n                    <div key={content.id} className=\"space-y-2\">\r\n                      <div className=\"flex items-start gap-3\">\r\n                        <Badge variant=\"outline\" className=\"text-xs shrink-0\">#{index + 1}</Badge>\r\n                        <div className=\"min-w-0 flex-1\">\r\n                          <h4 className=\"font-medium text-sm line-clamp-2 mb-1\">\r\n                            {content.title || '无标题'}\r\n                          </h4>\r\n                          <div className=\"flex items-center gap-3 text-xs text-muted-foreground\">\r\n                            <span className=\"flex items-center gap-1\">\r\n                              <Heart className=\"h-3 w-3\" />\r\n                              {formatNumber(content.diggCount)}\r\n                            </span>\r\n                            <span className=\"flex items-center gap-1\">\r\n                              <MessageCircle className=\"h-3 w-3\" />\r\n                              {formatNumber(content.commentCount)}\r\n                            </span>\r\n                            <span className=\"flex items-center gap-1\">\r\n                              <Star className=\"h-3 w-3\" />\r\n                              {formatNumber(content.collectCount)}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"text-xs text-muted-foreground mt-1\">\r\n                            互动评分: {formatNumber(getEngagementScore(content))}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                      {index < 4 && <Separator />}\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"content\" className=\"space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>内容表现概览</CardTitle>\r\n              <CardDescription>内容数量和类型分析</CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\r\n                <div className=\"text-center space-y-2\">\r\n                  <div className=\"text-3xl font-bold text-blue-600\">{contentStats.videoCount}</div>\r\n                  <p className=\"text-sm text-muted-foreground\">视频内容</p>\r\n                </div>\r\n                <div className=\"text-center space-y-2\">\r\n                  <div className=\"text-3xl font-bold text-purple-600\">{contentStats.otherCount}</div>\r\n                  <p className=\"text-sm text-muted-foreground\">其他内容</p>\r\n                </div>\r\n                <div className=\"text-center space-y-2\">\r\n                  <div className=\"text-3xl font-bold text-green-600\">{contentStats.withTranscript}</div>\r\n                  <p className=\"text-sm text-muted-foreground\">带转录内容</p>\r\n                </div>\r\n              </div>\r\n              \r\n              <Separator />\r\n              \r\n              <div className=\"space-y-3\">\r\n                <h4 className=\"font-medium\">内容质量指标</h4>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <div className=\"flex justify-between text-sm mb-1\">\r\n                      <span>转录覆盖率</span>\r\n                      <span>{Math.round((contentStats.withTranscript / contentStats.totalContent) * 100)}%</span>\r\n                    </div>\r\n                    <Progress value={(contentStats.withTranscript / contentStats.totalContent) * 100} />\r\n                  </div>\r\n                  <div>\r\n                    <div className=\"flex justify-between text-sm mb-1\">\r\n                      <span>视频内容占比</span>\r\n                      <span>{Math.round((contentStats.videoCount / contentStats.totalContent) * 100)}%</span>\r\n                    </div>\r\n                    <Progress value={(contentStats.videoCount / contentStats.totalContent) * 100} />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"tags\" className=\"space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>热门标签</CardTitle>\r\n              <CardDescription>标签使用频率和互动表现分析</CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                {tagStats.slice(0, 10).map((tag, index) => (\r\n                  <div key={tag.tag} className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <Badge variant=\"secondary\" className=\"text-xs\">#{index + 1}</Badge>\r\n                      <div>\r\n                        <div className=\"font-medium\">#{tag.tag}</div>\r\n                        <div className=\"text-xs text-muted-foreground\">\r\n                          {tag.count} 次使用 · {formatNumber(tag.engagementSum)} 互动\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"text-right\">\r\n                      <div className=\"text-sm font-medium\">{formatNumber(Math.round(tag.engagementSum / tag.count))}</div>\r\n                      <div className=\"text-xs text-muted-foreground\">平均互动</div>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n      </Tabs>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\merchants\\[id]\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CardDescription' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":44,"suggestions":[{"messageId":"removeVar","data":{"varName":"CardDescription"},"fix":{"range":[166,183],"text":""},"desc":"Remove unused variable 'CardDescription'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Tabs' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"Tabs"},"fix":{"range":[498,503],"text":""},"desc":"Remove unused variable 'Tabs'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'TabsContent' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"TabsContent"},"fix":{"range":[502,515],"text":""},"desc":"Remove unused variable 'TabsContent'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'TabsList' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"TabsList"},"fix":{"range":[515,525],"text":""},"desc":"Remove unused variable 'TabsList'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'TabsTrigger' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":50,"suggestions":[{"messageId":"removeVar","data":{"varName":"TabsTrigger"},"fix":{"range":[525,538],"text":""},"desc":"Remove unused variable 'TabsTrigger'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'MapPin' is defined but never used. Allowed unused vars must match /^_/u.","line":32,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":9,"suggestions":[{"messageId":"removeVar","data":{"varName":"MapPin"},"fix":{"range":[864,876],"text":""},"desc":"Remove unused variable 'MapPin'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Filter' is defined but never used. Allowed unused vars must match /^_/u.","line":43,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":9,"suggestions":[{"messageId":"removeVar","data":{"varName":"Filter"},"fix":{"range":[991,1002],"text":""},"desc":"Remove unused variable 'Filter'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'ArrowUpDown' is defined but never used. Allowed unused vars must match /^_/u.","line":45,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"ArrowUpDown"},"fix":{"range":[1016,1032],"text":""},"desc":"Remove unused variable 'ArrowUpDown'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'contentTotal' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":75,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"contentTotal"},"fix":{"range":[2034,2046],"text":""},"desc":"Remove unused variable 'contentTotal'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":91,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":91,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":149,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":149,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMerchant'. Either include it or remove the dependency array.","line":159,"column":6,"nodeType":"ArrayExpression","endLine":159,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchMerchant, params.id]","fix":{"range":[4679,4690],"text":"[fetchMerchant, params.id]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchContents'. Either include it or remove the dependency array.","line":165,"column":6,"nodeType":"ArrayExpression","endLine":165,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [contentFilters, fetchContents, merchant]","fix":{"range":[4772,4798],"text":"[contentFilters, fetchContents, merchant]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":218,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":218,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 商家详情页面\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { useParams, useRouter } from 'next/navigation'\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Skeleton } from '@/components/ui/skeleton'\r\nimport { Separator } from '@/components/ui/separator'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { \r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from '@/components/ui/dropdown-menu'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\nimport { \r\n  ArrowLeft,\r\n  Building2, \r\n  MapPin, \r\n  Calendar,\r\n  Eye,\r\n  Heart,\r\n  MessageCircle,\r\n  Share2,\r\n  Star,\r\n  ExternalLink,\r\n  Play,\r\n  Clock,\r\n  Hash,\r\n  Filter,\r\n  BarChart3,\r\n  ArrowUpDown,\r\n  ArrowUp,\r\n  ArrowDown\r\n} from 'lucide-react'\r\nimport type { \r\n  MerchantWithDetails, \r\n  MerchantContent\r\n} from '@/types/merchant'\r\nimport { \r\n  BUSINESS_TYPE_LABELS,\r\n  MERCHANT_STATUS_LABELS,\r\n  CONTENT_TYPE_LABELS \r\n} from '@/types/merchant'\r\nimport { TagAnalysisModal } from '@/components/merchants/tag-analysis-modal'\r\n\r\nexport default function MerchantDetailPage() {\r\n  const params = useParams()\r\n  const router = useRouter()\r\n  const [merchant, setMerchant] = useState<MerchantWithDetails | null>(null)\r\n  const [contents, setContents] = useState<MerchantContent[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [contentLoading, setContentLoading] = useState(false)\r\n  const [contentFilters, setContentFilters] = useState({\r\n    search: '',\r\n    contentType: '',\r\n    sortBy: 'publishedAt' as 'publishedAt' | 'diggCount' | 'commentCount' | 'collectCount' | 'shareCount' | 'engagement',\r\n    sortOrder: 'desc' as 'asc' | 'desc',\r\n    page: 1,\r\n    limit: 20\r\n  })\r\n  const [contentTotal, setContentTotal] = useState(0)\r\n  const [tagAnalysisOpen, setTagAnalysisOpen] = useState(false)\r\n  const [exportLoading, setExportLoading] = useState(false)\r\n\r\n  // 获取商家详情\r\n  const fetchMerchant = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const response = await fetch(`/api/merchants/${params.id}`)\r\n      const data = await response.json()\r\n      \r\n      if (response.ok) {\r\n        setMerchant(data.merchant)\r\n        setContents(data.merchant.contents || [])\r\n      } else {\r\n        }\r\n    } catch (error) {\r\n      } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  // 获取商家内容\r\n  const fetchContents = async () => {\r\n    try {\r\n      setContentLoading(true)\r\n      const params = new URLSearchParams()\r\n      \r\n      // 处理特殊的排序字段\r\n      let apiSortBy = contentFilters.sortBy\r\n      if (contentFilters.sortBy === 'engagement' || contentFilters.sortBy === 'shareCount') {\r\n        // 对于互动评分和分享数，我们需要在前端排序\r\n        apiSortBy = 'publishedAt' // 先从API获取所有数据\r\n      }\r\n      \r\n      Object.entries(contentFilters).forEach(([key, value]) => {\r\n        if (value && value !== '' && key !== 'sortBy') {\r\n          if (key === 'sortBy' && (contentFilters.sortBy === 'engagement' || contentFilters.sortBy === 'shareCount')) {\r\n            // 不传递特殊排序到API\r\n            return\r\n          }\r\n          params.append(key, String(value))\r\n        }\r\n      })\r\n      \r\n      // 添加排序参数\r\n      params.append('sortBy', apiSortBy)\r\n      params.append('sortOrder', contentFilters.sortOrder)\r\n\r\n      const response = await fetch(`/api/merchants/${merchant?.id}/contents?${params}`)\r\n      const data = await response.json()\r\n      \r\n      if (response.ok) {\r\n        let sortedContents = data.contents\r\n        \r\n        // 前端排序处理\r\n        if (contentFilters.sortBy === 'engagement') {\r\n          sortedContents = [...data.contents].sort((a, b) => {\r\n            const scoreA = getEngagementScore(a)\r\n            const scoreB = getEngagementScore(b)\r\n            return contentFilters.sortOrder === 'desc' ? scoreB - scoreA : scoreA - scoreB\r\n          })\r\n        } else if (contentFilters.sortBy === 'shareCount') {\r\n          sortedContents = [...data.contents].sort((a, b) => {\r\n            return contentFilters.sortOrder === 'desc' \r\n              ? b.shareCount - a.shareCount \r\n              : a.shareCount - b.shareCount\r\n          })\r\n        }\r\n        \r\n        setContents(sortedContents)\r\n        setContentTotal(data.total)\r\n      } else {\r\n        }\r\n    } catch (error) {\r\n      } finally {\r\n      setContentLoading(false)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (params.id) {\r\n      fetchMerchant()\r\n    }\r\n  }, [params.id])\r\n\r\n  useEffect(() => {\r\n    if (merchant) {\r\n      fetchContents()\r\n    }\r\n  }, [contentFilters, merchant])\r\n\r\n  // 格式化数字\r\n  const formatNumber = (num: number) => {\r\n    if (num >= 10000) {\r\n      return `${(num / 10000).toFixed(1)}万`\r\n    }\r\n    return num.toLocaleString()\r\n  }\r\n\r\n  // 格式化时长\r\n  const formatDuration = (duration: string | null) => {\r\n    if (!duration) return '未知'\r\n    return duration.replace(/^00:/, '')  // 移除开头的00:\r\n  }\r\n\r\n  // 计算互动评分\r\n  const getEngagementScore = (content: MerchantContent) => {\r\n    return content.diggCount + content.commentCount * 2 + content.collectCount * 3 + content.shareCount * 4\r\n  }\r\n\r\n  // 导出数据\r\n  const handleExport = async (type: 'content' | 'analytics' | 'tags') => {\r\n    if (!merchant) return\r\n    \r\n    try {\r\n      setExportLoading(true)\r\n      const response = await fetch(`/api/merchants/${merchant.id}/export?type=${type}&format=csv`)\r\n      \r\n      if (response.ok) {\r\n        const blob = await response.blob()\r\n        const url = window.URL.createObjectURL(blob)\r\n        const a = document.createElement('a')\r\n        a.href = url\r\n        \r\n        // 从响应头获取文件名\r\n        const contentDisposition = response.headers.get('content-disposition')\r\n        let filename = `${merchant.name}_${type}_${new Date().toISOString().split('T')[0]}.csv`\r\n        \r\n        if (contentDisposition) {\r\n          const matches = contentDisposition.match(/filename[^;=\\n]*=((['\"]).*?\\2|[^;\\n]*)/)\r\n          if (matches && matches[1]) {\r\n            filename = decodeURIComponent(matches[1].replace(/['\"]/g, ''))\r\n          }\r\n        }\r\n        \r\n        a.download = filename\r\n        document.body.appendChild(a)\r\n        a.click()\r\n        window.URL.revokeObjectURL(url)\r\n        document.body.removeChild(a)\r\n      } else {\r\n        }\r\n    } catch (error) {\r\n      } finally {\r\n      setExportLoading(false)\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"container mx-auto p-6 space-y-6\">\r\n        <Skeleton className=\"h-8 w-64\" />\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n          <div className=\"lg:col-span-2 space-y-6\">\r\n            <Skeleton className=\"h-48\" />\r\n            <Skeleton className=\"h-64\" />\r\n          </div>\r\n          <div className=\"space-y-6\">\r\n            <Skeleton className=\"h-32\" />\r\n            <Skeleton className=\"h-48\" />\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (!merchant) {\r\n    return (\r\n      <div className=\"container mx-auto p-6 text-center\">\r\n        <h1 className=\"text-2xl font-bold text-muted-foreground\">商家不存在</h1>\r\n        <Button className=\"mt-4\" onClick={() => router.back()}>\r\n          返回\r\n        </Button>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"container mx-auto p-6 space-y-6\">\r\n      {/* 页面头部 */}\r\n      <div className=\"flex items-center gap-4\">\r\n        <Button variant=\"ghost\" size=\"sm\" onClick={() => router.back()}>\r\n          <ArrowLeft className=\"h-4 w-4\" />\r\n          返回\r\n        </Button>\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold\">{merchant.name}</h1>\r\n          <p className=\"text-muted-foreground mt-1\">\r\n            商家详情和内容分析\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n        {/* 主要内容区域 */}\r\n        <div className=\"lg:col-span-2 space-y-6\">\r\n          {/* 基本信息 */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"flex items-center gap-2\">\r\n                <Building2 className=\"h-5 w-5\" />\r\n                基本信息\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-muted-foreground\">商家名称</label>\r\n                  <div className=\"font-medium\">{merchant.name}</div>\r\n                </div>\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-muted-foreground\">业务类型</label>\r\n                  <div className=\"font-medium\">{BUSINESS_TYPE_LABELS[merchant.businessType]}</div>\r\n                </div>\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-muted-foreground\">所在地区</label>\r\n                  <div className=\"font-medium\">{merchant.location || '未指定'}</div>\r\n                </div>\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-muted-foreground\">状态</label>\r\n                  <Badge \r\n                    variant={merchant.status === 'ACTIVE' ? 'default' : 'secondary'}\r\n                    className=\"ml-1\"\r\n                  >\r\n                    {MERCHANT_STATUS_LABELS[merchant.status]}\r\n                  </Badge>\r\n                </div>\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-muted-foreground\">数据来源</label>\r\n                  <div className=\"font-medium\">{merchant.dataSource}</div>\r\n                </div>\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-muted-foreground\">创建时间</label>\r\n                  <div className=\"font-medium\">{new Date(merchant.createdAt).toLocaleString()}</div>\r\n                </div>\r\n              </div>\r\n              \r\n              {merchant.description && (\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-muted-foreground\">描述</label>\r\n                  <div className=\"mt-1\">{merchant.description}</div>\r\n                </div>\r\n              )}\r\n              \r\n              {merchant.category && (\r\n                <div>\r\n                  <label className=\"text-sm font-medium text-muted-foreground\">分类</label>\r\n                  <Badge \r\n                    variant=\"outline\"\r\n                    className=\"ml-1\"\r\n                    style={{ \r\n                      borderColor: merchant.category.color || '#6366f1',\r\n                      color: merchant.category.color || '#6366f1'\r\n                    }}\r\n                  >\r\n                    {merchant.category.name}\r\n                  </Badge>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* 内容列表 */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"flex items-center justify-between\">\r\n                <span className=\"flex items-center gap-2\">\r\n                  <Play className=\"h-5 w-5\" />\r\n                  内容列表\r\n                </span>\r\n                <Badge variant=\"outline\">{merchant.totalContentCount} 条内容</Badge>\r\n              </CardTitle>\r\n              <div className=\"flex gap-2 items-center\">\r\n                <Input\r\n                  placeholder=\"搜索内容...\"\r\n                  value={contentFilters.search}\r\n                  onChange={(e) => setContentFilters({ ...contentFilters, search: e.target.value, page: 1 })}\r\n                  className=\"flex-1 max-w-sm\"\r\n                />\r\n                \r\n                <Select\r\n                  value={contentFilters.sortBy}\r\n                  onValueChange={(value: any) => setContentFilters({ ...contentFilters, sortBy: value, page: 1 })}\r\n                >\r\n                  <SelectTrigger className=\"w-[180px]\">\r\n                    <SelectValue placeholder=\"选择排序方式\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"publishedAt\">发布时间</SelectItem>\r\n                    <SelectItem value=\"diggCount\">点赞数</SelectItem>\r\n                    <SelectItem value=\"commentCount\">评论数</SelectItem>\r\n                    <SelectItem value=\"collectCount\">收藏数</SelectItem>\r\n                    <SelectItem value=\"shareCount\">分享数</SelectItem>\r\n                    <SelectItem value=\"engagement\">互动评分</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n                \r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"icon\"\r\n                  onClick={() => setContentFilters({ \r\n                    ...contentFilters, \r\n                    sortOrder: contentFilters.sortOrder === 'desc' ? 'asc' : 'desc',\r\n                    page: 1 \r\n                  })}\r\n                  title={contentFilters.sortOrder === 'desc' ? '降序' : '升序'}\r\n                >\r\n                  {contentFilters.sortOrder === 'desc' ? (\r\n                    <ArrowDown className=\"h-4 w-4\" />\r\n                  ) : (\r\n                    <ArrowUp className=\"h-4 w-4\" />\r\n                  )}\r\n                </Button>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent>\r\n              {contentLoading ? (\r\n                <div className=\"space-y-4\">\r\n                  {Array.from({ length: 5 }).map((_, i) => (\r\n                    <div key={i} className=\"space-y-2\">\r\n                      <Skeleton className=\"h-4 w-3/4\" />\r\n                      <Skeleton className=\"h-3 w-1/2\" />\r\n                      <Separator />\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-4\">\r\n                  {contents.map((content) => (\r\n                    <div key={content.id} className=\"space-y-3\">\r\n                      <div className=\"flex items-start justify-between\">\r\n                        <div className=\"flex-1\">\r\n                          <h4 className=\"font-medium line-clamp-2 mb-1\">\r\n                            {content.title || '无标题'}\r\n                          </h4>\r\n                          <div className=\"flex flex-wrap items-center gap-4 text-sm text-muted-foreground\">\r\n                            <span className=\"flex items-center gap-1\">\r\n                              <Calendar className=\"h-3 w-3\" />\r\n                              {content.publishedAt ? new Date(content.publishedAt).toLocaleDateString() : '未知'}\r\n                            </span>\r\n                            <span className=\"flex items-center gap-1\">\r\n                              <Eye className=\"h-3 w-3\" />\r\n                              {CONTENT_TYPE_LABELS[content.contentType]}\r\n                            </span>\r\n                            {content.duration && (\r\n                              <span className=\"flex items-center gap-1\">\r\n                                <Clock className=\"h-3 w-3\" />\r\n                                {formatDuration(content.duration)}\r\n                              </span>\r\n                            )}\r\n                            {content.hasTranscript && (\r\n                              <Badge variant=\"outline\" className=\"text-xs\">\r\n                                有转录\r\n                              </Badge>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                        {content.shareUrl && (\r\n                          <Button variant=\"ghost\" size=\"sm\" asChild>\r\n                            <a href={content.shareUrl} target=\"_blank\" rel=\"noopener noreferrer\">\r\n                              <ExternalLink className=\"h-4 w-4\" />\r\n                            </a>\r\n                          </Button>\r\n                        )}\r\n                      </div>\r\n                      \r\n                      <div className=\"grid grid-cols-5 gap-4 text-sm\">\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Heart className=\"h-3 w-3 text-red-500\" />\r\n                          <span>{formatNumber(content.diggCount)}</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <MessageCircle className=\"h-3 w-3 text-blue-500\" />\r\n                          <span>{formatNumber(content.commentCount)}</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Star className=\"h-3 w-3 text-yellow-500\" />\r\n                          <span>{formatNumber(content.collectCount)}</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1\">\r\n                          <Share2 className=\"h-3 w-3 text-green-500\" />\r\n                          <span>{formatNumber(content.shareCount)}</span>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-1\" title=\"互动评分\">\r\n                          <BarChart3 className=\"h-3 w-3 text-purple-500\" />\r\n                          <span className=\"font-medium\">{formatNumber(getEngagementScore(content))}</span>\r\n                        </div>\r\n                      </div>\r\n                      \r\n                      {/* 标签 */}\r\n                      {content.parsedTags && content.parsedTags.length > 0 && (\r\n                        <div className=\"flex flex-wrap gap-1\">\r\n                          {content.parsedTags.map((tag: string, index: number) => (\r\n                            <Badge key={index} variant=\"secondary\" className=\"text-xs\">\r\n                              #{tag}\r\n                            </Badge>\r\n                          ))}\r\n                        </div>\r\n                      )}\r\n                      \r\n                      {/* 转录文本预览 */}\r\n                      {content.transcript && (\r\n                        <details className=\"group\">\r\n                          <summary className=\"cursor-pointer text-sm text-muted-foreground hover:text-foreground\">\r\n                            查看转录文本\r\n                          </summary>\r\n                          <div className=\"mt-2 p-3 bg-muted/50 rounded-md text-sm max-h-32 overflow-y-auto\">\r\n                            {content.transcript.substring(0, 200)}\r\n                            {content.transcript.length > 200 && '...'}\r\n                          </div>\r\n                        </details>\r\n                      )}\r\n                      \r\n                      <Separator />\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* 侧边栏 */}\r\n        <div className=\"space-y-6\">\r\n          {/* 统计数据 */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>数据统计</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div className=\"space-y-2\">\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-sm text-muted-foreground\">总内容数</span>\r\n                  <span className=\"font-medium\">{merchant.totalContentCount}</span>\r\n                </div>\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-sm text-muted-foreground\">总点赞数</span>\r\n                  <span className=\"font-medium text-red-600\">{formatNumber(merchant.totalDiggCount)}</span>\r\n                </div>\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-sm text-muted-foreground\">总评论数</span>\r\n                  <span className=\"font-medium text-blue-600\">{formatNumber(merchant.totalCommentCount)}</span>\r\n                </div>\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-sm text-muted-foreground\">总收藏数</span>\r\n                  <span className=\"font-medium text-yellow-600\">{formatNumber(merchant.totalCollectCount)}</span>\r\n                </div>\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-sm text-muted-foreground\">总分享数</span>\r\n                  <span className=\"font-medium text-green-600\">{formatNumber(merchant.totalShareCount)}</span>\r\n                </div>\r\n              </div>\r\n              <Separator />\r\n              <div className=\"space-y-2\">\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-sm text-muted-foreground\">平均互动率</span>\r\n                  <span className=\"font-medium\">\r\n                    {merchant.totalContentCount > 0 \r\n                      ? Math.round(\r\n                          (merchant.totalDiggCount + merchant.totalCommentCount + merchant.totalCollectCount + merchant.totalShareCount) \r\n                          / merchant.totalContentCount\r\n                        ).toLocaleString()\r\n                      : 0\r\n                    }\r\n                  </span>\r\n                </div>\r\n                <div className=\"flex justify-between\">\r\n                  <span className=\"text-sm text-muted-foreground\">最后采集</span>\r\n                  <span className=\"text-sm\">\r\n                    {merchant.lastCollectedAt \r\n                      ? new Date(merchant.lastCollectedAt).toLocaleDateString() \r\n                      : '未知'\r\n                    }\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* 快捷操作 */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>快捷操作</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-2\">\r\n              <Button variant=\"outline\" className=\"w-full\" asChild>\r\n                <a href={`/merchants/${merchant.id}/analytics`}>\r\n                  <BarChart3 className=\"h-4 w-4 mr-2\" />\r\n                  数据分析\r\n                </a>\r\n              </Button>\r\n              <Button variant=\"outline\" className=\"w-full\" onClick={() => setTagAnalysisOpen(true)}>\r\n                <Hash className=\"h-4 w-4 mr-2\" />\r\n                标签分析\r\n              </Button>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button variant=\"outline\" className=\"w-full\" disabled={exportLoading}>\r\n                    <ExternalLink className=\"h-4 w-4 mr-2\" />\r\n                    {exportLoading ? '导出中...' : '导出数据'}\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\">\r\n                  <DropdownMenuItem onClick={() => handleExport('content')}>\r\n                    导出内容数据\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleExport('analytics')}>\r\n                    导出分析数据\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem onClick={() => handleExport('tags')}>\r\n                    导出标签数据\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n\r\n      {/* 标签分析模态框 */}\r\n      <TagAnalysisModal\r\n        open={tagAnalysisOpen}\r\n        onOpenChange={setTagAnalysisOpen}\r\n        merchantId={merchant.id}\r\n        merchantName={merchant.name}\r\n      />\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\merchants\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'Tabs' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"Tabs"},"fix":{"range":[539,544],"text":""},"desc":"Remove unused variable 'Tabs'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'TabsContent' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"TabsContent"},"fix":{"range":[543,556],"text":""},"desc":"Remove unused variable 'TabsContent'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'TabsList' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"TabsList"},"fix":{"range":[556,566],"text":""},"desc":"Remove unused variable 'TabsList'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'TabsTrigger' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":50,"suggestions":[{"messageId":"removeVar","data":{"varName":"TabsTrigger"},"fix":{"range":[566,579],"text":""},"desc":"Remove unused variable 'TabsTrigger'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Search' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":9,"suggestions":[{"messageId":"removeVar","data":{"varName":"Search"},"fix":{"range":[624,631],"text":""},"desc":"Remove unused variable 'Search'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'BarChart3' is defined but never used. Allowed unused vars must match /^_/u.","line":19,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":12,"suggestions":[{"messageId":"removeVar","data":{"varName":"BarChart3"},"fix":{"range":[642,657],"text":""},"desc":"Remove unused variable 'BarChart3'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Star' is defined but never used. Allowed unused vars must match /^_/u.","line":27,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":7,"suggestions":[{"messageId":"removeVar","data":{"varName":"Star"},"fix":{"range":[745,754],"text":""},"desc":"Remove unused variable 'Star'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":76,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":99,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":99,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMerchants'. Either include it or remove the dependency array.","line":109,"column":6,"nodeType":"ArrayExpression","endLine":109,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [fetchMerchants, filters]","fix":{"range":[2787,2796],"text":"[fetchMerchants, filters]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 商家数据展示页面\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { Header } from '@/components/header'\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Skeleton } from '@/components/ui/skeleton'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { \r\n  Search, \r\n  Filter, \r\n  BarChart3, \r\n  Building2, \r\n  MapPin, \r\n  Calendar,\r\n  Eye,\r\n  Heart,\r\n  MessageCircle,\r\n  Share2,\r\n  Star\r\n} from 'lucide-react'\r\nimport type { \r\n  MerchantListItem, \r\n  MerchantCategory, \r\n  MerchantStats,\r\n  MerchantFilters\r\n} from '@/types/merchant'\r\nimport {\r\n  BUSINESS_TYPE_LABELS,\r\n  MERCHANT_STATUS_LABELS \r\n} from '@/types/merchant'\r\n\r\nexport default function MerchantsPage() {\r\n  const [merchants, setMerchants] = useState<MerchantListItem[]>([])\r\n  const [categories, setCategories] = useState<MerchantCategory[]>([])\r\n  const [stats, setStats] = useState<MerchantStats | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n  const [filters, setFilters] = useState<MerchantFilters>({\r\n    search: '',\r\n    categoryId: '',\r\n    location: '',\r\n    sortBy: 'createdAt',\r\n    sortOrder: 'desc',\r\n    page: 1,\r\n    limit: 20\r\n  })\r\n  const [total, setTotal] = useState(0)\r\n\r\n  // 获取商家列表\r\n  const fetchMerchants = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const params = new URLSearchParams()\r\n      \r\n      Object.entries(filters).forEach(([key, value]) => {\r\n        if (value && value !== '') {\r\n          params.append(key, String(value))\r\n        }\r\n      })\r\n\r\n      const response = await fetch(`/api/merchants?${params}`)\r\n      const data = await response.json()\r\n      \r\n      if (response.ok) {\r\n        setMerchants(data.merchants)\r\n        setTotal(data.total)\r\n      } else {\r\n        }\r\n    } catch (error) {\r\n      } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  // 获取分类和统计数据\r\n  const fetchData = async () => {\r\n    try {\r\n      const [categoriesRes, statsRes] = await Promise.all([\r\n        fetch('/api/merchants/categories'),\r\n        fetch('/api/merchants/stats')\r\n      ])\r\n      \r\n      if (categoriesRes.ok) {\r\n        const categoriesData = await categoriesRes.json()\r\n        setCategories(categoriesData)\r\n      }\r\n      \r\n      if (statsRes.ok) {\r\n        const statsData = await statsRes.json()\r\n        setStats(statsData.stats)\r\n      }\r\n    } catch (error) {\r\n      }\r\n  }\r\n\r\n  useEffect(() => {\r\n    fetchData()\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    fetchMerchants()\r\n  }, [filters])\r\n\r\n  // 处理搜索\r\n  const handleSearch = (value: string) => {\r\n    setFilters({ ...filters, search: value, page: 1 })\r\n  }\r\n\r\n  // 处理筛选\r\n  const handleFilter = (key: keyof MerchantFilters, value: string) => {\r\n    setFilters({ ...filters, [key]: value || undefined, page: 1 })\r\n  }\r\n\r\n  // 格式化数字\r\n  const formatNumber = (num: number) => {\r\n    if (num >= 10000) {\r\n      return `${(num / 10000).toFixed(1)}万`\r\n    }\r\n    return num.toLocaleString()\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-background\">\r\n      <Header />\r\n      <main className=\"container mx-auto p-6 space-y-6\">\r\n      {/* 页面标题 */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold\">商家数据中心</h1>\r\n          <p className=\"text-muted-foreground mt-1\">\r\n            支点有星辰合作数据\r\n          </p>\r\n        </div>\r\n        <Badge variant=\"outline\" className=\"px-3 py-1\">\r\n          共 {total} 家商家\r\n        </Badge>\r\n      </div>\r\n\r\n      {/* 统计概览 */}\r\n      {stats && (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">总商家数</CardTitle>\r\n              <Building2 className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{stats.totalMerchants}</div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                活跃: {stats.activeCount} | 停用: {stats.inactiveCount}\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n          \r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">总内容数</CardTitle>\r\n              <Eye className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{formatNumber(stats.totalContent)}</div>\r\n              <p className=\"text-xs text-muted-foreground\">视频、文章等内容</p>\r\n            </CardContent>\r\n          </Card>\r\n          \r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">总互动数</CardTitle>\r\n              <Heart className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{formatNumber(stats.totalEngagement)}</div>\r\n              <p className=\"text-xs text-muted-foreground\">点赞、评论、收藏、分享</p>\r\n            </CardContent>\r\n          </Card>\r\n          \r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">覆盖地区</CardTitle>\r\n              <MapPin className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{stats.locations.length}</div>\r\n              <p className=\"text-xs text-muted-foreground\">主要集中在广西地区</p>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      )}\r\n\r\n      {/* 搜索和筛选 */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Filter className=\"h-5 w-5\" />\r\n            搜索筛选\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-4\">\r\n          <div className=\"flex flex-col sm:flex-row gap-4\">\r\n            <div className=\"flex-1\">\r\n              <Input\r\n                placeholder=\"搜索商家名称、描述或地区...\"\r\n                value={filters.search}\r\n                onChange={(e) => handleSearch(e.target.value)}\r\n                className=\"w-full\"\r\n              />\r\n            </div>\r\n            <div className=\"flex gap-2\">\r\n              <Select\r\n                value={filters.categoryId || \"all\"}\r\n                onValueChange={(value) => handleFilter('categoryId', value === \"all\" ? \"\" : value)}\r\n              >\r\n                <SelectTrigger className=\"w-40\">\r\n                  <SelectValue placeholder=\"选择分类\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">全部分类</SelectItem>\r\n                  {categories.map((category) => (\r\n                    <SelectItem key={category.id} value={category.id}>\r\n                      {category.name}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n              \r\n              <Select\r\n                value={filters.sortBy}\r\n                onValueChange={(value) => handleFilter('sortBy', value)}\r\n              >\r\n                <SelectTrigger className=\"w-40\">\r\n                  <SelectValue />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"createdAt\">创建时间</SelectItem>\r\n                  <SelectItem value=\"name\">商家名称</SelectItem>\r\n                  <SelectItem value=\"totalContentCount\">内容数量</SelectItem>\r\n                  <SelectItem value=\"totalEngagement\">互动总数</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* 商家列表 */}\r\n      <div className=\"space-y-4\">\r\n        {loading ? (\r\n          // 加载骨架屏\r\n          <div className=\"grid gap-4\">\r\n            {Array.from({ length: 6 }).map((_, i) => (\r\n              <Card key={i}>\r\n                <CardHeader>\r\n                  <Skeleton className=\"h-6 w-3/4\" />\r\n                  <Skeleton className=\"h-4 w-1/2\" />\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"flex justify-between\">\r\n                    <div className=\"space-y-2\">\r\n                      <Skeleton className=\"h-4 w-24\" />\r\n                      <Skeleton className=\"h-4 w-32\" />\r\n                    </div>\r\n                    <Skeleton className=\"h-10 w-20\" />\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        ) : (\r\n          <div className=\"grid gap-4\">\r\n            {merchants.map((merchant) => (\r\n              <Card key={merchant.id} className=\"hover:shadow-md transition-shadow\">\r\n                <CardHeader>\r\n                  <div className=\"flex items-start justify-between\">\r\n                    <div className=\"space-y-1\">\r\n                      <CardTitle className=\"flex items-center gap-2\">\r\n                        {merchant.name}\r\n                        {merchant.category && (\r\n                          <Badge \r\n                            variant=\"outline\"\r\n                            style={{ \r\n                              borderColor: merchant.category.color || '#6366f1',\r\n                              color: merchant.category.color || '#6366f1'\r\n                            }}\r\n                          >\r\n                            {merchant.category.name}\r\n                          </Badge>\r\n                        )}\r\n                      </CardTitle>\r\n                      <CardDescription className=\"flex items-center gap-4\">\r\n                        {merchant.location && (\r\n                          <span className=\"flex items-center gap-1\">\r\n                            <MapPin className=\"h-3 w-3\" />\r\n                            {merchant.location}\r\n                          </span>\r\n                        )}\r\n                        <span className=\"flex items-center gap-1\">\r\n                          <Building2 className=\"h-3 w-3\" />\r\n                          {BUSINESS_TYPE_LABELS[merchant.businessType]}\r\n                        </span>\r\n                        <span className=\"flex items-center gap-1\">\r\n                          <Calendar className=\"h-3 w-3\" />\r\n                          {new Date(merchant.createdAt).toLocaleDateString()}\r\n                        </span>\r\n                      </CardDescription>\r\n                    </div>\r\n                    <Badge \r\n                      variant={merchant.status === 'ACTIVE' ? 'default' : 'secondary'}\r\n                    >\r\n                      {MERCHANT_STATUS_LABELS[merchant.status]}\r\n                    </Badge>\r\n                  </div>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\r\n                      <div className=\"flex items-center gap-1\">\r\n                        <Eye className=\"h-3 w-3 text-muted-foreground\" />\r\n                        <span>{merchant.totalContentCount} 内容</span>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-1\">\r\n                        <Heart className=\"h-3 w-3 text-red-500\" />\r\n                        <span>{formatNumber(merchant.totalDiggCount)}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-1\">\r\n                        <MessageCircle className=\"h-3 w-3 text-blue-500\" />\r\n                        <span>{formatNumber(merchant.totalCommentCount)}</span>\r\n                      </div>\r\n                      <div className=\"flex items-center gap-1\">\r\n                        <Share2 className=\"h-3 w-3 text-green-500\" />\r\n                        <span>{formatNumber(merchant.totalShareCount)}</span>\r\n                      </div>\r\n                    </div>\r\n                    <Button variant=\"outline\" size=\"sm\" asChild>\r\n                      <a href={`/merchants/${merchant.id}`}>\r\n                        查看详情\r\n                      </a>\r\n                    </Button>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* 分页 */}\r\n      {total > (filters.limit || 20) && (\r\n        <div className=\"flex justify-center gap-2\">\r\n          <Button\r\n            variant=\"outline\"\r\n            disabled={filters.page === 1}\r\n            onClick={() => setFilters({ ...filters, page: (filters.page || 1) - 1 })}\r\n          >\r\n            上一页\r\n          </Button>\r\n          <span className=\"flex items-center px-4\">\r\n            第 {filters.page} 页，共 {Math.ceil(total / (filters.limit || 20))} 页\r\n          </span>\r\n          <Button\r\n            variant=\"outline\"\r\n            disabled={(filters.page || 1) * (filters.limit || 20) >= total}\r\n            onClick={() => setFilters({ ...filters, page: (filters.page || 1) + 1 })}\r\n          >\r\n            下一页\r\n          </Button>\r\n        </div>\r\n      )}\r\n      </main>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'CardContent' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"CardContent"},"fix":{"range":[166,179],"text":""},"desc":"Remove unused variable 'CardContent'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Header } from \"@/components/header\"\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\nimport Link from \"next/link\"\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\"\nimport { Sparkles, Shield, Layers } from \"lucide-react\"\nimport { useSession } from \"next-auth/react\"\nimport { HomePageSkeleton } from \"@/components/skeletons/home-page-skeleton\"\nimport { ConnectionStatus } from \"@/components/ui/connection-status\"\n\nexport default function HomePage() {\n  const { status } = useSession()\n  \n  const workspaceTarget = status === \"authenticated\" ? \"/workspace\" : \"/login\"\n\n  // 在session加载期间显示骨架屏\n  if (status === \"loading\") {\n    return <HomePageSkeleton />\n  }\n\n\n\n  const features = [\n    { \n      icon: Sparkles, \n      title: \"智能高效\", \n      desc: \"AI驱动的创作流程，即时响应与流式输出，将想法快速转化为成品\" \n    },\n    { \n      icon: Shield, \n      title: \"安全可靠\", \n      desc: \"企业级安全保障，稳定的服务架构，确保数据安全与业务连续性\" \n    },\n    { \n      icon: Layers, \n      title: \"智能场景\", \n      desc: \"覆盖营销、文案、总结等多种创作场景，智能适配不同需求与平台\" \n    },\n  ]\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Header />\n      \n      {/* 连接状态指示器 - 仅在认证用户的情况下显示 */}\n      {status === \"authenticated\" && (\n        <ConnectionStatus\n          position=\"fixed\"\n          size=\"sm\"\n          className=\"top-20 right-4 z-[45]\"\n          animated={true}\n          autoHideWhenHealthy={true}\n          showDetails={false}\n        />\n      )}\n\n      {/* Hero：微网格/噪点纹理 + 排版优化 */}\n      <section className=\"relative overflow-hidden py-32 md:py-40 px-4\">\n        {/* 背景层：微网格 + 噪点（极低不透明度） */}\n        <div className=\"absolute inset-0 -z-10 pointer-events-none\">\n          {/* 网格（约 3% 透明度） */}\n          <div\n            className=\"absolute inset-0 opacity-[0.03]\"\n            style={{\n              backgroundImage:\n                \"linear-gradient(to right, rgba(0,0,0,0.25) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,0.25) 1px, transparent 1px)\",\n              backgroundSize: \"24px 24px\",\n            }}\n          />\n          {/* 噪点（约 4% 透明度） */}\n          <div\n            className=\"absolute inset-0 opacity-[0.04] mix-blend-overlay\"\n            style={{\n              backgroundImage:\n                \"url(\\\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'><filter id='n' x='0' y='0' width='1' height='1'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/></filter><rect width='100%' height='100%' filter='url(%23n)' opacity='0.4'/></svg>\\\")\",\n            }}\n          />\n        </div>\n\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"max-w-3xl md:max-w-4xl mx-auto md:mx-0 text-center md:text-left\">\n            <Badge variant=\"secondary\" className=\"mb-6 bg-primary/10 text-primary border-primary/20 text-sm px-4 py-2\">\n              AI驱动的创作平台\n            </Badge>\n\n            <h1 className=\"text-5xl md:text-7xl font-bold tracking-tight leading-tight text-foreground\">\n              支点有星辰\n            </h1>\n            <p className=\"text-lg md:text-xl text-muted-foreground mt-6 max-w-2xl md:max-w-3xl\">\n              提供沉浸式的内容创作体验\n            </p>\n\n            <div className=\"mt-10 flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center md:justify-start\">\n              <Button asChild size=\"lg\" className=\"px-12 py-3 text-lg\">\n                <Link href={workspaceTarget}>开始创作</Link>\n              </Button>\n              <Button asChild variant=\"outline\" size=\"lg\" className=\"px-12 py-3 text-lg bg-transparent\">\n                <Link href=\"/inspiration\">浏览灵感库</Link>\n              </Button>\n              <Button asChild variant=\"ghost\" size=\"lg\" className=\"px-10 py-3 text-lg hidden sm:inline-flex\">\n                <Link href=\"/help\">了解平台</Link>\n              </Button>\n            </div>\n          </div>\n        </div>\n      </section>\n      {/* 用例/模板 Tabs（P2） */}\n      <section className=\"px-4 py-8\">\n        <div className=\"max-w-6xl mx-auto\">\n          <h2 className=\"text-2xl md:text-3xl font-semibold tracking-tight text-foreground mb-6\">常用场景</h2>\n          <Tabs defaultValue=\"marketing\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"marketing\" className=\"text-xs\">营销文案</TabsTrigger>\n              <TabsTrigger value=\"script\" className=\"text-xs\">短视频脚本</TabsTrigger>\n              <TabsTrigger value=\"summary\" className=\"text-xs\">长文总结</TabsTrigger>\n            </TabsList>\n            <TabsContent value=\"marketing\" className=\"mt-6\">\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                <div className=\"rounded-xl border border-border p-6 bg-card transition-colors duration-200 hover:bg-card/80\">\n                  <h3 className=\"font-semibold mb-2\">产品推广帖</h3>\n                  <p className=\"text-sm text-muted-foreground\">快速生成多平台适配的推广文案。</p>\n                </div>\n                <div className=\"rounded-xl border border-border p-6 bg-card transition-colors duration-200 hover:bg-card/80\">\n                  <h3 className=\"font-semibold mb-2\">电商详情优化</h3>\n                  <p className=\"text-sm text-muted-foreground\">一键优化标题/卖点/描述。</p>\n                </div>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"script\" className=\"mt-6\">\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                <div className=\"rounded-xl border border-border p-6 bg-card transition-colors duration-200 hover:bg-card/80\">\n                  <h3 className=\"font-semibold mb-2\">短视频开场</h3>\n                  <p className=\"text-sm text-muted-foreground\">为不同平台自动适配钩子与节奏。</p>\n                </div>\n                <div className=\"rounded-xl border border-border p-6 bg-card transition-colors duration-200 hover:bg-card/80\">\n                  <h3 className=\"font-semibold mb-2\">分镜脚本</h3>\n                  <p className=\"text-sm text-muted-foreground\">按场景生成分镜要点与旁白。</p>\n                </div>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"summary\" className=\"mt-6\">\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                <div className=\"rounded-xl border border-border p-6 bg-card transition-colors duration-200 hover:bg-card/80\">\n                  <h3 className=\"font-semibold mb-2\">长文摘要</h3>\n                  <p className=\"text-sm text-muted-foreground\">提炼要点，保留关键事实与结论。</p>\n                </div>\n                <div className=\"rounded-xl border border-border p-6 bg-card transition-colors duration-200 hover:bg-card/80\">\n                  <h3 className=\"font-semibold mb-2\">会议纪要</h3>\n                  <p className=\"text-sm text-muted-foreground\">自动输出行动项与负责人。</p>\n                </div>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </section>\n\n      {/* 微示例区块（P3） */}\n      <section className=\"px-4 py-4\">\n        <div className=\"max-w-6xl mx-auto grid gap-6 md:grid-cols-2\">\n          {/* 左：几步开始 */}\n          <div className=\"rounded-xl border border-border p-6 bg-card transition-colors duration-200 hover:bg-card/80\">\n            <p className=\"text-xs text-muted-foreground mb-3\">几步开始</p>\n            <ol className=\"space-y-3 text-sm\">\n              <li>1. 选择创作场景（营销/脚本/总结）</li>\n              <li>2. 填写核心要点（品牌/产品/受众）</li>\n              <li>3. 点击“开始创作”，实时生成并微调</li>\n            </ol>\n          </div>\n          {/* 右：配置示例 */}\n          <div className=\"rounded-xl border border-border p-6 bg-card transition-colors duration-200 hover:bg-card/80 font-mono text-xs leading-relaxed\">\n            <p className=\"text-[11px] text-muted-foreground mb-3\">输入示例</p>\n            <pre className=\"whitespace-pre-wrap\">{`{\n  \"角色\": \"模型会自动匹配最合适的角色\",\n  \"需求\": \"需要什么文案\",\n  \"相关信息\": [\"品牌\", \"产品\", \"受众\" ],\n  \"优势特点\": {\n    \"是否差异化\": [\"品牌调性\", \"核心卖点\"],\n    \"平台\": \"抖音\"\n  }\n}`}</pre>\n          </div>\n        </div>\n      </section>\n\n      {/* KPM 指标条（P3） */}\n      <section className=\"px-4 py-16\">\n        <div className=\"max-w-6xl mx-auto\">\n          <h3 className=\"text-lg font-medium text-center mb-8 text-foreground/80\">平台数据</h3>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-8 text-center\">\n            <div>\n              <div className=\"text-3xl font-semibold\">99.95%</div>\n              <div className=\"text-xs text-muted-foreground mt-1\">服务可用性</div>\n            </div>\n            <div>\n              <div className=\"text-3xl font-semibold\">~1.2s</div>\n              <div className=\"text-xs text-muted-foreground mt-1\">平均响应延迟</div>\n            </div>\n            <div>\n              <div className=\"text-3xl font-semibold\">10K+</div>\n              <div className=\"text-xs text-muted-foreground mt-1\">日活生成量</div>\n            </div>\n            <div>\n              <div className=\"text-3xl font-semibold\">50%</div>\n              <div className=\"text-xs text-muted-foreground mt-1\">成本节省</div>\n            </div>\n          </div>\n        </div>\n      </section>\n\n\n\n\n\n      {/* 优势区：3-6 项卡片式要点 */}\n      <section className=\"py-16 px-4\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"mb-10 text-center\">\n            <Badge variant=\"secondary\" className=\"mb-3 bg-primary/10 text-primary border-primary/20 px-3 py-1\">\n              核心优势\n            </Badge>\n            <h2 className=\"text-2xl md:text-3xl font-semibold tracking-tight text-foreground\">为什么选择我们</h2>\n            <p className=\"text-sm md:text-base text-muted-foreground mt-2\">面向创作全流程的专业能力与体验</p>\n          </div>\n\n          <div className=\"grid gap-8 md:grid-cols-2 lg:grid-cols-3\">\n            {features.map((f) => (\n              <Card key={f.title} className=\"h-full bg-card transition-all duration-200 hover:bg-card/80 hover:-translate-y-0.5 hover:shadow-lg\">\n                <CardHeader>\n                  <div className=\"flex items-center gap-3\">\n                    <f.icon className=\"size-5 text-primary\" />\n                    <CardTitle className=\"text-base md:text-lg\">{f.title}</CardTitle>\n                  </div>\n                  <CardDescription className=\"text-sm text-muted-foreground mt-2 leading-relaxed\">\n                    {f.desc}\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            ))}\n          </div>\n        </div>\n      </section>\n\n      {/* 收束式 CTA：中性背景，强调主 CTA */}\n      <section className=\"py-16 px-4 bg-muted/30\">\n        <div className=\"max-w-4xl mx-auto text-center\">\n          <h2 className=\"text-3xl md:text-4xl font-semibold tracking-tight text-foreground\">开始您的创作之旅</h2>\n          <p className=\"text-base md:text-lg text-muted-foreground mt-4\">体验前沿的大模型，立即开启高效创作</p>\n          <div className=\"mt-8 flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center\">\n            <Button asChild size=\"lg\" className=\"px-12 py-3 text-lg\">\n              <Link href={workspaceTarget}>立即开始</Link>\n            </Button>\n            <Button asChild variant=\"outline\" size=\"lg\" className=\"px-12 py-3 text-lg bg-transparent\">\n              <Link href=\"/inspiration\">浏览灵感库</Link>\n            </Button>\n          </div>\n        </div>\n      </section>\n\n      {/* Footer 保持原有结构与风格 */}\n      <footer className=\"py-16 px-4 bg-muted/30\">\n        <div className=\"max-w-6xl mx-auto\">\n          <div className=\"grid md:grid-cols-4 gap-12\">\n            <div className=\"md:col-span-2\">\n              <h3 className=\"font-bold text-2xl text-foreground mb-4\">支点有星辰</h3>\n              <p className=\"text-muted-foreground text-lg leading-relaxed\">\n                专业的AI创作平台，让创作变得更加智能和高效\n              </p>\n            </div>\n\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-6 text-lg\">产品</h4>\n              <div className=\"space-y-3\">\n                <Link href={workspaceTarget} className=\"block text-muted-foreground hover:text-primary transition-colors\">\n                  创作工作台\n                </Link>\n                <Link href=\"/inspiration\" className=\"block text-muted-foreground hover:text-primary transition-colors\">\n                  灵感库\n                </Link>\n                <Link href=\"/documents\" className=\"block text-muted-foreground hover:text-primary transition-colors\">\n                  文档管理\n                </Link>\n              </div>\n            </div>\n\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-6 text-lg\">支持</h4>\n              <div className=\"space-y-3\">\n                <Link href=\"/help\" className=\"block text-muted-foreground hover:text-primary transition-colors\">\n                  帮助中心\n                </Link>\n                <Link href=\"/feedback\" className=\"block text-muted-foreground hover:text-primary transition-colors\">\n                  意见反馈\n                </Link>\n                <Link href=\"/settings\" className=\"block text-muted-foreground hover:text-primary transition-colors\">\n                  设置\n                </Link>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"mt-12 pt-8 text-center text-muted-foreground\">\n            <p>&copy; 2025 支点有星辰. 保留所有权利.</p>\n          </div>\n        </div>\n      </footer>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\settings\\enhanced-page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'status' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":89,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":89,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"status"},"fix":{"range":[2425,2433],"text":""},"desc":"Remove unused variable 'status'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":231,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":231,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 增强版设置页面\r\n * 集成网络状态监控、自动重连、页面可见性感知等可靠性功能\r\n */\r\n\r\n\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { Header } from \"@/components/header\"\r\nimport { toast } from \"sonner\"\r\nimport { useSession, signOut } from \"next-auth/react\"\r\nimport {\r\n  User,\r\n  Mail,\r\n  Lock,\r\n  Palette,\r\n  Layout,\r\n  BarChart3,\r\n  Settings,\r\n  Calendar,\r\n  Zap,\r\n  Eye,\r\n  EyeOff,\r\n  LogOut,\r\n  ChartColumn,\r\n  RefreshCw,\r\n  Wifi,\r\n  WifiOff,\r\n} from \"lucide-react\"\r\nimport { StatsCardsGridSkeleton, UsageDetailCardSkeleton } from \"@/components/ui/stats-card-skeleton\"\r\nimport { ModelUsageCards } from \"@/components/stats/model-usage-cards\"\r\nimport { ConnectionRecovery } from \"@/components/ui/connection-recovery\"\r\nimport { useNetworkStatus } from \"@/hooks/use-network-status\"\r\nimport { useVisibilityAwareData } from \"@/hooks/use-page-visibility\"\r\nimport { smartApi } from \"@/lib/utils/smart-fetch\"\r\n\r\ninterface UsageData {\r\n  date: string\r\n  tokens: number\r\n  requests: number\r\n}\r\n\r\ninterface ModelUsageData {\r\n  displayName: string\r\n  provider: string\r\n  totalTokens: number\r\n  requests: number\r\n  promptTokens: number\r\n  completionTokens: number\r\n  percentage: number\r\n  formattedTokens: string\r\n  formattedRequests: string\r\n}\r\n\r\ninterface ModelStatsResponse {\r\n  success: boolean\r\n  data: {\r\n    totalStats: {\r\n      totalTokens: number\r\n      totalRequests: number\r\n      formattedTokens: string\r\n      formattedRequests: string\r\n      avgTokensPerRequest: number\r\n    }\r\n    modelStats: Record<string, ModelUsageData>\r\n    dailyStats: Array<{\r\n      date: string\r\n      models: Record<string, { tokens: number; requests: number }>\r\n    }>\r\n    summary: {\r\n      queryDays: number\r\n      totalModels: number\r\n      mostUsedModel: string | null\r\n      leastUsedModel: string | null\r\n      hasData: boolean\r\n    }\r\n  }\r\n}\r\n\r\nexport default function EnhancedSettingsPage() {\r\n  const { data: session, status } = useSession()\r\n  const [activeTab, setActiveTab] = useState(\"usage\")\r\n  const [showPassword, setShowPassword] = useState(false)\r\n  const [showConnectionRecovery, setShowConnectionRecovery] = useState(false)\r\n\r\n  // 账户设置状态\r\n  const [email, setEmail] = useState(\"user@example.com\")\r\n  const [currentPassword, setCurrentPassword] = useState(\"\")\r\n  const [newPassword, setNewPassword] = useState(\"\")\r\n  const [confirmPassword, setConfirmPassword] = useState(\"\")\r\n\r\n  // 偏好设置状态\r\n  const [theme, setTheme] = useState(\"system\")\r\n  const [language, setLanguage] = useState(\"zh-CN\")\r\n  const [autoSave, setAutoSave] = useState(true)\r\n  const [notifications, setNotifications] = useState(true)\r\n\r\n  // 网络状态监控\r\n  const { isConnected, connectivity, rtt, checkNetworkStatus } = useNetworkStatus({\r\n    enableNotifications: true,\r\n    healthCheckInterval: 30000\r\n  })\r\n\r\n  // 获取当前用户ID\r\n  const fetchCurrentUserId = async (): Promise<string | null> => {\r\n    const idFromSession = (session as any)?.user?.id\r\n    return (idFromSession as string) || null\r\n  }\r\n\r\n  // 使用可见性感知的数据获取 - 使用量数据\r\n  const {\r\n    data: usageData,\r\n    loading: loadingUsage,\r\n    error: usageError,\r\n    fetchData: refetchUsage\r\n  } = useVisibilityAwareData<UsageData[]>(\r\n    async () => {\r\n      const userId = await fetchCurrentUserId()\r\n      if (!userId) {\r\n        throw new Error(\"未登录或无法获取用户信息\")\r\n      }\r\n\r\n      const response = await smartApi.getJson<any>(`/api/users/${userId}`, {\r\n        retry: { maxRetries: 3, initialDelay: 1000 },\r\n        waitForRecovery: true,\r\n        timeout: 15000\r\n      })\r\n      \r\n      const stats = (response?.data?.usageStats || []) as Array<{ date: string; totalTokens: number; apiCalls: number }>\r\n      \r\n      // 数据去重和合并逻辑\r\n      const dateMap = new Map<string, { tokens: number; requests: number; count: number }>()\r\n      \r\n      stats.forEach((item) => {\r\n        const dateKey = new Date(item.date).toISOString().split(\"T\")[0]\r\n        const existing = dateMap.get(dateKey)\r\n        \r\n        if (existing) {\r\n          existing.tokens += item.totalTokens || 0\r\n          existing.requests += item.apiCalls || 0\r\n          existing.count += 1\r\n        } else {\r\n          dateMap.set(dateKey, {\r\n            tokens: item.totalTokens || 0,\r\n            requests: item.apiCalls || 0,\r\n            count: 1\r\n          })\r\n        }\r\n      })\r\n      \r\n      const mapped: UsageData[] = Array.from(dateMap.entries())\r\n        .map(([date, data]) => ({\r\n          date,\r\n          tokens: data.tokens,\r\n          requests: data.requests,\r\n        }))\r\n        .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\r\n      \r\n      return mapped\r\n    },\r\n    {\r\n      fetchOnMount: true,\r\n      forceRefreshOnLongAbsence: true,\r\n      longAbsenceThreshold: 5 * 60 * 1000 // 5分钟\r\n    }\r\n  )\r\n\r\n  // 使用可见性感知的数据获取 - 模型统计数据\r\n  const {\r\n    data: modelStats,\r\n    loading: loadingModelStats,\r\n    error: modelStatsError,\r\n    fetchData: refetchModelStats\r\n  } = useVisibilityAwareData<ModelStatsResponse['data']>(\r\n    async () => {\r\n      const userId = await fetchCurrentUserId()\r\n      if (!userId) {\r\n        throw new Error(\"未登录或无法获取用户信息\")\r\n      }\r\n      \r\n      const response = await smartApi.getJson<ModelStatsResponse>(`/api/users/${userId}/model-stats?days=30`, {\r\n        retry: { maxRetries: 3, initialDelay: 1000 },\r\n        waitForRecovery: true,\r\n        timeout: 15000\r\n      })\r\n      \r\n      if (!response.success) {\r\n        throw new Error(\"API返回失败状态\")\r\n      }\r\n      \r\n      return response.data\r\n    },\r\n    {\r\n      fetchOnMount: true,\r\n      forceRefreshOnLongAbsence: true,\r\n      longAbsenceThreshold: 5 * 60 * 1000\r\n    }\r\n  )\r\n\r\n  // 监听网络状态变化\r\n  useEffect(() => {\r\n    if (!isConnected && (usageError || modelStatsError)) {\r\n      setShowConnectionRecovery(true)\r\n    } else if (isConnected && showConnectionRecovery) {\r\n      setShowConnectionRecovery(false)\r\n      // 网络恢复后自动重新获取数据\r\n      refetchUsage()\r\n      refetchModelStats()\r\n    }\r\n  }, [isConnected, usageError, modelStatsError, showConnectionRecovery, refetchUsage, refetchModelStats])\r\n\r\n  // 手动刷新所有数据\r\n  const handleRefreshAll = async () => {\r\n    toast.loading(\"正在刷新数据...\", { id: \"refresh-all\" })\r\n    \r\n    try {\r\n      await Promise.all([\r\n        refetchUsage(),\r\n        refetchModelStats()\r\n      ])\r\n      \r\n      toast.success(\"数据刷新成功\", { id: \"refresh-all\" })\r\n    } catch (error) {\r\n      toast.error(\"数据刷新失败\", { id: \"refresh-all\" })\r\n    }\r\n  }\r\n\r\n  // 账户操作\r\n  const handleUpdateEmail = () => {\r\n    toast.success(\"邮箱更新成功\")\r\n  }\r\n\r\n  const handleUpdatePassword = () => {\r\n    if (newPassword !== confirmPassword) {\r\n      toast.error(\"新密码与确认密码不匹配\")\r\n      return\r\n    }\r\n    toast.success(\"密码更新成功\")\r\n    setCurrentPassword(\"\")\r\n    setNewPassword(\"\")\r\n    setConfirmPassword(\"\")\r\n  }\r\n\r\n  // 计算统计数据\r\n  const totalTokens = usageData?.reduce((sum, data) => sum + data.tokens, 0) || 0\r\n  const totalRequests = usageData?.reduce((sum, data) => sum + data.requests, 0) || 0\r\n  const avgTokensPerRequest = totalRequests > 0 ? Math.round(totalTokens / totalRequests) : 0\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-background\">\r\n      <Header />\r\n\r\n      {/* 网络状态指示器 */}\r\n      {connectivity !== 'good' && (\r\n        <div className=\"fixed top-20 left-4 z-[45] flex items-center gap-2 px-3 py-2 bg-yellow-500 text-white text-sm rounded-full shadow-lg\">\r\n          {connectivity === 'offline' ? (\r\n            <>\r\n              <WifiOff className=\"w-4 h-4\" />\r\n              {isConnected ? '服务器离线' : '网络离线'}\r\n            </>\r\n          ) : (\r\n            <>\r\n              <Wifi className=\"w-4 h-4\" />\r\n              连接较慢 {rtt && `(${Math.round(rtt)}ms)`}\r\n            </>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      <main className=\"container mx-auto py-8 px-4\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <div className=\"mb-8 flex items-center justify-between\">\r\n            <div>\r\n              <h1 className=\"text-2xl font-semibold text-foreground mb-2\">设置</h1>\r\n              <p className=\"text-muted-foreground\">管理您的账户、偏好设置和API配置</p>\r\n            </div>\r\n            \r\n            {/* 刷新按钮 */}\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={handleRefreshAll}\r\n              disabled={loadingUsage || loadingModelStats}\r\n              className=\"gap-2\"\r\n            >\r\n              <RefreshCw className={`w-4 h-4 ${(loadingUsage || loadingModelStats) ? 'animate-spin' : ''}`} />\r\n              刷新数据\r\n            </Button>\r\n          </div>\r\n\r\n          <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\r\n            <TabsList className=\"grid w-full grid-cols-3\">\r\n              <TabsTrigger value=\"usage\" className=\"gap-2\">\r\n                <BarChart3 className=\"h-4 w-4\" />\r\n                用量\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"account\" className=\"gap-2\">\r\n                <User className=\"h-4 w-4\" />\r\n                账户\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"preferences\" className=\"gap-2\">\r\n                <Settings className=\"h-4 w-4\" />\r\n                偏好\r\n              </TabsTrigger>\r\n            </TabsList>\r\n\r\n            {/* 用量统计 */}\r\n            <TabsContent value=\"usage\" className=\"space-y-6\">\r\n              {/* 数据卡片网格 - 带加载状态 */}\r\n              {loadingUsage ? (\r\n                <StatsCardsGridSkeleton />\r\n              ) : (\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                  <Card>\r\n                    <CardContent className=\"p-4\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <Zap className=\"h-8 w-8 text-primary/60\" />\r\n                        <div>\r\n                          <p className=\"text-sm text-muted-foreground\">总Token使用</p>\r\n                          <p className=\"text-2xl font-semibold\">{totalTokens.toLocaleString()}</p>\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardContent className=\"p-4\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <ChartColumn className=\"h-8 w-8 text-primary/60\" />\r\n                        <div>\r\n                          <p className=\"text-sm text-muted-foreground\">总请求数</p>\r\n                          <p className=\"text-2xl font-semibold\">{totalRequests}</p>\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                  <Card>\r\n                    <CardContent className=\"p-4\">\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <Calendar className=\"h-8 w-8 text-primary/60\" />\r\n                        <div>\r\n                          <p className=\"text-sm text-muted-foreground\">平均Token/请求</p>\r\n                          <p className=\"text-2xl font-semibold\">{avgTokensPerRequest}</p>\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>\r\n              )}\r\n\r\n              {/* 模型使用分布 */}\r\n              {modelStatsError ? (\r\n                <Card className=\"border-destructive\">\r\n                  <CardContent className=\"p-6 text-center\">\r\n                    <p className=\"text-sm text-destructive\">{modelStatsError.message}</p>\r\n                    <Button \r\n                      variant=\"outline\" \r\n                      size=\"sm\" \r\n                      onClick={() => refetchModelStats()}\r\n                      className=\"mt-2\"\r\n                    >\r\n                      重新加载\r\n                    </Button>\r\n                  </CardContent>\r\n                </Card>\r\n              ) : (\r\n                <ModelUsageCards \r\n                  modelStats={modelStats?.modelStats || {}}\r\n                  totalStats={modelStats?.totalStats || {\r\n                    totalTokens: 0,\r\n                    totalRequests: 0,\r\n                    formattedTokens: \"0\",\r\n                    formattedRequests: \"0\"\r\n                  }}\r\n                  loading={loadingModelStats}\r\n                  className=\"mt-6\"\r\n                />\r\n              )}\r\n\r\n              {/* 使用情况详细卡片 */}\r\n              {loadingUsage ? (\r\n                <UsageDetailCardSkeleton />\r\n              ) : (\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle>最近30天使用情况</CardTitle>\r\n                    <CardDescription>Token使用量和请求数统计</CardDescription>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"space-y-4\">\r\n                      {!usageData || usageData.length === 0 ? (\r\n                        <p className=\"text-sm text-muted-foreground\">暂无数据</p>\r\n                      ) : (\r\n                        usageData.map((data, index) => (\r\n                          <div key={`usage-${data.date}-${index}`} className=\"space-y-2\">\r\n                            <div className=\"flex items-center justify-between text-sm\">\r\n                              <span>{data.date}</span>\r\n                              <div className=\"flex items-center gap-4\">\r\n                                <span className=\"text-muted-foreground\">{data.tokens} tokens</span>\r\n                                <span className=\"text-muted-foreground\">{data.requests} 请求</span>\r\n                              </div>\r\n                            </div>\r\n                            <Progress value={(data.tokens / Math.max(1, ...usageData.map((d) => d.tokens))) * 100} />\r\n                          </div>\r\n                        ))\r\n                      )}\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              )}\r\n\r\n              {/* 账户管理 */}\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <User className=\"h-5 w-5\" />\r\n                    账户管理\r\n                  </CardTitle>\r\n                  <CardDescription>管理您的账户设置</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <Button \r\n                    variant=\"destructive\" \r\n                    onClick={() => {\r\n                      signOut({ callbackUrl: '/login' })\r\n                    }}\r\n                    className=\"gap-2\"\r\n                  >\r\n                    <LogOut className=\"h-4 w-4\" />\r\n                    退出登录\r\n                  </Button>\r\n                </CardContent>\r\n              </Card>\r\n            </TabsContent>\r\n\r\n            {/* 账户设置和偏好设置保持不变 */}\r\n            <TabsContent value=\"account\" className=\"space-y-6\">\r\n              {/* 账户设置内容 */}\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Mail className=\"h-5 w-5\" />\r\n                    邮箱设置\r\n                  </CardTitle>\r\n                  <CardDescription>管理您的账户与偏好设置</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"email\">邮箱地址</Label>\r\n                    <Input id=\"email\" type=\"email\" value={email} onChange={(e) => setEmail(e.target.value)} />\r\n                  </div>\r\n                  <Button onClick={handleUpdateEmail}>更新邮箱</Button>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Lock className=\"h-5 w-5\" />\r\n                    密码设置\r\n                  </CardTitle>\r\n                  <CardDescription>重设您的登录密码</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"current-password\">当前密码</Label>\r\n                    <div className=\"relative\">\r\n                      <Input\r\n                        id=\"current-password\"\r\n                        type={showPassword ? \"text\" : \"password\"}\r\n                        value={currentPassword}\r\n                        onChange={(e) => setCurrentPassword(e.target.value)}\r\n                      />\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"sm\"\r\n                        className=\"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 p-0\"\r\n                        onClick={() => setShowPassword(!showPassword)}\r\n                      >\r\n                        {showPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"new-password\">新密码</Label>\r\n                    <Input\r\n                      id=\"new-password\"\r\n                      type=\"password\"\r\n                      value={newPassword}\r\n                      onChange={(e) => setNewPassword(e.target.value)}\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"confirm-password\">确认新密码</Label>\r\n                    <Input\r\n                      id=\"confirm-password\"\r\n                      type=\"password\"\r\n                      value={confirmPassword}\r\n                      onChange={(e) => setConfirmPassword(e.target.value)}\r\n                    />\r\n                  </div>\r\n                  <Button onClick={handleUpdatePassword}>更新密码</Button>\r\n                </CardContent>\r\n              </Card>\r\n            </TabsContent>\r\n\r\n            {/* 偏好设置 */}\r\n            <TabsContent value=\"preferences\" className=\"space-y-6\">\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Palette className=\"h-5 w-5\" />\r\n                    外观设置\r\n                  </CardTitle>\r\n                  <CardDescription>自定义界面主题和外观</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label>主题选择</Label>\r\n                    <Select value={theme} onValueChange={setTheme}>\r\n                      <SelectTrigger>\r\n                        <SelectValue />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"light\">浅色模式</SelectItem>\r\n                        <SelectItem value=\"dark\">深色模式</SelectItem>\r\n                        <SelectItem value=\"system\">跟随系统</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>语言设置</Label>\r\n                    <Select value={language} onValueChange={setLanguage}>\r\n                      <SelectTrigger>\r\n                        <SelectValue />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"zh-CN\">简体中文</SelectItem>\r\n                        <SelectItem value=\"en-US\">English</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardHeader>\r\n                  <CardTitle className=\"flex items-center gap-2\">\r\n                    <Layout className=\"h-5 w-5\" />\r\n                    功能设置\r\n                  </CardTitle>\r\n                  <CardDescription>配置应用功能和行为</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"space-y-0.5\">\r\n                      <Label>自动保存</Label>\r\n                      <p className=\"text-sm text-muted-foreground\">编辑时自动保存文档</p>\r\n                    </div>\r\n                    <Switch checked={autoSave} onCheckedChange={setAutoSave} />\r\n                  </div>\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"space-y-0.5\">\r\n                      <Label>桌面通知</Label>\r\n                      <p className=\"text-sm text-muted-foreground\">接收重要事件的桌面通知</p>\r\n                    </div>\r\n                    <Switch checked={notifications} onCheckedChange={setNotifications} />\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            </TabsContent>\r\n          </Tabs>\r\n        </div>\r\n      </main>\r\n\r\n      {/* 连接恢复界面 */}\r\n      <ConnectionRecovery\r\n        show={showConnectionRecovery}\r\n        errorType={!isConnected ? 'network' : 'server'}\r\n        onRecovery={() => {\r\n          setShowConnectionRecovery(false)\r\n          handleRefreshAll()\r\n        }}\r\n        onClose={() => setShowConnectionRecovery(false)}\r\n        customRecoveryAction={async () => {\r\n          const networkStatus = await checkNetworkStatus()\r\n          return networkStatus.isOnline && networkStatus.serverHealthy\r\n        }}\r\n      />\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\settings\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'usageError' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":98,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":98,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"usageError"},"fix":{"range":[2878,2888],"text":""},"desc":"Remove unused variable 'usageError'."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchModelStats' and 'fetchUsage'. Either include them or remove the dependency array.","line":246,"column":6,"nodeType":"ArrayExpression","endLine":246,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [fetchModelStats, fetchUsage, status]","fix":{"range":[7175,7211],"text":"[fetchModelStats, fetchUsage, status]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":246,"column":15,"nodeType":"ChainExpression","endLine":246,"endColumn":41,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useState } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { Switch } from \"@/components/ui/switch\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Progress } from \"@/components/ui/progress\"\nimport { Header } from \"@/components/header\"\nimport { toast } from \"sonner\"\nimport { useSession, signOut } from \"next-auth/react\"\nimport {\n  User,\n  Mail,\n  Lock,\n  Palette,\n  Layout,\n  BarChart3,\n  Settings,\n  Calendar,\n  Zap,\n  Eye,\n  EyeOff,\n  LogOut,\n  ChartColumn,\n} from \"lucide-react\"\nimport { StatsCardsGridSkeleton, UsageDetailCardSkeleton } from \"@/components/ui/stats-card-skeleton\"\nimport { ModelUsageCards } from \"@/components/stats/model-usage-cards\"\nimport { ConnectionStatus } from \"@/components/ui/connection-status\"\nimport { ConnectionRecovery } from \"@/components/ui/connection-recovery\"\n\ninterface UsageData {\n  date: string\n  tokens: number\n  requests: number\n}\n\ninterface ModelUsageData {\n  displayName: string\n  provider: string\n  totalTokens: number\n  requests: number\n  promptTokens: number\n  completionTokens: number\n  percentage: number\n  formattedTokens: string\n  formattedRequests: string\n}\n\ninterface ModelStatsResponse {\n  success: boolean\n  data: {\n    totalStats: {\n      totalTokens: number\n      totalRequests: number\n      formattedTokens: string\n      formattedRequests: string\n      avgTokensPerRequest: number\n    }\n    modelStats: Record<string, ModelUsageData>\n    dailyStats: Array<{\n      date: string\n      models: Record<string, { tokens: number; requests: number }>\n    }>\n    summary: {\n      queryDays: number\n      totalModels: number\n      mostUsedModel: string | null\n      leastUsedModel: string | null\n      hasData: boolean\n    }\n  }\n}\n\nexport default function SettingsPage() {\n  const { data: session, status } = useSession()\n  const [activeTab, setActiveTab] = useState(\"usage\")\n  const [showPassword, setShowPassword] = useState(false)\n\n  // 账户设置状态\n  const [email, setEmail] = useState(\"user@example.com\")\n  const [currentPassword, setCurrentPassword] = useState(\"\")\n  const [newPassword, setNewPassword] = useState(\"\")\n  const [confirmPassword, setConfirmPassword] = useState(\"\")\n\n  // 偏好设置状态\n  const [theme, setTheme] = useState(\"system\")\n  const [language, setLanguage] = useState(\"zh-CN\")\n  const [autoSave, setAutoSave] = useState(true)\n  const [notifications, setNotifications] = useState(true)\n\n  // 用量真实数据\n  const [usageData, setUsageData] = useState<UsageData[]>([])\n  const [loadingUsage, setLoadingUsage] = useState(false)\n  const [usageError, setUsageError] = useState<string | null>(null)\n\n  // 模型统计数据\n  const [modelStats, setModelStats] = useState<ModelStatsResponse['data'] | null>(null)\n  const [loadingModelStats, setLoadingModelStats] = useState(false)\n  const [modelStatsError, setModelStatsError] = useState<string | null>(null)\n\n  // 连接监控状态\n  const [showConnectionRecovery, setShowConnectionRecovery] = useState(false)\n  const [connectionError, setConnectionError] = useState<string | null>(null)\n\n  const handleUpdateEmail = () => {\n    toast.success(\"邮箱更新成功\")\n  }\n\n  const handleUpdatePassword = () => {\n    if (newPassword !== confirmPassword) {\n      toast.error(\"新密码与确认密码不匹配\")\n      return\n    }\n    toast.success(\"密码更新成功\")\n    setCurrentPassword(\"\")\n    setNewPassword(\"\")\n    setConfirmPassword(\"\")\n  }\n\n  // 连接状态变化处理\n  const handleConnectionStatusChange = (connected: boolean) => {\n    if (!connected) {\n      setConnectionError(\"连接已断开，可能是服务器重启或网络问题\")\n      setShowConnectionRecovery(true)\n    } else {\n      setConnectionError(null)\n      setShowConnectionRecovery(false)\n    }\n  }\n\n  // 连接恢复成功处理\n  const handleConnectionRecovery = () => {\n    setShowConnectionRecovery(false)\n    setConnectionError(null)\n    toast.success(\"连接已恢复，正在重新加载数据...\")\n    \n    // 重新获取数据\n    if (status === 'authenticated') {\n      fetchUsage()\n      fetchModelStats()\n    }\n  }\n\n  // 获取当前用户ID：优先 useSession，兜底 /api/auth/me\n  const fetchCurrentUserId = async (): Promise<string | null> => {\n    const idFromSession = (session as any)?.user?.id\n    return (idFromSession as string) || null\n  }\n\n  const fetchUsage = async () => {\n    setLoadingUsage(true)\n    setUsageError(null)\n    try {\n      const userId = await fetchCurrentUserId()\n      if (!userId) {\n        setUsageError(\"未登录或无法获取用户信息\")\n        setUsageData([])\n        return\n      }\n      const res = await fetch(`/api/users/${userId}`)\n      if (!res.ok) throw new Error(\"获取使用量失败\")\n      const result = await res.json()\n      const stats = (result?.data?.usageStats || []) as Array<{ date: string; totalTokens: number; apiCalls: number }>\n      \n      // 方案：使用Map确保日期唯一性，并智能合并重复数据\n      const dateMap = new Map<string, { tokens: number; requests: number; count: number }>()\n      \n      stats.forEach((item) => {\n        const dateKey = new Date(item.date).toISOString().split(\"T\")[0]\n        const existing = dateMap.get(dateKey)\n        \n        if (existing) {\n          // 合并重复日期的数据\n          existing.tokens += item.totalTokens || 0\n          existing.requests += item.apiCalls || 0\n          existing.count += 1\n        } else {\n          // 创建新记录\n          dateMap.set(dateKey, {\n            tokens: item.totalTokens || 0,\n            requests: item.apiCalls || 0,\n            count: 1\n          })\n        }\n      })\n      \n      const mapped: UsageData[] = Array.from(dateMap.entries())\n        .map(([date, data]) => ({\n          date,\n          tokens: data.tokens,\n          requests: data.requests,\n        }))\n        .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())\n      \n      // 调试信息：记录重复数据情况\n      const duplicateCount = Array.from(dateMap.values()).filter(d => d.count > 1).length\n      if (duplicateCount > 0) {\n        }\n      setUsageData(mapped)\n    } catch (e: any) {\n      setUsageError(e?.message || \"获取使用量失败\")\n      setUsageData([])\n    } finally {\n      setLoadingUsage(false)\n    }\n  }\n\n  // 获取模型统计数据\n  const fetchModelStats = async () => {\n    setLoadingModelStats(true)\n    setModelStatsError(null)\n    try {\n      const userId = await fetchCurrentUserId()\n      if (!userId) {\n        setModelStatsError(\"未登录或无法获取用户信息\")\n        setModelStats(null)\n        return\n      }\n      \n      const res = await fetch(`/api/users/${userId}/model-stats?days=30`)\n      if (!res.ok) throw new Error(\"获取模型统计失败\")\n      \n      const result: ModelStatsResponse = await res.json()\n      if (result.success) {\n        setModelStats(result.data)\n      } else {\n        throw new Error(\"API返回失败状态\")\n      }\n    } catch (e: any) {\n      setModelStatsError(e?.message || \"获取模型统计失败\")\n      setModelStats(null)\n    } finally {\n      setLoadingModelStats(false)\n    }\n  }\n\n  useEffect(() => {\n    if (status !== 'authenticated') return\n    fetchUsage()\n    fetchModelStats()\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [status, (session as any)?.user?.id])\n\n  const totalTokens = usageData.reduce((sum, data) => sum + data.tokens, 0)\n  const totalRequests = usageData.reduce((sum, data) => sum + data.requests, 0)\n  const avgTokensPerRequest = totalRequests > 0 ? Math.round(totalTokens / totalRequests) : 0\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Header />\n\n      <main className=\"container mx-auto py-8 px-4\">\n        <div className=\"max-w-4xl mx-auto\">\n          <div className=\"mb-8\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <div>\n                <h1 className=\"text-2xl font-semibold text-foreground mb-2\">设置</h1>\n                <p className=\"text-muted-foreground\">管理您的账户、偏好设置和API配置</p>\n              </div>\n              \n              {/* 连接状态指示器 */}\n              <ConnectionStatus\n                size=\"md\"\n                showDetails={true}\n                onStatusChange={handleConnectionStatusChange}\n                className=\"ml-4\"\n              />\n            </div>\n          </div>\n\n          <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\n            <TabsList className=\"grid w-full grid-cols-3\">\n              <TabsTrigger value=\"usage\" className=\"gap-2\">\n                <BarChart3 className=\"h-4 w-4\" />\n                用量\n              </TabsTrigger>\n              <TabsTrigger value=\"account\" className=\"gap-2\">\n                <User className=\"h-4 w-4\" />\n                账户\n              </TabsTrigger>\n              <TabsTrigger value=\"preferences\" className=\"gap-2\">\n                <Settings className=\"h-4 w-4\" />\n                偏好\n              </TabsTrigger>\n            </TabsList>\n\n            {/* 用量统计 */}\n            <TabsContent value=\"usage\" className=\"space-y-6\">\n              {/* 数据卡片网格 - 带加载状态 */}\n              {loadingUsage ? (\n                <StatsCardsGridSkeleton />\n              ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <Card>\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Zap className=\"h-8 w-8 text-primary/60\" />\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">总Token使用</p>\n                          <p className=\"text-2xl font-semibold\">{totalTokens.toLocaleString()}</p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                  <Card>\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <ChartColumn className=\"h-8 w-8 text-primary/60\" />\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">总请求数</p>\n                          <p className=\"text-2xl font-semibold\">{totalRequests}</p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                  <Card>\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <Calendar className=\"h-8 w-8 text-primary/60\" />\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">平均Token/请求</p>\n                          <p className=\"text-2xl font-semibold\">{avgTokensPerRequest}</p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n              )}\n\n              {/* 模型使用分布 - 新增功能 */}\n              {modelStatsError ? (\n                <Card className=\"border-destructive\">\n                  <CardContent className=\"p-6 text-center\">\n                    <p className=\"text-sm text-destructive\">{modelStatsError}</p>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      onClick={fetchModelStats}\n                      className=\"mt-2\"\n                    >\n                      重新加载\n                    </Button>\n                  </CardContent>\n                </Card>\n              ) : (\n                <ModelUsageCards \n                  modelStats={modelStats?.modelStats || {}}\n                  totalStats={modelStats?.totalStats || {\n                    totalTokens: 0,\n                    totalRequests: 0,\n                    formattedTokens: \"0\",\n                    formattedRequests: \"0\"\n                  }}\n                  loading={loadingModelStats}\n                  className=\"mt-6\"\n                />\n              )}\n\n              {/* 使用情况详细卡片 - 带加载状态 */}\n              {loadingUsage ? (\n                <UsageDetailCardSkeleton />\n              ) : (\n                <Card>\n                  <CardHeader>\n                    <CardTitle>最近30天使用情况</CardTitle>\n                    <CardDescription>Token使用量和请求数统计</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      {usageData.length === 0 ? (\n                        <p className=\"text-sm text-muted-foreground\">暂无数据</p>\n                      ) : (\n                        usageData.map((data, index) => (\n                          <div key={`usage-${data.date}-${index}`} className=\"space-y-2\">\n                            <div className=\"flex items-center justify-between text-sm\">\n                              <span>{data.date}</span>\n                              <div className=\"flex items-center gap-4\">\n                                <span className=\"text-muted-foreground\">{data.tokens} tokens</span>\n                                <span className=\"text-muted-foreground\">{data.requests} 请求</span>\n                              </div>\n                            </div>\n                            <Progress value={(data.tokens / Math.max(1, ...usageData.map((d) => d.tokens))) * 100} />\n                          </div>\n                        ))\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n\n              {/* 账户管理 */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <User className=\"h-5 w-5\" />\n                    账户管理\n                  </CardTitle>\n                  <CardDescription>管理您的账户设置</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <Button \n                    variant=\"destructive\" \n                    onClick={() => {\n                      signOut({ callbackUrl: '/login' })\n                    }}\n                    className=\"gap-2\"\n                  >\n                    <LogOut className=\"h-4 w-4\" />\n                    退出登录\n                  </Button>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            {/* 账户设置 */}\n            <TabsContent value=\"account\" className=\"space-y-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Mail className=\"h-5 w-5\" />\n                    邮箱设置\n                  </CardTitle>\n                  <CardDescription>管理您的账户与偏好设置</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"email\">邮箱地址</Label>\n                    <Input id=\"email\" type=\"email\" value={email} onChange={(e) => setEmail(e.target.value)} />\n                  </div>\n                  <Button onClick={handleUpdateEmail}>更新邮箱</Button>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Lock className=\"h-5 w-5\" />\n                    密码设置\n                  </CardTitle>\n                  <CardDescription>重设您的登录密码</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"current-password\">当前密码</Label>\n                    <div className=\"relative\">\n                      <Input\n                        id=\"current-password\"\n                        type={showPassword ? \"text\" : \"password\"}\n                        value={currentPassword}\n                        onChange={(e) => setCurrentPassword(e.target.value)}\n                      />\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"absolute right-2 top-1/2 -translate-y-1/2 h-6 w-6 p-0\"\n                        onClick={() => setShowPassword(!showPassword)}\n                      >\n                        {showPassword ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                      </Button>\n                    </div>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"new-password\">新密码</Label>\n                    <Input\n                      id=\"new-password\"\n                      type=\"password\"\n                      value={newPassword}\n                      onChange={(e) => setNewPassword(e.target.value)}\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"confirm-password\">确认新密码</Label>\n                    <Input\n                      id=\"confirm-password\"\n                      type=\"password\"\n                      value={confirmPassword}\n                      onChange={(e) => setConfirmPassword(e.target.value)}\n                    />\n                  </div>\n                  <Button onClick={handleUpdatePassword}>更新密码</Button>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            {/* 偏好设置 */}\n            <TabsContent value=\"preferences\" className=\"space-y-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Palette className=\"h-5 w-5\" />\n                    外观设置\n                  </CardTitle>\n                  <CardDescription>自定义界面主题和外观</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label>主题选择</Label>\n                    <Select value={theme} onValueChange={setTheme}>\n                      <SelectTrigger>\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"light\">浅色模式</SelectItem>\n                        <SelectItem value=\"dark\">深色模式</SelectItem>\n                        <SelectItem value=\"system\">跟随系统</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>语言设置</Label>\n                    <Select value={language} onValueChange={setLanguage}>\n                      <SelectTrigger>\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"zh-CN\">简体中文</SelectItem>\n                        <SelectItem value=\"en-US\">English</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Layout className=\"h-5 w-5\" />\n                    功能设置\n                  </CardTitle>\n                  <CardDescription>配置应用功能和行为</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"space-y-0.5\">\n                      <Label>自动保存</Label>\n                      <p className=\"text-sm text-muted-foreground\">编辑时自动保存文档</p>\n                    </div>\n                    <Switch checked={autoSave} onCheckedChange={setAutoSave} />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"space-y-0.5\">\n                      <Label>桌面通知</Label>\n                      <p className=\"text-sm text-muted-foreground\">接收重要事件的桌面通知</p>\n                    </div>\n                    <Switch checked={notifications} onCheckedChange={setNotifications} />\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n\n          </Tabs>\n        </div>\n      </main>\n      \n      {/* 连接恢复组件 */}\n      <ConnectionRecovery\n        show={showConnectionRecovery}\n        errorType=\"server\"\n        errorMessage={connectionError || undefined}\n        onRecovery={handleConnectionRecovery}\n        onClose={() => setShowConnectionRecovery(false)}\n        showDetailedStatus={true}\n      />\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\test-scrollbar\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'Code' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"Code"},"fix":{"range":[268,274],"text":""},"desc":"Remove unused variable 'Code'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'AlertTriangle' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":51,"suggestions":[{"messageId":"removeVar","data":{"varName":"AlertTriangle"},"fix":{"range":[274,289],"text":""},"desc":"Remove unused variable 'AlertTriangle'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'HelpCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":63,"suggestions":[{"messageId":"removeVar","data":{"varName":"HelpCircle"},"fix":{"range":[289,301],"text":""},"desc":"Remove unused variable 'HelpCircle'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Clock' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":65,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":70,"suggestions":[{"messageId":"removeVar","data":{"varName":"Clock"},"fix":{"range":[301,308],"text":""},"desc":"Remove unused variable 'Clock'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'messageId' is defined but never used. Allowed unused args must match /^_/u.","line":89,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":89,"endColumn":38,"suggestions":[{"messageId":"removeVar","data":{"varName":"messageId"},"fix":{"range":[4145,4162],"text":""},"desc":"Remove unused variable 'messageId'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused args must match /^_/u.","line":172,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":172,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"e"},"fix":{"range":[7157,7176],"text":""},"desc":"Remove unused variable 'e'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useRef, useEffect, useMemo, useCallback } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Card } from '@/components/ui/card'\r\nimport { ArrowLeft, Bot, User, Code, AlertTriangle, HelpCircle, Clock, Calendar } from 'lucide-react'\r\nimport Link from 'next/link'\r\n\r\n// 模拟消息类型\r\ninterface TestMessage {\r\n  id: string\r\n  role: 'user' | 'assistant'\r\n  content: string\r\n  timestamp: number\r\n}\r\n\r\n// 时间轴数据点\r\ninterface TimelinePoint {\r\n  messageId: string\r\n  index: number\r\n  percentage: number\r\n  timestamp: number\r\n  date: Date\r\n  isAIMessage: boolean\r\n}\r\n\r\n// 生成模拟对话数据 - 支持不同数量测试\r\nconst generateTestMessages = (count: number = 120): TestMessage[] => {\r\n  const messages: TestMessage[] = []\r\n  const baseTime = Date.now() - 24 * 60 * 60 * 1000 // 24小时前开始\r\n  \r\n  const sampleContents = [\r\n    { role: 'user', content: '你好，我想了解一下React hooks的使用？' },\r\n    { role: 'assistant', content: 'React hooks是React 16.8引入的新特性，它允许你在函数组件中使用state和其他React特性。最常用的hooks包括useState、useEffect、useContext等。' },\r\n    { role: 'user', content: '能给我一个useState的例子吗？' },\r\n    { role: 'assistant', content: '当然可以！这是一个简单的计数器例子：\\n\\n```jsx\\nimport React, { useState } from \\'react\\';\\n\\nfunction Counter() {\\n  const [count, setCount] = useState(0);\\n  \\n  return (\\n    <div>\\n      <p>你点击了 {count} 次</p>\\n      <button onClick={() => setCount(count + 1)}>\\n        点击我\\n      </button>\\n    </div>\\n  );\\n}\\n```' },\r\n    { role: 'user', content: '这个例子很清楚！那useEffect是做什么的？' },\r\n    { role: 'assistant', content: 'useEffect hook用于在函数组件中执行副作用操作，比如数据获取、订阅或手动更改React组件的DOM。它相当于类组件中的componentDidMount、componentDidUpdate和componentWillUnmount的组合。' },\r\n    { role: 'user', content: '有时候我的useEffect会无限循环，这是为什么？' },\r\n    { role: 'assistant', content: '无限循环通常是由于依赖数组配置不当引起的。如果你在useEffect内部修改了依赖数组中的值，就会导致无限循环。' },\r\n    { role: 'user', content: '能举个具体的错误例子吗？' },\r\n    { role: 'assistant', content: '这是一个会导致无限循环的错误示例：\\n\\n```jsx\\n// ❌ 错误示例\\nconst [data, setData] = useState([]);\\nuseEffect(() => {\\n  setData([...data, \\'new item\\']);\\n}, [data]);\\n```' },\r\n    { role: 'user', content: '原来如此！那如何在useEffect中获取数据？' },\r\n    { role: 'assistant', content: '在useEffect中获取数据是很常见的操作。由于useEffect不能直接是async函数，我们需要在内部定义异步函数。' },\r\n    { role: 'user', content: '非常有帮助！还有其他重要的hooks吗？' },\r\n    { role: 'assistant', content: '是的，还有很多有用的hooks：useContext、useReducer、useCallback、useMemo、useRef、useLayoutEffect等。' },\r\n    { role: 'user', content: '我想深入学习useReducer，它什么时候比useState更好？' },\r\n    { role: 'assistant', content: 'useReducer在复杂状态逻辑、状态转换依赖于之前的状态等情况下比useState更适合。' },\r\n    { role: 'user', content: '能给我看看useContext的使用场景吗？' },\r\n    { role: 'assistant', content: 'useContext主要用于跨组件共享状态，避免props drilling问题。它让你可以在任何子组件中直接访问上层提供的状态。' },\r\n    { role: 'user', content: '什么是props drilling？' },\r\n    { role: 'assistant', content: 'Props drilling是指为了将数据传递给深层嵌套的子组件，需要通过多个中间组件一层层传递props的现象。' },\r\n    { role: 'user', content: '那useCallback和useMemo有什么区别？' },\r\n    { role: 'assistant', content: 'useCallback缓存函数引用，useMemo缓存计算结果。useCallback返回函数，useMemo返回值。' },\r\n    { role: 'user', content: '什么时候需要使用useRef？' },\r\n    { role: 'assistant', content: 'useRef用于访问DOM元素、保存可变值而不触发重新渲染、或在函数组件中保存实例变量。' },\r\n    { role: 'user', content: 'useLayoutEffect和useEffect有什么不同？' },\r\n    { role: 'assistant', content: 'useLayoutEffect在DOM更新后、浏览器绘制前同步执行，而useEffect在绘制后异步执行。' }\r\n  ]\r\n  \r\n  // 生成指定数量的消息\r\n  for (let i = 0; i < count; i++) {\r\n    const template = sampleContents[i % sampleContents.length]\r\n    const variation = Math.floor(i / sampleContents.length)\r\n    \r\n    messages.push({\r\n      id: `msg-${i}`,\r\n      role: template.role as 'user' | 'assistant',\r\n      content: variation > 0 \r\n        ? `${template.content} (第${variation + 1}轮对话)` \r\n        : template.content,\r\n      timestamp: baseTime + (i * 5 * 60 * 1000) // 每5分钟一条消息\r\n    })\r\n  }\r\n  \r\n  return messages\r\n}\r\n\r\n// 时间轴滚动条组件\r\n// 判断是否为AI消息（移到组件外部）\r\nconst isAIMessage = (message: TestMessage): boolean => {\r\n  return message.role === 'assistant'\r\n}\r\n\r\nconst TimelineScrollbar: React.FC<{\r\n  messages: TestMessage[]\r\n  currentMessageId?: string\r\n  onJumpToMessage: (messageId: string) => void\r\n  containerHeight: number\r\n}> = ({ messages, currentMessageId, onJumpToMessage, containerHeight }) => {\r\n  const [hoverPosition, setHoverPosition] = useState<number | null>(null)\r\n  const [hoverMessage, setHoverMessage] = useState<TestMessage | null>(null)\r\n  \r\n  // 智能采样策略 - 动态密度控制\r\n  const timelineData = useMemo((): TimelinePoint[] => {\r\n    if (messages.length === 0) return []\r\n    \r\n    const firstTime = messages[0].timestamp\r\n    const lastTime = messages[messages.length - 1].timestamp\r\n    const totalDuration = lastTime - firstTime\r\n    \r\n    // 根据消息数量决定采样策略\r\n    let samplesToShow: TestMessage[] = []\r\n    \r\n    if (messages.length < 50) {\r\n      // < 50条：显示所有圆点\r\n      samplesToShow = messages\r\n    } else if (messages.length <= 100) {\r\n      // 50-100条：每2条显示1个圆点\r\n      samplesToShow = messages.filter((_, index) => index % 2 === 0)\r\n    } else {\r\n      // > 100条：按时间段分组显示 (每10条取1个代表)\r\n      const step = Math.max(1, Math.floor(messages.length / 20)) // 最多显示20个代表点\r\n      samplesToShow = messages.filter((_, index) => index % step === 0)\r\n      \r\n      // 确保包含最后一条消息\r\n      if (samplesToShow[samplesToShow.length - 1]?.id !== messages[messages.length - 1]?.id) {\r\n        samplesToShow.push(messages[messages.length - 1])\r\n      }\r\n    }\r\n    \r\n    return samplesToShow.map((message) => {\r\n      const originalIndex = messages.findIndex(m => m.id === message.id)\r\n      const relativeTime = message.timestamp - firstTime\r\n      const percentage = totalDuration > 0 ? (relativeTime / totalDuration) * 100 : 0\r\n      \r\n      return {\r\n        messageId: message.id,\r\n        index: originalIndex,\r\n        percentage,\r\n        timestamp: message.timestamp,\r\n        date: new Date(message.timestamp),\r\n        isAIMessage: isAIMessage(message)\r\n      }\r\n    })\r\n  }, [messages])\r\n  \r\n  // 优化双色系统 - 保持协调的适度对比\r\n  const getMessageColor = (message: TestMessage, isActive: boolean) => {\r\n    if (isActive) return 'bg-orange-500 shadow-2xl ring-4 ring-orange-200 scale-125'\r\n    \r\n    if (message.role === 'assistant') {\r\n      // AI消息：饱和蓝色 - 保持项目主色调\r\n      return 'bg-blue-500 hover:bg-blue-600 hover:shadow-lg shadow-sm'\r\n    } else {\r\n      // 用户消息：温和灰色 - 与蓝色形成平衡对比\r\n      return 'bg-gray-500 hover:bg-gray-600 hover:shadow-lg shadow-sm'\r\n    }\r\n  }\r\n  \r\n  // 处理鼠标悬停\r\n  const handleMouseMove = (e: React.MouseEvent) => {\r\n    const rect = e.currentTarget.getBoundingClientRect()\r\n    const hoverY = e.clientY - rect.top\r\n    const percentage = (hoverY / rect.height) * 100\r\n    \r\n    setHoverPosition(percentage)\r\n    \r\n    // 找到最接近的消息\r\n    const closestPoint = timelineData.reduce((closest, current) => {\r\n      const currentDiff = Math.abs(current.percentage - percentage)\r\n      const closestDiff = Math.abs(closest.percentage - percentage)\r\n      return currentDiff < closestDiff ? current : closest\r\n    })\r\n    \r\n    const message = messages.find(m => m.id === closestPoint.messageId)\r\n    setHoverMessage(message || null)\r\n  }\r\n  \r\n  // 处理点击跳转\r\n  const handleClick = (e: React.MouseEvent) => {\r\n    if (hoverMessage) {\r\n      onJumpToMessage(hoverMessage.id)\r\n    }\r\n  }\r\n  \r\n  return (\r\n    <div className=\"relative w-8 flex items-center justify-center\">\r\n      {/* 透明轨道 - 只用于事件处理 */}\r\n      <div\r\n        className=\"relative w-6 cursor-pointer transition-all duration-200\"\r\n        style={{ height: `${containerHeight - 40}px` }}\r\n        onMouseMove={handleMouseMove}\r\n        onMouseLeave={() => {\r\n          setHoverPosition(null)\r\n          setHoverMessage(null)\r\n        }}\r\n        onClick={handleClick}\r\n      >\r\n        {/* 细线连接点 - 项目主题色 */}\r\n        <div className=\"absolute left-1/2 top-0 w-px h-full bg-border opacity-50 transform -translate-x-1/2\" />\r\n        \r\n        {/* 纯色圆点 */}\r\n        {timelineData.map((point) => {\r\n          const message = messages.find(m => m.id === point.messageId)!\r\n          const isActive = currentMessageId === point.messageId\r\n          \r\n          return (\r\n            <div\r\n              key={point.messageId}\r\n              className={`absolute rounded-full cursor-pointer transform -translate-x-1/2 transition-all duration-300 ${\r\n                getMessageColor(message, isActive)\r\n              } ${\r\n                isActive \r\n                  ? 'w-5 h-5 z-20 animate-pulse scale-110' \r\n                  : 'w-3 h-3 hover:w-4 hover:h-4 hover:z-10 hover:scale-110'\r\n              }`}\r\n              style={{\r\n                top: `${point.percentage}%`,\r\n                left: '50%'\r\n              }}\r\n              onClick={(e) => {\r\n                e.stopPropagation()\r\n                onJumpToMessage(point.messageId)\r\n              }}\r\n            >\r\n              {/* 激活状态的光环效果 */}\r\n              {isActive && (\r\n                <div className=\"absolute inset-0 rounded-full animate-ping bg-orange-400 opacity-50\" />\r\n              )}\r\n            </div>\r\n          )\r\n        })}\r\n        \r\n        {/* 悬停提示 - 显示在左侧避免遮挡 */}\r\n        {hoverPosition !== null && hoverMessage && (\r\n          <div\r\n            className=\"absolute right-6 bg-popover border border-border text-popover-foreground text-xs rounded-lg px-3 py-2 pointer-events-none z-20 shadow-lg\"\r\n            style={{\r\n              top: `${hoverPosition}%`,\r\n              transform: 'translateY(-50%)',\r\n              maxWidth: '200px'\r\n            }}\r\n          >\r\n            <div className=\"font-medium text-foreground\">\r\n              {new Date(hoverMessage.timestamp).toLocaleTimeString()}\r\n            </div>\r\n            <div className=\"text-muted-foreground mt-1 truncate\">\r\n              {hoverMessage.content.slice(0, 30)}...\r\n            </div>\r\n            \r\n            {/* 箭头指针 - 指向圆点 */}\r\n            <div \r\n              className=\"absolute top-1/2 -right-1 w-2 h-2 bg-popover border-r border-b border-border transform rotate-45 -translate-y-1/2\"\r\n            />\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// 消息组件\r\nconst MessageItem: React.FC<{\r\n  message: TestMessage\r\n  isActive?: boolean\r\n}> = ({ message, isActive }) => {\r\n  \r\n  return (\r\n    <div\r\n      data-message-id={message.id}\r\n      className={`mb-4 p-4 rounded-lg transition-all duration-300 ${\r\n        isActive \r\n          ? 'bg-blue-50 border-2 border-blue-300 shadow-lg scale-[1.02]' \r\n          : 'bg-white border border-gray-200 hover:shadow-md'\r\n      }`}\r\n    >\r\n      <div className=\"flex items-start gap-3\">\r\n        {/* 头像 */}\r\n        <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${\r\n          message.role === 'user' \r\n            ? 'bg-blue-500 text-white' \r\n            : 'bg-green-500 text-white'\r\n        }`}>\r\n          {message.role === 'user' ? <User className=\"w-4 h-4\" /> : <Bot className=\"w-4 h-4\" />}\r\n        </div>\r\n        \r\n        {/* 消息内容 */}\r\n        <div className=\"flex-1 min-w-0\">\r\n          <div className=\"flex items-center gap-2 mb-1\">\r\n            <span className=\"font-medium text-sm\">\r\n              {message.role === 'user' ? '用户' : 'AI助手'}\r\n            </span>\r\n            <span className=\"text-xs text-gray-500\">\r\n              {new Date(message.timestamp).toLocaleTimeString()}\r\n            </span>\r\n            {message.role === 'assistant' && (\r\n              <Badge variant=\"secondary\" className=\"text-xs text-green-600 bg-green-50\">\r\n                <Bot className=\"w-3 h-3\" />\r\n                <span className=\"ml-1\">AI回复</span>\r\n              </Badge>\r\n            )}\r\n          </div>\r\n          \r\n          {/* 内容 */}\r\n          <div className=\"text-sm text-gray-700 whitespace-pre-wrap\">\r\n            {message.content.includes('```') ? (\r\n              <div className=\"bg-gray-900 text-green-400 p-3 rounded text-xs font-mono overflow-x-auto\">\r\n                {message.content.replace(/```jsx?/g, '').replace(/```/g, '')}\r\n              </div>\r\n            ) : (\r\n              message.content\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// 主测试页面\r\nexport default function TestScrollbarPage() {\r\n  const [messageCount, setMessageCount] = useState<number>(120)\r\n  const [messages, setMessages] = useState<TestMessage[]>(() => generateTestMessages(120))\r\n  const [currentMessageId, setCurrentMessageId] = useState<string | null>(null)\r\n  const containerRef = useRef<HTMLDivElement>(null)\r\n  \r\n  // 切换消息数量进行测试\r\n  const handleChangeMessageCount = (count: number) => {\r\n    setMessageCount(count)\r\n    setMessages(generateTestMessages(count))\r\n    setCurrentMessageId(null)\r\n  }\r\n  \r\n  // 跳转到指定消息\r\n  const jumpToMessage = useCallback((messageId: string) => {\r\n    const element = containerRef.current?.querySelector(`[data-message-id=\"${messageId}\"]`)\r\n    if (element) {\r\n      element.scrollIntoView({\r\n        behavior: 'smooth',\r\n        block: 'center'\r\n      })\r\n      setCurrentMessageId(messageId)\r\n      \r\n      // 3秒后清除高亮\r\n      setTimeout(() => {\r\n        setCurrentMessageId(null)\r\n      }, 3000)\r\n    }\r\n  }, [])\r\n  \r\n  // 使用 Intersection Observer 追踪当前可见消息\r\n  useEffect(() => {\r\n    if (!containerRef.current) return\r\n\r\n    const observer = new IntersectionObserver(\r\n      (entries) => {\r\n        entries.forEach((entry) => {\r\n          if (entry.isIntersecting && entry.intersectionRatio > 0.5) {\r\n            const messageId = entry.target.getAttribute('data-message-id')\r\n            if (messageId) {\r\n              setCurrentMessageId(messageId)\r\n            }\r\n          }\r\n        })\r\n      },\r\n      {\r\n        root: containerRef.current,\r\n        rootMargin: '-30% 0px -30% 0px',\r\n        threshold: [0.3, 0.5, 0.7]\r\n      }\r\n    )\r\n\r\n    const messageElements = containerRef.current.querySelectorAll('[data-message-id]')\r\n    messageElements.forEach((el) => observer.observe(el))\r\n\r\n    return () => observer.disconnect()\r\n  }, [])\r\n  \r\n  return (\r\n    <div className=\"min-h-screen bg-background\">\r\n      {/* 头部 */}\r\n      <div className=\"bg-card border-b border p-4\">\r\n        <div className=\"max-w-6xl mx-auto flex items-center justify-between\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <Link href=\"/workspace\">\r\n              <Button variant=\"ghost\" size=\"sm\">\r\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\r\n                返回工作区\r\n              </Button>\r\n            </Link>\r\n            <div>\r\n              <h1 className=\"text-xl font-semibold\">优化配色智能圆点导航测试</h1>\r\n              <p className=\"text-sm text-muted-foreground\">\r\n                平衡配色 + 智能采样：蓝灰适度对比，橙色醒目高亮，保持视觉和谐的长对话导航\r\n              </p>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n              <Calendar className=\"w-4 h-4\" />\r\n              共 {messages.length} 条消息\r\n            </div>\r\n            \r\n            {/* 测试按钮组 */}\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"text-sm text-muted-foreground\">测试数量：</span>\r\n              {[30, 60, 120, 200].map(count => (\r\n                <Button \r\n                  key={count}\r\n                  variant={messageCount === count ? \"default\" : \"outline\"}\r\n                  size=\"sm\"\r\n                  onClick={() => handleChangeMessageCount(count)}\r\n                  className=\"text-xs\"\r\n                >\r\n                  {count}条\r\n                </Button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      {/* 说明区域 */}\r\n      <div className=\"max-w-6xl mx-auto p-4\">\r\n        <Card className=\"p-4 mb-4 bg-muted border\">\r\n          <h3 className=\"font-medium text-foreground mb-3\">🎨 优化配色智能圆点导航</h3>\r\n          <div className=\"text-sm text-muted-foreground space-y-2\">\r\n            <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3\">\r\n              <p className=\"font-medium text-blue-800 mb-1\">\r\n                当前状态：{messages.length} 条消息\r\n              </p>\r\n              <p className=\"text-xs text-blue-600\">\r\n                {messages.length < 50 && '显示策略：全部圆点（< 50条）'}\r\n                {messages.length >= 50 && messages.length <= 100 && '显示策略：每2条显示1个圆点（50-100条）'}\r\n                {messages.length > 100 && `显示策略：智能采样约${Math.floor(messages.length / Math.max(1, Math.floor(messages.length / 20)))}条显示1个圆点（> 100条）`}\r\n              </p>\r\n            </div>\r\n            \r\n            <p>• <strong>平衡配色时间轴</strong>：适度对比 + 微妙阴影增强视觉层次</p>\r\n            <div className=\"grid grid-cols-2 gap-6 mt-3\">\r\n              <div>\r\n                <p className=\"font-medium mb-2 text-foreground\">用户消息：</p>\r\n                <p>● <span className=\"inline-block w-3 h-3 bg-gray-500 rounded-full mr-2 shadow-sm\"></span>温和灰色圆点</p>\r\n              </div>\r\n              <div>\r\n                <p className=\"font-medium mb-2 text-foreground\">AI消息：</p>\r\n                <p>● <span className=\"inline-block w-3 h-3 bg-blue-500 rounded-full mr-2 shadow-sm\"></span>饱和蓝色圆点</p>\r\n              </div>\r\n            </div>\r\n            <p>• <strong className=\"text-orange-500\">橙色脉动</strong>：当前可见消息高亮显示</p>\r\n            <p>• <strong>悬停效果</strong>：圆点放大+阴影，显示时间和内容预览</p>\r\n            <p>• <strong>动态优化</strong>：长对话自动减少圆点密度，提升可用性</p>\r\n          </div>\r\n        </Card>\r\n      </div>\r\n      \r\n      {/* 主内容区域 */}\r\n      <div className=\"max-w-6xl mx-auto p-4\">\r\n        <div className=\"bg-card rounded-lg shadow-sm border overflow-hidden\">\r\n          <div className=\"flex h-[600px]\">\r\n            {/* 消息列表 */}\r\n            <div \r\n              ref={containerRef}\r\n              className=\"flex-1 overflow-y-auto p-4 scroll-smooth\"\r\n              style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}\r\n            >\r\n              <style jsx>{`\r\n                div::-webkit-scrollbar {\r\n                  display: none;\r\n                }\r\n              `}</style>\r\n              \r\n              {messages.map((message) => (\r\n                <MessageItem\r\n                  key={message.id}\r\n                  message={message}\r\n                  isActive={currentMessageId === message.id}\r\n                />\r\n              ))}\r\n            </div>\r\n            \r\n            {/* 时间轴滚动条 */}\r\n            <div className=\"bg-muted border-l border p-2\">\r\n              <TimelineScrollbar\r\n                messages={messages}\r\n                currentMessageId={currentMessageId}\r\n                onJumpToMessage={jumpToMessage}\r\n                containerHeight={600}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      {/* 底部统计 */}\r\n      <div className=\"max-w-6xl mx-auto p-4\">\r\n        <div className=\"bg-card rounded-lg border p-4\">\r\n          <h3 className=\"font-medium mb-3\">智能采样统计</h3>\r\n          <div className=\"grid grid-cols-4 gap-4 text-center\">\r\n            {(() => {\r\n              const totalMessages = messages.length\r\n              const userMessages = messages.filter(m => m.role === 'user').length\r\n              const aiMessages = messages.filter(m => m.role === 'assistant').length\r\n              \r\n              // 计算显示的圆点数量\r\n              let displayedDots = 0\r\n              if (totalMessages < 50) {\r\n                displayedDots = totalMessages\r\n              } else if (totalMessages <= 100) {\r\n                displayedDots = Math.ceil(totalMessages / 2)\r\n              } else {\r\n                const step = Math.max(1, Math.floor(totalMessages / 20))\r\n                displayedDots = Math.ceil(totalMessages / step)\r\n              }\r\n              \r\n              return [\r\n                { label: '总消息数', count: totalMessages, color: 'text-primary' },\r\n                { label: '用户消息', count: userMessages, color: 'text-muted-foreground' },\r\n                { label: 'AI回复', count: aiMessages, color: 'text-primary' },\r\n                { label: '显示圆点', count: displayedDots, color: 'text-green-600' },\r\n              ].map((stat) => (\r\n                <div key={stat.label} className=\"text-center\">\r\n                  <div className={`text-2xl font-bold ${stat.color}`}>{stat.count}</div>\r\n                  <div className=\"text-xs text-muted-foreground\">{stat.label}</div>\r\n                </div>\r\n              ))\r\n            })()}\r\n          </div>\r\n          \r\n          <div className=\"mt-4 p-3 bg-muted rounded-lg\">\r\n            <p className=\"text-sm text-muted-foreground text-center\">\r\n              {(() => {\r\n                const totalMessages = messages.length\r\n                if (totalMessages === 0) return '压缩比：0% • 节省空间：0%'\r\n                \r\n                let displayedDots = 0\r\n                if (totalMessages < 50) {\r\n                  displayedDots = totalMessages\r\n                } else if (totalMessages <= 100) {\r\n                  displayedDots = Math.ceil(totalMessages / 2)\r\n                } else {\r\n                  const step = Math.max(1, Math.floor(totalMessages / 20))\r\n                  displayedDots = Math.ceil(totalMessages / step)\r\n                }\r\n                \r\n                const compressionRatio = Math.round((displayedDots / totalMessages) * 100)\r\n                const spaceSaved = 100 - compressionRatio\r\n                \r\n                return `压缩比：${compressionRatio}% • 节省空间：${spaceSaved}%`\r\n              })()}\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\app\\workspace\\page.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'updateConversation' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":82,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateConversation"},"fix":{"range":[2475,2499],"text":""},"desc":"Remove unused variable 'updateConversation'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'updateConversationMessages' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":87,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateConversationMessages"},"fix":{"range":[2627,2659],"text":""},"desc":"Remove unused variable 'updateConversationMessages'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":93,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":93,"endColumn":14},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":123,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":123,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":155,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":155,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":187,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":187,"endColumn":15},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":198,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":198,"endColumn":15},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":416,"column":46,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[15402,15449],"text":"\n                                          将删除&quot;"},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[15402,15449],"text":"\n                                          将删除&ldquo;"},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[15402,15449],"text":"\n                                          将删除&#34;"},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[15402,15449],"text":"\n                                          将删除&rdquo;"},"desc":"Replace with `&rdquo;`."}]},{"ruleId":"react/no-unescaped-entities","severity":2,"message":"`\"` can be escaped with `&quot;`, `&ldquo;`, `&#34;`, `&rdquo;`.","line":416,"column":59,"nodeType":"JSXText","messageId":"unescapedEntityAlts","suggestions":[{"messageId":"replaceWithAlt","data":{"alt":"&quot;"},"fix":{"range":[15461,15505],"text":"&quot;\n                                          "},"desc":"Replace with `&quot;`."},{"messageId":"replaceWithAlt","data":{"alt":"&ldquo;"},"fix":{"range":[15461,15505],"text":"&ldquo;\n                                          "},"desc":"Replace with `&ldquo;`."},{"messageId":"replaceWithAlt","data":{"alt":"&#34;"},"fix":{"range":[15461,15505],"text":"&#34;\n                                          "},"desc":"Replace with `&#34;`."},{"messageId":"replaceWithAlt","data":{"alt":"&rdquo;"},"fix":{"range":[15461,15505],"text":"&rdquo;\n                                          "},"desc":"Replace with `&rdquo;`."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport type React from \"react\"\nimport { useState, useEffect } from \"react\"\nimport { useConversations } from \"@/hooks/use-conversations\"\nimport { useSafeLocalStorage } from \"@/hooks/use-safe-local-storage\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\"\nimport {\n  AlertDialog,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogCancel,\n  AlertDialogAction,\n} from \"@/components/ui/alert-dialog\"\nimport { toast } from \"@/hooks/use-toast\"\nimport { ChevronLeft, ChevronRight, MessageSquare, Plus, MoreHorizontal } from \"lucide-react\"\nimport dynamic from \"next/dynamic\"\nimport { ChatCenterSkeleton } from \"@/components/skeletons/chat-center-skeleton\"\nconst SmartChatCenterV2 = dynamic(\n  () => import(\"@/components/chat/smart-chat-center-v2-fixed\").then(m => m.SmartChatCenterV2),\n  { ssr: false, loading: () => <ChatCenterSkeleton /> }\n)\nimport { Header } from \"@/components/header\"\nimport { ALLOWED_MODELS, DEFAULT_MODEL } from \"@/lib/ai/models\"\nimport { WorkspaceSkeleton } from \"@/components/skeletons/workspace-skeleton\"\nimport { ConnectionStatus } from \"@/components/ui/connection-status\"\n\ninterface Message {\n  id: string\n  role: \"user\" | \"assistant\"\n  content: string\n  timestamp: number\n  tokens?: number\n}\n\ninterface Conversation {\n  id: string\n  title: string\n  messages: Message[]\n  model: string\n  createdAt: number\n  updatedAt: number\n}\n\nexport default function WorkspacePage() {\n  // 使用安全的localStorage hook\n  const defaultModelId = ALLOWED_MODELS.length > 0 ? ALLOWED_MODELS[0].id : DEFAULT_MODEL\n  const [selectedModel, setSelectedModel] = useSafeLocalStorage('lastSelectedModelId', defaultModelId)\n  const [sidebarCollapsed, setSidebarCollapsed] = useState(() => {\n    // 移动端默认折叠侧边栏\n    if (typeof window !== 'undefined') {\n      return window.innerWidth < 768\n    }\n    return false\n  })\n  \n  // 编辑状态管理\n  const [editingConvId, setEditingConvId] = useState<string | null>(null)\n  const [editTitle, setEditTitle] = useState('')\n\n\n  // 原有对话管理hooks - 保持操作功能\n  const {\n    conversations: fallbackConversations,\n    currentConversationId,\n    loading: fallbackLoading,\n    error: fallbackError,\n    loadingConversationId, // 获取加载中的对话ID\n    createConversation,\n    updateConversation,\n    updateConversationWithMessages, // 使用新的更新函数\n    deleteConversation,\n    setCurrentConversation,\n    getCurrentConversation,\n    updateConversationMessages,\n  } = useConversations()\n\n  // 使用传统对话数据\n  const conversations = fallbackConversations\n  const loading = fallbackLoading\n  const error = fallbackError\n  \n  // 获取当前对话\n  const currentConversation = getCurrentConversation()\n\n  // 基础性能监控\n  useEffect(() => {\n    if (!loading && conversations.length > 0) {\n      // 性能监控逻辑\n    }\n  }, [loading, conversations.length])\n  \n  // 确保始终有可用对话（页面加载完成后，如果没有对话就创建一个）\n  useEffect(() => {\n    if (!loading && conversations.length === 0 && !currentConversationId) {\n      createConversation(selectedModel)\n    }\n  }, [loading, conversations.length, currentConversationId, createConversation, selectedModel])\n\n  // 简化的对话管理函数\n  const handleCreateConversation = async () => {\n    try {\n      const newConversation = await createConversation(selectedModel)\n      if (newConversation) {\n        // 移动端创建对话后自动折叠侧边栏，专注聊天\n        if (typeof window !== 'undefined' && window.innerWidth < 768) {\n          setSidebarCollapsed(true)\n        }\n        }\n      return newConversation\n    } catch (error) {\n      return null\n    }\n  }\n\n  const handleUpdateConversation = (id: string, updates: Partial<Conversation>) => {\n    updateConversationWithMessages(id, updates) // 使用支持消息更新的函数\n  }\n\n  const handleDeleteConversation = (id: string) => {\n    deleteConversation(id)\n  }\n\n  const handleSelectConversation = (id: string) => {\n    setCurrentConversation(id)\n    // 移动端选择对话后自动折叠侧边栏\n    if (typeof window !== 'undefined' && window.innerWidth < 768) {\n      setSidebarCollapsed(true)\n    }\n  }\n\n  // 编辑功能处理函数\n  const handleStartEdit = (convId: string, currentTitle: string) => {\n    setEditingConvId(convId)\n    setEditTitle(currentTitle)\n  }\n\n  const handleSaveTitle = async () => {\n    if (editingConvId && editTitle.trim() !== '') {\n      try {\n        // 调用更新对话函数\n        await handleUpdateConversation(editingConvId, { title: editTitle.trim() })\n      } catch (error) {\n        // 错误处理\n      }\n    }\n    // 退出编辑状态\n    setEditingConvId(null)\n    setEditTitle('')\n  }\n\n  const handleCancelEdit = () => {\n    setEditingConvId(null)\n    setEditTitle('')\n  }\n\n  // 导出对话功能\n  const handleExportConversation = (conversation: Conversation) => {\n    try {\n      const data = JSON.stringify({ \n        id: conversation.id, \n        title: conversation.title, \n        messages: conversation.messages \n      }, null, 2)\n      const blob = new Blob([data], { type: 'application/json;charset=utf-8' })\n      const url = URL.createObjectURL(blob)\n      const a = document.createElement('a')\n      a.href = url\n      a.download = `${conversation.title || 'conversation'}.json`\n      document.body.appendChild(a)\n      a.click()\n      a.remove()\n      URL.revokeObjectURL(url)\n      toast({ title: '导出成功', description: '对话已导出为 JSON 文件。' })\n    } catch (e) {\n      toast({ title: '导出失败', description: '请稍后重试。' })\n    }\n  }\n\n  // 复制对话链接功能\n  const handleCopyConversationLink = async (conversation: Conversation) => {\n    try {\n      const url = `${window.location.origin}${window.location.pathname}?conversation=${conversation.id}`\n      await navigator.clipboard.writeText(url)\n      toast({ title: '已复制链接', description: '对话链接已复制到剪贴板。' })\n    } catch (e) {\n      toast({ title: '复制失败', description: '无法复制到剪贴板。' })\n    }\n  }\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter') {\n      e.preventDefault()\n      handleSaveTitle()\n    } else if (e.key === 'Escape') {\n      e.preventDefault()\n      handleCancelEdit()\n    }\n  }\n\n\n  // 响应式监听器 - 处理窗口大小变化\n  useEffect(() => {\n    const handleResize = () => {\n      // 在桌面端展开侧边栏，移动端折叠\n      if (window.innerWidth >= 768) {\n        setSidebarCollapsed(false)\n      } else {\n        setSidebarCollapsed(true)\n      }\n    }\n\n    window.addEventListener('resize', handleResize)\n    return () => window.removeEventListener('resize', handleResize)\n  }, [])\n\n\n  if (loading) {\n    return (\n      <div className=\"h-screen flex flex-col bg-background\">\n        <Header />\n        <WorkspaceSkeleton />\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col bg-background\">\n      <Header />\n      \n      {/* 连接状态指示器 - 工作区专用，调整位置避免与时间轴冲突 */}\n      <ConnectionStatus\n        position=\"fixed\"\n        size=\"sm\"\n        className=\"top-20 left-4 z-[45] md:left-auto md:right-4\"\n        animated={true}\n        showDetails={false}\n        autoHideWhenHealthy={false}\n      />\n\n      <div className=\"flex-1 flex overflow-hidden min-h-0 relative\">\n        {/* 移动端遮罩层 - 调整层级避免干扰组件交互 */}\n        {!sidebarCollapsed && (\n          <div\n            className=\"fixed inset-0 bg-black/50 z-[15] md:hidden\"\n            onClick={() => setSidebarCollapsed(true)}\n          />\n        )}\n\n        {/* 左侧对话历史侧边栏 */}\n        <div className={`bg-card border-r border-border flex flex-col min-h-0 z-20 transition-all duration-200 ${\n          sidebarCollapsed\n            ? 'w-0 overflow-hidden opacity-0'\n            : 'w-80 md:relative fixed left-0 top-0 h-full opacity-100'\n        }`}\n        style={{\n          transition: 'width 300ms cubic-bezier(0.4, 0, 0.2, 1), opacity 200ms ease-in-out'\n        }}>\n          {/* 侧边栏头部 - 固定高度 */}\n          <div className=\"flex-shrink-0 p-4 border-b border-border\">\n            <div className=\"flex items-center justify-between mb-3\">\n              <h2 className=\"font-semibold text-foreground\">对话历史</h2>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setSidebarCollapsed(true)}\n                className=\"h-8 w-8 p-0\"\n              >\n                <ChevronLeft className=\"h-4 w-4\" />\n              </Button>\n            </div>\n            {/* 新建对话按钮 */}\n            <Button\n              onClick={handleCreateConversation}\n              className=\"w-full gap-2 text-sm hover:bg-primary hover:text-primary-foreground transition-all duration-200\"\n              size=\"sm\"\n              disabled={loading}\n            >\n              <Plus className=\"h-4 w-4\" />\n              {loading ? '创建中...' : '新建对话'}\n            </Button>\n          </div>\n\n          {/* 对话列表 - 可滚动区域 */}\n          <div className=\"flex-1 overflow-y-auto p-2 min-h-0 scrollbar-hide\">\n            {conversations.length === 0 ? (\n              <div className=\"text-center text-muted-foreground py-8\">\n                <MessageSquare className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n                <p className=\"text-sm\">暂无对话历史</p>\n              </div>\n            ) : (\n              <div className=\"space-y-1\">\n                {conversations.map((conv) => (\n                  <div key={conv.id} className=\"relative\">\n                    {editingConvId === conv.id ? (\n                      // 编辑模式 - 增强的用户体验\n                      <div className=\"w-full p-3 bg-secondary rounded-md border border-primary/20 animate-in fade-in-0 duration-200\">\n                        <Input\n                          value={editTitle}\n                          onChange={(e) => setEditTitle(e.target.value)}\n                          onBlur={handleSaveTitle}\n                          onKeyDown={handleKeyDown}\n                          className=\"text-sm font-medium bg-transparent border-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-0 p-0 h-auto shadow-none\"\n                          autoFocus\n                          placeholder=\"输入对话标题...\"\n                          maxLength={50}\n                        />\n                        <div className=\"flex items-center justify-between mt-2\">\n                          <div className=\"text-xs text-muted-foreground\">\n                            回车保存 • ESC取消\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            {editTitle.length}/50\n                          </div>\n                        </div>\n                      </div>\n                    ) : (\n                      // 正常模式 - 重新设计避免按钮嵌套\n                      <div className=\"relative w-full group\">\n                        <div\n                          className={`w-full justify-start text-left h-auto p-3 transition-all duration-200 cursor-pointer rounded-md ${\n                            currentConversation?.id === conv.id \n                              ? 'bg-secondary ring-1 ring-primary/20 shadow-sm' \n                              : 'hover:bg-accent hover:shadow-sm'\n                          }`}\n                          onClick={() => handleSelectConversation(conv.id)}\n                          onDoubleClick={(e) => {\n                            e.preventDefault()\n                            e.stopPropagation()\n                            handleStartEdit(conv.id, conv.title)\n                          }}\n                          title=\"单击选择 • 双击编辑标题\"\n                        >\n                          <div className=\"flex items-center justify-between gap-2\">\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"font-medium truncate\">{conv.title}</div>\n                              <div className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                                {loadingConversationId === conv.id ? (\n                                  <>\n                                    <div className=\"w-3 h-3 border border-primary border-t-transparent rounded-full animate-spin\"></div>\n                                    加载中...\n                                  </>\n                                ) : (\n                                  <span>{conv.messages.length} 条消息</span>\n                                )}\n                              </div>\n                            </div>\n                            \n                            {/* 操作菜单 - hover时显示 */}\n                            <div className=\"opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center gap-1\">\n                              {/* 三点菜单 */}\n                              <DropdownMenu>\n                                <DropdownMenuTrigger asChild>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    className=\"h-6 w-6 p-0 hover:bg-accent\"\n                                    onClick={(e) => {\n                                      e.preventDefault()\n                                      e.stopPropagation()\n                                    }}\n                                  >\n                                    <MoreHorizontal className=\"h-3 w-3\" />\n                                  </Button>\n                                </DropdownMenuTrigger>\n                                <DropdownMenuContent\n                                  align=\"end\"\n                                  className=\"min-w-[10rem]\"\n                                  onClick={(e) => e.stopPropagation()}\n                                >\n                                  <DropdownMenuItem \n                                    onSelect={(e) => {\n                                      e.stopPropagation()\n                                      handleExportConversation(conv)\n                                    }}\n                                  >\n                                    导出对话\n                                  </DropdownMenuItem>\n                                  <DropdownMenuItem \n                                    onSelect={(e) => {\n                                      e.stopPropagation()\n                                      handleCopyConversationLink(conv)\n                                    }}\n                                  >\n                                    复制链接\n                                  </DropdownMenuItem>\n                                  <DropdownMenuSeparator />\n                                  <AlertDialog>\n                                    <AlertDialogTrigger asChild>\n                                      <DropdownMenuItem\n                                        className=\"text-destructive focus:text-destructive\"\n                                        onSelect={(e) => {\n                                          e.preventDefault()\n                                          e.stopPropagation()\n                                        }}\n                                      >\n                                        删除对话\n                                      </DropdownMenuItem>\n                                    </AlertDialogTrigger>\n                                    <AlertDialogContent onClick={(e) => e.stopPropagation()}>\n                                      <AlertDialogHeader>\n                                        <AlertDialogTitle>删除对话</AlertDialogTitle>\n                                        <AlertDialogDescription>\n                                          将删除\"{conv.title}\"\n                                          {conv.messages?.length ? `（${conv.messages.length} 条消息）` : ''}。\n                                          此操作不可撤销。\n                                        </AlertDialogDescription>\n                                      </AlertDialogHeader>\n                                      <AlertDialogFooter>\n                                        <AlertDialogCancel>取消</AlertDialogCancel>\n                                        <AlertDialogAction\n                                          className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                                          onClick={(e) => {\n                                            e.stopPropagation()\n                                            const msgCount = conv.messages?.length ?? 0\n                                            handleDeleteConversation(conv.id)\n                                            toast({\n                                              title: '已删除对话',\n                                              description: `\"${conv.title}\" 已删除（${msgCount} 条消息）。`,\n                                            })\n                                          }}\n                                        >\n                                          确认删除\n                                        </AlertDialogAction>\n                                      </AlertDialogFooter>\n                                    </AlertDialogContent>\n                                  </AlertDialog>\n                                </DropdownMenuContent>\n                              </DropdownMenu>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </div>\n\n        {/* 侧边栏折叠按钮 */}\n        {sidebarCollapsed && (\n          <div className=\"w-12 bg-card border-r border-border flex items-center justify-center\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setSidebarCollapsed(false)}\n              className=\"h-full w-full p-0\"\n            >\n              <ChevronRight className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        )}\n\n        {/* 主对话区域 - 具有明确高度约束和最大宽度 */}\n        <div className=\"flex-1 flex flex-col min-h-0 overflow-hidden\">\n          <div className=\"flex-1 flex justify-center px-4 md:px-6 min-h-0 overflow-hidden\">\n            <div className=\"w-full max-w-4xl lg:max-w-5xl xl:max-w-6xl 2xl:max-w-7xl flex flex-col h-full\">\n              <SmartChatCenterV2\n                data-testid=\"chat-center\"\n                conversation={currentConversation || undefined}\n                conversations={conversations}\n                selectedModel={selectedModel}\n                selectedText=\"\"\n                editorContextEnabled={false}\n                editorContent=\"\"\n                onUpdateConversation={handleUpdateConversation}\n                onCreateConversation={handleCreateConversation}\n                onDeleteConversation={handleDeleteConversation}\n                onSelectConversation={handleSelectConversation}\n                onSelectedModelChange={setSelectedModel}\n              />\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\admin\\admin-dashboard.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":79,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":79,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchStats'. Either include it or remove the dependency array.","line":106,"column":6,"nodeType":"ArrayExpression","endLine":106,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [fetchStats, timeRange]","fix":{"range":[2552,2563],"text":"[fetchStats, timeRange]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { ChartContainer, ChartTooltip, ChartTooltipContent } from \"@/components/ui/chart\"\nimport { Area, AreaChart, ResponsiveContainer, XAxis, YAxis, PieChart, Pie, Cell } from \"recharts\"\nimport { Users, MessageSquare, Activity, TrendingUp, Clock, Zap, AlertCircle } from \"lucide-react\"\n\ninterface AdminStats {\n  overview: {\n    totalUsers: number\n    activeUsers: number\n    totalSessions: number\n    totalTokensUsed: number\n    totalDocuments: number\n    totalApiCalls: number\n  }\n  usageTrend: Array<{\n    date: string\n    users: number\n    sessions: number\n    tokens: number\n    apiCalls: number\n  }>\n  userDistribution: Array<{\n    role: string\n    count: number\n    percentage: number\n  }>\n  featureUsage: Array<{\n    feature: string\n    usage: number\n    growth: string\n  }>\n  systemPerformance: {\n    avgResponseTime: string\n    uptime: string\n    errorRate: string\n    throughput: number\n  }\n}\n\nconst chartConfig = {\n  users: {\n    label: \"用户数\",\n    color: \"hsl(142, 76%, 36%)\",\n  },\n  sessions: {\n    label: \"会话数\",\n    color: \"hsl(142, 76%, 56%)\",\n  },\n  tokens: {\n    label: \"Token使用\",\n    color: \"hsl(142, 76%, 76%)\",\n  },\n  apiCalls: {\n    label: \"API调用\",\n    color: \"hsl(142, 76%, 86%)\",\n  },\n}\n\nconst COLORS = [\"hsl(142, 76%, 36%)\", \"hsl(142, 76%, 56%)\", \"hsl(142, 76%, 76%)\"]\n\nexport function AdminDashboard() {\n  const [stats, setStats] = useState<AdminStats | null>(null)\n  const [loading, setLoading] = useState(true)\n  const [timeRange, setTimeRange] = useState(\"7d\")\n\n  const fetchStats = async () => {\n    try {\n      setLoading(true)\n      const response = await fetch(`/api/admin/stats?timeRange=${timeRange}`)\n      const result = await response.json()\n\n      if (result.success) {\n        setStats(result.data)\n      }\n    } catch (error) {\n      setStats({\n        overview: {\n          totalUsers: 0,\n          activeUsers: 0,\n          totalSessions: 0,\n          totalTokensUsed: 0,\n          totalDocuments: 0,\n          totalApiCalls: 0,\n        },\n        usageTrend: [],\n        userDistribution: [],\n        featureUsage: [],\n        systemPerformance: {\n          avgResponseTime: \"0\",\n          uptime: \"0\",\n          errorRate: \"0\",\n          throughput: 0,\n        },\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    fetchStats()\n  }, [timeRange])\n\n  const formatNumber = (num: number): string => {\n    if (num >= 1000000) {\n      return `${(num / 1000000).toFixed(1)}M`\n    }\n    if (num >= 1000) {\n      return `${(num / 1000).toFixed(1)}K`\n    }\n    return num.toLocaleString()\n  }\n\n  if (loading || !stats) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-muted-foreground\">加载中...</div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* 时间范围选择 */}\n      <div className=\"flex justify-end\">\n        <Select value={timeRange} onValueChange={setTimeRange}>\n          <SelectTrigger className=\"w-32\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"1d\">今天</SelectItem>\n            <SelectItem value=\"7d\">7天</SelectItem>\n            <SelectItem value=\"30d\">30天</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* 概览统计 */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">总用户数</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{formatNumber(stats.overview?.totalUsers || 0)}</div>\n            <p className=\"text-xs text-muted-foreground\">活跃用户: {formatNumber(stats.overview?.activeUsers || 0)}</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">总会话数</CardTitle>\n            <MessageSquare className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{formatNumber(stats.overview?.totalSessions || 0)}</div>\n            <p className=\"text-xs text-muted-foreground\">API调用: {formatNumber(stats.overview?.totalApiCalls || 0)}</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Token使用量</CardTitle>\n            <Zap className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{formatNumber(stats.overview?.totalTokensUsed || 0)}</div>\n            <p className=\"text-xs text-muted-foreground\">文档数: {formatNumber(stats.overview?.totalDocuments || 0)}</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* 使用趋势图表 */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>使用趋势</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {stats.usageTrend && stats.usageTrend.length > 0 ? (\n              <ChartContainer config={chartConfig}>\n                <ResponsiveContainer width=\"100%\" height={300}>\n                  <AreaChart data={stats.usageTrend}>\n                    <XAxis dataKey=\"date\" tickLine={false} axisLine={false} tickMargin={8} />\n                    <YAxis tickLine={false} axisLine={false} tickMargin={8} tickFormatter={formatNumber} />\n                    <ChartTooltip cursor={false} content={<ChartTooltipContent indicator=\"dot\" />} />\n                    <Area\n                      dataKey=\"users\"\n                      type=\"natural\"\n                      fill={chartConfig.users.color}\n                      fillOpacity={0.4}\n                      stroke={chartConfig.users.color}\n                      stackId=\"a\"\n                    />\n                    <Area\n                      dataKey=\"sessions\"\n                      type=\"natural\"\n                      fill={chartConfig.sessions.color}\n                      fillOpacity={0.4}\n                      stroke={chartConfig.sessions.color}\n                      stackId=\"a\"\n                    />\n                  </AreaChart>\n                </ResponsiveContainer>\n              </ChartContainer>\n            ) : (\n              <div className=\"flex items-center justify-center h-[300px] text-muted-foreground\">暂无数据</div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>用户角色分布</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {stats.userDistribution && stats.userDistribution.length > 0 ? (\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <PieChart>\n                  <Pie\n                    data={stats.userDistribution}\n                    cx=\"50%\"\n                    cy=\"50%\"\n                    labelLine={false}\n                    label={({ role, percentage }) => `${role} ${percentage}%`}\n                    outerRadius={80}\n                    fill=\"#8884d8\"\n                    dataKey=\"count\"\n                  >\n                    {stats.userDistribution.map((entry, index) => (\n                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                    ))}\n                  </Pie>\n                  <ChartTooltip />\n                </PieChart>\n              </ResponsiveContainer>\n            ) : (\n              <div className=\"flex items-center justify-center h-[300px] text-muted-foreground\">暂无数据</div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* 功能使用统计和系统性能 */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>功能使用统计</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {stats.featureUsage && stats.featureUsage.length > 0 ? (\n                stats.featureUsage.map((feature) => (\n                  <div key={feature.feature} className=\"flex items-center justify-between\">\n                    <div>\n                      <div className=\"font-medium\">{feature.feature}</div>\n                      <div className=\"text-sm text-muted-foreground\">{formatNumber(feature.usage)} 次使用</div>\n                    </div>\n                    <div\n                      className={`text-sm font-medium ${Number.parseFloat(feature.growth) >= 0 ? \"text-green-600\" : \"text-red-600\"}`}\n                    >\n                      {Number.parseFloat(feature.growth) >= 0 ? \"+\" : \"\"}\n                      {feature.growth}%\n                    </div>\n                  </div>\n                ))\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">暂无功能使用数据</div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>系统性能</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>平均响应时间</span>\n                </div>\n                <span className=\"font-medium\">{stats.systemPerformance?.avgResponseTime || \"0\"}ms</span>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <Activity className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>系统正常运行时间</span>\n                </div>\n                <span className=\"font-medium\">{stats.systemPerformance?.uptime || \"0\"}%</span>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <AlertCircle className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>错误率</span>\n                </div>\n                <span className=\"font-medium\">{stats.systemPerformance?.errorRate || \"0\"}%</span>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                  <span>吞吐量</span>\n                </div>\n                <span className=\"font-medium\">{formatNumber(stats.systemPerformance?.throughput || 0)}/min</span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\admin\\admin-overview.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":40,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Users, Key, MessageSquare, FileText, Activity, RefreshCw } from \"lucide-react\"\n\ninterface SystemStats {\n  totalUsers: number\n  activeUsers: number\n  totalKeys: number\n  activeKeys: number\n  totalConversations: number\n  totalDocuments: number\n  systemStatus: \"healthy\" | \"warning\" | \"error\"\n  lastUpdated: string\n}\n\nexport function AdminOverview() {\n  const [stats, setStats] = useState<SystemStats | null>(null)\n  const [loading, setLoading] = useState(true)\n\n  const fetchStats = async () => {\n    try {\n      setLoading(true)\n      // 模拟API调用\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n\n      setStats({\n        totalUsers: 1247,\n        activeUsers: 892,\n        totalKeys: 156,\n        activeKeys: 134,\n        totalConversations: 8934,\n        totalDocuments: 2156,\n        systemStatus: \"healthy\",\n        lastUpdated: new Date().toLocaleString(\"zh-CN\"),\n      })\n    } catch (error) {\n      } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    fetchStats()\n  }, [])\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <RefreshCw className=\"h-6 w-6 animate-spin text-primary\" />\n        <span className=\"ml-2 text-muted-foreground\">加载中...</span>\n      </div>\n    )\n  }\n\n  if (!stats) {\n    return (\n      <div className=\"text-center py-12 text-muted-foreground\">\n        <p>数据加载失败</p>\n        <Button onClick={fetchStats} className=\"mt-4 bg-transparent\" variant=\"outline\">\n          重新加载\n        </Button>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* 系统状态 */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Activity className=\"h-5 w-5\" />\n                系统状态\n              </CardTitle>\n              <CardDescription>最后更新: {stats.lastUpdated}</CardDescription>\n            </div>\n            <Badge variant={stats.systemStatus === \"healthy\" ? \"default\" : \"destructive\"}>\n              {stats.systemStatus === \"healthy\" ? \"正常运行\" : \"异常\"}\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            <div className=\"flex items-center gap-3 p-4 bg-muted/30 rounded-lg\">\n              <div className=\"w-3 h-3 bg-green-500 rounded-full\"></div>\n              <div>\n                <p className=\"text-sm font-medium\">API服务</p>\n                <p className=\"text-xs text-muted-foreground\">正常</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-3 p-4 bg-muted/30 rounded-lg\">\n              <div className=\"w-3 h-3 bg-green-500 rounded-full\"></div>\n              <div>\n                <p className=\"text-sm font-medium\">数据库</p>\n                <p className=\"text-xs text-muted-foreground\">正常</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-3 p-4 bg-muted/30 rounded-lg\">\n              <div className=\"w-3 h-3 bg-green-500 rounded-full\"></div>\n              <div>\n                <p className=\"text-sm font-medium\">存储服务</p>\n                <p className=\"text-xs text-muted-foreground\">正常</p>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* 数据统计 */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-2 bg-primary/10 rounded-lg\">\n                <Users className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">总用户数</p>\n                <p className=\"text-2xl font-semibold\">{stats.totalUsers}</p>\n                <p className=\"text-xs text-muted-foreground\">活跃: {stats.activeUsers}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-2 bg-primary/10 rounded-lg\">\n                <Key className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">API密钥</p>\n                <p className=\"text-2xl font-semibold\">{stats.totalKeys}</p>\n                <p className=\"text-xs text-muted-foreground\">活跃: {stats.activeKeys}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-2 bg-primary/10 rounded-lg\">\n                <MessageSquare className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">对话总数</p>\n                <p className=\"text-2xl font-semibold\">{stats.totalConversations}</p>\n                <p className=\"text-xs text-muted-foreground\">本月新增</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"p-2 bg-primary/10 rounded-lg\">\n                <FileText className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">文档总数</p>\n                <p className=\"text-2xl font-semibold\">{stats.totalDocuments}</p>\n                <p className=\"text-xs text-muted-foreground\">已创建</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* 快速操作 */}\n      <Card>\n        <CardHeader>\n          <CardTitle>快速操作</CardTitle>\n          <CardDescription>常用管理功能</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <Button variant=\"outline\" className=\"h-auto p-4 flex flex-col gap-2 bg-transparent\">\n              <Users className=\"h-6 w-6\" />\n              <span>用户管理</span>\n              <span className=\"text-xs text-muted-foreground\">管理用户权限和状态</span>\n            </Button>\n            <Button variant=\"outline\" className=\"h-auto p-4 flex flex-col gap-2 bg-transparent\">\n              <Key className=\"h-6 w-6\" />\n              <span>密钥分发</span>\n              <span className=\"text-xs text-muted-foreground\">生成和管理API密钥</span>\n            </Button>\n            <Button variant=\"outline\" className=\"h-auto p-4 flex flex-col gap-2 bg-transparent\" onClick={fetchStats}>\n              <RefreshCw className=\"h-6 w-6\" />\n              <span>刷新数据</span>\n              <span className=\"text-xs text-muted-foreground\">更新系统统计信息</span>\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\admin\\key-management.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":70,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":70,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchKeys'. Either include it or remove the dependency array.","line":83,"column":6,"nodeType":"ArrayExpression","endLine":83,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchKeys]","fix":{"range":[2442,2444],"text":"[fetchKeys]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":287,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":287,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport type React from \"react\"\n\nimport { useState, useEffect } from \"react\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\"\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Label } from \"@/components/ui/label\"\nimport { Checkbox } from \"@/components/ui/checkbox\"\nimport { Key, Plus, Copy, Trash2, Eye, EyeOff } from \"lucide-react\"\nimport { useToast } from \"@/hooks/use-toast\"\n\ninterface ApiKey {\n  id: string\n  key: string\n  name: string\n  permissions: string[]\n  status: string\n  createdAt: string\n  expiresAt: string | null\n  maxUsage: number | null\n  currentUsage: number\n  lastUsedAt: string | null\n}\n\nexport function KeyManagement() {\n  const [keys, setKeys] = useState<ApiKey[]>([])\n  const [loading, setLoading] = useState(true)\n  const [showCreateDialog, setShowCreateDialog] = useState(false)\n  const [visibleKeys, setVisibleKeys] = useState<Set<string>>(new Set())\n  const { toast } = useToast()\n\n  const fetchKeys = async () => {\n    try {\n      setLoading(true)\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n\n      const mockKeys: ApiKey[] = [\n        {\n          id: \"1\",\n          key: \"sk-1234567890abcdef1234567890abcdef\",\n          name: \"生产环境密钥\",\n          permissions: [\"chat\", \"documents\"],\n          status: \"active\",\n          createdAt: \"2024-01-01T00:00:00Z\",\n          expiresAt: null,\n          maxUsage: null,\n          currentUsage: 1250,\n          lastUsedAt: \"2024-01-15T10:30:00Z\",\n        },\n        {\n          id: \"2\",\n          key: \"sk-abcdef1234567890abcdef1234567890\",\n          name: \"测试环境密钥\",\n          permissions: [\"chat\"],\n          status: \"active\",\n          createdAt: \"2024-01-10T00:00:00Z\",\n          expiresAt: \"2024-02-10T00:00:00Z\",\n          maxUsage: 1000,\n          currentUsage: 456,\n          lastUsedAt: \"2024-01-14T15:20:00Z\",\n        },\n      ]\n\n      setKeys(mockKeys)\n    } catch (error) {\n      toast({\n        title: \"获取密钥列表失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    fetchKeys()\n  }, [])\n\n  const formatDate = (dateString: string | null): string => {\n    if (!dateString) return \"无限制\"\n    return new Date(dateString).toLocaleString(\"zh-CN\")\n  }\n\n  const getStatusColor = (status: string): \"default\" | \"secondary\" | \"destructive\" => {\n    switch (status) {\n      case \"active\":\n        return \"default\"\n      case \"inactive\":\n        return \"secondary\"\n      case \"expired\":\n        return \"destructive\"\n      default:\n        return \"secondary\"\n    }\n  }\n\n  const getStatusText = (status: string): string => {\n    switch (status) {\n      case \"active\":\n        return \"活跃\"\n      case \"inactive\":\n        return \"非活跃\"\n      case \"expired\":\n        return \"已过期\"\n      default:\n        return \"未知\"\n    }\n  }\n\n  const copyToClipboard = (text: string) => {\n    navigator.clipboard.writeText(text)\n    toast({\n      title: \"复制成功\",\n      description: \"API密钥已复制到剪贴板\",\n    })\n  }\n\n  const toggleKeyVisibility = (keyId: string) => {\n    setVisibleKeys((prev) => {\n      const newSet = new Set(prev)\n      if (newSet.has(keyId)) {\n        newSet.delete(keyId)\n      } else {\n        newSet.add(keyId)\n      }\n      return newSet\n    })\n  }\n\n  const maskKey = (key: string): string => {\n    return `${key.substring(0, 8)}${\"*\".repeat(key.length - 12)}${key.substring(key.length - 4)}`\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Key className=\"h-5 w-5\" />\n              密钥管理\n            </CardTitle>\n            <CardDescription>生成和管理API访问密钥</CardDescription>\n          </div>\n          <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n            <DialogTrigger asChild>\n              <Button className=\"gap-2\">\n                <Plus className=\"h-4 w-4\" />\n                生成密钥\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>生成新的API密钥</DialogTitle>\n              </DialogHeader>\n              <CreateKeyForm\n                onSuccess={() => {\n                  setShowCreateDialog(false)\n                  fetchKeys()\n                }}\n              />\n            </DialogContent>\n          </Dialog>\n        </div>\n      </CardHeader>\n\n      <CardContent>\n        {loading ? (\n          <div className=\"flex items-center justify-center h-32\">\n            <div className=\"w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin\"></div>\n            <span className=\"ml-2 text-muted-foreground\">加载中...</span>\n          </div>\n        ) : (\n          <div className=\"border rounded-lg\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>密钥信息</TableHead>\n                  <TableHead>权限</TableHead>\n                  <TableHead>状态</TableHead>\n                  <TableHead>使用情况</TableHead>\n                  <TableHead>过期时间</TableHead>\n                  <TableHead>操作</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {keys.map((apiKey) => (\n                  <TableRow key={apiKey.id}>\n                    <TableCell>\n                      <div>\n                        <div className=\"font-medium\">{apiKey.name}</div>\n                        <div className=\"text-sm text-muted-foreground font-mono flex items-center gap-2\">\n                          {visibleKeys.has(apiKey.id) ? apiKey.key : maskKey(apiKey.key)}\n                          <Button variant=\"ghost\" size=\"sm\" onClick={() => toggleKeyVisibility(apiKey.id)}>\n                            {visibleKeys.has(apiKey.id) ? <EyeOff className=\"h-3 w-3\" /> : <Eye className=\"h-3 w-3\" />}\n                          </Button>\n                          <Button variant=\"ghost\" size=\"sm\" onClick={() => copyToClipboard(apiKey.key)}>\n                            <Copy className=\"h-3 w-3\" />\n                          </Button>\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {apiKey.permissions.slice(0, 2).map((permission) => (\n                          <Badge key={permission} variant=\"outline\" className=\"text-xs\">\n                            {permission}\n                          </Badge>\n                        ))}\n                        {apiKey.permissions.length > 2 && (\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            +{apiKey.permissions.length - 2}\n                          </Badge>\n                        )}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={getStatusColor(apiKey.status)}>{getStatusText(apiKey.status)}</Badge>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"text-sm\">\n                        <div>\n                          {apiKey.currentUsage.toLocaleString()} / {apiKey.maxUsage?.toLocaleString() || \"无限制\"}\n                        </div>\n                        <div className=\"text-muted-foreground\">\n                          {apiKey.lastUsedAt ? formatDate(apiKey.lastUsedAt) : \"从未使用\"}\n                        </div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"text-sm text-muted-foreground\">{formatDate(apiKey.expiresAt)}</div>\n                    </TableCell>\n                    <TableCell>\n                      <Button variant=\"ghost\" size=\"sm\">\n                        <Trash2 className=\"h-3 w-3\" />\n                      </Button>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </div>\n        )}\n\n        <div className=\"text-sm text-muted-foreground mt-4\">共 {keys.length} 个API密钥</div>\n      </CardContent>\n    </Card>\n  )\n}\n\nfunction CreateKeyForm({ onSuccess }: { onSuccess: () => void }) {\n  const [formData, setFormData] = useState({\n    name: \"\",\n    permissions: [] as string[],\n    expiresAt: \"\",\n    maxUsage: \"\",\n  })\n  const [loading, setLoading] = useState(false)\n  const { toast } = useToast()\n\n  const allPermissions = [\n    { id: \"chat\", label: \"AI对话\" },\n    { id: \"documents\", label: \"文档管理\" },\n    { id: \"trending\", label: \"热门数据\" },\n    { id: \"export\", label: \"数据导出\" },\n    { id: \"admin\", label: \"管理权限\" },\n  ]\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setLoading(true)\n\n    try {\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n\n      toast({\n        title: \"创建成功\",\n        description: \"API密钥已生成\",\n      })\n      onSuccess()\n    } catch (error) {\n      toast({\n        title: \"创建失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handlePermissionChange = (permissionId: string, checked: boolean) => {\n    setFormData((prev) => ({\n      ...prev,\n      permissions: checked ? [...prev.permissions, permissionId] : prev.permissions.filter((p) => p !== permissionId),\n    }))\n  }\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"name\">密钥名称</Label>\n        <Input\n          id=\"name\"\n          value={formData.name}\n          onChange={(e) => setFormData((prev) => ({ ...prev, name: e.target.value }))}\n          placeholder=\"为密钥起一个名称...\"\n          required\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label>权限</Label>\n        <div className=\"space-y-2\">\n          {allPermissions.map((permission) => (\n            <div key={permission.id} className=\"flex items-center space-x-2\">\n              <Checkbox\n                id={permission.id}\n                checked={formData.permissions.includes(permission.id)}\n                onCheckedChange={(checked) => handlePermissionChange(permission.id, checked as boolean)}\n              />\n              <Label htmlFor={permission.id}>{permission.label}</Label>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"expiresAt\">过期时间（可选）</Label>\n        <Input\n          id=\"expiresAt\"\n          type=\"datetime-local\"\n          value={formData.expiresAt}\n          onChange={(e) => setFormData((prev) => ({ ...prev, expiresAt: e.target.value }))}\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"maxUsage\">最大使用次数（可选）</Label>\n        <Input\n          id=\"maxUsage\"\n          type=\"number\"\n          value={formData.maxUsage}\n          onChange={(e) => setFormData((prev) => ({ ...prev, maxUsage: e.target.value }))}\n          placeholder=\"留空表示无限制\"\n        />\n      </div>\n\n      <div className=\"flex justify-end gap-2\">\n        <Button type=\"submit\" disabled={loading}>\n          {loading ? \"生成中...\" : \"生成密钥\"}\n        </Button>\n      </div>\n    </form>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\admin\\user-management.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":72,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchUsers'. Either include it or remove the dependency array.","line":85,"column":6,"nodeType":"ArrayExpression","endLine":85,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchUsers]","fix":{"range":[2584,2586],"text":"[fetchUsers]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":298,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":298,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport type React from \"react\"\n\nimport { useState, useEffect } from \"react\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\"\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Label } from \"@/components/ui/label\"\nimport { Checkbox } from \"@/components/ui/checkbox\"\nimport { Search, Plus, Edit, Trash2, Key, Users } from \"lucide-react\"\nimport { useToast } from \"@/hooks/use-toast\"\n\ninterface User {\n  id: string\n  username: string\n  email: string\n  role: string\n  status: string\n  permissions: string[]\n  createdAt: string\n  lastLoginAt: string | null\n  totalSessions: number\n  totalTokensUsed: number\n}\n\nexport function UserManagement() {\n  const [users, setUsers] = useState<User[]>([])\n  const [loading, setLoading] = useState(true)\n  const [searchTerm, setSearchTerm] = useState(\"\")\n  const [statusFilter, setStatusFilter] = useState(\"all\")\n  const [showCreateDialog, setShowCreateDialog] = useState(false)\n  const { toast } = useToast()\n\n  const fetchUsers = async () => {\n    try {\n      setLoading(true)\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n\n      const mockUsers: User[] = [\n        {\n          id: \"1\",\n          username: \"admin\",\n          email: \"admin@example.com\",\n          role: \"admin\",\n          status: \"active\",\n          permissions: [\"chat\", \"documents\", \"trending\", \"admin\"],\n          createdAt: \"2024-01-01T00:00:00Z\",\n          lastLoginAt: \"2024-01-15T10:30:00Z\",\n          totalSessions: 156,\n          totalTokensUsed: 45000,\n        },\n        {\n          id: \"2\",\n          username: \"user1\",\n          email: \"user1@example.com\",\n          role: \"user\",\n          status: \"active\",\n          permissions: [\"chat\", \"documents\"],\n          createdAt: \"2024-01-05T00:00:00Z\",\n          lastLoginAt: \"2024-01-14T15:20:00Z\",\n          totalSessions: 89,\n          totalTokensUsed: 12000,\n        },\n      ]\n\n      setUsers(mockUsers)\n    } catch (error) {\n      toast({\n        title: \"获取用户列表失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    fetchUsers()\n  }, [])\n\n  const filteredUsers = users.filter((user) => {\n    const matchesSearch =\n      user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      user.email.toLowerCase().includes(searchTerm.toLowerCase())\n    const matchesStatus = statusFilter === \"all\" || user.status === statusFilter\n    return matchesSearch && matchesStatus\n  })\n\n  const formatDate = (dateString: string | null): string => {\n    if (!dateString) return \"从未登录\"\n    return new Date(dateString).toLocaleString(\"zh-CN\")\n  }\n\n  const getStatusColor = (status: string): \"default\" | \"secondary\" | \"destructive\" => {\n    switch (status) {\n      case \"active\":\n        return \"default\"\n      case \"inactive\":\n        return \"secondary\"\n      case \"suspended\":\n        return \"destructive\"\n      default:\n        return \"secondary\"\n    }\n  }\n\n  const getStatusText = (status: string): string => {\n    switch (status) {\n      case \"active\":\n        return \"活跃\"\n      case \"inactive\":\n        return \"非活跃\"\n      case \"suspended\":\n        return \"已暂停\"\n      default:\n        return \"未知\"\n    }\n  }\n\n  const getRoleText = (role: string): string => {\n    switch (role) {\n      case \"admin\":\n        return \"管理员\"\n      case \"premium\":\n        return \"高级用户\"\n      case \"user\":\n        return \"普通用户\"\n      default:\n        return \"未知\"\n    }\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Users className=\"h-5 w-5\" />\n              用户管理\n            </CardTitle>\n            <CardDescription>管理系统用户和权限设置</CardDescription>\n          </div>\n          <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n            <DialogTrigger asChild>\n              <Button className=\"gap-2\">\n                <Plus className=\"h-4 w-4\" />\n                添加用户\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>创建新用户</DialogTitle>\n              </DialogHeader>\n              <CreateUserForm\n                onSuccess={() => {\n                  setShowCreateDialog(false)\n                  fetchUsers()\n                }}\n              />\n            </DialogContent>\n          </Dialog>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {/* 搜索和筛选 */}\n        <div className=\"flex gap-4\">\n          <div className=\"flex-1\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"搜索用户名或邮箱...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n          </div>\n          <Select value={statusFilter} onValueChange={setStatusFilter}>\n            <SelectTrigger className=\"w-32\">\n              <SelectValue placeholder=\"状态\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">全部状态</SelectItem>\n              <SelectItem value=\"active\">活跃</SelectItem>\n              <SelectItem value=\"inactive\">非活跃</SelectItem>\n              <SelectItem value=\"suspended\">已暂停</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        {/* 用户表格 */}\n        {loading ? (\n          <div className=\"flex items-center justify-center h-32\">\n            <div className=\"w-6 h-6 border-2 border-primary border-t-transparent rounded-full animate-spin\"></div>\n            <span className=\"ml-2 text-muted-foreground\">加载中...</span>\n          </div>\n        ) : (\n          <div className=\"border rounded-lg\">\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>用户信息</TableHead>\n                  <TableHead>角色</TableHead>\n                  <TableHead>状态</TableHead>\n                  <TableHead>使用统计</TableHead>\n                  <TableHead>最后登录</TableHead>\n                  <TableHead>操作</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredUsers.map((user) => (\n                  <TableRow key={user.id}>\n                    <TableCell>\n                      <div>\n                        <div className=\"font-medium\">{user.username}</div>\n                        <div className=\"text-sm text-muted-foreground\">{user.email}</div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant=\"outline\">{getRoleText(user.role)}</Badge>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={getStatusColor(user.status)}>{getStatusText(user.status)}</Badge>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"text-sm\">\n                        <div>会话: {user.totalSessions}</div>\n                        <div className=\"text-muted-foreground\">Token: {user.totalTokensUsed.toLocaleString()}</div>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"text-sm text-muted-foreground\">{formatDate(user.lastLoginAt)}</div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex gap-1\">\n                        <Button variant=\"ghost\" size=\"sm\">\n                          <Edit className=\"h-3 w-3\" />\n                        </Button>\n                        <Button variant=\"ghost\" size=\"sm\">\n                          <Key className=\"h-3 w-3\" />\n                        </Button>\n                        <Button variant=\"ghost\" size=\"sm\">\n                          <Trash2 className=\"h-3 w-3\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </div>\n        )}\n\n        <div className=\"text-sm text-muted-foreground\">显示 {filteredUsers.length} 个用户</div>\n      </CardContent>\n    </Card>\n  )\n}\n\nfunction CreateUserForm({ onSuccess }: { onSuccess: () => void }) {\n  const [formData, setFormData] = useState({\n    username: \"\",\n    email: \"\",\n    role: \"user\",\n    permissions: [] as string[],\n  })\n  const [loading, setLoading] = useState(false)\n  const { toast } = useToast()\n\n  const allPermissions = [\n    { id: \"chat\", label: \"AI对话\" },\n    { id: \"documents\", label: \"文档管理\" },\n    { id: \"trending\", label: \"热门数据\" },\n    { id: \"export\", label: \"数据导出\" },\n    { id: \"admin\", label: \"管理权限\" },\n  ]\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setLoading(true)\n\n    try {\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n\n      toast({\n        title: \"创建成功\",\n        description: \"用户已创建\",\n      })\n      onSuccess()\n    } catch (error) {\n      toast({\n        title: \"创建失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const handlePermissionChange = (permissionId: string, checked: boolean) => {\n    setFormData((prev) => ({\n      ...prev,\n      permissions: checked ? [...prev.permissions, permissionId] : prev.permissions.filter((p) => p !== permissionId),\n    }))\n  }\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"username\">用户名</Label>\n        <Input\n          id=\"username\"\n          value={formData.username}\n          onChange={(e) => setFormData((prev) => ({ ...prev, username: e.target.value }))}\n          required\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"email\">邮箱</Label>\n        <Input\n          id=\"email\"\n          type=\"email\"\n          value={formData.email}\n          onChange={(e) => setFormData((prev) => ({ ...prev, email: e.target.value }))}\n          required\n        />\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"role\">角色</Label>\n        <Select value={formData.role} onValueChange={(value) => setFormData((prev) => ({ ...prev, role: value }))}>\n          <SelectTrigger>\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"user\">普通用户</SelectItem>\n            <SelectItem value=\"premium\">高级用户</SelectItem>\n            <SelectItem value=\"admin\">管理员</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label>权限</Label>\n        <div className=\"space-y-2\">\n          {allPermissions.map((permission) => (\n            <div key={permission.id} className=\"flex items-center space-x-2\">\n              <Checkbox\n                id={permission.id}\n                checked={formData.permissions.includes(permission.id)}\n                onCheckedChange={(checked) => handlePermissionChange(permission.id, checked as boolean)}\n              />\n              <Label htmlFor={permission.id}>{permission.label}</Label>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"flex justify-end gap-2\">\n        <Button type=\"submit\" disabled={loading}>\n          {loading ? \"创建中...\" : \"创建用户\"}\n        </Button>\n      </div>\n    </form>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\auth\\invite-code-auth.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'Separator' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"Separator"},"fix":{"range":[462,515],"text":""},"desc":"Remove unused variable 'Separator'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Github' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":44,"suggestions":[{"messageId":"removeVar","data":{"varName":"Github"},"fix":{"range":[631,639],"text":""},"desc":"Remove unused variable 'Github'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":126,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":126,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'startedRedirect' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":174,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":174,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState } from 'react'\nimport Link from 'next/link'\nimport { signIn } from 'next-auth/react'\nimport { useRouter } from 'next/navigation'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\nimport { Separator } from '@/components/ui/separator'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { Loader2, User, CheckCircle, Github, LogIn, UserPlus } from 'lucide-react'\nimport { RouteTransitionOverlay } from '@/components/ui/route-transition-overlay'\n\ninterface InviteCodeVerification {\n  id: string\n  code: string\n  description: string | null\n  defaultRole: string\n  monthlyTokenLimit: number\n  remainingUses: number\n  expiresAt: string | null\n}\n\nexport function InviteCodeAuth() {\n  // 主模式切换：登录 or 注册\n  const [authMode, setAuthMode] = useState<'login' | 'register'>('login')\n  \n  // 注册流程状态\n  const [step, setStep] = useState<'verify' | 'register'>('verify')\n  const [inviteCode, setInviteCode] = useState('')\n  const [verifiedInvite, setVerifiedInvite] = useState<InviteCodeVerification | null>(null)\n  const [isVerifying, setIsVerifying] = useState(false)\n  const [verifyError, setVerifyError] = useState<string | null>(null)\n  \n  // 通用状态\n  const [error, setError] = useState<string | null>(null)\n  const [isLoading, setIsLoading] = useState(false)\n  const [redirecting, setRedirecting] = useState(false)\n  const router = useRouter()\n\n  // 登录信息\n  const [loginEmail, setLoginEmail] = useState('')\n  \n  // 注册信息\n  const [email, setEmail] = useState('')\n  const [username, setUsername] = useState('')\n  const [displayName, setDisplayName] = useState('')\n\n  // 已注册用户登录\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault()\n    \n    if (!loginEmail.trim()) {\n      setError('请输入邮箱地址')\n      return\n    }\n\n    setError(null)\n    setIsLoading(true)\n    let startedRedirect = false\n\n    try {\n      // 安全检查：确保开发登录码已正确配置\n      const devLoginCode = process.env.NEXT_PUBLIC_DEV_LOGIN_CODE\n      if (!devLoginCode) {\n        setError('开发环境登录码未配置，请联系管理员')\n        return\n      }\n\n      const result = await signIn('credentials', {\n        email: loginEmail.trim(),\n        code: devLoginCode,\n        redirect: false,\n      })\n\n      if (result?.error) {\n        setError('登录失败：' + result.error)\n      } else {\n        // 登录成功，使用 App Router 导航并显示过渡遮罩\n        setRedirecting(true)\n        startedRedirect = true\n        // 确保会话状态即时可见（如遇延迟问题可移除此调用）\n        try { router.refresh() } catch {}\n        router.replace('/workspace')\n        return\n      }\n    } catch (err: any) {\n      setError('登录失败：' + (err.message || '网络错误'))\n    } finally {\n      if (!startedRedirect) setIsLoading(false)\n    }\n  }\n\n  // 验证邀请码\n  const handleVerifyCode = async (e: React.FormEvent) => {\n    e.preventDefault()\n    \n    if (!inviteCode.trim()) {\n      setVerifyError('请输入邀请码')\n      return\n    }\n    \n    setIsVerifying(true)\n    setVerifyError(null)\n    \n    try {\n      const response = await fetch('/api/invite-codes/verify', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ code: inviteCode.trim().toUpperCase() })\n      })\n      \n      const data = await response.json()\n      \n      if (data.success) {\n        setVerifiedInvite(data.data)\n        setStep('register')\n      } else {\n        setVerifyError(data.error || '邀请码验证失败')\n      }\n    } catch (error) {\n      setVerifyError('网络错误，请重试')\n    } finally {\n      setIsVerifying(false)\n    }\n  }\n\n  // 注册用户\n  const handleRegister = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!email.trim()) {\n      return\n    }\n\n    setError(null)\n    setIsLoading(true)\n    try {\n      // 先调用后端注册接口\n      const res = await fetch('/api/invite-codes/register', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          inviteCode: inviteCode.trim(),\n          email: email.trim(),\n          username: username.trim() || undefined,\n          displayName: displayName.trim() || undefined,\n        })\n      })\n      const data = await res.json()\n      if (!res.ok || !data?.success) {\n        setError(data?.error || '注册失败')\n        return\n      }\n\n      // 注册成功后，使用临时 Credentials 自动登录（开发期）\n      const login = await signIn('credentials', {\n        email: email.trim(),\n        code: process.env.NEXT_PUBLIC_DEV_LOGIN_CODE || 'dev-123456',\n        redirect: false,\n      })\n      if (login?.error) {\n        setError(login.error)\n        return\n      }\n\n      // 跳转工作台（使用 App Router 导航）\n      setRedirecting(true)\n      let startedRedirect = true\n      // 确保会话状态即时可见（如遇延迟问题可移除此调用）\n      try { router.refresh() } catch {}\n      router.replace('/workspace')\n      return\n    } catch (err: any) {\n      setError(err?.message || '注册失败')\n    } finally {\n      // 如果没有开始跳转，才恢复按钮状态\n      if (!redirecting) setIsLoading(false)\n    }\n  }\n\n  // 返回验证步骤\n  const handleBackToVerify = () => {\n    setStep('verify')\n    setVerifiedInvite(null)\n    setVerifyError(null)\n  }\n\n  // 切换认证模式时清理状态\n  const handleModeChange = (mode: 'login' | 'register') => {\n    setAuthMode(mode)\n    setError(null)\n    setVerifyError(null)\n    setLoginEmail('')\n    setEmail('')\n    setUsername('')\n    setDisplayName('')\n    setInviteCode('')\n    setVerifiedInvite(null)\n    setStep('verify')\n  }\n\n  // 渲染登录表单\n  const renderLoginForm = () => (\n    <form onSubmit={handleLogin} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"login-email\">邮箱地址</Label>\n        <Input\n          id=\"login-email\"\n          type=\"email\"\n          placeholder=\"请输入您的注册邮箱\"\n          value={loginEmail}\n          onChange={(e) => setLoginEmail(e.target.value)}\n          disabled={isLoading}\n          autoComplete=\"email\"\n        />\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertDescription>{error}</AlertDescription>\n        </Alert>\n      )}\n\n      <Button type=\"submit\" className=\"w-full\" disabled={isLoading || !loginEmail.trim()}>\n        {isLoading ? (\n          <>\n            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            登录中...\n          </>\n        ) : (\n          <>\n            <LogIn className=\"mr-2 h-4 w-4\" />\n            登录\n          </>\n        )}\n      </Button>\n\n      <div className=\"text-center text-xs text-muted-foreground\">\n        使用您注册时的邮箱地址登录\n      </div>\n    </form>\n  )\n\n  // 渲染注册邀请码验证表单\n  const renderInviteForm = () => (\n    <form onSubmit={handleVerifyCode} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"invite-code\">邀请码</Label>\n        <Input\n          id=\"invite-code\"\n          type=\"text\"\n          placeholder=\"例如：ZHIDIAN5DLX01\"\n          value={inviteCode}\n          onChange={(e) => setInviteCode(e.target.value)}\n          className=\"text-center font-mono tracking-wider\"\n          maxLength={20}\n          disabled={isVerifying}\n        />\n      </div>\n\n      {verifyError && (\n        <Alert variant=\"destructive\">\n          <AlertDescription>{verifyError}</AlertDescription>\n        </Alert>\n      )}\n\n      {/* 开发环境显示测试邀请码 */}\n      {process.env.NODE_ENV === 'development' && (\n        <div className=\"p-3 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg\">\n          <div className=\"text-sm font-medium text-blue-800 dark:text-blue-200 mb-1\">\n            开发测试用邀请码：\n          </div>\n          <div className=\"text-xs text-blue-700 dark:text-blue-300 font-mono\">\n            ZHIDIAN5DLX01\n          </div>\n          <button\n            type=\"button\"\n            className=\"text-xs text-blue-600 hover:text-blue-800 underline mt-1\"\n            onClick={() => setInviteCode('ZHIDIAN5DLX01')}\n          >\n            点击自动填入\n          </button>\n        </div>\n      )}\n\n      <Button type=\"submit\" className=\"w-full\" disabled={isVerifying || !inviteCode.trim()}>\n        {isVerifying ? (\n          <>\n            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            验证中...\n          </>\n        ) : (\n          <>\n            <CheckCircle className=\"mr-2 h-4 w-4\" />\n            验证邀请码\n          </>\n        )}\n      </Button>\n\n      <div className=\"text-center text-xs text-muted-foreground\">\n        还没有邀请码？请联系我们获取\n      </div>\n    </form>\n  )\n\n  // 渲染注册信息填写表单\n  const renderRegisterForm = () => (\n    <>\n      {verifiedInvite && (\n        <div className=\"mb-4 p-3 bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800 rounded-lg\">\n          <div className=\"flex items-center mb-2\">\n            <CheckCircle className=\"h-4 w-4 text-green-600 mr-2\" />\n            <span className=\"text-sm font-medium text-green-800 dark:text-green-200\">邀请码验证成功</span>\n          </div>\n          <div className=\"text-xs text-green-700 dark:text-green-300 space-y-1\">\n            <p>邀请码: <span className=\"font-mono\">{verifiedInvite.code}</span></p>\n            <p>月度配额: {verifiedInvite.monthlyTokenLimit.toLocaleString()} tokens</p>\n            {verifiedInvite.description && (\n              <p>说明: {verifiedInvite.description}</p>\n            )}\n          </div>\n        </div>\n      )}\n\n      <form onSubmit={handleRegister} className=\"space-y-4\">\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"email\">邮箱 *</Label>\n          <Input \n            id=\"email\" \n            type=\"email\" \n            placeholder=\"name@example.com\" \n            value={email} \n            onChange={(e) => setEmail(e.target.value)} \n            required \n            disabled={isLoading} \n            autoComplete=\"email\" \n          />\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"username\">用户名（可选）</Label>\n          <Input \n            id=\"username\" \n            type=\"text\" \n            placeholder=\"不超过20个字符\" \n            value={username} \n            onChange={(e) => setUsername(e.target.value)} \n            disabled={isLoading} \n            autoComplete=\"username\" \n            maxLength={20} \n          />\n        </div>\n\n        <div className=\"space-y-2\">\n          <Label htmlFor=\"displayName\">显示名称（可选）</Label>\n          <Input \n            id=\"displayName\" \n            type=\"text\" \n            placeholder=\"用于展示的昵称\" \n            value={displayName} \n            onChange={(e) => setDisplayName(e.target.value)} \n            disabled={isLoading} \n            maxLength={50} \n          />\n        </div>\n\n        {error && (\n          <Alert variant=\"destructive\">\n            <AlertDescription>{error}</AlertDescription>\n          </Alert>\n        )}\n\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2\">\n          <Button\n            type=\"button\"\n            variant=\"outline\"\n            className=\"w-full\"\n            onClick={handleBackToVerify}\n            disabled={isLoading}\n          >\n            返回\n          </Button>\n          <Button\n            type=\"submit\"\n            className=\"w-full\"\n            disabled={isLoading || !email.trim()}\n          >\n            {isLoading ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                创建中...\n              </>\n            ) : (\n              <>\n                <User className=\"mr-2 h-4 w-4\" />\n                创建账户\n              </>\n            )}\n          </Button>\n        </div>\n\n        <p className=\"text-[11px] text-muted-foreground text-center leading-relaxed\">\n          继续即表示你同意我们的\n          <Link href=\"/terms\" className=\"mx-1 underline underline-offset-4 hover:text-foreground\" prefetch={false}>\n            服务条款\n          </Link>\n          与\n          <Link href=\"/privacy\" className=\"ml-1 underline underline-offset-4 hover:text-foreground\" prefetch={false}>\n            隐私政策\n          </Link>\n        </p>\n      </form>\n    </>\n  )\n\n  return (\n    <>\n      <Card className=\"w-full\">\n        <CardHeader className=\"space-y-1\">\n          <CardTitle className=\"text-xl text-center\">支点有星辰</CardTitle>\n          <CardDescription className=\"text-center\">\n            {authMode === 'login' ? '欢迎回来，请登录您的账户' : '使用邀请码创建新账户'}\n          </CardDescription>\n        </CardHeader>\n\n        <CardContent>\n          <Tabs value={authMode} onValueChange={(value) => handleModeChange(value as 'login' | 'register')}>\n            <TabsList className=\"grid w-full grid-cols-2\">\n              <TabsTrigger value=\"login\">\n                <LogIn className=\"w-4 h-4 mr-1\" />\n                登录\n              </TabsTrigger>\n              <TabsTrigger value=\"register\">\n                <UserPlus className=\"w-4 h-4 mr-1\" />\n                注册\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"login\" className=\"mt-4\">\n              {renderLoginForm()}\n            </TabsContent>\n\n            <TabsContent value=\"register\" className=\"mt-4\">\n              {authMode === 'register' && step === 'verify' ? renderInviteForm() : renderRegisterForm()}\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n      </Card>\n      {redirecting && <RouteTransitionOverlay text=\"正在进入工作区...\" />}\n    </>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\chat\\chat-error-boundary.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used. Allowed unused args must match /^_/u.","line":13,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"error"},"fix":{"range":[283,296],"text":""},"desc":"Remove unused variable 'error'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'errorInfo' is defined but never used. Allowed unused args must match /^_/u.","line":13,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":54,"suggestions":[{"messageId":"removeVar","data":{"varName":"errorInfo"},"fix":{"range":[295,323],"text":""},"desc":"Remove unused variable 'errorInfo'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 聊天错误边界组件\r\n * 捕获和处理聊天组件中的错误\r\n */\r\n\r\nimport React, { Component, ReactNode } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { AlertTriangle, RefreshCw } from 'lucide-react'\r\n\r\ninterface Props {\r\n  children: ReactNode\r\n  fallback?: ReactNode\r\n  onError?: (error: Error, errorInfo: React.ErrorInfo) => void\r\n}\r\n\r\ninterface State {\r\n  hasError: boolean\r\n  error: Error | null\r\n  errorInfo: React.ErrorInfo | null\r\n}\r\n\r\nexport class ChatErrorBoundary extends Component<Props, State> {\r\n  constructor(props: Props) {\r\n    super(props)\r\n    this.state = {\r\n      hasError: false,\r\n      error: null,\r\n      errorInfo: null\r\n    }\r\n  }\r\n\r\n  static getDerivedStateFromError(error: Error): State {\r\n    return {\r\n      hasError: true,\r\n      error,\r\n      errorInfo: null\r\n    }\r\n  }\r\n\r\n  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {\r\n    this.setState({\r\n      error,\r\n      errorInfo\r\n    })\r\n\r\n    // 调用错误回调\r\n    this.props.onError?.(error, errorInfo)\r\n\r\n    // 错误上报\r\n    // 可以在这里添加错误上报服务\r\n    // errorReportingService.report(error, errorInfo)\r\n  }\r\n\r\n  handleRetry = () => {\r\n    this.setState({\r\n      hasError: false,\r\n      error: null,\r\n      errorInfo: null\r\n    })\r\n  }\r\n\r\n  render() {\r\n    if (this.state.hasError) {\r\n      // 如果提供了自定义 fallback，使用它\r\n      if (this.props.fallback) {\r\n        return this.props.fallback\r\n      }\r\n\r\n      // 默认错误 UI\r\n      return (\r\n        <div className=\"flex-1 flex items-center justify-center p-8\">\r\n          <div className=\"text-center max-w-md\">\r\n            <div className=\"w-16 h-16 bg-destructive/10 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n              <AlertTriangle className=\"w-8 h-8 text-destructive\" />\r\n            </div>\r\n            \r\n            <h2 className=\"text-xl font-semibold mb-2 text-destructive\">\r\n              聊天组件出现错误\r\n            </h2>\r\n            \r\n            <p className=\"text-muted-foreground mb-4\">\r\n              抱歉，聊天功能遇到了一些问题。请尝试刷新页面或联系技术支持。\r\n            </p>\r\n\r\n            {/* 错误详情（仅在开发环境显示） */}\r\n            {process.env.NODE_ENV === 'development' && this.state.error && (\r\n              <details className=\"text-left mb-4 p-3 bg-muted rounded-lg\">\r\n                <summary className=\"cursor-pointer text-sm font-medium mb-2\">\r\n                  错误详情（开发模式）\r\n                </summary>\r\n                <pre className=\"text-xs text-muted-foreground overflow-auto\">\r\n                  {this.state.error.toString()}\r\n                  {this.state.errorInfo?.componentStack}\r\n                </pre>\r\n              </details>\r\n            )}\r\n\r\n            <div className=\"flex gap-2 justify-center\">\r\n              <Button onClick={this.handleRetry} className=\"gap-2\">\r\n                <RefreshCw className=\"w-4 h-4\" />\r\n                重试\r\n              </Button>\r\n              \r\n              <Button \r\n                variant=\"outline\" \r\n                onClick={() => window.location.reload()}\r\n              >\r\n                刷新页面\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )\r\n    }\r\n\r\n    return this.props.children\r\n  }\r\n}\r\n\r\n/**\r\n * 错误边界 Hook 版本（用于函数组件）\r\n */\r\nexport function useChatErrorHandler() {\r\n  const [error, setError] = React.useState<Error | null>(null)\r\n\r\n  const resetError = React.useCallback(() => {\r\n    setError(null)\r\n  }, [])\r\n\r\n  const handleError = React.useCallback((error: Error) => {\r\n    setError(error)\r\n    }, [])\r\n\r\n  // 错误边界效果\r\n  React.useEffect(() => {\r\n    const handleUnhandledRejection = (event: PromiseRejectionEvent) => {\r\n      handleError(new Error(event.reason))\r\n    }\r\n\r\n    const handleErrorEvent = (event: ErrorEvent) => {\r\n      handleError(new Error(event.message))\r\n    }\r\n\r\n    window.addEventListener('unhandledrejection', handleUnhandledRejection)\r\n    window.addEventListener('error', handleErrorEvent)\r\n\r\n    return () => {\r\n      window.removeEventListener('unhandledrejection', handleUnhandledRejection)\r\n      window.removeEventListener('error', handleErrorEvent)\r\n    }\r\n  }, [handleError])\r\n\r\n  return {\r\n    error,\r\n    resetError,\r\n    handleError\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\chat\\chat-header.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'isLoading' is defined but never used. Allowed unused args must match /^_/u.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":12,"suggestions":[{"messageId":"removeVar","data":{"varName":"isLoading"},"fix":{"range":[323,336],"text":""},"desc":"Remove unused variable 'isLoading'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'onCreateConversation' is defined but never used. Allowed unused args must match /^_/u.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"onCreateConversation"},"fix":{"range":[336,360],"text":""},"desc":"Remove unused variable 'onCreateConversation'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'onDeleteConversation' is defined but never used. Allowed unused args must match /^_/u.","line":20,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"onDeleteConversation"},"fix":{"range":[409,433],"text":""},"desc":"Remove unused variable 'onDeleteConversation'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 聊天头部组件\n * 包含标题编辑、新建对话、操作按钮等功能\n */\n\nimport React from 'react'\nimport { Input } from '@/components/ui/input'\nimport type { ChatHeaderProps } from '@/types/chat'\nimport { getModelDisplayName } from '@/lib/model-utils'\n\nexport const ChatHeader = React.memo<ChatHeaderProps>(({\n  conversation,\n  editingTitle,\n  tempTitle,\n  isLoading,\n  onCreateConversation,\n  onEditTitle,\n  onTitleChange,\n  onTitleSubmit,\n  onDeleteConversation,\n}) => {\n  // 获取当前对话使用的模型 - 优先从最新助手消息获取\n  const getCurrentConversationModel = () => {\n    if (!conversation?.messages) return ''\n    \n    // 倒序查找最新的助手消息中的模型信息\n    for (let i = conversation.messages.length - 1; i >= 0; i--) {\n      const message = conversation.messages[i]\n      if (message.role === 'assistant' && message.metadata?.model) {\n        return message.metadata.model\n      }\n    }\n    \n    // 如果没有助手消息，使用对话创建时的模型\n    return conversation.model || ''\n  }\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter') {\n      onTitleSubmit()\n    }\n    if (e.key === 'Escape') {\n      onEditTitle() // 取消编辑\n    }\n  }\n\n  return (\n    <div className=\"bg-transparent px-4 py-2 shadow-none\">\n      {/* 紧凑单行布局 - 优化空间利用，为对话记录节省更多空间 */}\n      <div \n        className=\"flex items-center gap-2 cursor-pointer group transition-all duration-200 rounded-md px-2 py-1 -mx-2 hover:bg-black/5 dark:hover:bg-white/5\"\n        onDoubleClick={() => conversation && onEditTitle()}\n        title={conversation ? \"双击编辑标题\" : \"\"}\n      >\n        <div className=\"flex-1 min-w-0 flex items-center gap-2\">\n          {editingTitle ? (\n            <Input\n              value={tempTitle}\n              onChange={(e) => onTitleChange(e.target.value)}\n              onBlur={onTitleSubmit}\n              onKeyDown={handleKeyDown}\n              className=\"text-sm font-medium rounded-md bg-transparent border-none focus-visible:ring-1 focus-visible:ring-primary focus-visible:ring-offset-0 p-0 h-5 shadow-none flex-1\"\n              autoFocus\n              placeholder=\"输入对话标题...\"\n            />\n          ) : (\n            <>\n              {/* 主标题 - 截断显示 */}\n              <div className=\"font-medium text-sm truncate transition-colors duration-200 group-hover:text-primary/80 flex-1 min-w-0\">\n                {conversation?.title || '新对话'}\n              </div>\n              \n              {/* 紧凑元信息标签 */}\n              <div className=\"flex items-center gap-1 text-xs text-muted-foreground transition-colors duration-300 flex-shrink-0\">\n                <span className=\"bg-muted/50 px-1.5 py-0.5 rounded text-xs font-mono\">\n                  {conversation?.messages?.length || 0}\n                </span>\n                {(() => {\n                  const currentModel = getCurrentConversationModel()\n                  return currentModel ? (\n                    <span className=\"bg-primary/10 text-primary px-1.5 py-0.5 rounded text-xs font-medium truncate max-w-16\" title={getModelDisplayName(currentModel)}>\n                      {getModelDisplayName(currentModel).split(' ')[0]}\n                    </span>\n                  ) : null\n                })()}\n              </div>\n            </>\n          )}\n        </div>\n      </div>\n    </div>\n  )\n})\n\nChatHeader.displayName = 'ChatHeader'\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\chat\\chat-input.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'getModelName' is defined but never used. Allowed unused vars must match /^_/u.","line":57,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"getModelName"},"fix":{"range":[1170,1221],"text":""},"desc":"Remove unused variable 'getModelName'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused args must match /^_/u.","line":143,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":143,"endColumn":64,"suggestions":[{"messageId":"removeVar","data":{"varName":"e"},"fix":{"range":[3929,3969],"text":""},"desc":"Remove unused variable 'e'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused args must match /^_/u.","line":154,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":63,"suggestions":[{"messageId":"removeVar","data":{"varName":"e"},"fix":{"range":[4310,4350],"text":""},"desc":"Remove unused variable 'e'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useImperativeHandle has missing dependencies: 'adjustHeight' and 'textareaRef'. Either include them or remove the dependency array.","line":188,"column":6,"nodeType":"ArrayExpression","endLine":188,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [adjustHeight, textareaRef]","fix":{"range":[5207,5209],"text":"[adjustHeight, textareaRef]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 聊天输入组件\r\n * 包含文本输入、发送按钮、设置面板等\r\n */\r\n\r\nimport React, { forwardRef, useState, useMemo } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Textarea } from '@/components/ui/textarea'\r\nimport { Send, Loader2, Square, Lightbulb, AlertTriangle } from 'lucide-react'\r\nimport type { ChatInputProps } from '@/types/chat'\r\nimport { useAutoResizeTextarea } from '@/hooks/use-auto-resize-textarea'\r\nimport { ModelSelectorAnimated } from './model-selector-animated'\r\n\r\n// 推荐问题列表\r\nconst SUGGESTED_QUESTIONS = [\r\n  \"帮我写一段创意文案\",\r\n  \"总结一下这段内容\",\r\n  \"给我一些学习建议\",\r\n  \"推荐几个选题\",\r\n  \"写一个文案的开头\",\r\n  \"解释一个复杂的概念\"\r\n]\r\n\r\n// 智能占位符文本配置\r\nconst PLACEHOLDER_TEXTS = {\r\n  default: [\r\n    \"请输入您想要创作\",\r\n    \"在这里输入您的问题...\",\r\n    \"让我来帮助您...\",\r\n    \"有什么我可以帮您的吗？\"\r\n  ],\r\n  creative: [\r\n    \"来创作一些有趣的内容吧...\",\r\n    \"让我帮您发挥创意...\",\r\n    \"输入您的创作想法...\"\r\n  ],\r\n  analytical: [\r\n    \"请描述需要分析的内容...\",\r\n    \"输入您想要分析的主题...\",\r\n    \"让我帮您理解和分析...\"\r\n  ],\r\n  conversational: [\r\n    \"继续我们的对话...\",\r\n    \"还有什么想聊的吗？\",\r\n    \"请继续...\"\r\n  ]\r\n}\r\n\r\n// 字符限制配置\r\nconst CHAR_LIMITS = {\r\n  MAX: 20000,\r\n  SHOW_COUNTER: 15000,\r\n  WARNING: 18000\r\n} as const\r\n\r\n// 获取模型名称（简化：直接显示ID；如需名称，请在上层通过 props 注入或统一在头部展示模型名称）\r\nfunction getModelName(id: string) {\r\n  return id\r\n}\r\n\r\nexport const ChatInput = forwardRef<HTMLTextAreaElement, ChatInputProps>(({\r\n  input,\r\n  isLoading,\r\n  settings,\r\n  selectedText,\r\n  onInputChange,\r\n  onSubmit,\r\n  onStop,\r\n  onSettingsChange\r\n}, ref) => {\r\n  // 空输入提示状态\r\n  const [showEmptyInputTip, setShowEmptyInputTip] = useState(false)\r\n  // 输入框聚焦状态\r\n  const [isFocused, setIsFocused] = useState(false)\r\n  // 占位符文本状态\r\n  const [currentPlaceholder, setCurrentPlaceholder] = useState('')\r\n  \r\n  // 字符计数相关状态\r\n  const charCount = useMemo(() => input.length, [input])\r\n  const shouldShowCounter = charCount >= CHAR_LIMITS.SHOW_COUNTER\r\n  const isOverWarningThreshold = charCount >= CHAR_LIMITS.WARNING\r\n  const isOverLimit = charCount > CHAR_LIMITS.MAX\r\n  const remainingChars = CHAR_LIMITS.MAX - charCount\r\n  \r\n  // 智能占位符选择逻辑\r\n  const getSmartPlaceholder = useMemo(() => {\r\n    if (isLoading) return '正在获取返回数据'\r\n    \r\n    // 根据历史对话内容判断上下文类型\r\n    // 这里简化为随机选择，实际项目中可以基于消息历史做更智能的判断\r\n    const contexts = ['default', 'creative', 'analytical', 'conversational'] as const\r\n    const randomContext = contexts[Math.floor(Math.random() * contexts.length)]\r\n    const placeholders = PLACEHOLDER_TEXTS[randomContext]\r\n    \r\n    return placeholders[Math.floor(Math.random() * placeholders.length)]\r\n  }, [isLoading])\r\n  \r\n  // 初始化和更新占位符\r\n  React.useEffect(() => {\r\n    if (!currentPlaceholder) {\r\n      setCurrentPlaceholder(getSmartPlaceholder)\r\n    }\r\n  }, [currentPlaceholder, getSmartPlaceholder])\r\n  \r\n  // 自适应高度：使用统一 Hook（min=72, max=300）\r\n  const { textareaRef, adjustHeight } = useAutoResizeTextarea({ minHeight: 72, maxHeight: 300 })\r\n  const setTextareaRef = (node: HTMLTextAreaElement | null) => {\r\n    textareaRef.current = node\r\n    // 透传给外部 forwardRef，保持聚焦与快捷键逻辑不变\r\n    if (typeof ref === 'function') {\r\n      ref(node)\r\n    } else if (ref) {\r\n      ;(ref as React.MutableRefObject<HTMLTextAreaElement | null>).current = node\r\n    }\r\n  }\r\n\r\n  const handleKeyDown = (e: React.KeyboardEvent) => {\r\n    if (e.key === 'Enter' && !e.shiftKey) {\r\n      e.preventDefault()\r\n      if (input.trim() && !isLoading && !isOverLimit) {\r\n        setShowEmptyInputTip(false) // 隐藏提示\r\n        onSubmit(e as any)\r\n      } else if (!input.trim() && !isLoading) {\r\n        // 输入为空时显示友好提示\r\n        setShowEmptyInputTip(true)\r\n        setTimeout(() => setShowEmptyInputTip(false), 5000) // 5秒后自动隐藏\r\n      }\r\n    }\r\n    if (e.key === 'Escape') {\r\n      onStop()\r\n    }\r\n  }\r\n  \r\n  // 处理输入变化，包含字符限制验证\r\n  const handleInputChange = (value: string) => {\r\n    // 如果超过最大限制，截断输入\r\n    const truncatedValue = value.length > CHAR_LIMITS.MAX ? value.slice(0, CHAR_LIMITS.MAX) : value\r\n    onInputChange(truncatedValue)\r\n    adjustHeight()\r\n  }\r\n  \r\n  // 处理输入框聚焦\r\n  const handleFocus = (e: React.FocusEvent<HTMLTextAreaElement>) => {\r\n    setIsFocused(true)\r\n    setShowEmptyInputTip(false)\r\n    // 聚焦时可以切换到更具体的占位符\r\n    if (!input.trim()) {\r\n      const focusedPlaceholders = PLACEHOLDER_TEXTS.conversational\r\n      setCurrentPlaceholder(focusedPlaceholders[Math.floor(Math.random() * focusedPlaceholders.length)])\r\n    }\r\n  }\r\n  \r\n  // 处理输入框失焦\r\n  const handleBlur = (e: React.FocusEvent<HTMLTextAreaElement>) => {\r\n    setIsFocused(false)\r\n    // 失焦后2秒切换到默认占位符\r\n    if (!input.trim()) {\r\n      setTimeout(() => {\r\n        setCurrentPlaceholder(getSmartPlaceholder)\r\n      }, 2000)\r\n    }\r\n  }\r\n\r\n  // 处理推荐问题点击\r\n  const handleSuggestedQuestion = (question: string) => {\r\n    onInputChange(question)\r\n    setShowEmptyInputTip(false)\r\n  }\r\n\r\n\r\n  // 暴露 textarea 引用和高度调整函数给外部\r\n  React.useImperativeHandle(ref, () => {\r\n    const element = textareaRef.current\r\n    if (!element) {\r\n      // 如果element不存在，创建一个空的textarea作为fallback\r\n      const fallback = document.createElement('textarea')\r\n      return Object.assign(fallback, {\r\n        adjustHeight: () => {}\r\n      })\r\n    }\r\n    \r\n    // 创建代理对象，包含textarea的所有方法和属性，以及我们的adjustHeight\r\n    return Object.assign(element, {\r\n      adjustHeight: (reset?: boolean) => {\r\n        adjustHeight(reset)\r\n        }\r\n    })\r\n  }, [])\r\n\r\n  // 占位符已通过智能系统管理，这里移除硬编码\r\n\r\n  return (\r\n    <div className=\"bg-transparent p-4 shadow-none\">\r\n      <div className=\"max-w-[720px] mx-auto\">\r\n        {/* 选中文本快捷操作 */}\r\n        {selectedText && (\r\n          <div className=\"border border-border rounded-xl p-2.5 mb-3 bg-muted/50\">\r\n            <div className=\"flex items-center gap-2 text-sm mb-2\">\r\n              <span className=\"text-muted-foreground\">检测到选中文本，快捷操作：</span>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-6 px-2 text-xs\"\r\n                onClick={() => onInputChange(`请帮我优化这段文本：\\n\\n\"${selectedText}\"\\n\\n`)}\r\n              >\r\n                匹配合适的角色来优化这段文本\r\n              </Button>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-6 px-2 text-xs\"\r\n                onClick={() => onInputChange(`请帮我扩展这段内容：\\n\\n\"${selectedText}\"\\n\\n`)}\r\n              >\r\n                扩展内容，保持风格不变\r\n              </Button>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-6 px-2 text-xs\"\r\n                onClick={() => onInputChange(`请帮我总结这段文本：\\n\\n\"${selectedText}\"\\n\\n`)}\r\n              >\r\n                总结内容\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* 输入表单（对齐样例布局） */}\r\n        <form onSubmit={onSubmit}>\r\n          <div className={`bg-muted/50 rounded-2xl p-1.5 transition-all duration-200 ${\r\n            isFocused ? 'ring-2 ring-primary/20 bg-muted/70 shadow-sm' : 'hover:bg-muted/60'\r\n          }`} \r\n          data-focused={isFocused ? 'true' : 'false'}>\r\n            <div className=\"relative flex flex-col\">\r\n              {/* 输入区域 */}\r\n              <Textarea\r\n                ref={setTextareaRef}\r\n                value={input}\r\n                onChange={(e) => handleInputChange(e.target.value)}\r\n                onKeyDown={handleKeyDown}\r\n                onFocus={handleFocus}\r\n                onBlur={handleBlur}\r\n                placeholder={currentPlaceholder}\r\n                className={`w-full rounded-xl rounded-b-none px-4 py-3 bg-background border text-foreground resize-none overflow-y-auto outline-none focus:outline-none focus-visible:outline-none focus-visible:ring-0 focus-visible:ring-offset-0 !ring-0 !ring-offset-0 scrollbar-hide ${\r\n                  // 聚焦时的特殊样式\r\n                  isFocused ? 'scale-[1.005] shadow-sm' : ''\r\n                } ${\r\n                  // 字符限制相关的边框颜色\r\n                  isOverLimit ? 'border-red-400' : \r\n                  isOverWarningThreshold ? 'border-amber-400' : \r\n                  isFocused ? 'border-primary shadow-sm' :\r\n                  'border-border hover:border-border/80'\r\n                } ${\r\n                  // 占位符动画\r\n                  'placeholder:text-muted-foreground placeholder:transition-opacity placeholder:duration-300'\r\n                } ${\r\n                  // 聚焦时占位符淡化效果\r\n                  isFocused && !input.trim() ? 'placeholder:opacity-70' : 'placeholder:opacity-100'\r\n                }`}\r\n                style={{ \r\n                  // 确保没有水平滚动\r\n                  overflowX: 'hidden',\r\n                  // 隐藏滚动条但保留滚动功能\r\n                  scrollbarWidth: 'none',\r\n                  msOverflowStyle: 'none',\r\n                  // JavaScript控制高度限制\r\n                  minHeight: '72px',\r\n                  maxHeight: '300px'\r\n                }}\r\n                disabled={isLoading}\r\n                data-chat-composer-input\r\n              />\r\n\r\n              {/* 底部工具条 */}\r\n              <div className=\"h-14 bg-muted/50 rounded-b-xl flex items-center\">\r\n                <div className=\"absolute left-3 right-3 bottom-3 flex items-center justify-between w-[calc(100%-24px)]\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <ModelSelectorAnimated\r\n                      modelId={settings.modelId}\r\n                      onChange={(id) => onSettingsChange({ modelId: id })}\r\n                    />\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    {/* 字符计数器 */}\r\n                    {shouldShowCounter && (\r\n                      <div className={`flex items-center gap-1 text-xs transition-colors duration-200 ${\r\n                        isOverLimit ? 'text-red-500' : \r\n                        isOverWarningThreshold ? 'text-amber-500' : \r\n                        'text-muted-foreground'\r\n                      }`}>\r\n                        {isOverWarningThreshold && (\r\n                          <AlertTriangle className=\"w-3 h-3\" />\r\n                        )}\r\n                        <span>\r\n                          {isOverLimit ? `超出 ${Math.abs(remainingChars)}` : remainingChars}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                    \r\n                    {/* 停止按钮 */}\r\n                    <Button\r\n                      type=\"button\"\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={onStop}\r\n                      disabled={!isLoading}\r\n                      className=\"h-8 w-8 p-0 rounded-md bg-secondary hover:bg-secondary/80 text-secondary-foreground transition-colors\"\r\n                      aria-label=\"停止\"\r\n                    >\r\n                      <Square className=\"w-4 h-4\" />\r\n                    </Button>\r\n\r\n                    {/* 发送按钮 */}\r\n                    <Button\r\n                      type=\"submit\"\r\n                      size=\"sm\"\r\n                      disabled={isLoading || isOverLimit}\r\n                      className=\"h-8 w-8 p-0 rounded-md\"\r\n                      aria-label=\"发送\"\r\n                      onClick={(e) => {\r\n                        if ((!input.trim() || isOverLimit) && !isLoading) {\r\n                          e.preventDefault()\r\n                          if (!input.trim()) {\r\n                            setShowEmptyInputTip(true)\r\n                            setTimeout(() => setShowEmptyInputTip(false), 5000)\r\n                          }\r\n                        }\r\n                      }}\r\n                    >\r\n                      {isLoading ? (\r\n                        <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n                      ) : (\r\n                        <Send className=\"w-4 h-4\" />\r\n                      )}\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </form>\r\n\r\n        {/* 空输入友好提示 */}\r\n        {showEmptyInputTip && (\r\n          <div className=\"mt-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-200 dark:border-blue-800 animate-in slide-in-from-top-2 fade-in-0 duration-300\">\r\n            <div className=\"flex items-center gap-2 mb-3\">\r\n              <Lightbulb className=\"w-5 h-5 text-blue-500\" />\r\n              <span className=\"text-sm font-medium text-blue-900 dark:text-blue-100\">\r\n                别着急，试试这些问题吧\r\n              </span>\r\n            </div>\r\n            <div className=\"grid grid-cols-2 gap-2\">\r\n              {SUGGESTED_QUESTIONS.slice(0, 4).map((question, index) => (\r\n                <button\r\n                  key={index}\r\n                  onClick={() => handleSuggestedQuestion(question)}\r\n                  className=\"text-left text-sm p-2 rounded-lg bg-white dark:bg-blue-900/50 border border-blue-200 dark:border-blue-700 hover:border-blue-300 dark:hover:border-blue-600 text-blue-800 dark:text-blue-200 hover:bg-blue-50 dark:hover:bg-blue-900/70 transition-colors\"\r\n                >\r\n                  {question}\r\n                </button>\r\n              ))}\r\n            </div>\r\n            <p className=\"text-xs text-blue-600 dark:text-blue-400 mt-2\">\r\n              点击上面的问题快速开始对话，或者在输入框中输入您的问题\r\n            </p>\r\n          </div>\r\n        )}\r\n\r\n        {/* 字符限制警告 */}\r\n        {isOverWarningThreshold && (\r\n          <div className={`mt-3 p-3 rounded-xl border transition-all duration-200 animate-in slide-in-from-top-2 fade-in-0 ${\r\n            isOverLimit \r\n              ? 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' \r\n              : 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800'\r\n          }`}>\r\n            <div className=\"flex items-center gap-2\">\r\n              <AlertTriangle className={`w-4 h-4 ${\r\n                isOverLimit ? 'text-red-500' : 'text-amber-500'\r\n              }`} />\r\n              <span className={`text-sm font-medium ${\r\n                isOverLimit \r\n                  ? 'text-red-900 dark:text-red-100' \r\n                  : 'text-amber-900 dark:text-amber-100'\r\n              }`}>\r\n                {isOverLimit \r\n                  ? `已超出字符限制 ${Math.abs(remainingChars)} 个字符` \r\n                  : `还可输入 ${remainingChars} 个字符`\r\n                }\r\n              </span>\r\n            </div>\r\n            {isOverLimit && (\r\n              <p className=\"text-xs text-red-600 dark:text-red-400 mt-1\">\r\n                请删除多余内容后再发送\r\n              </p>\r\n            )}\r\n          </div>\r\n        )}\r\n        \r\n        {/* 状态信息 */}\r\n        <div className=\"flex items-center justify-between mt-2 text-xs text-foreground/70\">\r\n          <span>按 Enter 发送，Shift + Enter 换行</span>\r\n          <span>\r\n            {!shouldShowCounter && charCount > 0 && (\r\n              <span className=\"text-muted-foreground\">{charCount} 字符</span>\r\n            )}\r\n          </span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n})\r\n\r\nChatInput.displayName = 'ChatInput'\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\chat\\conversation-sidebar-v2.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'useConversationStore' is defined but never used. Allowed unused vars must match /^_/u.","line":28,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"useConversationStore"},"fix":{"range":[522,543],"text":""},"desc":"Remove unused variable 'useConversationStore'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Conversation' is defined but never used. Allowed unused vars must match /^_/u.","line":44,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":27,"suggestions":[{"messageId":"removeVar","data":{"varName":"Conversation"},"fix":{"range":[963,1011],"text":""},"desc":"Remove unused variable 'Conversation'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useMemo has unnecessary dependencies: 'conversations' and 'searchInput'. Either exclude them or remove the dependency array.","line":79,"column":6,"nodeType":"ArrayExpression","endLine":79,"endColumn":60,"suggestions":[{"desc":"Update the dependencies array to be: [getFilteredConversations]","fix":{"range":[2214,2268],"text":"[getFilteredConversations]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 对话侧边栏组件 V2\r\n * 使用 Zustand + TanStack Query 的新架构\r\n * 演示如何使用新的状态管理和数据获取方式\r\n */\r\n\r\n'use client'\r\n\r\nimport React, { useEffect } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { ScrollArea } from '@/components/ui/scroll-area'\r\nimport { Input } from '@/components/ui/input'\r\nimport { \r\n  Plus, \r\n  MessageSquare, \r\n  Trash2, \r\n  Search,\r\n  Loader2,\r\n  Edit2,\r\n  Check,\r\n  X\r\n} from 'lucide-react'\r\nimport { cn } from '@/lib/utils'\r\nimport { toast } from 'sonner'\r\n\r\n// Zustand Store\r\nimport { \r\n  useConversationStore,\r\n  useConversations,\r\n  useCurrentConversationId,\r\n  useConversationActions,\r\n  useConversationLoading\r\n} from '@/stores/conversation-store'\r\n\r\n// TanStack Query Hooks\r\nimport { useConversationsQuery } from '@/hooks/api/use-conversations-query'\r\nimport { \r\n  useCreateConversationMutation,\r\n  useUpdateConversationMutation,\r\n  useDeleteConversationMutation\r\n} from '@/hooks/api/use-conversation-mutations'\r\n\r\n// Types\r\nimport type { Conversation } from '@/types/chat'\r\n\r\nexport function ConversationSidebarV2() {\r\n  // Zustand State\r\n  const conversations = useConversations()\r\n  const currentConversationId = useCurrentConversationId()\r\n  const { \r\n    selectConversation, \r\n    setConversations,\r\n    setSearchQuery,\r\n    getFilteredConversations \r\n  } = useConversationActions()\r\n  const { isCreating, isDeleting, isUpdating } = useConversationLoading()\r\n  \r\n  // TanStack Query\r\n  const { data: serverConversations, isLoading: isLoadingList } = useConversationsQuery()\r\n  const createMutation = useCreateConversationMutation()\r\n  const updateMutation = useUpdateConversationMutation()\r\n  const deleteMutation = useDeleteConversationMutation()\r\n  \r\n  // Local State\r\n  const [editingId, setEditingId] = React.useState<string | null>(null)\r\n  const [editingTitle, setEditingTitle] = React.useState('')\r\n  const [searchInput, setSearchInput] = React.useState('')\r\n  \r\n  // 同步服务器数据到 Zustand Store\r\n  useEffect(() => {\r\n    if (serverConversations) {\r\n      setConversations(serverConversations)\r\n    }\r\n  }, [serverConversations, setConversations])\r\n  \r\n  // 获取过滤后的对话列表\r\n  const filteredConversations = React.useMemo(() => {\r\n    return getFilteredConversations()\r\n  }, [conversations, searchInput, getFilteredConversations])\r\n  \r\n  // 创建新对话\r\n  const handleCreateConversation = async () => {\r\n    try {\r\n      const newConversation = await createMutation.mutateAsync('claude-opus-4-1-20250805')\r\n      selectConversation(newConversation.id)\r\n      toast.success('新对话已创建', {\r\n        icon: <MessageSquare className=\"w-4 h-4\" />\r\n      })\r\n    } catch (error) {\r\n      toast.error('创建对话失败', {\r\n        description: error instanceof Error ? error.message : '未知错误'\r\n      })\r\n    }\r\n  }\r\n  \r\n  // 删除对话\r\n  const handleDeleteConversation = async (id: string, e: React.MouseEvent) => {\r\n    e.stopPropagation()\r\n    \r\n    // 确认删除\r\n    if (!confirm('确定要删除这个对话吗？')) {\r\n      return\r\n    }\r\n    \r\n    try {\r\n      await deleteMutation.mutateAsync(id)\r\n      toast.success('对话已删除', {\r\n        icon: <Trash2 className=\"w-4 h-4\" />\r\n      })\r\n    } catch (error) {\r\n      toast.error('删除失败', {\r\n        description: error instanceof Error ? error.message : '未知错误'\r\n      })\r\n    }\r\n  }\r\n  \r\n  // 开始编辑标题\r\n  const handleStartEdit = (id: string, title: string, e: React.MouseEvent) => {\r\n    e.stopPropagation()\r\n    setEditingId(id)\r\n    setEditingTitle(title)\r\n  }\r\n  \r\n  // 保存编辑的标题\r\n  const handleSaveTitle = async () => {\r\n    if (!editingId || !editingTitle.trim()) return\r\n    \r\n    try {\r\n      await updateMutation.mutateAsync({\r\n        id: editingId,\r\n        updates: { title: editingTitle.trim() }\r\n      })\r\n      toast.success('标题已更新')\r\n      setEditingId(null)\r\n      setEditingTitle('')\r\n    } catch (error) {\r\n      toast.error('更新失败', {\r\n        description: error instanceof Error ? error.message : '未知错误'\r\n      })\r\n    }\r\n  }\r\n  \r\n  // 取消编辑\r\n  const handleCancelEdit = () => {\r\n    setEditingId(null)\r\n    setEditingTitle('')\r\n  }\r\n  \r\n  // 搜索处理\r\n  const handleSearch = (value: string) => {\r\n    setSearchInput(value)\r\n    setSearchQuery(value)\r\n  }\r\n  \r\n  return (\r\n    <div className=\"flex flex-col h-full bg-background border-r\">\r\n      {/* 头部 */}\r\n      <div className=\"p-4 border-b space-y-3\">\r\n        {/* 新建对话按钮 */}\r\n        <Button\r\n          onClick={handleCreateConversation}\r\n          disabled={createMutation.isPending}\r\n          className=\"w-full\"\r\n          size=\"sm\"\r\n        >\r\n          {createMutation.isPending ? (\r\n            <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n          ) : (\r\n            <Plus className=\"w-4 h-4 mr-2\" />\r\n          )}\r\n          新建对话\r\n        </Button>\r\n        \r\n        {/* 搜索框 */}\r\n        <div className=\"relative\">\r\n          <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\r\n          <Input\r\n            value={searchInput}\r\n            onChange={(e) => handleSearch(e.target.value)}\r\n            placeholder=\"搜索对话...\"\r\n            className=\"pl-8 h-8 text-sm\"\r\n          />\r\n        </div>\r\n      </div>\r\n      \r\n      {/* 对话列表 */}\r\n      <ScrollArea className=\"flex-1\">\r\n        <div className=\"p-2 space-y-1\">\r\n          {isLoadingList ? (\r\n            <div className=\"flex items-center justify-center py-8\">\r\n              <Loader2 className=\"w-6 h-6 animate-spin text-muted-foreground\" />\r\n            </div>\r\n          ) : filteredConversations.length === 0 ? (\r\n            <div className=\"text-center py-8 text-sm text-muted-foreground\">\r\n              {searchInput ? '没有找到匹配的对话' : '暂无对话'}\r\n            </div>\r\n          ) : (\r\n            filteredConversations.map((conversation) => (\r\n              <div\r\n                key={conversation.id}\r\n                onClick={() => selectConversation(conversation.id)}\r\n                className={cn(\r\n                  \"group relative flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all\",\r\n                  \"hover:bg-accent\",\r\n                  currentConversationId === conversation.id && \"bg-accent\",\r\n                  (deleteMutation.isPending && deleteMutation.variables === conversation.id) && \"opacity-50\"\r\n                )}\r\n              >\r\n                <MessageSquare className=\"w-4 h-4 flex-shrink-0 text-muted-foreground\" />\r\n                \r\n                {/* 标题编辑 */}\r\n                {editingId === conversation.id ? (\r\n                  <div className=\"flex-1 flex items-center gap-1\">\r\n                    <Input\r\n                      value={editingTitle}\r\n                      onChange={(e) => setEditingTitle(e.target.value)}\r\n                      onKeyDown={(e) => {\r\n                        if (e.key === 'Enter') handleSaveTitle()\r\n                        if (e.key === 'Escape') handleCancelEdit()\r\n                      }}\r\n                      className=\"h-6 text-sm\"\r\n                      autoFocus\r\n                      onClick={(e) => e.stopPropagation()}\r\n                    />\r\n                    <Button\r\n                      size=\"sm\"\r\n                      variant=\"ghost\"\r\n                      className=\"h-6 w-6 p-0\"\r\n                      onClick={(e) => {\r\n                        e.stopPropagation()\r\n                        handleSaveTitle()\r\n                      }}\r\n                      disabled={updateMutation.isPending}\r\n                    >\r\n                      {updateMutation.isPending ? (\r\n                        <Loader2 className=\"w-3 h-3 animate-spin\" />\r\n                      ) : (\r\n                        <Check className=\"w-3 h-3\" />\r\n                      )}\r\n                    </Button>\r\n                    <Button\r\n                      size=\"sm\"\r\n                      variant=\"ghost\"\r\n                      className=\"h-6 w-6 p-0\"\r\n                      onClick={(e) => {\r\n                        e.stopPropagation()\r\n                        handleCancelEdit()\r\n                      }}\r\n                    >\r\n                      <X className=\"w-3 h-3\" />\r\n                    </Button>\r\n                  </div>\r\n                ) : (\r\n                  <>\r\n                    <div className=\"flex-1 truncate\">\r\n                      <p className=\"text-sm font-medium truncate\">\r\n                        {conversation.title}\r\n                      </p>\r\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {conversation.metadata?.messageCount ?? conversation.messages.length} 条消息\r\n                      </p>\r\n                    </div>\r\n                    \r\n                    {/* 操作按钮 */}\r\n                    <div className=\"hidden group-hover:flex items-center gap-1\">\r\n                      <Button\r\n                        size=\"sm\"\r\n                        variant=\"ghost\"\r\n                        className=\"h-6 w-6 p-0\"\r\n                        onClick={(e) => handleStartEdit(conversation.id, conversation.title, e)}\r\n                      >\r\n                        <Edit2 className=\"w-3 h-3\" />\r\n                      </Button>\r\n                      <Button\r\n                        size=\"sm\"\r\n                        variant=\"ghost\"\r\n                        className=\"h-6 w-6 p-0 hover:text-destructive\"\r\n                        onClick={(e) => handleDeleteConversation(conversation.id, e)}\r\n                        disabled={deleteMutation.isPending}\r\n                      >\r\n                        {deleteMutation.isPending && deleteMutation.variables === conversation.id ? (\r\n                          <Loader2 className=\"w-3 h-3 animate-spin\" />\r\n                        ) : (\r\n                          <Trash2 className=\"w-3 h-3\" />\r\n                        )}\r\n                      </Button>\r\n                    </div>\r\n                  </>\r\n                )}\r\n              </div>\r\n            ))\r\n          )}\r\n        </div>\r\n      </ScrollArea>\r\n      \r\n      {/* 底部状态栏 */}\r\n      <div className=\"p-2 border-t text-xs text-muted-foreground text-center\">\r\n        {conversations.length} 个对话\r\n        {(isCreating || isDeleting || isUpdating) && (\r\n          <span className=\"ml-2\">\r\n            <Loader2 className=\"w-3 h-3 inline animate-spin\" />\r\n            处理中...\r\n          </span>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default ConversationSidebarV2","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\chat\\message-item.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'User' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"User"},"fix":{"range":[148,153],"text":""},"desc":"Remove unused variable 'User'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'ThumbsUp' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"ThumbsUp"},"fix":{"range":[165,175],"text":""},"desc":"Remove unused variable 'ThumbsUp'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'ThumbsDown' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":49,"suggestions":[{"messageId":"removeVar","data":{"varName":"ThumbsDown"},"fix":{"range":[175,187],"text":""},"desc":"Remove unused variable 'ThumbsDown'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'RotateCcw' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":60,"suggestions":[{"messageId":"removeVar","data":{"varName":"RotateCcw"},"fix":{"range":[187,198],"text":""},"desc":"Remove unused variable 'RotateCcw'."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":87,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":87,"endColumn":20,"suggestions":[{"fix":{"range":[2174,2201],"text":""},"messageId":"removeConsole","data":{"propertyName":"error"},"desc":"Remove the console.error()."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'handleRetry' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":91,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":91,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 消息项组件\n * 显示单条消息，包含用户消息和助手消息\n */\n\nimport React, { useState, useEffect } from 'react'\nimport { Button } from '@/components/ui/button'\nimport { User, Copy, Check, ThumbsUp, ThumbsDown, RotateCcw } from 'lucide-react'\nimport { cn } from '@/lib/utils'\nimport { toast } from 'sonner'\nimport type { MessageItemProps } from '@/types/chat'\nimport { getModelDisplayName, getModelProvider } from '@/lib/model-utils'\n\nexport const MessageItem = React.memo<MessageItemProps>(({\n  message,\n  onCopy,\n  onRetry\n}) => {\n  const isUser = message.role === 'user'\n  const isAssistant = message.role === 'assistant'\n  const hasError = message.metadata?.error\n  \n  // 微光闪烁状态 - 新回复时触发\n  const [shouldGlow, setShouldGlow] = useState(false)\n  const [isNewMessage, setIsNewMessage] = useState(false)\n  \n  // 复制状态\n  const [copied, setCopied] = useState(false)\n  \n  // 字数统计\n  const wordCount = message.content.length\n  \n  useEffect(() => {\n    // 如果是助手消息且有内容，触发微光效果\n    if (isAssistant && message.content && message.content.length > 10) {\n      setIsNewMessage(true)\n      setShouldGlow(true)\n      \n      // 3秒后停止微光效果\n      const timer = setTimeout(() => {\n        setShouldGlow(false)\n      }, 3000)\n      \n      // 5秒后取消新消息标记\n      const newTimer = setTimeout(() => {\n        setIsNewMessage(false)\n      }, 5000)\n      \n      return () => {\n        clearTimeout(timer)\n        clearTimeout(newTimer)\n      }\n    }\n  }, [message.content, isAssistant])\n\n  const handleCopy = async () => {\n    try {\n      // 调用父组件的复制函数\n      onCopy(message.content)\n      \n      // 尝试使用浏览器 API 复制\n      if (navigator.clipboard && navigator.clipboard.writeText) {\n        await navigator.clipboard.writeText(message.content)\n      }\n      \n      // 设置复制状态\n      setCopied(true)\n      \n      // 显示成功提示\n      toast.success('已复制到剪贴板', {\n        duration: 2000,\n        position: 'bottom-right',\n        icon: <Check className=\"w-4 h-4\" />,\n        className: 'text-sm'\n      })\n      \n      // 2秒后重置复制状态\n      setTimeout(() => {\n        setCopied(false)\n      }, 2000)\n    } catch (err) {\n      // 复制失败提示\n      toast.error('复制失败，请手动选择文本', {\n        duration: 3000,\n        position: 'bottom-right'\n      })\n      console.error('复制失败:', err)\n    }\n  }\n\n  const handleRetry = () => {\n    if (onRetry) {\n      onRetry()\n    }\n  }\n\n  return (\n    <div \n      data-message-id={message.id}\n      className={cn(\n        \"flex gap-4 transition-all duration-300\",\n        isUser ? \"justify-end\" : \"justify-start\",\n        isNewMessage && \"animate-in slide-in-from-bottom-2 fade-in-0\"\n      )}\n    >\n      {/* 消息内容 */}\n      <div className={cn(\n        \"max-w-[90%] group\",\n        isUser && \"flex flex-col items-end\"\n      )}>\n        <div className={cn(\n          \"rounded-2xl px-6 py-4 text-sm leading-relaxed relative overflow-hidden transition-all duration-500\",\n          isUser\n            ? \"bg-primary/90 text-primary-foreground rounded-2xl\"\n            : hasError\n              ? \"bg-destructive/10 border border-destructive/20 text-destructive\"\n              : \"bg-black/5 dark:bg-white/5 border border-white/10\",\n          // 微光闪烁效果\n          isAssistant && shouldGlow && \"shadow-md ring-2 ring-primary/20 bg-gradient-to-r from-black/5 via-primary/5 to-black/5 dark:from-white/5 dark:via-primary/10 dark:to-white/5\"\n        )}>\n          \n          {/* 微光效果 - 仅对助手消息 */}\n          {isAssistant && shouldGlow && (\n            <div className=\"absolute inset-0 bg-gradient-to-r from-transparent via-primary/20 to-transparent animate-pulse opacity-50\" />\n          )}\n          \n          \n          {/* 错误标识 */}\n          {hasError && (\n            <div className=\"text-xs text-destructive mb-2 font-medium\">\n               {message.metadata?.error}\n            </div>\n          )}\n\n          {/* 消息文本 */}\n          <div className=\"whitespace-pre-wrap relative z-10\">\n            {message.content}\n          </div>\n\n        </div>\n\n        {/* 消息元信息 */}\n        <div className=\"flex items-center justify-between gap-2 mt-1 text-xs text-muted-foreground\">\n          <div className=\"flex items-center gap-2\">\n            {/* 时间戳 */}\n            <span>\n              {new Date(message.timestamp).toLocaleTimeString('zh-CN', {\n                hour: '2-digit',\n                minute: '2-digit'\n              })}\n            </span>\n\n            {/* 字数统计 - 新增 */}\n            {wordCount > 0 && (\n              <>\n                <span>•</span>\n                <span className={cn(\n                  \"transition-colors duration-300\",\n                  shouldGlow && isAssistant ? \"text-primary font-medium\" : \"\"\n                )}>\n                  {wordCount} 字\n                </span>\n              </>\n            )}\n\n            {/* 模型信息 - 优化显示，所有消息都显示 */}\n            {message.metadata?.model && (() => {\n              const provider = getModelProvider(message.metadata.model)\n              return (\n                <>\n                  <span>•</span>\n                  <span className={cn(\n                    \"transition-colors duration-300 px-1.5 py-0.5 rounded text-xs bg-muted/50 border border-muted/20\",\n                    shouldGlow && isAssistant ? \"text-primary font-medium bg-primary/10 border-primary/20\" : \"text-muted-foreground\"\n                  )} title={`使用 ${provider.name} 模型`}>\n                    {getModelDisplayName(message.metadata.model)}\n                  </span>\n                </>\n              )\n            })()}\n\n            {/* Token 信息 */}\n            {message.tokens && (\n              <>\n                <span>•</span>\n                <span>{message.tokens} tokens</span>\n              </>\n            )}\n\n            {/* 处理时间 */}\n            {message.metadata?.processingTime && (\n              <>\n                <span>•</span>\n                <span>{message.metadata.processingTime}ms</span>\n              </>\n            )}\n          </div>\n\n          {/* 复制按钮 - 只对助手消息显示，统一风格 */}\n          {isAssistant && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className={cn(\n                \"h-5 px-2 text-xs transition-all duration-200\",\n                copied \n                  ? \"text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-950/30\"\n                  : \"opacity-70 hover:opacity-100 text-muted-foreground hover:text-primary hover:bg-primary/10\",\n                \"rounded\"\n              )}\n              onClick={handleCopy}\n              title={copied ? \"已复制\" : \"复制消息内容\"}\n              disabled={copied}\n            >\n              {copied ? (\n                <>\n                  <Check className=\"h-3 w-3 mr-1 animate-in zoom-in-0 duration-200\" />\n                  已复制\n                </>\n              ) : (\n                <>\n                  <Copy className=\"h-3 w-3 mr-1\" />\n                  复制\n                </>\n              )}\n            </Button>\n          )}\n        </div>\n      </div>\n\n    </div>\n  )\n})\n\nMessageItem.displayName = 'MessageItem'\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\chat\\model-selector-animated.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'modelId' is defined but never used. Allowed unused args must match /^_/u.","line":18,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"modelId"},"fix":{"range":[482,497],"text":""},"desc":"Remove unused variable 'modelId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n} from \"@/components/ui/dropdown-menu\"\nimport { ChevronDown, Check } from \"lucide-react\"\nimport { ALLOWED_MODELS } from \"@/lib/ai/models\"\nimport { cn } from \"@/lib/utils\"\nimport { AnimatePresence, motion } from \"framer-motion\"\n\ninterface ModelSelectorAnimatedProps {\n  modelId: string\n  onChange: (modelId: string) => void\n  className?: string\n}\n\nexport function ModelSelectorAnimated({ modelId, onChange, className }: ModelSelectorAnimatedProps) {\n  const current = ALLOWED_MODELS.find((m) => m.id === modelId)\n  const isEmpty = ALLOWED_MODELS.length === 0\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button\n          variant=\"ghost\"\n          className={cn(\n            \"flex items-center gap-1 h-8 pl-1 pr-2 text-xs rounded-md\",\n            \"bg-secondary hover:bg-secondary/80 text-secondary-foreground\",\n            \"transition-colors\",\n            className\n          )}\n        >\n          <AnimatePresence mode=\"wait\">\n            <motion.div\n              key={modelId}\n              initial={{ opacity: 0, y: -5 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: 5 }}\n              transition={{ duration: 0.15 }}\n              className=\"flex items-center gap-1\"\n            >\n\n              {current?.name || modelId}\n              <ChevronDown className=\"w-3 h-3 opacity-50\" />\n            </motion.div>\n          </AnimatePresence>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent\n        className={cn(\n          \"min-w-[12rem]\",\n          \"border border-border\",\n          \"bg-popover text-popover-foreground\",\n        )}\n        align=\"start\"\n      >\n        {isEmpty ? (\n          <DropdownMenuItem disabled className=\"text-muted-foreground\">\n            暂无可用模型，请联系管理员配置 MODEL_ALLOWLIST\n          </DropdownMenuItem>\n        ) : (\n          ALLOWED_MODELS.map((m) => (\n            <DropdownMenuItem\n              key={m.id}\n              onSelect={() => onChange(m.id)}\n              className=\"flex items-center justify-between gap-2\"\n            >\n              <span className=\"inline-flex items-center gap-2\">\n                <span>{m.name}</span>\n              </span>\n              {modelId === m.id && <Check className=\"w-4 h-4 text-primary\" />}\n            </DropdownMenuItem>\n          ))\n        )}\n      </DropdownMenuContent>\n    </DropdownMenu>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\chat\\smart-chat-center-v2-fixed.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'Button' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"Button"},"fix":{"range":[153,200],"text":""},"desc":"Remove unused variable 'Button'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'Plus' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"Plus"},"fix":{"range":[211,216],"text":""},"desc":"Remove unused variable 'Plus'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'X' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"X"},"fix":{"range":[222,225],"text":""},"desc":"Remove unused variable 'X'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'ALLOWED_MODELS' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":24,"suggestions":[{"messageId":"removeVar","data":{"varName":"ALLOWED_MODELS"},"fix":{"range":[249,297],"text":""},"desc":"Remove unused variable 'ALLOWED_MODELS'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'conversations' is assigned a value but never used. Allowed unused args must match /^_/u.","line":36,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"conversations"},"fix":{"range":[1164,1187],"text":""},"desc":"Remove unused variable 'conversations'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'editorContent' is defined but never used. Allowed unused args must match /^_/u.","line":40,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"editorContent"},"fix":{"range":[1255,1273],"text":""},"desc":"Remove unused variable 'editorContent'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'onDeleteConversation' is defined but never used. Allowed unused args must match /^_/u.","line":43,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"onDeleteConversation"},"fix":{"range":[1323,1348],"text":""},"desc":"Remove unused variable 'onDeleteConversation'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'model' is defined but never used. Allowed unused args must match /^_/u.","line":79,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":79,"endColumn":70,"suggestions":[{"messageId":"removeVar","data":{"varName":"model"},"fix":{"range":[2347,2361],"text":""},"desc":"Remove unused variable 'model'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'handleTemplateInject' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":91,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":91,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"handleTemplateInject"},"fix":{"range":[2617,2644],"text":""},"desc":"Remove unused variable 'handleTemplateInject'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'scrollToBottom' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":104,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"scrollToBottom"},"fix":{"range":[2925,2940],"text":""},"desc":"Remove unused variable 'scrollToBottom'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'focusInput' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":105,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":105,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"focusInput"},"fix":{"range":[2939,2956],"text":""},"desc":"Remove unused variable 'focusInput'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'dispatch'. Either include it or remove the dependency array.","line":144,"column":6,"nodeType":"ArrayExpression","endLine":144,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [dispatch, selectedText]","fix":{"range":[4218,4232],"text":"[dispatch, selectedText]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'scrollAreaRef'. Either include it or remove the dependency array.","line":236,"column":6,"nodeType":"ArrayExpression","endLine":236,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [scrollAreaRef]","fix":{"range":[7005,7007],"text":"[scrollAreaRef]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'scrollAreaRef'. Either include it or remove the dependency array.","line":264,"column":6,"nodeType":"ArrayExpression","endLine":264,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [scrollAreaRef, state.messages]","fix":{"range":[7835,7851],"text":"[scrollAreaRef, state.messages]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 修复后的智能聊天中心组件\r\n * 使用简化的 API 调用逻辑，避免无限循环\r\n */\r\n\r\n\"use client\"\r\n\r\nimport React, { useEffect, useMemo, useRef, useCallback, useState } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Plus, Clock, X } from 'lucide-react'\r\nimport { ALLOWED_MODELS } from '@/lib/ai/models'\r\nimport { VIRTUAL_SCROLL_CONFIG } from '@/lib/config/chat-config'\r\n\r\n// 导入子组件\r\nimport { ChatHeader } from './chat-header'\r\nimport { ChatMessages } from './chat-messages'\r\nimport { ChatMessagesVirtual } from './chat-messages-virtual'\r\nimport { ChatInput } from './chat-input'\r\nimport { TimelineScrollbar } from './timeline-scrollbar'\r\n\r\n// 导入 hooks\r\nimport { useChatState } from '@/hooks/use-chat-state'\r\nimport { useChatActionsFixed as useChatActions } from '@/hooks/use-chat-actions-fixed'\r\nimport { useChatEffects } from '@/hooks/use-chat-effects'\r\nimport { useModelState } from '@/hooks/use-model-state'\r\n\r\n// 导入类型和常量\r\nimport type { SmartChatCenterProps, Conversation } from '@/types/chat'\r\nimport { DEFAULT_CHAT_SETTINGS } from '@/types/chat'\r\n\r\n/**\r\n * 修复后的智能聊天中心组件\r\n */\r\nexport const SmartChatCenterV2Fixed = React.memo<SmartChatCenterProps>(({\r\n  conversation,\r\n  conversations = [],\r\n  selectedModel,\r\n  selectedText,\r\n  editorContextEnabled = false,\r\n  editorContent,\r\n  onUpdateConversation,\r\n  onCreateConversation,\r\n  onDeleteConversation,\r\n  onSelectConversation,\r\n  onSelectedModelChange,\r\n}) => {\r\n  // 统一模型状态管理\r\n  const {\r\n    selectedModel: currentModel,\r\n    setSelectedModel,\r\n    getCurrentModel,\r\n    isInitialized: modelInitialized,\r\n    validateModel\r\n  } = useModelState(selectedModel)\r\n\r\n  // 定时器引用，用于防止内存泄漏\r\n  const adjustHeightTimerRef = useRef<NodeJS.Timeout | null>(null)\r\n  \r\n  // 时间轴相关状态\r\n  const [currentMessageId, setCurrentMessageId] = useState<string | null>(null)\r\n  const [showTimeline, setShowTimeline] = useState<boolean>(true)\r\n\r\n  // 初始化设置（使用统一的模型状态）\r\n  const initialSettings = useMemo(() => {\r\n    return {\r\n      ...DEFAULT_CHAT_SETTINGS,\r\n      modelId: currentModel,\r\n      contextAware: !!editorContextEnabled,\r\n    }\r\n  }, [currentModel, editorContextEnabled])\r\n\r\n  // 状态管理\r\n  const { state, dispatch } = useChatState({\r\n    settings: initialSettings,\r\n    messages: [], // 不从 conversation 初始化，避免循环\r\n  })\r\n\r\n  // 包装onCreateConversation为Promise形式\r\n  const createConversationWrapper = useCallback(async (model?: string): Promise<Conversation | null> => {\r\n    onCreateConversation()\r\n    return null // 因为原始函数返回void，我们返回null\r\n  }, [onCreateConversation])\r\n\r\n  // 操作管理\r\n  const {\r\n    sendMessage,\r\n    stopGeneration,\r\n    copyMessage,\r\n    retryMessage,\r\n    updateSettings,\r\n    handleTemplateInject,\r\n  } = useChatActions({\r\n    state,\r\n    dispatch,\r\n    conversation,\r\n    onUpdateConversation,\r\n    getCurrentModel, // 传递统一的模型获取函数\r\n    onCreateConversation: createConversationWrapper, // 传递包装后的对话创建函数\r\n    onSelectConversation, // 传递对话选择函数\r\n  })\r\n\r\n  // 副作用管理\r\n  const {\r\n    scrollToBottom,\r\n    focusInput,\r\n    scrollAreaRef,\r\n    textareaRef,\r\n  } = useChatEffects({\r\n    state,\r\n    dispatch,\r\n    onSendMessage: sendMessage,\r\n    onStopGeneration: stopGeneration,\r\n    onCreateConversation,\r\n  })\r\n\r\n  // 处理对话切换 - 优化消息同步逻辑\r\n  useEffect(() => {\r\n    if (conversation?.id && Array.isArray(conversation.messages)) {\r\n      // 使用批量设置消息，减少渲染次数\r\n      dispatch({ type: 'SET_MESSAGES', payload: conversation.messages })\r\n      // 清除加载状态\r\n      dispatch({ type: 'SET_LOADING', payload: false })\r\n      dispatch({ type: 'SET_ERROR', payload: null })\r\n    } else if (!conversation?.id) {\r\n      // 没有选择对话时清空消息\r\n      dispatch({ type: 'CLEAR_MESSAGES' })\r\n      dispatch({ type: 'SET_LOADING', payload: false })\r\n      dispatch({ type: 'SET_ERROR', payload: null })\r\n    } else if (conversation?.id && !Array.isArray(conversation.messages)) {\r\n      // 有对话但消息尚未加载，显示加载状态\r\n      dispatch({ type: 'SET_LOADING', payload: true })\r\n      dispatch({ type: 'SET_ERROR', payload: null })\r\n    }\r\n  }, [conversation?.id, conversation?.messages, dispatch])\r\n\r\n  // 处理选中文本 - 只在选中文本变化时触发\r\n  useEffect(() => {\r\n    if (selectedText && selectedText.trim()) {\r\n      dispatch({ \r\n        type: 'SET_INPUT', \r\n        payload: `请帮我优化这段文本：\\n\\n\"${selectedText}\"\\n\\n` \r\n      })\r\n    }\r\n  }, [selectedText])\r\n\r\n  // 处理标题编辑\r\n  const handleTitleEdit = () => {\r\n    if (state.editingTitle && state.tempTitle.trim() && conversation) {\r\n      onUpdateConversation(conversation.id, { title: state.tempTitle.trim() })\r\n    }\r\n    dispatch({ type: 'SET_EDITING_TITLE', payload: !state.editingTitle })\r\n    if (!state.editingTitle) {\r\n      dispatch({ type: 'SET_TEMP_TITLE', payload: conversation?.title || '' })\r\n    }\r\n  }\r\n\r\n  const handleTitleChange = (title: string) => {\r\n    dispatch({ type: 'SET_TEMP_TITLE', payload: title })\r\n  }\r\n\r\n  const handleTitleSubmit = () => {\r\n    if (state.tempTitle.trim() && conversation) {\r\n      onUpdateConversation(conversation.id, { title: state.tempTitle.trim() })\r\n    }\r\n    dispatch({ type: 'SET_EDITING_TITLE', payload: false })\r\n  }\r\n\r\n  // 处理输入\r\n  const handleInputChange = (value: string) => {\r\n    dispatch({ type: 'SET_INPUT', payload: value })\r\n  }\r\n\r\n  // 处理发送 - 立即重置输入框\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    if (!state.input.trim() || state.isLoading) return\r\n\r\n    // 保存输入内容\r\n    const messageContent = state.input.trim()\r\n    \r\n    // 立即清空输入框状态\r\n    dispatch({ type: 'SET_INPUT', payload: '' })\r\n    \r\n    // 等待状态更新完成后再重置高度\r\n    if (adjustHeightTimerRef.current) {\r\n      clearTimeout(adjustHeightTimerRef.current)\r\n    }\r\n    \r\n    adjustHeightTimerRef.current = setTimeout(() => {\r\n      if (textareaRef.current && 'adjustHeight' in textareaRef.current && typeof textareaRef.current.adjustHeight === 'function') {\r\n        textareaRef.current.adjustHeight(true)\r\n      }\r\n      adjustHeightTimerRef.current = null\r\n    }, 0)\r\n    \r\n    // 异步发送消息\r\n    await sendMessage(messageContent)\r\n  }\r\n\r\n  // 处理设置变更\r\n  const handleSettingsChange = (newSettings: Partial<typeof state.settings>) => {\r\n    updateSettings(newSettings)\r\n    \r\n    if (newSettings.modelId && validateModel(newSettings.modelId)) {\r\n      // 使用统一的模型状态管理\r\n      setSelectedModel(newSettings.modelId)\r\n      onSelectedModelChange?.(newSettings.modelId)\r\n    }\r\n  }\r\n  \r\n  // 同步模型状态到聊天状态（当统一状态更新时）\r\n  useEffect(() => {\r\n    if (modelInitialized && currentModel !== state.settings.modelId) {\r\n      dispatch({\r\n        type: 'SET_SETTINGS',\r\n        payload: { modelId: currentModel }\r\n      })\r\n    }\r\n  }, [currentModel, state.settings.modelId, modelInitialized, dispatch])\r\n\r\n  // 跳转到指定消息\r\n  const jumpToMessage = useCallback((messageId: string) => {\r\n    const element = scrollAreaRef.current?.querySelector(`[data-message-id=\"${messageId}\"]`)\r\n    if (element) {\r\n      element.scrollIntoView({\r\n        behavior: 'smooth',\r\n        block: 'center'\r\n      })\r\n      setCurrentMessageId(messageId)\r\n      \r\n      // 3秒后清除高亮\r\n      setTimeout(() => {\r\n        setCurrentMessageId(null)\r\n      }, 3000)\r\n    }\r\n  }, [])\r\n\r\n  // 使用 Intersection Observer 追踪当前可见消息\r\n  useEffect(() => {\r\n    if (!scrollAreaRef.current) return\r\n\r\n    const observer = new IntersectionObserver(\r\n      (entries) => {\r\n        entries.forEach((entry) => {\r\n          if (entry.isIntersecting && entry.intersectionRatio > 0.5) {\r\n            const messageId = entry.target.getAttribute('data-message-id')\r\n            if (messageId) {\r\n              setCurrentMessageId(messageId)\r\n            }\r\n          }\r\n        })\r\n      },\r\n      {\r\n        root: scrollAreaRef.current,\r\n        rootMargin: '-30% 0px -30% 0px',\r\n        threshold: [0.3, 0.5, 0.7]\r\n      }\r\n    )\r\n\r\n    const messageElements = scrollAreaRef.current.querySelectorAll('[data-message-id]')\r\n    messageElements.forEach((el) => observer.observe(el))\r\n\r\n    return () => observer.disconnect()\r\n  }, [state.messages])\r\n\r\n  // 组件卸载时清理定时器\r\n  useEffect(() => {\r\n    return () => {\r\n      if (adjustHeightTimerRef.current) {\r\n        clearTimeout(adjustHeightTimerRef.current)\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  // 即使没有对话也显示聊天界面，确保输入框始终可用\r\n  // 强制确保组件总是渲染，不管对话状态如何\r\n  return (\r\n    <div className=\"flex flex-col h-full bg-background\" style={{ minHeight: 0, height: '100%' }}>\r\n      {/* 头部 - 紧凑固定高度，只占用左侧1/3空间为对话记录让路 */}\r\n      <div className=\"flex-shrink-0 flex\" style={{ flexShrink: 0 }}>\r\n        <div className=\"w-1/3 min-w-0\">\r\n          <ChatHeader\r\n            conversation={conversation}\r\n            editingTitle={state.editingTitle}\r\n            tempTitle={state.tempTitle}\r\n            isLoading={state.isLoading}\r\n            onEditTitle={handleTitleEdit}\r\n            onTitleChange={handleTitleChange}\r\n            onTitleSubmit={handleTitleSubmit}\r\n          />\r\n        </div>\r\n        {/* 右侧2/3空间预留给未来扩展或保持空白以突出紧凑设计 */}\r\n        <div className=\"flex-1\"></div>\r\n      </div>\r\n\r\n      {/* 消息列表 + 时间轴 - 可滚动区域，明确设置 flex-grow 和 overflow */}\r\n      <div className=\"flex-1 overflow-hidden\" style={{ flexGrow: 1, flexShrink: 1, minHeight: 0, overflow: 'hidden' }}>\r\n        <div className=\"flex h-full relative\">\r\n          {/* 消息列表 */}\r\n          <div className=\"flex-1 overflow-hidden\">\r\n            {/* 根据消息数量自动选择普通或虚拟滚动组件 */}\r\n            {state.messages.length > VIRTUAL_SCROLL_CONFIG.threshold ? (\r\n              <ChatMessagesVirtual\r\n                ref={scrollAreaRef}\r\n                messages={state.messages}\r\n                isLoading={state.isLoading}\r\n                error={state.error}\r\n                onCopyMessage={copyMessage}\r\n                onRetryMessage={retryMessage}\r\n                typingMode={state.typingMode}\r\n                previewContent={state.previewContent}\r\n              />\r\n            ) : (\r\n              <ChatMessages\r\n                ref={scrollAreaRef}\r\n                messages={state.messages}\r\n                isLoading={state.isLoading}\r\n                error={state.error}\r\n                onCopyMessage={copyMessage}\r\n                onRetryMessage={retryMessage}\r\n                typingMode={state.typingMode}\r\n                previewContent={state.previewContent}\r\n              />\r\n            )}\r\n          </div>\r\n          \r\n          {/* 时间轴滚动条 - 智能显示策略 */}\r\n          {showTimeline && state.messages.length > 5 && (\r\n            <div className=\"flex-shrink-0 bg-background border-l border-border/20\">\r\n              {/* 显示策略提示 - 所有情况都显示当前策略 */}\r\n              {state.messages.length > 5 && (\r\n                <div className=\"px-2 py-1 text-xs text-muted-foreground text-center border-b border-border/10 bg-background/50\">\r\n                  {state.messages.length <= 17 ? '对话轮次' :\r\n                   state.messages.length <= 50 ? '关键节点' : \r\n                   state.messages.length <= 100 ? '时间分段' : '章节概览'}\r\n                </div>\r\n              )}\r\n              \r\n              <TimelineScrollbar\r\n                messages={state.messages}\r\n                currentMessageId={currentMessageId}\r\n                onJumpToMessage={jumpToMessage}\r\n                containerHeight={600}\r\n                className=\"py-2 px-2\"\r\n              />\r\n            </div>\r\n          )}\r\n          \r\n          {/* 隐形时间轴触发器 - 右边缘悬浮区域，完全不遮挡对话内容 */}\r\n          {!showTimeline && state.messages.length > 5 && (\r\n            <div \r\n              className=\"absolute top-6 right-0 w-6 h-12 bg-transparent hover:bg-muted/10 transition-all duration-300 flex items-center justify-end group cursor-pointer z-[35] rounded-l-md\"\r\n              onClick={() => setShowTimeline(true)}\r\n              title=\"点击显示时间轴导航\"\r\n            >\r\n              {/* 隐形按钮 - 只在悬停时显示 */}\r\n              <div className=\"opacity-0 group-hover:opacity-100 transition-all duration-300 bg-background/95 backdrop-blur-sm border shadow-lg rounded-full w-5 h-5 flex items-center justify-center group-hover:scale-110 transform group-hover:-translate-x-1\">\r\n                <Clock className=\"w-3 h-3 text-muted-foreground group-hover:text-primary\" />\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* 输入区域 - 固定高度，确保始终可见 */}\r\n      <div className=\"flex-shrink-0\" style={{ flexShrink: 0, minHeight: 'auto' }}>\r\n        <ChatInput\r\n          ref={textareaRef}\r\n          input={state.input}\r\n          isLoading={state.isLoading}\r\n          settings={state.settings}\r\n          selectedText={selectedText}\r\n          onInputChange={handleInputChange}\r\n          onSubmit={handleSubmit}\r\n          onStop={stopGeneration}\r\n          onSettingsChange={handleSettingsChange}\r\n        />\r\n      </div>\r\n    </div>\r\n  )\r\n})\r\n\r\nSmartChatCenterV2Fixed.displayName = 'SmartChatCenterV2Fixed'\r\n\r\nexport { SmartChatCenterV2Fixed as SmartChatCenterV2 }","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\chat\\timeline-scrollbar.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'useState' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"useState"},"fix":{"range":[32,41],"text":""},"desc":"Remove unused variable 'useState'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'useCallback' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"useCallback"},"fix":{"range":[49,62],"text":""},"desc":"Remove unused variable 'useCallback'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'messageId' is defined but never used. Allowed unused args must match /^_/u.","line":22,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":38,"suggestions":[{"messageId":"removeVar","data":{"varName":"messageId"},"fix":{"range":[442,459],"text":""},"desc":"Remove unused variable 'messageId'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useState, useMemo, useCallback } from 'react'\r\n\r\n// 导入现有的消息类型\r\nimport type { ChatMessage } from '@/types/chat'\r\n\r\n// 时间轴数据点接口\r\ninterface TimelinePoint {\r\n  messageId: string\r\n  index: number\r\n  percentage: number\r\n  timestamp: number\r\n  date: Date\r\n  isAIMessage: boolean\r\n}\r\n\r\n// 组件 Props\r\ninterface TimelineScrollbarProps {\r\n  messages: ChatMessage[]\r\n  currentMessageId?: string | null\r\n  onJumpToMessage: (messageId: string) => void\r\n  containerHeight?: number\r\n  className?: string\r\n}\r\n\r\n/**\r\n * 简化版时间轴滚动条组件\r\n * 只保留点击跳转功能，移除悬浮提示框\r\n */\r\n\r\n// 对话轮次提取算法 - 基于user-assistant对话结构\r\nconst getConversationTurns = (messages: ChatMessage[], maxPoints: number) => {\r\n  if (messages.length === 0 || maxPoints <= 0) return []\r\n  if (messages.length === 1) return [messages[0]]\r\n  \r\n  const turns: ChatMessage[] = []\r\n  let lastRole = ''\r\n  \r\n  // 识别对话轮次的转换点\r\n  for (let i = 0; i < messages.length; i++) {\r\n    const message = messages[i]\r\n    \r\n    // 角色切换点或第一条消息\r\n    if (i === 0 || message.role !== lastRole) {\r\n      turns.push(message)\r\n    }\r\n    \r\n    lastRole = message.role\r\n  }\r\n  \r\n  // 总是包含最后一条消息（避免重复）\r\n  if (messages.length > 1) {\r\n    const lastMessage = messages[messages.length - 1]\r\n    if (!turns.some(t => t.id === lastMessage.id)) {\r\n      turns.push(lastMessage)\r\n    }\r\n  }\r\n  \r\n  // 如果轮次数量超过限制，优先保留AI回复和开始/结束\r\n  if (turns.length > maxPoints) {\r\n    const prioritized: ChatMessage[] = []\r\n    \r\n    // 强制保留首尾（避免重复）\r\n    const firstMessage = messages[0]\r\n    const lastMessage = messages[messages.length - 1]\r\n    \r\n    prioritized.push(firstMessage)\r\n    if (messages.length > 1 && lastMessage.id !== firstMessage.id) {\r\n      prioritized.push(lastMessage)\r\n    }\r\n    \r\n    // 优先选择AI回复（通常更重要）\r\n    const aiTurns = turns.filter(m => \r\n      m.role === 'assistant' && \r\n      !prioritized.some(p => p.id === m.id)\r\n    )\r\n    const remainingSlots = maxPoints - prioritized.length\r\n    \r\n    for (let i = 0; i < Math.min(aiTurns.length, remainingSlots); i++) {\r\n      prioritized.push(aiTurns[i])\r\n    }\r\n    \r\n    // 优化排序：创建索引映射避免重复indexOf调用\r\n    const messageIndexMap = new Map()\r\n    messages.forEach((msg, index) => messageIndexMap.set(msg.id, index))\r\n    \r\n    return prioritized.sort((a, b) => \r\n      (messageIndexMap.get(a.id) || 0) - (messageIndexMap.get(b.id) || 0)\r\n    )\r\n  }\r\n  \r\n  return turns\r\n}\r\n\r\n// 关键消息点提取算法 - 基于内容和时间间隔\r\nconst getKeyMessagePoints = (messages: ChatMessage[], maxPoints: number) => {\r\n  const keyPoints: ChatMessage[] = []\r\n  const timeGaps: number[] = []\r\n  \r\n  // 计算时间间隔，寻找对话的自然分段\r\n  for (let i = 1; i < messages.length; i++) {\r\n    timeGaps.push(messages[i].timestamp - messages[i-1].timestamp)\r\n  }\r\n  \r\n  const avgGap = timeGaps.reduce((a, b) => a + b, 0) / timeGaps.length\r\n  const longGapThreshold = avgGap * 3 // 3倍平均间隔认为是长停顿\r\n  \r\n  // 总是包含首尾消息（避免重复）\r\n  const firstMessage = messages[0]\r\n  const lastMessage = messages[messages.length - 1]\r\n  \r\n  keyPoints.push(firstMessage)\r\n  if (messages.length > 1 && lastMessage.id !== firstMessage.id) {\r\n    keyPoints.push(lastMessage)\r\n  }\r\n  \r\n  // 查找长停顿后的消息（对话重新开始点）\r\n  for (let i = 1; i < messages.length && keyPoints.length < maxPoints; i++) {\r\n    const gap = messages[i].timestamp - messages[i-1].timestamp\r\n    if (gap > longGapThreshold) {\r\n      const message = messages[i]\r\n      // 避免添加重复的消息\r\n      if (!keyPoints.some(p => p.id === message.id)) {\r\n        keyPoints.push(message)\r\n      }\r\n    }\r\n  }\r\n  \r\n  // 如果还有空间，均匀补充中间点\r\n  while (keyPoints.length < maxPoints && keyPoints.length < messages.length) {\r\n    const step = Math.floor(messages.length / (maxPoints - keyPoints.length + 1))\r\n    const nextIndex = keyPoints.length * step\r\n    if (nextIndex < messages.length) {\r\n      const message = messages[nextIndex]\r\n      if (!keyPoints.some(p => p.id === message.id)) {\r\n        keyPoints.push(message)\r\n      } else break\r\n    } else break\r\n  }\r\n  \r\n  // 按时间戳排序\r\n  return keyPoints.sort((a, b) => a.timestamp - b.timestamp)\r\n}\r\n\r\n// 时间段分组算法\r\nconst getTimeBasedGroups = (messages: ChatMessage[], maxGroups: number) => {\r\n  const groups: ChatMessage[] = []\r\n  const totalDuration = messages[messages.length - 1].timestamp - messages[0].timestamp\r\n  const groupDuration = totalDuration / maxGroups\r\n  \r\n  for (let i = 0; i < maxGroups; i++) {\r\n    const groupStart = messages[0].timestamp + i * groupDuration\r\n    const groupEnd = groupStart + groupDuration\r\n    \r\n    // 找到该时间段内的代表性消息（通常选择AI回复）\r\n    const groupMessages = messages.filter(m => \r\n      m.timestamp >= groupStart && m.timestamp < groupEnd\r\n    )\r\n    \r\n    if (groupMessages.length > 0) {\r\n      // 优先选择AI助手的回复作为代表点\r\n      const aiMessage = groupMessages.find(m => m.role === 'assistant')\r\n      groups.push(aiMessage || groupMessages[Math.floor(groupMessages.length / 2)])\r\n    }\r\n  }\r\n  \r\n  return groups\r\n}\r\n\r\n// 超长对话的渐进式披露点\r\nconst getProgressiveDisclosurePoints = (messages: ChatMessage[], maxPoints: number) => {\r\n  const points: ChatMessage[] = []\r\n  \r\n  // 始终包含开始和结束（避免重复）\r\n  const firstMessage = messages[0]\r\n  const lastMessage = messages[messages.length - 1]\r\n  \r\n  points.push(firstMessage)\r\n  if (messages.length > 1 && lastMessage.id !== firstMessage.id) {\r\n    points.push(lastMessage)\r\n  }\r\n  \r\n  // 找到对话的\"章节\"分界点（基于长时间间隔）\r\n  const timeGaps: {index: number, gap: number}[] = []\r\n  for (let i = 1; i < messages.length; i++) {\r\n    const gap = messages[i].timestamp - messages[i-1].timestamp\r\n    timeGaps.push({index: i, gap})\r\n  }\r\n  \r\n  // 按间隔时间排序，选择最大的几个间隔作为章节分界\r\n  timeGaps.sort((a, b) => b.gap - a.gap)\r\n  const chapterBreaks = timeGaps.slice(0, maxPoints - 2).sort((a, b) => a.index - b.index)\r\n  \r\n  chapterBreaks.forEach(breakPoint => {\r\n    if (breakPoint.index < messages.length) {\r\n      const message = messages[breakPoint.index]\r\n      // 避免添加重复的消息\r\n      if (!points.some(p => p.id === message.id)) {\r\n        points.push(message)\r\n      }\r\n    }\r\n  })\r\n  \r\n  return points.sort((a, b) => a.timestamp - b.timestamp)\r\n}\r\n\r\nexport const TimelineScrollbar: React.FC<TimelineScrollbarProps> = ({\r\n  messages,\r\n  currentMessageId,\r\n  onJumpToMessage,\r\n  containerHeight = 400,\r\n  className = \"\"\r\n}) => {\r\n  // 三级渐进式显示策略 - 基于UX研究的最佳实践\r\n  const timelineData = useMemo((): TimelinePoint[] => {\r\n    if (messages.length === 0) return []\r\n    \r\n    const firstTime = messages[0].timestamp\r\n    const lastTime = messages[messages.length - 1].timestamp\r\n    const totalDuration = lastTime - firstTime\r\n    \r\n    // 智能采样策略：基于对话结构和消息数量\r\n    let samplesToShow: ChatMessage[] = []\r\n    \r\n    if (messages.length <= 17) {\r\n      // ≤ 17条：智能选择关键对话轮次，避免过度拥挤\r\n      samplesToShow = getConversationTurns(messages, Math.min(messages.length, 12))\r\n    } else if (messages.length <= 50) {\r\n      // 18-50条：关键点 + 时间段标记策略\r\n      samplesToShow = getKeyMessagePoints(messages, 12) // 显示最多12个关键点\r\n    } else if (messages.length <= 100) {\r\n      // 51-100条：时间段分组 + 重要节点\r\n      samplesToShow = getTimeBasedGroups(messages, 10) // 10个时间段代表点\r\n    } else {\r\n      // > 100条：超长对话的三级渐进披露\r\n      samplesToShow = getProgressiveDisclosurePoints(messages, 8) // 8个主要节点\r\n    }\r\n    \r\n    // 确保去重：按messageId去重，保持原始顺序\r\n    const uniqueSamples = samplesToShow.filter((message, index, array) => \r\n      array.findIndex(m => m.id === message.id) === index\r\n    )\r\n    \r\n    // 智能分布算法：混合时间和结构\r\n    const timelinePoints = uniqueSamples.map((message, arrayIndex) => {\r\n      const originalIndex = messages.findIndex(m => m.id === message.id)\r\n      \r\n      // 计算基于对话结构的位置（考虑消息序号）\r\n      const structuralPercentage = uniqueSamples.length > 1 \r\n        ? (arrayIndex / (uniqueSamples.length - 1)) * 100 \r\n        : 0\r\n      \r\n      // 计算基于时间的位置\r\n      const relativeTime = message.timestamp - firstTime\r\n      const timePercentage = totalDuration > 0 \r\n        ? (relativeTime / totalDuration) * 100 \r\n        : structuralPercentage\r\n      \r\n      // 智能权重策略\r\n      let finalPercentage = structuralPercentage\r\n      \r\n      if (totalDuration > 0) {\r\n        // 分析时间分布的均匀程度\r\n        const timeSpread = totalDuration / (1000 * 60) // 转换为分钟\r\n        \r\n        if (timeSpread > 60) {\r\n          // >1小时的对话：时间权重70%，结构权重30%\r\n          finalPercentage = timePercentage * 0.7 + structuralPercentage * 0.3\r\n        } else if (timeSpread > 10) {\r\n          // 10分钟-1小时：时间权重50%，结构权重50%\r\n          finalPercentage = timePercentage * 0.5 + structuralPercentage * 0.5\r\n        } else {\r\n          // <10分钟（高频对话）：时间权重20%，结构权重80%\r\n          finalPercentage = timePercentage * 0.2 + structuralPercentage * 0.8\r\n        }\r\n      }\r\n      \r\n      return {\r\n        messageId: message.id,\r\n        index: originalIndex,\r\n        percentage: finalPercentage,\r\n        timestamp: message.timestamp,\r\n        date: new Date(message.timestamp),\r\n        isAIMessage: message.role === 'assistant'\r\n      }\r\n    })\r\n    \r\n    // 间距过滤逻辑 - 根据消息数量调整策略\r\n    const filteredPoints: TimelinePoint[] = []\r\n    let lastPercentage = -10\r\n    \r\n    // 根据消息数量和时间跨度调整间距要求\r\n    const timeSpread = totalDuration / (1000 * 60) // 分钟\r\n    let minSpacing = 6 // 默认6%\r\n    \r\n    if (messages.length <= 17) {\r\n      minSpacing = 2 // ≤17条消息：宽松间距，显示更多关键点\r\n    } else if (messages.length <= 50) {\r\n      minSpacing = 4 // 18-50条：中等间距\r\n    }\r\n    \r\n    // 高频对话（<10分钟）需要更宽松的间距\r\n    if (timeSpread < 10) {\r\n      minSpacing = Math.max(1, minSpacing - 2)\r\n    }\r\n    \r\n    for (const point of timelinePoints) {\r\n      if (point.percentage - lastPercentage >= minSpacing || filteredPoints.length === 0) {\r\n        filteredPoints.push(point)\r\n        lastPercentage = point.percentage\r\n      }\r\n    }\r\n    \r\n    return filteredPoints\r\n  }, [messages])\r\n\r\n  // 优化双色系统 - 清晰的颜色对比\r\n  const getMessageColor = (point: TimelinePoint, isActive: boolean) => {\r\n    if (isActive) return 'bg-orange-500 shadow-xl ring-2 ring-orange-300/50'\r\n    \r\n    if (point.isAIMessage) {\r\n      // AI消息：鲜明蓝色\r\n      return 'bg-blue-500 hover:bg-blue-600 hover:shadow-md border border-blue-300/30 shadow-blue-200/10'\r\n    } else {\r\n      // 用户消息：深灰色\r\n      return 'bg-slate-600 hover:bg-slate-700 hover:shadow-md border border-slate-400/30 shadow-slate-200/10'\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className={`relative w-10 flex items-center justify-center ${className}`}>\r\n      {/* 时间轴轨道 */}\r\n      <div\r\n        className=\"relative w-8 cursor-pointer transition-all duration-200\"\r\n        style={{ \r\n          height: `${containerHeight - 60}px`,\r\n          marginTop: '20px'\r\n        }}\r\n      >\r\n        {/* 背景轨道 */}\r\n        <div className=\"absolute left-1/2 top-0 w-1 h-full bg-muted/30 rounded-full transform -translate-x-1/2\" />\r\n        {/* 细线连接点 */}\r\n        <div className=\"absolute left-1/2 top-0 w-px h-full bg-border/40 transform -translate-x-1/2\" />\r\n        \r\n        {/* 智能圆点 */}\r\n        {timelineData.map((point) => {\r\n          const isActive = currentMessageId === point.messageId\r\n          \r\n          return (\r\n            <div\r\n              key={point.messageId}\r\n              className={`absolute rounded-full cursor-pointer transform -translate-x-1/2 transition-all duration-300 ${\r\n                getMessageColor(point, isActive)\r\n              } ${\r\n                isActive \r\n                  ? 'w-4 h-4 z-[25]' \r\n                  : 'w-2.5 h-2.5 hover:w-3.5 hover:h-3.5 hover:z-[15] hover:scale-110'\r\n              }`}\r\n              style={{\r\n                top: `${point.percentage}%`,\r\n                left: '50%'\r\n              }}\r\n              onClick={(e) => {\r\n                e.stopPropagation()\r\n                onJumpToMessage(point.messageId)\r\n              }}\r\n              title={`跳转到${point.isAIMessage ? 'AI' : '用户'}消息 (#${point.index + 1})`}\r\n            >\r\n              {/* 激活状态的光环效果 */}\r\n              {isActive && (\r\n                <div className=\"absolute inset-0 rounded-full animate-ping bg-orange-400/40\" />\r\n              )}\r\n            </div>\r\n          )\r\n        })}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nTimelineScrollbar.displayName = 'TimelineScrollbar'","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\documents\\document-editor.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'document' is defined but never used. Allowed unused args must match /^_/u.","line":30,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"document"},"fix":{"range":[882,900],"text":""},"desc":"Remove unused variable 'document'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":119,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":119,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Label } from \"@/components/ui/label\"\nimport { Save, FileText, Clock, User, Hash } from \"lucide-react\"\nimport { useToast } from \"@/hooks/use-toast\"\n\ninterface Document {\n  id?: string\n  title: string\n  content: string\n  category: string\n  tags: string[]\n  version?: number\n  wordCount?: number\n  status?: string\n  author?: string\n  createdAt?: string\n  updatedAt?: string\n}\n\ninterface DocumentEditorProps {\n  document?: Document\n  onSave?: (document: Document) => void\n  onCancel?: () => void\n}\n\nexport function DocumentEditor({ document, onSave, onCancel }: DocumentEditorProps) {\n  const [formData, setFormData] = useState<Document>({\n    title: \"\",\n    content: \"\",\n    category: \"短视频文案\",\n    tags: [],\n  })\n  const [newTag, setNewTag] = useState(\"\")\n  const [saving, setSaving] = useState(false)\n  const [wordCount, setWordCount] = useState(0)\n  const { toast } = useToast()\n\n  const categories = [\"短视频文案\", \"营销文案\", \"产品介绍\", \"教程内容\", \"创意脚本\"]\n\n  useEffect(() => {\n    if (document) {\n      setFormData(document)\n    }\n  }, [document])\n\n  useEffect(() => {\n    setWordCount(formData.content.split(/\\s+/).filter((word) => word.length > 0).length)\n  }, [formData.content])\n\n  const handleInputChange = (field: keyof Document, value: any) => {\n    setFormData((prev) => ({\n      ...prev,\n      [field]: value,\n    }))\n  }\n\n  const handleAddTag = () => {\n    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {\n      setFormData((prev) => ({\n        ...prev,\n        tags: [...prev.tags, newTag.trim()],\n      }))\n      setNewTag(\"\")\n    }\n  }\n\n  const handleRemoveTag = (tagToRemove: string) => {\n    setFormData((prev) => ({\n      ...prev,\n      tags: prev.tags.filter((tag) => tag !== tagToRemove),\n    }))\n  }\n\n  const handleSave = async () => {\n    if (!formData.title.trim() || !formData.content.trim()) {\n      toast({\n        title: \"保存失败\",\n        description: \"标题和内容不能为空\",\n        variant: \"destructive\",\n      })\n      return\n    }\n\n    setSaving(true)\n    try {\n      const method = document?.id ? \"PUT\" : \"POST\"\n      const url = document?.id ? `/api/documents/${document.id}` : \"/api/documents\"\n\n      const response = await fetch(url, {\n        method,\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          ...formData,\n          versionComment: document?.id ? \"文档更新\" : \"创建文档\",\n        }),\n      })\n\n      const result = await response.json()\n\n      if (result.success) {\n        toast({\n          title: \"保存成功\",\n          description: result.message || \"文档已保存\",\n        })\n        onSave?.(result.data)\n      } else {\n        throw new Error(result.error)\n      }\n    } catch (error) {\n      toast({\n        title: \"保存失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setSaving(false)\n    }\n  }\n\n  return (\n    <div className=\"max-w-4xl mx-auto space-y-6\">\n      {/* 文档信息 */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <FileText className=\"h-5 w-5\" />\n            {document?.id ? \"编辑文档\" : \"创建文档\"}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* 标题 */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"title\">文档标题</Label>\n            <Input\n              id=\"title\"\n              value={formData.title}\n              onChange={(e) => handleInputChange(\"title\", e.target.value)}\n              placeholder=\"请输入文档标题...\"\n              className=\"text-lg\"\n            />\n          </div>\n\n          {/* 分类和标签 */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">文档分类</Label>\n              <Select value={formData.category} onValueChange={(value) => handleInputChange(\"category\", value)}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"选择分类\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {categories.map((category) => (\n                    <SelectItem key={category} value={category}>\n                      {category}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"tags\">标签</Label>\n              <div className=\"flex gap-2\">\n                <Input\n                  id=\"tags\"\n                  value={newTag}\n                  onChange={(e) => setNewTag(e.target.value)}\n                  placeholder=\"添加标签...\"\n                  onKeyDown={(e) => {\n                    if (e.key === \"Enter\") {\n                      e.preventDefault()\n                      handleAddTag()\n                    }\n                  }}\n                />\n                <Button type=\"button\" onClick={handleAddTag} variant=\"outline\" size=\"sm\">\n                  添加\n                </Button>\n              </div>\n              <div className=\"flex flex-wrap gap-2 mt-2\">\n                {formData.tags.map((tag) => (\n                  <Badge key={tag} variant=\"secondary\" className=\"cursor-pointer\" onClick={() => handleRemoveTag(tag)}>\n                    {tag} ×\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* 内容编辑器 */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle>文档内容</CardTitle>\n            <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n              <div className=\"flex items-center gap-1\">\n                <Hash className=\"h-4 w-4\" />\n                <span>{wordCount} 字</span>\n              </div>\n              {document?.version && (\n                <div className=\"flex items-center gap-1\">\n                  <Clock className=\"h-4 w-4\" />\n                  <span>版本 {document.version}</span>\n                </div>\n              )}\n              {document?.author && (\n                <div className=\"flex items-center gap-1\">\n                  <User className=\"h-4 w-4\" />\n                  <span>{document.author}</span>\n                </div>\n              )}\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <Textarea\n            value={formData.content}\n            onChange={(e) => handleInputChange(\"content\", e.target.value)}\n            placeholder=\"请输入文档内容...\"\n            className=\"min-h-[400px] text-base leading-relaxed\"\n          />\n        </CardContent>\n      </Card>\n\n      {/* 操作按钮 */}\n      <div className=\"flex justify-end gap-2\">\n        {onCancel && (\n          <Button variant=\"outline\" onClick={onCancel}>\n            取消\n          </Button>\n        )}\n        <Button onClick={handleSave} disabled={saving}>\n          {saving ? (\n            <>\n              <Clock className=\"h-4 w-4 mr-2 animate-spin\" />\n              保存中...\n            </>\n          ) : (\n            <>\n              <Save className=\"h-4 w-4 mr-2\" />\n              保存文档\n            </>\n          )}\n        </Button>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\documents\\document-list.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'document' is defined but never used. Allowed unused args must match /^_/u.","line":28,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"document"},"fix":{"range":[832,850],"text":""},"desc":"Remove unused variable 'document'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'document' is defined but never used. Allowed unused args must match /^_/u.","line":29,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"document"},"fix":{"range":[873,891],"text":""},"desc":"Remove unused variable 'document'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":56,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchDocuments'. Either include it or remove the dependency array.","line":69,"column":6,"nodeType":"ArrayExpression","endLine":69,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [selectedCategory, searchTerm, fetchDocuments]","fix":{"range":[1989,2019],"text":"[selectedCategory, searchTerm, fetchDocuments]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":88,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":88,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Search, Filter, Edit, Trash2, Download, Eye, Clock, User, Hash } from \"lucide-react\"\r\nimport { useToast } from \"@/hooks/use-toast\"\r\n\r\ninterface Document {\r\n  id: string\r\n  title: string\r\n  content: string\r\n  category: string\r\n  tags: string[]\r\n  createdAt: string\r\n  updatedAt: string\r\n  version: number\r\n  wordCount: number\r\n  status: string\r\n  author: string\r\n  aiGenerated: boolean\r\n}\r\n\r\ninterface DocumentListProps {\r\n  onEdit?: (document: Document) => void\r\n  onView?: (document: Document) => void\r\n}\r\n\r\nexport function DocumentList({ onEdit, onView }: DocumentListProps) {\r\n  const [documents, setDocuments] = useState<Document[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [searchTerm, setSearchTerm] = useState(\"\")\r\n  const [selectedCategory, setSelectedCategory] = useState(\"all\")\r\n  const [sortBy, setSortBy] = useState(\"updatedAt\")\r\n  const { toast } = useToast()\r\n\r\n  const categories = [\"all\", \"短视频文案\", \"营销文案\", \"产品介绍\", \"教程内容\", \"创意脚本\"]\r\n\r\n  const fetchDocuments = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const params = new URLSearchParams({\r\n        category: selectedCategory,\r\n        search: searchTerm,\r\n      })\r\n\r\n      const response = await fetch(`/api/documents?${params}`)\r\n      const result = await response.json()\r\n\r\n      if (result.success) {\r\n        setDocuments(result.data)\r\n      }\r\n    } catch (error) {\r\n      toast({\r\n        title: \"获取文档失败\",\r\n        description: \"请稍后重试\",\r\n        variant: \"destructive\",\r\n      })\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    fetchDocuments()\r\n  }, [selectedCategory, searchTerm])\r\n\r\n  const handleDelete = async (id: string) => {\r\n    if (!confirm(\"确定要删除这个文档吗？\")) return\r\n\r\n    try {\r\n      const response = await fetch(`/api/documents/${id}`, {\r\n        method: \"DELETE\",\r\n      })\r\n\r\n      const result = await response.json()\r\n\r\n      if (result.success) {\r\n        toast({\r\n          title: \"删除成功\",\r\n          description: \"文档已删除\",\r\n        })\r\n        fetchDocuments()\r\n      }\r\n    } catch (error) {\r\n      toast({\r\n        title: \"删除失败\",\r\n        description: \"请稍后重试\",\r\n        variant: \"destructive\",\r\n      })\r\n    }\r\n  }\r\n\r\n  const handleExport = (document: Document) => {\r\n    const content = `# ${document.title}\\n\\n分类: ${document.category}\\n标签: ${document.tags.join(\", \")}\\n作者: ${document.author}\\n创建时间: ${new Date(document.createdAt).toLocaleString(\"zh-CN\")}\\n\\n---\\n\\n${document.content}`\r\n\r\n    const blob = new Blob([content], { type: \"text/markdown\" })\r\n    const url = URL.createObjectURL(blob)\r\n    const a = window.document.createElement(\"a\")\r\n    a.href = url\r\n    a.download = `${document.title}.md`\r\n    a.click()\r\n    URL.revokeObjectURL(url)\r\n  }\r\n\r\n  const formatDate = (dateString: string): string => {\r\n    const date = new Date(dateString)\r\n    const now = new Date()\r\n    const diffInHours = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60))\r\n\r\n    if (diffInHours < 1) return \"刚刚\"\r\n    if (diffInHours < 24) return `${diffInHours}小时前`\r\n    const diffInDays = Math.floor(diffInHours / 24)\r\n    if (diffInDays < 7) return `${diffInDays}天前`\r\n    return date.toLocaleDateString(\"zh-CN\")\r\n  }\r\n\r\n  const getStatusColor = (status: string): string => {\r\n    switch (status) {\r\n      case \"published\":\r\n        return \"bg-green-100 text-green-800\"\r\n      case \"draft\":\r\n        return \"bg-yellow-100 text-yellow-800\"\r\n      case \"archived\":\r\n        return \"bg-gray-100 text-gray-800\"\r\n      default:\r\n        return \"bg-gray-100 text-gray-800\"\r\n    }\r\n  }\r\n\r\n  const getStatusText = (status: string): string => {\r\n    switch (status) {\r\n      case \"published\":\r\n        return \"已发布\"\r\n      case \"draft\":\r\n        return \"草稿\"\r\n      case \"archived\":\r\n        return \"已归档\"\r\n      default:\r\n        return \"未知\"\r\n    }\r\n  }\r\n\r\n  // 排序文档\r\n  const sortedDocuments = [...documents].sort((a, b) => {\r\n    switch (sortBy) {\r\n      case \"title\":\r\n        return a.title.localeCompare(b.title)\r\n      case \"createdAt\":\r\n        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\r\n      case \"updatedAt\":\r\n        return new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime()\r\n      case \"wordCount\":\r\n        return b.wordCount - a.wordCount\r\n      default:\r\n        return 0\r\n    }\r\n  })\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-64\">\r\n        <div className=\"text-muted-foreground\">加载中...</div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* 搜索和筛选 */}\r\n      <Card>\r\n        <CardContent className=\"p-4\">\r\n          <div className=\"flex flex-col md:flex-row gap-4\">\r\n            <div className=\"flex-1\">\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\r\n                <Input\r\n                  placeholder=\"搜索文档标题或内容...\"\r\n                  value={searchTerm}\r\n                  onChange={(e) => setSearchTerm(e.target.value)}\r\n                  className=\"pl-10\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex gap-2\">\r\n              <Select value={selectedCategory} onValueChange={setSelectedCategory}>\r\n                <SelectTrigger className=\"w-40\">\r\n                  <SelectValue placeholder=\"分类\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"all\">全部分类</SelectItem>\r\n                  {categories.slice(1).map((category) => (\r\n                    <SelectItem key={category} value={category}>\r\n                      {category}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n\r\n              <Select value={sortBy} onValueChange={setSortBy}>\r\n                <SelectTrigger className=\"w-32\">\r\n                  <SelectValue placeholder=\"排序\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"updatedAt\">更新时间</SelectItem>\r\n                  <SelectItem value=\"createdAt\">创建时间</SelectItem>\r\n                  <SelectItem value=\"title\">标题</SelectItem>\r\n                  <SelectItem value=\"wordCount\">字数</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* 文档列表 */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n        {sortedDocuments.map((document) => (\r\n          <Card key={document.id} className=\"hover:shadow-lg transition-shadow\">\r\n            <CardHeader className=\"pb-3\">\r\n              <div className=\"flex items-start justify-between\">\r\n                <CardTitle className=\"text-lg line-clamp-2 flex-1\">{document.title}</CardTitle>\r\n                <div className=\"flex items-center gap-1 ml-2\">\r\n                  {document.aiGenerated && (\r\n                    <Badge variant=\"outline\" className=\"text-xs\">\r\n                      AI\r\n                    </Badge>\r\n                  )}\r\n                  <Badge className={`text-xs ${getStatusColor(document.status)}`}>\r\n                    {getStatusText(document.status)}\r\n                  </Badge>\r\n                </div>\r\n              </div>\r\n            </CardHeader>\r\n\r\n            <CardContent className=\"space-y-4\">\r\n              <div className=\"text-sm text-muted-foreground line-clamp-3\">{document.content}</div>\r\n\r\n              <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\r\n                <div className=\"flex items-center gap-1\">\r\n                  <Hash className=\"h-3 w-3\" />\r\n                  <span>{document.wordCount}字</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <Clock className=\"h-3 w-3\" />\r\n                  <span>v{document.version}</span>\r\n                </div>\r\n                <div className=\"flex items-center gap-1\">\r\n                  <User className=\"h-3 w-3\" />\r\n                  <span>{document.author}</span>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center justify-between\">\r\n                <div className=\"flex flex-wrap gap-1\">\r\n                  <Badge variant=\"secondary\" className=\"text-xs\">\r\n                    {document.category}\r\n                  </Badge>\r\n                  {document.tags.slice(0, 2).map((tag) => (\r\n                    <Badge key={tag} variant=\"outline\" className=\"text-xs\">\r\n                      {tag}\r\n                    </Badge>\r\n                  ))}\r\n                </div>\r\n                <span className=\"text-xs text-muted-foreground\">{formatDate(document.updatedAt)}</span>\r\n              </div>\r\n\r\n              <div className=\"flex gap-2 pt-2\">\r\n                <Button variant=\"outline\" size=\"sm\" onClick={() => onView?.(document)}>\r\n                  <Eye className=\"h-3 w-3 mr-1\" />\r\n                  查看\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\" onClick={() => onEdit?.(document)}>\r\n                  <Edit className=\"h-3 w-3 mr-1\" />\r\n                  编辑\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\" onClick={() => handleExport(document)}>\r\n                  <Download className=\"h-3 w-3 mr-1\" />\r\n                  导出\r\n                </Button>\r\n                <Button variant=\"outline\" size=\"sm\" onClick={() => handleDelete(document.id)}>\r\n                  <Trash2 className=\"h-3 w-3 mr-1\" />\r\n                  删除\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n      {sortedDocuments.length === 0 && (\r\n        <div className=\"text-center py-12\">\r\n          <Filter className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\r\n          <p className=\"text-muted-foreground\">没有找到符合条件的文档</p>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\documents\\markdown-editor.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'document' is defined but never used. Allowed unused args must match /^_/u.","line":32,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"document"},"fix":{"range":[947,965],"text":""},"desc":"Remove unused variable 'document'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":127,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":127,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nimport { Badge } from \"@/components/ui/badge\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Label } from \"@/components/ui/label\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { Save, Eye, Edit3, Hash, Clock, X, Shield, AlertTriangle } from \"lucide-react\"\nimport { useToast } from \"@/hooks/use-toast\"\nimport { SecureMarkdown } from \"@/components/ui/secure-markdown\"\n\ninterface Document {\n  id?: string\n  title: string\n  content: string\n  category: string\n  tags: string[]\n  version?: number\n  wordCount?: number\n  status?: string\n  author?: string\n  createdAt?: string\n  updatedAt?: string\n}\n\ninterface MarkdownEditorProps {\n  document?: Document\n  onSave?: (document: Document) => void\n  onCancel?: () => void\n}\n\nexport function MarkdownEditor({ document, onSave, onCancel }: MarkdownEditorProps) {\n  const [formData, setFormData] = useState<Document>({\n    title: \"\",\n    content: \"\",\n    category: \"\",\n    tags: [],\n  })\n  const [newTag, setNewTag] = useState(\"\")\n  const [saving, setSaving] = useState(false)\n  const [wordCount, setWordCount] = useState(0)\n  const [activeTab, setActiveTab] = useState(\"edit\")\n  const { toast } = useToast()\n  \n  // 🛡️ 安全渲染开关 - 可以安全切换新旧组件\n  const [useSecureRendering, setUseSecureRendering] = useState(true)\n\n  // 用户自定义分类：在编辑器中直接以自由文本输入分类\n\n  useEffect(() => {\n    if (document) {\n      setFormData(document)\n    }\n  }, [document])\n\n  useEffect(() => {\n    const text = formData.content.replace(/[#*`_~[\\]()]/g, \"\")\n    setWordCount(text.split(/\\s+/).filter((word) => word.length > 0).length)\n  }, [formData.content])\n\n  const handleInputChange = (field: keyof Document, value: any) => {\n    setFormData((prev) => ({\n      ...prev,\n      [field]: value,\n    }))\n  }\n\n  const handleAddTag = () => {\n    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {\n      setFormData((prev) => ({\n        ...prev,\n        tags: [...prev.tags, newTag.trim()],\n      }))\n      setNewTag(\"\")\n    }\n  }\n\n  const handleRemoveTag = (tagToRemove: string) => {\n    setFormData((prev) => ({\n      ...prev,\n      tags: prev.tags.filter((tag) => tag !== tagToRemove),\n    }))\n  }\n\n  const handleSave = async () => {\n    // 标题可留空：按规则自动生成标题\n    const inputTitle = (formData.title || \"\").trim()\n    let computedTitle = inputTitle\n\n    if (!computedTitle) {\n      const firstLine = ((formData.content || \"\").split(/\\r?\\n/)[0] || \"\").trim()\n      if (firstLine) {\n        computedTitle = Array.from(firstLine).slice(0, 9).join(\"\")\n      } else if (!((formData.content || \"\").trim())) {\n        computedTitle = \"无标题文档\"\n      } else {\n        computedTitle = \"无标题文档\"\n      }\n    }\n\n    setSaving(true)\n    try {\n      // 模拟API调用\n      await new Promise((resolve) => setTimeout(resolve, 1000))\n\n      const savedDocument = {\n        ...formData,\n        title: computedTitle,\n        id: document?.id || Date.now().toString(),\n        version: (document?.version || 0) + 1,\n        wordCount,\n        updatedAt: new Date().toISOString(),\n        createdAt: document?.createdAt || new Date().toISOString(),\n        author: \"当前用户\",\n        status: \"已保存\",\n      }\n\n      toast({\n        title: \"保存成功\",\n        description: \"文档已保存\",\n      })\n      onSave?.(savedDocument)\n    } catch (error) {\n      toast({\n        title: \"保存失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setSaving(false)\n    }\n  }\n\n  const renderMarkdown = (content: string) => {\n    return content\n      .replace(/^### (.*$)/gim, '<h3 class=\"text-lg font-semibold mt-4 mb-2\">$1</h3>')\n      .replace(/^## (.*$)/gim, '<h2 class=\"text-xl font-semibold mt-6 mb-3\">$1</h2>')\n      .replace(/^# (.*$)/gim, '<h1 class=\"text-2xl font-bold mt-8 mb-4\">$1</h1>')\n      .replace(/\\*\\*(.*)\\*\\*/gim, '<strong class=\"font-semibold\">$1</strong>')\n      .replace(/\\*(.*)\\*/gim, '<em class=\"italic\">$1</em>')\n      .replace(/`([^`]*)`/gim, '<code class=\"bg-muted px-1 py-0.5 rounded text-sm font-mono\">$1</code>')\n      .replace(/^- (.*$)/gim, '<li class=\"ml-4\">• $1</li>')\n      .replace(/^\\d+\\. (.*$)/gim, '<li class=\"ml-4\">$1</li>')\n      .replace(/\\n/gim, \"<br>\")\n  }\n\n  return (\n    <div className=\"max-w-6xl mx-auto\">\n      <Card>\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Edit3 className=\"h-5 w-5\" />\n              {document?.id ? \"编辑文档\" : \"新建文档\"}\n            </CardTitle>\n            <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n              <div className=\"flex items-center gap-1\">\n                <Hash className=\"h-4 w-4\" />\n                <span>{wordCount} 字</span>\n              </div>\n              {document?.version && (\n                <div className=\"flex items-center gap-1\">\n                  <Clock className=\"h-4 w-4\" />\n                  <span>v{document.version}</span>\n                </div>\n              )}\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {/* 文档信息 */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"md:col-span-2 space-y-2\">\n              <Label htmlFor=\"title\">文档标题</Label>\n              <Input\n                id=\"title\"\n                value={formData.title}\n                onChange={(e) => handleInputChange(\"title\", e.target.value)}\n                placeholder=\"请输入文档标题...\"\n                className=\"text-base\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">分类</Label>\n              <Input\n                id=\"category\"\n                value={formData.category}\n                onChange={(e) => handleInputChange(\"category\", e.target.value)}\n                placeholder=\"输入或创建分类（可留空）\"\n                className=\"text-base\"\n              />\n            </div>\n          </div>\n\n          {/* 标签管理 */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"tags\">标签</Label>\n            <div className=\"flex gap-2\">\n              <Input\n                id=\"tags\"\n                value={newTag}\n                onChange={(e) => setNewTag(e.target.value)}\n                placeholder=\"添加标签...\"\n                onKeyDown={(e) => {\n                  if (e.key === \"Enter\") {\n                    e.preventDefault()\n                    handleAddTag()\n                  }\n                }}\n                className=\"flex-1\"\n              />\n              <Button type=\"button\" onClick={handleAddTag} variant=\"outline\" size=\"sm\">\n                添加\n              </Button>\n            </div>\n            {formData.tags.length > 0 && (\n              <div className=\"flex flex-wrap gap-2 mt-2\">\n                {formData.tags.map((tag) => (\n                  <Badge key={tag} variant=\"secondary\" className=\"gap-1\">\n                    {tag}\n                    <X className=\"h-3 w-3 cursor-pointer\" onClick={() => handleRemoveTag(tag)} />\n                  </Badge>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Markdown编辑器 */}\n          <div className=\"space-y-2\">\n            <Label>内容</Label>\n            <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-2\">\n                <TabsTrigger value=\"edit\" className=\"gap-2\">\n                  <Edit3 className=\"h-4 w-4\" />\n                  编辑\n                </TabsTrigger>\n                <TabsTrigger value=\"preview\" className=\"gap-2\">\n                  <Eye className=\"h-4 w-4\" />\n                  预览\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"edit\" className=\"mt-4\">\n                <Textarea\n                  value={formData.content}\n                  onChange={(e) => handleInputChange(\"content\", e.target.value)}\n                  placeholder=\"支持Markdown格式，例如：&#10;# 标题&#10;## 二级标题&#10;**粗体** *斜体*&#10;- 列表项&#10;`代码`\"\n                  className=\"min-h-[500px] text-sm font-mono leading-relaxed resize-none\"\n                />\n                <div className=\"mt-2 text-xs text-muted-foreground\">\n                  支持Markdown语法：# 标题，**粗体**，*斜体*，`代码`，- 列表等\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"preview\" className=\"mt-4\">\n                {/* 安全渲染模式切换器 */}\n                <div className=\"mb-4 p-3 bg-blue-50 dark:bg-blue-950 rounded-lg border border-blue-200 dark:border-blue-800\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      {useSecureRendering ? (\n                        <Shield className=\"h-4 w-4 text-green-600\" />\n                      ) : (\n                        <AlertTriangle className=\"h-4 w-4 text-orange-500\" />\n                      )}\n                      <span className=\"text-sm font-medium\">\n                        {useSecureRendering ? '安全渲染模式' : '传统渲染模式'}\n                      </span>\n                    </div>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setUseSecureRendering(!useSecureRendering)}\n                    >\n                      {useSecureRendering ? '切换到传统模式' : '切换到安全模式'}\n                    </Button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    {useSecureRendering \n                      ? '使用React-Markdown安全渲染，防护XSS攻击，支持更多功能' \n                      : '使用传统dangerouslySetInnerHTML渲染，存在XSS风险'}\n                  </p>\n                </div>\n\n                <div className=\"min-h-[500px] p-4 border border-border rounded-md bg-muted/30\">\n                  {formData.content ? (\n                    useSecureRendering ? (\n                      // ✅ 新的安全渲染方式\n                      <SecureMarkdown \n                        content={formData.content}\n                        className=\"\"\n                        enableGfm={true}\n                        variant=\"prose\"\n                      />\n                    ) : (\n                      // ❌ 旧的不安全方式 - 保留用于对比\n                      <div\n                        className=\"prose prose-sm max-w-none dark:prose-invert\"\n                        dangerouslySetInnerHTML={{ __html: renderMarkdown(formData.content) }}\n                      />\n                    )\n                  ) : (\n                    <div className=\"text-muted-foreground text-center py-20\">\n                      在编辑模式下输入内容，这里将显示预览效果\n                    </div>\n                  )}\n                </div>\n              </TabsContent>\n            </Tabs>\n          </div>\n\n          {/* 操作按钮 */}\n          <div className=\"flex justify-end gap-2 pt-4 border-t\">\n            {onCancel && (\n              <Button variant=\"outline\" onClick={onCancel}>\n                取消\n              </Button>\n            )}\n            <Button onClick={handleSave} disabled={saving}>\n              {saving ? (\n                <>\n                  <Clock className=\"h-4 w-4 mr-2 animate-spin\" />\n                  保存中...\n                </>\n              ) : (\n                <>\n                  <Save className=\"h-4 w-4 mr-2\" />\n                  保存文档\n                </>\n              )}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\editor\\milkdown-editor.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'content' is defined but never used. Allowed unused args must match /^_/u.","line":11,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"content"},"fix":{"range":[376,391],"text":""},"desc":"Remove unused variable 'content'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'content' is defined but never used. Allowed unused args must match /^_/u.","line":12,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"content"},"fix":{"range":[413,428],"text":""},"desc":"Remove unused variable 'content'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useRef, useState } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { toast } from \"sonner\"\nimport { Bold, Italic, Code, List, ListOrdered, Quote, Heading1, Heading2, Save, FileText, Check } from \"lucide-react\"\n\ninterface MilkdownEditorProps {\n  content?: string\n  onChange?: (content: string) => void\n  onSave?: (content: string) => void\n  placeholder?: string\n}\n\nexport function MilkdownEditor({ content = \"\", onChange, onSave, placeholder = \"开始创作...\" }: MilkdownEditorProps) {\n  const editorRef = useRef<HTMLDivElement>(null)\n  const [editorContent, setEditorContent] = useState(content)\n  const [isFirstSave, setIsFirstSave] = useState(true)\n  const [isSaving, setIsSaving] = useState(false)\n  const [hasContent, setHasContent] = useState(false)\n\n  useEffect(() => {\n    setHasContent(editorContent.trim().length > 0)\n  }, [editorContent])\n\n  const handleContentChange = (newContent: string) => {\n    setEditorContent(newContent)\n    onChange?.(newContent)\n  }\n\n  const handleSave = async () => {\n    if (!editorContent.trim()) return\n\n    setIsSaving(true)\n\n    // 模拟保存过程\n    await new Promise((resolve) => setTimeout(resolve, 800))\n\n    onSave?.(editorContent)\n    setIsSaving(false)\n\n    if (isFirstSave) {\n      toast.success(\"杰作已保存\", {\n        description: \"您的创作已成功保存到文档库\",\n        duration: 3000,\n      })\n      setIsFirstSave(false)\n    } else {\n      toast.success(\"保存成功\")\n    }\n  }\n\n  const insertMarkdown = (syntax: string, placeholder = \"\") => {\n    const textarea = editorRef.current?.querySelector(\"textarea\")\n    if (!textarea) return\n\n    const start = textarea.selectionStart\n    const end = textarea.selectionEnd\n    const selectedText = editorContent.substring(start, end)\n    const replacement = selectedText || placeholder\n\n    let newContent = \"\"\n    if (syntax === \"**\") {\n      newContent = editorContent.substring(0, start) + `**${replacement}**` + editorContent.substring(end)\n    } else if (syntax === \"*\") {\n      newContent = editorContent.substring(0, start) + `*${replacement}*` + editorContent.substring(end)\n    } else if (syntax === \"`\") {\n      newContent = editorContent.substring(0, start) + `\\`${replacement}\\`` + editorContent.substring(end)\n    } else if (syntax === \"# \") {\n      const lineStart = editorContent.lastIndexOf(\"\\n\", start - 1) + 1\n      newContent = editorContent.substring(0, lineStart) + `# ${replacement || \"标题\"}` + editorContent.substring(end)\n    } else if (syntax === \"## \") {\n      const lineStart = editorContent.lastIndexOf(\"\\n\", start - 1) + 1\n      newContent =\n        editorContent.substring(0, lineStart) + `## ${replacement || \"副标题\"}` + editorContent.substring(end)\n    } else if (syntax === \"- \") {\n      const lineStart = editorContent.lastIndexOf(\"\\n\", start - 1) + 1\n      newContent = editorContent.substring(0, lineStart) + `- ${replacement || \"列表项\"}` + editorContent.substring(end)\n    } else if (syntax === \"1. \") {\n      const lineStart = editorContent.lastIndexOf(\"\\n\", start - 1) + 1\n      newContent =\n        editorContent.substring(0, lineStart) + `1. ${replacement || \"有序列表项\"}` + editorContent.substring(end)\n    } else if (syntax === \"> \") {\n      const lineStart = editorContent.lastIndexOf(\"\\n\", start - 1) + 1\n      newContent =\n        editorContent.substring(0, lineStart) + `> ${replacement || \"引用内容\"}` + editorContent.substring(end)\n    }\n\n    handleContentChange(newContent)\n  }\n\n  const examplePrompts = [\n    \"写一个关于美食的短视频文案\",\n    \"创作一个科技产品介绍\",\n    \"制作一个旅游攻略文案\",\n    \"编写一个健身励志内容\",\n  ]\n\n  return (\n    <div className=\"h-full flex flex-col bg-background\">\n      {/* 工具栏 */}\n      <div className=\"border-b border-border p-3 flex items-center justify-between\">\n        <div className=\"flex items-center gap-1\">\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => insertMarkdown(\"**\", \"粗体文本\")}>\n            <Bold className=\"h-4 w-4\" />\n          </Button>\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => insertMarkdown(\"*\", \"斜体文本\")}>\n            <Italic className=\"h-4 w-4\" />\n          </Button>\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => insertMarkdown(\"`\", \"代码\")}>\n            <Code className=\"h-4 w-4\" />\n          </Button>\n          <div className=\"w-px h-4 bg-border mx-1\" />\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => insertMarkdown(\"# \")}>\n            <Heading1 className=\"h-4 w-4\" />\n          </Button>\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => insertMarkdown(\"## \")}>\n            <Heading2 className=\"h-4 w-4\" />\n          </Button>\n          <div className=\"w-px h-4 bg-border mx-1\" />\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => insertMarkdown(\"- \")}>\n            <List className=\"h-4 w-4\" />\n          </Button>\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => insertMarkdown(\"1. \")}>\n            <ListOrdered className=\"h-4 w-4\" />\n          </Button>\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => insertMarkdown(\"> \")}>\n            <Quote className=\"h-4 w-4\" />\n          </Button>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge variant=\"secondary\" className=\"text-xs\">\n            Markdown\n          </Badge>\n          <Button variant=\"default\" size=\"sm\" onClick={handleSave} disabled={!hasContent || isSaving} className=\"gap-2\">\n            {isSaving ? (\n              <div className=\"w-4 h-4 border-2 border-primary-foreground border-t-transparent rounded-full animate-spin\" />\n            ) : (\n              <Save className=\"h-4 w-4\" />\n            )}\n            {isSaving ? \"保存中...\" : \"保存\"}\n          </Button>\n        </div>\n      </div>\n\n      {/* 编辑器区域 */}\n      <div className=\"flex-1 relative\" ref={editorRef}>\n        {!hasContent ? (\n          <div className=\"absolute inset-0 flex items-center justify-center\">\n            <div className=\"text-center space-y-4 max-w-md\">\n              <FileText className=\"h-12 w-12 text-muted-foreground mx-auto\" />\n              <div>\n                <h3 className=\"font-medium text-foreground mb-2\">开始您的创作</h3>\n                <p className=\"text-sm text-muted-foreground mb-4\">选择一个示例提示开始，或直接在下方输入您的想法</p>\n              </div>\n              <div className=\"space-y-2\">\n                <p className=\"text-xs text-muted-foreground\">示例提示：</p>\n                <div className=\"flex flex-wrap gap-2 justify-center\">\n                  {examplePrompts.map((prompt, index) => (\n                    <Button\n                      key={index}\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className=\"text-xs bg-transparent\"\n                      onClick={() => handleContentChange(prompt)}\n                    >\n                      {prompt}\n                    </Button>\n                  ))}\n                </div>\n              </div>\n            </div>\n          </div>\n        ) : null}\n\n        <textarea\n          value={editorContent}\n          onChange={(e) => handleContentChange(e.target.value)}\n          placeholder={placeholder}\n          className=\"w-full h-full p-6 bg-transparent border-none outline-none resize-none font-mono text-sm leading-relaxed\"\n          style={{ minHeight: \"100%\" }}\n        />\n      </div>\n\n      {/* 状态栏 */}\n      <div className=\"border-t border-border p-2 flex items-center justify-between text-xs text-muted-foreground\">\n        <div className=\"flex items-center gap-4\">\n          <span>字符数: {editorContent.length}</span>\n          <span>行数: {editorContent.split(\"\\n\").length}</span>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {hasContent && (\n            <div className=\"flex items-center gap-1 text-green-600\">\n              <Check className=\"h-3 w-3\" />\n              <span>已编辑</span>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\feedback\\feedback-form.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":87,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport type React from \"react\"\n\nimport { useState } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Label } from \"@/components/ui/label\"\nimport { Send, MessageCircle } from \"lucide-react\"\nimport { useToast } from \"@/hooks/use-toast\"\n\ninterface FeedbackFormProps {\n  onSuccess?: () => void\n}\n\nexport function FeedbackForm({ onSuccess }: FeedbackFormProps) {\n  const [formData, setFormData] = useState({\n    title: \"\",\n    content: \"\",\n    category: \"功能建议\",\n    priority: \"medium\",\n    authorName: \"\",\n    contactInfo: \"\",\n  })\n  const [submitting, setSubmitting] = useState(false)\n  const { toast } = useToast()\n\n  const categories = [\"功能建议\", \"问题报告\", \"使用体验\", \"性能优化\", \"界面设计\"]\n  const priorities = [\n    { value: \"low\", label: \"低优先级\" },\n    { value: \"medium\", label: \"中优先级\" },\n    { value: \"high\", label: \"高优先级\" },\n    { value: \"urgent\", label: \"紧急\" },\n  ]\n\n  const handleInputChange = (field: string, value: string) => {\n    setFormData((prev) => ({\n      ...prev,\n      [field]: value,\n    }))\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n\n    if (!formData.title.trim() || !formData.content.trim()) {\n      toast({\n        title: \"提交失败\",\n        description: \"标题和内容不能为空\",\n        variant: \"destructive\",\n      })\n      return\n    }\n\n    setSubmitting(true)\n    try {\n      const response = await fetch(\"/api/feedback\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(formData),\n      })\n\n      const result = await response.json()\n\n      if (result.success) {\n        toast({\n          title: \"提交成功\",\n          description: \"感谢您的反馈，我们会尽快处理\",\n        })\n        setFormData({\n          title: \"\",\n          content: \"\",\n          category: \"功能建议\",\n          priority: \"medium\",\n          authorName: \"\",\n          contactInfo: \"\",\n        })\n        onSuccess?.()\n      } else {\n        throw new Error(result.error)\n      }\n    } catch (error) {\n      toast({\n        title: \"提交失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setSubmitting(false)\n    }\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <MessageCircle className=\"h-5 w-5\" />\n          提交反馈\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"title\">反馈标题</Label>\n            <Input\n              id=\"title\"\n              value={formData.title}\n              onChange={(e) => handleInputChange(\"title\", e.target.value)}\n              placeholder=\"请简要描述您的反馈...\"\n              required\n            />\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">反馈类型</Label>\n              <Select value={formData.category} onValueChange={(value) => handleInputChange(\"category\", value)}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"选择反馈类型\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {categories.map((category) => (\n                    <SelectItem key={category} value={category}>\n                      {category}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"priority\">优先级</Label>\n              <Select value={formData.priority} onValueChange={(value) => handleInputChange(\"priority\", value)}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"选择优先级\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {priorities.map((priority) => (\n                    <SelectItem key={priority.value} value={priority.value}>\n                      {priority.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"content\">详细描述</Label>\n            <Textarea\n              id=\"content\"\n              value={formData.content}\n              onChange={(e) => handleInputChange(\"content\", e.target.value)}\n              placeholder=\"请详细描述您遇到的问题或建议...\"\n              className=\"min-h-[120px]\"\n              required\n            />\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"authorName\">您的称呼（可选）</Label>\n              <Input\n                id=\"authorName\"\n                value={formData.authorName}\n                onChange={(e) => handleInputChange(\"authorName\", e.target.value)}\n                placeholder=\"您的姓名或昵称\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"contactInfo\">联系方式（可选）</Label>\n              <Input\n                id=\"contactInfo\"\n                value={formData.contactInfo}\n                onChange={(e) => handleInputChange(\"contactInfo\", e.target.value)}\n                placeholder=\"邮箱或其他联系方式\"\n              />\n            </div>\n          </div>\n\n          <div className=\"flex justify-end\">\n            <Button type=\"submit\" disabled={submitting}>\n              {submitting ? (\n                <>\n                  <Send className=\"h-4 w-4 mr-2 animate-pulse\" />\n                  提交中...\n                </>\n              ) : (\n                <>\n                  <Send className=\"h-4 w-4 mr-2\" />\n                  提交反馈\n                </>\n              )}\n            </Button>\n          </div>\n        </form>\n      </CardContent>\n    </Card>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\feedback\\feedback-list.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'ThumbsUp' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"ThumbsUp"},"fix":{"range":[501,510],"text":""},"desc":"Remove unused variable 'ThumbsUp'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'statuses' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":49,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":68,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":68,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchFeedbacks'. Either include it or remove the dependency array.","line":81,"column":6,"nodeType":"ArrayExpression","endLine":81,"endColumn":49,"suggestions":[{"desc":"Update the dependencies array to be: [categoryFilter, statusFilter, currentPage, fetchFeedbacks]","fix":{"range":[2335,2378],"text":"[categoryFilter, statusFilter, currentPage, fetchFeedbacks]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":320,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":320,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Button } from \"@/components/ui/button\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\"\nimport { Textarea } from \"@/components/ui/textarea\"\nimport { ThumbsUp, MessageSquare, Clock, User, Filter } from \"lucide-react\"\nimport { useToast } from \"@/hooks/use-toast\"\n\ninterface Feedback {\n  id: string\n  title: string\n  content: string\n  category: string\n  priority: string\n  status: string\n  createdAt: string\n  updatedAt: string\n  author: string\n  contactInfo: string\n  upvotes: number\n  tags: string[]\n  replies: Array<{\n    id: string\n    content: string\n    author: string\n    createdAt: string\n    isAdmin: boolean\n  }>\n}\n\ninterface FeedbackListProps {\n  showAdminActions?: boolean\n}\n\nexport function FeedbackList({ showAdminActions = false }: FeedbackListProps) {\n  const [feedbacks, setFeedbacks] = useState<Feedback[]>([])\n  const [loading, setLoading] = useState(true)\n  const [categoryFilter, setCategoryFilter] = useState(\"all\")\n  const [statusFilter, setStatusFilter] = useState(\"all\")\n  const [currentPage, setCurrentPage] = useState(1)\n  const [totalPages, setTotalPages] = useState(1)\n  const { toast } = useToast()\n\n  const categories = [\"all\", \"功能建议\", \"问题报告\", \"使用体验\", \"性能优化\", \"界面设计\"]\n  const statuses = [\"all\", \"pending\", \"in-progress\", \"resolved\", \"closed\"]\n\n  const fetchFeedbacks = async () => {\n    try {\n      setLoading(true)\n      const params = new URLSearchParams({\n        category: categoryFilter,\n        status: statusFilter,\n        page: currentPage.toString(),\n        limit: \"10\",\n      })\n\n      const response = await fetch(`/api/feedback?${params}`)\n      const result = await response.json()\n\n      if (result.success) {\n        setFeedbacks(result.data.feedbacks)\n        setTotalPages(result.data.totalPages)\n      }\n    } catch (error) {\n      toast({\n        title: \"获取反馈列表失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    fetchFeedbacks()\n  }, [categoryFilter, statusFilter, currentPage])\n\n  const formatDate = (dateString: string): string => {\n    const date = new Date(dateString)\n    const now = new Date()\n    const diffInHours = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60))\n\n    if (diffInHours < 1) return \"刚刚\"\n    if (diffInHours < 24) return `${diffInHours}小时前`\n    const diffInDays = Math.floor(diffInHours / 24)\n    if (diffInDays < 7) return `${diffInDays}天前`\n    return date.toLocaleDateString(\"zh-CN\")\n  }\n\n  const getStatusColor = (status: string): string => {\n    switch (status) {\n      case \"pending\":\n        return \"bg-yellow-100 text-yellow-800\"\n      case \"in-progress\":\n        return \"bg-blue-100 text-blue-800\"\n      case \"resolved\":\n        return \"bg-green-100 text-green-800\"\n      case \"closed\":\n        return \"bg-gray-100 text-gray-800\"\n      default:\n        return \"bg-gray-100 text-gray-800\"\n    }\n  }\n\n  const getStatusText = (status: string): string => {\n    switch (status) {\n      case \"pending\":\n        return \"待处理\"\n      case \"in-progress\":\n        return \"处理中\"\n      case \"resolved\":\n        return \"已解决\"\n      case \"closed\":\n        return \"已关闭\"\n      default:\n        return \"未知\"\n    }\n  }\n\n  const getPriorityColor = (priority: string): string => {\n    switch (priority) {\n      case \"urgent\":\n        return \"bg-red-100 text-red-800\"\n      case \"high\":\n        return \"bg-orange-100 text-orange-800\"\n      case \"medium\":\n        return \"bg-blue-100 text-blue-800\"\n      case \"low\":\n        return \"bg-gray-100 text-gray-800\"\n      default:\n        return \"bg-gray-100 text-gray-800\"\n    }\n  }\n\n  const getPriorityText = (priority: string): string => {\n    switch (priority) {\n      case \"urgent\":\n        return \"紧急\"\n      case \"high\":\n        return \"高\"\n      case \"medium\":\n        return \"中\"\n      case \"low\":\n        return \"低\"\n      default:\n        return \"未知\"\n    }\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-muted-foreground\">加载中...</div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* 筛选器 */}\n      <Card>\n        <CardContent className=\"p-4\">\n          <div className=\"flex gap-4\">\n            <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n              <SelectTrigger className=\"w-40\">\n                <SelectValue placeholder=\"反馈类型\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">全部类型</SelectItem>\n                {categories.slice(1).map((category) => (\n                  <SelectItem key={category} value={category}>\n                    {category}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n\n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger className=\"w-32\">\n                <SelectValue placeholder=\"状态\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">全部状态</SelectItem>\n                <SelectItem value=\"pending\">待处理</SelectItem>\n                <SelectItem value=\"in-progress\">处理中</SelectItem>\n                <SelectItem value=\"resolved\">已解决</SelectItem>\n                <SelectItem value=\"closed\">已关闭</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* 反馈列表 */}\n      <div className=\"space-y-4\">\n        {feedbacks.map((feedback) => (\n          <Card key={feedback.id} className=\"hover:shadow-md transition-shadow\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-start justify-between\">\n                <div className=\"flex-1\">\n                  <CardTitle className=\"text-lg line-clamp-1\">{feedback.title}</CardTitle>\n                  <div className=\"flex items-center gap-2 mt-2\">\n                    <Badge variant=\"outline\">{feedback.category}</Badge>\n                    <Badge className={getStatusColor(feedback.status)}>{getStatusText(feedback.status)}</Badge>\n                    <Badge className={getPriorityColor(feedback.priority)}>{getPriorityText(feedback.priority)}</Badge>\n                  </div>\n                </div>\n                {feedback.replies.length > 0 && (\n                  <div className=\"flex items-center gap-1 text-sm text-muted-foreground\">\n                    <MessageSquare className=\"h-3 w-3\" />\n                    <span>已回复</span>\n                  </div>\n                )}\n              </div>\n            </CardHeader>\n\n            <CardContent className=\"space-y-4\">\n              <p className=\"text-sm text-muted-foreground line-clamp-2\">{feedback.content}</p>\n\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4 text-xs text-muted-foreground\">\n                  <div className=\"flex items-center gap-1\">\n                    <User className=\"h-3 w-3\" />\n                    <span>{feedback.author}</span>\n                  </div>\n                  <div className=\"flex items-center gap-1\">\n                    <Clock className=\"h-3 w-3\" />\n                    <span>{formatDate(feedback.createdAt)}</span>\n                  </div>\n                </div>\n\n                <div className=\"flex gap-2\">\n                  <Dialog>\n                    <DialogTrigger asChild>\n                      <Button variant=\"outline\" size=\"sm\">\n                        查看详情\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent className=\"max-w-2xl\">\n                      <DialogHeader>\n                        <DialogTitle>{feedback.title}</DialogTitle>\n                      </DialogHeader>\n                      <FeedbackDetail feedback={feedback} showAdminActions={showAdminActions} />\n                    </DialogContent>\n                  </Dialog>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {feedbacks.length === 0 && (\n        <div className=\"text-center py-12\">\n          <Filter className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground\" />\n          <p className=\"text-muted-foreground\">没有找到符合条件的反馈</p>\n        </div>\n      )}\n\n      {/* 分页 */}\n      {totalPages > 1 && (\n        <div className=\"flex items-center justify-center gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}\n            disabled={currentPage === 1}\n          >\n            上一页\n          </Button>\n          <span className=\"flex items-center px-3 text-sm\">\n            {currentPage} / {totalPages}\n          </span>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}\n            disabled={currentPage === totalPages}\n          >\n            下一页\n          </Button>\n        </div>\n      )}\n    </div>\n  )\n}\n\nfunction FeedbackDetail({ feedback, showAdminActions }: { feedback: Feedback; showAdminActions: boolean }) {\n  const [reply, setReply] = useState(\"\")\n  const [submitting, setSubmitting] = useState(false)\n  const { toast } = useToast()\n\n  const handleReply = async () => {\n    if (!reply.trim()) return\n\n    setSubmitting(true)\n    try {\n      const response = await fetch(`/api/feedback/${feedback.id}`, {\n        method: \"PUT\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ reply: reply.trim() }),\n      })\n\n      const result = await response.json()\n\n      if (result.success) {\n        toast({\n          title: \"回复成功\",\n          description: \"回复已发送\",\n        })\n        setReply(\"\")\n      }\n    } catch (error) {\n      toast({\n        title: \"回复失败\",\n        description: \"请稍后重试\",\n        variant: \"destructive\",\n      })\n    } finally {\n      setSubmitting(false)\n    }\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div>\n        <h4 className=\"font-medium mb-2\">反馈内容</h4>\n        <p className=\"text-sm text-muted-foreground leading-relaxed\">{feedback.content}</p>\n      </div>\n\n      {feedback.contactInfo && (\n        <div>\n          <h4 className=\"font-medium mb-2\">联系方式</h4>\n          <p className=\"text-sm text-muted-foreground\">{feedback.contactInfo}</p>\n        </div>\n      )}\n\n      {feedback.replies.length > 0 && feedback.replies[0] && (\n        <div>\n          <h4 className=\"font-medium mb-2\">处理回复</h4>\n          <div className=\"border-l-2 border-primary/20 pl-4\">\n            <div className=\"flex items-center gap-2 mb-1\">\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                系统回复\n              </Badge>\n              <span className=\"text-xs text-muted-foreground\">{formatDate(feedback.replies[0].createdAt)}</span>\n            </div>\n            <p className=\"text-sm text-muted-foreground\">{feedback.replies[0].content}</p>\n          </div>\n        </div>\n      )}\n\n      {showAdminActions && (\n        <div>\n          <h4 className=\"font-medium mb-2\">管理员回复</h4>\n          <div className=\"space-y-2\">\n            <Textarea\n              value={reply}\n              onChange={(e) => setReply(e.target.value)}\n              placeholder=\"输入回复内容...\"\n              className=\"min-h-[80px]\"\n            />\n            <div className=\"flex justify-end\">\n              <Button onClick={handleReply} disabled={submitting || !reply.trim()}>\n                {submitting ? \"发送中...\" : \"发送回复\"}\n              </Button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n\n  function formatDate(dateString: string): string {\n    return new Date(dateString).toLocaleString(\"zh-CN\")\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\help\\help-tooltip.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'side' is assigned a value but never used. Allowed unused args must match /^_/u.","line":16,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":60,"suggestions":[{"messageId":"removeVar","data":{"varName":"side"},"fix":{"range":[434,448],"text":""},"desc":"Remove unused variable 'side'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, type ReactNode } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport { HelpCircle, X } from \"lucide-react\"\n\ninterface HelpTooltipProps {\n  content: string | ReactNode\n  title?: string\n  trigger?: ReactNode\n  side?: \"top\" | \"bottom\" | \"left\" | \"right\"\n  className?: string\n}\n\nexport function HelpTooltip({ content, title, trigger, side = \"top\", className }: HelpTooltipProps) {\n  const [isOpen, setIsOpen] = useState(false)\n\n  const defaultTrigger = (\n    <Button variant=\"ghost\" size=\"sm\" className=\"h-5 w-5 p-0 text-muted-foreground hover:text-foreground\">\n      <HelpCircle className=\"h-4 w-4\" />\n    </Button>\n  )\n\n  return (\n    <div className={`relative inline-block ${className}`}>\n      <div onClick={() => setIsOpen(!isOpen)} className=\"cursor-pointer\">\n        {trigger || defaultTrigger}\n      </div>\n\n      {isOpen && (\n        <>\n          <div className=\"fixed inset-0 z-40\" onClick={() => setIsOpen(false)} />\n          <Card className=\"absolute z-50 w-64 shadow-lg border\">\n            <CardContent className=\"p-3\">\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"flex-1\">\n                  {title && <h4 className=\"font-medium text-sm mb-1\">{title}</h4>}\n                  <div className=\"text-sm text-muted-foreground\">{content}</div>\n                </div>\n                <Button variant=\"ghost\" size=\"sm\" className=\"h-4 w-4 p-0\" onClick={() => setIsOpen(false)}>\n                  <X className=\"h-3 w-3\" />\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\help\\onboarding-tour.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'targetElement' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":72,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"targetElement"},"fix":{"range":[1700,1713],"text":""},"desc":"Remove unused variable 'targetElement'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { X, ArrowRight, ArrowLeft, Sparkles } from \"lucide-react\"\n\ninterface TourStep {\n  id: string\n  title: string\n  description: string\n  target: string\n  position: \"top\" | \"bottom\" | \"left\" | \"right\"\n  action?: string\n}\n\nconst tourSteps: TourStep[] = [\n  {\n    id: \"welcome\",\n    title: \"欢迎来到支点有星辰\",\n    description: \"这是一个专业的AI创作平台，让我们一起探索它的强大功能！\",\n    target: \"body\",\n    position: \"bottom\",\n  },\n  {\n    id: \"navigation\",\n    title: \"导航菜单\",\n    description: \"通过导航菜单可以快速访问不同的功能模块，包括对话、文档、热门数据等。\",\n    target: \"nav\",\n    position: \"bottom\",\n  },\n  {\n    id: \"chat\",\n    title: \"AI对话创作\",\n    description: \"在这里与AI进行对话，创作高质量的短视频文案和其他内容。\",\n    target: \"[href='/chat']\",\n    position: \"bottom\",\n    action: \"点击进入对话页面\",\n  },\n  {\n    id: \"documents\",\n    title: \"文档管理\",\n    description: \"管理您的创作文档，支持Markdown编辑和版本控制。\",\n    target: \"[href='/documents']\",\n    position: \"bottom\",\n  },\n  {\n    id: \"merchants\",\n    title: \"商家中心\",\n    description: \"查看商家数据，了解建材装修行业动态。\",\n    target: \"[href='/merchants']\",\n    position: \"bottom\",\n  },\n  {\n    id: \"inspiration\",\n    title: \"灵感库\",\n    description: \"浏览和收藏创作灵感，激发您的创意潜能。\",\n    target: \"[href='/inspiration']\",\n    position: \"bottom\",\n  },\n]\n\ninterface OnboardingTourProps {\n  onComplete: () => void\n  onSkip: () => void\n}\n\nexport function OnboardingTour({ onComplete, onSkip }: OnboardingTourProps) {\n  const [currentStep, setCurrentStep] = useState(0)\n  const [isVisible, setIsVisible] = useState(true)\n  const [targetElement, setTargetElement] = useState<HTMLElement | null>(null)\n\n  useEffect(() => {\n    const step = tourSteps[currentStep]\n    if (step) {\n      const element = document.querySelector(step.target) as HTMLElement\n      setTargetElement(element)\n\n      if (element) {\n        element.scrollIntoView({ behavior: \"smooth\", block: \"center\" })\n        element.style.position = \"relative\"\n        element.style.zIndex = \"1001\"\n      }\n    }\n  }, [currentStep])\n\n  const handleNext = () => {\n    if (currentStep < tourSteps.length - 1) {\n      setCurrentStep(currentStep + 1)\n    } else {\n      handleComplete()\n    }\n  }\n\n  const handlePrevious = () => {\n    if (currentStep > 0) {\n      setCurrentStep(currentStep - 1)\n    }\n  }\n\n  const handleComplete = () => {\n    setIsVisible(false)\n    onComplete()\n  }\n\n  const handleSkip = () => {\n    setIsVisible(false)\n    onSkip()\n  }\n\n  if (!isVisible) return null\n\n  const step = tourSteps[currentStep]\n\n  return (\n    <>\n      {/* 遮罩层 */}\n      <div className=\"fixed inset-0 bg-black/50 z-1000\" />\n\n      {/* 引导卡片 */}\n      <div className=\"fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-1001\">\n        <Card className=\"w-96 max-w-[90vw]\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <Sparkles className=\"h-5 w-5 text-primary\" />\n                <CardTitle className=\"text-lg\">{step.title}</CardTitle>\n              </div>\n              <Button variant=\"ghost\" size=\"sm\" onClick={handleSkip}>\n                <X className=\"h-4 w-4\" />\n              </Button>\n            </div>\n            <CardDescription>{step.description}</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <Badge variant=\"secondary\">\n                  {currentStep + 1} / {tourSteps.length}\n                </Badge>\n                {step.action && <span className=\"text-sm text-muted-foreground\">{step.action}</span>}\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Button variant=\"outline\" onClick={handlePrevious} disabled={currentStep === 0} size=\"sm\">\n                  <ArrowLeft className=\"h-4 w-4\" />\n                </Button>\n                <Button onClick={handleNext} size=\"sm\" className=\"gap-2\">\n                  {currentStep === tourSteps.length - 1 ? \"完成\" : \"下一步\"}\n                  {currentStep < tourSteps.length - 1 && <ArrowRight className=\"h-4 w-4\" />}\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\merchants\\tag-analysis-modal.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'TrendingUp' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"TrendingUp"},"fix":{"range":[547,562],"text":""},"desc":"Remove unused variable 'TrendingUp'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'open' is defined but never used. Allowed unused args must match /^_/u.","line":47,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":47,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"open"},"fix":{"range":[1110,1123],"text":""},"desc":"Remove unused variable 'open'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":72,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchTagAnalysis'. Either include it or remove the dependency array.","line":90,"column":6,"nodeType":"ArrayExpression","endLine":90,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [open, merchantId, fetchTagAnalysis]","fix":{"range":[2067,2085],"text":"[open, merchantId, fetchTagAnalysis]"}}]},{"ruleId":"no-unused-vars","severity":1,"message":"'index' is defined but never used. Allowed unused args must match /^_/u.","line":200,"column":91,"nodeType":"Identifier","messageId":"unusedVar","endLine":200,"endColumn":96,"suggestions":[{"messageId":"removeVar","data":{"varName":"index"},"fix":{"range":[7201,7208],"text":""},"desc":"Remove unused variable 'index'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'index' is defined but never used. Allowed unused args must match /^_/u.","line":223,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":223,"endColumn":66,"suggestions":[{"messageId":"removeVar","data":{"varName":"index"},"fix":{"range":[8400,8407],"text":""},"desc":"Remove unused variable 'index'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'index' is defined but never used. Allowed unused args must match /^_/u.","line":251,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":251,"endColumn":62,"suggestions":[{"messageId":"removeVar","data":{"varName":"index"},"fix":{"range":[9731,9738],"text":""},"desc":"Remove unused variable 'index'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 标签分析模态对话框组件\r\n */\r\n\r\n'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog'\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Skeleton } from '@/components/ui/skeleton'\r\nimport { Progress } from '@/components/ui/progress'\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\r\nimport { \r\n  Tag,\r\n  TrendingUp,\r\n  Hash,\r\n  BarChart3,\r\n  Star\r\n} from 'lucide-react'\r\n\r\ninterface TagStats {\r\n  tag: string\r\n  count: number\r\n  engagementSum: number\r\n  avgEngagement: number\r\n  contentIds: string[]\r\n}\r\n\r\ninterface TagAnalysisData {\r\n  totalTags: number\r\n  uniqueTags: number\r\n  topTags: TagStats[]\r\n  categoryTags: Array<{\r\n    category: string\r\n    tags: string[]\r\n    count: number\r\n  }>\r\n  engagementAnalysis: {\r\n    highPerformingTags: TagStats[]\r\n    growingTags: TagStats[]\r\n  }\r\n}\r\n\r\ninterface TagAnalysisModalProps {\r\n  open: boolean\r\n  onOpenChange: (open: boolean) => void\r\n  merchantId: string\r\n  merchantName: string\r\n}\r\n\r\nexport function TagAnalysisModal({ \r\n  open, \r\n  onOpenChange, \r\n  merchantId, \r\n  merchantName \r\n}: TagAnalysisModalProps) {\r\n  const [data, setData] = useState<TagAnalysisData | null>(null)\r\n  const [loading, setLoading] = useState(false)\r\n\r\n  // 获取标签分析数据\r\n  const fetchTagAnalysis = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const response = await fetch(`/api/merchants/${merchantId}/tags`)\r\n      const result = await response.json()\r\n      \r\n      if (response.ok) {\r\n        setData(result)\r\n      } else {\r\n        }\r\n    } catch (error) {\r\n      } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  // 格式化数字\r\n  const formatNumber = (num: number) => {\r\n    if (num >= 10000) {\r\n      return `${(num / 10000).toFixed(1)}万`\r\n    }\r\n    return num.toLocaleString()\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (open && merchantId) {\r\n      fetchTagAnalysis()\r\n    }\r\n  }, [open, merchantId])\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <Tag className=\"h-5 w-5\" />\r\n            {merchantName} - 标签分析\r\n          </DialogTitle>\r\n          <DialogDescription>\r\n            深度分析商家内容标签使用情况和表现\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {loading ? (\r\n          <div className=\"space-y-6\">\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              {Array.from({ length: 3 }).map((_, i) => (\r\n                <Skeleton key={i} className=\"h-24\" />\r\n              ))}\r\n            </div>\r\n            <Skeleton className=\"h-64\" />\r\n          </div>\r\n        ) : data ? (\r\n          <div className=\"space-y-6\">\r\n            {/* 概览统计 */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              <Card>\r\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                  <CardTitle className=\"text-sm font-medium\">标签总数</CardTitle>\r\n                  <Hash className=\"h-4 w-4 text-blue-500\" />\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"text-2xl font-bold\">{data.totalTags}</div>\r\n                  <p className=\"text-xs text-muted-foreground\">所有内容标签数量</p>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                  <CardTitle className=\"text-sm font-medium\">独特标签</CardTitle>\r\n                  <Tag className=\"h-4 w-4 text-purple-500\" />\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"text-2xl font-bold\">{data.uniqueTags}</div>\r\n                  <p className=\"text-xs text-muted-foreground\">不重复标签种类</p>\r\n                </CardContent>\r\n              </Card>\r\n\r\n              <Card>\r\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                  <CardTitle className=\"text-sm font-medium\">平均标签</CardTitle>\r\n                  <BarChart3 className=\"h-4 w-4 text-green-500\" />\r\n                </CardHeader>\r\n                <CardContent>\r\n                  <div className=\"text-2xl font-bold\">\r\n                    {data.uniqueTags > 0 ? Math.round(data.totalTags / data.uniqueTags) : 0}\r\n                  </div>\r\n                  <p className=\"text-xs text-muted-foreground\">每个标签平均使用次数</p>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n\r\n            <Tabs defaultValue=\"popular\" className=\"w-full\">\r\n              <TabsList className=\"grid w-full grid-cols-3\">\r\n                <TabsTrigger value=\"popular\">热门标签</TabsTrigger>\r\n                <TabsTrigger value=\"performance\">表现分析</TabsTrigger>\r\n                <TabsTrigger value=\"categories\">分类标签</TabsTrigger>\r\n              </TabsList>\r\n\r\n              <TabsContent value=\"popular\" className=\"space-y-4\">\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle>使用频率最高的标签</CardTitle>\r\n                    <CardDescription>按使用次数排序的热门标签</CardDescription>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"space-y-4\">\r\n                      {data.topTags.slice(0, 10).map((tag, index) => (\r\n                        <div key={tag.tag} className=\"flex items-center justify-between\">\r\n                          <div className=\"flex items-center gap-3\">\r\n                            <Badge variant=\"outline\" className=\"text-xs\">#{index + 1}</Badge>\r\n                            <div>\r\n                              <div className=\"font-medium\">#{tag.tag}</div>\r\n                              <div className=\"text-xs text-muted-foreground\">\r\n                                {tag.count} 次使用 · 平均互动 {formatNumber(tag.avgEngagement)}\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                          <div className=\"text-right\">\r\n                            <div className=\"text-sm font-medium\">{formatNumber(tag.engagementSum)}</div>\r\n                            <div className=\"text-xs text-muted-foreground\">总互动</div>\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </TabsContent>\r\n\r\n              <TabsContent value=\"performance\" className=\"space-y-4\">\r\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle>高表现标签</CardTitle>\r\n                      <CardDescription>平均互动量最高的标签</CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-3\">\r\n                        {data.engagementAnalysis.highPerformingTags.slice(0, 8).map((tag, index) => (\r\n                          <div key={tag.tag} className=\"flex items-center justify-between\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Star className=\"h-3 w-3 text-yellow-500\" />\r\n                              <span className=\"text-sm font-medium\">#{tag.tag}</span>\r\n                            </div>\r\n                            <div className=\"text-right\">\r\n                              <div className=\"text-sm font-medium\">{formatNumber(tag.avgEngagement)}</div>\r\n                              <div className=\"text-xs text-muted-foreground\">{tag.count}次使用</div>\r\n                            </div>\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n\r\n                  <Card>\r\n                    <CardHeader>\r\n                      <CardTitle>标签互动分布</CardTitle>\r\n                      <CardDescription>不同标签的互动表现对比</CardDescription>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-3\">\r\n                        {data.topTags.slice(0, 6).map((tag, index) => {\r\n                          const maxEngagement = Math.max(...data.topTags.map(t => t.avgEngagement))\r\n                          const percentage = (tag.avgEngagement / maxEngagement) * 100\r\n                          \r\n                          return (\r\n                            <div key={tag.tag} className=\"space-y-1\">\r\n                              <div className=\"flex justify-between text-sm\">\r\n                                <span>#{tag.tag}</span>\r\n                                <span>{formatNumber(tag.avgEngagement)}</span>\r\n                              </div>\r\n                              <Progress value={percentage} className=\"h-2\" />\r\n                            </div>\r\n                          )\r\n                        })}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                </div>\r\n              </TabsContent>\r\n\r\n              <TabsContent value=\"categories\" className=\"space-y-4\">\r\n                <Card>\r\n                  <CardHeader>\r\n                    <CardTitle>标签分类分析</CardTitle>\r\n                    <CardDescription>按内容类型分组的标签使用情况</CardDescription>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"space-y-4\">\r\n                      {data.categoryTags.map((category, index) => (\r\n                        <div key={category.category} className=\"space-y-2\">\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <h4 className=\"font-medium\">{category.category}</h4>\r\n                            <Badge variant=\"secondary\">{category.count} 个标签</Badge>\r\n                          </div>\r\n                          <div className=\"flex flex-wrap gap-1\">\r\n                            {category.tags.slice(0, 10).map((tag) => (\r\n                              <Badge key={tag} variant=\"outline\" className=\"text-xs\">\r\n                                #{tag}\r\n                              </Badge>\r\n                            ))}\r\n                            {category.tags.length > 10 && (\r\n                              <Badge variant=\"outline\" className=\"text-xs\">\r\n                                +{category.tags.length - 10} 更多\r\n                              </Badge>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </TabsContent>\r\n            </Tabs>\r\n          </div>\r\n        ) : (\r\n          <div className=\"text-center py-8\">\r\n            <p className=\"text-muted-foreground\">暂无标签分析数据</p>\r\n          </div>\r\n        )}\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\monitoring\\system-monitor.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":61,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMetrics'. Either include it or remove the dependency array.","line":71,"column":6,"nodeType":"ArrayExpression","endLine":71,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [timeRange, selectedMetric, fetchMetrics]","fix":{"range":[2359,2386],"text":"[timeRange, selectedMetric, fetchMetrics]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { ChartContainer, ChartTooltip, ChartTooltipContent } from \"@/components/ui/chart\"\nimport { Line, LineChart, ResponsiveContainer, XAxis, YAxis } from \"recharts\"\nimport { Activity, Clock, AlertTriangle, TrendingUp, Database, Cpu } from \"lucide-react\"\n\ninterface SystemMetrics {\n  responseTime: Array<{ time: string; value: number }>\n  errorRate: Array<{ time: string; value: number }>\n  throughput: Array<{ time: string; value: number }>\n  stats: {\n    avgResponseTime: number\n    errorRate: number\n    totalRequests: number\n    uptime: number\n  }\n}\n\nconst chartConfig = {\n  value: {\n    label: \"数值\",\n    color: \"hsl(142, 76%, 36%)\",\n  },\n}\n\nexport function SystemMonitor() {\n  const [metrics, setMetrics] = useState<SystemMetrics | null>(null)\n  const [loading, setLoading] = useState(true)\n  const [timeRange, setTimeRange] = useState(\"1h\")\n  const [selectedMetric, setSelectedMetric] = useState(\"response_time\")\n\n  const fetchMetrics = async () => {\n    try {\n      setLoading(true)\n      const response = await fetch(`/api/analytics/metrics?metricType=${selectedMetric}&timeRange=${timeRange}`)\n      const result = await response.json()\n\n      if (result.success) {\n        // 转换数据格式用于图表显示\n        const chartData = result.data.metrics.map((metric: any) => ({\n          time: new Date(metric.timestamp).toLocaleTimeString(),\n          value: metric.value,\n        }))\n\n        setMetrics({\n          responseTime: selectedMetric === \"response_time\" ? chartData : [],\n          errorRate: selectedMetric === \"error_rate\" ? chartData : [],\n          throughput: selectedMetric === \"throughput\" ? chartData : [],\n          stats: {\n            avgResponseTime: result.data.stats.avg,\n            errorRate: 0.5, // 模拟数据\n            totalRequests: result.data.stats.count,\n            uptime: 99.9, // 模拟数据\n          },\n        })\n      }\n    } catch (error) {\n      } finally {\n      setLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    fetchMetrics()\n    const interval = setInterval(fetchMetrics, 30000) // 每30秒刷新一次\n    return () => clearInterval(interval)\n  }, [timeRange, selectedMetric])\n\n  const getStatusColor = (value: number, type: string) => {\n    switch (type) {\n      case \"response_time\":\n        return value < 200 ? \"bg-green-500\" : value < 500 ? \"bg-yellow-500\" : \"bg-red-500\"\n      case \"error_rate\":\n        return value < 1 ? \"bg-green-500\" : value < 5 ? \"bg-yellow-500\" : \"bg-red-500\"\n      case \"uptime\":\n        return value > 99 ? \"bg-green-500\" : value > 95 ? \"bg-yellow-500\" : \"bg-red-500\"\n      default:\n        return \"bg-gray-500\"\n    }\n  }\n\n  if (loading || !metrics) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-muted-foreground\">加载监控数据中...</div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* 控制面板 */}\n      <div className=\"flex gap-4\">\n        <Select value={timeRange} onValueChange={setTimeRange}>\n          <SelectTrigger className=\"w-32\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"1h\">1小时</SelectItem>\n            <SelectItem value=\"24h\">24小时</SelectItem>\n            <SelectItem value=\"7d\">7天</SelectItem>\n          </SelectContent>\n        </Select>\n\n        <Select value={selectedMetric} onValueChange={setSelectedMetric}>\n          <SelectTrigger className=\"w-40\">\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"response_time\">响应时间</SelectItem>\n            <SelectItem value=\"error_rate\">错误率</SelectItem>\n            <SelectItem value=\"throughput\">吞吐量</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* 系统状态概览 */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">平均响应时间</CardTitle>\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{metrics.stats.avgResponseTime.toFixed(0)}ms</div>\n            <div className=\"flex items-center gap-2 mt-2\">\n              <div\n                className={`w-2 h-2 rounded-full ${getStatusColor(metrics.stats.avgResponseTime, \"response_time\")}`}\n              />\n              <span className=\"text-xs text-muted-foreground\">\n                {metrics.stats.avgResponseTime < 200\n                  ? \"优秀\"\n                  : metrics.stats.avgResponseTime < 500\n                    ? \"良好\"\n                    : \"需要优化\"}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">错误率</CardTitle>\n            <AlertTriangle className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{metrics.stats.errorRate}%</div>\n            <div className=\"flex items-center gap-2 mt-2\">\n              <div className={`w-2 h-2 rounded-full ${getStatusColor(metrics.stats.errorRate, \"error_rate\")}`} />\n              <span className=\"text-xs text-muted-foreground\">\n                {metrics.stats.errorRate < 1 ? \"优秀\" : metrics.stats.errorRate < 5 ? \"良好\" : \"需要关注\"}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">总请求数</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{metrics.stats.totalRequests.toLocaleString()}</div>\n            <p className=\"text-xs text-muted-foreground mt-2\">过去{timeRange}</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">系统正常运行时间</CardTitle>\n            <Activity className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{metrics.stats.uptime}%</div>\n            <div className=\"flex items-center gap-2 mt-2\">\n              <div className={`w-2 h-2 rounded-full ${getStatusColor(metrics.stats.uptime, \"uptime\")}`} />\n              <span className=\"text-xs text-muted-foreground\">系统稳定</span>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* 实时监控图表 */}\n      <Card>\n        <CardHeader>\n          <CardTitle>\n            实时监控 -{\" \"}\n            {selectedMetric === \"response_time\" ? \"响应时间\" : selectedMetric === \"error_rate\" ? \"错误率\" : \"吞吐量\"}\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <ChartContainer config={chartConfig}>\n            <ResponsiveContainer width=\"100%\" height={300}>\n              <LineChart\n                data={\n                  selectedMetric === \"response_time\"\n                    ? metrics.responseTime\n                    : selectedMetric === \"error_rate\"\n                      ? metrics.errorRate\n                      : metrics.throughput\n                }\n              >\n                <XAxis dataKey=\"time\" tickLine={false} axisLine={false} tickMargin={8} />\n                <YAxis tickLine={false} axisLine={false} tickMargin={8} />\n                <ChartTooltip cursor={false} content={<ChartTooltipContent />} />\n                <Line dataKey=\"value\" type=\"monotone\" stroke={chartConfig.value.color} strokeWidth={2} dot={false} />\n              </LineChart>\n            </ResponsiveContainer>\n          </ChartContainer>\n        </CardContent>\n      </Card>\n\n      {/* 系统健康状态 */}\n      <Card>\n        <CardHeader>\n          <CardTitle>系统健康状态</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n              <div className=\"flex items-center gap-3\">\n                <Database className=\"h-5 w-5 text-muted-foreground\" />\n                <span>数据库连接</span>\n              </div>\n              <Badge variant=\"default\" className=\"bg-green-500\">\n                正常\n              </Badge>\n            </div>\n\n            <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n              <div className=\"flex items-center gap-3\">\n                <Cpu className=\"h-5 w-5 text-muted-foreground\" />\n                <span>CPU使用率</span>\n              </div>\n              <Badge variant=\"default\" className=\"bg-yellow-500\">\n                45%\n              </Badge>\n            </div>\n\n            <div className=\"flex items-center justify-between p-4 border rounded-lg\">\n              <div className=\"flex items-center gap-3\">\n                <Activity className=\"h-5 w-5 text-muted-foreground\" />\n                <span>内存使用率</span>\n              </div>\n              <Badge variant=\"default\" className=\"bg-green-500\">\n                62%\n              </Badge>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\performance\\lazy-image.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":2,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":57,"column":9,"nodeType":"JSXOpeningElement","endLine":67,"endColumn":11}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useRef, useEffect } from \"react\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\n\ninterface LazyImageProps {\n  src: string\n  alt: string\n  width?: number\n  height?: number\n  className?: string\n  placeholder?: string\n  onLoad?: () => void\n  onError?: () => void\n}\n\nexport function LazyImage({ src, alt, width, height, className = \"\", placeholder, onLoad, onError }: LazyImageProps) {\n  const [isLoaded, setIsLoaded] = useState(false)\n  const [isInView, setIsInView] = useState(false)\n  const [hasError, setHasError] = useState(false)\n  const imgRef = useRef<HTMLImageElement>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  useEffect(() => {\n    const observer = new IntersectionObserver(\n      ([entry]) => {\n        if (entry.isIntersecting) {\n          setIsInView(true)\n          observer.disconnect()\n        }\n      },\n      { threshold: 0.1 },\n    )\n\n    if (containerRef.current) {\n      observer.observe(containerRef.current)\n    }\n\n    return () => observer.disconnect()\n  }, [])\n\n  const handleLoad = () => {\n    setIsLoaded(true)\n    onLoad?.()\n  }\n\n  const handleError = () => {\n    setHasError(true)\n    onError?.()\n  }\n\n  return (\n    <div ref={containerRef} className={`relative overflow-hidden ${className}`} style={{ width, height }}>\n      {!isLoaded && !hasError && <Skeleton className=\"absolute inset-0 w-full h-full\" style={{ width, height }} />}\n\n      {isInView && !hasError && (\n        <img\n          ref={imgRef}\n          src={src || \"/placeholder.svg\"}\n          alt={alt}\n          width={width}\n          height={height}\n          className={`transition-opacity duration-300 ${isLoaded ? \"opacity-100\" : \"opacity-0\"} ${className}`}\n          onLoad={handleLoad}\n          onError={handleError}\n          loading=\"lazy\"\n        />\n      )}\n\n      {hasError && (\n        <div\n          className=\"flex items-center justify-center bg-muted text-muted-foreground text-sm\"\n          style={{ width, height }}\n        >\n          {placeholder || \"图片加载失败\"}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\performance\\preloader.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":42,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect } from \"react\"\n\ninterface PreloaderProps {\n  resources: string[]\n  onComplete?: () => void\n}\n\nexport function Preloader({ resources, onComplete }: PreloaderProps) {\n  useEffect(() => {\n    const preloadResource = (url: string): Promise<void> => {\n      return new Promise((resolve, reject) => {\n        if (url.match(/\\.(jpg|jpeg|png|gif|webp)$/i)) {\n          // 预加载图片\n          const img = new Image()\n          img.onload = () => resolve()\n          img.onerror = reject\n          img.src = url\n        } else if (url.match(/\\.(js|css)$/i)) {\n          // 预加载脚本和样式\n          const link = document.createElement(\"link\")\n          link.rel = \"preload\"\n          link.href = url\n          link.as = url.endsWith(\".js\") ? \"script\" : \"style\"\n          link.onload = () => resolve()\n          link.onerror = reject\n          document.head.appendChild(link)\n        } else {\n          // 其他资源使用fetch预加载\n          fetch(url)\n            .then(() => resolve())\n            .catch(reject)\n        }\n      })\n    }\n\n    const preloadAll = async () => {\n      try {\n        await Promise.all(resources.map(preloadResource))\n        onComplete?.()\n      } catch (error) {\n        onComplete?.()\n      }\n    }\n\n    if (resources.length > 0) {\n      preloadAll()\n    }\n  }, [resources, onComplete])\n\n  return null\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\performance\\virtual-list.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'item' is defined but never used. Allowed unused args must match /^_/u.","line":11,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"item"},"fix":{"range":[204,212],"text":""},"desc":"Remove unused variable 'item'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'index' is defined but never used. Allowed unused args must match /^_/u.","line":11,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":38,"suggestions":[{"messageId":"removeVar","data":{"varName":"index"},"fix":{"range":[211,226],"text":""},"desc":"Remove unused variable 'index'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport type React from \"react\"\n\nimport { useState, useRef, useMemo } from \"react\"\n\ninterface VirtualListProps<T> {\n  items: T[]\n  itemHeight: number\n  containerHeight: number\n  renderItem: (item: T, index: number) => React.ReactNode\n  overscan?: number\n  className?: string\n}\n\nexport function VirtualList<T>({\n  items,\n  itemHeight,\n  containerHeight,\n  renderItem,\n  overscan = 5,\n  className = \"\",\n}: VirtualListProps<T>) {\n  const [scrollTop, setScrollTop] = useState(0)\n  const containerRef = useRef<HTMLDivElement>(null)\n\n  const { visibleItems, totalHeight, offsetY } = useMemo(() => {\n    const startIndex = Math.max(0, Math.floor(scrollTop / itemHeight) - overscan)\n    const endIndex = Math.min(items.length - 1, Math.ceil((scrollTop + containerHeight) / itemHeight) + overscan)\n\n    const visibleItems = items.slice(startIndex, endIndex + 1).map((item, index) => ({\n      item,\n      index: startIndex + index,\n    }))\n\n    return {\n      visibleItems,\n      totalHeight: items.length * itemHeight,\n      offsetY: startIndex * itemHeight,\n    }\n  }, [items, itemHeight, containerHeight, scrollTop, overscan])\n\n  const handleScroll = (e: React.UIEvent<HTMLDivElement>) => {\n    setScrollTop(e.currentTarget.scrollTop)\n  }\n\n  return (\n    <div\n      ref={containerRef}\n      className={`overflow-auto ${className}`}\n      style={{ height: containerHeight }}\n      onScroll={handleScroll}\n    >\n      <div style={{ height: totalHeight, position: \"relative\" }}>\n        <div style={{ transform: `translateY(${offsetY}px)` }}>\n          {visibleItems.map(({ item, index }) => (\n            <div key={index} style={{ height: itemHeight }}>\n              {renderItem(item, index)}\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\providers\\storage-provider.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'data' is defined but never used. Allowed unused args must match /^_/u.","line":12,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":28,"suggestions":[{"messageId":"removeVar","data":{"varName":"data"},"fix":{"range":[293,305],"text":""},"desc":"Remove unused variable 'data'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":40,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":60,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":60,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport type React from \"react\"\n\nimport { createContext, useContext, useEffect, useState } from \"react\"\nimport { LocalStorage } from \"@/lib/storage\"\n\ninterface StorageContextType {\n  isStorageAvailable: boolean\n  clearAllData: () => void\n  exportData: () => string\n  importData: (data: string) => boolean\n}\n\nconst StorageContext = createContext<StorageContextType | undefined>(undefined)\n\nexport function StorageProvider({ children }: { children: React.ReactNode }) {\n  const [isStorageAvailable, setIsStorageAvailable] = useState(false)\n\n  useEffect(() => {\n    setIsStorageAvailable(LocalStorage.isAvailable())\n  }, [])\n\n  const clearAllData = () => {\n    if (confirm(\"确定要清空所有本地数据吗？此操作不可恢复。\")) {\n      LocalStorage.clear()\n      window.location.reload()\n    }\n  }\n\n  const exportData = () => {\n    try {\n      const data = {\n        conversations: LocalStorage.getItem(\"conversations\", []),\n        userSettings: LocalStorage.getItem(\"user_settings\", {}),\n        documents: LocalStorage.getItem(\"documents\", []),\n        exportTime: new Date().toISOString(),\n      }\n      return JSON.stringify(data, null, 2)\n    } catch (error) {\n      return \"\"\n    }\n  }\n\n  const importData = (dataString: string) => {\n    try {\n      const data = JSON.parse(dataString)\n\n      if (data.conversations) {\n        LocalStorage.setItem(\"conversations\", data.conversations)\n      }\n      if (data.userSettings) {\n        LocalStorage.setItem(\"user_settings\", data.userSettings)\n      }\n      if (data.documents) {\n        LocalStorage.setItem(\"documents\", data.documents)\n      }\n\n      return true\n    } catch (error) {\n      return false\n    }\n  }\n\n  return (\n    <StorageContext.Provider\n      value={{\n        isStorageAvailable,\n        clearAllData,\n        exportData,\n        importData,\n      }}\n    >\n      {children}\n    </StorageContext.Provider>\n  )\n}\n\nexport function useStorage() {\n  const context = useContext(StorageContext)\n  if (context === undefined) {\n    throw new Error(\"useStorage must be used within a StorageProvider\")\n  }\n  return context\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\stats\\model-usage-cards.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'getProviderIcon' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"getProviderIcon"},"fix":{"range":[256,273],"text":""},"desc":"Remove unused variable 'getProviderIcon'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Progress } from \"@/components/ui/progress\"\nimport { Brain, Search, Zap, HelpCircle } from \"lucide-react\"\nimport { getProviderColor, getProviderIcon, formatStatsNumber } from \"@/lib/ai/model-stats-helper\"\n\ninterface ModelUsageData {\n  displayName: string\n  provider: string\n  totalTokens: number\n  requests: number\n  promptTokens: number\n  completionTokens: number\n  percentage: number\n  formattedTokens: string\n  formattedRequests: string\n}\n\ninterface ModelUsageCardsProps {\n  modelStats: Record<string, ModelUsageData>\n  totalStats: {\n    totalTokens: number\n    totalRequests: number\n    formattedTokens: string\n    formattedRequests: string\n  }\n  loading: boolean\n  className?: string\n}\n\n// 获取提供商图标组件\nfunction getProviderIconComponent(provider: string) {\n  switch (provider.toLowerCase()) {\n    case 'claude':\n      return Brain\n    case 'google':\n      return Search\n    case 'openai':\n      return Zap\n    default:\n      return HelpCircle\n  }\n}\n\n// 获取提供商徽章颜色\nfunction getProviderBadgeVariant(provider: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" {\n  switch (provider.toLowerCase()) {\n    case 'claude':\n      return 'destructive' // 橙色系\n    case 'google':\n      return 'default'     // 蓝色系\n    case 'openai':\n      return 'secondary'   // 绿色系\n    default:\n      return 'outline'\n  }\n}\n\nexport function ModelUsageCards({ \n  modelStats, \n  totalStats, \n  loading, \n  className = \"\" \n}: ModelUsageCardsProps) {\n  if (loading) {\n    return (\n      <div className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 ${className}`}>\n        {[...Array(3)].map((_, i) => (\n          <Card key={i} className=\"animate-pulse\">\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-start justify-between mb-3\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-8 h-8 bg-muted rounded-lg\"></div>\n                  <div>\n                    <div className=\"w-20 h-4 bg-muted rounded mb-1\"></div>\n                    <div className=\"w-12 h-3 bg-muted rounded\"></div>\n                  </div>\n                </div>\n                <div className=\"w-10 h-5 bg-muted rounded\"></div>\n              </div>\n              <div className=\"space-y-2\">\n                <div className=\"w-full h-2 bg-muted rounded\"></div>\n                <div className=\"flex justify-between\">\n                  <div className=\"w-16 h-3 bg-muted rounded\"></div>\n                  <div className=\"w-12 h-3 bg-muted rounded\"></div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    )\n  }\n\n  const modelEntries = Object.entries(modelStats).sort((a, b) => b[1].totalTokens - a[1].totalTokens)\n\n  if (modelEntries.length === 0) {\n    return (\n      <Card className={className}>\n        <CardContent className=\"p-6 text-center\">\n          <div className=\"flex flex-col items-center gap-3 text-muted-foreground\">\n            <HelpCircle className=\"h-8 w-8\" />\n            <div>\n              <p className=\"font-medium\">暂无模型使用数据</p>\n              <p className=\"text-sm\">开始对话后，这里将显示各模型的使用统计</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    )\n  }\n\n  return (\n    <div className={`space-y-4 ${className}`}>\n      {/* 标题 */}\n      <div className=\"flex items-center justify-between\">\n        <h3 className=\"text-lg font-semibold\">模型使用分布</h3>\n        <Badge variant=\"outline\" className=\"text-xs\">\n          {modelEntries.length} 个模型\n        </Badge>\n      </div>\n\n      {/* 模型卡片网格 */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n        {modelEntries.map(([modelId, data]) => {\n          const IconComponent = getProviderIconComponent(data.provider)\n          const badgeVariant = getProviderBadgeVariant(data.provider)\n          const providerColor = getProviderColor(data.provider)\n\n          return (\n            <Card key={modelId} className=\"hover:shadow-md transition-shadow\">\n              <CardContent className=\"p-4\">\n                {/* 模型信息头部 */}\n                <div className=\"flex items-start justify-between mb-3\">\n                  <div className=\"flex items-center gap-3\">\n                    <div \n                      className=\"p-2 rounded-lg\"\n                      style={{ backgroundColor: `${providerColor}20` }}\n                    >\n                      <IconComponent \n                        className=\"h-4 w-4\" \n                        style={{ color: providerColor }}\n                      />\n                    </div>\n                    <div>\n                      <h4 className=\"font-medium text-sm leading-none\">\n                        {data.displayName}\n                      </h4>\n                      <Badge variant={badgeVariant} className=\"mt-1 text-xs\">\n                        {data.provider}\n                      </Badge>\n                    </div>\n                  </div>\n                  <div className=\"text-right\">\n                    <div className=\"text-xl font-semibold\">\n                      {data.percentage}%\n                    </div>\n                  </div>\n                </div>\n\n                {/* 使用量进度条 */}\n                <div className=\"space-y-2 mb-3\">\n                  <Progress \n                    value={data.percentage} \n                    className=\"h-2\"\n                    style={{\n                      '--progress-foreground': providerColor\n                    } as React.CSSProperties}\n                  />\n                  <div className=\"flex justify-between text-xs text-muted-foreground\">\n                    <span>Token用量</span>\n                    <span>{data.formattedTokens}</span>\n                  </div>\n                </div>\n\n                {/* 详细统计 */}\n                <div className=\"grid grid-cols-2 gap-3 text-xs\">\n                  <div>\n                    <div className=\"text-muted-foreground\">请求数</div>\n                    <div className=\"font-medium\">{data.formattedRequests}</div>\n                  </div>\n                  <div>\n                    <div className=\"text-muted-foreground\">平均Token</div>\n                    <div className=\"font-medium\">\n                      {data.requests > 0 ? Math.round(data.totalTokens / data.requests) : 0}\n                    </div>\n                  </div>\n                </div>\n\n                {/* Token类型分布（仅在有数据时显示） */}\n                {(data.promptTokens > 0 || data.completionTokens > 0) && (\n                  <div className=\"mt-3 pt-3 border-t\">\n                    <div className=\"grid grid-cols-2 gap-3 text-xs\">\n                      <div>\n                        <div className=\"text-muted-foreground\">输入Token</div>\n                        <div className=\"font-medium\">\n                          {formatStatsNumber(data.promptTokens)}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-muted-foreground\">输出Token</div>\n                        <div className=\"font-medium\">\n                          {formatStatsNumber(data.completionTokens)}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )\n        })}\n      </div>\n\n      {/* 总计摘要卡片 */}\n      <Card className=\"border-dashed border-2\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h4 className=\"font-medium text-muted-foreground\">总计使用量</h4>\n              <div className=\"flex items-center gap-4 mt-1\">\n                <div className=\"text-sm\">\n                  <span className=\"text-2xl font-bold\">{totalStats.formattedTokens}</span>\n                  <span className=\"text-muted-foreground ml-1\">Tokens</span>\n                </div>\n                <div className=\"text-sm\">\n                  <span className=\"text-2xl font-bold\">{totalStats.formattedRequests}</span>\n                  <span className=\"text-muted-foreground ml-1\">请求</span>\n                </div>\n              </div>\n            </div>\n            <Badge variant=\"outline\" className=\"text-xs\">\n              累计统计\n            </Badge>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\templates\\prompt-template-library.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'template' is defined but never used. Allowed unused args must match /^_/u.","line":92,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":92,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"template"},"fix":{"range":[2302,2326],"text":""},"desc":"Remove unused variable 'template'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'content' is defined but never used. Allowed unused args must match /^_/u.","line":93,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":93,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"content"},"fix":{"range":[2356,2371],"text":""},"desc":"Remove unused variable 'content'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'content' is defined but never used. Allowed unused args must match /^_/u.","line":94,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":94,"endColumn":38,"suggestions":[{"messageId":"removeVar","data":{"varName":"content"},"fix":{"range":[2403,2418],"text":""},"desc":"Remove unused variable 'content'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\"\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\nimport { Wand2, Search, Star, Copy, Plus } from \"lucide-react\"\n\ninterface PromptTemplate {\n  id: string\n  title: string\n  description: string\n  content: string\n  category: string\n  tags: string[]\n  isPopular?: boolean\n}\n\nconst promptTemplates: PromptTemplate[] = [\n  {\n    id: \"1\",\n    title: \"美食短视频文案\",\n    description: \"适用于美食类短视频的文案创作\",\n    content:\n      \"请为我创作一个关于{食物名称}的短视频文案，要求：\\n1. 突出食物的色香味\\n2. 包含制作过程的亮点\\n3. 语言生动有趣，适合短视频传播\\n4. 字数控制在100-150字\",\n    category: \"美食\",\n    tags: [\"短视频\", \"美食\", \"文案\"],\n    isPopular: true,\n  },\n  {\n    id: \"2\",\n    title: \"旅游攻略文案\",\n    description: \"旅游景点介绍和攻略文案\",\n    content:\n      \"请为{目的地}创作一份旅游攻略文案，包括：\\n1. 景点特色介绍\\n2. 最佳游览时间\\n3. 交通方式\\n4. 美食推荐\\n5. 注意事项\\n语言要轻松愉快，适合社交媒体分享\",\n    category: \"旅游\",\n    tags: [\"旅游\", \"攻略\", \"介绍\"],\n    isPopular: true,\n  },\n  {\n    id: \"3\",\n    title: \"产品介绍文案\",\n    description: \"商品或服务的营销文案\",\n    content:\n      \"请为{产品名称}创作产品介绍文案：\\n1. 突出产品核心卖点\\n2. 解决用户痛点\\n3. 包含使用场景\\n4. 呼吁行动\\n5. 语言简洁有力，具有说服力\",\n    category: \"营销\",\n    tags: [\"产品\", \"营销\", \"介绍\"],\n  },\n  {\n    id: \"4\",\n    title: \"健身励志文案\",\n    description: \"健身运动相关的励志内容\",\n    content:\n      \"创作一段关于{运动类型}的励志文案：\\n1. 激发运动热情\\n2. 强调坚持的重要性\\n3. 分享运动带来的好处\\n4. 语言正能量，鼓舞人心\\n5. 适合健身社群分享\",\n    category: \"健身\",\n    tags: [\"健身\", \"励志\", \"运动\"],\n  },\n  {\n    id: \"5\",\n    title: \"科技产品评测\",\n    description: \"数码产品的专业评测文案\",\n    content:\n      \"请为{产品名称}写一份评测文案：\\n1. 外观设计分析\\n2. 功能特性介绍\\n3. 性能测试结果\\n4. 优缺点总结\\n5. 购买建议\\n语言专业客观，逻辑清晰\",\n    category: \"科技\",\n    tags: [\"科技\", \"评测\", \"数码\"],\n    isPopular: true,\n  },\n  {\n    id: \"6\",\n    title: \"生活小技巧分享\",\n    description: \"实用的生活窍门和技巧\",\n    content:\n      \"分享一个关于{生活场景}的实用小技巧：\\n1. 问题场景描述\\n2. 解决方法步骤\\n3. 注意事项\\n4. 效果说明\\n5. 语言通俗易懂，实用性强\",\n    category: \"生活\",\n    tags: [\"生活\", \"技巧\", \"实用\"],\n  },\n]\n\nconst categories = [\"全部\", \"美食\", \"旅游\", \"营销\", \"健身\", \"科技\", \"生活\"]\n\ninterface PromptTemplateLibraryProps {\n  onSelectTemplate: (template: PromptTemplate) => void\n  onInjectToChat?: (content: string) => void\n  onInjectToEditor?: (content: string) => void\n}\n\nexport function PromptTemplateLibrary({ onSelectTemplate, onInjectToChat }: PromptTemplateLibraryProps) {\n  const [open, setOpen] = useState(false)\n  const [searchQuery, setSearchQuery] = useState(\"\")\n  const [selectedCategory, setSelectedCategory] = useState(\"全部\")\n\n  const filteredTemplates = promptTemplates.filter((template) => {\n    const matchesSearch =\n      template.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      template.description.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      template.tags.some((tag) => tag.toLowerCase().includes(searchQuery.toLowerCase()))\n\n    const matchesCategory = selectedCategory === \"全部\" || template.category === selectedCategory\n\n    return matchesSearch && matchesCategory\n  })\n\n  const popularTemplates = promptTemplates.filter((template) => template.isPopular)\n\n  const handleSelectTemplate = (template: PromptTemplate) => {\n    onSelectTemplate(template)\n    // 统一输入入口：默认仅注入聊天输入框（Composer）\n    onInjectToChat?.(template.content)\n    setOpen(false)\n  }\n\n  const copyTemplate = (content: string) => {\n    navigator.clipboard.writeText(content)\n  }\n\n  return (\n    <Dialog open={open} onOpenChange={setOpen}>\n      <DialogTrigger asChild>\n        <Button variant=\"ghost\" size=\"sm\" className=\"gap-1 h-7 px-2\">\n          <Wand2 className=\"h-3 w-3\" />\n          <span className=\"text-xs\">模板</span>\n        </Button>\n      </DialogTrigger>\n      <DialogContent className=\"max-w-4xl max-h-[80vh]\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Wand2 className=\"h-5 w-5\" />\n            Prompt模板库\n          </DialogTitle>\n          <DialogDescription>选择合适的模板快速开始创作，或者从中获取灵感</DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {/* 搜索栏 */}\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"搜索模板...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-10\"\n            />\n          </div>\n\n          <Tabs value={selectedCategory} onValueChange={setSelectedCategory}>\n            <TabsList className=\"grid w-full grid-cols-7\">\n              {categories.map((category) => (\n                <TabsTrigger key={category} value={category} className=\"text-xs\">\n                  {category}\n                </TabsTrigger>\n              ))}\n            </TabsList>\n\n            <TabsContent value={selectedCategory} className=\"mt-4\">\n              <ScrollArea className=\"h-[50vh]\">\n                <div className=\"space-y-4\">\n                  {selectedCategory === \"全部\" && (\n                    <div className=\"mb-6\">\n                      <div className=\"flex items-center gap-2 mb-3\">\n                        <Star className=\"h-4 w-4 text-yellow-500\" />\n                        <h3 className=\"font-medium\">热门模板</h3>\n                      </div>\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                        {popularTemplates.map((template) => (\n                          <div\n                            key={template.id}\n                            className=\"border border-border rounded-lg p-4 hover:bg-muted/50 cursor-pointer transition-colors\"\n                            onClick={() => handleSelectTemplate(template)}\n                          >\n                            <div className=\"flex items-start justify-between mb-2\">\n                              <h4 className=\"font-medium text-sm\">{template.title}</h4>\n                              <div className=\"flex items-center gap-1\">\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"h-6 w-6 p-0\"\n                                  onClick={(e) => {\n                                    e.stopPropagation()\n                                    copyTemplate(template.content)\n                                  }}\n                                >\n                                  <Copy className=\"h-3 w-3\" />\n                                </Button>\n                                <Star className=\"h-3 w-3 text-yellow-500 fill-current\" />\n                              </div>\n                            </div>\n                            <p className=\"text-xs text-muted-foreground mb-2\">{template.description}</p>\n                            <div className=\"flex items-center gap-1\">\n                              <Badge variant=\"secondary\" className=\"text-xs\">\n                                {template.category}\n                              </Badge>\n                              {template.tags.slice(0, 2).map((tag) => (\n                                <Badge key={tag} variant=\"outline\" className=\"text-xs\">\n                                  {tag}\n                                </Badge>\n                              ))}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                    {filteredTemplates.map((template) => (\n                      <div\n                        key={template.id}\n                        className=\"border border-border rounded-lg p-4 hover:bg-muted/50 cursor-pointer transition-colors\"\n                        onClick={() => handleSelectTemplate(template)}\n                      >\n                        <div className=\"flex items-start justify-between mb-2\">\n                          <h4 className=\"font-medium text-sm\">{template.title}</h4>\n                          <div className=\"flex items-center gap-1\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              className=\"h-6 w-6 p-0\"\n                              onClick={(e) => {\n                                e.stopPropagation()\n                                copyTemplate(template.content)\n                              }}\n                            >\n                              <Copy className=\"h-3 w-3\" />\n                            </Button>\n                            {template.isPopular && <Star className=\"h-3 w-3 text-yellow-500 fill-current\" />}\n                          </div>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground mb-2 line-clamp-2\">{template.description}</p>\n                        <div className=\"flex items-center gap-1 flex-wrap\">\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            {template.category}\n                          </Badge>\n                          {template.tags.slice(0, 2).map((tag) => (\n                            <Badge key={tag} variant=\"outline\" className=\"text-xs\">\n                              {tag}\n                            </Badge>\n                          ))}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n\n                  {filteredTemplates.length === 0 && (\n                    <div className=\"text-center py-8\">\n                      <div className=\"w-12 h-12 bg-muted rounded-full flex items-center justify-center mx-auto mb-3\">\n                        <Search className=\"h-6 w-6 text-muted-foreground\" />\n                      </div>\n                      <p className=\"text-muted-foreground\">未找到匹配的模板</p>\n                      <p className=\"text-sm text-muted-foreground mt-1\">尝试调整搜索关键词或选择其他分类</p>\n                    </div>\n                  )}\n                </div>\n              </ScrollArea>\n            </TabsContent>\n          </Tabs>\n\n          <div className=\"flex items-center justify-between pt-4 border-t\">\n            <div className=\"text-sm text-muted-foreground\">共 {filteredTemplates.length} 个模板</div>\n            <Button variant=\"outline\" size=\"sm\" className=\"gap-2 bg-transparent\">\n              <Plus className=\"h-3 w-3\" />\n              自定义模板\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\carousel.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'api' is defined but never used. Allowed unused args must match /^_/u.","line":21,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"api"},"fix":{"range":[600,616],"text":""},"desc":"Remove unused variable 'api'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nfunction Carousel({\n  orientation = \"horizontal\",\n  opts,\n  setApi,\n  plugins,\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & CarouselProps) {\n  const [carouselRef, api] = useEmblaCarousel(\n    {\n      ...opts,\n      axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n    },\n    plugins\n  )\n  const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n  const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n  const onSelect = React.useCallback((api: CarouselApi) => {\n    if (!api) return\n    setCanScrollPrev(api.canScrollPrev())\n    setCanScrollNext(api.canScrollNext())\n  }, [])\n\n  const scrollPrev = React.useCallback(() => {\n    api?.scrollPrev()\n  }, [api])\n\n  const scrollNext = React.useCallback(() => {\n    api?.scrollNext()\n  }, [api])\n\n  const handleKeyDown = React.useCallback(\n    (event: React.KeyboardEvent<HTMLDivElement>) => {\n      if (event.key === \"ArrowLeft\") {\n        event.preventDefault()\n        scrollPrev()\n      } else if (event.key === \"ArrowRight\") {\n        event.preventDefault()\n        scrollNext()\n      }\n    },\n    [scrollPrev, scrollNext]\n  )\n\n  React.useEffect(() => {\n    if (!api || !setApi) return\n    setApi(api)\n  }, [api, setApi])\n\n  React.useEffect(() => {\n    if (!api) return\n    onSelect(api)\n    api.on(\"reInit\", onSelect)\n    api.on(\"select\", onSelect)\n\n    return () => {\n      api?.off(\"select\", onSelect)\n    }\n  }, [api, onSelect])\n\n  return (\n    <CarouselContext.Provider\n      value={{\n        carouselRef,\n        api: api,\n        opts,\n        orientation:\n          orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n        scrollPrev,\n        scrollNext,\n        canScrollPrev,\n        canScrollNext,\n      }}\n    >\n      <div\n        onKeyDownCapture={handleKeyDown}\n        className={cn(\"relative\", className)}\n        role=\"region\"\n        aria-roledescription=\"carousel\"\n        data-slot=\"carousel\"\n        {...props}\n      >\n        {children}\n      </div>\n    </CarouselContext.Provider>\n  )\n}\n\nfunction CarouselContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div\n      ref={carouselRef}\n      className=\"overflow-hidden\"\n      data-slot=\"carousel-content\"\n    >\n      <div\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n}\n\nfunction CarouselItem({ className, ...props }: React.ComponentProps<\"div\">) {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      data-slot=\"carousel-item\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CarouselPrevious({\n  className,\n  variant = \"outline\",\n  size = \"icon\",\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      data-slot=\"carousel-previous\"\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute size-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"top-1/2 -left-12 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n}\n\nfunction CarouselNext({\n  className,\n  variant = \"outline\",\n  size = \"icon\",\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      data-slot=\"carousel-next\"\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute size-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"top-1/2 -right-12 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n}\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\chart.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'k' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":4,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":5,"suggestions":[{"messageId":"removeVar","data":{"varName":"k"},"fix":{"range":[262,263],"text":""},"desc":"Remove unused variable 'k'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport * as RechartsPrimitive from \"recharts\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// Format: { THEME_NAME: CSS_SELECTOR }\r\nconst THEMES = { light: \"\", dark: \".dark\" } as const\r\n\r\nexport type ChartConfig = {\r\n  [k in string]: {\r\n    label?: React.ReactNode\r\n    icon?: React.ComponentType\r\n  } & (\r\n    | { color?: string; theme?: never }\r\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\r\n  )\r\n}\r\n\r\ntype ChartContextProps = {\r\n  config: ChartConfig\r\n}\r\n\r\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\r\n\r\nfunction useChart() {\r\n  const context = React.useContext(ChartContext)\r\n\r\n  if (!context) {\r\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\r\n  }\r\n\r\n  return context\r\n}\r\n\r\nfunction ChartContainer({\r\n  id,\r\n  className,\r\n  children,\r\n  config,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & {\r\n  config: ChartConfig\r\n  children: React.ComponentProps<\r\n    typeof RechartsPrimitive.ResponsiveContainer\r\n  >[\"children\"]\r\n}) {\r\n  const uniqueId = React.useId()\r\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\r\n\r\n  return (\r\n    <ChartContext.Provider value={{ config }}>\r\n      <div\r\n        data-slot=\"chart\"\r\n        data-chart={chartId}\r\n        className={cn(\r\n          \"[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden\",\r\n          className\r\n        )}\r\n        {...props}\r\n      >\r\n        <ChartStyle id={chartId} config={config} />\r\n        <RechartsPrimitive.ResponsiveContainer>\r\n          {children}\r\n        </RechartsPrimitive.ResponsiveContainer>\r\n      </div>\r\n    </ChartContext.Provider>\r\n  )\r\n}\r\n\r\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\r\n  const colorConfig = Object.entries(config).filter(\r\n    ([, config]) => config.theme || config.color\r\n  )\r\n\r\n  if (!colorConfig.length) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <style\r\n      dangerouslySetInnerHTML={{\r\n        __html: Object.entries(THEMES)\r\n          .map(\r\n            ([theme, prefix]) => `\r\n${prefix} [data-chart=${id}] {\r\n${colorConfig\r\n  .map(([key, itemConfig]) => {\r\n    const color =\r\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\r\n      itemConfig.color\r\n    return color ? `  --color-${key}: ${color};` : null\r\n  })\r\n  .join(\"\\n\")}\r\n}\r\n`\r\n          )\r\n          .join(\"\\n\"),\r\n      }}\r\n    />\r\n  )\r\n}\r\n\r\nconst ChartTooltip = RechartsPrimitive.Tooltip\r\n\r\nfunction ChartTooltipContent({\r\n  active,\r\n  payload,\r\n  className,\r\n  indicator = \"dot\",\r\n  hideLabel = false,\r\n  hideIndicator = false,\r\n  label,\r\n  labelFormatter,\r\n  labelClassName,\r\n  formatter,\r\n  color,\r\n  nameKey,\r\n  labelKey,\r\n}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\r\n  React.ComponentProps<\"div\"> & {\r\n    hideLabel?: boolean\r\n    hideIndicator?: boolean\r\n    indicator?: \"line\" | \"dot\" | \"dashed\"\r\n    nameKey?: string\r\n    labelKey?: string\r\n    payload?: any[]\r\n    label?: any\r\n  }) {\r\n  const { config } = useChart()\r\n\r\n  const tooltipLabel = React.useMemo(() => {\r\n    if (hideLabel || !payload?.length) {\r\n      return null\r\n    }\r\n\r\n    const [item] = payload\r\n    const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\r\n    const itemConfig = getPayloadConfigFromPayload(config, item, key)\r\n    const value =\r\n      !labelKey && typeof label === \"string\"\r\n        ? config[label as keyof typeof config]?.label || label\r\n        : itemConfig?.label\r\n\r\n    if (labelFormatter) {\r\n      return (\r\n        <div className={cn(\"font-medium\", labelClassName)}>\r\n          {labelFormatter(value, payload)}\r\n        </div>\r\n      )\r\n    }\r\n\r\n    if (!value) {\r\n      return null\r\n    }\r\n\r\n    return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\r\n  }, [\r\n    label,\r\n    labelFormatter,\r\n    payload,\r\n    hideLabel,\r\n    labelClassName,\r\n    config,\r\n    labelKey,\r\n  ])\r\n\r\n  if (!active || !payload?.length) {\r\n    return null\r\n  }\r\n\r\n  const nestLabel = payload.length === 1 && indicator !== \"dot\"\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl\",\r\n        className\r\n      )}\r\n    >\r\n      {!nestLabel ? tooltipLabel : null}\r\n      <div className=\"grid gap-1.5\">\r\n        {payload.map((item: any, index: number) => {\r\n          const key = `${nameKey || item.name || item.dataKey || \"value\"}`\r\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\r\n          const indicatorColor = color || item.payload.fill || item.color\r\n\r\n          return (\r\n            <div\r\n              key={item.dataKey}\r\n              className={cn(\r\n                \"[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5\",\r\n                indicator === \"dot\" && \"items-center\"\r\n              )}\r\n            >\r\n              {formatter && item?.value !== undefined && item.name ? (\r\n                formatter(item.value, item.name, item, index, item.payload)\r\n              ) : (\r\n                <>\r\n                  {itemConfig?.icon ? (\r\n                    <itemConfig.icon />\r\n                  ) : (\r\n                    !hideIndicator && (\r\n                      <div\r\n                        className={cn(\r\n                          \"shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)\",\r\n                          {\r\n                            \"h-2.5 w-2.5\": indicator === \"dot\",\r\n                            \"w-1\": indicator === \"line\",\r\n                            \"w-0 border-[1.5px] border-dashed bg-transparent\":\r\n                              indicator === \"dashed\",\r\n                            \"my-0.5\": nestLabel && indicator === \"dashed\",\r\n                          }\r\n                        )}\r\n                        style={\r\n                          {\r\n                            \"--color-bg\": indicatorColor,\r\n                            \"--color-border\": indicatorColor,\r\n                          } as React.CSSProperties\r\n                        }\r\n                      />\r\n                    )\r\n                  )}\r\n                  <div\r\n                    className={cn(\r\n                      \"flex flex-1 justify-between leading-none\",\r\n                      nestLabel ? \"items-end\" : \"items-center\"\r\n                    )}\r\n                  >\r\n                    <div className=\"grid gap-1.5\">\r\n                      {nestLabel ? tooltipLabel : null}\r\n                      <span className=\"text-muted-foreground\">\r\n                        {itemConfig?.label || item.name}\r\n                      </span>\r\n                    </div>\r\n                    {item.value && (\r\n                      <span className=\"text-foreground font-mono font-medium tabular-nums\">\r\n                        {item.value.toLocaleString()}\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </>\r\n              )}\r\n            </div>\r\n          )\r\n        })}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nconst ChartLegend = RechartsPrimitive.Legend\r\n\r\nfunction ChartLegendContent({\r\n  className,\r\n  hideIcon = false,\r\n  payload,\r\n  verticalAlign = \"bottom\",\r\n  nameKey,\r\n}: React.ComponentProps<\"div\"> & {\r\n    hideIcon?: boolean\r\n    nameKey?: string\r\n    payload?: any[]\r\n    verticalAlign?: \"bottom\" | \"top\"\r\n  }) {\r\n  const { config } = useChart()\r\n\r\n  if (!payload?.length) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"flex items-center justify-center gap-4\",\r\n        verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\r\n        className\r\n      )}\r\n    >\r\n      {payload.map((item: any) => {\r\n        const key = `${nameKey || item.dataKey || \"value\"}`\r\n        const itemConfig = getPayloadConfigFromPayload(config, item, key)\r\n\r\n        return (\r\n          <div\r\n            key={item.value}\r\n            className={cn(\r\n              \"[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3\"\r\n            )}\r\n          >\r\n            {itemConfig?.icon && !hideIcon ? (\r\n              <itemConfig.icon />\r\n            ) : (\r\n              <div\r\n                className=\"h-2 w-2 shrink-0 rounded-[2px]\"\r\n                style={{\r\n                  backgroundColor: item.color,\r\n                }}\r\n              />\r\n            )}\r\n            {itemConfig?.label}\r\n          </div>\r\n        )\r\n      })}\r\n    </div>\r\n  )\r\n}\r\n\r\n// Helper to extract item config from a payload.\r\nfunction getPayloadConfigFromPayload(\r\n  config: ChartConfig,\r\n  payload: unknown,\r\n  key: string\r\n) {\r\n  if (typeof payload !== \"object\" || payload === null) {\r\n    return undefined\r\n  }\r\n\r\n  const payloadPayload =\r\n    \"payload\" in payload &&\r\n    typeof payload.payload === \"object\" &&\r\n    payload.payload !== null\r\n      ? payload.payload\r\n      : undefined\r\n\r\n  let configLabelKey: string = key\r\n\r\n  if (\r\n    key in payload &&\r\n    typeof payload[key as keyof typeof payload] === \"string\"\r\n  ) {\r\n    configLabelKey = payload[key as keyof typeof payload] as string\r\n  } else if (\r\n    payloadPayload &&\r\n    key in payloadPayload &&\r\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\r\n  ) {\r\n    configLabelKey = payloadPayload[\r\n      key as keyof typeof payloadPayload\r\n    ] as string\r\n  }\r\n\r\n  return configLabelKey in config\r\n    ? config[configLabelKey]\r\n    : config[key as keyof typeof config]\r\n}\r\n\r\nexport {\r\n  ChartContainer,\r\n  ChartTooltip,\r\n  ChartTooltipContent,\r\n  ChartLegend,\r\n  ChartLegendContent,\r\n  ChartStyle,\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\connection-recovery.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'Wifi' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":7,"suggestions":[{"messageId":"removeVar","data":{"varName":"Wifi"},"fix":{"range":[359,368],"text":""},"desc":"Remove unused variable 'Wifi'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":112,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":112,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":150,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":150,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 连接恢复组件\n * 提供友好的网络连接错误处理和恢复界面\n */\n\n\"use client\"\n\nimport { useState, useEffect, useCallback } from 'react'\nimport { Button } from '@/components/ui/button'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Progress } from '@/components/ui/progress'\nimport { Badge } from '@/components/ui/badge'\nimport { \n  RefreshCw, \n  Wifi, \n  WifiOff, \n  Server, \n  AlertTriangle, \n  CheckCircle,\n  Clock,\n  Activity\n} from 'lucide-react'\nimport { smartApi } from '@/lib/utils/smart-fetch'\nimport { cn } from '@/lib/utils'\n\nexport interface ConnectionRecoveryProps {\n  /** 是否显示恢复界面 */\n  show?: boolean\n  /** 错误类型 */\n  errorType?: 'network' | 'server' | 'timeout' | 'unknown'\n  /** 错误消息 */\n  errorMessage?: string\n  /** 自动重试间隔（毫秒） */\n  autoRetryInterval?: number\n  /** 最大自动重试次数 */\n  maxAutoRetries?: number\n  /** 恢复成功回调 */\n  onRecovery?: () => void\n  /** 关闭回调 */\n  onClose?: () => void\n  /** 自定义恢复操作 */\n  customRecoveryAction?: () => Promise<boolean>\n  /** 是否显示详细状态 */\n  showDetailedStatus?: boolean\n}\n\ninterface RecoveryStatus {\n  isRetrying: boolean\n  currentAttempt: number\n  maxAttempts: number\n  lastAttemptTime?: number\n  nextRetryTime?: number\n  connectionQuality?: 'good' | 'poor' | 'offline'\n  serverStatus?: 'healthy' | 'unhealthy' | 'unknown'\n}\n\nexport function ConnectionRecovery({\n  show = true,\n  errorType = 'unknown',\n  errorMessage,\n  autoRetryInterval = 5000,\n  maxAutoRetries = 5,\n  onRecovery,\n  onClose,\n  customRecoveryAction,\n  showDetailedStatus = true\n}: ConnectionRecoveryProps) {\n  const [status, setStatus] = useState<RecoveryStatus>({\n    isRetrying: false,\n    currentAttempt: 0,\n    maxAttempts: maxAutoRetries\n  })\n\n  const [countdown, setCountdown] = useState(0)\n  const [showAdvanced, setShowAdvanced] = useState(false)\n\n  /**\n   * 执行连接检查\n   */\n  const checkConnection = useCallback(async (): Promise<boolean> => {\n    try {\n      if (customRecoveryAction) {\n        return await customRecoveryAction()\n      }\n\n      // 检查网络状态\n      const networkOnline = navigator.onLine\n      if (!networkOnline) {\n        setStatus(prev => ({ \n          ...prev, \n          connectionQuality: 'offline',\n          serverStatus: 'unknown'\n        }))\n        return false\n      }\n\n      // 检查服务器健康状态\n      const response = await smartApi.get('/api/health', {\n        timeout: 8000,\n        retry: { maxRetries: 1 }\n      })\n\n      const isHealthy = response.ok\n      \n      setStatus(prev => ({ \n        ...prev,\n        connectionQuality: isHealthy ? 'good' : 'poor',\n        serverStatus: isHealthy ? 'healthy' : 'unhealthy'\n      }))\n\n      return isHealthy\n    } catch (error) {\n      setStatus(prev => ({\n        ...prev,\n        connectionQuality: 'offline',\n        serverStatus: 'unhealthy'\n      }))\n      \n      return false\n    }\n  }, [customRecoveryAction])\n\n  /**\n   * 执行恢复尝试\n   */\n  const attemptRecovery = useCallback(async (manual = false) => {\n    if (status.isRetrying && !manual) return\n\n    setStatus(prev => ({\n      ...prev,\n      isRetrying: true,\n      currentAttempt: manual ? prev.currentAttempt + 1 : prev.currentAttempt,\n      lastAttemptTime: Date.now()\n    }))\n\n    try {\n      const success = await checkConnection()\n      \n      if (success) {\n        onRecovery?.()\n        return true\n      } else {\n        setStatus(prev => ({\n          ...prev,\n          currentAttempt: prev.currentAttempt + 1,\n          nextRetryTime: Date.now() + autoRetryInterval\n        }))\n        return false\n      }\n    } catch (error) {\n      return false\n    } finally {\n      setStatus(prev => ({ ...prev, isRetrying: false }))\n    }\n  }, [status.isRetrying, checkConnection, autoRetryInterval, onRecovery])\n\n  /**\n   * 自动重试逻辑\n   */\n  useEffect(() => {\n    if (!show || status.currentAttempt >= status.maxAttempts) return\n\n    const timer = setTimeout(() => {\n      attemptRecovery(false)\n    }, autoRetryInterval)\n\n    return () => clearTimeout(timer)\n  }, [show, status.currentAttempt, status.maxAttempts, autoRetryInterval, attemptRecovery])\n\n  /**\n   * 倒计时逻辑\n   */\n  useEffect(() => {\n    if (!status.nextRetryTime || status.isRetrying) return\n\n    const updateCountdown = () => {\n      const remaining = Math.max(0, status.nextRetryTime! - Date.now())\n      setCountdown(Math.ceil(remaining / 1000))\n      \n      if (remaining <= 0) {\n        setCountdown(0)\n      }\n    }\n\n    updateCountdown()\n    const interval = setInterval(updateCountdown, 1000)\n\n    return () => clearInterval(interval)\n  }, [status.nextRetryTime, status.isRetrying])\n\n  /**\n   * 获取错误配置\n   */\n  const getErrorConfig = useCallback(() => {\n    switch (errorType) {\n      case 'network':\n        return {\n          icon: WifiOff,\n          title: '网络连接中断',\n          description: '无法连接到网络，请检查您的网络设置',\n          color: 'text-red-500',\n          bgColor: 'bg-red-50 dark:bg-red-950/20'\n        }\n      case 'server':\n        return {\n          icon: Server,\n          title: '服务器连接失败',\n          description: '服务器可能正在维护或遇到问题',\n          color: 'text-orange-500',\n          bgColor: 'bg-orange-50 dark:bg-orange-950/20'\n        }\n      case 'timeout':\n        return {\n          icon: Clock,\n          title: '连接超时',\n          description: '服务器响应时间过长，请稍后重试',\n          color: 'text-yellow-500',\n          bgColor: 'bg-yellow-50 dark:bg-yellow-950/20'\n        }\n      default:\n        return {\n          icon: AlertTriangle,\n          title: '连接异常',\n          description: errorMessage || '遇到未知的连接问题',\n          color: 'text-gray-500',\n          bgColor: 'bg-gray-50 dark:bg-gray-950/20'\n        }\n    }\n  }, [errorType, errorMessage])\n\n  /**\n   * 获取状态指示器\n   */\n  const getStatusIndicator = () => {\n    const { connectionQuality, serverStatus } = status\n\n    if (connectionQuality === 'offline') {\n      return <Badge variant=\"destructive\" className=\"gap-1\">\n        <WifiOff className=\"w-3 h-3\" />\n        离线\n      </Badge>\n    }\n\n    if (serverStatus === 'unhealthy') {\n      return <Badge variant=\"destructive\" className=\"gap-1\">\n        <Server className=\"w-3 h-3\" />\n        服务器异常\n      </Badge>\n    }\n\n    if (connectionQuality === 'poor') {\n      return <Badge variant=\"secondary\" className=\"gap-1\">\n        <Activity className=\"w-3 h-3\" />\n        连接质量差\n      </Badge>\n    }\n\n    if (connectionQuality === 'good' && serverStatus === 'healthy') {\n      return <Badge variant=\"default\" className=\"gap-1 bg-green-500\">\n        <CheckCircle className=\"w-3 h-3\" />\n        连接正常\n      </Badge>\n    }\n\n    return null\n  }\n\n  if (!show) return null\n\n  const errorConfig = getErrorConfig()\n  const Icon = errorConfig.icon\n  const progress = (status.currentAttempt / status.maxAttempts) * 100\n\n  return (\n    <div className=\"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4\">\n      <Card className={cn(\"w-full max-w-md\", errorConfig.bgColor)}>\n        <CardHeader className=\"text-center pb-4\">\n          <div className={cn(\"w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center\", errorConfig.bgColor)}>\n            <Icon className={cn(\"w-8 h-8\", errorConfig.color)} />\n          </div>\n          \n          <CardTitle className=\"flex items-center justify-center gap-2\">\n            {errorConfig.title}\n            {showDetailedStatus && getStatusIndicator()}\n          </CardTitle>\n          \n          <p className=\"text-sm text-muted-foreground\">\n            {errorConfig.description}\n          </p>\n        </CardHeader>\n\n        <CardContent className=\"space-y-4\">\n          {/* 重试进度 */}\n          {status.currentAttempt > 0 && (\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span>重试进度</span>\n                <span>{status.currentAttempt}/{status.maxAttempts}</span>\n              </div>\n              <Progress value={progress} className=\"h-2\" />\n            </div>\n          )}\n\n          {/* 倒计时 */}\n          {countdown > 0 && !status.isRetrying && (\n            <div className=\"text-center text-sm text-muted-foreground\">\n              {countdown} 秒后自动重试...\n            </div>\n          )}\n\n          {/* 操作按钮 */}\n          <div className=\"flex gap-2\">\n            <Button \n              onClick={() => attemptRecovery(true)} \n              disabled={status.isRetrying}\n              className=\"flex-1\"\n            >\n              {status.isRetrying ? (\n                <>\n                  <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                  重连中...\n                </>\n              ) : (\n                <>\n                  <RefreshCw className=\"w-4 h-4 mr-2\" />\n                  立即重试\n                </>\n              )}\n            </Button>\n            \n            <Button \n              variant=\"outline\" \n              onClick={() => window.location.reload()}\n            >\n              刷新页面\n            </Button>\n          </div>\n\n          {/* 高级选项 */}\n          {showDetailedStatus && (\n            <div className=\"space-y-3\">\n              <Button \n                variant=\"ghost\" \n                size=\"sm\"\n                onClick={() => setShowAdvanced(!showAdvanced)}\n                className=\"w-full text-xs\"\n              >\n                {showAdvanced ? '隐藏' : '显示'}详细状态\n              </Button>\n\n              {showAdvanced && (\n                <div className=\"bg-muted/50 rounded-lg p-3 space-y-2 text-xs\">\n                  <div className=\"grid grid-cols-2 gap-2\">\n                    <div>\n                      <span className=\"font-medium\">网络状态:</span>\n                      <br />\n                      <span className={cn(\n                        navigator.onLine ? 'text-green-600' : 'text-red-600'\n                      )}>\n                        {navigator.onLine ? '在线' : '离线'}\n                      </span>\n                    </div>\n                    <div>\n                      <span className=\"font-medium\">连接质量:</span>\n                      <br />\n                      <span>\n                        {status.connectionQuality === 'good' ? '良好' : \n                         status.connectionQuality === 'poor' ? '较差' : '离线'}\n                      </span>\n                    </div>\n                  </div>\n                  \n                  {status.lastAttemptTime && (\n                    <div className=\"text-muted-foreground\">\n                      上次检查: {new Date(status.lastAttemptTime).toLocaleTimeString()}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* 关闭按钮 */}\n          {onClose && (\n            <Button \n              variant=\"ghost\" \n              size=\"sm\" \n              onClick={onClose}\n              className=\"w-full\"\n            >\n              暂时关闭提示\n            </Button>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  )\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\connection-status.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'Wifi' is defined but never used. Allowed unused vars must match /^_/u.","line":13,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":7,"suggestions":[{"messageId":"removeVar","data":{"varName":"Wifi"},"fix":{"range":[265,270],"text":""},"desc":"Remove unused variable 'Wifi'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'connected' is defined but never used. Allowed unused args must match /^_/u.","line":48,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"connected"},"fix":{"range":[954,972],"text":""},"desc":"Remove unused variable 'connected'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 响应式连接状态指示组件\r\n * 用于在主界面显示连接监控状态的轻量级指示器\r\n * Phase 1: 基础设施搭建\r\n */\r\n\r\n'use client';\r\n\r\nimport { useConnectionMonitor } from '@/hooks/use-connection-monitor';\r\nimport { useState, useEffect, useRef } from 'react';\r\nimport { cn } from '@/lib/utils';\r\nimport { \r\n  Wifi, \r\n  WifiOff, \r\n  Server, \r\n  RefreshCw, \r\n  CheckCircle, \r\n  AlertTriangle,\r\n  Clock,\r\n  Loader2\r\n} from 'lucide-react';\r\n\r\n// 动画样式类\r\nconst getAnimationClasses = (status: string, animated: boolean) => {\r\n  if (!animated) return '';\r\n  \r\n  const classes = [];\r\n  \r\n  if (status !== 'healthy') {\r\n    classes.push('connection-pulse');\r\n  }\r\n  \r\n  return classes.join(' ');\r\n};\r\n\r\nexport interface ConnectionStatusProps {\r\n  /** 是否显示详细信息 */\r\n  showDetails?: boolean;\r\n  /** 组件大小 */\r\n  size?: 'sm' | 'md' | 'lg';\r\n  /** 显示位置 */\r\n  position?: 'fixed' | 'relative';\r\n  /** 是否显示文本标签 */\r\n  showLabel?: boolean;\r\n  /** 自定义CSS类名 */\r\n  className?: string;\r\n  /** 状态变化回调 */\r\n  onStatusChange?: (connected: boolean) => void;\r\n  /** 是否启用动画效果 */\r\n  animated?: boolean;\r\n  /** 是否自动隐藏良好状态 */\r\n  autoHideWhenHealthy?: boolean;\r\n  /** Tooltip延迟显示时间(ms) */\r\n  tooltipDelay?: number;\r\n}\r\n\r\nexport function ConnectionStatus({\r\n  showDetails = false,\r\n  size = 'md',\r\n  position = 'relative',\r\n  showLabel = true,\r\n  className,\r\n  onStatusChange,\r\n  animated = true,\r\n  autoHideWhenHealthy = false,\r\n  tooltipDelay = 500\r\n}: ConnectionStatusProps) {\r\n  const [showTooltip, setShowTooltip] = useState(false);\r\n  const [isRefreshing, setIsRefreshing] = useState(false);\r\n  const [previousStatus, setPreviousStatus] = useState<string>('unknown');\r\n  const [tooltipPosition, setTooltipPosition] = useState<'top' | 'bottom'>('top');\r\n  const [isMounted, setIsMounted] = useState(false);\r\n  const tooltipTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const componentRef = useRef<HTMLDivElement>(null);\r\n  \r\n  const {\r\n    isConnected,\r\n    isOnline,\r\n    isServerHealthy,\r\n    responseTime,\r\n    consecutiveFailures,\r\n    currentInterval,\r\n    error,\r\n    triggerHealthCheck,\r\n    debugInfo\r\n  } = useConnectionMonitor({\r\n    onStatusChange: (state) => {\r\n      const currentStatus = state.isOnline && state.isServerHealthy ? 'healthy' : 'unhealthy';\r\n      if (currentStatus !== previousStatus && animated) {\r\n        setPreviousStatus(currentStatus);\r\n      }\r\n      onStatusChange?.(state.isOnline && state.isServerHealthy);\r\n    }\r\n  });\r\n\r\n  // 客户端挂载标记\r\n  useEffect(() => {\r\n    setIsMounted(true);\r\n  }, []);\r\n\r\n  // 状态变化动画效果\r\n  useEffect(() => {\r\n    if (componentRef.current && animated && isMounted) {\r\n      const element = componentRef.current;\r\n      element.style.transform = 'scale(1.05)';\r\n      setTimeout(() => {\r\n        element.style.transform = 'scale(1)';\r\n      }, 150);\r\n    }\r\n  }, [isConnected, animated, isMounted]);\r\n\r\n  // 清理定时器\r\n  useEffect(() => {\r\n    return () => {\r\n      if (tooltipTimeoutRef.current) {\r\n        clearTimeout(tooltipTimeoutRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  // 获取状态配置 - 服务端渲染时始终返回默认状态\r\n  const getStatusConfig = () => {\r\n    // 服务端渲染或未挂载时，返回默认的健康状态\r\n    if (!isMounted) {\r\n      return {\r\n        icon: CheckCircle,\r\n        color: 'text-green-500',\r\n        bgColor: 'bg-green-50 dark:bg-green-950/20',\r\n        borderColor: 'border-green-200 dark:border-green-800',\r\n        label: '正常',\r\n        status: 'healthy' as const,\r\n        pulseColor: 'shadow-green-400/50',\r\n        ariaLabel: '连接状态检查中'\r\n      };\r\n    }\r\n\r\n    // 客户端已挂载，使用真实状态\r\n    if (!isOnline) {\r\n      return {\r\n        icon: WifiOff,\r\n        color: 'text-red-500',\r\n        bgColor: 'bg-red-50 dark:bg-red-950/20',\r\n        borderColor: 'border-red-200 dark:border-red-800',\r\n        label: '离线',\r\n        status: 'offline' as const,\r\n        pulseColor: 'shadow-red-400/50',\r\n        ariaLabel: '网络连接离线，无法访问服务'\r\n      };\r\n    }\r\n\r\n    if (!isServerHealthy) {\r\n      return {\r\n        icon: Server,\r\n        color: 'text-yellow-500', \r\n        bgColor: 'bg-yellow-50 dark:bg-yellow-950/20',\r\n        borderColor: 'border-yellow-200 dark:border-yellow-800',\r\n        label: '服务异常',\r\n        status: 'error' as const,\r\n        pulseColor: 'shadow-yellow-400/50',\r\n        ariaLabel: '服务器连接异常，可能正在维护'\r\n      };\r\n    }\r\n\r\n    if (consecutiveFailures > 0) {\r\n      return {\r\n        icon: AlertTriangle,\r\n        color: 'text-orange-500',\r\n        bgColor: 'bg-orange-50 dark:bg-orange-950/20', \r\n        borderColor: 'border-orange-200 dark:border-orange-800',\r\n        label: '不稳定',\r\n        status: 'warning' as const,\r\n        pulseColor: 'shadow-orange-400/50',\r\n        ariaLabel: `连接不稳定，已连续失败${consecutiveFailures}次`\r\n      };\r\n    }\r\n\r\n    return {\r\n      icon: CheckCircle,\r\n      color: 'text-green-500',\r\n      bgColor: 'bg-green-50 dark:bg-green-950/20',\r\n      borderColor: 'border-green-200 dark:border-green-800', \r\n      label: '正常',\r\n      status: 'healthy' as const,\r\n      pulseColor: 'shadow-green-400/50',\r\n      ariaLabel: `连接正常，响应时间${responseTime || 0}毫秒`\r\n    };\r\n  };\r\n\r\n  // 获取尺寸配置\r\n  const getSizeConfig = () => {\r\n    switch (size) {\r\n      case 'sm':\r\n        return {\r\n          container: 'h-6 gap-1.5',\r\n          icon: 'w-3 h-3',\r\n          text: 'text-xs',\r\n          button: 'h-6 w-6 p-1'\r\n        };\r\n      case 'lg':\r\n        return {\r\n          container: 'h-10 gap-2.5',\r\n          icon: 'w-5 h-5', \r\n          text: 'text-sm',\r\n          button: 'h-8 w-8 p-1.5'\r\n        };\r\n      default: // md\r\n        return {\r\n          container: 'h-8 gap-2',\r\n          icon: 'w-4 h-4',\r\n          text: 'text-sm',\r\n          button: 'h-7 w-7 p-1'\r\n        };\r\n    }\r\n  };\r\n\r\n  const statusConfig = getStatusConfig();\r\n  const sizeConfig = getSizeConfig();\r\n  const Icon = statusConfig.icon;\r\n\r\n  // 智能检测tooltip位置，避免与Header重叠\r\n  const detectTooltipPosition = () => {\r\n    if (!componentRef.current) return 'top';\r\n    \r\n    const rect = componentRef.current.getBoundingClientRect();\r\n    const headerHeight = 64; // Header组件高度16 (4rem)\r\n    const tooltipHeight = 80; // 估计tooltip高度\r\n    \r\n    // 如果组件距离顶部太近（可能与Header重叠），显示在下方\r\n    if (rect.top - tooltipHeight < headerHeight + 8) {\r\n      return 'bottom';\r\n    }\r\n    \r\n    return 'top';\r\n  };\r\n\r\n  // 处理Tooltip显示逻辑\r\n  const handleTooltipShow = () => {\r\n    if (tooltipTimeoutRef.current) {\r\n      clearTimeout(tooltipTimeoutRef.current);\r\n    }\r\n    tooltipTimeoutRef.current = setTimeout(() => {\r\n      setTooltipPosition(detectTooltipPosition());\r\n      setShowTooltip(true);\r\n    }, tooltipDelay);\r\n  };\r\n\r\n  const handleTooltipHide = () => {\r\n    if (tooltipTimeoutRef.current) {\r\n      clearTimeout(tooltipTimeoutRef.current);\r\n    }\r\n    setShowTooltip(false);\r\n  };\r\n\r\n  // 手动刷新处理\r\n  const handleManualRefresh = async () => {\r\n    setIsRefreshing(true);\r\n    try {\r\n      await triggerHealthCheck();\r\n    } finally {\r\n      setTimeout(() => setIsRefreshing(false), 500);\r\n    }\r\n  };\r\n\r\n  // 生成tooltip内容\r\n  const getTooltipContent = () => {\r\n    const parts = [];\r\n    \r\n    parts.push(`状态: ${statusConfig.label}`);\r\n    \r\n    if (responseTime) {\r\n      const quality = responseTime < 200 ? '优秀' : responseTime < 500 ? '良好' : responseTime < 1000 ? '一般' : '较慢';\r\n      parts.push(`响应时间: ${responseTime}ms (${quality})`);\r\n    }\r\n    \r\n    if (consecutiveFailures > 0) {\r\n      parts.push(`连续失败: ${consecutiveFailures}次`);\r\n    }\r\n    \r\n    parts.push(`检查间隔: ${currentInterval/1000}s`);\r\n    \r\n    if (debugInfo.successRate > 0) {\r\n      parts.push(`成功率: ${Math.round(debugInfo.successRate)}%`);\r\n    }\r\n    \r\n    if (error) {\r\n      parts.push(`错误: ${error}`);\r\n    }\r\n    \r\n    return parts.join('\\n');\r\n  };\r\n\r\n  // 根据设置决定是否显示组件\r\n  const shouldHide = autoHideWhenHealthy && statusConfig.status === 'healthy' && consecutiveFailures === 0;\r\n  \r\n  const baseClasses = cn(\r\n    'inline-flex items-center px-3 py-1 rounded-full border connection-responsive',\r\n    'transform hover:scale-105 focus-within:scale-105',\r\n    'hover:shadow-md focus-within:shadow-md',\r\n    statusConfig.bgColor,\r\n    statusConfig.borderColor,\r\n    sizeConfig.container,\r\n    position === 'fixed' && 'fixed top-4 right-4 z-[45] shadow-lg',\r\n    getAnimationClasses(statusConfig.status, animated),\r\n    shouldHide && 'opacity-30 hover:opacity-100 transition-opacity',\r\n    className\r\n  );\r\n\r\n  return (\r\n    <div \r\n      ref={componentRef}\r\n      className={baseClasses}\r\n      onMouseEnter={handleTooltipShow}\r\n      onMouseLeave={handleTooltipHide}\r\n      onFocus={handleTooltipShow}\r\n      onBlur={handleTooltipHide}\r\n      role=\"status\"\r\n      aria-live=\"polite\"\r\n      aria-label={statusConfig.ariaLabel}\r\n      tabIndex={0}\r\n    >\r\n      {/* 状态图标 */}\r\n      <Icon \r\n        className={cn(\r\n          sizeConfig.icon, \r\n          statusConfig.color,\r\n          animated && isMounted && statusConfig.status !== 'healthy' && 'animate-pulse'\r\n        )} \r\n        aria-hidden=\"true\"\r\n      />\r\n      \r\n      {/* 状态文本 */}\r\n      {showLabel && (\r\n        <span className={cn(sizeConfig.text, statusConfig.color, 'font-medium')}>\r\n          {statusConfig.label}\r\n        </span>\r\n      )}\r\n\r\n      {/* 响应时间 */}\r\n      {showDetails && responseTime && (\r\n        <span className={cn(sizeConfig.text, 'text-gray-500 font-mono')}>\r\n          {responseTime}ms\r\n        </span>\r\n      )}\r\n\r\n      {/* 手动刷新按钮 */}\r\n      <button\r\n        onClick={handleManualRefresh}\r\n        disabled={isRefreshing}\r\n        className={cn(\r\n          'rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-all duration-200',\r\n          'flex items-center justify-center',\r\n          'focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500',\r\n          'disabled:opacity-50 disabled:cursor-not-allowed',\r\n          sizeConfig.button\r\n        )}\r\n        title=\"手动检查连接\"\r\n        aria-label=\"手动检查网络连接状态\"\r\n      >\r\n        {isRefreshing ? (\r\n          <Loader2 className=\"w-3 h-3 text-gray-400 animate-spin\" />\r\n        ) : (\r\n          <RefreshCw className=\"w-3 h-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors\" />\r\n        )}\r\n      </button>\r\n\r\n      {/* Tooltip */}\r\n      {showTooltip && (\r\n        <div className={cn(\r\n          \"absolute left-1/2 transform -translate-x-1/2 z-[60] connection-fade-in\",\r\n          tooltipPosition === 'top' ? \"bottom-full mb-2\" : \"top-full mt-2\"\r\n        )}>\r\n          <div className=\"bg-gray-900 dark:bg-gray-800 text-white text-xs rounded-lg px-4 py-3 whitespace-pre-line max-w-sm md:max-w-2xl shadow-lg border border-gray-700\">\r\n            {getTooltipContent()}\r\n            {/* 箭头指向 */}\r\n            <div className={cn(\r\n              \"absolute left-1/2 transform -translate-x-1/2 border-4 border-transparent\",\r\n              tooltipPosition === 'top' \r\n                ? \"top-full border-t-gray-900 dark:border-t-gray-800\"\r\n                : \"bottom-full border-b-gray-900 dark:border-b-gray-800\"\r\n            )}></div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* 详细状态面板 */}\r\n      {showDetails && (\r\n        <div className=\"ml-2 flex items-center gap-1.5 text-xs text-gray-500\">\r\n          {/* 检查间隔指示器 */}\r\n          <div className=\"flex items-center gap-1\">\r\n            <Clock className=\"w-3 h-3\" />\r\n            <span className=\"font-mono\">{currentInterval/1000}s</span>\r\n          </div>\r\n\r\n          {/* 失败次数 */}\r\n          {consecutiveFailures > 0 && (\r\n            <div className=\"text-red-500 font-medium\">\r\n              ×{consecutiveFailures}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n/**\r\n * 预设的状态指示器变体\r\n */\r\nexport const ConnectionStatusVariants = {\r\n  // 顶部固定状态栏\r\n  TopBar: (props: Omit<ConnectionStatusProps, 'position' | 'size'>) => (\r\n    <ConnectionStatus {...props} position=\"fixed\" size=\"sm\" />\r\n  ),\r\n\r\n  // 侧边栏状态\r\n  Sidebar: (props: Omit<ConnectionStatusProps, 'showDetails' | 'size'>) => (\r\n    <ConnectionStatus {...props} showDetails={true} size=\"md\" />\r\n  ),\r\n\r\n  // 紧凑状态指示器（仅图标）\r\n  Compact: (props: Omit<ConnectionStatusProps, 'showLabel' | 'size'>) => (\r\n    <ConnectionStatus {...props} showLabel={false} size=\"sm\" />\r\n  ),\r\n\r\n  // 详细状态面板\r\n  Detailed: (props: Omit<ConnectionStatusProps, 'showDetails' | 'size'>) => (\r\n    <ConnectionStatus {...props} showDetails={true} size=\"lg\" />\r\n  )\r\n};","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\error-boundary.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used. Allowed unused args must match /^_/u.","line":30,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"error"},"fix":{"range":[690,703],"text":""},"desc":"Remove unused variable 'error'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'errorInfo' is defined but never used. Allowed unused args must match /^_/u.","line":30,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":61,"suggestions":[{"messageId":"removeVar","data":{"varName":"errorInfo"},"fix":{"range":[702,730],"text":""},"desc":"Remove unused variable 'errorInfo'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport type React from \"react\"\n\nimport { Component, type ReactNode } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\nimport { AlertTriangle, RefreshCw } from \"lucide-react\"\n\ninterface Props {\n  children: ReactNode\n  fallback?: ReactNode\n}\n\ninterface State {\n  hasError: boolean\n  error?: Error\n}\n\nexport class ErrorBoundary extends Component<Props, State> {\n  constructor(props: Props) {\n    super(props)\n    this.state = { hasError: false }\n  }\n\n  static getDerivedStateFromError(error: Error): State {\n    return { hasError: true, error }\n  }\n\n  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {\n    }\n\n  render() {\n    if (this.state.hasError) {\n      if (this.props.fallback) {\n        return this.props.fallback\n      }\n\n      return (\n        <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n          <Card className=\"max-w-md w-full\">\n            <CardHeader className=\"text-center\">\n              <div className=\"mx-auto w-12 h-12 bg-destructive/10 rounded-full flex items-center justify-center mb-4\">\n                <AlertTriangle className=\"h-6 w-6 text-destructive\" />\n              </div>\n              <CardTitle>出现了一些问题</CardTitle>\n              <CardDescription>应用程序遇到了意外错误，请尝试刷新页面。</CardDescription>\n            </CardHeader>\n            <CardContent className=\"text-center space-y-4\">\n              <Button onClick={() => window.location.reload()} className=\"gap-2\">\n                <RefreshCw className=\"h-4 w-4\" />\n                刷新页面\n              </Button>\n              <details className=\"text-left\">\n                <summary className=\"text-sm text-muted-foreground cursor-pointer hover:text-foreground\">\n                  查看错误详情\n                </summary>\n                <pre className=\"mt-2 text-xs bg-muted p-2 rounded overflow-auto max-h-32\">\n                  {this.state.error?.message}\n                </pre>\n              </details>\n            </CardContent>\n          </Card>\n        </div>\n      )\n    }\n\n    return this.props.children\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\keyboard-shortcuts.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'open' is defined but never used. Allowed unused args must match /^_/u.","line":10,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"open"},"fix":{"range":[378,391],"text":""},"desc":"Remove unused variable 'open'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { MessageSquare, TrendingUp, FileText, Keyboard } from \"lucide-react\"\r\n\r\ninterface KeyboardShortcutsProps {\r\n  open: boolean\r\n  onOpenChange: (open: boolean) => void\r\n}\r\n\r\nexport function KeyboardShortcuts({ open, onOpenChange }: KeyboardShortcutsProps) {\r\n  const shortcuts = [\r\n    {\r\n      category: \"导航\",\r\n      items: [\r\n        { keys: [\"Ctrl\", \"1\"], description: \"打开对话页面\", icon: MessageSquare },\r\n        { keys: [\"Ctrl\", \"2\"], description: \"打开热门数据\", icon: TrendingUp },\r\n        { keys: [\"Ctrl\", \"3\"], description: \"打开文档管理\", icon: FileText },\r\n        { keys: [\"Ctrl\", \"K\"], description: \"显示快捷键\", icon: Keyboard },\r\n      ],\r\n    },\r\n    {\r\n      category: \"对话功能\",\r\n      items: [\r\n        { keys: [\"Enter\"], description: \"发送消息\" },\r\n        { keys: [\"Shift\", \"Enter\"], description: \"换行\" },\r\n        { keys: [\"Ctrl\", \"N\"], description: \"新建对话\" },\r\n        { keys: [\"Ctrl\", \"/\"], description: \"搜索对话\" },\r\n      ],\r\n    },\r\n    {\r\n      category: \"编辑功能\",\r\n      items: [\r\n        { keys: [\"Ctrl\", \"S\"], description: \"保存文档\" },\r\n        { keys: [\"Ctrl\", \"Z\"], description: \"撤销\" },\r\n        { keys: [\"Ctrl\", \"Y\"], description: \"重做\" },\r\n        { keys: [\"Ctrl\", \"F\"], description: \"查找\" },\r\n      ],\r\n    },\r\n  ]\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"max-w-2xl\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <Keyboard className=\"h-5 w-5\" />\r\n            键盘快捷键\r\n          </DialogTitle>\r\n          <DialogDescription>使用这些快捷键提高您的工作效率</DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-6\">\r\n          {shortcuts.map((category) => (\r\n            <div key={category.category}>\r\n              <h3 className=\"font-medium text-sm text-muted-foreground mb-3\">{category.category}</h3>\r\n              <div className=\"space-y-2\">\r\n                {category.items.map((item, index) => (\r\n                  <div key={index} className=\"flex items-center justify-between py-2\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      {\"icon\" in item && item.icon && <item.icon className=\"h-4 w-4 text-muted-foreground\" />}\r\n                      <span className=\"text-sm\">{item.description}</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1\">\r\n                      {item.keys.map((key, keyIndex) => (\r\n                        <div key={keyIndex} className=\"flex items-center gap-1\">\r\n                          <Badge variant=\"outline\" className=\"px-2 py-1 text-xs font-mono\">\r\n                            {key}\r\n                          </Badge>\r\n                          {keyIndex < item.keys.length - 1 && <span className=\"text-xs text-muted-foreground\">+</span>}\r\n                        </div>\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n              {category.category !== shortcuts[shortcuts.length - 1].category && <Separator className=\"mt-4\" />}\r\n            </div>\r\n          ))}\r\n        </div>\r\n\r\n        <div className=\"text-xs text-muted-foreground text-center pt-4 border-t\">\r\n          按{\" \"}\r\n          <Badge variant=\"outline\" className=\"px-1 py-0.5 text-xs\">\r\n            Esc\r\n          </Badge>{\" \"}\r\n          关闭此对话框\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\retry-wrapper.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":46,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'handleReset' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":52,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useCallback, type ReactNode } from \"react\"\nimport { ErrorState } from \"./error-state\"\nimport { LoadingState } from \"./loading-state\"\n\ninterface RetryWrapperProps {\n  children: ReactNode\n  onRetry: () => Promise<void>\n  loading?: boolean\n  error?: Error | string | null\n  maxRetries?: number\n  retryDelay?: number\n  loadingMessage?: string\n  errorTitle?: string\n  errorDescription?: string\n  showErrorDetails?: boolean\n}\n\nexport function RetryWrapper({\n  children,\n  onRetry,\n  loading = false,\n  error = null,\n  maxRetries = 3,\n  retryDelay = 1000,\n  loadingMessage = \"加载中...\",\n  errorTitle,\n  errorDescription,\n  showErrorDetails = false,\n}: RetryWrapperProps) {\n  const [retryCount, setRetryCount] = useState(0)\n  const [isRetrying, setIsRetrying] = useState(false)\n\n  const handleRetry = useCallback(async () => {\n    if (retryCount >= maxRetries) {\n      return\n    }\n\n    setIsRetrying(true)\n    setRetryCount((prev) => prev + 1)\n\n    try {\n      await new Promise((resolve) => setTimeout(resolve, retryDelay))\n      await onRetry()\n    } catch (error) {\n      } finally {\n      setIsRetrying(false)\n    }\n  }, [onRetry, retryCount, maxRetries, retryDelay])\n\n  const handleReset = useCallback(() => {\n    setRetryCount(0)\n    setIsRetrying(false)\n  }, [])\n\n  if (loading || isRetrying) {\n    return <LoadingState message={isRetrying ? `重试中... (${retryCount}/${maxRetries})` : loadingMessage} />\n  }\n\n  if (error) {\n    const canRetry = retryCount < maxRetries\n    return (\n      <ErrorState\n        title={errorTitle}\n        description={errorDescription}\n        error={error}\n        onRetry={canRetry ? handleRetry : undefined}\n        showDetails={showErrorDetails}\n        type={typeof error === \"string\" && error.includes(\"网络\") ? \"network\" : \"generic\"}\n      />\n    )\n  }\n\n  return <>{children}</>\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\sidebar.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'open' is defined but never used. Allowed unused args must match /^_/u.","line":38,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":38,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"open"},"fix":{"range":[1059,1072],"text":""},"desc":"Remove unused variable 'open'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'open' is defined but never used. Allowed unused args must match /^_/u.","line":40,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"open"},"fix":{"range":[1124,1137],"text":""},"desc":"Remove unused variable 'open'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'open' is defined but never used. Allowed unused args must match /^_/u.","line":67,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":67,"endColumn":32,"suggestions":[{"messageId":"removeVar","data":{"varName":"open"},"fix":{"range":[1729,1742],"text":""},"desc":"Remove unused variable 'open'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'value' is defined but never used. Allowed unused args must match /^_/u.","line":77,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":77,"endColumn":39,"suggestions":[{"messageId":"removeVar","data":{"varName":"value"},"fix":{"range":[2134,2148],"text":""},"desc":"Remove unused variable 'value'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { Slot } from \"@radix-ui/react-slot\"\r\nimport { cva, VariantProps } from \"class-variance-authority\"\r\nimport { PanelLeftIcon } from \"lucide-react\"\r\n\r\nimport { useMobile } from \"@/hooks/use-mobile\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport {\r\n  Sheet,\r\n  SheetContent,\r\n  SheetDescription,\r\n  SheetHeader,\r\n  SheetTitle,\r\n} from \"@/components/ui/sheet\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\"\r\n\r\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\r\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\r\nconst SIDEBAR_WIDTH = \"16rem\"\r\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\r\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\r\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\r\n\r\ntype SidebarContextProps = {\r\n  state: \"expanded\" | \"collapsed\"\r\n  open: boolean\r\n  setOpen: (open: boolean) => void\r\n  openMobile: boolean\r\n  setOpenMobile: (open: boolean) => void\r\n  isMobile: boolean\r\n  toggleSidebar: () => void\r\n}\r\n\r\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\r\n\r\nfunction useSidebar() {\r\n  const context = React.useContext(SidebarContext)\r\n  if (!context) {\r\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\r\n  }\r\n\r\n  return context\r\n}\r\n\r\nfunction SidebarProvider({\r\n  defaultOpen = true,\r\n  open: openProp,\r\n  onOpenChange: setOpenProp,\r\n  className,\r\n  style,\r\n  children,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & {\r\n  defaultOpen?: boolean\r\n  open?: boolean\r\n  onOpenChange?: (open: boolean) => void\r\n}) {\r\n  const isMobile = useMobile()\r\n  const [openMobile, setOpenMobile] = React.useState(false)\r\n\r\n  // This is the internal state of the sidebar.\r\n  // We use openProp and setOpenProp for control from outside the component.\r\n  const [_open, _setOpen] = React.useState(defaultOpen)\r\n  const open = openProp ?? _open\r\n  const setOpen = React.useCallback(\r\n    (value: boolean | ((value: boolean) => boolean)) => {\r\n      const openState = typeof value === \"function\" ? value(open) : value\r\n      if (setOpenProp) {\r\n        setOpenProp(openState)\r\n      } else {\r\n        _setOpen(openState)\r\n      }\r\n\r\n      // This sets the cookie to keep the sidebar state.\r\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\r\n    },\r\n    [setOpenProp, open]\r\n  )\r\n\r\n  // Helper to toggle the sidebar.\r\n  const toggleSidebar = React.useCallback(() => {\r\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\r\n  }, [isMobile, setOpen, setOpenMobile])\r\n\r\n  // Adds a keyboard shortcut to toggle the sidebar.\r\n  React.useEffect(() => {\r\n    const handleKeyDown = (event: KeyboardEvent) => {\r\n      if (\r\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\r\n        (event.metaKey || event.ctrlKey)\r\n      ) {\r\n        event.preventDefault()\r\n        toggleSidebar()\r\n      }\r\n    }\r\n\r\n    window.addEventListener(\"keydown\", handleKeyDown)\r\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\r\n  }, [toggleSidebar])\r\n\r\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\r\n  // This makes it easier to style the sidebar with Tailwind classes.\r\n  const state = open ? \"expanded\" : \"collapsed\"\r\n\r\n  const contextValue = React.useMemo<SidebarContextProps>(\r\n    () => ({\r\n      state,\r\n      open,\r\n      setOpen,\r\n      isMobile,\r\n      openMobile,\r\n      setOpenMobile,\r\n      toggleSidebar,\r\n    }),\r\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\r\n  )\r\n\r\n  return (\r\n    <SidebarContext.Provider value={contextValue}>\r\n      <TooltipProvider delayDuration={0}>\r\n        <div\r\n          data-slot=\"sidebar-wrapper\"\r\n          style={\r\n            {\r\n              \"--sidebar-width\": SIDEBAR_WIDTH,\r\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\r\n              ...style,\r\n            } as React.CSSProperties\r\n          }\r\n          className={cn(\r\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\r\n            className\r\n          )}\r\n          {...props}\r\n        >\r\n          {children}\r\n        </div>\r\n      </TooltipProvider>\r\n    </SidebarContext.Provider>\r\n  )\r\n}\r\n\r\nfunction Sidebar({\r\n  side = \"left\",\r\n  variant = \"sidebar\",\r\n  collapsible = \"offcanvas\",\r\n  className,\r\n  children,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & {\r\n  side?: \"left\" | \"right\"\r\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\r\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\r\n}) {\r\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\r\n\r\n  if (collapsible === \"none\") {\r\n    return (\r\n      <div\r\n        data-slot=\"sidebar\"\r\n        className={cn(\r\n          \"bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col\",\r\n          className\r\n        )}\r\n        {...props}\r\n      >\r\n        {children}\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (isMobile) {\r\n    return (\r\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\r\n        <SheetContent\r\n          data-sidebar=\"sidebar\"\r\n          data-slot=\"sidebar\"\r\n          data-mobile=\"true\"\r\n          className=\"bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden\"\r\n          style={\r\n            {\r\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\r\n            } as React.CSSProperties\r\n          }\r\n          side={side}\r\n        >\r\n          <SheetHeader className=\"sr-only\">\r\n            <SheetTitle>Sidebar</SheetTitle>\r\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\r\n          </SheetHeader>\r\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\r\n        </SheetContent>\r\n      </Sheet>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className=\"group peer text-sidebar-foreground hidden md:block\"\r\n      data-state={state}\r\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\r\n      data-variant={variant}\r\n      data-side={side}\r\n      data-slot=\"sidebar\"\r\n    >\r\n      {/* This is what handles the sidebar gap on desktop */}\r\n      <div\r\n        data-slot=\"sidebar-gap\"\r\n        className={cn(\r\n          \"relative w-(--sidebar-width) bg-transparent transition-[width] duration-200 ease-linear\",\r\n          \"group-data-[collapsible=offcanvas]:w-0\",\r\n          \"group-data-[side=right]:rotate-180\",\r\n          variant === \"floating\" || variant === \"inset\"\r\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]\"\r\n            : \"group-data-[collapsible=icon]:w-(--sidebar-width-icon)\"\r\n        )}\r\n      />\r\n      <div\r\n        data-slot=\"sidebar-container\"\r\n        className={cn(\r\n          \"fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-[left,right,width] duration-200 ease-linear md:flex\",\r\n          side === \"left\"\r\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\r\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\r\n          // Adjust the padding for floating and inset variants.\r\n          variant === \"floating\" || variant === \"inset\"\r\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]\"\r\n            : \"group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l\",\r\n          className\r\n        )}\r\n        {...props}\r\n      >\r\n        <div\r\n          data-sidebar=\"sidebar\"\r\n          data-slot=\"sidebar-inner\"\r\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\r\n        >\r\n          {children}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction SidebarTrigger({\r\n  className,\r\n  onClick,\r\n  ...props\r\n}: React.ComponentProps<typeof Button>) {\r\n  const { toggleSidebar } = useSidebar()\r\n\r\n  return (\r\n    <Button\r\n      data-sidebar=\"trigger\"\r\n      data-slot=\"sidebar-trigger\"\r\n      variant=\"ghost\"\r\n      size=\"icon\"\r\n      className={cn(\"size-7\", className)}\r\n      onClick={(event) => {\r\n        onClick?.(event)\r\n        toggleSidebar()\r\n      }}\r\n      {...props}\r\n    >\r\n      <PanelLeftIcon />\r\n      <span className=\"sr-only\">Toggle Sidebar</span>\r\n    </Button>\r\n  )\r\n}\r\n\r\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\r\n  const { toggleSidebar } = useSidebar()\r\n\r\n  return (\r\n    <button\r\n      data-sidebar=\"rail\"\r\n      data-slot=\"sidebar-rail\"\r\n      aria-label=\"Toggle Sidebar\"\r\n      tabIndex={-1}\r\n      onClick={toggleSidebar}\r\n      title=\"Toggle Sidebar\"\r\n      className={cn(\r\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\r\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\r\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\r\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\r\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\r\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\r\n  return (\r\n    <main\r\n      data-slot=\"sidebar-inset\"\r\n      className={cn(\r\n        \"bg-background relative flex w-full flex-1 flex-col\",\r\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarInput({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<typeof Input>) {\r\n  return (\r\n    <Input\r\n      data-slot=\"sidebar-input\"\r\n      data-sidebar=\"input\"\r\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-header\"\r\n      data-sidebar=\"header\"\r\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-footer\"\r\n      data-sidebar=\"footer\"\r\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarSeparator({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<typeof Separator>) {\r\n  return (\r\n    <Separator\r\n      data-slot=\"sidebar-separator\"\r\n      data-sidebar=\"separator\"\r\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-content\"\r\n      data-sidebar=\"content\"\r\n      className={cn(\r\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-group\"\r\n      data-sidebar=\"group\"\r\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarGroupLabel({\r\n  className,\r\n  asChild = false,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\r\n  const Comp = asChild ? Slot : \"div\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"sidebar-group-label\"\r\n      data-sidebar=\"group-label\"\r\n      className={cn(\r\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarGroupAction({\r\n  className,\r\n  asChild = false,\r\n  ...props\r\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\r\n  const Comp = asChild ? Slot : \"button\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"sidebar-group-action\"\r\n      data-sidebar=\"group-action\"\r\n      className={cn(\r\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        // Increases the hit area of the button on mobile.\r\n        \"after:absolute after:-inset-2 md:after:hidden\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarGroupContent({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-group-content\"\r\n      data-sidebar=\"group-content\"\r\n      className={cn(\"w-full text-sm\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\r\n  return (\r\n    <ul\r\n      data-slot=\"sidebar-menu\"\r\n      data-sidebar=\"menu\"\r\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\r\n  return (\r\n    <li\r\n      data-slot=\"sidebar-menu-item\"\r\n      data-sidebar=\"menu-item\"\r\n      className={cn(\"group/menu-item relative\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nconst sidebarMenuButtonVariants = cva(\r\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\r\n        outline:\r\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\r\n      },\r\n      size: {\r\n        default: \"h-8 text-sm\",\r\n        sm: \"h-7 text-xs\",\r\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  }\r\n)\r\n\r\nfunction SidebarMenuButton({\r\n  asChild = false,\r\n  isActive = false,\r\n  variant = \"default\",\r\n  size = \"default\",\r\n  tooltip,\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"button\"> & {\r\n  asChild?: boolean\r\n  isActive?: boolean\r\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\r\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\r\n  const Comp = asChild ? Slot : \"button\"\r\n  const { isMobile, state } = useSidebar()\r\n\r\n  const button = (\r\n    <Comp\r\n      data-slot=\"sidebar-menu-button\"\r\n      data-sidebar=\"menu-button\"\r\n      data-size={size}\r\n      data-active={isActive}\r\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\r\n      {...props}\r\n    />\r\n  )\r\n\r\n  if (!tooltip) {\r\n    return button\r\n  }\r\n\r\n  if (typeof tooltip === \"string\") {\r\n    tooltip = {\r\n      children: tooltip,\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Tooltip>\r\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\r\n      <TooltipContent\r\n        side=\"right\"\r\n        align=\"center\"\r\n        hidden={state !== \"collapsed\" || isMobile}\r\n        {...tooltip}\r\n      />\r\n    </Tooltip>\r\n  )\r\n}\r\n\r\nfunction SidebarMenuAction({\r\n  className,\r\n  asChild = false,\r\n  showOnHover = false,\r\n  ...props\r\n}: React.ComponentProps<\"button\"> & {\r\n  asChild?: boolean\r\n  showOnHover?: boolean\r\n}) {\r\n  const Comp = asChild ? Slot : \"button\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"sidebar-menu-action\"\r\n      data-sidebar=\"menu-action\"\r\n      className={cn(\r\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        // Increases the hit area of the button on mobile.\r\n        \"after:absolute after:-inset-2 md:after:hidden\",\r\n        \"peer-data-[size=sm]/menu-button:top-1\",\r\n        \"peer-data-[size=default]/menu-button:top-1.5\",\r\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        showOnHover &&\r\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuBadge({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-menu-badge\"\r\n      data-sidebar=\"menu-badge\"\r\n      className={cn(\r\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\r\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\r\n        \"peer-data-[size=sm]/menu-button:top-1\",\r\n        \"peer-data-[size=default]/menu-button:top-1.5\",\r\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuSkeleton({\r\n  className,\r\n  showIcon = false,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & {\r\n  showIcon?: boolean\r\n}) {\r\n  // Random width between 50 to 90%.\r\n  const width = React.useMemo(() => {\r\n    return `${Math.floor(Math.random() * 40) + 50}%`\r\n  }, [])\r\n\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-menu-skeleton\"\r\n      data-sidebar=\"menu-skeleton\"\r\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\r\n      {...props}\r\n    >\r\n      {showIcon && (\r\n        <Skeleton\r\n          className=\"size-4 rounded-md\"\r\n          data-sidebar=\"menu-skeleton-icon\"\r\n        />\r\n      )}\r\n      <Skeleton\r\n        className=\"h-4 max-w-(--skeleton-width) flex-1\"\r\n        data-sidebar=\"menu-skeleton-text\"\r\n        style={\r\n          {\r\n            \"--skeleton-width\": width,\r\n          } as React.CSSProperties\r\n        }\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\r\n  return (\r\n    <ul\r\n      data-slot=\"sidebar-menu-sub\"\r\n      data-sidebar=\"menu-sub\"\r\n      className={cn(\r\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuSubItem({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"li\">) {\r\n  return (\r\n    <li\r\n      data-slot=\"sidebar-menu-sub-item\"\r\n      data-sidebar=\"menu-sub-item\"\r\n      className={cn(\"group/menu-sub-item relative\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuSubButton({\r\n  asChild = false,\r\n  size = \"md\",\r\n  isActive = false,\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"a\"> & {\r\n  asChild?: boolean\r\n  size?: \"sm\" | \"md\"\r\n  isActive?: boolean\r\n}) {\r\n  const Comp = asChild ? Slot : \"a\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"sidebar-menu-sub-button\"\r\n      data-sidebar=\"menu-sub-button\"\r\n      data-size={size}\r\n      data-active={isActive}\r\n      className={cn(\r\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\r\n        size === \"sm\" && \"text-xs\",\r\n        size === \"md\" && \"text-sm\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nexport {\r\n  Sidebar,\r\n  SidebarContent,\r\n  SidebarFooter,\r\n  SidebarGroup,\r\n  SidebarGroupAction,\r\n  SidebarGroupContent,\r\n  SidebarGroupLabel,\r\n  SidebarHeader,\r\n  SidebarInput,\r\n  SidebarInset,\r\n  SidebarMenu,\r\n  SidebarMenuAction,\r\n  SidebarMenuBadge,\r\n  SidebarMenuButton,\r\n  SidebarMenuItem,\r\n  SidebarMenuSkeleton,\r\n  SidebarMenuSub,\r\n  SidebarMenuSubButton,\r\n  SidebarMenuSubItem,\r\n  SidebarProvider,\r\n  SidebarRail,\r\n  SidebarSeparator,\r\n  SidebarTrigger,\r\n  useSidebar,\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\ui\\use-toast.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'state' is defined but never used. Allowed unused args must match /^_/u.","line":132,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":132,"endColumn":37,"suggestions":[{"messageId":"removeVar","data":{"varName":"state"},"fix":{"range":[2753,2765],"text":""},"desc":"Remove unused variable 'state'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\n// Inspired by react-hot-toast library\nimport * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\components\\workspace\\conversation-search.tsx","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'query' is defined but never used. Allowed unused args must match /^_/u.","line":28,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"query"},"fix":{"range":[636,649],"text":""},"desc":"Remove unused variable 'query'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'filters' is defined but never used. Allowed unused args must match /^_/u.","line":36,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"filters"},"fix":{"range":[820,832],"text":""},"desc":"Remove unused variable 'filters'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'filters' is defined but never used. Allowed unused args must match /^_/u.","line":210,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":210,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"filters"},"fix":{"range":[5934,5946],"text":""},"desc":"Remove unused variable 'filters'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'filters' is defined but never used. Allowed unused args must match /^_/u.","line":215,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":215,"endColumn":10,"suggestions":[{"messageId":"removeVar","data":{"varName":"filters"},"fix":{"range":[6047,6055],"text":""},"desc":"Remove unused variable 'filters'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'onFiltersChange' is defined but never used. Allowed unused args must match /^_/u.","line":216,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":216,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"onFiltersChange"},"fix":{"range":[6054,6074],"text":""},"desc":"Remove unused variable 'onFiltersChange'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 对话搜索和过滤组件\r\n * Phase 1 实现：基础搜索 + 快速过滤\r\n */\r\n\r\n\"use client\"\r\n\r\nimport React, { useState } from 'react'\r\nimport { Search, Filter, X, Clock, MessageSquare, Tag, Calendar } from 'lucide-react'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from '@/components/ui/popover'\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from '@/components/ui/select'\r\n\r\ninterface ConversationSearchProps {\r\n  searchQuery: string\r\n  onSearchChange: (query: string) => void\r\n  onClearSearch: () => void\r\n  isSearching?: boolean\r\n  resultCount?: number\r\n  filters: {\r\n    sortBy: string\r\n    sortOrder: string\r\n  }\r\n  onFiltersChange: (filters: any) => void\r\n}\r\n\r\ninterface QuickFilter {\r\n  key: string\r\n  label: string\r\n  icon: React.ReactNode\r\n  count?: number\r\n  active?: boolean\r\n}\r\n\r\nexport const ConversationSearch: React.FC<ConversationSearchProps> = ({\r\n  searchQuery,\r\n  onSearchChange,\r\n  onClearSearch,\r\n  isSearching = false,\r\n  resultCount,\r\n  filters,\r\n  onFiltersChange\r\n}) => {\r\n  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false)\r\n\r\n  // 快速过滤选项\r\n  const quickFilters: QuickFilter[] = [\r\n    {\r\n      key: 'today',\r\n      label: '今天',\r\n      icon: <Clock className=\"w-3 h-3\" />,\r\n      count: 5\r\n    },\r\n    {\r\n      key: 'week',\r\n      label: '本周',\r\n      icon: <Calendar className=\"w-3 h-3\" />,\r\n      count: 23\r\n    },\r\n    {\r\n      key: 'long',\r\n      label: '长对话',\r\n      icon: <MessageSquare className=\"w-3 h-3\" />,\r\n      count: 12\r\n    },\r\n    {\r\n      key: 'favorites',\r\n      label: '收藏',\r\n      icon: <Tag className=\"w-3 h-3\" />,\r\n      count: 8\r\n    }\r\n  ]\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      {/* 搜索输入框 */}\r\n      <div className=\"relative\">\r\n        <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4\" />\r\n        <Input\r\n          placeholder=\"搜索对话标题或内容...\"\r\n          value={searchQuery}\r\n          onChange={(e) => onSearchChange(e.target.value)}\r\n          className=\"pl-10 pr-10\"\r\n        />\r\n        {searchQuery && (\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={onClearSearch}\r\n            className=\"absolute right-1 top-1/2 transform -translate-y-1/2 h-6 w-6 p-0\"\r\n          >\r\n            <X className=\"w-3 h-3\" />\r\n          </Button>\r\n        )}\r\n        {isSearching && (\r\n          <div className=\"absolute right-8 top-1/2 transform -translate-y-1/2\">\r\n            <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary\"></div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* 搜索结果统计 */}\r\n      {searchQuery && (\r\n        <div className=\"flex items-center justify-between text-sm text-muted-foreground\">\r\n          <span>\r\n            {isSearching ? '搜索中...' : `找到 ${resultCount || 0} 个结果`}\r\n          </span>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={onClearSearch}\r\n            className=\"text-xs\"\r\n          >\r\n            清除搜索\r\n          </Button>\r\n        </div>\r\n      )}\r\n\r\n      {/* 快速过滤器 */}\r\n      <div className=\"flex items-center gap-2 flex-wrap\">\r\n        <span className=\"text-xs text-muted-foreground\">快速过滤:</span>\r\n        {quickFilters.map((filter) => (\r\n          <Badge\r\n            key={filter.key}\r\n            variant={filter.active ? \"default\" : \"secondary\"}\r\n            className=\"cursor-pointer text-xs\"\r\n            onClick={() => {\r\n              // 处理快速过滤逻辑\r\n              // TODO: 实现快速过滤功能\r\n            }}\r\n          >\r\n            {filter.icon}\r\n            <span className=\"ml-1\">{filter.label}</span>\r\n            {filter.count && (\r\n              <span className=\"ml-1 text-xs opacity-60\">({filter.count})</span>\r\n            )}\r\n          </Badge>\r\n        ))}\r\n      </div>\r\n\r\n      {/* 排序和高级过滤 */}\r\n      <div className=\"flex items-center justify-between\">\r\n        {/* 排序选项 */}\r\n        <div className=\"flex items-center gap-2\">\r\n          <span className=\"text-xs text-muted-foreground\">排序:</span>\r\n          <Select\r\n            value={filters.sortBy}\r\n            onValueChange={(value) => onFiltersChange({ ...filters, sortBy: value })}\r\n          >\r\n            <SelectTrigger className=\"w-32 h-8 text-xs\">\r\n              <SelectValue />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"recent\">最近更新</SelectItem>\r\n              <SelectItem value=\"alphabetical\">按标题</SelectItem>\r\n              <SelectItem value=\"messageCount\">消息数量</SelectItem>\r\n              <SelectItem value=\"relevance\">相关性</SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n          \r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => onFiltersChange({ \r\n              ...filters, \r\n              sortOrder: filters.sortOrder === 'desc' ? 'asc' : 'desc' \r\n            })}\r\n            className=\"h-8 px-2 text-xs\"\r\n          >\r\n            {filters.sortOrder === 'desc' ? '↓' : '↑'}\r\n          </Button>\r\n        </div>\r\n\r\n        {/* 高级过滤触发器 */}\r\n        <Popover open={showAdvancedFilters} onOpenChange={setShowAdvancedFilters}>\r\n          <PopoverTrigger asChild>\r\n            <Button variant=\"outline\" size=\"sm\" className=\"h-8 text-xs\">\r\n              <Filter className=\"w-3 h-3 mr-1\" />\r\n              高级过滤\r\n            </Button>\r\n          </PopoverTrigger>\r\n          <PopoverContent className=\"w-80 p-4\">\r\n            <AdvancedFilters\r\n              filters={filters}\r\n              onFiltersChange={onFiltersChange}\r\n              onClose={() => setShowAdvancedFilters(false)}\r\n            />\r\n          </PopoverContent>\r\n        </Popover>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// 高级过滤面板组件\r\ninterface AdvancedFiltersProps {\r\n  filters: any\r\n  onFiltersChange: (filters: any) => void\r\n  onClose: () => void\r\n}\r\n\r\nconst AdvancedFilters: React.FC<AdvancedFiltersProps> = ({\r\n  filters,\r\n  onFiltersChange,\r\n  onClose\r\n}) => {\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h4 className=\"font-medium text-sm\">高级过滤</h4>\r\n        <Button variant=\"ghost\" size=\"sm\" onClick={onClose} className=\"h-6 w-6 p-0\">\r\n          <X className=\"w-3 h-3\" />\r\n        </Button>\r\n      </div>\r\n\r\n      {/* 时间范围 */}\r\n      <div className=\"space-y-2\">\r\n        <label className=\"text-xs font-medium\">时间范围</label>\r\n        <Select>\r\n          <SelectTrigger className=\"text-xs\">\r\n            <SelectValue placeholder=\"选择时间范围\" />\r\n          </SelectTrigger>\r\n          <SelectContent>\r\n            <SelectItem value=\"today\">今天</SelectItem>\r\n            <SelectItem value=\"week\">本周</SelectItem>\r\n            <SelectItem value=\"month\">本月</SelectItem>\r\n            <SelectItem value=\"quarter\">本季度</SelectItem>\r\n            <SelectItem value=\"year\">今年</SelectItem>\r\n            <SelectItem value=\"custom\">自定义范围</SelectItem>\r\n          </SelectContent>\r\n        </Select>\r\n      </div>\r\n\r\n      {/* 模型过滤 */}\r\n      <div className=\"space-y-2\">\r\n        <label className=\"text-xs font-medium\">AI模型</label>\r\n        <div className=\"flex flex-wrap gap-1\">\r\n          {['claude-opus', 'gemini-pro', 'gpt-4'].map((model) => (\r\n            <Badge\r\n              key={model}\r\n              variant=\"secondary\"\r\n              className=\"cursor-pointer text-xs\"\r\n            >\r\n              {model}\r\n            </Badge>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      {/* 消息数量 */}\r\n      <div className=\"space-y-2\">\r\n        <label className=\"text-xs font-medium\">消息数量</label>\r\n        <div className=\"flex gap-2\">\r\n          <Input placeholder=\"最少\" className=\"text-xs\" />\r\n          <span className=\"text-xs self-center\">到</span>\r\n          <Input placeholder=\"最多\" className=\"text-xs\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* 操作按钮 */}\r\n      <div className=\"flex gap-2 pt-2\">\r\n        <Button size=\"sm\" className=\"flex-1 text-xs\">\r\n          应用过滤\r\n        </Button>\r\n        <Button variant=\"outline\" size=\"sm\" className=\"text-xs\">\r\n          重置\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  )\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\ai\\key-manager.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'config' is defined but never used. Allowed unused args must match /^_/u.","line":160,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":160,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"config"},"fix":{"range":[3584,3590],"text":"()"},"desc":"Remove unused variable 'config'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * AI模型API Key管理器\n * 支持按模型自动选择对应的API Key\n */\n\ninterface KeyConfig {\n  key: string\n  provider: string\n  models: string[]\n}\n\n// API Key配置映射\nconst KEY_CONFIGS: KeyConfig[] = [\n  {\n    key: process.env.LLM_CLAUDE_API_KEY || '',\n    provider: 'Claude',\n    models: ['claude-opus-4-1-20250805', 'claude-3-5-sonnet', 'claude-3-opus']\n  },\n  {\n    key: process.env.LLM_GEMINI_API_KEY || '',\n    provider: 'Google',\n    models: ['gemini-2.5-pro', 'gemini-1.5-pro']\n  },\n  {\n    key: process.env.LLM_OPENAI_API_KEY || '',\n    provider: 'OpenAI',\n    models: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo']\n  }\n]\n\n// 回退API Key（兼容旧配置）\nconst FALLBACK_KEY = process.env.LLM_API_KEY || ''\n\nexport interface KeySelectionResult {\n  apiKey: string\n  provider: string\n  keySource: 'specific' | 'fallback' | 'none'\n  confidence: 'high' | 'medium' | 'low'\n}\n\n/**\n * 根据模型ID选择最合适的API Key\n */\nexport function selectApiKey(modelId: string): KeySelectionResult {\n  // 1. 精确匹配：在配置中查找支持该模型的专属key\n  for (const config of KEY_CONFIGS) {\n    if (config.key && config.models.includes(modelId)) {\n      const result: KeySelectionResult = {\n        apiKey: config.key,\n        provider: config.provider,\n        keySource: 'specific',\n        confidence: 'high'\n      }\n      return result\n    }\n  }\n\n  // 2. 模糊匹配：根据模型名称推断供应商\n  const modelLower = modelId.toLowerCase()\n  for (const config of KEY_CONFIGS) {\n    if (!config.key) continue\n\n    const providerMatches = [\n      { provider: 'Claude', patterns: ['claude'] },\n      { provider: 'Google', patterns: ['gemini', 'palm', 'bard'] },\n      { provider: 'OpenAI', patterns: ['gpt', 'text-davinci', 'text-ada'] }\n    ]\n\n    const match = providerMatches.find(pm =>\n      pm.provider === config.provider &&\n      pm.patterns.some(pattern => modelLower.includes(pattern))\n    )\n\n    if (match) {\n      const result: KeySelectionResult = {\n        apiKey: config.key,\n        provider: config.provider,\n        keySource: 'specific',\n        confidence: 'medium'\n      }\n      return result\n    }\n  }\n\n  // 3. 回退到统一KEY（保持兼容性）\n  if (FALLBACK_KEY) {\n    const result: KeySelectionResult = {\n      apiKey: FALLBACK_KEY,\n      provider: 'Unknown',\n      keySource: 'fallback',\n      confidence: 'low'\n    }\n    return result\n  }\n\n  // 4. 无可用Key - 返回错误状态而不是抛出异常\n  const result: KeySelectionResult = {\n    apiKey: '',\n    provider: 'None',\n    keySource: 'none',\n    confidence: 'low'\n  }\n  return result\n}\n\n/**\n * 获取所有已配置的Key信息（用于健康检查）\n */\nexport function getKeyHealthStatus() {\n  const status = {\n    configuredKeys: 0,\n    availableProviders: [] as string[],\n    fallbackKey: !!FALLBACK_KEY,\n    keyStatus: {} as Record<string, boolean>\n  }\n\n  KEY_CONFIGS.forEach(config => {\n    if (config.key) {\n      status.configuredKeys++\n      status.availableProviders.push(config.provider)\n      status.keyStatus[config.provider] = true\n    } else {\n      status.keyStatus[config.provider] = false\n    }\n  })\n\n  return status\n}\n\n/**\n * 验证特定模型的Key配置\n */\nexport function validateModelKeyConfig(modelId: string): {\n  isValid: boolean\n  keyInfo: KeySelectionResult\n  recommendation?: string\n} {\n  const keyInfo = selectApiKey(modelId)\n  \n  const validation = {\n    isValid: !!keyInfo.apiKey,\n    keyInfo,\n    recommendation: undefined as string | undefined\n  }\n\n  if (!keyInfo.apiKey) {\n    validation.recommendation = `请配置 ${modelId} 对应供应商的API Key`\n  } else if (keyInfo.confidence === 'low') {\n    validation.recommendation = `建议为 ${modelId} 配置专属API Key以提高稳定性`\n  }\n\n  return validation\n}\n\n/**\n * 开发环境调试工具\n */\nexport const KeyDebugTools = {\n  showAllKeys: () => {\n    KEY_CONFIGS.forEach(config => {\n      })\n  },\n\n  testKeySelection: (modelId: string) => {\n    const result = selectApiKey(modelId)\n    return result\n  },\n\n  getAllSupportedModels: () => {\n    const allModels = KEY_CONFIGS.flatMap(config => config.models)\n    return allModels\n  }\n}\n\n// 开发环境暴露调试工具\nif (process.env.NODE_ENV === 'development' && typeof window !== 'undefined') {\n  (window as any).KeyDebugTools = KeyDebugTools\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\analytics.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":63,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":63,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":77,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":77,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport React from \"react\"\n\n// 数据分析和记录工具类\nexport interface UserEvent {\n  userId?: string\n  sessionId: string\n  eventType: \"page_view\" | \"chat_message\" | \"document_create\" | \"document_edit\" | \"feedback_submit\" | \"api_call\"\n  eventData: Record<string, any>\n  timestamp: Date\n  userAgent?: string\n  ip?: string\n}\n\nexport interface SystemMetric {\n  metricType: \"response_time\" | \"error_rate\" | \"throughput\" | \"memory_usage\" | \"cpu_usage\"\n  value: number\n  timestamp: Date\n  metadata?: Record<string, any>\n}\n\nclass Analytics {\n  private events: UserEvent[] = []\n  private metrics: SystemMetric[] = []\n\n  // 记录用户事件\n  trackEvent(event: Omit<UserEvent, \"timestamp\">) {\n    const fullEvent: UserEvent = {\n      ...event,\n      timestamp: new Date(),\n    }\n\n    this.events.push(fullEvent)\n\n    // 发送到服务器\n    this.sendEventToServer(fullEvent)\n  }\n\n  // 记录系统指标\n  recordMetric(metric: Omit<SystemMetric, \"timestamp\">) {\n    const fullMetric: SystemMetric = {\n      ...metric,\n      timestamp: new Date(),\n    }\n\n    this.metrics.push(fullMetric)\n\n    // 发送到服务器\n    this.sendMetricToServer(fullMetric)\n  }\n\n  // 发送事件到服务器\n  private async sendEventToServer(event: UserEvent) {\n    try {\n      await fetch(\"/api/analytics/events\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(event),\n      })\n    } catch (error) {\n      }\n  }\n\n  // 发送指标到服务器\n  private async sendMetricToServer(metric: SystemMetric) {\n    try {\n      await fetch(\"/api/analytics/metrics\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(metric),\n      })\n    } catch (error) {\n      }\n  }\n\n  // 生成会话ID\n  generateSessionId(): string {\n    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n  }\n\n  // 获取用户代理信息\n  getUserAgent(): string {\n    return typeof window !== \"undefined\" ? window.navigator.userAgent : \"\"\n  }\n}\n\nexport const analytics = new Analytics()\n\n// 页面访问追踪Hook\nexport function usePageTracking(pageName: string) {\n  const sessionId = analytics.generateSessionId()\n\n  React.useEffect(() => {\n    analytics.trackEvent({\n      sessionId,\n      eventType: \"page_view\",\n      eventData: {\n        page: pageName,\n        url: window.location.href,\n      },\n      userAgent: analytics.getUserAgent(),\n    })\n  }, [pageName, sessionId])\n\n  return sessionId\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\api\\error-handler.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'UNAUTHORIZED' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"UNAUTHORIZED"},"fix":{"range":[152,164],"text":""},"desc":"Remove unused variable 'UNAUTHORIZED'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'FORBIDDEN' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":12,"suggestions":[{"messageId":"removeVar","data":{"varName":"FORBIDDEN"},"fix":{"range":[181,195],"text":""},"desc":"Remove unused variable 'FORBIDDEN'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'TOKEN_EXPIRED' is defined but never used. Allowed unused vars must match /^_/u.","line":13,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"TOKEN_EXPIRED"},"fix":{"range":[209,227],"text":""},"desc":"Remove unused variable 'TOKEN_EXPIRED'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'BAD_REQUEST' is defined but never used. Allowed unused vars must match /^_/u.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"BAD_REQUEST"},"fix":{"range":[245,278],"text":""},"desc":"Remove unused variable 'BAD_REQUEST'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'NOT_FOUND' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":12,"suggestions":[{"messageId":"removeVar","data":{"varName":"NOT_FOUND"},"fix":{"range":[294,308],"text":""},"desc":"Remove unused variable 'NOT_FOUND'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'METHOD_NOT_ALLOWED' is defined but never used. Allowed unused vars must match /^_/u.","line":18,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"METHOD_NOT_ALLOWED"},"fix":{"range":[322,345],"text":""},"desc":"Remove unused variable 'METHOD_NOT_ALLOWED'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'VALIDATION_FAILED' is defined but never used. Allowed unused vars must match /^_/u.","line":21,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"VALIDATION_FAILED"},"fix":{"range":[368,405],"text":""},"desc":"Remove unused variable 'VALIDATION_FAILED'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'RESOURCE_CONFLICT' is defined but never used. Allowed unused vars must match /^_/u.","line":22,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"RESOURCE_CONFLICT"},"fix":{"range":[427,449],"text":""},"desc":"Remove unused variable 'RESOURCE_CONFLICT'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'RATE_LIMITED' is defined but never used. Allowed unused vars must match /^_/u.","line":23,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":15,"suggestions":[{"messageId":"removeVar","data":{"varName":"RATE_LIMITED"},"fix":{"range":[471,488],"text":""},"desc":"Remove unused variable 'RATE_LIMITED'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'QUOTA_EXCEEDED' is defined but never used. Allowed unused vars must match /^_/u.","line":24,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"QUOTA_EXCEEDED"},"fix":{"range":[505,524],"text":""},"desc":"Remove unused variable 'QUOTA_EXCEEDED'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'INTERNAL_ERROR' is defined but never used. Allowed unused vars must match /^_/u.","line":27,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"INTERNAL_ERROR"},"fix":{"range":[543,577],"text":""},"desc":"Remove unused variable 'INTERNAL_ERROR'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'DATABASE_ERROR' is defined but never used. Allowed unused vars must match /^_/u.","line":28,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"DATABASE_ERROR"},"fix":{"range":[596,615],"text":""},"desc":"Remove unused variable 'DATABASE_ERROR'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'EXTERNAL_SERVICE_ERROR' is defined but never used. Allowed unused vars must match /^_/u.","line":29,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"EXTERNAL_SERVICE_ERROR"},"fix":{"range":[634,661],"text":""},"desc":"Remove unused variable 'EXTERNAL_SERVICE_ERROR'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'code' is defined but never used. Allowed unused args must match /^_/u.","line":60,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":60,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"code"},"fix":{"range":[1191,1209],"text":""},"desc":"Remove unused variable 'code'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'statusCode' is assigned a value but never used. Allowed unused args must match /^_/u.","line":62,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":62,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"statusCode"},"fix":{"range":[1252,1270],"text":""},"desc":"Remove unused variable 'statusCode'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'details' is defined but never used. Allowed unused args must match /^_/u.","line":63,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":63,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"details"},"fix":{"range":[1290,1303],"text":""},"desc":"Remove unused variable 'details'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":213,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":213,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[5126,5130],"text":""},"desc":"Remove unused variable 'args'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 统一API错误处理工具\r\n * 提供一致的错误响应格式和安全的错误信息处理\r\n */\r\n\r\nimport { NextResponse } from 'next/server'\r\n\r\n// 错误类型定义\r\nexport enum ApiErrorCode {\r\n  // 认证相关\r\n  UNAUTHORIZED = 'UNAUTHORIZED',\r\n  FORBIDDEN = 'FORBIDDEN',\r\n  TOKEN_EXPIRED = 'TOKEN_EXPIRED',\r\n  \r\n  // 请求相关  \r\n  BAD_REQUEST = 'BAD_REQUEST',\r\n  NOT_FOUND = 'NOT_FOUND',\r\n  METHOD_NOT_ALLOWED = 'METHOD_NOT_ALLOWED',\r\n  \r\n  // 业务相关\r\n  VALIDATION_FAILED = 'VALIDATION_FAILED',\r\n  RESOURCE_CONFLICT = 'RESOURCE_CONFLICT',\r\n  RATE_LIMITED = 'RATE_LIMITED',\r\n  QUOTA_EXCEEDED = 'QUOTA_EXCEEDED',\r\n  \r\n  // 系统相关\r\n  INTERNAL_ERROR = 'INTERNAL_ERROR',\r\n  DATABASE_ERROR = 'DATABASE_ERROR',\r\n  EXTERNAL_SERVICE_ERROR = 'EXTERNAL_SERVICE_ERROR'\r\n}\r\n\r\n// 统一错误响应格式\r\nexport interface ApiErrorResponse {\r\n  success: false\r\n  error: {\r\n    code: ApiErrorCode\r\n    message: string\r\n    details?: any\r\n    timestamp: string\r\n    requestId?: string\r\n  }\r\n}\r\n\r\n// 统一成功响应格式\r\nexport interface ApiSuccessResponse<T = any> {\r\n  success: true\r\n  data: T\r\n  message?: string\r\n  metadata?: {\r\n    total?: number\r\n    page?: number\r\n    limit?: number\r\n    [key: string]: any\r\n  }\r\n}\r\n\r\n// API错误类\r\nexport class ApiError extends Error {\r\n  constructor(\r\n    public code: ApiErrorCode,\r\n    public message: string,\r\n    public statusCode: number = 500,\r\n    public details?: any\r\n  ) {\r\n    super(message)\r\n    this.name = 'ApiError'\r\n  }\r\n}\r\n\r\n// 预定义常用错误\r\nexport const CommonErrors = {\r\n  UNAUTHORIZED: new ApiError(ApiErrorCode.UNAUTHORIZED, '未认证，请先登录', 401),\r\n  FORBIDDEN: new ApiError(ApiErrorCode.FORBIDDEN, '权限不足，无法访问该资源', 403),\r\n  NOT_FOUND: new ApiError(ApiErrorCode.NOT_FOUND, '请求的资源不存在', 404),\r\n  VALIDATION_FAILED: new ApiError(ApiErrorCode.VALIDATION_FAILED, '输入数据验证失败', 400),\r\n  RATE_LIMITED: new ApiError(ApiErrorCode.RATE_LIMITED, '请求过于频繁，请稍后重试', 429),\r\n  INTERNAL_ERROR: new ApiError(ApiErrorCode.INTERNAL_ERROR, '服务器内部错误', 500)\r\n}\r\n\r\n/**\r\n * 统一错误响应生成器\r\n */\r\nexport function createErrorResponse(\r\n  error: ApiError | Error | string,\r\n  requestId?: string\r\n): NextResponse<ApiErrorResponse> {\r\n  let apiError: ApiError\r\n\r\n  if (error instanceof ApiError) {\r\n    apiError = error\r\n  } else if (error instanceof Error) {\r\n    // 根据错误类型智能分类\r\n    apiError = classifyError(error)\r\n  } else {\r\n    // 字符串错误\r\n    apiError = new ApiError(ApiErrorCode.INTERNAL_ERROR, error)\r\n  }\r\n\r\n  // 生产环境下隐藏敏感错误信息\r\n  const isProduction = process.env.NODE_ENV === 'production'\r\n  const shouldHideDetails = isProduction && apiError.statusCode >= 500\r\n\r\n  const response: ApiErrorResponse = {\r\n    success: false,\r\n    error: {\r\n      code: apiError.code,\r\n      message: shouldHideDetails ? '服务暂时不可用，请稍后重试' : apiError.message,\r\n      details: shouldHideDetails ? undefined : apiError.details,\r\n      timestamp: new Date().toISOString(),\r\n      requestId\r\n    }\r\n  }\r\n\r\n  // 记录错误日志（仅服务器错误）\r\n  if (apiError.statusCode >= 500) {\r\n    }\r\n\r\n  return NextResponse.json(response, { status: apiError.statusCode })\r\n}\r\n\r\n/**\r\n * 统一成功响应生成器\r\n */\r\nexport function createSuccessResponse<T>(\r\n  data: T,\r\n  message?: string,\r\n  metadata?: any\r\n): NextResponse<ApiSuccessResponse<T>> {\r\n  const response: ApiSuccessResponse<T> = {\r\n    success: true,\r\n    data,\r\n    message,\r\n    metadata\r\n  }\r\n\r\n  return NextResponse.json(response)\r\n}\r\n\r\n/**\r\n * 智能错误分类\r\n */\r\nfunction classifyError(error: Error): ApiError {\r\n  const message = error.message.toLowerCase()\r\n\r\n  // Prisma数据库错误\r\n  if (error.name === 'PrismaClientKnownRequestError') {\r\n    return new ApiError(ApiErrorCode.DATABASE_ERROR, '数据库操作失败', 500, { originalError: error.message })\r\n  }\r\n\r\n  // 验证错误\r\n  if (message.includes('validation') || message.includes('invalid')) {\r\n    return new ApiError(ApiErrorCode.VALIDATION_FAILED, error.message, 400)\r\n  }\r\n\r\n  // 权限错误\r\n  if (message.includes('unauthorized') || message.includes('permission')) {\r\n    return new ApiError(ApiErrorCode.FORBIDDEN, error.message, 403)\r\n  }\r\n\r\n  // 网络/外部服务错误\r\n  if (message.includes('fetch') || message.includes('network') || message.includes('timeout')) {\r\n    return new ApiError(ApiErrorCode.EXTERNAL_SERVICE_ERROR, '外部服务调用失败', 502, { originalError: error.message })\r\n  }\r\n\r\n  // 默认服务器错误\r\n  return new ApiError(ApiErrorCode.INTERNAL_ERROR, error.message, 500)\r\n}\r\n\r\n/**\r\n * 中间件工具：统一认证检查\r\n */\r\nexport function requireAuth(token: any, role?: string): ApiError | null {\r\n  if (!token?.sub) {\r\n    return CommonErrors.UNAUTHORIZED\r\n  }\r\n\r\n  if (role && (token as any).role !== role) {\r\n    return CommonErrors.FORBIDDEN\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * 中间件工具：输入验证\r\n */\r\nexport function validateInput(data: any, required: string[]): ApiError | null {\r\n  const missing = required.filter(field => !data[field])\r\n  \r\n  if (missing.length > 0) {\r\n    return new ApiError(\r\n      ApiErrorCode.VALIDATION_FAILED,\r\n      `缺少必填字段: ${missing.join(', ')}`,\r\n      400,\r\n      { missingFields: missing }\r\n    )\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * 请求ID生成器（用于追踪）\r\n */\r\nexport function generateRequestId(): string {\r\n  return `req_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`\r\n}\r\n\r\n/**\r\n * 错误处理装饰器（用于包装API处理函数）\r\n */\r\nexport function withErrorHandler<T extends any[], R>(\r\n  handler: (...args: T) => Promise<NextResponse<R | ApiErrorResponse>>\r\n) {\r\n  return async (...args: T): Promise<NextResponse<R | ApiErrorResponse>> => {\r\n    const requestId = generateRequestId()\r\n    \r\n    try {\r\n      return await handler(...args)\r\n    } catch (error) {\r\n      return createErrorResponse(error as Error, requestId)\r\n    }\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\error-handler.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'errorInfo' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":87,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"errorInfo"},"fix":{"range":[2032,2321],"text":""},"desc":"Remove unused variable 'errorInfo'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nexport class AppError extends Error {\n  public readonly code: string\n  public readonly statusCode: number\n  public readonly isOperational: boolean\n\n  constructor(message: string, code = \"UNKNOWN_ERROR\", statusCode = 500, isOperational = true) {\n    super(message)\n    this.name = \"AppError\"\n    this.code = code\n    this.statusCode = statusCode\n    this.isOperational = isOperational\n\n    Error.captureStackTrace(this, this.constructor)\n  }\n}\n\nexport class NetworkError extends AppError {\n  constructor(message = \"网络连接失败\") {\n    super(message, \"NETWORK_ERROR\", 0, true)\n    this.name = \"NetworkError\"\n  }\n}\n\nexport class APIError extends AppError {\n  constructor(message: string, statusCode = 500) {\n    super(message, \"API_ERROR\", statusCode, true)\n    this.name = \"APIError\"\n  }\n}\n\nexport class ValidationError extends AppError {\n  constructor(message: string) {\n    super(message, \"VALIDATION_ERROR\", 400, true)\n    this.name = \"ValidationError\"\n  }\n}\n\nexport function handleAPIError(error: any): AppError {\n  if (error instanceof AppError) {\n    return error\n  }\n\n  if (error.name === \"TypeError\" && error.message.includes(\"fetch\")) {\n    return new NetworkError(\"网络连接失败，请检查您的网络连接\")\n  }\n\n  if (error.status || error.statusCode) {\n    const statusCode = error.status || error.statusCode\n    let message = error.message || \"请求失败\"\n\n    switch (statusCode) {\n      case 400:\n        message = \"请求参数错误\"\n        break\n      case 401:\n        message = \"未授权访问\"\n        break\n      case 403:\n        message = \"访问被拒绝\"\n        break\n      case 404:\n        message = \"请求的资源不存在\"\n        break\n      case 429:\n        message = \"请求过于频繁，请稍后重试\"\n        break\n      case 500:\n        message = \"服务器内部错误\"\n        break\n      case 502:\n        message = \"网关错误\"\n        break\n      case 503:\n        message = \"服务暂时不可用\"\n        break\n    }\n\n    return new APIError(message, statusCode)\n  }\n\n  return new AppError(error.message || \"未知错误\", \"UNKNOWN_ERROR\", 500, false)\n}\n\nexport function logError(error: Error, context?: string) {\n  const errorInfo = {\n    message: error.message,\n    stack: error.stack,\n    context,\n    timestamp: new Date().toISOString(),\n    userAgent: typeof window !== \"undefined\" ? window.navigator.userAgent : \"server\",\n    url: typeof window !== \"undefined\" ? window.location.href : \"server\",\n  }\n\n  // 在生产环境中，这里可以发送错误到监控服务\n  if (process.env.NODE_ENV === \"production\") {\n    // 发送到错误监控服务\n    // sendToErrorService(errorInfo)\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\import\\local-folder-importer.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":156,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":156,"endColumn":23},{"ruleId":"no-unused-vars","severity":1,"message":"'tempConfig' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":175,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":175,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":382,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":382,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 本地文件夹数据导入工具\r\n * 专门用于扫描和导入本地文件夹中的数据\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client'\r\nimport fs from 'fs'\r\nimport path from 'path'\r\nimport { importExternalResources, ImportConfig, ImportResult } from './external-resource-importer'\r\n\r\nconst prisma = new PrismaClient()\r\n\r\n// 本地导入配置\r\nexport interface LocalImportConfig {\r\n  userId: string                    // 导入用户ID\r\n  sourceFolderPath: string         // 源文件夹路径\r\n  categoryId?: string              // 分类ID\r\n  importedFrom?: string            // 来源说明\r\n  filePattern?: RegExp             // 文件过滤正则\r\n  recursive?: boolean              // 是否递归扫描子文件夹\r\n  maxDepth?: number               // 最大递归深度\r\n  excludePatterns?: RegExp[]      // 排除的文件/文件夹模式\r\n  createFolderCategories?: boolean // 是否为每个子文件夹创建分类\r\n}\r\n\r\n// 扫描结果\r\nexport interface ScanResult {\r\n  totalFiles: number\r\n  supportedFiles: FileInfo[]\r\n  unsupportedFiles: string[]\r\n  folderStructure: FolderInfo[]\r\n}\r\n\r\nexport interface FileInfo {\r\n  filePath: string\r\n  fileName: string\r\n  fileType: string\r\n  fileSize: number\r\n  relativePath: string\r\n  folderName: string\r\n  lastModified: Date\r\n}\r\n\r\nexport interface FolderInfo {\r\n  folderPath: string\r\n  folderName: string\r\n  fileCount: number\r\n  hasSubfolders: boolean\r\n  files: FileInfo[]\r\n}\r\n\r\n// 批量导入结果\r\nexport interface BatchImportResult {\r\n  success: boolean\r\n  totalFiles: number\r\n  processedFiles: number\r\n  successCount: number\r\n  errorCount: number\r\n  results: ImportResult[]\r\n  categoryMapping: Map<string, string>\r\n}\r\n\r\n/**\r\n * 本地文件夹导入器\r\n */\r\nexport class LocalFolderImporter {\r\n  private config: LocalImportConfig\r\n  private supportedExtensions = ['.csv', '.json', '.xlsx', '.xls', '.txt', '.md', '.pdf', '.doc', '.docx']\r\n\r\n  constructor(config: LocalImportConfig) {\r\n    this.config = {\r\n      recursive: true,\r\n      maxDepth: 5,\r\n      excludePatterns: [/node_modules/, /\\.git/, /\\.svn/, /temp/, /tmp/],\r\n      createFolderCategories: true,\r\n      ...config\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 扫描文件夹\r\n   */\r\n  async scanFolder(): Promise<ScanResult> {\r\n    if (!fs.existsSync(this.config.sourceFolderPath)) {\r\n      throw new Error(`文件夹不存在: ${this.config.sourceFolderPath}`)\r\n    }\r\n\r\n    const result: ScanResult = {\r\n      totalFiles: 0,\r\n      supportedFiles: [],\r\n      unsupportedFiles: [],\r\n      folderStructure: []\r\n    }\r\n\r\n    await this.scanDirectory(this.config.sourceFolderPath, '', 0, result)\r\n\r\n    return result\r\n  }\r\n\r\n  /**\r\n   * 批量导入所有文件\r\n   */\r\n  async importAll(): Promise<BatchImportResult> {\r\n    const scanResult = await this.scanFolder()\r\n    \r\n    if (scanResult.supportedFiles.length === 0) {\r\n      return {\r\n        success: true,\r\n        totalFiles: scanResult.totalFiles,\r\n        processedFiles: 0,\r\n        successCount: 0,\r\n        errorCount: 0,\r\n        results: [],\r\n        categoryMapping: new Map()\r\n      }\r\n    }\r\n\r\n    const batchResult: BatchImportResult = {\r\n      success: true,\r\n      totalFiles: scanResult.totalFiles,\r\n      processedFiles: 0,\r\n      successCount: 0,\r\n      errorCount: 0,\r\n      results: [],\r\n      categoryMapping: new Map()\r\n    }\r\n\r\n    // 创建文件夹分类映射\r\n    if (this.config.createFolderCategories) {\r\n      await this.createFolderCategories(scanResult.folderStructure, batchResult.categoryMapping)\r\n    }\r\n\r\n    // 按文件夹分组导入\r\n    const filesByFolder = this.groupFilesByFolder(scanResult.supportedFiles)\r\n    \r\n    for (const [folderPath, files] of filesByFolder) {\r\n      const categoryId = batchResult.categoryMapping.get(folderPath) || this.config.categoryId\r\n\r\n      for (const file of files) {\r\n        try {\r\n          const importConfig = this.createImportConfig(file, categoryId)\r\n          const result = await importExternalResources(importConfig)\r\n          \r\n          batchResult.results.push(result)\r\n          batchResult.processedFiles++\r\n          \r\n          if (result.success) {\r\n            batchResult.successCount += result.successCount\r\n            } else {\r\n            batchResult.errorCount += result.errorCount\r\n            }\r\n          \r\n          // 避免过快处理\r\n          await this.delay(100)\r\n          \r\n        } catch (error) {\r\n          batchResult.errorCount++\r\n          }\r\n      }\r\n    }\r\n\r\n    batchResult.success = batchResult.errorCount === 0\r\n    \r\n    return batchResult\r\n  }\r\n\r\n  /**\r\n   * 按文件类型分别导入\r\n   */\r\n  async importByFileType(fileType: string): Promise<BatchImportResult> {\r\n    const scanResult = await this.scanFolder()\r\n    const filteredFiles = scanResult.supportedFiles.filter(f => f.fileType === fileType)\r\n    \r\n    // 使用过滤后的文件创建临时配置\r\n    const tempConfig = { ...this.config }\r\n    const originalScan = this.scanFolder\r\n    this.scanFolder = async () => ({\r\n      ...scanResult,\r\n      supportedFiles: filteredFiles\r\n    })\r\n    \r\n    const result = await this.importAll()\r\n    this.scanFolder = originalScan\r\n    \r\n    return result\r\n  }\r\n\r\n  /**\r\n   * 预览导入（不实际导入，只显示会导入什么）\r\n   */\r\n  async preview(): Promise<{\r\n    scanResult: ScanResult\r\n    importPlan: Array<{\r\n      file: FileInfo\r\n      categoryName?: string\r\n      estimatedRecords: number\r\n    }>\r\n  }> {\r\n    const scanResult = await this.scanFolder()\r\n    const importPlan = []\r\n\r\n    for (const file of scanResult.supportedFiles) {\r\n      const estimatedRecords = await this.estimateRecords(file)\r\n      const categoryName = this.config.createFolderCategories \r\n        ? this.getFolderName(file.relativePath)\r\n        : undefined\r\n\r\n      importPlan.push({\r\n        file,\r\n        categoryName,\r\n        estimatedRecords\r\n      })\r\n    }\r\n\r\n    return { scanResult, importPlan }\r\n  }\r\n\r\n  /**\r\n   * 递归扫描目录\r\n   */\r\n  private async scanDirectory(\r\n    dirPath: string,\r\n    relativePath: string,\r\n    depth: number,\r\n    result: ScanResult\r\n  ): Promise<void> {\r\n    if (depth > (this.config.maxDepth || 5)) {\r\n      return\r\n    }\r\n\r\n    // 检查是否应该排除这个目录\r\n    if (this.shouldExclude(dirPath)) {\r\n      return\r\n    }\r\n\r\n    const items = fs.readdirSync(dirPath)\r\n    const folderInfo: FolderInfo = {\r\n      folderPath: dirPath,\r\n      folderName: path.basename(dirPath),\r\n      fileCount: 0,\r\n      hasSubfolders: false,\r\n      files: []\r\n    }\r\n\r\n    for (const item of items) {\r\n      const itemPath = path.join(dirPath, item)\r\n      const itemRelativePath = path.join(relativePath, item)\r\n      const stat = fs.statSync(itemPath)\r\n\r\n      if (stat.isDirectory()) {\r\n        folderInfo.hasSubfolders = true\r\n        if (this.config.recursive) {\r\n          await this.scanDirectory(itemPath, itemRelativePath, depth + 1, result)\r\n        }\r\n      } else if (stat.isFile()) {\r\n        result.totalFiles++\r\n        \r\n        const fileInfo = this.createFileInfo(itemPath, itemRelativePath, stat)\r\n        \r\n        if (this.isSupportedFile(fileInfo)) {\r\n          result.supportedFiles.push(fileInfo)\r\n          folderInfo.files.push(fileInfo)\r\n          folderInfo.fileCount++\r\n        } else {\r\n          result.unsupportedFiles.push(itemPath)\r\n        }\r\n      }\r\n    }\r\n\r\n    if (folderInfo.fileCount > 0 || folderInfo.hasSubfolders) {\r\n      result.folderStructure.push(folderInfo)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 创建文件信息对象\r\n   */\r\n  private createFileInfo(filePath: string, relativePath: string, stat: fs.Stats): FileInfo {\r\n    const ext = path.extname(filePath).toLowerCase()\r\n    \r\n    return {\r\n      filePath,\r\n      fileName: path.basename(filePath),\r\n      fileType: this.getFileType(ext),\r\n      fileSize: stat.size,\r\n      relativePath,\r\n      folderName: path.dirname(relativePath) || '根目录',\r\n      lastModified: stat.mtime\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 判断文件类型\r\n   */\r\n  private getFileType(extension: string): string {\r\n    const typeMap: Record<string, string> = {\r\n      '.csv': 'csv',\r\n      '.json': 'json',\r\n      '.xlsx': 'excel',\r\n      '.xls': 'excel',\r\n      '.txt': 'txt',\r\n      '.md': 'md',\r\n      '.pdf': 'pdf',\r\n      '.doc': 'doc',\r\n      '.docx': 'docx'\r\n    }\r\n    return typeMap[extension] || 'unknown'\r\n  }\r\n\r\n  /**\r\n   * 检查是否为支持的文件\r\n   */\r\n  private isSupportedFile(file: FileInfo): boolean {\r\n    const ext = path.extname(file.filePath).toLowerCase()\r\n    const isSupported = this.supportedExtensions.includes(ext)\r\n    \r\n    if (this.config.filePattern) {\r\n      return isSupported && this.config.filePattern.test(file.fileName)\r\n    }\r\n    \r\n    return isSupported\r\n  }\r\n\r\n  /**\r\n   * 检查是否应该排除\r\n   */\r\n  private shouldExclude(itemPath: string): boolean {\r\n    if (!this.config.excludePatterns) return false\r\n    \r\n    return this.config.excludePatterns.some(pattern => \r\n      pattern.test(itemPath) || pattern.test(path.basename(itemPath))\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 按文件夹分组文件\r\n   */\r\n  private groupFilesByFolder(files: FileInfo[]): Map<string, FileInfo[]> {\r\n    const groups = new Map<string, FileInfo[]>()\r\n    \r\n    for (const file of files) {\r\n      const folderPath = path.dirname(file.filePath)\r\n      if (!groups.has(folderPath)) {\r\n        groups.set(folderPath, [])\r\n      }\r\n      groups.get(folderPath)!.push(file)\r\n    }\r\n    \r\n    return groups\r\n  }\r\n\r\n  /**\r\n   * 创建文件夹分类\r\n   */\r\n  private async createFolderCategories(\r\n    folders: FolderInfo[],\r\n    categoryMapping: Map<string, string>\r\n  ): Promise<void> {\r\n    for (const folder of folders) {\r\n      if (folder.fileCount === 0) continue\r\n\r\n      const categoryName = this.getFolderName(folder.folderPath)\r\n      \r\n      try {\r\n        // 检查分类是否已存在\r\n        let category = await prisma.documentCategory.findUnique({\r\n          where: { name: categoryName }\r\n        })\r\n\r\n        // 如果不存在则创建\r\n        if (!category) {\r\n          category = await prisma.documentCategory.create({\r\n            data: {\r\n              name: categoryName,\r\n              description: `从 ${folder.folderPath} 导入`,\r\n              color: this.generateFolderColor(categoryName)\r\n            }\r\n          })\r\n        }\r\n\r\n        categoryMapping.set(folder.folderPath, category.id)\r\n      } catch (error) {\r\n        }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取文件夹名称\r\n   */\r\n  private getFolderName(folderPath: string): string {\r\n    const baseName = path.basename(folderPath)\r\n    const relativePath = path.relative(this.config.sourceFolderPath, folderPath)\r\n    \r\n    return relativePath || baseName || '根目录'\r\n  }\r\n\r\n  /**\r\n   * 生成文件夹颜色\r\n   */\r\n  private generateFolderColor(folderName: string): string {\r\n    const colors = [\r\n      '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899',\r\n      '#f43f5e', '#ef4444', '#f97316', '#f59e0b', '#eab308',\r\n      '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4'\r\n    ]\r\n    \r\n    const hash = folderName.split('').reduce((a, b) => {\r\n      a = ((a << 5) - a) + b.charCodeAt(0)\r\n      return a & a\r\n    }, 0)\r\n    \r\n    return colors[Math.abs(hash) % colors.length]\r\n  }\r\n\r\n  /**\r\n   * 创建导入配置\r\n   */\r\n  private createImportConfig(file: FileInfo, categoryId?: string): ImportConfig {\r\n    return {\r\n      userId: this.config.userId,\r\n      filePath: file.filePath,\r\n      fileType: file.fileType as any,\r\n      categoryId,\r\n      source: 'IMPORTED',\r\n      importedFrom: this.config.importedFrom || `本地文件夹: ${this.config.sourceFolderPath}`,\r\n      mapping: this.getDefaultMapping(file.fileType),\r\n      options: {\r\n        skipFirstRow: ['csv', 'excel'].includes(file.fileType),\r\n        updateExisting: true,\r\n        chunkSize: 50\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取默认字段映射\r\n   */\r\n  private getDefaultMapping(fileType: string) {\r\n    switch (fileType) {\r\n      case 'csv':\r\n      case 'excel':\r\n        return {\r\n          title: '标题',\r\n          content: '内容',\r\n          excerpt: '摘要',\r\n          tags: '标签'\r\n        }\r\n      case 'json':\r\n        return {\r\n          title: 'title',\r\n          content: 'content',\r\n          excerpt: 'excerpt',\r\n          tags: 'tags'\r\n        }\r\n      default:\r\n        return {\r\n          title: 'title',\r\n          content: 'content'\r\n        }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 估算记录数量\r\n   */\r\n  private async estimateRecords(file: FileInfo): Promise<number> {\r\n    try {\r\n      switch (file.fileType) {\r\n        case 'csv':\r\n          const csvContent = fs.readFileSync(file.filePath, 'utf8')\r\n          return Math.max(0, csvContent.split('\\n').length - 1)\r\n        \r\n        case 'json':\r\n          const jsonContent = fs.readFileSync(file.filePath, 'utf8')\r\n          const data = JSON.parse(jsonContent)\r\n          return Array.isArray(data) ? data.length : 1\r\n        \r\n        case 'txt':\r\n        case 'md':\r\n          const textContent = fs.readFileSync(file.filePath, 'utf8')\r\n          return Math.max(1, textContent.split('\\n\\n').length)\r\n        \r\n        default:\r\n          return 1\r\n      }\r\n    } catch {\r\n      return 1\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 延时函数\r\n   */\r\n  private delay(ms: number): Promise<void> {\r\n    return new Promise(resolve => setTimeout(resolve, ms))\r\n  }\r\n}\r\n\r\n/**\r\n * 便捷函数：快速导入本地文件夹\r\n */\r\nexport async function importLocalFolder(\r\n  userId: string,\r\n  sourceFolderPath: string,\r\n  options?: Partial<LocalImportConfig>\r\n): Promise<BatchImportResult> {\r\n  const importer = new LocalFolderImporter({\r\n    userId,\r\n    sourceFolderPath,\r\n    ...options\r\n  })\r\n  \r\n  return await importer.importAll()\r\n}\r\n\r\n/**\r\n * 便捷函数：预览本地文件夹\r\n */\r\nexport async function previewLocalFolder(\r\n  userId: string,\r\n  sourceFolderPath: string,\r\n  options?: Partial<LocalImportConfig>\r\n) {\r\n  const importer = new LocalFolderImporter({\r\n    userId,\r\n    sourceFolderPath,\r\n    ...options\r\n  })\r\n  \r\n  return await importer.preview()\r\n}\r\n\r\nexport default LocalFolderImporter","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\mcp\\client-manager.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'MCPServerConfig' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"MCPServerConfig"},"fix":{"range":[298,314],"text":""},"desc":"Remove unused variable 'MCPServerConfig'."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":118,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":118,"endColumn":20,"suggestions":[{"fix":{"range":[3308,3370],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":156,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":156,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'serverId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":189,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":189,"endColumn":25,"suggestions":[{"messageId":"removeVar","data":{"varName":"serverId"},"fix":{"range":[5078,5086],"text":""},"desc":"Remove unused variable 'serverId'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":229,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":229,"endColumn":24},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":320,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":320,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * MCP客户端管理器\r\n * 负责管理MCP服务器连接、工具获取和健康检查\r\n */\r\n\r\nimport { Client } from '@modelcontextprotocol/sdk/client/index.js'\r\nimport { StdioClientTransport } from '@modelcontextprotocol/sdk/client/stdio.js'\r\nimport { SSEClientTransport } from '@modelcontextprotocol/sdk/client/sse.js'\r\nimport type {\r\n  MCPServerConfig,\r\n  MCPClientWrapper,\r\n  MCPTool,\r\n  MCPHealthStatus,\r\n  MCPManagerConfig,\r\n  MCPServerStatus\r\n} from './types'\r\nimport { getServerConfig, validateServerConfig } from './servers'\r\n\r\nexport class MCPClientManager {\r\n  private clients: Map<string, MCPClientWrapper> = new Map()\r\n  private config: MCPManagerConfig\r\n  private healthCheckTimer?: NodeJS.Timeout\r\n\r\n  constructor(config: Partial<MCPManagerConfig> = {}) {\r\n    this.config = {\r\n      maxConnections: config.maxConnections || 10,\r\n      connectionTimeout: config.connectionTimeout || 30000,\r\n      healthCheckInterval: config.healthCheckInterval || 60000,\r\n      enableLogging: config.enableLogging ?? true,\r\n      ...config\r\n    }\r\n\r\n    // 启动健康检查定时器\r\n    if (this.config.healthCheckInterval > 0) {\r\n      this.startHealthCheck()\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 创建MCP客户端连接\r\n   */\r\n  async createClient(serverId: string): Promise<MCPClientWrapper> {\r\n    const serverConfig = getServerConfig(serverId)\r\n    if (!serverConfig) {\r\n      throw new Error(`未找到服务器配置: ${serverId}`)\r\n    }\r\n\r\n    if (!validateServerConfig(serverConfig)) {\r\n      throw new Error(`无效的服务器配置: ${serverId}`)\r\n    }\r\n\r\n    // 检查是否已存在连接\r\n    if (this.clients.has(serverId)) {\r\n      const existing = this.clients.get(serverId)!\r\n      if (existing.status === 'connected') {\r\n        return existing\r\n      }\r\n      // 清理旧连接\r\n      await this.closeClient(serverId)\r\n    }\r\n\r\n    // 检查连接数限制\r\n    if (this.clients.size >= this.config.maxConnections) {\r\n      throw new Error(`已达到最大连接数限制: ${this.config.maxConnections}`)\r\n    }\r\n\r\n    const clientWrapper: MCPClientWrapper = {\r\n      id: serverId,\r\n      name: serverConfig.name,\r\n      client: new Client(\r\n        {\r\n          name: `zhidian-ai-${serverId}`,\r\n          version: \"1.0.0\"\r\n        },\r\n        {\r\n          capabilities: {}\r\n        }\r\n      ),\r\n      status: 'connecting'\r\n    }\r\n\r\n    this.clients.set(serverId, clientWrapper)\r\n\r\n    try {\r\n      // 创建传输层\r\n      let transport\r\n      if (serverConfig.type === 'stdio') {\r\n        transport = new StdioClientTransport({\r\n          command: serverConfig.config.command!,\r\n          args: serverConfig.config.args || [],\r\n          env: serverConfig.config.env\r\n        })\r\n      } else if (serverConfig.type === 'sse') {\r\n        transport = new SSEClientTransport(new URL(serverConfig.config.url!))\r\n      } else {\r\n        throw new Error(`不支持的传输类型: ${serverConfig.type}`)\r\n      }\r\n\r\n      // 设置连接超时\r\n      const timeoutPromise = new Promise((_, reject) => {\r\n        setTimeout(() => reject(new Error('连接超时')), this.config.connectionTimeout)\r\n      })\r\n\r\n      // 连接到服务器\r\n      await Promise.race([\r\n        clientWrapper.client.connect(transport),\r\n        timeoutPromise\r\n      ])\r\n\r\n      // 获取工具列表\r\n      const tools = await this.getClientTools(clientWrapper.client)\r\n      \r\n      clientWrapper.status = 'connected'\r\n      clientWrapper.tools = tools\r\n      clientWrapper.connectedAt = new Date()\r\n\r\n      if (this.config.enableLogging) {\r\n        console.log(`MCP client connected with ${tools.length} tools`)\r\n      }\r\n\r\n      return clientWrapper\r\n\r\n    } catch (error: any) {\r\n      clientWrapper.status = 'error'\r\n      clientWrapper.lastError = error.message\r\n\r\n      if (this.config.enableLogging) {\r\n        }\r\n\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取客户端工具\r\n   */\r\n  private async getClientTools(client: Client): Promise<Record<string, any>> {\r\n    try {\r\n      const response = await client.request(\r\n        { method: \"tools/list\" },\r\n        {} as any\r\n      )\r\n      \r\n      const tools: Record<string, any> = {}\r\n      if (response && typeof response === 'object' && 'tools' in response && Array.isArray(response.tools)) {\r\n        for (const tool of response.tools) {\r\n          tools[tool.name] = {\r\n            name: tool.name,\r\n            description: tool.description,\r\n            inputSchema: tool.inputSchema\r\n          }\r\n        }\r\n      }\r\n      \r\n      return tools\r\n    } catch (error) {\r\n      return {}\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取所有可用工具\r\n   */\r\n  async getAllTools(): Promise<MCPTool[]> {\r\n    const allTools: MCPTool[] = []\r\n    \r\n    for (const [serverId, clientWrapper] of this.clients) {\r\n      if (clientWrapper.status === 'connected' && clientWrapper.tools) {\r\n        for (const [toolName, toolInfo] of Object.entries(clientWrapper.tools)) {\r\n          allTools.push({\r\n            name: toolName,\r\n            description: toolInfo.description,\r\n            inputSchema: toolInfo.inputSchema,\r\n            serverId: serverId,\r\n            serverName: clientWrapper.name\r\n          })\r\n        }\r\n      }\r\n    }\r\n    \r\n    return allTools\r\n  }\r\n\r\n  /**\r\n   * 调用工具\r\n   */\r\n  async callTool(toolName: string, args: any): Promise<any> {\r\n    // 找到包含该工具的客户端\r\n    for (const [serverId, clientWrapper] of this.clients) {\r\n      if (clientWrapper.status === 'connected' && \r\n          clientWrapper.tools && \r\n          clientWrapper.tools[toolName]) {\r\n        \r\n        try {\r\n          const result = await clientWrapper.client.request({\r\n            method: \"tools/call\",\r\n            params: {\r\n              name: toolName,\r\n              arguments: args\r\n            }\r\n          },\r\n          {} as any)\r\n          \r\n          return result\r\n        } catch (error: any) {\r\n          if (this.config.enableLogging) {\r\n            }\r\n          throw error\r\n        }\r\n      }\r\n    }\r\n    \r\n    throw new Error(`未找到工具: ${toolName}`)\r\n  }\r\n\r\n  /**\r\n   * 关闭客户端连接\r\n   */\r\n  async closeClient(serverId: string): Promise<void> {\r\n    const clientWrapper = this.clients.get(serverId)\r\n    if (!clientWrapper) {\r\n      return\r\n    }\r\n\r\n    try {\r\n      await clientWrapper.client.close()\r\n      if (this.config.enableLogging) {\r\n        }\r\n    } catch (error: any) {\r\n      } finally {\r\n      this.clients.delete(serverId)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 关闭所有客户端连接\r\n   */\r\n  async closeAllClients(): Promise<void> {\r\n    const closePromises = Array.from(this.clients.keys()).map(serverId => \r\n      this.closeClient(serverId)\r\n    )\r\n    await Promise.all(closePromises)\r\n  }\r\n\r\n  /**\r\n   * 获取客户端状态\r\n   */\r\n  getClientStatus(serverId: string): MCPClientWrapper | undefined {\r\n    return this.clients.get(serverId)\r\n  }\r\n\r\n  /**\r\n   * 获取所有客户端状态\r\n   */\r\n  getAllClientStatus(): MCPServerStatus[] {\r\n    return Array.from(this.clients.values()).map(client => ({\r\n      id: client.id,\r\n      name: client.name,\r\n      status: client.status,\r\n      toolsCount: Object.keys(client.tools || {}).length,\r\n      lastCheck: client.connectedAt || new Date(),\r\n      error: client.lastError\r\n    }))\r\n  }\r\n\r\n  /**\r\n   * 健康检查\r\n   */\r\n  async healthCheck(): Promise<MCPHealthStatus[]> {\r\n    const results: MCPHealthStatus[] = []\r\n    \r\n    for (const [serverId, clientWrapper] of this.clients) {\r\n      const startTime = Date.now()\r\n      \r\n      try {\r\n        if (clientWrapper.status === 'connected') {\r\n          // 简单的ping测试\r\n          await clientWrapper.client.request(\r\n            { method: \"ping\" },\r\n            {} as any\r\n          )\r\n          \r\n          results.push({\r\n            serverId,\r\n            serverName: clientWrapper.name,\r\n            status: 'healthy',\r\n            responseTime: Date.now() - startTime,\r\n            lastCheck: new Date()\r\n          })\r\n        } else {\r\n          results.push({\r\n            serverId,\r\n            serverName: clientWrapper.name,\r\n            status: 'unhealthy',\r\n            lastCheck: new Date(),\r\n            error: clientWrapper.lastError || '未连接'\r\n          })\r\n        }\r\n      } catch (error: any) {\r\n        results.push({\r\n          serverId,\r\n          serverName: clientWrapper.name,\r\n          status: 'unhealthy',\r\n          lastCheck: new Date(),\r\n          error: error.message\r\n        })\r\n      }\r\n    }\r\n    \r\n    return results\r\n  }\r\n\r\n  /**\r\n   * 启动健康检查定时器\r\n   */\r\n  private startHealthCheck(): void {\r\n    this.healthCheckTimer = setInterval(async () => {\r\n      try {\r\n        await this.healthCheck()\r\n      } catch (error) {\r\n        }\r\n    }, this.config.healthCheckInterval)\r\n  }\r\n\r\n  /**\r\n   * 停止健康检查定时器\r\n   */\r\n  private stopHealthCheck(): void {\r\n    if (this.healthCheckTimer) {\r\n      clearInterval(this.healthCheckTimer)\r\n      this.healthCheckTimer = undefined\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 销毁管理器\r\n   */\r\n  async destroy(): Promise<void> {\r\n    this.stopHealthCheck()\r\n    await this.closeAllClients()\r\n  }\r\n}\r\n\r\n// 全局MCP管理器实例\r\nlet globalMCPManager: MCPClientManager | null = null\r\n\r\n/**\r\n * 获取全局MCP管理器实例\r\n */\r\nexport function getMCPManager(): MCPClientManager {\r\n  if (!globalMCPManager) {\r\n    globalMCPManager = new MCPClientManager()\r\n  }\r\n  return globalMCPManager\r\n}\r\n\r\n/**\r\n * 销毁全局MCP管理器实例\r\n */\r\nexport async function destroyMCPManager(): Promise<void> {\r\n  if (globalMCPManager) {\r\n    await globalMCPManager.destroy()\r\n    globalMCPManager = null\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\metrics.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'now' is defined but never used. Allowed unused vars must match /^_/u.","line":38,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":38,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"now"},"fix":{"range":[756,872],"text":""},"desc":"Remove unused variable 'now'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\n// Lightweight Metrics SDK for Web Vitals + custom marks/measures\n// - Sends via sendBeacon when available, otherwise fetch(keepalive)\n// - Safely no-op on SSR\n\nimport type { Metric } from 'web-vitals'\nimport { onLCP, onCLS, onINP, onTTFB, onFCP } from 'web-vitals'\n\nexport type MetricPayload = {\n  name: string\n  value?: number\n  ts?: number\n  tags?: Record<string, string>\n  detail?: any\n}\n\nexport type MetricsInitOptions = {\n  endpoint?: string\n  sampleRate?: number // 0..1\n  app?: string\n  version?: string\n  tags?: Record<string, string>\n}\n\nconst STATE: {\n  inited: boolean\n  endpoint: string\n  sampleRate: number\n  baseTags: Record<string, string>\n} = {\n  inited: false,\n  endpoint: '/api/metrics',\n  sampleRate: 1,\n  baseTags: {},\n}\n\nfunction now() {\n  return (typeof performance !== 'undefined' && performance.now) ? performance.now() : Date.now()\n}\n\nfunction shouldSample() {\n  return Math.random() < STATE.sampleRate\n}\n\nexport function initMetrics(opts: MetricsInitOptions = {}) {\n  if (STATE.inited) return\n  STATE.endpoint = opts.endpoint || STATE.endpoint\n  STATE.sampleRate = typeof opts.sampleRate === 'number' ? Math.max(0, Math.min(1, opts.sampleRate)) : STATE.sampleRate\n  STATE.baseTags = {\n    app: opts.app || 'zhidian-ai-platform',\n    version: opts.version || (process.env.NEXT_PUBLIC_APP_VERSION || 'dev'),\n    ...opts.tags,\n  }\n  STATE.inited = true\n}\n\nexport function setUser(userId?: string) {\n  if (!userId) return\n  STATE.baseTags.userId = userId\n}\n\nexport function send(payload: MetricPayload) {\n  if (typeof window === 'undefined') return\n  if (!STATE.inited) initMetrics()\n  if (!shouldSample()) return\n  const body = JSON.stringify({ ...payload, ts: payload.ts || Date.now(), tags: { ...STATE.baseTags, ...payload.tags } })\n  try {\n    if (navigator?.sendBeacon) {\n      const blob = new Blob([body], { type: 'application/json' })\n      navigator.sendBeacon(STATE.endpoint, blob)\n      return\n    }\n  } catch {}\n  try {\n    fetch(STATE.endpoint, { method: 'POST', body, headers: { 'Content-Type': 'application/json' }, keepalive: true })\n  } catch {}\n}\n\nexport function mark(name: string, tags?: Record<string, string>) {\n  if (typeof performance !== 'undefined' && performance.mark) {\n    try { performance.mark(name) } catch {}\n  }\n  send({ name: 'mark', value: 0, detail: { mark: name }, tags })\n}\n\nexport function measure(name: string, startMark: string, endMark: string, extra?: { tags?: Record<string,string>, detail?: any }) {\n  let duration: number | undefined\n  try {\n    if (performance.getEntriesByName && performance.measure) {\n      // Clear existing measure if any\n      try { performance.clearMeasures(name) } catch {}\n      performance.measure(name, startMark, endMark)\n      const entries = performance.getEntriesByName(name)\n      duration = entries?.[entries.length - 1]?.duration\n    }\n  } catch {}\n  send({ name, value: duration, detail: { startMark, endMark, ...(extra?.detail || {}) }, tags: extra?.tags })\n}\n\nexport function setupWebVitals() {\n  // Safety: only attach once per page\n  if ((window as any).__webVitalsSetup) return\n  ;(window as any).__webVitalsSetup = true\n  const sendMetric = (metric: Metric) => {\n    send({ name: metric.name, value: metric.value, detail: { id: metric.id, rating: (metric as any).rating } })\n  }\n  onLCP(sendMetric)\n  onCLS(sendMetric)\n  onINP(sendMetric)\n  onTTFB(sendMetric)\n  onFCP(sendMetric)\n}\n\n// Helpers for common flows\nexport function startEndTracker(baseName: string, tags?: Record<string,string>) {\n  const start = () => mark(`${baseName}_shown`, tags)\n  const end = (extra?: { tags?: Record<string,string> }) => {\n    mark(`${baseName}_hidden`, { ...tags, ...extra?.tags })\n    measure(`${baseName}_visible_dur`, `${baseName}_shown`, `${baseName}_hidden`, { tags: { ...tags, ...extra?.tags } })\n  }\n  return { start, end }\n}\n\nexport const Metrics = {\n  init: initMetrics,\n  setUser,\n  send,\n  mark,\n  measure,\n  setupWebVitals,\n  startEndTracker,\n}\n\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\model-validator.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":110,"column":3,"nodeType":"MemberExpression","messageId":"unexpected","endLine":110,"endColumn":20,"suggestions":[{"fix":{"range":[2432,2649],"text":""},"messageId":"removeMethodCall","desc":"Remove the console method call."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'endpoint' is defined but never used. Allowed unused args must match /^_/u.","line":128,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":128,"endColumn":54,"suggestions":[{"messageId":"removeVar","data":{"varName":"endpoint"},"fix":{"range":[2806,2824],"text":""},"desc":"Remove unused variable 'endpoint'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'intervalMs' is assigned a value but never used. Allowed unused args must match /^_/u.","line":154,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":41,"suggestions":[{"messageId":"removeVar","data":{"varName":"intervalMs"},"fix":{"range":[3363,3381],"text":""},"desc":"Remove unused variable 'intervalMs'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":177,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":177,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":224,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":224,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":234,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":234,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":248,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":248,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 模型一致性验证工具\n * 用于在开发和生产环境中验证模型选择的一致性\n */\n\nimport { ALLOWED_MODELS } from '@/lib/ai/models'\n\ninterface ModelValidationResult {\n  isValid: boolean\n  errors: string[]\n  warnings: string[]\n  modelInfo?: {\n    id: string\n    name: string\n    provider: string\n  }\n}\n\ninterface ValidationContext {\n  component: string\n  timestamp: string\n  environment: string\n}\n\n/**\n * 验证模型ID是否有效\n */\nexport function validateModelId(modelId: string): ModelValidationResult {\n  const result: ModelValidationResult = {\n    isValid: true,\n    errors: [],\n    warnings: []\n  }\n\n  // 检查模型ID是否为空\n  if (!modelId || modelId.trim() === '') {\n    result.isValid = false\n    result.errors.push('模型ID不能为空')\n    return result\n  }\n\n  // 检查模型是否在白名单中\n  const allowedModel = ALLOWED_MODELS.find(m => m.id === modelId)\n  if (!allowedModel) {\n    result.isValid = false\n    result.errors.push(`模型 \"${modelId}\" 不在白名单中`)\n    \n    // 提供建议的模型\n    const similarModels = ALLOWED_MODELS.filter(m => \n      m.id.toLowerCase().includes(modelId.toLowerCase()) ||\n      modelId.toLowerCase().includes(m.id.toLowerCase())\n    )\n\n    if (similarModels.length > 0) {\n      result.warnings.push(`您可能想使用: ${similarModels.map(m => m.id).join(', ')}`)\n    }\n    \n    return result\n  }\n\n  // 添加模型信息\n  result.modelInfo = {\n    id: allowedModel.id,\n    name: allowedModel.name,\n    provider: allowedModel.id.includes('claude') ? 'Claude' : \n              allowedModel.id.includes('gemini') ? 'Google' : 'Unknown'\n  }\n\n  return result\n}\n\n/**\n * 验证多个环节的模型一致性\n */\nexport function validateModelConsistency(\n  uiModel: string,\n  stateModel: string,\n  requestModel: string,\n  context: ValidationContext\n): ModelValidationResult {\n  const result: ModelValidationResult = {\n    isValid: true,\n    errors: [],\n    warnings: []\n  }\n\n  const models = { UI: uiModel, 状态: stateModel, 请求: requestModel }\n  \n  // 检查是否所有模型都相同\n  const allModels = [uiModel, stateModel, requestModel]\n  const uniqueModels = [...new Set(allModels)]\n  \n  if (uniqueModels.length > 1) {\n    result.isValid = false\n    result.errors.push(\n      `${context.component} 中模型不一致: ${JSON.stringify(models, null, 2)}`\n    )\n  }\n\n  // 验证每个模型的有效性\n  for (const [source, modelId] of Object.entries(models)) {\n    const validation = validateModelId(modelId)\n    if (!validation.isValid) {\n      result.errors.push(`${source}模型无效: ${validation.errors.join(', ')}`)\n    }\n  }\n\n  // 记录验证日志\n  const logLevel = result.isValid ? 'log' : 'error'\n  console[logLevel](`[模型一致性验证] ${context.component}:`, {\n    结果: result.isValid ? '一致' : '不一致',\n    模型: models,\n    时间: context.timestamp,\n    环境: context.environment,\n    错误: result.errors,\n    警告: result.warnings\n  })\n\n  return result\n}\n\n/**\n * 创建模型验证中间件\n * 用于在API请求前进行验证\n */\nexport function createModelValidationMiddleware() {\n  return {\n    beforeRequest: (modelId: string, endpoint: string) => {\n      const validation = validateModelId(modelId)\n      \n      if (!validation.isValid) {\n        const error = new Error(`API请求前验证失败: ${validation.errors.join(', ')}`)\n        throw error\n      }\n\n      return validation\n    },\n    \n    afterRequest: (modelId: string, response: any) => {\n      // 可以在这里验证响应中的模型信息\n      return response\n    }\n  }\n}\n\n/**\n * 运行时模型状态检查器\n * 定期检查模型状态的一致性\n */\nexport class ModelConsistencyChecker {\n  private checkInterval: NodeJS.Timeout | null = null\n  private isRunning = false\n\n  constructor(private intervalMs: number = 30000) {} // 默认30秒检查一次\n\n  start(getModelStates: () => { ui: string; state: string; storage: string }) {\n    if (this.isRunning) return\n\n    this.isRunning = true\n    this.checkInterval = setInterval(() => {\n      try {\n        const states = getModelStates()\n        const validation = validateModelConsistency(\n          states.ui,\n          states.state,\n          states.storage,\n          {\n            component: 'ModelConsistencyChecker',\n            timestamp: new Date().toISOString(),\n            environment: process.env.NODE_ENV || 'unknown'\n          }\n        )\n\n        // 如果发现不一致，发出警告\n        if (!validation.isValid) {\n          }\n      } catch (error) {\n        }\n    }, this.intervalMs)\n  }\n\n  stop() {\n    if (this.checkInterval) {\n      clearInterval(this.checkInterval)\n      this.checkInterval = null\n      this.isRunning = false\n    }\n  }\n\n  checkOnce(getModelStates: () => { ui: string; state: string; storage: string }) {\n    const states = getModelStates()\n    return validateModelConsistency(\n      states.ui,\n      states.state,\n      states.storage,\n      {\n        component: 'ManualCheck',\n        timestamp: new Date().toISOString(),\n        environment: process.env.NODE_ENV || 'unknown'\n      }\n    )\n  }\n}\n\n/**\n * 开发环境专用的调试工具\n */\nexport const ModelDebugTools = {\n  // 导出当前所有模型状态\n  exportModelStates: () => {\n    const states: any = {}\n    \n    try {\n      // 从localStorage获取\n      states.localStorage = localStorage.getItem('lastSelectedModelId')\n      \n      // 从白名单获取\n      states.allowedModels = ALLOWED_MODELS.map(m => ({ id: m.id, name: m.name }))\n      \n      // 当前时间\n      states.timestamp = new Date().toISOString()\n      \n      return states\n    } catch (error) {\n      return null\n    }\n  },\n\n  // 重置所有模型状态\n  resetModelStates: () => {\n    try {\n      localStorage.removeItem('lastSelectedModelId')\n      // 建议刷新页面\n      } catch (error) {\n      }\n  },\n\n  // 强制设置模型\n  forceSetModel: (modelId: string) => {\n    const validation = validateModelId(modelId)\n    if (!validation.isValid) {\n      return false\n    }\n\n    try {\n      localStorage.setItem('lastSelectedModelId', modelId)\n      return true\n    } catch (error) {\n      return false\n    }\n  }\n}\n\n// 在开发环境中暴露调试工具到全局\nif (process.env.NODE_ENV === 'development' && typeof window !== 'undefined') {\n  (window as any).ModelDebugTools = ModelDebugTools\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\monitoring\\api-monitor.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":98,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":98,"endColumn":21,"suggestions":[{"fix":{"range":[1895,2007],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'response' is defined but never used. Allowed unused args must match /^_/u.","line":258,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":258,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"response"},"fix":{"range":[5790,5816],"text":""},"desc":"Remove unused variable 'response'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * API监控模块\n * 用于追踪API请求的性能和错误\n */\n\ninterface APIStats {\n  endpoint: string\n  method: string\n  status: number\n  duration: number\n  success: boolean\n  error?: string\n  timestamp: Date\n}\n\ninterface AggregatedStats {\n  totalRequests: number\n  successCount: number\n  errorCount: number\n  averageResponseTime: number\n  errorRate: number\n  endpoints: Map<string, EndpointStats>\n  recentErrors: ErrorInfo[]\n}\n\ninterface EndpointStats {\n  requests: number\n  successes: number\n  errors: number\n  avgResponseTime: number\n  lastError?: string\n  lastErrorTime?: Date\n}\n\ninterface ErrorInfo {\n  endpoint: string\n  error: string\n  timestamp: Date\n  status?: number\n}\n\nclass APIMonitor {\n  private stats: APIStats[] = []\n  private maxStatsSize = 1000 // 最多保留1000条记录\n  private errorThreshold = 0.1 // 10%错误率阈值\n  private slowRequestThreshold = 5000 // 5秒慢请求阈值\n  \n  /**\n   * 记录API请求\n   */\n  logRequest(\n    endpoint: string,\n    method: string,\n    status: number,\n    duration: number,\n    error?: string\n  ): void {\n    const stat: APIStats = {\n      endpoint,\n      method,\n      status,\n      duration,\n      success: status >= 200 && status < 300,\n      error,\n      timestamp: new Date()\n    }\n    \n    this.stats.push(stat)\n    \n    // 限制内存使用\n    if (this.stats.length > this.maxStatsSize) {\n      this.stats = this.stats.slice(-this.maxStatsSize)\n    }\n    \n    // 检查是否需要告警\n    this.checkAlerts(stat)\n  }\n  \n  /**\n   * 检查并触发告警\n   */\n  private checkAlerts(stat: APIStats): void {\n    // 慢请求告警\n    if (stat.duration > this.slowRequestThreshold) {\n      }\n    \n    // 错误告警\n    if (!stat.success) {\n      }\n    \n    // 检查错误率\n    const recentStats = this.getRecentStats(100) // 最近100个请求\n    if (recentStats.length >= 10) {\n      const errorCount = recentStats.filter(s => !s.success).length\n      const errorRate = errorCount / recentStats.length\n      \n      if (errorRate > this.errorThreshold) {\n        console.warn(`High error rate detected: ${(errorRate * 100).toFixed(2)}% (${errorCount}/${recentStats.length})`)\n      }\n    }\n  }\n  \n  /**\n   * 获取最近的统计数据\n   */\n  private getRecentStats(count: number): APIStats[] {\n    return this.stats.slice(-count)\n  }\n  \n  /**\n   * 获取聚合统计\n   */\n  getAggregatedStats(): AggregatedStats {\n    const endpoints = new Map<string, EndpointStats>()\n    const recentErrors: ErrorInfo[] = []\n    \n    let totalDuration = 0\n    let successCount = 0\n    let errorCount = 0\n    \n    for (const stat of this.stats) {\n      // 更新总计\n      totalDuration += stat.duration\n      if (stat.success) {\n        successCount++\n      } else {\n        errorCount++\n        \n        // 记录错误信息\n        recentErrors.push({\n          endpoint: stat.endpoint,\n          error: stat.error || `HTTP ${stat.status}`,\n          timestamp: stat.timestamp,\n          status: stat.status\n        })\n      }\n      \n      // 更新端点统计\n      let endpointStat = endpoints.get(stat.endpoint)\n      if (!endpointStat) {\n        endpointStat = {\n          requests: 0,\n          successes: 0,\n          errors: 0,\n          avgResponseTime: 0\n        }\n        endpoints.set(stat.endpoint, endpointStat)\n      }\n      \n      endpointStat.requests++\n      if (stat.success) {\n        endpointStat.successes++\n      } else {\n        endpointStat.errors++\n        endpointStat.lastError = stat.error || `HTTP ${stat.status}`\n        endpointStat.lastErrorTime = stat.timestamp\n      }\n      \n      // 更新平均响应时间（增量计算）\n      endpointStat.avgResponseTime = \n        (endpointStat.avgResponseTime * (endpointStat.requests - 1) + stat.duration) / \n        endpointStat.requests\n    }\n    \n    const totalRequests = this.stats.length\n    \n    return {\n      totalRequests,\n      successCount,\n      errorCount,\n      averageResponseTime: totalRequests > 0 ? totalDuration / totalRequests : 0,\n      errorRate: totalRequests > 0 ? errorCount / totalRequests : 0,\n      endpoints,\n      recentErrors: recentErrors.slice(-10) // 最近10个错误\n    }\n  }\n  \n  /**\n   * 获取性能报告\n   */\n  getPerformanceReport(): string {\n    const stats = this.getAggregatedStats()\n    const lines: string[] = [\n      '=== API性能报告 ===',\n      `总请求数: ${stats.totalRequests}`,\n      `成功: ${stats.successCount} (${((stats.successCount / stats.totalRequests) * 100).toFixed(2)}%)`,\n      `失败: ${stats.errorCount} (${(stats.errorRate * 100).toFixed(2)}%)`,\n      `平均响应时间: ${stats.averageResponseTime.toFixed(0)}ms`,\n      '',\n      '端点统计:'\n    ]\n    \n    for (const [endpoint, endpointStats] of stats.endpoints) {\n      lines.push(\n        `  ${endpoint}:`,\n        `    请求: ${endpointStats.requests}`,\n        `    成功率: ${((endpointStats.successes / endpointStats.requests) * 100).toFixed(2)}%`,\n        `    平均响应: ${endpointStats.avgResponseTime.toFixed(0)}ms`\n      )\n      \n      if (endpointStats.lastError) {\n        lines.push(\n          `    最后错误: ${endpointStats.lastError} (${endpointStats.lastErrorTime?.toLocaleTimeString()})`\n        )\n      }\n    }\n    \n    if (stats.recentErrors.length > 0) {\n      lines.push('', '最近错误:')\n      for (const error of stats.recentErrors.slice(-5)) {\n        lines.push(\n          `  [${error.timestamp.toLocaleTimeString()}] ${error.endpoint}: ${error.error}`\n        )\n      }\n    }\n    \n    return lines.join('\\n')\n  }\n  \n  /**\n   * 清空统计数据\n   */\n  reset(): void {\n    this.stats = []\n  }\n  \n  /**\n   * 导出统计数据（用于持久化或分析）\n   */\n  export(): APIStats[] {\n    return [...this.stats]\n  }\n  \n  /**\n   * 导入统计数据\n   */\n  import(stats: APIStats[]): void {\n    this.stats = stats\n  }\n}\n\n// 创建全局实例\nexport const apiMonitor = new APIMonitor()\n\n// 开发环境下，每分钟输出一次性能报告\nif (process.env.NODE_ENV === 'development') {\n  setInterval(() => {\n    const report = apiMonitor.getPerformanceReport()\n    if (report) {\n      }\n  }, 60000)\n}\n\n// 导出工具函数\nexport function trackAPIRequest(\n  endpoint: string,\n  method: string = 'GET'\n): (response: Response | Error) => void {\n  const startTime = Date.now()\n  \n  return (responseOrError: Response | Error) => {\n    const duration = Date.now() - startTime\n    \n    if (responseOrError instanceof Error) {\n      apiMonitor.logRequest(\n        endpoint,\n        method,\n        0,\n        duration,\n        responseOrError.message\n      )\n    } else {\n      apiMonitor.logRequest(\n        endpoint,\n        method,\n        responseOrError.status,\n        duration,\n        responseOrError.ok ? undefined : `HTTP ${responseOrError.status}`\n      )\n    }\n  }\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\performance-utils.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":4,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":44,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[61,65],"text":""},"desc":"Remove unused variable 'args'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":14,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":44,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[338,342],"text":""},"desc":"Remove unused variable 'args'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\n// 防抖函数\nexport function debounce<T extends (...args: any[]) => any>(func: T, wait: number): T {\n  let timeout: NodeJS.Timeout | null = null\n\n  return ((...args: any[]) => {\n    if (timeout) clearTimeout(timeout)\n    timeout = setTimeout(() => func(...args), wait)\n  }) as T\n}\n\n// 节流函数\nexport function throttle<T extends (...args: any[]) => any>(func: T, limit: number): T {\n  let inThrottle: boolean\n\n  return ((...args: any[]) => {\n    if (!inThrottle) {\n      func(...args)\n      inThrottle = true\n      setTimeout(() => (inThrottle = false), limit)\n    }\n  }) as T\n}\n\n// 延迟执行\nexport function defer(callback: () => void): void {\n  if (typeof requestIdleCallback !== \"undefined\") {\n    requestIdleCallback(callback)\n  } else {\n    setTimeout(callback, 0)\n  }\n}\n\n// 批量更新\nexport class BatchUpdater {\n  private updates: (() => void)[] = []\n  private scheduled = false\n\n  add(update: () => void): void {\n    this.updates.push(update)\n    if (!this.scheduled) {\n      this.scheduled = true\n      requestAnimationFrame(() => {\n        this.flush()\n      })\n    }\n  }\n\n  private flush(): void {\n    const updates = this.updates.splice(0)\n    updates.forEach((update) => update())\n    this.scheduled = false\n  }\n}\n\n// 性能测量\nexport class PerformanceMeasurer {\n  private marks = new Map<string, number>()\n\n  start(name: string): void {\n    this.marks.set(name, performance.now())\n  }\n\n  end(name: string): number {\n    const startTime = this.marks.get(name)\n    if (!startTime) {\n      return 0\n    }\n\n    const duration = performance.now() - startTime\n    this.marks.delete(name)\n    return duration\n  }\n\n  measure(name: string, fn: () => void): number {\n    this.start(name)\n    fn()\n    return this.end(name)\n  }\n\n  async measureAsync(name: string, fn: () => Promise<void>): Promise<number> {\n    this.start(name)\n    await fn()\n    return this.end(name)\n  }\n}\n\n// 内存使用监控\nexport function getMemoryUsage(): { used: number; total: number } | null {\n  if (typeof window !== \"undefined\" && \"memory\" in performance) {\n    const memory = (performance as any).memory\n    return {\n      used: Math.round(memory.usedJSHeapSize / 1024 / 1024),\n      total: Math.round(memory.totalJSHeapSize / 1024 / 1024),\n    }\n  }\n  return null\n}\n\n// 网络状态检测\nexport function getNetworkInfo(): { effectiveType?: string; downlink?: number; rtt?: number } {\n  if (typeof navigator !== \"undefined\" && \"connection\" in navigator) {\n    const connection = (navigator as any).connection\n    return {\n      effectiveType: connection.effectiveType,\n      downlink: connection.downlink,\n      rtt: connection.rtt,\n    }\n  }\n  return {}\n}\n\n// 设备性能等级评估\nexport function getDevicePerformanceLevel(): \"high\" | \"medium\" | \"low\" {\n  if (typeof navigator === \"undefined\") return \"medium\"\n\n  const hardwareConcurrency = navigator.hardwareConcurrency || 4\n  const memory = getMemoryUsage()\n  const network = getNetworkInfo()\n\n  let score = 0\n\n  // CPU核心数评分\n  if (hardwareConcurrency >= 8) score += 3\n  else if (hardwareConcurrency >= 4) score += 2\n  else score += 1\n\n  // 内存评分\n  if (memory && memory.total >= 4000) score += 3\n  else if (memory && memory.total >= 2000) score += 2\n  else score += 1\n\n  // 网络评分\n  if (network.effectiveType === \"4g\") score += 2\n  else if (network.effectiveType === \"3g\") score += 1\n\n  if (score >= 7) return \"high\"\n  if (score >= 4) return \"medium\"\n  return \"low\"\n}\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\prisma.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":53,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":53,"endColumn":21,"suggestions":[{"fix":{"range":[1566,1624],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":57,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":57,"endColumn":16,"suggestions":[{"fix":{"range":[1648,1675],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":59,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":59,"endColumn":17,"suggestions":[{"fix":{"range":[1700,1744],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":67,"column":30,"nodeType":"MemberExpression","messageId":"unexpected","endLine":67,"endColumn":42},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":70,"column":47,"nodeType":"MemberExpression","messageId":"unexpected","endLine":70,"endColumn":59}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client'\n\n// 全局变量声明（避免开发环境多次实例化）\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\n// SQLite优化配置（修复版 - 区分查询和执行类型）\nconst sqliteOptimizations = [\n  { sql: 'PRAGMA journal_mode=WAL', type: 'query', desc: 'WAL模式' },\n  { sql: 'PRAGMA cache_size=-16000', type: 'execute', desc: '缓存大小' },\n  { sql: 'PRAGMA synchronous=NORMAL', type: 'execute', desc: '同步模式' },\n  { sql: 'PRAGMA busy_timeout=30000', type: 'query', desc: '繁忙超时' },\n  { sql: 'PRAGMA temp_store=memory', type: 'execute', desc: '临时表存储' },\n  { sql: 'PRAGMA wal_autocheckpoint=1000', type: 'query', desc: 'WAL检查点' },\n  { sql: 'PRAGMA foreign_keys=ON', type: 'execute', desc: '外键约束' }\n]\n\n// 创建 Prisma 客户端实例\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient({\n  // 日志配置：开发环境显示查询，生产环境只显示错误\n  log: process.env.NODE_ENV === 'development' \n    ? ['query', 'warn', 'error'] \n    : ['error'],\n  \n  // 数据源配置\n  datasources: {\n    db: {\n      url: process.env.DATABASE_URL\n    }\n  },\n\n  // 事务优化配置（优化超时设置）\n  transactionOptions: {\n    maxWait: 5000,         // 最大等待时间：5秒（减少锁等待）\n    timeout: 45000,        // 事务超时：45秒（匹配API超时）\n    isolationLevel: 'ReadCommitted'  // 降低隔离级别，提升并发性能\n  }\n})\n\n// 数据库连接初始化和优化\nasync function initializeDatabase() {\n  try {\n    // 执行SQLite优化配置（区分查询和执行类型）\n    for (const opt of sqliteOptimizations) {\n      try {\n        if (opt.type === 'query') {\n          await prisma.$queryRawUnsafe(opt.sql)\n        } else {\n          await prisma.$executeRawUnsafe(opt.sql)\n        }\n      } catch (pragmaError) {\n        console.warn(`⚠️  ${opt.desc} 配置失败:`, pragmaError.message)\n      }\n    }\n    \n    console.log('✅ 数据库优化配置已应用')\n  } catch (error) {\n    console.warn('⚠️  数据库优化配置失败，使用默认设置:', error)\n  }\n}\n\n// 开发环境缓存实例\nif (process.env.NODE_ENV !== 'production') {\n  globalForPrisma.prisma = prisma\n  // 开发环境立即初始化\n  initializeDatabase().catch(console.warn)\n} else {\n  // 生产环境延迟初始化\n  setTimeout(() => initializeDatabase().catch(console.warn), 1000)\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\security\\content-filter.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":248,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":248,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[6762,6766],"text":""},"desc":"Remove unused variable 'args'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 内容过滤和安全验证工具\r\n * 防止注入攻击和恶意内容\r\n */\r\n\r\n// 内容过滤配置\r\nexport const CONTENT_FILTER_CONFIG = {\r\n  // 编辑器上下文限制\r\n  EDITOR_EXCERPT: {\r\n    MAX_LENGTH: 2000,           // 最大长度2000字符\r\n    MAX_LINES: 50,              // 最大50行\r\n    ALLOWED_LANGUAGES: [        // 允许的编程语言标识\r\n      'javascript', 'typescript', 'python', 'java', 'c++', 'c', 'go', \r\n      'rust', 'html', 'css', 'json', 'xml', 'yaml', 'markdown'\r\n    ]\r\n  },\r\n  \r\n  // 危险模式匹配\r\n  DANGEROUS_PATTERNS: [\r\n    /system\\s*[:：]\\s*/i,        // \"system:\" 或 \"system：\"\r\n    /assistant\\s*[:：]\\s*/i,     // \"assistant:\" 或 \"assistant：\"\r\n    /human\\s*[:：]\\s*/i,         // \"human:\" 或 \"human：\"  \r\n    /user\\s*[:：]\\s*/i,          // \"user:\" 或 \"user：\"\r\n    /\\[system\\]/i,               // [system]\r\n    /\\[assistant\\]/i,            // [assistant]\r\n    /\\[user\\]/i,                 // [user]\r\n    /忽略以上/i,                  // \"忽略以上\"\r\n    /ignore\\s+above/i,           // \"ignore above\"\r\n    /forget\\s+previous/i,        // \"forget previous\"\r\n    /new\\s+instruction/i,        // \"new instruction\"\r\n    /重新定义/i,                  // \"重新定义\"\r\n    /redefine/i,                 // \"redefine\"\r\n    /<script\\b/i,                // script标签\r\n    /javascript\\s*:/i,           // javascript: 协议\r\n    /data\\s*:/i,                 // data: 协议\r\n  ],\r\n  \r\n  // 敏感关键词\r\n  SENSITIVE_KEYWORDS: [\r\n    'prompt injection', '提示注入', 'jailbreak', '越狱',\r\n    'system prompt', '系统提示', 'override', '覆盖',\r\n    'backdoor', '后门', 'malware', '恶意软件'\r\n  ]\r\n}\r\n\r\n// 过滤结果类型\r\nexport interface ContentFilterResult {\r\n  isValid: boolean\r\n  filteredContent: string\r\n  warnings: string[]\r\n  dangerLevel: 'safe' | 'suspicious' | 'dangerous'\r\n  metadata: {\r\n    originalLength: number\r\n    filteredLength: number\r\n    removedLines: number\r\n    truncated: boolean\r\n  }\r\n}\r\n\r\n/**\r\n * 过滤编辑器上下文内容\r\n */\r\nexport function filterEditorExcerpt(content: string): ContentFilterResult {\r\n  const originalLength = content.length\r\n  const warnings: string[] = []\r\n  let dangerLevel: 'safe' | 'suspicious' | 'dangerous' = 'safe'\r\n  \r\n  // 1. 基本验证\r\n  if (!content || typeof content !== 'string') {\r\n    return {\r\n      isValid: false,\r\n      filteredContent: '',\r\n      warnings: ['内容为空或格式无效'],\r\n      dangerLevel: 'safe',\r\n      metadata: {\r\n        originalLength: 0,\r\n        filteredLength: 0,\r\n        removedLines: 0,\r\n        truncated: false\r\n      }\r\n    }\r\n  }\r\n\r\n  let filteredContent = content.trim()\r\n\r\n  // 2. 长度限制\r\n  let truncated = false\r\n  if (filteredContent.length > CONTENT_FILTER_CONFIG.EDITOR_EXCERPT.MAX_LENGTH) {\r\n    filteredContent = filteredContent.substring(0, CONTENT_FILTER_CONFIG.EDITOR_EXCERPT.MAX_LENGTH)\r\n    truncated = true\r\n    warnings.push(`内容超长已截断至${CONTENT_FILTER_CONFIG.EDITOR_EXCERPT.MAX_LENGTH}字符`)\r\n  }\r\n\r\n  // 3. 行数限制\r\n  const lines = filteredContent.split('\\n')\r\n  let removedLines = 0\r\n  if (lines.length > CONTENT_FILTER_CONFIG.EDITOR_EXCERPT.MAX_LINES) {\r\n    const keepLines = CONTENT_FILTER_CONFIG.EDITOR_EXCERPT.MAX_LINES\r\n    filteredContent = lines.slice(0, keepLines).join('\\n')\r\n    removedLines = lines.length - keepLines\r\n    warnings.push(`超过${CONTENT_FILTER_CONFIG.EDITOR_EXCERPT.MAX_LINES}行限制，已移除${removedLines}行`)\r\n  }\r\n\r\n  // 4. 危险模式检测\r\n  const dangerousMatches = CONTENT_FILTER_CONFIG.DANGEROUS_PATTERNS.filter(pattern => \r\n    pattern.test(filteredContent)\r\n  )\r\n\r\n  if (dangerousMatches.length > 0) {\r\n    dangerLevel = 'dangerous'\r\n    warnings.push(`检测到${dangerousMatches.length}个可能的注入模式`)\r\n    \r\n    // 移除或替换危险模式\r\n    for (const pattern of CONTENT_FILTER_CONFIG.DANGEROUS_PATTERNS) {\r\n      filteredContent = filteredContent.replace(pattern, '[已过滤]')\r\n    }\r\n  }\r\n\r\n  // 5. 敏感关键词检测\r\n  const sensitiveMatches = CONTENT_FILTER_CONFIG.SENSITIVE_KEYWORDS.filter(keyword =>\r\n    filteredContent.toLowerCase().includes(keyword.toLowerCase())\r\n  )\r\n\r\n  if (sensitiveMatches.length > 0) {\r\n    if (dangerLevel === 'safe') dangerLevel = 'suspicious'\r\n    warnings.push(`检测到${sensitiveMatches.length}个敏感关键词`)\r\n    \r\n    // 替换敏感关键词\r\n    for (const keyword of CONTENT_FILTER_CONFIG.SENSITIVE_KEYWORDS) {\r\n      const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'), 'gi')\r\n      filteredContent = filteredContent.replace(regex, '[敏感内容]')\r\n    }\r\n  }\r\n\r\n  // 6. HTML/JavaScript 清理\r\n  filteredContent = sanitizeContent(filteredContent)\r\n\r\n  // 7. 最终验证\r\n  const isValid = dangerLevel !== 'dangerous' && filteredContent.length > 0\r\n\r\n  return {\r\n    isValid,\r\n    filteredContent,\r\n    warnings,\r\n    dangerLevel,\r\n    metadata: {\r\n      originalLength,\r\n      filteredLength: filteredContent.length,\r\n      removedLines,\r\n      truncated\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 内容清理 - 移除HTML标签和危险字符\r\n */\r\nfunction sanitizeContent(content: string): string {\r\n  return content\r\n    // 移除HTML标签\r\n    .replace(/<[^>]*>/g, '')\r\n    // 移除JavaScript事件属性\r\n    .replace(/on\\w+\\s*=\\s*['\"\"].*?['\"]/gi, '')\r\n    // 移除特殊控制字符（保留换行和制表符）\r\n    .replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '')\r\n    // 限制连续的换行符\r\n    .replace(/\\n{4,}/g, '\\n\\n\\n')\r\n}\r\n\r\n/**\r\n * 生成安全的上下文消息\r\n */\r\nexport function createSafeContextMessage(editorExcerpt: string): { role: string; content: string } | null {\r\n  if (!editorExcerpt) return null\r\n\r\n  const filterResult = filterEditorExcerpt(editorExcerpt)\r\n  \r\n  if (!filterResult.isValid) {\r\n    return null\r\n  }\r\n\r\n  // 记录可疑内容\r\n  if (filterResult.dangerLevel !== 'safe') {\r\n    }\r\n\r\n  return {\r\n    role: \"system\",\r\n    content: `以下是用户编辑器中的代码上下文（已安全过滤）：\\n\\n${filterResult.filteredContent}\\n\\n请基于此上下文协助用户。`\r\n  }\r\n}\r\n\r\n/**\r\n * 验证消息内容\r\n */\r\nexport function validateMessageContent(content: string): ContentFilterResult {\r\n  // 对用户消息进行基本验证\r\n  const maxMessageLength = 10000 // 单条消息最大长度\r\n  const warnings: string[] = []\r\n  let dangerLevel: 'safe' | 'suspicious' | 'dangerous' = 'safe'\r\n  \r\n  if (!content || typeof content !== 'string') {\r\n    return {\r\n      isValid: false,\r\n      filteredContent: '',\r\n      warnings: ['消息内容无效'],\r\n      dangerLevel: 'safe',\r\n      metadata: {\r\n        originalLength: 0,\r\n        filteredLength: 0,\r\n        removedLines: 0,\r\n        truncated: false\r\n      }\r\n    }\r\n  }\r\n\r\n  let filteredContent = content.trim()\r\n  const originalLength = filteredContent.length\r\n\r\n  // 长度检查\r\n  let truncated = false\r\n  if (filteredContent.length > maxMessageLength) {\r\n    filteredContent = filteredContent.substring(0, maxMessageLength)\r\n    truncated = true\r\n    warnings.push('消息过长已截断')\r\n  }\r\n\r\n  // 基本清理\r\n  filteredContent = sanitizeContent(filteredContent)\r\n\r\n  return {\r\n    isValid: true,\r\n    filteredContent,\r\n    warnings,\r\n    dangerLevel,\r\n    metadata: {\r\n      originalLength,\r\n      filteredLength: filteredContent.length,\r\n      removedLines: 0,\r\n      truncated\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 内容过滤中间件 - 用于API路由\r\n */\r\nexport function withContentFilter<T extends any[], R>(\r\n  handler: (...args: T) => Promise<R>,\r\n  options: { logSuspicious?: boolean } = {}\r\n) {\r\n  return async (...args: T): Promise<R> => {\r\n    // 这里可以添加请求级别的内容过滤逻辑\r\n    const result = await handler(...args)\r\n    \r\n    // 记录可疑活动\r\n    if (options.logSuspicious) {\r\n      // 实现日志记录逻辑\r\n    }\r\n    \r\n    return result\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\security\\invite-code-security.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'prisma' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"prisma"},"fix":{"range":[0,37],"text":""},"desc":"Remove unused variable 'prisma'."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":229,"column":5,"nodeType":"MemberExpression","messageId":"unexpected","endLine":229,"endColumn":16,"suggestions":[{"fix":{"range":[5438,5681],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '@/lib/prisma'\r\nimport { createHash } from 'crypto'\r\nimport { NextRequest } from 'next/server'\r\n\r\n// 邀请码安全配置\r\nexport const SECURITY_CONFIG = {\r\n  // 验证失败限制\r\n  MAX_ATTEMPTS_PER_IP: 5,        // 每个IP最多尝试次数\r\n  MAX_ATTEMPTS_PER_DAY: 20,      // 每天全局最多尝试次数\r\n  LOCKOUT_DURATION: 15 * 60 * 1000, // 锁定时长（15分钟）\r\n  \r\n  // 速率限制\r\n  RATE_LIMIT_WINDOW: 60 * 1000,  // 时间窗口（1分钟）\r\n  RATE_LIMIT_MAX_REQUESTS: 3,    // 时间窗口内最多请求次数\r\n  \r\n  // 邀请码格式\r\n  CODE_MIN_LENGTH: 20,            // 邀请码最小长度\r\n  CODE_CHARSET: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%', // 扩展字符集\r\n}\r\n\r\n// 验证尝试记录（内存缓存，生产环境应使用Redis）\r\nconst attemptCache = new Map<string, {\r\n  count: number\r\n  firstAttempt: Date\r\n  lastAttempt: Date\r\n  locked: boolean\r\n  lockedUntil?: Date\r\n}>()\r\n\r\n// 速率限制缓存\r\nconst rateLimitCache = new Map<string, {\r\n  requests: Date[]\r\n}>()\r\n\r\n/**\r\n * 生成安全的邀请码\r\n */\r\nexport function generateSecureInviteCode(): string {\r\n  const charset = SECURITY_CONFIG.CODE_CHARSET\r\n  const length = 24 // 增加长度\r\n  let code = ''\r\n  \r\n  // 使用加密随机数生成器\r\n  const randomValues = new Uint8Array(length)\r\n  crypto.getRandomValues(randomValues)\r\n  \r\n  for (let i = 0; i < length; i++) {\r\n    code += charset[randomValues[i] % charset.length]\r\n  }\r\n  \r\n  // 添加校验和（防止随机猜测）\r\n  const checksum = createHash('sha256')\r\n    .update(code + process.env.NEXTAUTH_SECRET)\r\n    .digest('hex')\r\n    .substring(0, 4)\r\n    .toUpperCase()\r\n  \r\n  return `${code}-${checksum}`\r\n}\r\n\r\n/**\r\n * 验证邀请码格式和校验和\r\n */\r\nexport function validateInviteCodeFormat(code: string): boolean {\r\n  const parts = code.split('-')\r\n  if (parts.length !== 2) return false\r\n  \r\n  const [mainCode, providedChecksum] = parts\r\n  \r\n  // 验证长度\r\n  if (mainCode.length < SECURITY_CONFIG.CODE_MIN_LENGTH) return false\r\n  \r\n  // 验证校验和\r\n  const expectedChecksum = createHash('sha256')\r\n    .update(mainCode + process.env.NEXTAUTH_SECRET)\r\n    .digest('hex')\r\n    .substring(0, 4)\r\n    .toUpperCase()\r\n  \r\n  return providedChecksum === expectedChecksum\r\n}\r\n\r\n/**\r\n * 获取客户端IP\r\n */\r\nexport function getClientIP(request: NextRequest): string {\r\n  const forwarded = request.headers.get('x-forwarded-for')\r\n  const realIP = request.headers.get('x-real-ip')\r\n  const ip = forwarded?.split(',')[0] || realIP || 'unknown'\r\n  \r\n  // 对IP进行哈希处理，保护隐私\r\n  return createHash('sha256').update(ip).digest('hex').substring(0, 16)\r\n}\r\n\r\n/**\r\n * 检查IP是否被锁定\r\n */\r\nexport function isIPLocked(ipHash: string): boolean {\r\n  const attempts = attemptCache.get(ipHash)\r\n  \r\n  if (!attempts || !attempts.locked) return false\r\n  \r\n  if (attempts.lockedUntil && new Date() > attempts.lockedUntil) {\r\n    // 解锁\r\n    attempts.locked = false\r\n    attempts.count = 0\r\n    return false\r\n  }\r\n  \r\n  return true\r\n}\r\n\r\n/**\r\n * 记录失败尝试\r\n */\r\nexport function recordFailedAttempt(ipHash: string): void {\r\n  const now = new Date()\r\n  const attempts = attemptCache.get(ipHash) || {\r\n    count: 0,\r\n    firstAttempt: now,\r\n    lastAttempt: now,\r\n    locked: false\r\n  }\r\n  \r\n  attempts.count++\r\n  attempts.lastAttempt = now\r\n  \r\n  // 检查是否需要锁定\r\n  if (attempts.count >= SECURITY_CONFIG.MAX_ATTEMPTS_PER_IP) {\r\n    attempts.locked = true\r\n    attempts.lockedUntil = new Date(now.getTime() + SECURITY_CONFIG.LOCKOUT_DURATION)\r\n  }\r\n  \r\n  attemptCache.set(ipHash, attempts)\r\n}\r\n\r\n/**\r\n * 清除成功验证后的记录\r\n */\r\nexport function clearAttempts(ipHash: string): void {\r\n  attemptCache.delete(ipHash)\r\n  rateLimitCache.delete(ipHash)\r\n}\r\n\r\n/**\r\n * 检查速率限制\r\n */\r\nexport function checkRateLimit(ipHash: string): boolean {\r\n  const now = new Date()\r\n  const limit = rateLimitCache.get(ipHash) || { requests: [] }\r\n  \r\n  // 清理过期的请求记录\r\n  limit.requests = limit.requests.filter(\r\n    date => now.getTime() - date.getTime() < SECURITY_CONFIG.RATE_LIMIT_WINDOW\r\n  )\r\n  \r\n  // 检查是否超过限制\r\n  if (limit.requests.length >= SECURITY_CONFIG.RATE_LIMIT_MAX_REQUESTS) {\r\n    return false\r\n  }\r\n  \r\n  // 记录新请求\r\n  limit.requests.push(now)\r\n  rateLimitCache.set(ipHash, limit)\r\n  \r\n  return true\r\n}\r\n\r\n/**\r\n * 生成时效性令牌（可选方案）\r\n */\r\nexport function generateTemporaryToken(inviteCode: string): string {\r\n  const timestamp = Date.now()\r\n  const data = `${inviteCode}:${timestamp}`\r\n  const signature = createHash('sha256')\r\n    .update(data + process.env.NEXTAUTH_SECRET)\r\n    .digest('hex')\r\n  \r\n  return Buffer.from(`${data}:${signature}`).toString('base64')\r\n}\r\n\r\n/**\r\n * 验证时效性令牌\r\n */\r\nexport function validateTemporaryToken(token: string, maxAge: number = 5 * 60 * 1000): {\r\n  valid: boolean\r\n  inviteCode?: string\r\n} {\r\n  try {\r\n    const decoded = Buffer.from(token, 'base64').toString()\r\n    const parts = decoded.split(':')\r\n    \r\n    if (parts.length !== 3) return { valid: false }\r\n    \r\n    const [inviteCode, timestamp, signature] = parts\r\n    const now = Date.now()\r\n    \r\n    // 检查时效性\r\n    if (now - parseInt(timestamp) > maxAge) {\r\n      return { valid: false }\r\n    }\r\n    \r\n    // 验证签名\r\n    const expectedSignature = createHash('sha256')\r\n      .update(`${inviteCode}:${timestamp}` + process.env.NEXTAUTH_SECRET)\r\n      .digest('hex')\r\n    \r\n    if (signature !== expectedSignature) {\r\n      return { valid: false }\r\n    }\r\n    \r\n    return { valid: true, inviteCode }\r\n  } catch {\r\n    return { valid: false }\r\n  }\r\n}\r\n\r\n/**\r\n * 记录所有验证尝试（用于审计）\r\n */\r\nexport async function logVerificationAttempt(\r\n  ipHash: string,\r\n  code: string,\r\n  success: boolean,\r\n  userAgent?: string\r\n) {\r\n  // 仅在开发环境记录到控制台，生产环境可扩展为数据库或日志服务\r\n  if (process.env.NODE_ENV === 'development') {\r\n    console.log('Invite code attempt:', {\r\n      timestamp: new Date().toISOString(),\r\n      ipHash,\r\n      codePrefix: code.substring(0, 4) + '***', // 不记录完整邀请码\r\n      success,\r\n      userAgent: userAgent?.substring(0, 50) // 截断User-Agent\r\n    })\r\n  }\r\n  \r\n  // TODO: 在生产环境中添加数据库日志记录或发送到日志服务\r\n  \r\n  // 可选：记录到数据库\r\n  // await prisma.auditLog.create({\r\n  //   data: {\r\n  //     action: 'INVITE_CODE_VERIFICATION',\r\n  //     ipHash,\r\n  //     success,\r\n  //     metadata: { userAgent }\r\n  //   }\r\n  // })\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\security\\rate-limiter.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":196,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":196,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[4636,4640],"text":""},"desc":"Remove unused variable 'args'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'request' is defined but never used. Allowed unused args must match /^_/u.","line":198,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":198,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"request"},"fix":{"range":[4700,4720],"text":""},"desc":"Remove unused variable 'request'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":206,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":206,"endColumn":21},{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":288,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":288,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[6960,6964],"text":""},"desc":"Remove unused variable 'args'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":291,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":291,"endColumn":47,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[7074,7078],"text":""},"desc":"Remove unused variable 'args'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":294,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":294,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[7188,7192],"text":""},"desc":"Remove unused variable 'args'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'args' is defined but never used. Allowed unused args must match /^_/u.","line":297,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":297,"endColumn":50,"suggestions":[{"messageId":"removeVar","data":{"varName":"args"},"fix":{"range":[7305,7309],"text":""},"desc":"Remove unused variable 'args'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * API速率限制工具\r\n * 防止恶意刷量攻击，保护系统资源\r\n */\r\n\r\nimport { NextRequest } from 'next/server'\r\nimport { createHash } from 'crypto'\r\nimport { ApiError, ApiErrorCode } from '@/lib/api/error-handler'\r\n\r\n// 速率限制配置\r\nexport const RATE_LIMIT_CONFIG = {\r\n  // 通用API限制 (requests per minute)\r\n  GENERAL: { requests: 60, window: 60 * 1000 },\r\n  \r\n  // 聊天API限制 (更严格)\r\n  CHAT: { requests: 30, window: 60 * 1000 },\r\n  \r\n  // 认证相关API限制 (非常严格)\r\n  AUTH: { requests: 10, window: 60 * 1000 },\r\n  \r\n  // 管理员API限制\r\n  ADMIN: { requests: 100, window: 60 * 1000 },\r\n  \r\n  // 文件上传限制\r\n  UPLOAD: { requests: 20, window: 60 * 1000 },\r\n  \r\n  // 搜索API限制\r\n  SEARCH: { requests: 50, window: 60 * 1000 },\r\n  \r\n  // IP级别的全局限制\r\n  GLOBAL_IP: { requests: 200, window: 60 * 1000 },\r\n  \r\n  // 用户级别的限制\r\n  USER: { requests: 300, window: 60 * 1000 }\r\n}\r\n\r\n// 限制类型\r\nexport type RateLimitType = keyof typeof RATE_LIMIT_CONFIG\r\n\r\n// 请求记录接口\r\ninterface RequestRecord {\r\n  count: number\r\n  firstRequest: number\r\n  lastRequest: number\r\n  blocked: boolean\r\n  blockedUntil?: number\r\n}\r\n\r\n// 内存存储（生产环境建议使用Redis）\r\nconst requestCounts = new Map<string, RequestRecord>()\r\n\r\n// 清理过期记录的定时任务\r\nsetInterval(() => {\r\n  const now = Date.now()\r\n  for (const [key, record] of requestCounts.entries()) {\r\n    // 清理超过5分钟的记录\r\n    if (now - record.lastRequest > 5 * 60 * 1000) {\r\n      requestCounts.delete(key)\r\n    }\r\n  }\r\n}, 2 * 60 * 1000) // 每2分钟清理一次\r\n\r\n/**\r\n * 生成限制键\r\n */\r\nfunction generateLimitKey(identifier: string, type: RateLimitType): string {\r\n  // 对标识符进行哈希处理以保护隐私\r\n  const hash = createHash('sha256').update(identifier).digest('hex').substring(0, 16)\r\n  return `ratelimit:${type}:${hash}`\r\n}\r\n\r\n/**\r\n * 获取客户端标识符\r\n */\r\nfunction getClientIdentifier(request: NextRequest, userId?: string): string {\r\n  // 优先使用用户ID，其次使用IP\r\n  if (userId) return `user:${userId}`\r\n  \r\n  const forwarded = request.headers.get('x-forwarded-for')\r\n  const realIP = request.headers.get('x-real-ip') \r\n  const ip = forwarded?.split(',')[0] || realIP || 'unknown'\r\n  \r\n  return `ip:${ip}`\r\n}\r\n\r\n/**\r\n * 检查速率限制\r\n */\r\nexport function checkRateLimit(\r\n  request: NextRequest, \r\n  type: RateLimitType,\r\n  userId?: string\r\n): { allowed: boolean; remaining: number; resetTime: number; error?: ApiError } {\r\n  const config = RATE_LIMIT_CONFIG[type]\r\n  const identifier = getClientIdentifier(request, userId)\r\n  const key = generateLimitKey(identifier, type)\r\n  const now = Date.now()\r\n  \r\n  // 获取或创建请求记录\r\n  let record = requestCounts.get(key)\r\n  \r\n  if (!record) {\r\n    // 首次请求\r\n    record = {\r\n      count: 1,\r\n      firstRequest: now,\r\n      lastRequest: now,\r\n      blocked: false\r\n    }\r\n    requestCounts.set(key, record)\r\n    return { \r\n      allowed: true, \r\n      remaining: config.requests - 1,\r\n      resetTime: now + config.window\r\n    }\r\n  }\r\n  \r\n  // 检查是否在阻止期间\r\n  if (record.blocked && record.blockedUntil && now < record.blockedUntil) {\r\n    return {\r\n      allowed: false,\r\n      remaining: 0,\r\n      resetTime: record.blockedUntil,\r\n      error: new ApiError(\r\n        ApiErrorCode.RATE_LIMITED,\r\n        `API调用过于频繁，请在${Math.ceil((record.blockedUntil - now) / 1000)}秒后重试`,\r\n        429,\r\n        { \r\n          type, \r\n          resetTime: record.blockedUntil,\r\n          identifier: identifier.startsWith('user:') ? 'user' : 'ip'\r\n        }\r\n      )\r\n    }\r\n  }\r\n  \r\n  // 检查时间窗口\r\n  if (now - record.firstRequest > config.window) {\r\n    // 重置窗口\r\n    record = {\r\n      count: 1,\r\n      firstRequest: now,\r\n      lastRequest: now,\r\n      blocked: false\r\n    }\r\n    requestCounts.set(key, record)\r\n    return { \r\n      allowed: true, \r\n      remaining: config.requests - 1,\r\n      resetTime: now + config.window\r\n    }\r\n  }\r\n  \r\n  // 检查是否超过限制\r\n  if (record.count >= config.requests) {\r\n    // 超过限制，阻止请求\r\n    record.blocked = true\r\n    record.blockedUntil = now + config.window\r\n    record.lastRequest = now\r\n    requestCounts.set(key, record)\r\n    \r\n    return {\r\n      allowed: false,\r\n      remaining: 0,\r\n      resetTime: record.blockedUntil,\r\n      error: new ApiError(\r\n        ApiErrorCode.RATE_LIMITED,\r\n        `API调用频率超限，请在${Math.ceil(config.window / 1000)}秒后重试`,\r\n        429,\r\n        { \r\n          type, \r\n          limit: config.requests,\r\n          window: config.window,\r\n          identifier: identifier.startsWith('user:') ? 'user' : 'ip'\r\n        }\r\n      )\r\n    }\r\n  }\r\n  \r\n  // 更新记录\r\n  record.count++\r\n  record.lastRequest = now\r\n  requestCounts.set(key, record)\r\n  \r\n  return { \r\n    allowed: true, \r\n    remaining: config.requests - record.count,\r\n    resetTime: record.firstRequest + config.window\r\n  }\r\n}\r\n\r\n/**\r\n * 速率限制装饰器\r\n */\r\nexport function withRateLimit<T extends any[], R>(\r\n  handler: (...args: T) => Promise<R>,\r\n  type: RateLimitType,\r\n  getUserId?: (request: NextRequest) => Promise<string | undefined>\r\n) {\r\n  return async (request: NextRequest, ...restArgs: any[]): Promise<R> => {\r\n    // 获取用户ID（如果提供了获取函数）\r\n    let userId: string | undefined\r\n    if (getUserId) {\r\n      try {\r\n        userId = await getUserId(request)\r\n      } catch (error) {\r\n        // 忽略获取用户ID的错误，继续使用IP限制\r\n        }\r\n    }\r\n    \r\n    // 检查速率限制\r\n    const limitCheck = checkRateLimit(request, type, userId)\r\n    \r\n    if (!limitCheck.allowed && limitCheck.error) {\r\n      throw limitCheck.error\r\n    }\r\n    \r\n    // 执行原始处理函数，使用类型断言来解决泛型约束问题\r\n    const result = await handler(...([request, ...restArgs] as T))\r\n    \r\n    return result\r\n  }\r\n}\r\n\r\n/**\r\n * 多重限制检查 (同时检查多个限制类型)\r\n */\r\nexport function checkMultipleRateLimits(\r\n  request: NextRequest,\r\n  types: RateLimitType[],\r\n  userId?: string\r\n): { allowed: boolean; remaining: number; resetTime: number; error?: ApiError; failedType?: RateLimitType } {\r\n  for (const type of types) {\r\n    const result = checkRateLimit(request, type, userId)\r\n    if (!result.allowed) {\r\n      return { ...result, failedType: type }\r\n    }\r\n  }\r\n  \r\n  // 返回最严格的限制信息\r\n  const results = types.map(type => checkRateLimit(request, type, userId))\r\n  const minRemaining = Math.min(...results.map(r => r.remaining))\r\n  const maxResetTime = Math.max(...results.map(r => r.resetTime))\r\n  \r\n  return {\r\n    allowed: true,\r\n    remaining: minRemaining,\r\n    resetTime: maxResetTime\r\n  }\r\n}\r\n\r\n/**\r\n * 获取限制状态（用于监控）\r\n */\r\nexport function getRateLimitStats(): {\r\n  totalKeys: number\r\n  activeBlocks: number\r\n  memoryUsage: number\r\n} {\r\n  const now = Date.now()\r\n  let activeBlocks = 0\r\n  \r\n  for (const record of requestCounts.values()) {\r\n    if (record.blocked && record.blockedUntil && now < record.blockedUntil) {\r\n      activeBlocks++\r\n    }\r\n  }\r\n  \r\n  return {\r\n    totalKeys: requestCounts.size,\r\n    activeBlocks,\r\n    memoryUsage: JSON.stringify([...requestCounts.entries()]).length\r\n  }\r\n}\r\n\r\n/**\r\n * 手动清除特定键的限制（管理员功能）\r\n */\r\nexport function clearRateLimit(identifier: string, type: RateLimitType): boolean {\r\n  const key = generateLimitKey(identifier, type)\r\n  return requestCounts.delete(key)\r\n}\r\n\r\n/**\r\n * 预设的速率限制中间件\r\n */\r\nexport const RateLimitMiddleware = {\r\n  chat: <T extends any[], R>(handler: (...args: T) => Promise<R>) => \r\n    withRateLimit(handler, 'CHAT'),\r\n    \r\n  auth: <T extends any[], R>(handler: (...args: T) => Promise<R>) =>\r\n    withRateLimit(handler, 'AUTH'),\r\n    \r\n  admin: <T extends any[], R>(handler: (...args: T) => Promise<R>) =>\r\n    withRateLimit(handler, 'ADMIN'),\r\n    \r\n  general: <T extends any[], R>(handler: (...args: T) => Promise<R>) =>\r\n    withRateLimit(handler, 'GENERAL')\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\storage.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":16,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":27,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":37,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":47,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":47,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// 本地存储工具类\nexport class LocalStorage {\n  private static prefix = \"zhidian_\"\n\n  // 检查是否在客户端环境\n  private static isClient(): boolean {\n    return typeof window !== 'undefined' && typeof localStorage !== 'undefined'\n  }\n\n  static setItem<T>(key: string, value: T): void {\n    if (!this.isClient()) return\n    \n    try {\n      const serializedValue = JSON.stringify(value)\n      window.localStorage.setItem(this.prefix + key, serializedValue)\n    } catch (error) {\n      }\n  }\n\n  static getItem<T>(key: string, defaultValue: T): T {\n    if (!this.isClient()) return defaultValue\n    \n    try {\n      const item = window.localStorage.getItem(this.prefix + key)\n      if (item === null) return defaultValue\n      return JSON.parse(item) as T\n    } catch (error) {\n      return defaultValue\n    }\n  }\n\n  static removeItem(key: string): void {\n    if (!this.isClient()) return\n    \n    try {\n      window.localStorage.removeItem(this.prefix + key)\n    } catch (error) {\n      }\n  }\n\n  static clear(): void {\n    if (!this.isClient()) return\n    \n    try {\n      const keys = Object.keys(window.localStorage).filter((key) => key.startsWith(this.prefix))\n      keys.forEach((key) => window.localStorage.removeItem(key))\n    } catch (error) {\n      }\n  }\n\n  // 检查本地存储是否可用\n  static isAvailable(): boolean {\n    if (!this.isClient()) return false\n    \n    try {\n      const testKey = \"__test__\"\n      window.localStorage.setItem(testKey, \"test\")\n      window.localStorage.removeItem(testKey)\n      return true\n    } catch {\n      return false\n    }\n  }\n}\n\n// 存储键名常量\nexport const STORAGE_KEYS = {\n  CONVERSATIONS: \"conversations\",\n  CURRENT_CONVERSATION_ID: \"current_conversation_id\", // 当前选中的对话ID\n  USER_SETTINGS: \"user_settings\",\n  THEME: \"theme\",\n  DOCUMENTS: \"documents\",\n  RECENT_MODELS: \"recent_models\",\n  CHAT_DRAFTS: \"chat_drafts\",\n} as const\n","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\title-utils.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'index' is defined but never used. Allowed unused args must match /^_/u.","line":136,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":136,"endColumn":36,"suggestions":[{"messageId":"removeVar","data":{"varName":"index"},"fix":{"range":[3296,3303],"text":""},"desc":"Remove unused variable 'index'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'title12' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":137,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":137,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"title12"},"fix":{"range":[3314,3359],"text":""},"desc":"Remove unused variable 'title12'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'title15' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":138,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":18},{"ruleId":"no-unused-vars","severity":1,"message":"'title20' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":139,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":139,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 对话标题智能处理工具\n * 考虑UI显示限制和响应式设计\n */\n\n/**\n * 智能截取标题\n * @param content 原始内容\n * @param maxLength 最大字符数（默认15，适配侧边栏显示）\n * @returns 截取后的标题\n */\nexport function createSmartTitle(content: string, maxLength: number = 15): string {\n  if (!content || !content.trim()) {\n    return '新对话'\n  }\n\n  const trimmedContent = content.trim()\n  \n  // 如果内容本身就很短，直接返回\n  if (trimmedContent.length <= maxLength) {\n    return trimmedContent\n  }\n\n  // 智能截取策略：\n  // 1. 优先在句号、问号、感叹号处截断\n  // 2. 其次在逗号、分号处截断  \n  // 3. 避免在单词中间截断（英文）\n  // 4. 最后添加省略号\n  \n  const punctuationBreaks = ['。', '？', '！', '.', '?', '!']\n  const softBreaks = ['，', '；', ',', ';', ' ']\n  \n  // 在理想长度范围内查找标点符号\n  const idealRange = Math.floor(maxLength * 0.7) // 70%位置开始查找\n  \n  // 查找句号等强截断点\n  for (let i = idealRange; i < Math.min(maxLength, trimmedContent.length); i++) {\n    if (punctuationBreaks.includes(trimmedContent[i])) {\n      return trimmedContent.substring(0, i + 1)\n    }\n  }\n  \n  // 查找逗号等软截断点\n  for (let i = idealRange; i < Math.min(maxLength, trimmedContent.length); i++) {\n    if (softBreaks.includes(trimmedContent[i])) {\n      return trimmedContent.substring(0, i) + '...'\n    }\n  }\n  \n  // 硬截断，但尽量避免截断emoji或特殊字符\n  const truncated = trimmedContent.substring(0, maxLength - 3)\n  return truncated + '...'\n}\n\n/**\n * 根据不同屏幕尺寸动态调整标题长度\n */\nexport function getAdaptiveTitleLength(): number {\n  if (typeof window === 'undefined') return 15 // SSR fallback\n  \n  const width = window.innerWidth\n  \n  // 移动端：侧边栏折叠，不需要考虑\n  if (width < 768) return 20\n  \n  // 平板：较小空间\n  if (width < 1024) return 12\n  \n  // 桌面端：正常空间\n  if (width < 1440) return 15\n  \n  // 大屏：更多空间\n  return 18\n}\n\n/**\n * 生成智能对话标题\n * @param firstUserMessage 用户的第一条消息内容\n * @param maxLength 最大长度，默认15\n */\nexport function generateConversationTitle(firstUserMessage: string, maxLength?: number): string {\n  const adaptiveLength = maxLength || getAdaptiveTitleLength()\n  return createSmartTitle(firstUserMessage, adaptiveLength)\n}\n\n/**\n * 检查对话是否需要生成标题\n * @param conversation 对话对象\n * @returns 是否需要生成新标题\n */\nexport function shouldGenerateTitle(conversation: any): boolean {\n  if (!conversation || !conversation.messages) return false\n  \n  // 检查是否还是默认标题且有用户消息\n  const hasDefaultTitle = conversation.title === '新对话' || !conversation.title.trim()\n  const hasUserMessages = conversation.messages.some((msg: any) => msg.role === 'user' && msg.content.trim())\n  \n  return hasDefaultTitle && hasUserMessages\n}\n\n/**\n * 从对话中获取智能标题\n * @param conversation 对话对象\n * @returns 智能生成的标题\n */\nexport function getSmartTitleFromConversation(conversation: any): string {\n  if (!conversation || !conversation.messages) return '新对话'\n  \n  // 找到第一条用户消息\n  const firstUserMessage = conversation.messages.find((msg: any) => \n    msg.role === 'user' && msg.content && msg.content.trim()\n  )\n  \n  if (!firstUserMessage) return '新对话'\n  \n  return generateConversationTitle(firstUserMessage.content)\n}\n\n/**\n * 测试不同场景下的标题生成\n */\nexport function testTitleGeneration() {\n  const testCases = [\n    \"帮我写一个登录页面的完整代码\",\n    \"What is the best way to handle authentication in Next.js applications?\",\n    \"你好！我想了解一下React的useState Hook的使用方法。\",\n    \"解释一下这个错误：Cannot read properties of undefined\",\n    \"写一个简单的待办事项应用\",\n    \"How to fix CORS errors?\",\n    \"请帮我分析这段代码的性能问题，我觉得渲染太慢了\",\n    \"Hi there!\",\n    \"\",\n    \"A\"\n  ]\n  \n  testCases.forEach((content, index) => {\n    const title12 = createSmartTitle(content, 12)\n    const title15 = createSmartTitle(content, 15) \n    const title20 = createSmartTitle(content, 20)\n    \n    })\n}\n\n// 开发时可以调用测试\nif (typeof window !== 'undefined' && process.env.NODE_ENV === 'development') {\n  // testTitleGeneration()\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\utils\\api-cache.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'defaultTTL' is assigned a value but never used. Allowed unused args must match /^_/u.","line":17,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"defaultTTL"},"fix":{"range":[274,284],"text":""},"desc":"Remove unused variable 'defaultTTL'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'maxSize' is assigned a value but never used. Allowed unused args must match /^_/u.","line":18,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"maxSize"},"fix":{"range":[316,323],"text":""},"desc":"Remove unused variable 'maxSize'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 简单的内存缓存工具\r\n * 用于缓存统计查询结果，减少数据库压力\r\n */\r\n\r\ninterface CacheEntry<T> {\r\n  data: T\r\n  timestamp: number\r\n  ttl: number\r\n}\r\n\r\nclass SimpleCache {\r\n  private cache = new Map<string, CacheEntry<any>>()\r\n  private cleanupTimer?: NodeJS.Timeout\r\n\r\n  constructor(\r\n    private defaultTTL = 60000, // 默认60秒\r\n    private maxSize = 100        // 最大缓存条目数\r\n  ) {\r\n    // 每分钟清理过期缓存\r\n    this.startCleanup()\r\n  }\r\n\r\n  /**\r\n   * 获取缓存\r\n   */\r\n  get<T>(key: string): T | null {\r\n    const entry = this.cache.get(key)\r\n    if (!entry) return null\r\n\r\n    // 检查是否过期\r\n    if (Date.now() > entry.timestamp + entry.ttl) {\r\n      this.cache.delete(key)\r\n      return null\r\n    }\r\n\r\n    return entry.data as T\r\n  }\r\n\r\n  /**\r\n   * 设置缓存\r\n   */\r\n  set<T>(key: string, data: T, ttl?: number): void {\r\n    // 如果缓存已满，删除最旧的条目\r\n    if (this.cache.size >= this.maxSize) {\r\n      const firstKey = this.cache.keys().next().value\r\n      if (firstKey) this.cache.delete(firstKey)\r\n    }\r\n\r\n    this.cache.set(key, {\r\n      data,\r\n      timestamp: Date.now(),\r\n      ttl: ttl || this.defaultTTL\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 删除缓存\r\n   */\r\n  delete(key: string): void {\r\n    this.cache.delete(key)\r\n  }\r\n\r\n  /**\r\n   * 清空缓存\r\n   */\r\n  clear(): void {\r\n    this.cache.clear()\r\n  }\r\n\r\n  /**\r\n   * 获取缓存统计\r\n   */\r\n  getStats() {\r\n    return {\r\n      size: this.cache.size,\r\n      maxSize: this.maxSize,\r\n      keys: Array.from(this.cache.keys())\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 启动定期清理\r\n   */\r\n  private startCleanup() {\r\n    this.cleanupTimer = setInterval(() => {\r\n      const now = Date.now()\r\n      for (const [key, entry] of this.cache.entries()) {\r\n        if (now > entry.timestamp + entry.ttl) {\r\n          this.cache.delete(key)\r\n        }\r\n      }\r\n    }, 60000) // 每分钟清理一次\r\n  }\r\n\r\n  /**\r\n   * 停止清理（用于测试或关闭）\r\n   */\r\n  destroy() {\r\n    if (this.cleanupTimer) {\r\n      clearInterval(this.cleanupTimer)\r\n      this.cleanupTimer = undefined\r\n    }\r\n    this.clear()\r\n  }\r\n}\r\n\r\n// 创建缓存实例\r\nconst statsCache = new SimpleCache(30000, 50)  // 30秒TTL，最多50条\r\nconst queryCache = new SimpleCache(60000, 100) // 60秒TTL，最多100条\r\n\r\n/**\r\n * 带缓存的查询包装器\r\n */\r\nexport async function cachedQuery<T>(\r\n  key: string,\r\n  queryFn: () => Promise<T>,\r\n  ttl?: number\r\n): Promise<T> {\r\n  // 尝试从缓存获取\r\n  const cached = queryCache.get<T>(key)\r\n  if (cached !== null) {\r\n    return cached\r\n  }\r\n\r\n  // 执行查询\r\n  const result = await queryFn()\r\n  \r\n  // 存入缓存\r\n  queryCache.set(key, result, ttl)\r\n  \r\n  return result\r\n}\r\n\r\n/**\r\n * 使用示例：\r\n * \r\n * const stats = await cachedQuery(\r\n *   `user-stats-${userId}-${days}`,\r\n *   () => prisma.usageStats.findMany({ ... }),\r\n *   30000 // 30秒缓存\r\n * )\r\n */\r\n\r\nexport { SimpleCache, statsCache, queryCache }","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\utils\\retry.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used. Allowed unused args must match /^_/u.","line":11,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"error"},"fix":{"range":[165,178],"text":""},"desc":"Remove unused variable 'error'."}]},{"ruleId":"no-unused-vars","severity":1,"message":"'attempt' is defined but never used. Allowed unused args must match /^_/u.","line":11,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":43,"suggestions":[{"messageId":"removeVar","data":{"varName":"attempt"},"fix":{"range":[177,194],"text":""},"desc":"Remove unused variable 'attempt'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 重试工具函数\n * 提供指数退避的自动重试机制\n */\n\nexport interface RetryOptions {\n  maxRetries?: number\n  initialDelay?: number\n  maxDelay?: number\n  factor?: number\n  onRetry?: (error: Error, attempt: number) => void\n}\n\n/**\n * 使用指数退避算法的重试函数\n * @param fn 需要重试的异步函数\n * @param options 重试配置选项\n * @returns Promise<T>\n */\nexport async function retryWithBackoff<T>(\n  fn: () => Promise<T>,\n  options: RetryOptions = {}\n): Promise<T> {\n  const {\n    maxRetries = 3,\n    initialDelay = 1000,\n    maxDelay = 30000,\n    factor = 2,\n    onRetry\n  } = options\n\n  let lastError: Error\n\n  for (let attempt = 0; attempt < maxRetries; attempt++) {\n    try {\n      return await fn()\n    } catch (error) {\n      lastError = error as Error\n\n      // 判断是否应该重试\n      if (!shouldRetry(error)) {\n        throw error\n      }\n\n      // 最后一次尝试，直接抛出错误\n      if (attempt === maxRetries - 1) {\n        throw error\n      }\n\n      // 计算延迟时间（指数退避）\n      const delay = Math.min(\n        initialDelay * Math.pow(factor, attempt),\n        maxDelay\n      )\n\n      // 触发重试回调\n      if (onRetry) {\n        onRetry(lastError, attempt + 1)\n      }\n\n      // 等待后重试\n      await sleep(delay)\n    }\n  }\n\n  throw lastError!\n}\n\n/**\n * 判断错误是否应该重试\n * @param error 错误对象\n * @returns boolean\n */\nfunction shouldRetry(error: any): boolean {\n  const message = error?.message || ''\n  const status = error?.status || error?.response?.status\n\n  // 不应该重试的错误类型\n  const noRetryPatterns = [\n    '401',           // 未授权\n    '403',           // 禁止访问\n    '月度配额',      // 配额耗尽\n    '无效的API Key', // API Key错误\n    '模型验证失败',  // 模型不支持\n  ]\n\n  // 检查是否包含不应重试的模式\n  for (const pattern of noRetryPatterns) {\n    if (message.includes(pattern) || status === parseInt(pattern)) {\n      return false\n    }\n  }\n\n  // 应该重试的错误类型\n  const retryPatterns = [\n    'ECONNRESET',       // 连接重置\n    'ETIMEDOUT',        // 超时\n    'ENOTFOUND',        // DNS解析失败\n    'NetworkError',     // 网络错误\n    '408',              // 请求超时\n    '500',              // 服务器内部错误\n    '502',              // 网关错误\n    '503',              // 服务不可用\n    '504',              // 网关超时\n    '429',              // 请求过多（限流）\n    'AbortError',       // 请求被中止\n    '请求超时',         // 中文超时消息\n    '流处理失败',       // SSE流错误\n    'AI服务响应超时',   // AI服务超时\n    'AI服务连接失败',   // AI服务连接失败\n    'Database timeout', // 数据库超时\n    'timeout',          // 通用超时\n  ]\n\n  // 检查是否应该重试\n  for (const pattern of retryPatterns) {\n    if (message.includes(pattern) || status === parseInt(pattern)) {\n      return true\n    }\n  }\n\n  // 默认重试网络相关错误\n  return error.name === 'TypeError' || error.name === 'FetchError'\n}\n\n/**\n * 延迟函数\n * @param ms 延迟毫秒数\n */\nfunction sleep(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms))\n}\n\n/**\n * 带超时的fetch请求\n * @param url 请求URL\n * @param options 请求选项\n * @param timeout 超时时间（毫秒）\n */\nexport async function fetchWithTimeout(\n  url: string,\n  options: RequestInit = {},\n  timeout = 30000\n): Promise<Response> {\n  const controller = new AbortController()\n  const timeoutId = setTimeout(() => controller.abort(), timeout)\n\n  try {\n    const response = await fetch(url, {\n      ...options,\n      signal: controller.signal\n    })\n    clearTimeout(timeoutId)\n    return response\n  } catch (error: any) {\n    clearTimeout(timeoutId)\n    if (error.name === 'AbortError') {\n      const timeoutError = new Error(`请求超时（${timeout}ms）`)\n      timeoutError.name = 'TimeoutError'\n      throw timeoutError\n    }\n    throw error\n  }\n}\n\n/**\n * 带重试和超时的fetch请求\n * @param url 请求URL\n * @param options 请求选项\n * @param retryOptions 重试选项\n * @param timeout 超时时间\n */\nexport async function fetchWithRetry(\n  url: string,\n  options: RequestInit = {},\n  retryOptions: RetryOptions = {},\n  timeout = 30000\n): Promise<Response> {\n  return retryWithBackoff(\n    () => fetchWithTimeout(url, options, timeout),\n    retryOptions\n  )\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\utils\\smart-fetch.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":48,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":19},{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":73,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * 智能Fetch客户端\n * 集成网络状态监控、自动重连、断线恢复等功能\n */\n\nimport { retryWithBackoff, type RetryOptions } from './retry'\n\nexport interface SmartFetchOptions extends RequestInit {\n  /** 重试选项 */\n  retry?: RetryOptions\n  /** 是否等待网络恢复 */\n  waitForRecovery?: boolean\n  /** 网络恢复等待超时时间（毫秒） */\n  recoveryTimeout?: number\n  /** 是否在重试前检查网络状态 */\n  checkNetworkBeforeRetry?: boolean\n  /** 请求超时时间（毫秒） */\n  timeout?: number\n  /** 是否显示重试通知 */\n  showRetryNotification?: boolean\n}\n\n/**\n * 网络恢复检查函数\n */\nasync function waitForNetworkRecovery(timeout = 30000): Promise<boolean> {\n  const startTime = Date.now()\n  const healthCheckUrl = '/api/health'\n  \n  while (Date.now() - startTime < timeout) {\n    try {\n      // 检查浏览器网络状态\n      if (!navigator.onLine) {\n        await new Promise(resolve => setTimeout(resolve, 1000))\n        continue\n      }\n\n      // 检查服务器健康状态\n      const response = await fetch(healthCheckUrl, {\n        method: 'HEAD',\n        cache: 'no-cache',\n        signal: AbortSignal.timeout(5000)\n      })\n\n      if (response.ok) {\n        return true\n      }\n    } catch (error) {\n      // 继续等待\n    }\n\n    await new Promise(resolve => setTimeout(resolve, 2000))\n  }\n\n  return false\n}\n\n/**\n * 检查网络状态\n */\nasync function checkNetworkStatus(): Promise<boolean> {\n  if (!navigator.onLine) {\n    return false\n  }\n\n  try {\n    const response = await fetch('/api/health', {\n      method: 'HEAD',\n      cache: 'no-cache',\n      signal: AbortSignal.timeout(5000)\n    })\n    return response.ok\n  } catch (error) {\n    return false\n  }\n}\n\n/**\n * 创建带超时的fetch请求\n */\nfunction createTimeoutFetch(url: string, options: RequestInit, timeout: number): Promise<Response> {\n  return new Promise((resolve, reject) => {\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => {\n      controller.abort()\n      reject(new Error(`请求超时（${timeout}ms）`))\n    }, timeout)\n\n    fetch(url, {\n      ...options,\n      signal: controller.signal\n    })\n    .then(response => {\n      clearTimeout(timeoutId)\n      resolve(response)\n    })\n    .catch(error => {\n      clearTimeout(timeoutId)\n      if (error.name === 'AbortError') {\n        reject(new Error(`请求超时（${timeout}ms）`))\n      } else {\n        reject(error)\n      }\n    })\n  })\n}\n\n/**\n * 智能Fetch函数\n * 自动处理网络异常、重连、重试等场景\n */\nexport async function smartFetch(\n  url: string,\n  options: SmartFetchOptions = {}\n): Promise<Response> {\n  const {\n    retry = {\n      maxRetries: 3,\n      initialDelay: 1000,\n      factor: 2\n    },\n    waitForRecovery = true,\n    recoveryTimeout = 30000,\n    checkNetworkBeforeRetry = true,\n    timeout = 30000,\n    showRetryNotification = false,\n    ...fetchOptions\n  } = options\n\n  // 增强的重试逻辑\n  const enhancedRetry: RetryOptions = {\n    ...retry,\n    onRetry: async (error, attempt) => {\n      // 如果启用了重试通知\n      if (showRetryNotification && typeof window !== 'undefined') {\n        const event = new CustomEvent('smart-fetch-retry', {\n          detail: { url, attempt, error: error.message }\n        })\n        window.dispatchEvent(event)\n      }\n\n      // 在重试前检查网络状态\n      if (checkNetworkBeforeRetry) {\n        const networkHealthy = await checkNetworkStatus()\n        if (!networkHealthy && waitForRecovery) {\n          const recovered = await waitForNetworkRecovery(recoveryTimeout)\n          if (!recovered) {\n            throw new Error('网络恢复超时，请检查网络连接')\n          }\n        }\n      }\n\n      // 调用原始的重试回调\n      if (retry.onRetry) {\n        retry.onRetry(error, attempt)\n      }\n    }\n  }\n\n  // 执行请求\n  return retryWithBackoff(\n    () => createTimeoutFetch(url, fetchOptions, timeout),\n    enhancedRetry\n  )\n}\n\n/**\n * 智能Fetch的便捷方法\n */\nexport const smartApi = {\n  async get(url: string, options?: Omit<SmartFetchOptions, 'method'>) {\n    return smartFetch(url, { ...options, method: 'GET' })\n  },\n\n  async post(url: string, data?: any, options?: Omit<SmartFetchOptions, 'method' | 'body'>) {\n    return smartFetch(url, {\n      ...options,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        ...options?.headers\n      },\n      body: data ? JSON.stringify(data) : undefined\n    })\n  },\n\n  async put(url: string, data?: any, options?: Omit<SmartFetchOptions, 'method' | 'body'>) {\n    return smartFetch(url, {\n      ...options,\n      method: 'PUT',\n      headers: {\n        'Content-Type': 'application/json',\n        ...options?.headers\n      },\n      body: data ? JSON.stringify(data) : undefined\n    })\n  },\n\n  async delete(url: string, options?: Omit<SmartFetchOptions, 'method'>) {\n    return smartFetch(url, { ...options, method: 'DELETE' })\n  },\n\n  /**\n   * 带JSON解析的GET请求\n   */\n  async getJson<T>(url: string, options?: Omit<SmartFetchOptions, 'method'>): Promise<T> {\n    const response = await this.get(url, options)\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n    }\n    return response.json()\n  },\n\n  /**\n   * 带JSON解析的POST请求\n   */\n  async postJson<T>(url: string, data?: any, options?: Omit<SmartFetchOptions, 'method' | 'body'>): Promise<T> {\n    const response = await this.post(url, data, options)\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n    }\n    return response.json()\n  }\n}\n\n/**\n * 网络状态感知的Hook工厂\n * 返回一个自动处理网络状态的fetch hook\n */\nexport function createNetworkAwareFetch(defaultOptions?: SmartFetchOptions) {\n  return {\n    smartFetch: (url: string, options?: SmartFetchOptions) => \n      smartFetch(url, { ...defaultOptions, ...options }),\n    \n    smartApi: {\n      get: (url: string, options?: Omit<SmartFetchOptions, 'method'>) =>\n        smartApi.get(url, { ...defaultOptions, ...options }),\n      \n      post: (url: string, data?: any, options?: Omit<SmartFetchOptions, 'method' | 'body'>) =>\n        smartApi.post(url, data, { ...defaultOptions, ...options }),\n      \n      getJson: <T>(url: string, options?: Omit<SmartFetchOptions, 'method'>) =>\n        smartApi.getJson<T>(url, { ...defaultOptions, ...options }),\n      \n      postJson: <T>(url: string, data?: any, options?: Omit<SmartFetchOptions, 'method' | 'body'>) =>\n        smartApi.postJson<T>(url, data, { ...defaultOptions, ...options })\n    }\n  }\n}\n\n// 默认的网络感知fetch实例\nexport const networkAwareFetch = createNetworkAwareFetch({\n  retry: { maxRetries: 3, initialDelay: 1000 },\n  waitForRecovery: true,\n  recoveryTimeout: 30000,\n  checkNetworkBeforeRetry: true,\n  timeout: 30000\n})","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\utils\\tag-parser.ts","messages":[{"ruleId":"no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":19,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":17},{"ruleId":"no-unused-vars","severity":1,"message":"'secondError' is defined but never used.","line":42,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 健壮的标签解析工具\r\n * 处理各种可能的标签数据格式\r\n */\r\n\r\n/**\r\n * 安全解析标签数据\r\n * @param tagString - 标签字符串数据\r\n * @returns 解析后的标签数组\r\n */\r\nexport function parseTagsSafely(tagString: string | null | undefined): string[] {\r\n  if (!tagString || tagString.trim() === '') {\r\n    return []\r\n  }\r\n\r\n  try {\r\n    // 尝试直接JSON解析\r\n    return JSON.parse(tagString)\r\n  } catch (error) {\r\n    try {\r\n      // 方法2: 将Python风格的数组转换为JSON格式\r\n      let cleaned = tagString.trim()\r\n      \r\n      // 如果是数组格式，处理单引号\r\n      if (cleaned.startsWith('[') && cleaned.endsWith(']')) {\r\n        // 替换单引号为双引号，但要小心字符串内部的单引号\r\n        cleaned = cleaned.replace(/'/g, '\"')\r\n        return JSON.parse(cleaned)\r\n      }\r\n      \r\n      // 方法3: 处理逗号分隔的字符串\r\n      if (cleaned.includes(',') && !cleaned.startsWith('[')) {\r\n        return cleaned.split(',').map(tag => tag.trim().replace(/['\"]/g, ''))\r\n      }\r\n      \r\n      // 方法4: 单个标签\r\n      if (!cleaned.startsWith('[')) {\r\n        return [cleaned.replace(/['\"]/g, '')]\r\n      }\r\n      \r\n      return []\r\n    } catch (secondError) {\r\n      return []\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 清理和标准化标签\r\n * @param tags - 标签数组\r\n * @returns 清理后的标签数组\r\n */\r\nexport function cleanTags(tags: string[]): string[] {\r\n  return tags\r\n    .filter(tag => typeof tag === 'string' && tag.trim() !== '')\r\n    .map(tag => tag.trim())\r\n    .filter(tag => tag.length > 0 && tag.length <= 50) // 过滤过长的标签\r\n    .slice(0, 20) // 限制标签数量\r\n}\r\n\r\n/**\r\n * 解析和清理标签的组合函数\r\n * @param tagString - 标签字符串数据\r\n * @returns 清理后的标签数组\r\n */\r\nexport function parseAndCleanTags(tagString: string | null | undefined): string[] {\r\n  const parsed = parseTagsSafely(tagString)\r\n  return cleanTags(parsed)\r\n}","usedDeprecatedRules":[]},{"filePath":"D:\\zdqidongxiangmu\\lib\\utils\\usage-stats-helper.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":34,"column":9,"nodeType":"MemberExpression","messageId":"unexpected","endLine":34,"endColumn":21,"suggestions":[{"fix":{"range":[701,734],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement.","line":58,"column":7,"nodeType":"MemberExpression","messageId":"unexpected","endLine":58,"endColumn":19,"suggestions":[{"fix":{"range":[1201,1247],"text":""},"messageId":"removeConsole","data":{"propertyName":"warn"},"desc":"Remove the console.warn()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * 使用量统计辅助函数\r\n * 简单、优雅、无副作用\r\n */\r\n\r\nimport { PrismaClient } from '@prisma/client'\r\n\r\ninterface UsageRecord {\r\n  userId: string\r\n  modelId: string\r\n  modelProvider?: string | null\r\n  promptTokens?: number\r\n  completionTokens?: number\r\n  totalTokens?: number\r\n  messagesCreated?: number\r\n  success?: boolean\r\n}\r\n\r\n/**\r\n * 异步记录使用量统计（发送即忘）\r\n * 不阻塞主流程，失败不影响用户体验\r\n */\r\nexport function recordUsageAsync(\r\n  prisma: PrismaClient,\r\n  record: UsageRecord\r\n): void {\r\n  // 使用 Promise 异步执行，不等待结果\r\n  Promise.resolve().then(async () => {\r\n    try {\r\n      await recordUsageInternal(prisma, record)\r\n    } catch (error) {\r\n      // 记录但不抛出错误，避免影响主流程\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.warn('使用量统计记录失败:', error)\r\n      }\r\n      // 生产环境静默处理，确保用户体验不受影响\r\n    }\r\n  })\r\n}\r\n\r\n/**\r\n * 内部记录函数（增强版 - 解决外键约束问题）\r\n */\r\nasync function recordUsageInternal(\r\n  prisma: PrismaClient,\r\n  record: UsageRecord\r\n): Promise<void> {\r\n  const today = getTodayUTC()\r\n  \r\n  // 关键修复：先验证用户存在，避免外键约束违反\r\n  const userExists = await prisma.user.findUnique({\r\n    where: { id: record.userId },\r\n    select: { id: true }\r\n  })\r\n  \r\n  if (!userExists) {\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.warn(`跳过不存在用户的统计记录: ${record.userId}`)\r\n    }\r\n    return // 静默跳过，不影响主流程\r\n  }\r\n\r\n  // 使用优化的事务配置和错误处理\r\n  await prisma.$transaction(\r\n    [\r\n      // 1. 更新总量统计\r\n      prisma.usageStats.upsert({\r\n        where: {\r\n          userId_date_modelId: {\r\n            userId: record.userId,\r\n            date: today,\r\n            modelId: \"_total\"\r\n          }\r\n        },\r\n        update: {\r\n          apiCalls: { increment: 1 },\r\n          successfulCalls: record.success ? { increment: 1 } : undefined,\r\n          failedCalls: !record.success ? { increment: 1 } : undefined,\r\n          promptTokens: record.promptTokens ? { increment: record.promptTokens } : undefined,\r\n          completionTokens: record.completionTokens ? { increment: record.completionTokens } : undefined,\r\n          totalTokens: record.totalTokens ? { increment: record.totalTokens } : undefined,\r\n          messagesCreated: record.messagesCreated ? { increment: record.messagesCreated } : undefined,\r\n          updatedAt: new Date(),\r\n        },\r\n        create: {\r\n          userId: record.userId,\r\n          date: today,\r\n          modelId: \"_total\",\r\n          apiCalls: 1,\r\n          successfulCalls: record.success ? 1 : 0,\r\n          failedCalls: !record.success ? 1 : 0,\r\n          promptTokens: record.promptTokens || 0,\r\n          completionTokens: record.completionTokens || 0,\r\n          totalTokens: record.totalTokens || 0,\r\n          messagesCreated: record.messagesCreated || 0,\r\n        }\r\n      }),\r\n      \r\n      // 2. 更新按模型统计\r\n      prisma.usageStats.upsert({\r\n        where: {\r\n          userId_date_modelId: {\r\n            userId: record.userId,\r\n            date: today,\r\n            modelId: record.modelId\r\n          }\r\n        },\r\n        update: {\r\n          apiCalls: { increment: 1 },\r\n          successfulCalls: record.success ? { increment: 1 } : undefined,\r\n          failedCalls: !record.success ? { increment: 1 } : undefined,\r\n          promptTokens: record.promptTokens ? { increment: record.promptTokens } : undefined,\r\n          completionTokens: record.completionTokens ? { increment: record.completionTokens } : undefined,\r\n          totalTokens: record.totalTokens ? { increment: record.totalTokens } : undefined,\r\n          messagesCreated: record.messagesCreated ? { increment: record.messagesCreated } : undefined,\r\n          updatedAt: new Date(),\r\n        },\r\n        create: {\r\n          userId: record.userId,\r\n          date: today,\r\n          modelId: record.modelId,\r\n          modelProvider: record.modelProvider,\r\n          apiCalls: 1,\r\n          successfulCalls: record.success ? 1 : 0,\r\n          failedCalls: !record.success ? 1 : 0,\r\n          promptTokens: record.promptTokens || 0,\r\n          completionTokens: record.completionTokens || 0,\r\n          totalTokens: record.totalTokens || 0,\r\n          messagesCreated: record.messagesCreated || 0,\r\n        }\r\n      })\r\n    ],\r\n    {\r\n      // 使用更长的超时时间和重试机制\r\n      maxWait: 15000,  // 15秒等待\r\n      timeout: 45000,  // 45秒超时\r\n      // SQLite下使用序列化隔离级别确保一致性\r\n      isolationLevel: 'Serializable'\r\n    }\r\n  )\r\n}\r\n\r\n/**\r\n * 获取UTC日期（0点）\r\n */\r\nfunction getTodayUTC(): Date {\r\n  const today = new Date()\r\n  today.setUTCHours(0, 0, 0, 0)\r\n  return today\r\n}\r\n\r\nexport type { UsageRecord }","usedDeprecatedRules":[]}]