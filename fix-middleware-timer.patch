// 修复 middleware.ts 的定时器清理问题
//
// 问题：setInterval 返回值未保存，无法清理
// 解决：保存定时器ID并添加清理机制

// 在 middleware.ts 中修改：

// 修改前：
if (process.env.NODE_ENV === 'development') {
  setInterval(() => {
    if (totalRequests > 0) {
      const hitRate = ((cacheHits / totalRequests) * 100).toFixed(1)
      totalRequests = 0
      cacheHits = 0
    }
  }, 30000)
}

// 修改后：
if (process.env.NODE_ENV === 'development') {
  // 保存定时器ID
  const statsInterval = setInterval(() => {
    if (totalRequests > 0) {
      const hitRate = ((cacheHits / totalRequests) * 100).toFixed(1)
      console.log(`[Middleware Stats] Hit Rate: ${hitRate}%, Total Requests: ${totalRequests}`)
      // 重置计数器
      totalRequests = 0
      cacheHits = 0
    }
  }, 30000)
  
  // 添加进程退出时的清理
  const cleanup = () => {
    if (statsInterval) {
      clearInterval(statsInterval)
      console.log('[Middleware] Stats interval cleared')
    }
  }
  
  // 监听进程退出信号
  process.on('SIGTERM', cleanup)
  process.on('SIGINT', cleanup)
  process.on('beforeExit', cleanup)
}