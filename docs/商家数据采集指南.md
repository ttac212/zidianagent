# 商家创作档案优化 - 使用指南

## 📋 概述

本次优化为商家档案系统添加了以下核心功能：

1. **播放量数据采集** - 获取真实的视频播放量
2. **评论数据采集** - 每个视频采集100条真实用户评论
3. **刷量检测** - 自动识别疑似刷量的视频
4. **互动率计算** - 基于播放量计算真实互动率
5. **质量评分** - 综合评估视频内容质量

---

## 🗄️ 数据库变更

### 新增表

#### `MerchantContentComment` (评论表)
```sql
- id: 主键
- contentId: 关联视频ID
- externalId: 抖音评论ID (唯一)
- text: 评论文本
- authorName: 评论者昵称
- authorUid: 评论者UID
- diggCount: 评论点赞数
- replyCount: 回复数
- isTop: 是否置顶
- keywords: 关键词 (JSON数组)
- createdAt: 评论时间
- collectedAt: 采集时间
```

### 扩展字段

#### `Merchant` (商家表)
```sql
+ followerCount: 粉丝数
+ totalPlayCount: 总播放量
+ avgEngagementRate: 平均互动率
```

#### `MerchantContent` (内容表)
```sql
+ playCount: 播放量 ⭐ 核心指标
+ forwardCount: 转发数
+ likeRate: 点赞率 (%)
+ commentRate: 评论率 (%)
+ completionRate: 完播率 (%)
+ avgWatchDuration: 平均观看时长 (秒)
+ isSuspicious: 疑似刷量标记
+ suspiciousReason: 标记原因
```

---

## 🚀 快速开始

### 步骤1：重新生成Prisma Client

**如果之前遇到权限错误**，请先关闭开发服务器，然后运行：

```bash
# 方式1：生成Client
pnpm db:generate

# 方式2：如果方式1失败，直接push（已自动同步）
pnpm db:push
```

### 步骤2：配置TikHub API密钥

确保 `.env.local` 中配置了TikHub API密钥：

```env
TIKHUB_API_KEY=your_api_key_here
```

### 步骤3：采集数据

#### 选项A：处理单个商家

```bash
npx tsx scripts/enhance-merchant-videos.ts [商家ID]
```

示例：
```bash
# 获取商家ID（可选）
npx tsx scripts/check-merchant-data.ts

# 处理特定商家
npx tsx scripts/enhance-merchant-videos.ts cm123456abc
```

#### 选项B：批量处理所有商家（推荐）

```bash
npx tsx scripts/batch-enhance-all.ts
```

**特点**：
- 自动按点赞数排序，优先处理热门商家
- 每个商家处理完成后延迟5秒
- 自动重试和错误处理
- 实时显示进度

---

## 📊 采集策略

### 视频优先级

脚本会优先采集**互动评分高**的视频：

```typescript
互动评分 = 点赞数 × 1 + 评论数 × 2 + 收藏数 × 3 + 分享数 × 4
```

### 采集数量

- **默认**: 每次处理50个视频
- **评论**: 每个视频100条（可调整）
- **批量**: 一次性处理所有商家

### 成本预估

基于TikHub API定价：

| 项目 | 单价 | 数量 | 总计 |
|------|------|------|------|
| 获取播放量 (批量) | $0.01/10视频 | 445视频 | ~$0.45 |
| 获取评论 | $0.001/次 | 445×5页 | ~$2.23 |
| **总计** | - | - | **~$2.70** |

---

## ⚠️ 刷量检测规则

系统会自动标记以下可疑行为：

### 检测规则

1. **互动失衡**
   - 点赞率>10% 但评论率<0.3%
   - 典型特征：只刷点赞，不刷评论

2. **极高点赞率**
   - 点赞率>15%
   - 自然流量极少超过10%

3. **分享率异常**
   - 点赞率>8% 但分享率<0.5%
   - 真实爆款视频分享率通常>0.3%

4. **评论质量差**
   - 空洞评论（"666"、"赞"）占比>60%
   - 典型刷量评论特征

5. **互动集中**
   - 前10%评论占评论总点赞数>80%
   - 可能是水军互相点赞

6. **时间异常**
   - 50+评论集中在1小时内
   - 自然评论通常分散在数天

### 置信度分级

| 置信度 | 判定 | 说明 |
|--------|------|------|
| 0-29% | 真实 | 数据正常 |
| 30-59% | 可疑 | 存在刷量嫌疑 |
| 60-100% | 高风险 | 强烈刷量特征 |

### 标记示例

```
✅ 真实视频:
  - 播放量: 10,000
  - 点赞率: 4.2%
  - 评论率: 0.6%
  - 质量评分: 75/100

⚠️ 疑似刷量:
  - 播放量: 5,000
  - 点赞率: 12.5%
  - 评论率: 0.1%
  - 置信度: 65%
  - 原因: 点赞率过高(12.50%)但评论率很低(0.100%)
```

---

## 📈 数据质量评分

系统会为每个视频计算0-100的质量评分：

### 评分维度

1. **点赞率** (权重: 20分)
   - 3-5%: +20分 (最优)
   - 2-7%: +10分
   - >10%: -20分 (可疑)

2. **评论率** (权重: 15分)
   - 0.5-1%: +15分
   - 0.3-2%: +10分

3. **分享率** (权重: 15分)
   - 0.3-0.8%: +15分
   - 0.1-1.5%: +8分

4. **评论质量** (权重: 10分)
   - 空洞率<20%: +10分
   - 空洞率>60%: -15分

### 评分解读

| 分数 | 等级 | 建议 |
|------|------|------|
| 80-100 | 优秀 | 可作为爆款案例 |
| 60-79 | 良好 | 值得分析学习 |
| 40-59 | 一般 | 可参考但需谨慎 |
| 0-39 | 较差 | 不建议作为参考 |

---

## 🔍 数据验证

### 查看采集结果

```bash
# 检查商家数据
npx tsx scripts/check-merchant-data.ts

# 查询疑似刷量的视频
```

使用Prisma Studio可视化：

```bash
pnpm db:studio
```

### SQL查询示例

```sql
-- 查看所有疑似刷量的视频
SELECT title, playCount, likeRate, suspiciousReason
FROM merchant_contents
WHERE isSuspicious = 1;

-- 查看评论最多的视频
SELECT c.title, COUNT(cm.id) as commentCount
FROM merchant_contents c
LEFT JOIN merchant_content_comments cm ON cm.contentId = c.id
GROUP BY c.id
ORDER BY commentCount DESC
LIMIT 10;

-- 查看平均互动率
SELECT
  AVG(likeRate) as avgLikeRate,
  AVG(commentRate) as avgCommentRate,
  COUNT(*) as totalVideos
FROM merchant_contents
WHERE playCount > 0;
```

---

## 🛠️ 故障排除

### 问题1: Prisma Client生成失败

**错误信息**: `EPERM: operation not permitted`

**解决方案**:
```bash
# 1. 关闭开发服务器 (Ctrl+C)
# 2. 关闭所有Node进程（如果仍有问题）
taskkill /f /im node.exe
# 3. 重新生成
pnpm db:generate
# 4. 重启开发服务器
pnpm dev
```

### 问题2: TikHub API限流

**错误信息**: `Rate limit exceeded`

**解决方案**:
- 脚本已内置延迟（视频间2秒，评论分页间0.5秒）
- 如仍超限，手动增加 `scripts/enhance-merchant-videos.ts` 中的延迟时间

### 问题3: 部分视频无法获取统计

**可能原因**:
- 视频已删除
- 视频设置为私密
- API权限不足

**处理**: 脚本会自动跳过失败的视频，继续处理下一个

### 问题4: 评论数量少于预期

**可能原因**:
- 视频实际评论数<100
- 抖音限制了评论接口返回数量

**处理**: 这是正常情况，脚本会采集所有可获取的评论

---

## 📝 下一步计划

### 1. 档案生成优化

数据采集完成后，需要更新档案生成算法以使用新数据：

- [ ] 修改 `lib/ai/profile-generator.ts`
- [ ] 集成播放量和真实互动率
- [ ] 包含用户评论洞察
- [ ] 排除疑似刷量内容

### 2. 前端展示优化

- [ ] 显示数据质量徽章
- [ ] 标记疑似刷量内容
- [ ] 展示真实互动率
- [ ] 用户评论情感分布图

### 3. 定期更新机制

- [ ] 创建定时任务脚本
- [ ] 增量更新已采集的视频
- [ ] 监控数据质量变化

---

## 📞 联系与支持

遇到问题？

1. 检查环境变量配置 (`.env.local`)
2. 查看TikHub账户余额和限额
3. 查看脚本输出的错误日志
4. 检查数据库连接状态

---

## 📄 文件清单

本次优化涉及的文件：

### 数据库
- ✅ `prisma/schema.prisma` - 数据库模型扩展

### 工具库
- ✅ `lib/utils/fraud-detection.ts` - 刷量检测算法
- 📝 `lib/ai/profile-generator.ts` - 档案生成器（待优化）

### 脚本
- ✅ `scripts/enhance-merchant-videos.ts` - 单商家数据增强
- ✅ `scripts/batch-enhance-all.ts` - 批量处理所有商家

### 文档
- ✅ `docs/商家数据采集指南.md` - 本文档

---

## ⏱️ 预计执行时间

| 任务 | 时间 | 说明 |
|------|------|------|
| Schema迁移 | 已完成 | ✅ |
| 脚本开发 | 已完成 | ✅ |
| 数据采集 (6商家×75视频) | 30-45分钟 | 包含API延迟 |
| 档案重新生成 | 5-10分钟 | 待实施 |

---

## 💡 最佳实践

1. **首次采集**
   - 先测试单个商家：`npx tsx scripts/enhance-merchant-videos.ts [商家ID]`
   - 确认无误后批量处理：`npx tsx scripts/batch-enhance-all.ts`

2. **成本控制**
   - 每次采集前检查TikHub余额
   - 对新增商家使用增量采集

3. **数据质量**
   - 定期检查疑似刷量标记的准确性
   - 根据实际情况调整检测规则阈值

4. **性能优化**
   - 优先采集互动高的视频
   - 评论采集可调整为50条（如预算有限）

---

🎉 **数据采集系统已就绪，随时可以开始使用！**
