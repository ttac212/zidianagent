先摸清 /merchants → 查看详情 → 商家详情页的全链路（前端组件、Hook、API、数据模型），为后续大改做准备。以
  下是梳理结果，直接按关键路径说。

  【链路总览】

  - 列表页 app/merchants/page.tsx（client）：用 useMerchantsQuery 拉 /api/merchants（分页/搜索/分类/状态/排序），
    useMerchantStatsQuery 拉 /api/merchants/stats，useMerchantCategoriesQuery 拉 /api/merchants/categories。Admin 专属：    SSE 同步按钮（useMerchantSyncStream → /api/merchants/sync-stream）+ 新增商家弹窗 AddMerchantDialog（解析抖音分享 /
    api/douyin/parse-share，再 /api/tikhub/sync 入库）。同步进度弹窗 MerchantSyncProgressDialog。
  - 详情页 app/merchants/[id]/page.tsx（client，约千行，逻辑很重）：
      - 商家基础：useMerchantDetailQuery → /api/merchants/[id]?includeContents=false。编辑弹窗 EditMerchantDialog →
        PATCH /api/merchants/[id]。自动同步开关 MonitoringConfig → 同一个 PATCH（监控开关/周期）。
      - 内容列表：useMerchantContentsQuery → /api/merchants/[id]/contents（搜索/类型/时间/是否转录/最小互动量/排序/分
        页，部分字段客户端二次排序过滤 engagement）。Admin 可多选→批量转录 BatchTranscribeDialog（/api/merchants/[id]/
        contents/batch-transcribe/stream），单条同步 POST /api/merchants/[id]/contents/[contentId]/sync。
      - AI 档案卡 MerchantProfileCard：useMerchantProfile → /api/merchants/[id]/profile，生成 POST /api/merchants/[id]/
        profile/generate，编辑 PATCH /api/merchants/[id]/profile。
      - “一键对齐工作台”跳转：先 GET /api/merchants/[id]/briefing，拼提示写入 sessionStorage，再跳 /workspace?
        prefill=...。
      - 导出：/api/merchants/[id]/export?type=content|analytics|tags&format=csv。
      - 分析入口：数据分析按钮跳 /merchants/[id]/analytics；标签分析按钮打开 TagAnalysisModal（/api/merchants/[id]/
        tags）；对标弹窗 BenchmarkDialog 相关 /api/merchants/[id]/benchmarks。
  - 分析页 app/merchants/[id]/analytics/page.tsx（client）：手动 fetch /api/merchants/[id]/analytics。展示总互动/趋势、
    均值、内容数量、转录占比、Top 内容、标签排行、时间线（目前无可视化图表，仅卡片+列表）。
  - 其他入口：app/merchants/[id]/audience/document/page.tsx → AudienceDocumentEditor（走 /api/merchants/[id]/analyze-
    audience* 等），不在主列表流但同属商家中心。

  【API 侧关键点】

  - 列表 /api/merchants：默认只出 ACTIVE，status=ALL 才全量；排序支持 name/createdAt/totalContentCount/totalEngagement。  - 详情 /api/merchants/[id]：includeContents 默认 true（但前端传 false），contentLimit 最多 50。
  - 内容列表 /api/merchants/[id]/contents：engagement 排序在客户端重排；minEngagement 也在客户端过滤；取多 3 倍数据再截
    断，避免分页错位。
  - 同步：批量 POST /api/merchants/sync（阻塞，限 20 个），SSE /api/merchants/sync-stream（取前 100 个，2s 间隔），单条
    内容同步 /api/merchants/[id]/contents/[contentId]/sync。
  - 统计 /api/merchants/stats，分类 /api/merchants/categories，分析 /api/merchants/[id]/analytics，标签 /api/merchants/
    [id]/tags。全部走 withMerchantAuth/withMerchantAdminAuth，依赖 next-auth JWT。

  【数据模型要点（prisma/schema.prisma）】

  - Merchant：计数/互动汇总、监控开关+周期+nextSyncAt，status 默认 ACTIVE。
  - MerchantContent：互动计数、totalEngagement 可能为 0 需前端兜底，tags/textExtra 是字符串 JSON。
  - 关联：Profile（档案）、AudienceAnalysis（粉丝画像）、Benchmarks（对标）、Monitoring 配置均在 Merchant 上。

  【坏味道 / 风险】

  - 详情页组件超长，状态多，重复工具函数（formatNumber/formatDuration），容易继续膨胀，selectMode/导出/对齐/同步交织，测    试难覆盖。
  - 导出 handleExport catch 分支空实现，错误无反馈；analytics/contents fetch 失败仅 console.error，用户只看到空白。
  - includeContents API 默认 true，但前端全部传 false；调用方若遗漏参数会带回内容列表，带来隐式性能差异。
  - 内容列表 engagement 排序/过滤在前端做，分页总数来自 DB，可能出现“页码有但这一页被滤空”的体验不一致。
  - SSE 同步没有前端超时/重连策略，后端逐个 2s 延迟，100 家商户可能卡一长段时间；取消逻辑靠 Abort，前端未限制重复点击。
  - React Query keys 使用对象 filters，未做稳定序列化；不同引用会触发不必要的请求（虽有 keepPreviousData 但缓存粒度
    过细）。
  - 中文文案/注释部分出现乱码（源文件编码问题），后续改动需统一 UTF-8 否则继续扩散。

  【后续改动建议（Linus式）】

  1. 先拆详情页：把“基础信息卡”“内容列表块”“AI 档案”“导出/分析/对标侧栏”分组件，每块清晰接口，减少状态交叉。
  2. 统一数据获取：把列表/详情/内容/分析的 fetch 包成独立 service + 错误处理策略（toast + fallback），避免空白静默失败。  3. 分页与排序逻辑前后端一致：engagement 排序/过滤放回 API，返回的数据即最终展示，减少前端二次处理导致的页码错位。
  4. 导出/同步兜底：补错误提示，给 SSE 同步加前端超时/disable 重复启动，后端支持并发上限/批大小配置。
  5. 文档化接口契约：特别是 includeContents 默认行为、limit 上限、监控开关字段，确保大改不破现有调用。
  6. 公用工具抽离：formatNumber 等放到 lib/utils，避免重复和编码问题。