# å•†å®¶æ¡£æ¡ˆç”Ÿæˆ - å®Œæ•´æŠ€æœ¯é“¾è·¯æ–‡æ¡£

## ğŸ“… æ–‡æ¡£ç‰ˆæœ¬
- **åˆ›å»ºæ—¶é—´**: 2025-01-11
- **æœ€åæ›´æ–°**: 2025-01-11
- **ç³»ç»Ÿç‰ˆæœ¬**: ç®€åŒ–ç‰ˆï¼ˆä»…ä¿ç•™Briefï¼‰
- **æŠ€æœ¯æ ˆ**: Next.js 15 + Prisma + Claude Sonnet 4.5

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å•†å®¶æ¡£æ¡ˆç”Ÿæˆç³»ç»Ÿæ˜¯ä¸€ä¸ªAIé©±åŠ¨çš„å†…å®¹åˆ†æå·¥å…·ï¼Œé€šè¿‡åˆ†æå•†å®¶çš„TOP10çˆ†æ¬¾å†…å®¹ï¼Œç”Ÿæˆç®€æ´çš„å•†å®¶Briefï¼ˆåˆ›ä½œç®€æŠ¥ï¼‰ï¼Œå¸®åŠ©åˆ›ä½œè€…å¿«é€Ÿäº†è§£å•†å®¶æ ¸å¿ƒä¿¡æ¯ã€‚

**æ ¸å¿ƒè¾“å‡º**ï¼šå•†å®¶Briefï¼ˆ5ä¸ªç»´åº¦ï¼‰
- å•†å®¶ä»‹ç»ï¼ˆ3å¥è¯ï¼‰
- æ ¸å¿ƒå–ç‚¹ï¼ˆ3-5ä¸ªï¼‰
- ä½¿ç”¨åœºæ™¯ï¼ˆç»“åˆç—›ç‚¹ï¼‰
- ç›®æ ‡ç”¨æˆ·ç”»åƒ
- å“ç‰Œè°ƒæ€§

---

## ğŸ”„ å®Œæ•´ç”Ÿæˆé“¾è·¯

### é˜¶æ®µ1ï¼šå‰ç«¯è§¦å‘ï¼ˆç”¨æˆ·æ“ä½œï¼‰

**å…¥å£ç»„ä»¶**: `components/merchants/merchant-profile-card.tsx`

```typescript
// ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆæ¡£æ¡ˆ"æŒ‰é’®
const handleGenerate = async () => {
  // 1. å‰ç½®æ£€æŸ¥
  if (totalContentCount === 0) {
    toast.error('å•†å®¶æš‚æ— å†…å®¹,æ— æ³•ç”Ÿæˆæ¡£æ¡ˆ')
    return
  }

  // 2. æ˜¾ç¤ºåŠ è½½æç¤º
  toast.loading('æ­£åœ¨ç”Ÿæˆæ¡£æ¡ˆ,é¢„è®¡30-60ç§’...', { id: 'generate-profile' })

  try {
    // 3. è°ƒç”¨React Query Mutation
    await generateMutation.mutateAsync()

    // 4. æˆåŠŸååˆ·æ–°æ•°æ®
    toast.success('æ¡£æ¡ˆç”ŸæˆæˆåŠŸï¼', { id: 'generate-profile' })
  } catch (error) {
    toast.error('æ¡£æ¡ˆç”Ÿæˆå¤±è´¥', { id: 'generate-profile' })
  }
}
```

**React Query Hook**: `hooks/api/use-merchant-profile.ts`

```typescript
export function useGenerateProfile(merchantId: string) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async () => {
      const response = await fetch(
        `/api/merchants/${merchantId}/profile/generate`,
        { method: 'POST' }
      )
      if (!response.ok) throw new Error('ç”Ÿæˆå¤±è´¥')
      return response.json()
    },
    onSuccess: () => {
      // åˆ·æ–°æ¡£æ¡ˆæ•°æ®
      queryClient.invalidateQueries({
        queryKey: ['merchant-profile', merchantId]
      })
    }
  })
}
```

---

### é˜¶æ®µ2ï¼šAPIè·¯ç”±å¤„ç†ï¼ˆæœåŠ¡ç«¯ï¼‰

**APIè·¯ç”±**: `app/api/merchants/[id]/profile/generate/route.ts`

```typescript
export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const merchantId = params.id

    // 1. æƒé™éªŒè¯ï¼ˆå¯é€‰ï¼‰
    const session = await getServerSession(authOptions)
    if (!session?.user) {
      return NextResponse.json({ error: 'æœªæˆæƒ' }, { status: 401 })
    }

    // 2. è°ƒç”¨æ¡£æ¡ˆç”Ÿæˆæ ¸å¿ƒé€»è¾‘
    const result = await generateMerchantProfile(merchantId)

    // 3. è¿”å›ç”Ÿæˆç»“æœ
    return NextResponse.json({
      profile: result.profile,
      tokensUsed: result.tokensUsed,
      model: result.model
    })

  } catch (error) {
    console.error('[Generate Profile API] é”™è¯¯:', error)
    return NextResponse.json(
      { error: error.message || 'ç”Ÿæˆå¤±è´¥' },
      { status: 500 }
    )
  }
}
```

---

### é˜¶æ®µ3ï¼šæ ¸å¿ƒç”Ÿæˆé€»è¾‘

**æ ¸å¿ƒæ–‡ä»¶**: `lib/ai/profile-generator.ts`

#### 3.1 ä¸»å‡½æ•°æµç¨‹

```typescript
export async function generateMerchantProfile(merchantId: string) {
  // STEP 1: è·å–å•†å®¶å’ŒTOP10å†…å®¹
  const merchant = await fetchMerchantWithContents(merchantId)

  if (!merchant) {
    throw new Error('å•†å®¶ä¸å­˜åœ¨')
  }

  if (merchant.totalContentCount === 0) {
    throw new Error('å•†å®¶æš‚æ— å†…å®¹,æ— æ³•ç”Ÿæˆæ¡£æ¡ˆ')
  }

  // STEP 2: AIåˆ†æTOP10å†…å®¹è´¨é‡ï¼ˆæ‰¹é‡å¹¶å‘ï¼‰
  console.info('[ProfileGenerator] å¼€å§‹AIå†…å®¹è´¨é‡åˆ†æ...')
  const contentsWithAnalysis = await analyzeContentsQuality(merchant.contents || [])
  console.info('[ProfileGenerator] AIåˆ†æå®Œæˆ')

  // STEP 3: æ„å»ºPromptï¼ˆåŒ…å«AIåˆ†æç»“æœï¼‰
  const userPrompt = buildUserPrompt(merchant, contentsWithAnalysis)

  // STEP 4: è°ƒç”¨LLM APIç”Ÿæˆæ¡£æ¡ˆ
  const aiResponse = await callLLMAPI(userPrompt)

  // STEP 5: è§£æå“åº”
  const parsed = parseProfileResponse(aiResponse.content)

  // STEP 6: ä¿å­˜åˆ°æ•°æ®åº“
  const profile = await prisma.merchantProfile.upsert({
    where: { merchantId },
    create: {
      merchantId,
      ...parsed,
      aiGeneratedAt: new Date(),
      aiModelUsed: MODEL_ID,
      aiTokenUsed: aiResponse.usage.total_tokens
    },
    update: {
      ...parsed,
      aiGeneratedAt: new Date(),
      aiModelUsed: MODEL_ID,
      aiTokenUsed: aiResponse.usage.total_tokens
      // æ³¨æ„: ä¸æ›´æ–° custom* å­—æ®µ,ä¿æŒç”¨æˆ·ç¼–è¾‘å†…å®¹
    }
  })

  return {
    profile,
    tokensUsed: aiResponse.usage.total_tokens,
    model: MODEL_ID
  }
}
```

#### 3.2 æ•°æ®è·å–ï¼ˆSTEP 1ï¼‰

```typescript
async function fetchMerchantWithContents(merchantId: string) {
  const merchant = await prisma.merchant.findUnique({
    where: { id: merchantId },
    include: {
      category: true,
      contents: {
        // æŒ‰äº’åŠ¨è¯„åˆ†æ’åº: ç‚¹èµ + è¯„è®º*2 + æ”¶è—*3 + åˆ†äº«*4
        orderBy: [
          { diggCount: 'desc' },
          { commentCount: 'desc' },
          { collectCount: 'desc' }
        ],
        take: 10  // åªå–TOP10
      }
    }
  })

  return merchant
}
```

#### 3.3 AIå†…å®¹è´¨é‡åˆ†æï¼ˆSTEP 2ï¼‰

**è°ƒç”¨é“¾**: `profile-generator.ts` â†’ `lib/ai/content-analyzer.ts`

```typescript
// åœ¨ profile-generator.ts ä¸­
async function analyzeContentsQuality(contents: any[]) {
  if (contents.length === 0) return []

  // å‡†å¤‡åˆ†ææ•°æ®
  const analysisInput = contents.map(c => ({
    id: c.id,
    title: c.title,
    transcript: c.transcript
  }))

  // æ‰¹é‡è°ƒç”¨AIåˆ†æï¼ˆå¹¶å‘æ§åˆ¶=3ï¼‰
  const analysisResults = await analyzeContentQualityBatch(analysisInput, 3)

  // åˆå¹¶åˆ†æç»“æœ
  return contents.map(c => ({
    ...c,
    aiAnalysis: analysisResults.get(c.id) || null
  }))
}
```

**AIåˆ†æè¯¦æƒ…**: è§ä¸‹æ–¹"å­ç³»ç»Ÿï¼šAIå†…å®¹è´¨é‡åˆ†æ"

#### 3.4 æ„å»ºPromptï¼ˆSTEP 3ï¼‰

```typescript
function buildUserPrompt(merchant: any, contentsWithAnalysis: any[]): string {
  const top10Contents = contentsWithAnalysis || []

  // æ„å»ºTOP10å†…å®¹è¯¦ç»†ä¿¡æ¯
  const contentsDetail = top10Contents.map((c: any, idx: number) => {
    // è§£ætags
    let tags: string[] = []
    try {
      const parsedTags = JSON.parse(c.tags || '[]')
      tags = Array.isArray(parsedTags)
        ? parsedTags.map((t: any) => t.tag_name || t).filter(Boolean)
        : []
    } catch {
      // å¿½ç•¥è§£æé”™è¯¯
    }

    // è·å–å‰3ç§’æ–‡æ¡ˆ
    const opening = c.transcript ? c.transcript.substring(0, 100) : '(æ— è½¬å½•)'

    // âœ… è®¡ç®—äº’åŠ¨ç‡
    const metrics = calculateContentMetrics({
      playCount: c.playCount || 0,
      diggCount: c.diggCount,
      commentCount: c.commentCount,
      shareCount: c.shareCount,
      collectCount: c.collectCount
    })

    const likeRate = metrics.likeRate !== null ? metrics.likeRate.toFixed(2) : 'N/A'
    const commentRate = metrics.commentRate !== null ? metrics.commentRate.toFixed(3) : 'N/A'
    const shareRate = metrics.shareRate !== null ? metrics.shareRate.toFixed(3) : 'N/A'

    // âœ… è´¨é‡ç­‰çº§åˆ¤æ–­
    const qualityLevel = getQualityLevel(metrics)

    // âœ… åˆ·é‡æ£€æµ‹
    let fraudWarning = ''
    if (c.playCount > 0) {
      const fraudResult = detectFraud(
        {
          playCount: c.playCount,
          diggCount: c.diggCount,
          commentCount: c.commentCount,
          shareCount: c.shareCount,
          collectCount: c.collectCount
        },
        []
      )

      if (fraudResult.isSuspicious) {
        fraudWarning = `\n- âš ï¸ åˆ·é‡è­¦å‘Š: ${fraudResult.reason}`
      }
    }

    // âœ… AIè´¨é‡åˆ†æç»“æœ
    let aiAnalysisText = ''
    if (c.aiAnalysis) {
      const analysis = c.aiAnalysis
      aiAnalysisText = `
- AIè´¨é‡åˆ†æ:
  * å¼€å¤´è´¨é‡: ${analysis.openingQuality.score}/10 (${analysis.openingQuality.level === 'high' ? 'é«˜' : analysis.openingQuality.level === 'medium' ? 'ä¸­' : 'ä½'}) - ${analysis.openingQuality.reason}
  * æƒ…ç»ªç‚¹: ${translateEmotionType(analysis.emotionalTrigger.primary)} (å¼ºåº¦${analysis.emotionalTrigger.intensity}/10) - ${analysis.emotionalTrigger.description}
  * ç—›ç‚¹: ${analysis.painPoints.length > 0 ? analysis.painPoints.join('ã€') : 'æ— '}
  * ç”¨æˆ·éœ€æ±‚: ${analysis.userNeeds.length > 0 ? analysis.userNeeds.join('ã€') : 'æ— '}
  * å†…å®¹èŠ‚å¥: ${translatePace(analysis.contentRhythm.pace)}ï¼ŒèŠ‚å¥å˜åŒ–${translateVariety(analysis.contentRhythm.variety)}
  * ç»¼åˆè¯„åˆ†: ${analysis.overallQuality.score}/100
  * ä¼˜ç‚¹: ${analysis.overallQuality.strengths.join('ã€')}
  ${analysis.overallQuality.weaknesses.length > 0 ? `* ç¼ºç‚¹: ${analysis.overallQuality.weaknesses.join('ã€')}` : ''}`
    }

    return `[ç¬¬${idx + 1}å]
- æ ‡é¢˜: ${c.title}
- å‰3ç§’æ–‡æ¡ˆ: ${opening}
- æ’­æ”¾é‡: ${(c.playCount || 0).toLocaleString()}
- äº’åŠ¨ç‡: èµ${likeRate}% | è¯„${commentRate}% | è½¬${shareRate}%
- è´¨é‡è¯„ä¼°: ${qualityLevel.label} (${qualityLevel.description})${fraudWarning}${aiAnalysisText}
- æ ‡ç­¾: ${tags.join(', ') || 'æ— '}
- æ—¶é•¿: ${c.duration || 'æœªçŸ¥'}
- å‘å¸ƒæ—¶é—´: ${c.publishedAt ? new Date(c.publishedAt).toLocaleDateString() : 'æœªçŸ¥'}
- å†…å®¹ç±»å‹: ${c.contentType}
`
  }).join('\n')

  return `è¯·ä¸ºä»¥ä¸‹å•†å®¶ç”Ÿæˆåˆ›ä½œç®€æŠ¥(Brief)ï¼š

**å•†å®¶åŸºæœ¬ä¿¡æ¯**
- åç§°ï¼š${merchant.name}
- ä¸šåŠ¡ç±»å‹ï¼š${merchant.businessType}
- åœ°åŒºï¼š${merchant.location || 'æœªçŸ¥'}
- åˆ†ç±»ï¼š${merchant.category?.name || 'æœªåˆ†ç±»'}
- æ€»å†…å®¹æ•°ï¼š${merchant.totalContentCount}
- æ€»ç‚¹èµï¼š${merchant.totalDiggCount.toLocaleString()}
- æ€»è¯„è®ºï¼š${merchant.totalCommentCount.toLocaleString()}
- æ€»åˆ†äº«ï¼š${merchant.totalShareCount.toLocaleString()}

**TOP10çˆ†æ¬¾å†…å®¹ï¼ˆå«AIè´¨é‡åˆ†æï¼‰**
${contentsDetail}

è¯·æŒ‰ä»¥ä¸‹ç»“æ„åˆ†æï¼š

## æ•°æ®åˆ†ææ³¨æ„äº‹é¡¹
1. ä¼˜å…ˆå‚è€ƒ"è´¨é‡è¯„ä¼°: âœ… é«˜è´¨é‡"ä¸”"AIç»¼åˆè¯„åˆ†"é«˜çš„å†…å®¹
2. å¯¹äºæ ‡æ³¨"âš ï¸ åˆ·é‡è­¦å‘Š"çš„å†…å®¹ï¼Œåœ¨åˆ†æä¸­è¯´æ˜åŸå› ä½†ä¸å¿…å®Œå…¨æ’é™¤
3. åˆ©ç”¨AIåˆ†æçš„"ç—›ç‚¹"å’Œ"ç”¨æˆ·éœ€æ±‚"æ¥å®Œå–„ä½¿ç”¨åœºæ™¯

## å•†å®¶Briefï¼ˆåˆ›ä½œç®€æŠ¥ï¼‰
- intro: 3å¥è¯ä»‹ç»(å­—ç¬¦ä¸²æ ¼å¼,ç”¨ç©ºæ ¼è¿æ¥ã€‚ç¬¬1å¥:æ˜¯è°;ç¬¬2å¥:åšä»€ä¹ˆ;ç¬¬3å¥:ç‰¹ç‚¹)
- sellingPoints: æ ¸å¿ƒå–ç‚¹(å­—ç¬¦ä¸²æ•°ç»„,3-5ä¸ª)
- usageScenarios: ä½¿ç”¨åœºæ™¯+è§£å†³çš„ç—›ç‚¹(å­—ç¬¦ä¸²æ•°ç»„,ç»“åˆAIåˆ†æçš„ç—›ç‚¹)
- audienceProfile: ç›®æ ‡ç”¨æˆ·ç”»åƒ(å¯¹è±¡:{age,gender,interests[],behaviors})
- brandTone: å“ç‰Œè°ƒæ€§(å­—ç¬¦ä¸²)

è¾“å‡ºJSONæ ¼å¼(ä¸¥æ ¼éµå¾ªç»“æ„)ï¼š
{
  "brief": {
    "intro": "...",
    "sellingPoints": [...],
    "usageScenarios": [...],
    "audienceProfile": {...},
    "brandTone": "..."
  }
}

æ³¨æ„ï¼š
1. æ•°æ®ä¸è¶³æ—¶å¡«nullæˆ–ç©ºæ•°ç»„
2. åªè¾“å‡ºJSONï¼Œä¸è¦å…¶ä»–æ–‡å­—`
}
```

**Promptç‰¹ç‚¹**ï¼š
1. åŒ…å«å•†å®¶åŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€ä¸šåŠ¡ç±»å‹ã€ç»Ÿè®¡æ•°æ®ï¼‰
2. åŒ…å«TOP10å†…å®¹è¯¦ç»†åˆ†æï¼ˆäº’åŠ¨ç‡ã€AIè´¨é‡åˆ†æã€åˆ·é‡æ£€æµ‹ï¼‰
3. æä¾›æ˜ç¡®çš„æ•°æ®ç†è§£è§„åˆ™
4. è¦æ±‚ä¸¥æ ¼çš„JSONè¾“å‡ºæ ¼å¼

#### 3.5 è°ƒç”¨LLM APIï¼ˆSTEP 4ï¼‰

**APIé…ç½®**ï¼š
- æ¨¡å‹ï¼š`anthropic/claude-sonnet-4.5`
- APIæä¾›å•†ï¼šZenMux AI
- Temperature: 0.7
- Max Tokens: 30000

```typescript
async function callLLMAPI(userPrompt: string) {
  if (!API_KEY) {
    throw new Error('æœªé…ç½®ZENMUX_API_KEY')
  }

  const response = await fetch(`${API_BASE}/chat/completions`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: MODEL_ID,
      messages: [
        { role: 'system', content: SYSTEM_PROMPT },
        { role: 'user', content: userPrompt }
      ],
      max_tokens: 30000,
      temperature: 0.7,
      // ä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºç¡®ä¿è¿”å›æ ¼å¼ä¸¥æ ¼ç¬¦åˆschema
      response_format: {
        type: 'json_schema',
        json_schema: {
          name: 'merchant_profile',
          description: 'å•†å®¶åˆ›ä½œæ¡£æ¡ˆæ•°æ®ç»“æ„',
          schema: {
            type: 'object',
            properties: {
              brief: {
                type: 'object',
                properties: {
                  intro: {
                    type: 'string',
                    description: '3å¥è¯å•†å®¶ä»‹ç»(åˆå¹¶ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²)'
                  },
                  sellingPoints: {
                    type: 'array',
                    items: { type: 'string' },
                    description: 'æ ¸å¿ƒå–ç‚¹åˆ—è¡¨'
                  },
                  usageScenarios: {
                    type: 'array',
                    items: { type: 'string' },
                    description: 'ä½¿ç”¨åœºæ™¯åˆ—è¡¨'
                  },
                  audienceProfile: {
                    type: 'object',
                    properties: {
                      age: { type: 'string' },
                      gender: { type: 'string' },
                      interests: {
                        type: 'array',
                        items: { type: 'string' }
                      },
                      behaviors: { type: 'string' }
                    },
                    required: ['age', 'gender', 'interests', 'behaviors']
                  },
                  brandTone: { type: 'string' }
                },
                required: ['intro', 'sellingPoints', 'usageScenarios', 'audienceProfile', 'brandTone']
              }
            },
            required: ['brief'],
            additionalProperties: false
          }
        }
      }
    })
  })

  if (!response.ok) {
    const errorText = await response.text()
    console.error('[ProfileGenerator] APIé”™è¯¯:', response.status, errorText)
    throw new Error(`LLM APIè°ƒç”¨å¤±è´¥: ${response.status}`)
  }

  const data = await response.json()

  if (!data.choices || data.choices.length === 0) {
    throw new Error('LLM APIè¿”å›æ ¼å¼é”™è¯¯')
  }

  return {
    content: data.choices[0].message.content,
    usage: data.usage || { total_tokens: 0, prompt_tokens: 0, completion_tokens: 0 }
  }
}
```

**System Prompt**ï¼š

```typescript
const SYSTEM_PROMPT = `ä½ æ˜¯æŠ–éŸ³çŸ­è§†é¢‘æ–‡æ¡ˆåˆ›ä½œä¸“å®¶ã€‚
ä»»åŠ¡ï¼šä¸ºåˆ›ä½œè€…ç”Ÿæˆå•†å®¶åˆ›ä½œç®€æŠ¥(Brief)ï¼Œè®©ä»–ä»¬å¿«é€Ÿäº†è§£å•†å®¶å¹¶åˆ›ä½œçˆ†æ¬¾è„šæœ¬ã€‚

ã€æ•°æ®ç†è§£è§„åˆ™ã€‘
1. äº’åŠ¨ç‡è´¨é‡åˆ¤æ–­ï¼š
   - è¯„è®ºç‡â‰¥0.5% + åˆ†äº«ç‡â‰¥0.3% â†’ çœŸå®é«˜è´¨é‡å†…å®¹ï¼Œé‡ç‚¹å‚è€ƒ
   - ç‚¹èµç‡>10% + è¯„è®ºç‡<0.3% â†’ ç–‘ä¼¼åˆ·é‡ï¼Œé™ä½æƒé‡
   - åˆ†äº«ç‡é«˜ â†’ ç”¨æˆ·è®¤ä¸ºå†…å®¹æœ‰ä»·å€¼ï¼Œå€¼å¾—ä¼ æ’­
   - æ ‡æ³¨"âš ï¸ ç–‘ä¼¼åˆ·é‡"çš„å†…å®¹ï¼šæ˜ç¡®æŒ‡å‡ºä½†ä¸å®Œå…¨æ’é™¤å‚è€ƒ

2. AIè´¨é‡åˆ†æç†è§£ï¼š
   - "å¼€å¤´è´¨é‡ï¼šé«˜"ï¼šæœ‰å¸å¼•åŠ›çš„å¼€å¤´ï¼Œä¼˜å…ˆä½œä¸ºé»„é‡‘3ç§’æ¨¡æ¿
   - "æƒ…ç»ªç‚¹"ï¼šåˆ¤æ–­å†…å®¹ä¸»æ‰“ä»€ä¹ˆæƒ…ç»ªï¼ˆç¬‘ç‚¹/ç—›ç‚¹/çˆ½ç‚¹/çŸ¥è¯†ç‚¹ï¼‰
   - "ç—›ç‚¹"å’Œ"éœ€æ±‚"ï¼šç†è§£ç”¨æˆ·çœŸæ­£çš„éœ€æ±‚
   - "ç»¼åˆè¯„åˆ†"ï¼šAIå¯¹å†…å®¹æ•´ä½“è´¨é‡çš„è¯„åˆ¤

3. çˆ†æ¬¾è¯†åˆ«ä¼˜å…ˆçº§ï¼š
   - ç¬¬ä¸€ä¼˜å…ˆï¼šAIè´¨é‡è¯„åˆ†é«˜ + è¯„è®ºç‡é«˜ + åˆ†äº«ç‡é«˜ + æ— åˆ·é‡å«Œç–‘
   - ç¬¬äºŒä¼˜å…ˆï¼šäº’åŠ¨ç‡å‡è¡¡ï¼ŒçœŸå®æ•°æ®
   - ç¬¬ä¸‰ä¼˜å…ˆï¼šå•ä¸€æŒ‡æ ‡çªå‡ºä½†å…¶ä»–æŒ‡æ ‡æ­£å¸¸

è¾“å‡ºè¦æ±‚ï¼š
1. åŸºäº**çœŸå®äº’åŠ¨ç‡**ï¼ˆè¯„è®ºç‡+åˆ†äº«ç‡ï¼‰å’Œ**AIè´¨é‡åˆ†æ**è¯†åˆ«çˆ†æ¬¾
2. å¦‚å‘ç°åˆ·é‡å†…å®¹ï¼Œåœ¨åˆ†æä¸­è¯´æ˜ä½†ä¸å¿…å®Œå…¨æ’é™¤
3. å¦‚æœæ•°æ®ä¸è¶³(å†…å®¹æ•°<5)ï¼Œæ˜ç¡®æŒ‡å‡ºå¹¶ç»™æœ‰é™å»ºè®®
4. å¿…é¡»ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¾“å‡ºï¼Œä¾¿äºç¨‹åºè§£æ
5. åªè¾“å‡ºJSONï¼Œä¸è¦é¢å¤–çš„è§£é‡Šæ–‡å­—`
```

#### 3.6 è§£æå“åº”ï¼ˆSTEP 5ï¼‰

**è§£æå™¨**: `lib/ai/profile-parser.ts`

```typescript
export function parseProfileResponse(aiResponse: string): ParseResult {
  try {
    // å°è¯•ä»å“åº”ä¸­æå–JSON
    const jsonText = extractJSON(aiResponse)

    if (!jsonText) {
      console.error('[Profile Parser] æ— æ³•æå–JSON:', aiResponse.substring(0, 200))
      return createEmptyResult()
    }

    // è§£æJSON
    const parsed: AIProfileResponse = JSON.parse(jsonText)

    // éªŒè¯ç»“æ„
    if (!validateStructure(parsed)) {
      console.error('[Profile Parser] JSONç»“æ„éªŒè¯å¤±è´¥')
      return createEmptyResult()
    }

    // è½¬æ¢ä¸ºæ•°æ®åº“å­˜å‚¨æ ¼å¼
    return convertToStorageFormat(parsed)

  } catch (error) {
    console.error('[Profile Parser] è§£æå¤±è´¥:', error)
    return createEmptyResult()
  }
}
```

**å…³é”®å‡½æ•°**ï¼š

1. **extractJSON**: ä»AIå“åº”ä¸­æå–JSONæ–‡æœ¬
   - å°è¯•ç›´æ¥è§£æ
   - å°è¯•æå– ````json ... ``` ä»£ç å—
   - å°è¯•æå–ç¬¬ä¸€ä¸ªå®Œæ•´çš„JSONå¯¹è±¡

2. **validateStructure**: éªŒè¯JSONç»“æ„
   - éªŒè¯brieféƒ¨åˆ†å­˜åœ¨
   - éªŒè¯Briefç»“æ„å®Œæ•´æ€§

3. **convertToStorageFormat**: è½¬æ¢ä¸ºæ•°æ®åº“æ ¼å¼
   ```typescript
   function convertToStorageFormat(data: AIProfileResponse): ParseResult {
     const { brief } = data
   
     return {
       briefIntro: brief.intro || null,
       briefSellingPoints: JSON.stringify(brief.sellingPoints || []),
       briefUsageScenarios: JSON.stringify(brief.usageScenarios || []),
       briefAudienceProfile: JSON.stringify(brief.audienceProfile || null),
       briefBrandTone: brief.brandTone || null
     }
   }
   ```

#### 3.7 ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆSTEP 6ï¼‰

**æ•°æ®åº“æ“ä½œ**ï¼šä½¿ç”¨Prisma `upsert`

```typescript
const profile = await prisma.merchantProfile.upsert({
  where: { merchantId },
  create: {
    merchantId,
    ...parsed,  // åŒ…å«: briefIntro, briefSellingPoints, briefUsageScenarios, briefAudienceProfile, briefBrandTone
    aiGeneratedAt: new Date(),
    aiModelUsed: MODEL_ID,
    aiTokenUsed: aiResponse.usage.total_tokens
  },
  update: {
    ...parsed,
    aiGeneratedAt: new Date(),
    aiModelUsed: MODEL_ID,
    aiTokenUsed: aiResponse.usage.total_tokens
    // æ³¨æ„: ä¸æ›´æ–° custom* å­—æ®µ,ä¿æŒç”¨æˆ·ç¼–è¾‘å†…å®¹
  }
})
```

**æ•°æ®åº“Schema** (`prisma/schema.prisma`):

```prisma
model MerchantProfile {
  id         String   @id @default(cuid())
  merchantId String   @unique
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  // === PART 1: å•†å®¶Briefï¼ˆåˆ›ä½œç®€æŠ¥ï¼‰ ===
  briefIntro           String? // å•†å®¶ä»‹ç»(3å¥è¯:æ˜¯è°ã€åšä»€ä¹ˆã€æœ‰ä»€ä¹ˆç‰¹ç‚¹)
  briefSellingPoints   String? // æ ¸å¿ƒå–ç‚¹(JSONæ•°ç»„:3-5ä¸ªäº§å“å–ç‚¹)
  briefUsageScenarios  String? // ä½¿ç”¨åœºæ™¯å’Œç—›ç‚¹(JSONæ•°ç»„)
  briefAudienceProfile String? // ç›®æ ‡ç”¨æˆ·ç”»åƒ(å¹´é¾„ã€æ€§åˆ«ã€å…´è¶£ã€æ¶ˆè´¹ä¹ æƒ¯)
  briefBrandTone       String? // å“ç‰Œè°ƒæ€§(æ­£ç»/æç¬‘/æ¸©æƒ…/ä¸“ä¸š + å…·ä½“æè¿°)

  // === å…ƒæ•°æ® ===
  aiGeneratedAt DateTime? // AIç”Ÿæˆæ—¶é—´
  aiModelUsed   String?   // ä½¿ç”¨çš„æ¨¡å‹ID
  aiTokenUsed   Int       @default(0) // æ¶ˆè€—çš„tokenæ•°

  // === ç”¨æˆ·ç¼–è¾‘éƒ¨åˆ†(æ°¸ä¹…ä¿ç•™) ===
  customBackground     String? // å•†å®¶èƒŒæ™¯æ•…äº‹(è€æ¿ã€åˆ›ä¸šå†ç¨‹ç­‰)
  customOfflineInfo    String? // çº¿ä¸‹ä¿¡æ¯(å®ä½“åº—ã€åœ°ç†ä¼˜åŠ¿ç­‰)
  customProductDetails String? // äº§å“è¯¦ç»†ä¿¡æ¯(AIä¸çŸ¥é“çš„ç»†èŠ‚)
  customDosAndDonts    String? // ç¦å¿Œæ¸…å•å’Œå¿…å¼ºè°ƒç‚¹(ç¦å¿Œè¯ã€å¿…é¡»æåŠçš„ç‚¹)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId])
  @@map("merchant_profiles")
}
```

---

### é˜¶æ®µ4ï¼šå‰ç«¯å±•ç¤º

**æ•°æ®è·å–**: `hooks/api/use-merchant-profile.ts`

```typescript
export function useMerchantProfile(merchantId: string) {
  return useQuery({
    queryKey: ['merchant-profile', merchantId],
    queryFn: async () => {
      const response = await fetch(`/api/merchants/${merchantId}/profile`)
      if (!response.ok) throw new Error('è·å–å¤±è´¥')
      return response.json() as Promise<MerchantProfileResponse>
    },
    staleTime: 5 * 60 * 1000,  // 5åˆ†é’Ÿç¼“å­˜
    enabled: !!merchantId
  })
}
```

**å±•ç¤ºç»„ä»¶**: `components/merchants/profile-ai-section.tsx`

```typescript
export function ProfileAISection({
  brief,
  aiGeneratedAt,
  aiModelUsed,
  aiTokenUsed
}: ProfileAISectionProps) {
  if (!brief) {
    return (
      <div className="text-sm text-muted-foreground">
        æš‚æ— AIåˆ†ææ•°æ®
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* å•†å®¶Brief */}
      <Card>
        <CardHeader>
          <CardTitle className="text-lg flex items-center gap-2">
            <Target className="h-5 w-5" />
            å•†å®¶Brief(åˆ›ä½œç®€æŠ¥)
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* å•†å®¶ä»‹ç» */}
          {brief.intro && (
            <div>
              <h4 className="font-medium text-sm mb-2">å•†å®¶ä»‹ç»</h4>
              <p className="text-sm text-muted-foreground whitespace-pre-wrap">
                {brief.intro}
              </p>
            </div>
          )}

          {/* æ ¸å¿ƒå–ç‚¹ */}
          {brief.sellingPoints && brief.sellingPoints.length > 0 && (
            <div>
              <h4 className="font-medium text-sm mb-2">æ ¸å¿ƒå–ç‚¹</h4>
              <ul className="list-disc list-inside space-y-1">
                {brief.sellingPoints.map((point, idx) => (
                  <li key={idx} className="text-sm text-muted-foreground">
                    {point}
                  </li>
                ))}
              </ul>
            </div>
          )}

          {/* ä½¿ç”¨åœºæ™¯ */}
          {/* ç›®æ ‡ç”¨æˆ·ç”»åƒ */}
          {/* å“ç‰Œè°ƒæ€§ */}
          {/* ... å…¶ä»–å­—æ®µå±•ç¤º */}
        </CardContent>
      </Card>

      {/* AIå…ƒæ•°æ® */}
      {aiGeneratedAt && (
        <div className="text-xs text-muted-foreground">
          ç”Ÿæˆäº: {dt.parse(aiGeneratedAt)?.toLocaleString('zh-CN') ?? 'æœªçŸ¥'}
          {aiModelUsed && ` | æ¨¡å‹: ${aiModelUsed}`}
          {aiTokenUsed && ` | Token: ${aiTokenUsed}`}
        </div>
      )}
    </div>
  )
}
```

---

## ğŸ”§ å­ç³»ç»Ÿï¼šAIå†…å®¹è´¨é‡åˆ†æ

**æ ¸å¿ƒæ–‡ä»¶**: `lib/ai/content-analyzer.ts`

### åŠŸèƒ½æ¦‚è¿°

åˆ†æå•æ¡å†…å®¹çš„è´¨é‡ï¼Œæå–ä»¥ä¸‹ç»´åº¦ï¼š
1. å¼€å¤´è´¨é‡ï¼ˆ0-10åˆ†ï¼‰
2. æƒ…ç»ªç‚¹ï¼ˆhumor/pain/satisfaction/knowledge/curiosityï¼‰
3. ç—›ç‚¹å’Œç”¨æˆ·éœ€æ±‚
4. å†…å®¹èŠ‚å¥ï¼ˆfast/medium/slowï¼‰
5. ç»¼åˆè¯„åˆ†ï¼ˆ0-100åˆ†ï¼‰

### æ•°æ®ç»“æ„

```typescript
export interface ContentQualityAnalysis {
  openingQuality: {
    score: number            // è¯„åˆ† 0-10
    level: 'high' | 'medium' | 'low'
    reason: string           // AIè¯„ä»·åŸå› 
    hasHook: boolean         // æ˜¯å¦æœ‰å¸å¼•åŠ›å¼€å¤´
  }
  emotionalTrigger: {
    primary: 'humor' | 'pain' | 'satisfaction' | 'knowledge' | 'curiosity' | 'other'
    intensity: number        // æƒ…ç»ªå¼ºåº¦ 0-10
    description: string      // æƒ…ç»ªç‚¹æè¿°
  }
  painPoints: string[]       // è¯†åˆ«åˆ°çš„ç”¨æˆ·ç—›ç‚¹
  userNeeds: string[]        // è¯†åˆ«åˆ°çš„ç”¨æˆ·éœ€æ±‚
  contentRhythm: {
    pace: 'fast' | 'medium' | 'slow'
    variety: 'high' | 'medium' | 'low'  // èŠ‚å¥å˜åŒ–
    description: string
  }
  overallQuality: {
    score: number            // ç»¼åˆè´¨é‡è¯„åˆ† 0-100
    strengths: string[]      // ä¼˜ç‚¹ï¼ˆæœ€å¤š3ä¸ªï¼‰
    weaknesses: string[]     // ç¼ºç‚¹ï¼ˆæœ€å¤š3ä¸ªï¼‰
  }
}
```

### å•æ¡åˆ†æ

```typescript
export async function analyzeContentQuality(content: {
  title: string
  transcript: string | null
}): Promise<ContentQualityAnalysis | null> {
  // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
  if (!content.transcript || content.transcript.length < 10) {
    console.warn('[ContentAnalyzer] è½¬å½•æ–‡æœ¬è¿‡çŸ­æˆ–ç¼ºå¤±ï¼Œè·³è¿‡åˆ†æ')
    return null
  }

  try {
    // æ„å»ºç”¨æˆ·Prompt
    const userPrompt = buildAnalysisPrompt(content)

    // è°ƒç”¨LLM API
    const response = await callLLMAPI(userPrompt)

    // è§£æå“åº”
    const analysis = parseAnalysisResponse(response.content)

    return analysis

  } catch (error) {
    console.error('[ContentAnalyzer] åˆ†æå¤±è´¥:', error)
    return null
  }
}
```

### æ‰¹é‡åˆ†æï¼ˆå¹¶å‘æ§åˆ¶ï¼‰

```typescript
export async function analyzeContentQualityBatch(
  contents: Array<{ id: string; title: string; transcript: string | null }>,
  concurrency = 3
): Promise<Map<string, ContentQualityAnalysis>> {
  const results = new Map<string, ContentQualityAnalysis>()

  // è¿‡æ»¤æ‰æ— æ•ˆæ•°æ®
  const validContents = contents.filter(c => c.transcript && c.transcript.length >= 10)

  console.info(`[ContentAnalyzer] æ‰¹é‡åˆ†æ: ${validContents.length}/${contents.length} æ¡æœ‰æ•ˆå†…å®¹`)

  // åˆ†æ‰¹å¤„ç†
  for (let i = 0; i < validContents.length; i += concurrency) {
    const batch = validContents.slice(i, i + concurrency)

    const batchResults = await Promise.allSettled(
      batch.map(async (content) => {
        const analysis = await analyzeContentQuality(content)
        return { id: content.id, analysis }
      })
    )

    batchResults.forEach((result) => {
      if (result.status === 'fulfilled' && result.value.analysis) {
        results.set(result.value.id, result.value.analysis)
      }
    })

    console.info(`[ContentAnalyzer] å·²å¤„ç† ${Math.min(i + concurrency, validContents.length)}/${validContents.length}`)

    // é¿å…è¿‡å¿«è¯·æ±‚ï¼Œæ¯æ‰¹é—´éš”1ç§’
    if (i + concurrency < validContents.length) {
      await new Promise(resolve => setTimeout(resolve, 1000))
    }
  }

  return results
}
```

### APIé…ç½®

**æ¨¡å‹**: `anthropic/claude-sonnet-4.5`
**Temperature**: 0.3ï¼ˆè¾ƒä½æ¸©åº¦ï¼Œä¿è¯åˆ†æç¨³å®šæ€§ï¼‰
**Max Tokens**: 2000
**Response Format**: `json_object`ï¼ˆç®€å•JSONæ¨¡å¼ï¼Œé¿å…å­—æ®µå‘½åé—®é¢˜ï¼‰

### è§£æå¢å¼º

ä¸ºäº†åº”å¯¹AIè¿”å›æ ¼å¼çš„ä¸ç¡®å®šæ€§ï¼Œè§£æå™¨åŒ…å«ä¸‰å±‚é˜²æŠ¤ï¼š

1. **Markdownæ¸…ç†**ï¼šç§»é™¤ ````json ... ``` åŒ…è£¹
2. **å­—æ®µåæ ‡å‡†åŒ–**ï¼šè‡ªåŠ¨è½¬æ¢ä¸‹åˆ’çº¿å‘½åä¸ºé©¼å³°å‘½å
3. **é»˜è®¤å€¼å¡«å……**ï¼šç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½æœ‰å€¼

```typescript
function parseAnalysisResponse(aiResponse: string): ContentQualityAnalysis {
  try {
    // 1. æ¸…ç†markdownä»£ç å—åŒ…è£¹
    let cleanedResponse = aiResponse.trim()
    if (cleanedResponse.startsWith('```json')) {
      cleanedResponse = cleanedResponse.replace(/^```json\n?/, '').replace(/\n?```$/, '')
    } else if (cleanedResponse.startsWith('```')) {
      cleanedResponse = cleanedResponse.replace(/^```\n?/, '').replace(/\n?```$/, '')
    }

    const parsed = JSON.parse(cleanedResponse.trim())

    // 2. è½¬æ¢å­—æ®µåï¼ˆä¸‹åˆ’çº¿â†’é©¼å³°ï¼‰
    const normalized = normalizeFieldNames(parsed)

    // 3. éªŒè¯å¹¶è¡¥å……ç¼ºå¤±å­—æ®µ
    const result = validateAndFillDefaults(normalized)

    return result

  } catch (error) {
    console.error('[ContentAnalyzer] è§£æå¤±è´¥:', error)
    console.error('[ContentAnalyzer] åŸå§‹å“åº”:', aiResponse.substring(0, 500))
    throw error
  }
}
```

---

## ğŸ”§ å­ç³»ç»Ÿï¼šäº’åŠ¨ç‡è®¡ç®—ä¸åˆ·é‡æ£€æµ‹

### äº’åŠ¨ç‡è®¡ç®—

**æ ¸å¿ƒæ–‡ä»¶**: `lib/utils/content-metrics.ts`

```typescript
export function calculateContentMetrics(content: {
  playCount: number
  diggCount: number
  commentCount: number
  shareCount: number
  collectCount: number
}): ContentMetrics {
  const { playCount, diggCount, commentCount, shareCount, collectCount } = content

  if (playCount === 0) {
    return {
      likeRate: null,
      commentRate: null,
      shareRate: null,
      collectRate: null
    }
  }

  return {
    likeRate: (diggCount / playCount) * 100,      // ç‚¹èµç‡
    commentRate: (commentCount / playCount) * 100, // è¯„è®ºç‡
    shareRate: (shareCount / playCount) * 100,     // åˆ†äº«ç‡
    collectRate: (collectCount / playCount) * 100  // æ”¶è—ç‡
  }
}
```

### è´¨é‡æƒé‡è®¡ç®—

```typescript
export function calculateQualityWeight(metrics: ContentMetrics): {
  commentWeight: number
  shareWeight: number
  likeWeight: number
  totalScore: number
} {
  const { likeRate, commentRate, shareRate } = metrics

  // æƒé‡åˆ†é…ï¼šè¯„è®ºÃ—2ã€åˆ†äº«Ã—2.5ã€ç‚¹èµÃ—0.5
  const commentWeight = (commentRate || 0) * 2
  const shareWeight = (shareRate || 0) * 2.5
  const likeWeight = (likeRate || 0) * 0.5

  return {
    commentWeight,
    shareWeight,
    likeWeight,
    totalScore: commentWeight + shareWeight + likeWeight
  }
}
```

### è´¨é‡ç­‰çº§åˆ¤æ–­

```typescript
export function getQualityLevel(metrics: ContentMetrics): {
  level: 'high' | 'medium' | 'low' | 'unknown'
  label: string
  description: string
} {
  const { commentRate, shareRate, likeRate } = metrics

  if (commentRate === null || shareRate === null || likeRate === null) {
    return {
      level: 'unknown',
      label: 'â“ æ— æ³•åˆ¤æ–­',
      description: 'ç¼ºå°‘æ’­æ”¾é‡æ•°æ®'
    }
  }

  // é«˜è´¨é‡ï¼šè¯„è®ºç‡â‰¥0.5% ä¸” åˆ†äº«ç‡â‰¥0.3%
  if (commentRate >= 0.5 && shareRate >= 0.3) {
    return {
      level: 'high',
      label: 'âœ… é«˜è´¨é‡',
      description: 'è¯„è®ºå’Œåˆ†äº«æ´»è·ƒï¼ŒçœŸå®äº’åŠ¨å¼º'
    }
  }

  // ä½è´¨é‡ï¼šç‚¹èµç‡>10% ä½† è¯„è®ºç‡<0.3%ï¼ˆç–‘ä¼¼åˆ·é‡ï¼‰
  if (likeRate > 10 && commentRate < 0.3) {
    return {
      level: 'low',
      label: 'âš ï¸ ä½è´¨é‡',
      description: 'ç‚¹èµç‡å¼‚å¸¸ï¼Œç–‘ä¼¼åˆ·é‡'
    }
  }

  // ä¸­ç­‰è´¨é‡
  return {
    level: 'medium',
    label: 'â­• ä¸­ç­‰',
    description: 'äº’åŠ¨æ•°æ®æ­£å¸¸'
  }
}
```

### åˆ·é‡æ£€æµ‹

**æ ¸å¿ƒæ–‡ä»¶**: `lib/utils/fraud-detection.ts`

```typescript
export function detectFraud(
  content: {
    playCount: number
    diggCount: number
    commentCount: number
    shareCount: number
    collectCount: number
  },
  historicalData: any[]
): {
  isSuspicious: boolean
  reason: string
  confidence: number
} {
  const { playCount, diggCount, commentCount, shareCount } = content

  if (playCount === 0) {
    return { isSuspicious: false, reason: '', confidence: 0 }
  }

  const likeRate = (diggCount / playCount) * 100
  const commentRate = (commentCount / playCount) * 100
  const shareRate = (shareCount / playCount) * 100

  // è§„åˆ™1ï¼šç‚¹èµç‡å¼‚å¸¸é«˜ï¼ˆ>15%ï¼‰
  if (likeRate > 15) {
    return {
      isSuspicious: true,
      reason: 'ç‚¹èµç‡è¿‡é«˜ï¼ˆ>15%ï¼‰ï¼Œè‡ªç„¶æµé‡ç½•è§',
      confidence: 0.8
    }
  }

  // è§„åˆ™2ï¼šäº’åŠ¨ä¸å¹³è¡¡ï¼ˆç‚¹èµç‡>10% ä½† è¯„è®ºç‡<0.3%ï¼‰
  if (likeRate > 10 && commentRate < 0.3) {
    return {
      isSuspicious: true,
      reason: 'ç‚¹èµå¤šä½†è¯„è®ºå°‘ï¼Œäº’åŠ¨ä¸å¹³è¡¡',
      confidence: 0.7
    }
  }

  // è§„åˆ™3ï¼šè¯„è®ºåˆ†äº«æ¯”ä¾‹å¼‚å¸¸
  if (shareRate > 2 && commentRate < 0.2) {
    return {
      isSuspicious: true,
      reason: 'åˆ†äº«ç‡é«˜ä½†è¯„è®ºæå°‘ï¼Œå¼‚å¸¸æ¨¡å¼',
      confidence: 0.6
    }
  }

  return { isSuspicious: false, reason: '', confidence: 0 }
}
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### æ—¶é—´æ¶ˆè€—

| é˜¶æ®µ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| æ•°æ®è·å– | ~100ms | ä»æ•°æ®åº“è·å–å•†å®¶+TOP10å†…å®¹ |
| AIå†…å®¹åˆ†æ | ~30s | æ‰¹é‡åˆ†æ10æ¡å†…å®¹ï¼ˆå¹¶å‘3ï¼‰ |
| Promptæ„å»º | ~50ms | æ„å»ºå®Œæ•´Promptæ–‡æœ¬ |
| LLM APIè°ƒç”¨ | ~5-10s | Claudeç”Ÿæˆæ¡£æ¡ˆ |
| å“åº”è§£æ | ~10ms | è§£æJSONå¹¶éªŒè¯ |
| æ•°æ®åº“ä¿å­˜ | ~50ms | Upsertæ“ä½œ |
| **æ€»è®¡** | **~35-40s** | ç«¯åˆ°ç«¯ç”Ÿæˆæ—¶é—´ |

### Tokenæ¶ˆè€—

| éƒ¨åˆ† | Tokenæ•° | è¯´æ˜ |
|------|---------|------|
| AIå†…å®¹åˆ†æ | ~5000 | 10æ¡å†…å®¹åˆ†æï¼ˆæ¯æ¡~500 tokensï¼‰ |
| æ¡£æ¡ˆç”ŸæˆPrompt | ~3000 | åŒ…å«å•†å®¶ä¿¡æ¯+TOP10å†…å®¹è¯¦æƒ… |
| æ¡£æ¡ˆç”ŸæˆResponse | ~1000 | Brief JSONè¾“å‡º |
| **æ€»è®¡** | **~9000 tokens** | çº¦$0.018/æ¡£æ¡ˆï¼ˆClaude Sonnet 4.5ï¼‰ |

### å¹¶å‘æ§åˆ¶

- **AIå†…å®¹åˆ†æ**: å¹¶å‘æ•°=3ï¼Œé¿å…APIé™æµ
- **æ‰¹æ¬¡é—´éš”**: 1ç§’ï¼Œé™ä½è¯·æ±‚å‹åŠ›
- **æ€»å¹¶å‘**: å•ä¸ªæ¡£æ¡ˆç”Ÿæˆä¸ºä¸²è¡Œæµç¨‹

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### å‰ç«¯é”™è¯¯å¤„ç†

```typescript
try {
  await generateMutation.mutateAsync()
  toast.success('æ¡£æ¡ˆç”ŸæˆæˆåŠŸï¼', { id: 'generate-profile' })
} catch (error) {
  const errorMessage = error instanceof Error
    ? error.message
    : 'æ¡£æ¡ˆç”Ÿæˆå¤±è´¥'
  toast.error(errorMessage, { id: 'generate-profile' })
}
```

### åç«¯é”™è¯¯å¤„ç†

**APIè·¯ç”±å±‚**ï¼š
```typescript
try {
  const result = await generateMerchantProfile(merchantId)
  return NextResponse.json(result)
} catch (error) {
  console.error('[Generate Profile API] é”™è¯¯:', error)
  return NextResponse.json(
    { error: error.message || 'ç”Ÿæˆå¤±è´¥' },
    { status: 500 }
  )
}
```

**æ ¸å¿ƒé€»è¾‘å±‚**ï¼š
```typescript
try {
  const merchant = await fetchMerchantWithContents(merchantId)
  // ... åç»­é€»è¾‘
} catch (error) {
  console.error('[ProfileGenerator] ç”Ÿæˆå¤±è´¥:', error)
  throw error  // å‘ä¸Šå±‚æŠ›å‡º
}
```

**AIåˆ†æå±‚**ï¼š
```typescript
try {
  const analysis = await analyzeContentQuality(content)
  return analysis
} catch (error) {
  console.error('[ContentAnalyzer] åˆ†æå¤±è´¥:', error)
  return null  // å¤±è´¥æ—¶è¿”å›nullï¼Œä¸é˜»æ–­æµç¨‹
}
```

### é™çº§ç­–ç•¥

1. **AIåˆ†æå¤±è´¥**ï¼šè·³è¿‡è¯¥å†…å®¹ï¼Œç»§ç»­å¤„ç†å…¶ä»–å†…å®¹
2. **è§£æå¤±è´¥**ï¼šè¿”å›ç©ºç»“æœï¼ˆ`createEmptyResult()`ï¼‰
3. **æ•°æ®ä¸è¶³**ï¼šåœ¨Promptä¸­æ˜ç¡®è¯´æ˜ï¼Œè®©AIç»™å‡ºæœ‰é™å»ºè®®

---

## ğŸ§ª æµ‹è¯•

### æ‰‹åŠ¨æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `scripts/test-content-analyzer.ts`

```bash
npx tsx scripts/test-content-analyzer.ts
```

**é¢„æœŸè¾“å‡º**ï¼š
```
===== æµ‹è¯•AIå†…å®¹åˆ†æåŠŸèƒ½ =====

âœ… æ‰¾åˆ°æµ‹è¯•å†…å®¹:
   å•†å®¶: çµå±±æ–°å“¥è‡ªå»ºæˆ¿
   æ ‡é¢˜: ç¬¬23å¥—å¦‚ä½•é€‰æ‹©
   è½¬å½•é•¿åº¦: 856 å­—ç¬¦
   æ’­æ”¾é‡: 10,000
   ç‚¹èµ: 400 | è¯„è®º: 80 | åˆ†äº«: 50

ğŸ¤– å¼€å§‹AIåˆ†æ...

âœ… AIåˆ†æå®Œæˆï¼è€—æ—¶: 3500 ms

ã€åˆ†æç»“æœã€‘

1ï¸âƒ£ å¼€å¤´è´¨é‡:
   è¯„åˆ†: 8/10
   ç­‰çº§: high (é«˜)
   æœ‰å¸å¼•åŠ›: æ˜¯
   åŸå› : ä½¿ç”¨ç–‘é—®å¥å’Œå…·ä½“æ•°å­—ï¼Œå¸å¼•åŠ›å¼º

2ï¸âƒ£ æƒ…ç»ªç‚¹:
   ä¸»è¦æƒ…ç»ª: ç—›ç‚¹å…±é¸£
   æƒ…ç»ªå¼ºåº¦: 7/10
   æè¿°: æˆ³ä¸­ç”¨æˆ·é€‰æˆ¿ç—›ç‚¹

3ï¸âƒ£ ç—›ç‚¹å’Œéœ€æ±‚:
   ç—›ç‚¹: ä¸çŸ¥é“å¦‚ä½•é€‰æ‹©è‡ªå»ºæˆ¿ã€æ‹…å¿ƒé€‰é”™
   éœ€æ±‚: é€‰æˆ¿æŒ‡å—ã€ä¸“ä¸šå»ºè®®

4ï¸âƒ£ å†…å®¹èŠ‚å¥:
   èŠ‚å¥å¿«æ…¢: å¿«èŠ‚å¥
   èŠ‚å¥å˜åŒ–: ä¸°å¯Œ
   æè¿°: ä¿¡æ¯å¯†é›†ï¼Œè½¬æŠ˜å¤š

5ï¸âƒ£ ç»¼åˆè¯„ä»·:
   ç»¼åˆè¯„åˆ†: 85/100
   ä¼˜ç‚¹:
     1. å¼€å¤´æŠ“äºº
     2. ç—›ç‚¹æ˜ç¡®
     3. èŠ‚å¥ç´§å‡‘

===== æµ‹è¯•å®Œæˆ =====
```

### é›†æˆæµ‹è¯•

**é€šè¿‡UIæµ‹è¯•**ï¼š
1. è¿›å…¥å•†å®¶è¯¦æƒ…é¡µï¼š`http://localhost:3007/merchants/[id]`
2. ç‚¹å‡»"æ¡£æ¡ˆ"æ ‡ç­¾
3. ç‚¹å‡»"ç”Ÿæˆæ¡£æ¡ˆ"æŒ‰é’®
4. ç­‰å¾…30-60ç§’
5. æŸ¥çœ‹ç”Ÿæˆçš„Briefå†…å®¹

**éªŒè¯è¦ç‚¹**ï¼š
- âœ… å•†å®¶ä»‹ç»æ˜¯å¦å‡†ç¡®ï¼ˆ3å¥è¯ï¼‰
- âœ… æ ¸å¿ƒå–ç‚¹æ˜¯å¦åˆç†ï¼ˆ3-5ä¸ªï¼‰
- âœ… ä½¿ç”¨åœºæ™¯æ˜¯å¦ç»“åˆç—›ç‚¹
- âœ… ç”¨æˆ·ç”»åƒæ˜¯å¦åŒ¹é…
- âœ… å“ç‰Œè°ƒæ€§æ˜¯å¦å‡†ç¡®

---

## ğŸ” å®‰å…¨æ€§

### API Keyç®¡ç†

```env
# .env.local
ZENMUX_API_KEY=your_key_here
```

- âœ… API Keyå­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­
- âœ… ä¸æäº¤åˆ°Gitä»“åº“ï¼ˆ.gitignoreä¸­æ’é™¤ï¼‰
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¹³å°ç¯å¢ƒå˜é‡ï¼ˆVercel/Railwayï¼‰

### æƒé™æ§åˆ¶ï¼ˆå¯é€‰ï¼‰

```typescript
// APIè·¯ç”±ä¸­å¯æ·»åŠ æƒé™éªŒè¯
const session = await getServerSession(authOptions)
if (!session?.user) {
  return NextResponse.json({ error: 'æœªæˆæƒ' }, { status: 401 })
}
```

### æ•°æ®éªŒè¯

- âœ… è¾“å…¥éªŒè¯ï¼šæ£€æŸ¥merchantIdæ˜¯å¦å­˜åœ¨
- âœ… æ•°æ®éªŒè¯ï¼šæ£€æŸ¥å†…å®¹æ•°é‡æ˜¯å¦è¶³å¤Ÿ
- âœ… å“åº”éªŒè¯ï¼šéªŒè¯JSONç»“æ„å®Œæ•´æ€§

---

## ğŸ“ˆ ç›‘æ§ä¸æ—¥å¿—

### å…³é”®æ—¥å¿—ç‚¹

```typescript
// 1. ç”Ÿæˆå¼€å§‹
console.info('[ProfileGenerator] å¼€å§‹ç”Ÿæˆæ¡£æ¡ˆ:', merchantId)

// 2. AIåˆ†æè¿›åº¦
console.info('[ProfileGenerator] å¼€å§‹AIå†…å®¹è´¨é‡åˆ†æ...')
console.info('[ProfileGenerator] AIåˆ†æå®Œæˆï¼ŒæˆåŠŸåˆ†æ:', count, 'æ¡')

// 3. Promptä¿¡æ¯
console.info('[ProfileGenerator] Prompté•¿åº¦:', userPrompt.length)

// 4. AIå“åº”
console.info('[ProfileGenerator] AIå“åº”é•¿åº¦:', aiResponse.content.length)
console.info('[ProfileGenerator] Tokenä½¿ç”¨:', aiResponse.usage)

// 5. ä¿å­˜æˆåŠŸ
console.info('[ProfileGenerator] æ¡£æ¡ˆå·²ä¿å­˜:', profile.id)

// 6. é”™è¯¯æ—¥å¿—
console.error('[ProfileGenerator] ç”Ÿæˆå¤±è´¥:', error)
```

### æ€§èƒ½ç›‘æ§

å¯é€šè¿‡æ•°æ®åº“å­—æ®µç›‘æ§ï¼š
- `aiTokenUsed`: æ¯æ¬¡ç”Ÿæˆçš„Tokenæ¶ˆè€—
- `aiGeneratedAt`: ç”Ÿæˆæ—¶é—´æˆ³
- `aiModelUsed`: ä½¿ç”¨çš„æ¨¡å‹ç‰ˆæœ¬
