      实现智能转录检测系统，解决控制台反馈中的转录文本缺失问题。

      ## 核心功能

      ### 1. 转录状态验证工具 (transcript-validator.ts)
      - **智能检测**：识别缺失、过短、包含错误信息的转录文本
      - **错误模式匹配**：识别13种常见错误特征
        - "对不起，我无法处理"
        - "系统错误"
        - "音频内容"（ASR服务错误）
        - 英文错误（error/failed/sorry）
      - **批量验证**：支持批量检测并返回详细统计
        - validCount: 有效数量
        - missingCount: 缺失数量
        - invalidCount: 无效数量（包含错误信息）
        - missingPercentage: 缺失比例

      ### 2. 自定义错误类型 (transcription-errors.ts)
      - **TranscriptionRequiredError**：当缺失比例≥30%时抛出
      - **结构化数据**：包含需要转录的内容列表
        ```typescript
        {
          total: 10,
          missingCount: 4,
          missingPercentage: 40,
          contentsToTranscribe: [{ id, title, reason }]
        }
        ```
      - **HTTP 202状态码**：Accepted - 表示需要先完成转录

      ### 3. 档案生成器集成 (profile-generator.ts)
      - **生成前检测**（step 1.5）：在AI分析前验证转录状态
      - **阈值判断**：缺失比例≥30%时阻止生成，抛出TranscriptionRequiredError
      - **详细日志**：输出转录状态统计（total/valid/missing/percentage）

      ### 4. API路由更新 (profile/generate/route.ts)
      - **优先处理转录错误**：在其他错误之前检查
      - **返回202响应**：包含需要转录的内容列表和提示信息
        ```json
        {
          "success": false,
          "error": "TRANSCRIPTION_REQUIRED",
          "message": "档案生成需要先转录 4/10 条内容（40.0%）",
          "statusCode": 202,
          "data": {
            "contentsToTranscribe": [...]
          },
          "hint": "请先转录缺失的内容，然后重新生成档案"
        }
        ```

      ## 工作流程

      ```
      用户点击"生成档案"
        ↓
      API检测TOP10内容转录状态
        ↓
      缺失≥30% → 返回202 + 需转录列表
      缺失<30% → 跳过无效内容，直接生成
        ↓
      前端收到202响应
        ↓
      自动调用批量转录API（SSE流式显示进度）
        ↓
      转录完成后自动重新调用档案生成API
      ```

      ## 解决的问题

      1. ✅ 识别控制台反馈中的"对不起，我无法处理音频内容"错误
      2. ✅ 防止在转录缺失时生成低质量档案（AI返回"数据不足"）
      3. ✅ 提供清晰的用户反馈和自动化解决路径
      4. ✅ 保持架构清晰（前后端分离，不阻塞主流程）

      ## 后续任务

      - [ ] 前端集成：处理202响应，自动调用转录API
      - [ ] UI优化：显示转录进度和状态
      - [ ] 测试：验证完整流程（检测 → 转录 → 生成）

      ## 相关文件

      - lib/utils/transcript-validator.ts (新增)
      - lib/errors/transcription-errors.ts (新增)
      - lib/ai/profile-generator.ts (修改)
      - app/api/merchants/[id]/profile/generate/route.ts (修改)

      Co-authored-by: User Feedback Analysis Team <noreply@zhidian.ai>")
  ⎿  [1118 609cc0a] feat(profile): 档案生成前自动检测转录状态
      5 files changed, 349 insertions(+), 57 deletions(-)
      create mode 100644 lib/errors/transcription-errors.ts
      create mode 100644 lib/utils/transcript-validator.ts

∴ Thinking…

  很好！代码已经提交。现在我需要给用户提供前端集成的指导，展示如何在前端自动处理这个202响应。

  让我先找到MerchantProfileCard组件，看看它是如何调用API的。

∴ Thinking…

  现在让我给用户提供前端集成指导。我会展示：
  1. 当前的实现状态
  2. 前端如何处理202响应
  3. 示例代码（伪代码）

● 🎉 后端实现完成！

  我已经完成了智能转录检测系统的后端实现。以下是完整的解决方案：

  ✅ 已完成的功能

  1. 转录状态验证工具 (lib/utils/transcript-validator.ts)

  - 智能识别13种错误模式（包括你控制台中的"对不起，我无法处理音频内容"）
  - 批量验证并返回详细统计
  - 支持自定义阈值判断（默认30%缺失率触发）

  2. 自定义错误类型 (lib/errors/transcription-errors.ts)

  - TranscriptionRequiredError - 当缺失过多时抛出
  - 包含完整的需转录内容列表（ID、标题、原因）
  - 自动转换为HTTP 202响应格式

  3. 档案生成器更新 (lib/ai/profile-generator.ts)

  - 在AI分析之前自动检测转录状态（step 1.5）
  - 缺失≥30% → 抛出错误，要求先转录
  - 缺失<30% → 跳过无效内容，继续生成

  4. API路由处理 (app/api/merchants/[id]/profile/generate/route.ts)

  - 捕获TranscriptionRequiredError返回HTTP 202 Accepted
  - 响应包含需要转录的内容列表

  📋 API响应格式示例

  当检测到需要转录时（202状态码）：
  {
    "success": false,
    "error": "TRANSCRIPTION_REQUIRED",
    "message": "档案生成需要先转录 4/10 条内容（40.0%）",
    "statusCode": 202,
    "data": {
      "total": 10,
      "missingCount": 4,
      "missingPercentage": 40,
      "contentsToTranscribe": [
        {
          "id": "content-123",
          "title": "工厂制造业获客方案...",
          "reason": "转录文本包含错误信息（匹配到\"对不起，我无法处理\"）"
        },
        ...
      ]
    },
    "hint": "请先转录缺失的内容，然后重新生成档案"
  }

  🔧 前端集成建议

  你现在需要在前端处理这个202响应。以下是建议的实现流程：

  方案A：自动化方案（推荐，一键完成）

  // 在 MerchantProfileCard 或相关组件中

  const handleGenerateProfile = async () => {
    setIsGenerating(true)

    try {
      const response = await fetch(`/api/merchants/${merchantId}/profile/generate`, {
        method: 'POST'
      })

      const data = await response.json()

      // 检查是否需要转录
      if (response.status === 202 && data.error === 'TRANSCRIPTION_REQUIRED') {
        // 显示转录中状态
        toast.info(`发现${data.data.missingCount}条内容未转录，正在自动转录...`)

        // 自动调用批量转录API
        const contentIds = data.data.contentsToTranscribe.map(c => c.id)
        await triggerBatchTranscribe(contentIds)

        // 转录完成后重新生成档案
        toast.success('转录完成，正在生成档案...')
        return handleGenerateProfile() // 递归重新调用
      }

      // 正常生成成功
      if (data.success) {
        toast.success('档案生成成功')
        // 更新UI
      }

    } catch (error) {
      toast.error('生成失败')
    } finally {
      setIsGenerating(false)
    }
  }

  // 批量转录函数（SSE流式）
  const triggerBatchTranscribe = async (contentIds: string[]) => {
    const url = `/api/merchants/${merchantId}/contents/batch-transcribe/stream?contentIds=${contentIds.join(',')}`

    await new Promise((resolve, reject) => {
      const eventSource = new EventSource(url)

      eventSource.addEventListener('progress', (e) => {
        const data = JSON.parse(e.data)
        // 更新进度UI: data.current / data.total
      })

      eventSource.addEventListener('done', () => {
        eventSource.close()
        resolve(true)
      })

      eventSource.addEventListener('error', () => {
        eventSource.close()
        reject()
      })
    })
  }

  方案B：提示用户确认（体验更透明）

  if (response.status === 202 && data.error === 'TRANSCRIPTION_REQUIRED') {
    const confirmed = await confirmDialog({
      title: '需要先转录内容',
      description: `发现${data.data.missingCount}条内容未转录（${data.data.missingPercentage.toFixed(1)}%），需要先
  转录才能生成高质量档案。是否立即转录？`,
      confirmText: '立即转录'
    })

    if (confirmed) {
      // ... 执行转录逻辑
    }
  }

  📊 完整工作流程

  用户点击"生成档案"
    ↓
  API检测TOP10转录状态
    ├─ 缺失<30% → 直接生成（跳过无效内容）✅
    └─ 缺失≥30% → 返回202 + 需转录列表
         ↓
    前端显示："正在转录X条内容..."
         ↓
    调用批量转录API（SSE流式进度）
         ↓
    转录完成 → 自动重新生成档案
         ↓
    显示："档案生成成功"✅

  💡 其他优化建议

  1. 优化content-analyzer逻辑：
    - 已完成：增强字段映射，错误率从10%降到0%
    - 建议：在analyzeContentQuality中也添加错误文本检测，直接跳过
  2. 数据清洗：
    - 可以添加一个脚本清理数据库中的错误转录文本：
  npx tsx scripts/clean-invalid-transcripts.ts
  3. 监控和统计：
    - 记录转录失败的内容ID
    - 分析哪些类型的视频容易转录失败

  你希望我帮你实现前端部分，还是你自己根据这个API规范来实现？