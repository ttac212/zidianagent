# 商家中心重构实施路线图（功能实现版）

## 1. 实施范围与目标
- **对象**：商家中心 App 路由、API、数据模型、AI 档案链路。
- **目标**：在统一 `Merchant` 数据模型下交付对标账号 MVP、创作档案升级，以及核心体验/权限修复。
- **完成标准**：所有列出的功能可在 Staging 全量回归通过，部署至生产后运行稳定 1 周。

## 2. 迭代计划与交付物
| 迭代 | 里程碑 | 计划时间 | 核心交付物 |
| --- | --- | --- | --- |
| Sprint 0 | 准备期 | 0.5 周 | 范围确认、数据库评审、LLM 配置校验、回滚预案 |
| Sprint 1 | 数据底座 & 权限 | 1 周 | Prisma schema 变更、迁移脚本、`Merchant` 状态扩展、权限中间件、基础 API 自测报告 |
| Sprint 2 | 对标账号 MVP | 1.5 周 | 对标 CRUD & 关联 API、列表 Tab & 空态、防抖、详情展示、基础 e2e |
| Sprint 3 | 创作档案升级 | 1.5 周 | `MerchantProfile` API、AI 生成链路、档案组件、人工补充流程、token 监控 |
| Sprint 4 | 优化 & 发布 | 1 周 | 搜索/分页优化、删除确认、lint/test/e2e 全量、监控告警、发布 checklist |

> 若资源受限，可将 Sprint 3 & 4 合并为 2 周延长冲刺，确保档案上线后有时间做监控与验收。

## 3. 功能任务拆解（按实施顺序）

### 3.1 数据模型与权限底座（Sprint 1）
- **Schema 变更**
  - 为 `Merchant` 新增：`status`（`SIGNED`/`BENCHMARK` 等）、`benchmarkForId`、必要索引组合。
  - 新增 `MerchantProfile` 表（13 个 AI 字段 + 4 个人工字段 + 元数据）。
  - 产出：`prisma/schema.prisma` PR，迁移脚本 + 回滚脚本，种子数据同步。
- **类型与枚举**
  - 更新 `types/merchant.ts`、`lib/prisma.ts`、前端类型入口。
  - 增补 `MerchantStatus`、`benchmark` 枚举常量，文档化状态机。
- **权限收敛**
  - 封装 ADMIN 校验中间件，在现有 `/api/merchants/*` 路由接入。
  - 覆盖创建、更新、删除、档案生成等敏感操作；普通用户只读。
- **验收**
  - `pnpm db:generate && pnpm db:push` 本地通过；种子数据可跑。
  - 基础 API 自测（Postman/Thunder 集合）记录于 Confluence/Notion。

### 3.2 对标账号 MVP（Sprint 2）
- **API**
  - `/api/merchants` 扩展查询：`status`、`benchmarkForId`、分页参数，输出含状态徽标字段。
  - `/api/merchants/[id]`：支持读取 `benchmarkForId`、更新时允许 status 切换。
  - `/api/merchants/[id]/benchmarks`（可选）：关联/解除再封装，确保权限检查。
- **前端列表页 `/merchants`**
  - Tab：`已签约`、`对标账号`、`全部`；默认展示 `已签约`。
  - 搜索输入添加 300ms 防抖、Tab 切换重置页码、空数据提示，引入徽章区分状态。
  - Admin 工具栏：新增“添加对标账号”入口。
- **详情页 `/merchants/[id]`**
  - 显示关联对标账号列表，支持新增/解除关联（Admin）。
  - 非 Admin 以只读卡片显示。
- **测试**
  - Vitest：API handler、状态筛选、防抖函数。
  - Playwright：Tab 切换、对标账号新增/删除、关联流程。

### 3.3 创作档案升级（Sprint 3）
- **API & 服务端**
  - `GET /api/merchants/[id]/profile`：返回档案与 `totalContentCount`。
  - `POST /api/merchants/[id]/profile/generate`：Admin 权限，触发 AI 生成，写入 AI 字段。
  - `PATCH /api/merchants/[id]/profile`：仅更新 `custom*` 字段，保持 AI 字段不变。
  - 日志：记录模型、token、耗时，异常时写入 Sentry。
- **AI 能力**
  - `lib/ai/profile-generator.ts`：拼接 Prompt、调用 Haiku/Gemini Flash、统计 token。
  - `lib/ai/profile-parser.ts`：解析 JSON，校验百分比=100 等规则，失败时降级保存原文。
  - 冷却策略：10 分钟内重复刷新返回 429；配置化写入。
- **前端**
  - `MerchantProfileCard`：集成 React Query hooks，处理 loading/空状态/刷新按钮。
  - `ProfileAISection`：按 Brief / 爆款分析 / 创作指南三段展示，JSON 格式化显示。
  - `ProfileCustomSection` 与 `ProfileEditDialog`：人工字段编辑保存。
  - 非 Admin 按钮禁用并提示权限。
- **测试**
  - 单测：解析器、生成器、API 权限。
  - e2e：生成成功、刷新、编辑、权限限制。

### 3.4 体验优化与发布（Sprint 4）
- 列表删除确认弹窗、导出提示、移动端布局 QA。
- 搜索/分页性能复测，必要时引入 React Query 缓存 & Loading Skeleton。
- 全量 `pnpm lint`、`pnpm test`、核心路径 `pnpm test:e2e`。
- 监控：token 消耗、生成成功率、API 错误率仪表盘；配置告警。
- 发布：执行 checklist（迁移 -> 部署 -> 验证 -> 观察），准备回滚脚本，安排上线窗口。

## 4. 技术实现要点
- **统一数据模型**：对标账号使用 `Merchant.status = BENCHMARK` + `benchmarkForId`; 转化为商家仅需更新 status 并清理关联。
- **关联约束**：MVP 阶段 `benchmarkForId` 约束单向一对多；扩展多对多可在后续通过中间表实现。
- **AI 字段与人工字段物理分离**：`POST generate` 操作只更新 AI 字段；`PATCH` 仅触达 `custom*` 字段，避免误覆盖。
- **Prompt 控制**：严格 JSON 输出、百分比校验、数据不足返回 null；解析失败时存储原文便于排查。
- **权限封装**：在 API 层统一调用 `requireAdmin()`，组件根据 `session.user.role` 控制按钮。
- **性能与成本**：列表查询添加索引；AI 生成记录 token 和耗时，冷却窗口避免刷量。

## 5. 测试与验收计划
- **单测**：覆盖 Prisma 层数据操作、API handler、AI 解析逻辑，目标行覆盖率≥80%。
- **前端**：组件快照与交互测试（React Testing Library / Vitest），确保 Tab、按钮、权限。
- **端到端**：Playwright 场景——对标账号 CRUD & 关联、档案生成/刷新/编辑、非 Admin 限制。
- **回归命令**：`pnpm lint && pnpm test && pnpm test:e2e`；如涉及 AI 外部服务，使用 Mock/Fixture。
- **验收清单**：功能验证（对标 + 档案）、性能指标、权限验证、监控指标配置成功。

## 6. 上线步骤与风险控制
1. `pnpm db:generate` -> 审核迁移 -> 预生产执行迁移并验证。
2. 部署后执行冒烟测试脚本（关键 API + UI 场景）。
3. 监控 token 消耗/错误率 24h；异常立即触发回滚（撤销迁移 or 切换旧构建）。
4. 输出上线总结，记录数据指标与问题。

**关键风险 & 对策**
- **AI 成本飙升**：上线前设定阈值 + 冷却；每日报表审计。
- **数据缺失导致档案不可用**：前端展示文案提示 + 允许人工补充，后台记录告警。
- **权限疏漏**：API 层单测 + e2e 覆盖；上线前手工测试不同角色。
- **需求蔓延**：迭代评审只接收迭代内任务，新增需求加入 V2 backlog。

---
> 文档作为实施依据，后续如需调整迭代或任务优先级，请在迭代评审会同步更新并记录。确认无误后可据此拆分到具体 issue / PR。
