  ✅ 值得做：身份认证、防滥用和数据同步的基础设施漏洞已经到了必须修的地步，否则产品一上线就会被共享密码、SQLite 锁等待和  失效的分析流程拖死。

  【关键洞察】

  - 数据结构：整个系统仍建立在 Prisma + SQLite（prisma/schema.prisma:5-8）之上，配合 lib/prisma.ts 的 WAL hack 和多张大
    表（merchant_contents / merchant_content_comments）会在批量同步时被长事务锁死；类型层再通过 types/merchant.ts 把同一    字段混合成 Date | string | null，进一步放大脏数据的概率。
  - 复杂度：业务核心（merchant page、同步 pipeline、audience/comment pipeline）全部是 400~900 行的巨型函数，再叠加重复的    SSE 解析、Hook 状态管理，任何改动都会牵一发动全身。
  - 风险点：认证完全依赖单个环境变量密码（auth/strategies/production.ts:17-74），新商家创建接口完全没做权限控制（app/
    api/merchants/route.ts:145-180），同步任务永远拉 100 个商家串行执行（app/api/merchants/sync-stream/route.ts:96-185）    ——这三件事足以“break userspace”。

  【Linus式方案】

  1. 第一步永远是简化数据结构：把 SQLite 换成 Postgres/MySQL，Prisma schema 里该有的 JSON/Date 类型就保持原生，别再塞
     Date | string | any；同步统计改成增量更新或触发器，避免每次全表扫描。
  2. 消除所有特殊情况：API 统一返回 { success, data } 结构，SSE 事件统一 spec，让前端 hooks 不用一半 unwrap 一半直
     接 .json()。
  3. 用最笨但最清晰的方式实现长任务：后台队列 + 限流，/api/merchants/sync-stream 只负责排队，真正的批处理在 worker 里并
     发消费并写入进度；评论分析不足 20 条时直接调 TikHub 重新抓而不是抛错。
  4. 确保零破坏性：引入 per-user 密码 / magic link，而不是全局密码；补上权限校验、速率限制和 Vitest 配置，把现在被
     exclude 的测试和 scripts/**/* 再次纳入自动化检查，防止以后再有“理论正确但破坏用户”的改动。

  【品味评分】
  凑合

  【致命问题】

  - auth/strategies/production.ts:17-74 & auth/strategies/development.ts:31-85：生产登录只校验 ADMIN_LOGIN_PASSWORD 这一    把万能钥匙，开发环境任何邮箱+DEV_LOGIN_CODE 即可自动建号，没有速率限制和审计。只要这个 env 泄露，所有账号瞬间失守。
  - app/api/merchants/route.ts:145-180：创建商家的接口注释里写“管理员功能”，实际把权限判断整块注释掉了，任何登录用户都能    伪造 manual_* 商家，直接污染主数据。
  - prisma/schema.prisma:5-8 / lib/prisma.ts:8-77 / lib/tikhub/sync-service.ts:478-611：在 SQLite 上执行 bulkUpsert +
    updateMerchantAggregates（全表求 _sum）的长事务，本来就会阻塞其它请求；现在再叠加多条 PRAGMA，自研 WAL，还把所有同步    放到一个事务里，生产流量一大就必定锁表、503。
  - app/api/merchants/sync-stream/route.ts:96-185：无论请求体怎么传，都硬编码 take: 100，然后依次 updateMerchantVideos
    并 sleep 2s；按钮上那个“limit”其实是传给 TikHub 的视频条数。结果就是一次同步耗时几分钟，TikHub 还容易限流。
  - lib/merchant/comments-source-manager.ts:1-103：分析 pipeline 在评论少于 20 条时直接 throw new Error，也没有去 TikHub    拉新评论的逻辑。新商家刚同步完想做评论分析必然失败。
  - types/merchant.ts:41-148：核心类型把日期声明成 Date | string，contactInfo 直接 any，下游常常拿着字符串去和 Date 做比    较，导致排序/过滤在不同 API 得到不同结果。
  - app/api/merchants/route.ts:19-140 vs app/api/merchants/[id]/profile/route.ts:18-109：同一个域名下有的返回裸 JSON，有    的包装成 { success, data }。Hooks 只能靠 unwrapApiResponse 或手写解析，客户端一旦误用就直接 500。
  - lib/merchant/audience-analysis-pipeline.ts:416-418 & lib/merchant/merchant-comments-analysis-pipeline.ts:334-339：
    tokenUsed 完全靠 Math.ceil(text.length * 1.5) 乱算。若后面按这个字段扣配额或结算成本，相当于和实际用量彻底脱节。
  - vitest.config.ts:5-20 & tsconfig.json:25-27：测试配置把 **/*.spec.ts?(x) 全排除掉，scripts/**/* 也被踢出 TypeScript
    校验。现在不但没有测试，连写了测试也跑不起来，脚本出错也不会被 TS 抓到。

  【改进方向】

  - 把认证换成真正的 per-user 凭证（密码 + TOTP 或 magic link），并在所有需要管理员权限的 API（例如商家创建、同步）里统
    一复用 withMerchantAdminAuth。
  - 迁移到支持并发的数据库，或至少把 updateMerchantAggregates 改成增量字段更新；批量同步和分析放进队列 worker，主线程只
    做排队 + SSE 推送。
  - 给评论/客群分析 pipeline 补齐“没有数据时自动采集”的分支，别让用户因为 19 条评论就无法使用功能。
  - 在类型和 API 层统一格式：公共响应、严格的 Date/Json 类型、React Query 层统一的 parseApiResponse；同时把 400+ 行页面
    拆成 Hook + 纯 UI 组件，减小认知负担。
  - 重新启用测试与脚本校验（移除 exclude、补 tests/setup），在 CI 里执行 pnpm lint && pnpm type-check && pnpm test，防止
    再有“上线才发现崩”的情况。