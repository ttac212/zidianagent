# æ‰¹é‡æ–‡æ¡ˆç”Ÿæˆæ¨¡å—æ–¹æ¡ˆè¯´æ˜

## èƒŒæ™¯ä¸ç›®æ ‡
- ä¸ºæ¯ä¸ªå•†å®¶æä¾›â€œæ‰¹é‡æ–‡æ¡ˆç”Ÿæˆâ€ç‹¬ç«‹æ¨¡å—ï¼Œæ”¯æŒåŸºäºåˆ†ææŠ¥å‘Šã€æç¤ºè¯ã€é€‰é¢˜/å¯¹æ ‡æ–‡æ¡ˆç­‰èµ„æ–™å¿«é€Ÿç”Ÿæˆ 5 æ¡çŸ­è§†é¢‘æ–‡æ¡ˆã€‚
- ç”Ÿæˆç»“æœéœ€é»˜è®¤å…¥åº“ï¼Œæ”¯æŒå¤åˆ¶ã€ç¼–è¾‘ã€ç‰ˆæœ¬è¿½è¸ªã€æ‰¹æ¬¡å†å²å›çœ‹ä¸å•æ¡/æ•´æ‰¹å†ç”Ÿæˆã€‚
- èµ„æ–™æ¥æºå¯ç»´æŠ¤å¤šç‰ˆæœ¬ï¼Œå¹¶å…è®¸å¼•ç”¨é™„ä»¶æ–‡æœ¬ï¼ˆåŒ…å« OCR/æ‘˜è¦ç»“æœï¼‰è€Œä¸ä¼šæ±¡æŸ“æ¨¡å‹è¾“å…¥ã€‚

## åŠŸèƒ½éœ€æ±‚æ‘˜è¦
- **èµ„æ–™ç®¡ç†**ï¼šå•†å®¶æŠ¥å‘Šã€æç¤ºè¯ã€é™„ä»¶æŒ‰ç‰ˆæœ¬ç®¡ç†ï¼›ä¿æŒæ¯ç±»ä»…ä¸€ä¸ªæ´»åŠ¨ç‰ˆæœ¬ï¼Œå¯è¿½æº¯å†å²ã€‚
- **ç”Ÿæˆæµç¨‹**ï¼šé€‰æ‹©å•†å®¶ â†’ é€‰å®šæŠ¥å‘Š/æç¤ºç‰ˆæœ¬ â†’ å‹¾é€‰é™„ä»¶/é€‰é¢˜/å¯¹æ ‡æ–‡æ¡ˆ â†’ å‘èµ·æ‰¹æ¬¡ â†’ å¼‚æ­¥ç”Ÿæˆ 5 æ¡ Markdown æ–‡æ¡ˆã€‚
- **ç»“æœä½¿ç”¨**ï¼šæŸ¥çœ‹ Markdown å†…å®¹ã€å¤åˆ¶ã€äººå·¥ç¼–è¾‘ã€å›æº¯ç‰ˆæœ¬ã€å•æ¡æˆ–æ•´æ‰¹å†ç”Ÿï¼›å†å²æ‰¹æ¬¡å¯å½’æ¡£ã€å¯¼å‡ºã€‚
- **å¼‚å¸¸å¤„ç†**ï¼šæ¨¡å‹è¾“å‡ºè¿è§„/ä¸ºç©ºæ—¶æç¤ºç”¨æˆ·è°ƒæ•´è¾“å…¥ææ–™ï¼Œå¹¶è®°å½•åˆ°å¼‚å¸¸è¡¨ä¾›æ’æŸ¥ã€‚
- **é™åˆ¶**ï¼šé¦–ç‰ˆä¸å¼€æ”¾ç”Ÿæˆå‚æ•°è°ƒèŠ‚ï¼ˆæ¸©åº¦/è¯­æ°”ç­‰ï¼‰ï¼Œé™„ä»¶ä»…æ”¯æŒæ–‡æœ¬ã€‚

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ
1. **å‰ç«¯é¡µé¢**
   - å·¦ä¾§èµ„æ–™é¢æ¿ï¼šå•†å®¶å½“å‰æŠ¥å‘Š/æç¤ºç‰ˆæœ¬ã€å†å²ç‰ˆæœ¬é€‰æ‹©ã€é™„ä»¶/é€‰é¢˜ç®¡ç†ï¼ˆå«å¯ç”¨å¼€å…³ï¼‰ã€‚
   - å³ä¾§æ‰¹æ¬¡è§†å›¾ï¼šå½“å‰æ‰¹æ¬¡çŠ¶æ€ã€5 æ¡æ–‡æ¡ˆå¡ç‰‡ï¼ˆMarkdown å±•ç¤ºã€å¤åˆ¶ã€äºŒæ¬¡ç¼–è¾‘ã€å†ç”ŸæŒ‰é’®ï¼‰ã€å†å²æ‰¹æ¬¡åˆ—è¡¨ã€‚
   - çŠ¶æ€æ›´æ–°é€šè¿‡ SSEï¼ˆå¯å›é€€è½®è¯¢ï¼‰åŒæ­¥ã€‚
2. **åç«¯ API / Server Action**
   - åˆ›å»ºæ‰¹æ¬¡ã€åˆ—å‡ºæ‰¹æ¬¡ã€è·å–æ‰¹æ¬¡è¯¦æƒ…ã€æ›´æ–°æ–‡æ¡ˆã€å•æ¡/æ•´æ‰¹å†ç”Ÿã€æŠ¥å‘Š/æç¤º/é™„ä»¶ CRUDã€‚
   - æ‰€æœ‰æ‰¹æ¬¡ç”Ÿæˆè¯·æ±‚è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”± Worker è°ƒç”¨ Claude 4.5 å¹¶å†™å…¥æ•°æ®åº“ã€‚
3. **ä»»åŠ¡ Worker**
   - å¤„ç†æ‰¹æ¬¡ç”Ÿæˆä¸å•æ¡å†ç”Ÿï¼Œç»Ÿä¸€è®°å½• token æ¶ˆè€—ã€å¼‚å¸¸äº‹ä»¶ã€çŠ¶æ€å˜æ›´ã€‚
4. **æ—¥å¿—ä¸ç›‘æ§**
   - `generation_exceptions` è®°å½•å¤±è´¥è¯¦æƒ…ï¼›å¤ç”¨ç°æœ‰ token ä½¿ç”¨ç»Ÿè®¡æˆ–åç»­æ‰©å±•ä»ªè¡¨ç›˜ã€‚

## æ•°æ®æ¨¡å‹è®¾è®¡

### merchant_prompt_assets
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| id | cuid | ä¸»é”® |
| merchant_id | FK â†’ merchants.id | å•†å®¶ |
| type | `REPORT \| PROMPT \| ATTACHMENT` | èµ„äº§ç±»å‹ |
| title | string | åç§° |
| version | int | ç‰ˆæœ¬å·ï¼ˆåŒå•†å®¶+ç±»å‹å”¯ä¸€ï¼‰ |
| parent_id | FK â†’ self (ON DELETE SET NULL) | å‰ä¸€ç‰ˆæœ¬ |
| content | text? | ä»… REPORT/PROMPT å…è®¸éç©º |
| reference_asset_id | FK â†’ reference_assets.id? | ä»… ATTACHMENT å…è®¸éç©º |
| metadata | JSON | é¢å¤–ä¿¡æ¯ï¼ˆé™„ä»¶å¼•ç”¨ç­‰ï¼‰ |
| is_active | boolean default false | æ´»åŠ¨ç‰ˆæœ¬æ ‡è®° |
| created_by | string | åˆ›å»ºäºº |
| created_at | DateTime default now | åˆ›å»ºæ—¶é—´ |
| updated_at | DateTime @updatedAt | æ›´æ–°æ—¶é—´ |

çº¦æŸï¼š
- `CHECK`ï¼š`(type IN ('REPORT','PROMPT') AND content IS NOT NULL AND reference_asset_id IS NULL) OR (type = 'ATTACHMENT' AND content IS NULL AND reference_asset_id IS NOT NULL)`
- `UNIQUE (merchant_id, type, version)`
- **éƒ¨åˆ†å”¯ä¸€**ï¼š`CREATE UNIQUE INDEX uniq_active_prompt_asset ON merchant_prompt_assets(merchant_id, type) WHERE is_active = true`

### reference_assets
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| id | cuid | ä¸»é”® |
| merchant_id | FK â†’ merchants.id |
| kind | `TOPIC \| BENCHMARK \| RAW_ATTACHMENT` |
| source_meta | JSON | æ¥æºä¿¡æ¯ |
| original_text | text | åŸå§‹æ–‡æœ¬ |
| ocr_text | text? | OCR ç»“æœ |
| summary | text? | æ‘˜è¦æ–‡æœ¬ |
| is_default_enabled | boolean default true | é»˜è®¤å‹¾é€‰ |
| created_by | string |
| created_at | DateTime |
| updated_at | DateTime |

### merchant_members
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| id | cuid | ä¸»é”® |
| merchant_id | FK â†’ merchants.id |
| user_id | FK â†’ users.id |
| role | `OWNER \| EDITOR \| VIEWER` |
| created_at | DateTime default now |
| updated_at | DateTime @updatedAt |

çº¦æŸï¼š
- `CHECK`ï¼š`role` å¿…é¡»åœ¨å…è®¸èŒƒå›´
- `UNIQUE (merchant_id, user_id)` é™åˆ¶å•å•†å®¶å•æˆå‘˜å”¯ä¸€
- ç´¢å¼• `merchant_member_user_idx` æ”¯æŒæŒ‰ç”¨æˆ·æŸ¥è¯¢å¯è®¿é—®å•†å®¶

### creative_batches
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| id | cuid |
| merchant_id | FK â†’ merchants.id |
| parent_batch_id | FK â†’ self (ON DELETE SET NULL) | æ•´æ‰¹å†ç”Ÿé“¾è·¯ |
| status | `QUEUED \| RUNNING \| SUCCEEDED \| PARTIAL_SUCCESS \| FAILED \| ARCHIVED` |
| model_id | string default `claude-sonnet-4-5-20250929` |
| status_version | int default 1 | çŠ¶æ€ç‰ˆæœ¬å· |
| started_at | DateTime? |
| completed_at | DateTime? |
| triggered_by | string |
| error_code | string? |
| error_message | string? |
| token_usage | JSON? |
| metadata | JSON? | æ‰¹æ¬¡ä¸Šä¸‹æ–‡ï¼ˆå†ç”Ÿç±»å‹ã€è¡¥å……æç¤ºç­‰ï¼‰ |
| created_at | DateTime default now |
| updated_at | DateTime @updatedAt |
| archived_at | DateTime? |

ç´¢å¼•ï¼š`(merchant_id, created_at DESC)`ã€`(status, created_at DESC)`

çŠ¶æ€å˜æ›´éœ€ä½¿ç”¨ `UPDATE ... SET status = ?, status_version = status_version + 1, updated_at = CURRENT_TIMESTAMP`.

### creative_batch_assets
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| id | cuid |
| batch_id | FK â†’ creative_batches.id |
| role | `REPORT \| PROMPT \| ATTACHMENT \| TOPIC \| BENCHMARK` |
| prompt_asset_id | FK â†’ merchant_prompt_assets.id? |
| reference_asset_id | FK â†’ reference_assets.id? |
| is_enabled | boolean default true |
| sort_order | int default 0 |

çº¦æŸï¼š
- `CHECK ( (prompt_asset_id IS NOT NULL) <> (reference_asset_id IS NOT NULL) )`
- `CHECK ( (role IN ('REPORT','PROMPT') AND prompt_asset_id IS NOT NULL) OR (role IN ('ATTACHMENT','TOPIC','BENCHMARK') AND reference_asset_id IS NOT NULL) )`
- éƒ¨åˆ†å”¯ä¸€ï¼š  
  - `CREATE UNIQUE INDEX uniq_batch_report ON creative_batch_assets(batch_id) WHERE role = 'REPORT'`  
  - `CREATE UNIQUE INDEX uniq_batch_prompt ON creative_batch_assets(batch_id) WHERE role = 'PROMPT'`
- æ™®é€šç´¢å¼•ï¼š`(batch_id, role, sort_order)`

### creative_copies
| å­—æ®µ | ç±»å‹ |
| --- | --- |
| id | cuid |
| batch_id | FK â†’ creative_batches.id |
| sequence | int (1-5) CHECK çº¦æŸå·²åœ¨æ•°æ®åº“å±‚å¼ºåˆ¶ |
| markdown_content | text |
| raw_model_output | JSON? |
| user_override | text? |
| state | `DRAFT \| APPROVED \| REJECTED` |
| regenerated_from_id | FK â†’ self (ON DELETE SET NULL) |
| edited_by | string? |
| edited_at | DateTime? |
| content_version | int default 1 |
| created_at | DateTime default now |
| updated_at | DateTime @updatedAt |

ç´¢å¼•ï¼š`(batch_id, sequence)`ã€`(regenerated_from_id)`

### creative_copy_revisions
- `copy_id` FK â†’ creative_copies.id
- `version` intï¼Œ`UNIQUE(copy_id, version)`
- `content` textï¼Œ`source` (`MODEL`/`USER`)ï¼Œ`note`ï¼Œ`created_by`ï¼Œ`created_at`

### generation_exceptions
- `batch_id` FK â†’ creative_batches.id
- `copy_id` FK â†’ creative_copies.id (å¯ç©º)
- `error_code`ã€`error_detail` JSONã€`request_payload`ã€`response_payload`
- `status` (`OPEN`/`ACKNOWLEDGED`/`RESOLVED`)
- `created_at`ã€`updated_at`
- ç´¢å¼•ï¼š`(batch_id, status)`

## ç‰ˆæœ¬å·ç”Ÿæˆç­–ç•¥
1. åœ¨ç‰ˆæœ¬åˆ›å»ºæœåŠ¡ä¸­å¼€å¯ Prisma äº‹åŠ¡ã€‚
2. æŸ¥è¯¢å½“å‰ `(merchant_id, type)` çš„æœ€å¤§ç‰ˆæœ¬ï¼š`SELECT COALESCE(MAX(version),0)+1`ï¼ˆSQLite é€šè¿‡ `prisma.$queryRaw` å®ç°ï¼‰ã€‚
3. å°è¯•æ’å…¥æ–°èµ„äº§è®°å½•ï¼ˆæºå¸¦ `version` å’Œæ½œåœ¨ `is_active`ï¼‰ã€‚
4. è‹¥è§¦å‘å”¯ä¸€çº¦æŸå†²çªï¼ˆP2002ï¼‰ï¼Œé€’å¢ç‰ˆæœ¬å·å¹¶é‡è¯•ï¼Œç›´è‡³æˆåŠŸã€‚
5. å¦‚éœ€å°†æ–°ç‰ˆæœ¬è®¾ä¸ºæ´»åŠ¨ç‰ˆæœ¬ï¼ŒåŒä¸€äº‹åŠ¡å†…æ‰§è¡Œï¼š`UPDATE merchant_prompt_assets SET is_active = false WHERE merchant_id=? AND type=? AND is_active = true`ï¼Œå†æ›´æ–°æ–°è®°å½• `is_active = true`ã€‚
6. äº‹åŠ¡æäº¤åè¿”å›æœ€ç»ˆç‰ˆæœ¬å€¼ã€‚
   - å®ç°å±‚è®¾ç½®é»˜è®¤é‡è¯• 5 æ¬¡å¹¶è®°å½•å¤±è´¥æ—¥å¿—ï¼Œå¦‚æœ‰éœ€è¦å¯æ‰©å±• `maxRetries` è¦†ç›–ã€‚

æœªæ¥è¿ç§»åˆ° Postgres æ—¶å¯æ”¹ä¸º `GENERATED ALWAYS AS IDENTITY` + `MERCHANT_ID,TYPE` åˆ†åŒºåºåˆ—ï¼Œä¸šåŠ¡é€»è¾‘ä¿æŒå…¼å®¹ã€‚

## æ‰¹æ¬¡çŠ¶æ€æ›´æ–°ç­–ç•¥
- æ‰€æœ‰çŠ¶æ€æ›´æ–°é€šè¿‡ `updateBatchStatus` æœåŠ¡å°è£…ï¼Œå†…å®¹ï¼š
  1. è¯»å–å½“å‰çŠ¶æ€ï¼ˆå¯é€‰è°ƒè¯•è®°å½•ï¼‰ã€‚
  2. æ‰§è¡Œ `UPDATE creative_batches SET status = ?, status_version = status_version + 1, started_at/completed_at = ?, updated_at = CURRENT_TIMESTAMP, error_code = ?, error_message = ?, token_usage = ? WHERE id = ?`.
  3. è¿”å›æ–°çš„ `status_version` æä¾›ç»™ SSEã€‚
- ä¿è¯ `status_version` å•è°ƒé€’å¢ï¼Œå‰ç«¯å¯ç”¨ `(batchId, statusVersion)` å»é‡ã€‚

## API & é˜Ÿåˆ—å¥‘çº¦

### åˆ›å»ºæ‰¹æ¬¡ `POST /api/creative/batches`
è¯·æ±‚ä½“ç¤ºä¾‹ï¼š
```json
{
  "merchantId": "mch_001",
  "assets": [
    { "role": "REPORT", "assetId": "mpr_1001" },
    { "role": "PROMPT", "assetId": "mpr_2006" },
    { "role": "ATTACHMENT", "assetId": "ref_9001", "enabled": true, "sortOrder": 1 },
    { "role": "TOPIC", "assetId": "ref_9002", "enabled": true },
    { "role": "BENCHMARK", "assetId": "ref_9003", "enabled": false }
  ]
}
```
å“åº”ç¤ºä¾‹ï¼š
```json
{
  "batchId": "cbt_123",
  "status": "QUEUED",
  "statusVersion": 1,
  "createdAt": "2024-06-30T12:00:00.000Z"
}
```

æœåŠ¡é€»è¾‘ï¼š
1. æ ¡éªŒå•†å®¶ä¸èµ„äº§å…³ç³»ã€æ£€æŸ¥æ´»åŠ¨ç‰ˆæœ¬ã€‚
2. åˆ›å»º `creative_batches`ï¼ˆstatus=QUEUEDï¼‰ã€‚
3. å†™å…¥ `creative_batch_assets`ï¼Œ`is_enabled` æœªæŒ‡å®šæ—¶é»˜è®¤ trueï¼›è‹¥ `enabled=false` ä¹Ÿéœ€è¦å†™è®°å½•ä¾›å†å²å›æ”¾ã€‚
4. æ¨é€ä»»åŠ¡ `{ batchId }` åˆ°é˜Ÿåˆ—ã€‚

### Worker è¾“å…¥
```json
{
  "batchId": "cbt_123",
  "merchantId": "mch_001",
  "materials": {
    "report": { "id": "mpr_1001", "content": "..." },
    "prompt": { "id": "mpr_2006", "content": "..." },
    "attachments": [
      { "id": "ref_9001", "text": "...", "summary": "..." }
    ],
    "topics": [...],
    "benchmarks": [...]
  }
}
```

### Worker è¾“å‡º
- å°†ç”Ÿæˆçš„æ–‡æ¡ˆæ’å…¥ `creative_copies`ï¼ˆ`content_version=1`ï¼‰ã€å†™ `creative_copy_revisions`ï¼ˆsource=MODELï¼‰ã€‚
- æ ¹æ®ç”Ÿæˆæ•°é‡å†³å®šæ‰¹æ¬¡çŠ¶æ€ï¼š
  - **5 æ¡**ï¼š`SUCCEEDED`
  - **1-4 æ¡**ï¼š`PARTIAL_SUCCESS`ï¼ˆéƒ¨åˆ†æˆåŠŸï¼Œä¿å­˜å·²ç”Ÿæˆå†…å®¹ï¼‰
  - **0 æ¡**ï¼š`FAILED`
- å¡«å…… `token_usage`ã€‚
- è‹¥æ¨¡å‹è¾“å‡ºä¸è¶³ 5 æ¡ï¼Œåœ¨ `generation_exceptions` è®°å½•è¯¦æƒ…ä¾›è°ƒè¯•ï¼Œä½†**ä¸å½±å“å·²ç”Ÿæˆæ–‡æ¡ˆçš„å¯ç”¨æ€§**ã€‚

**å¤±è´¥ç­–ç•¥åŸåˆ™**ï¼šæ°¸è¿œä¸è¦å› ä¸º"å°‘äº 5 æ¡"å°±ä¸¢å¼ƒå·²ç”Ÿæˆçš„å†…å®¹ã€‚ç”¨æˆ·æ‹¿åˆ° 3 æ¡æ–‡æ¡ˆæ€»æ¯”ä»€ä¹ˆéƒ½æ²¡æœ‰å¥½ã€‚

### å•æ¡å†ç”Ÿæˆ `POST /api/creative/copies/{id}/regenerate`
```json
{
  "appendPrompt": "å¼ºè°ƒä¼˜æƒ ä¿¡æ¯",
  "editedContent": "ç”¨æˆ·åˆšç¼–è¾‘ç‰ˆæœ¬",
  "notes": "å¸Œæœ›æ›´å£è¯­åŒ–"
}
```
- æœåŠ¡åˆ›å»º `creative_copies` æ–°è¡Œï¼ˆ`regenerated_from_id` æŒ‡å‘åŸ copyï¼‰ï¼Œå¤åˆ¶åŸåºå·ä¸èµ„äº§ä¿¡æ¯ã€‚
- å†™å…¥ revisionï¼ˆsource=USER/NOTEï¼‰ã€‚
- è§¦å‘å•æ¡ worker ä»»åŠ¡ï¼Œå®Œæˆå SSE é€šçŸ¥ã€‚

### æ•´æ‰¹å†ç”Ÿæˆ `POST /api/creative/batches/{id}/regenerate`
- æ–°å»ºæ‰¹æ¬¡å¹¶è®¾ç½® `parent_batch_id`ï¼Œå¤åˆ¶ä¸Šä¸€æ‰¹å¯ç”¨çš„èµ„äº§çŠ¶æ€ï¼ˆå…è®¸å‰ç«¯ä¿®æ”¹åæäº¤ï¼‰ã€‚
  - æ ¡éªŒ `parent_batch_id` å¿…é¡»å±äºåŒä¸€å•†å®¶ï¼Œå¦åˆ™ç›´æ¥æ‹’ç»ï¼Œé¿å…è·¨å•†å®¶ä¸²è”ã€‚
  - å°†å•æ¡å†ç”Ÿçš„ `appendPrompt`ã€æ¥æº copy ç­‰ä¿¡æ¯å†™å…¥ `creative_batches.metadata`ï¼Œä¾›åç»­ worker æ‹‰å–ã€‚

### æ–‡æ¡ˆçº§æ¥å£ `/api/creative/copies/{id}`
- `GET`ï¼šè¿”å›æ–‡æ¡ˆè¯¦æƒ…ã€æ‰€å±æ‰¹æ¬¡çŠ¶æ€ã€å…¨é‡ç‰ˆæœ¬å†å²ï¼›è¦æ±‚è°ƒç”¨è€…å…·å¤‡å•†å®¶æˆå‘˜èº«ä»½æˆ–ç®¡ç†å‘˜è§’è‰²ã€‚
- `PUT`ï¼šæ”¯æŒæ›´æ–° `content` ä¸ `state`ï¼Œå‘½ä¸­å†…å®¹æ—¶è‡ªåŠ¨ç”Ÿæˆ `creative_copy_revisions` è®°å½•å¹¶é€’å¢ `content_version`ï¼›è¯·æ±‚ä½“å¯é™„å¸¦ `note`ã€‚
- `POST`ï¼šå•æ¡å†ç”Ÿå…¥å£ï¼Œå¤ç”¨åŸæ‰¹æ¬¡èµ„äº§ç”Ÿæˆæ–°æ‰¹æ¬¡ï¼Œä¸”å°†ä»¥ä¸‹ä¸Šä¸‹æ–‡å†™å…¥ `creative_batches.metadata`ï¼š
  ```json
  {
    "source": "copy-regenerate",
    "parentCopyId": "ccp_001",
    "appendPrompt": "å¼ºè°ƒä¼˜æƒ ä¿¡æ¯",
    "editedContentProvided": true,
    "note": "ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹åå†ç”Ÿ"
  }
  ```
- æ–°æ‰¹æ¬¡ä¸æ–‡æ¡ˆå»ºç«‹ lineageï¼ˆ`parent_batch_id`ã€`regenerated_from_id`ï¼‰ï¼Œworker åº”è¯»å– `metadata.appendPrompt` è¿½åŠ åˆ°æ¨¡å‹æç¤ºï¼ŒSSE æ¨é€ä¹Ÿéœ€æºå¸¦æ–°çš„ `batchId`ã€‚

## SSE / äº‹ä»¶æ ¼å¼
- **æ‰¹æ¬¡çŠ¶æ€**
```json
{
  "type": "batch-status",
  "batchId": "cbt_123",
  "status": "SUCCEEDED",
  "statusVersion": 3,
  "timestamp": "2024-06-30T12:01:45.302Z",
  "tokenUsage": { "prompt": 5400, "completion": 6100 },
  "errorCode": null
}
```
- **æ–‡æ¡ˆæ›´æ–°**
```json
{
  "type": "copy-update",
  "batchId": "cbt_123",
  "copyId": "ccp_01",
  "sequence": 1,
  "state": "DRAFT",
  "contentVersion": 2,
  "timestamp": "2024-06-30T12:10:05.900Z",
  "regeneratedFromId": "ccp_09"
}
```
- å‰ç«¯é€šè¿‡ `statusVersion` / `contentVersion` å»é‡ï¼Œè½®è¯¢è·¯å¾„é‡ç”¨åŒä¸€ JSON ç»“æ„ã€‚

## å¹¶å‘ä¸æµ‹è¯•è€ƒè™‘
- å¹¶å‘åˆ›å»ºç‰ˆæœ¬ï¼šä½¿ç”¨ Vitest ç¼–å†™å•å…ƒæµ‹è¯•æ¨¡æ‹Ÿä¸¤ä¸ªä»»åŠ¡åŒæ—¶åˆ›å»ºåŒç±»èµ„äº§ï¼ŒéªŒè¯ä¹è§‚é‡è¯•é€»è¾‘ä¸ä¼šæŠ›å‡ºæœ€ç»ˆé”™è¯¯ã€‚
- å¹¶å‘çŠ¶æ€æ›´æ–°ï¼šä½¿ç”¨ Vitest æ¨¡æ‹Ÿå¤šä¸ª Worker æ›´æ–°åŒæ‰¹æ¬¡çš„é¡ºåºï¼Œç¡®è®¤ `status_version` å•è°ƒé€’å¢ä¸” `updated_at` æ­£ç¡®ã€‚
- æ•°æ®çº¦æŸæµ‹è¯•ï¼šå°è¯•æ’å…¥ä¸åˆæ³•æ•°æ®ï¼ˆç¼ºå°‘ contentã€åŒæºå¼•ç”¨ã€é‡å¤ REPORT/PROMPTï¼‰ç¡®ä¿æ•°æ®åº“å±‚æ‹’ç»ã€‚
- SQLite / Postgres å…¼å®¹ï¼šè¿ç§»è„šæœ¬éœ€åœ¨ `schema.prisma` æ³¨é‡Š raw SQL åŒæ—¶åœ¨ `migrations/*/steps.sql` ä¸­æä¾› `CREATE UNIQUE INDEX ... WHERE ...`/`CHECK` è¯­å¥ï¼›SQLite éœ€è¦ `partial index` æ”¯æŒï¼ˆå·²å­˜åœ¨ï¼Œæ³¨æ„è¯­æ³•ï¼‰ã€‚

## å®æ–½æ­¥éª¤
### è¿›åº¦å¿«ç…§ï¼ˆ2025-01-15ï¼‰
- [x] æ•°æ®åº“è¿ç§»ï¼ˆ`20240701_add_batch_module/` æ­£å‘+å›æ»šè„šæœ¬ï¼‰
- [x] Prisma Client schema & å…³ç³»ä¿®æ­£ï¼ˆå« `PromptAssetAttachment` åŒå‘å…³è”ï¼‰
- [x] å•†å®¶æˆå‘˜è¡¨ `merchant_members` + è®¿é—®æ§åˆ¶ helper
- [x] ä»“å‚¨å±‚ï¼šç‰ˆæœ¬ä¹è§‚é‡è¯•ã€æ‰¹æ¬¡äº‹åŠ¡åŒ–ã€çˆ¶æ‰¹æ ¡éªŒ
- [x] Vitest å¹¶å‘/çº¦æŸæµ‹è¯•ï¼š`tests/batch-repositories.test.ts`
- [x] **æ•°æ®å®Œæ•´æ€§ä¿®å¤**ï¼š
  - [x] æ·»åŠ  `creative_copies.sequence` CHECK çº¦æŸ (1-5)ï¼Œè¿ç§»è„šæœ¬ `20250115_add_sequence_constraint/`
  - [x] å¼•å…¥ `PARTIAL_SUCCESS` çŠ¶æ€ï¼Œä¿®å¤ Worker å¤±è´¥ç­–ç•¥
  - [x] Schema æ›´æ–°å¹¶æ·»åŠ çº¦æŸæ³¨é‡Š
- [x] API / Server Actions
  - [x] æ‰¹æ¬¡åˆ›å»º / åˆ—è¡¨ / è¯¦æƒ… / æ•´æ‰¹å†ç”Ÿï¼ˆåŸºäºæˆå‘˜è¡¨å®Œæˆå¤šç§Ÿæˆ·éš”ç¦»ï¼‰
  - [x] å•æ¡æ–‡æ¡ˆå†ç”Ÿ / æ–‡æ¡ˆç¼–è¾‘æ¥å£
- [x] Worker æ¡†æ¶ï¼ˆ`lib/workers/creative-batch-worker.ts`ï¼‰
  - [x] å®ç°æ­£ç¡®çš„å¤±è´¥ç­–ç•¥ï¼ˆPARTIAL_SUCCESSï¼‰
  - [x] Claude API é›†æˆï¼ˆå·²å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼‰
  - [x] æç¤ºè¯æ„å»ºå’Œè§£æé€»è¾‘
  - [x] SSE å®æ—¶æ¨é€ï¼ˆå·²å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼‰
- [x] å‰ç«¯æ”¯æŒ
  - [x] BatchStatusBadge ç»„ä»¶ï¼ˆæ˜¾ç¤º PARTIAL_SUCCESS ç­‰çŠ¶æ€ï¼‰
  - [x] æ‰¹æ¬¡åˆ—è¡¨é¡µé¢ï¼ˆ`app/creative/batches/page.tsx`ï¼‰
  - [x] Badge ç»„ä»¶æ‰©å±•ï¼ˆæ·»åŠ  success/warning å˜ä½“ï¼‰
  - [x] SSE Hookï¼ˆ`hooks/use-batch-status-sse.ts`ï¼‰- statusVersion å»é‡
  - [x] **P0 æ ¸å¿ƒé¡µé¢å’Œç»„ä»¶**ï¼ˆ2025-01-15ï¼‰ï¼š
    - [x] BatchInfoCard - æ‰¹æ¬¡ä¿¡æ¯å¡ç‰‡
    - [x] CopyCard - æ–‡æ¡ˆå¡ç‰‡ï¼ˆMarkdown é¢„è§ˆ + æ“ä½œï¼‰
    - [x] CopyEditDialog - æ–‡æ¡ˆç¼–è¾‘å¯¹è¯æ¡†ï¼ˆåŒæ ç¼–è¾‘å™¨ï¼‰
    - [x] CopyRegenerateDialog - å•æ¡é‡æ–°ç”Ÿæˆå¯¹è¯æ¡†
    - [x] æ‰¹æ¬¡è¯¦æƒ…é¡µé¢ï¼ˆ`/creative/batches/[batchId]`ï¼‰
    - [x] å•æ¡é‡æ–°ç”Ÿæˆ APIï¼ˆ`/api/creative/copies/:copyId/regenerate`ï¼‰
  - [ ] èµ„æ–™ç®¡ç†é¢æ¿ï¼ˆP1ï¼‰
  - [ ] ç‰ˆæœ¬å†å²æŸ¥çœ‹ï¼ˆP1ï¼‰
- [x] è¿ç»´è„šæœ¬
  - [x] å•†å®¶æˆå‘˜åŸºçº¿åŒæ­¥ï¼ˆ`scripts/backfill-merchant-members.ts`ï¼‰
  - [x] æ‰¹æ¬¡ Worker æµ‹è¯•ï¼ˆ`scripts/test-batch-worker.ts`ï¼‰
  - [x] SSE æ¨é€æµ‹è¯•ï¼ˆ`scripts/test-batch-sse.ts`ï¼‰
- [ ] è¿ç»´ä¸æ¸…ç†è„šæœ¬ã€å¼‚å¸¸é¢æ¿

1. **æ•°æ®åº“è¿ç§»**
   - æ›´æ–° `schema.prisma` å¹¶æ·»åŠ  raw SQL è¿ç§»ï¼ˆå»ºè®®ç›®å½•å¦‚ `20240701_add_batch_module/`; åŒ…å« forward/backward SQLï¼Œæ˜ç¤º CHECK / éƒ¨åˆ†å”¯ä¸€è¯­å¥ï¼‰ã€‚
   - é’ˆå¯¹ SQLite/Postgres åˆ†åˆ«éªŒè¯è¿ç§»æ‰§è¡Œï¼Œç¡®ä¿ rollback è„šæœ¬å¯ç”¨ã€‚
   - åº”ç”¨ `20240703_add_batch_metadata` è¿ç§»ï¼Œå‘ `creative_batches` å¢åŠ  `metadata` åˆ—ï¼Œç”¨äºå°è£…å•æ¡å†ç”Ÿä¸Šä¸‹æ–‡ï¼ˆappendPromptã€parentCopyIdã€note ç­‰ï¼‰ã€‚
   - è¿è¡Œ `scripts/backfill-merchant-members.ts`ï¼Œæ ¹æ®å†å²æ‰¹æ¬¡è§¦å‘äººè¡¥é½ `merchant_members` åŸºçº¿æ•°æ®ã€‚
2. **æ•°æ®è®¿é—®å±‚**
   - ç¼–å†™ `PromptAssetRepository`ã€`BatchRepository`ã€`CopyRepository` ç­‰ï¼Œå°è£…äº‹åŠ¡ã€ä¹è§‚é‡è¯•ä¸çŠ¶æ€æ›´æ–°ã€‚
3. **API / Server Actions**
   - æ­å»ºåˆ›å»ºæ‰¹æ¬¡ã€åˆ—å‡ºæ‰¹æ¬¡ã€è·å–è¯¦æƒ…ã€æ›´æ–°æ–‡æ¡ˆã€å†ç”Ÿæˆç­‰æ¥å£ã€‚
4. **Worker**
   - é›†æˆ Claude 4.5 è°ƒç”¨ã€å¼‚å¸¸æ•è·ã€çŠ¶æ€å›å†™ã€SSE æ¨é€ã€‚
5. **å‰ç«¯é¡µé¢**
   - æ„å»ºèµ„æ–™é¢æ¿ã€æ‰¹æ¬¡è§†å›¾ã€æ–‡æ¡ˆå¡ç‰‡ã€å†å²åˆ—è¡¨ã€‚
6. **æµ‹è¯•**
   - å•å…ƒæµ‹è¯•ï¼ˆå¹¶å‘ã€çº¦æŸã€çŠ¶æ€ï¼‰ã€é›†æˆæµ‹è¯•ï¼ˆç”Ÿæˆæµç¨‹ã€é”™è¯¯å¤„ç†ï¼‰ã€E2Eï¼ˆåŸºç¡€æµç¨‹ï¼‰ã€‚
7. **è¿ç»´æ”¯æŒ**
   - æä¾›æ¸…ç†è„šæœ¬ï¼ˆå½’æ¡£/åˆ é™¤æ‰¹æ¬¡ï¼‰ã€å¼‚å¸¸æŸ¥çœ‹é¡µé¢ã€è°ƒç”¨ç»Ÿè®¡åŸ‹ç‚¹ã€‚

### æ¶æ„ä¿®å¤è®°å½•ï¼ˆ2025-01-15ï¼‰
**é—®é¢˜å‘ç°**ï¼š
1. `creative_copies.sequence` ç¼ºå°‘æ•°æ®åº“çº¦æŸï¼Œå¯èƒ½å¯¼è‡´è¶Šç•Œå€¼ï¼ˆå¦‚ 0ã€999ï¼‰æ±¡æŸ“æ•°æ®
2. åŸè®¾è®¡ Worker å¤±è´¥ç­–ç•¥ä¼šå› ä¸º"ä¸è¶³ 5 æ¡"å°±æ ‡è®° FAILEDï¼Œä¸¢å¼ƒå·²ç”Ÿæˆçš„æ–‡æ¡ˆ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. æ·»åŠ  CHECK çº¦æŸ `sequence >= 1 AND sequence <= 5`ï¼Œé€šè¿‡è¡¨é‡å»ºè¿ç§»å®ç°ï¼ˆSQLite é™åˆ¶ï¼‰
2. å¼•å…¥ `PARTIAL_SUCCESS` çŠ¶æ€ï¼š
   - 5 æ¡ â†’ SUCCEEDED
   - 1-4 æ¡ â†’ PARTIAL_SUCCESSï¼ˆä¿å­˜å·²ç”Ÿæˆå†…å®¹ï¼‰
   - 0 æ¡ â†’ FAILED
3. Worker å®ç°éµå¾ª"Never break userspace"åŸåˆ™ï¼Œç”¨æˆ·æ‹¿åˆ°éƒ¨åˆ†ç»“æœæ€»æ¯”ä»€ä¹ˆéƒ½æ²¡æœ‰å¥½

**æµ‹è¯•éªŒè¯**ï¼ˆ2025-01-15ï¼‰ï¼š
- âœ… Worker æµ‹è¯•é€šè¿‡ï¼šç”Ÿæˆ 3/5 æ¡æ–‡æ¡ˆï¼Œæ­£ç¡®æ ‡è®° PARTIAL_SUCCESS
- âœ… sequence çº¦æŸéªŒè¯ï¼šæ•°æ®åº“æ‹’ç»è¶Šç•Œå€¼
- âœ… å¼‚å¸¸è®°å½•ï¼šä¸è¶³ 5 æ¡æ—¶è®°å½•è¯¦æƒ…ä½†ä¸å½±å“å·²ç”Ÿæˆå†…å®¹
- âœ… Token ç»Ÿè®¡ï¼šæ­£ç¡®è®°å½• prompt/completion tokens

**å·²å®Œæˆçš„æŠ€æœ¯å€º**ï¼š
- âœ… Prisma Client é‡æ–°ç”Ÿæˆ
- âœ… Worker Claude API è°ƒç”¨å®ç°
- âœ… å‰ç«¯ PARTIAL_SUCCESS çŠ¶æ€æ˜¾ç¤º

**SSE æ¨é€éªŒè¯**ï¼ˆ2025-01-15ï¼‰ï¼š
- âœ… çŠ¶æ€æµè½¬ï¼šQUEUED â†’ RUNNING â†’ PARTIAL_SUCCESS
- âœ… statusVersion é€’å¢ï¼š1 â†’ 2 â†’ 3
- âœ… äº‹ä»¶æ­£ç¡®æ¥æ”¶å’Œå»é‡
- âœ… å®Œæˆæ—¶è‡ªåŠ¨å…³é—­è¿æ¥

**å•†å®¶æˆå‘˜åŒæ­¥**ï¼š
- âœ… è„šæœ¬å®Œæˆï¼š`scripts/backfill-merchant-members.ts`
- âœ… ç”¨æˆ·æœ‰æ•ˆæ€§éªŒè¯
- âœ… è‡ªåŠ¨è¿‡æ»¤æ— æ•ˆå…³ç³»
- ğŸ“ ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼š`npx tsx scripts/backfill-merchant-members.ts`

**å‰©ä½™å·¥ä½œ**ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï¼š
- èµ„æ–™ç®¡ç†ç•Œé¢ï¼ˆæŠ¥å‘Šã€æç¤ºè¯ã€é™„ä»¶ CRUDï¼‰
- æ–‡æ¡ˆè¯¦æƒ…é¡µé¢ï¼ˆæŸ¥çœ‹ã€ç¼–è¾‘ã€ç‰ˆæœ¬å†å²ï¼‰
- æ•´æ‰¹/å•æ¡å†ç”Ÿæˆå‰ç«¯ç•Œé¢

### é£é™©ä¸å¾…åŠ
- éœ€è¦è¡¥å……å•†å®¶æˆå‘˜æ•°æ®çš„åˆå§‹åŒ–/åŒæ­¥è„šæœ¬ï¼Œä¿éšœè€ç”¨æˆ·èƒ½æ­£ç¡®è®¿é—®å¯¹åº”å•†å®¶ã€‚
- åç»­æµ‹è¯•éœ€è¦†ç›–â€œåŒå•†å®¶ä¸åŒæˆå‘˜å…±äº«è®¿é—®â€ä»¥åŠâ€œè·¨å•†å®¶æ‹’ç»â€å®Œæ•´æµç¨‹ï¼ŒåŒ…å« API ä¸é¡µé¢ç«¯åˆ°ç«¯ç”¨ä¾‹ã€‚

## æœªæ¥æ‰©å±•
- åˆ‡æ¢è‡³ Postgres åå¯ä½¿ç”¨åŸç”Ÿ partial unique/è§¦å‘å™¨ã€JSONB æŸ¥è¯¢ä¼˜åŒ–ã€‚
- å¼€æ”¾ç”Ÿæˆå‚æ•°ï¼ˆæ¸©åº¦ã€è¯­æ°”ï¼‰ï¼Œåœ¨ `creative_batches` ä¸­æ–°å¢å­—æ®µå³å¯ã€‚
- é™„ä»¶ OCR/æ‘˜è¦å¯æ”¯æŒå›¾ç‰‡/PDF å¤šæ¨¡æ€ï¼›å½“å‰ç»“æ„å·²é¢„ç•™ `summary` ä¸å¼•ç”¨å…³ç³»ã€‚
- å¼•å…¥æƒé™åˆ†çº§ã€æ‰¹æ¬¡å¯¼å‡ºï¼ˆCSV/Markdown æ‰“åŒ…ï¼‰ç­‰å¢å¼ºåŠŸèƒ½ã€‚

---
æ­¤æ–‡æ¡£ä½œä¸ºæ‰¹é‡æ–‡æ¡ˆç”Ÿæˆæ¨¡å—çš„æ•°æ®ä¸æµç¨‹åŸºçº¿ï¼Œä¾›åç»­è¿ç§»è„šæœ¬ã€API å®ç°ã€å‰ç«¯å¼€å‘å‚è€ƒã€‚*** End Patch
