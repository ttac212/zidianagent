# 商家信息编辑功能使用说明

## 功能概述
为商家数据中心添加了完整的编辑功能，管理员可以修改商家的基本信息、地址、分类等，解决了地址信息为空的问题。

## 功能特性

### ✅ 可编辑的字段
1. **基本信息**
   - 商家名称 *（必填）
   - 描述

2. **地址信息**
   - 所在地区（如：南宁）
   - 详细地址（如：广西 南宁 青秀区）

3. **分类和状态**
   - 商家分类（下拉选择）
   - 业务类型（B2C/B2B/B2B2C）
   - 状态（活跃/停用/暂停/已删除）

### 🔐 权限控制
- **仅管理员可编辑**：非管理员用户无法访问编辑功能
- **权限验证**：API 层面进行严格的权限检查

## 使用方法

### 1. 访问编辑功能

**步骤1**: 访问商家详情页
```
http://localhost:3007/merchants/{商家ID}
```

**步骤2**: 点击"编辑信息"按钮
- 位置：基本信息卡片的右上角
- 按钮：带铅笔图标的"编辑信息"按钮

### 2. 编辑商家信息

**对话框界面**：
- 标题："编辑商家信息"
- 说明："修改商家的基本信息和分类"

**可编辑字段**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 商家名称 | 文本输入 | ✅ | 商家的名称 |
| 描述 | 多行文本 | ❌ | 商家的详细描述（支持换行）|
| 所在地区 | 文本输入 | ❌ | 简短的地区信息（如：南宁）|
| 详细地址 | 文本输入 | ❌ | 完整地址（如：广西 南宁 青秀区）|
| 商家分类 | 下拉选择 | ❌ | 从现有分类中选择 |
| 业务类型 | 下拉选择 | ✅ | B2C/B2B/B2B2C |
| 状态 | 下拉选择 | ✅ | 活跃/停用/暂停/已删除 |

### 3. 保存修改

1. 填写或修改需要的字段
2. 点击"保存"按钮
3. 等待保存完成（显示"保存中..."）
4. 保存成功后显示提示："保存成功！即将关闭..."
5. 1秒后自动关闭对话框
6. 商家详情页面自动刷新，显示更新后的信息

### 4. 取消编辑

- 点击"取消"按钮或对话框外部区域
- 所有未保存的修改将被丢弃
- 表单重置为原始值

## 技术实现

### 新增文件

1. **`components/merchants/edit-merchant-dialog.tsx`** (295 行)
   - 编辑商家对话框组件
   - 表单验证
   - 状态管理
   - 成功/错误提示

2. **API 端点更新**
   - 文件：`app/api/merchants/[id]/route.ts`
   - 新增：`PATCH /api/merchants/[id]`
   - 功能：更新商家信息

### 修改文件

1. **`app/merchants/[id]/page.tsx`**
   - 引入 `EditMerchantDialog` 组件
   - 添加 `categories` 状态
   - 获取分类列表
   - 在基本信息卡片添加编辑按钮
   - 显示详细地址和更新时间

### API 规格

**请求**：
```http
PATCH /api/merchants/{id}
Content-Type: application/json

{
  "name": "商家名称",
  "description": "商家描述",
  "location": "南宁",
  "address": "广西 南宁 青秀区",
  "businessType": "B2C",
  "status": "ACTIVE",
  "categoryId": "category_id"
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "merchant": {
      "id": "...",
      "name": "...",
      ...
    }
  }
}
```

**权限要求**：
- 必须登录
- 用户角色必须为 `ADMIN`

**验证规则**：
- 商家名称不能为空
- 分类ID（如果提供）必须存在
- 所有文本字段会自动trim处理
- 空字符串会被转换为 `null`

## 使用场景

### 场景1：补充地址信息

由于TikHub API无法获取地址信息，管理员可以：

1. 访问商家详情页
2. 点击"编辑信息"
3. 填写"所在地区"：`南宁`
4. 填写"详细地址"：`广西 南宁 青秀区`
5. 保存

### 场景2：更正商家名称

1. 打开编辑对话框
2. 修改商家名称
3. 保存后立即在页面上看到更新

### 场景3：调整商家分类

1. 打开编辑对话框
2. 从下拉菜单选择新的分类
3. 保存后商家会显示新的分类标签

### 场景4：更改商家状态

1. 打开编辑对话框
2. 将状态从"活跃"改为"停用"
3. 保存后商家状态徽章更新

## 用户体验优化

### 实时反馈
- **保存中状态**：按钮显示加载图标和"保存中..."文本
- **成功提示**：绿色提示框显示"保存成功！即将关闭..."
- **错误提示**：红色提示框显示具体错误信息
- **自动关闭**：成功后1秒自动关闭对话框

### 数据保护
- **权限验证**：API层面验证管理员权限
- **数据验证**：必填字段检查
- **关联检查**：验证分类ID是否存在

### 界面友好
- **响应式布局**：适配移动端和桌面端
- **对话框滚动**：内容过多时可滚动查看
- **禁用状态**：保存时禁用所有输入
- **表单重置**：取消时恢复原始值

## 数据库更新示例

编辑操作会更新以下字段：

```sql
UPDATE merchants
SET
  name = '新商家名称',
  description = '新描述',
  location = '南宁',
  address = '广西 南宁 青秀区',
  businessType = 'B2C',
  status = 'ACTIVE',
  categoryId = 'cat_xxx',
  updatedAt = CURRENT_TIMESTAMP
WHERE id = 'merchant_id';
```

## 常见问题

### Q1: 我不是管理员，为什么看不到编辑按钮？
**A**: 编辑功能仅对管理员开放。请联系系统管理员升级您的权限。

### Q2: 保存时提示"只有管理员可以编辑商家信息"？
**A**: 您的会话可能已过期，请重新登录。

### Q3: 如何批量更新多个商家的地址？
**A**: 目前需要逐个编辑。批量编辑功能可在后续版本中添加。

### Q4: 地址信息可以为空吗？
**A**: 可以。地址信息不是必填字段，但建议补充完整以便数据分析。

### Q5: 编辑后原始数据会丢失吗？
**A**: 会被覆盖。系统会记录更新时间（`updatedAt`），但不保留历史版本。

## 后续优化建议

1. **批量编辑**：支持同时编辑多个商家
2. **历史记录**：记录编辑历史和操作日志
3. **字段验证**：添加更严格的地址格式验证
4. **自动补全**：地址输入支持自动补全
5. **权限细化**：支持不同级别的编辑权限
6. **数据导入**：通过Excel批量更新商家信息

---

## 相关文档

- **添加商家功能**：`docs/add-merchant-feature.md`
- **商家同步方案**：`docs/douyin-merchant-sync-plan.md`
- **用户地址测试**：`scripts/test-user-address.ts`
- **设置管理员**：`scripts/set-all-admin.ts`
