# 会话状态与实施总览

> 目的：沉淀当前会话的关键信息、代码修改、实施步骤与技术方案，供后续新会话延续工作使用（避免上下文长度限制）。
> 适用项目：Next.js 14（App Router）+ TypeScript + Tailwind CSS + NextAuth

---

## 1. 项目概览与状态

- 页面跳转优化（T1–T4）：已全部完成
  - T1：App Router 导航 + 过渡遮罩
  - T2：动态导入 fallback（ChatCenterSkeleton）
  - T3：页面内数据骨架（WorkspaceSkeleton）
  - T4：预取与细节增强（登录页预取、按需 refresh）
- 深度调研（P1）：进行中
  - P1-1：E2E 自动化测试（Playwright）最佳实践与落地指南（文档已完成）
  - P1-2：前端性能监控与埋点（Web Vitals + 自定义指标 + MVP 上报端点）已接入
- 下一步（P2）：骨架屏设计模式规范与最佳实践（页面/组件/数据三级骨架 + 最短显示时长策略）

---

## 2. T1–T4 实施记录（关键点与代码位置）

### T1. App Router 导航 + 过渡遮罩
- 目标：消除整页跳转白屏与“停-跳”闪烁；提供可感知过渡反馈
- 关键改动：
  - 登录/注册成功的跳转从 `window.location.href` 改为 `router.replace('/workspace')`
  - 新增过渡遮罩组件 RouteTransitionOverlay（挂载在登录页认证流程成功后）
- 主要文件：
  - components/auth/invite-code-auth.tsx（router.replace、redirecting 状态、按需 router.refresh）
  - components/ui/route-transition-overlay.tsx（过渡遮罩，P1-2 添加了可见时长埋点）

### T2. 动态导入 fallback（主聊天区）
- 目标：避免 SmartChatCenterV2 chunk 加载阶段出现主区空白
- 关键改动：
  - 为 dynamic 导入添加 `loading: () => <ChatCenterSkeleton />`
- 主要文件：
  - components/skeletons/chat-center-skeleton.tsx（骨架样式，已加 data-testid）
  - app/workspace/page.tsx（dynamic 的 loading 参数）

### T3. 页面内数据骨架（工作区）
- 目标：覆盖首次进入与“自动创建会话”阶段的数据加载空窗
- 关键改动：
  - 根据 `useConversations().loading` 在 page 层渲染 WorkspaceSkeleton
- 主要文件：
  - components/skeletons/workspace-skeleton.tsx（骨架样式，已加 data-testid）
  - app/workspace/page.tsx（loading 条件渲染骨架）

### T4. 预取与细节增强
- 目标：提升首次进入速度、修复细节
- 关键改动：
  - 登录页挂载时 `router.prefetch('/workspace')`
  - 登录/注册成功回调按需 `router.refresh()` 兜底会话可见性
  - 修正样式误拼 `text-left`
- 主要文件：
  - app/login/page.tsx、components/auth/invite-code-auth.tsx、app/workspace/page.tsx

> 详细过程与更多说明参见：docs/页面跳转优化实施记录.md

---

## 3. 代码变更清单（新增/修改）

### 新增文件
- components/ui/route-transition-overlay.tsx（过渡遮罩，含可见时长埋点）
- components/skeletons/chat-center-skeleton.tsx（主聊天区骨架）
- components/skeletons/workspace-skeleton.tsx（页面内数据骨架）
- lib/metrics.ts（Web Vitals + 自定义指标采集 SDK）
- app/api/metrics/route.ts（MVP 指标上报端点）
- docs/页面跳转优化实施记录.md（T1–T4 实施记录文档）
- docs/技术深度调研报告.md（E2E/监控/骨架/导航优化调研）

### 修改文件
- components/auth/invite-code-auth.tsx（App Router 导航、遮罩、按需 refresh）
- app/login/page.tsx（router.prefetch('/workspace')）
- app/workspace/page.tsx（dynamic fallback、loading 骨架、testid、样式修正）
- components/ui/route-transition-overlay.tsx（添加埋点 & testid）
- components/skeletons/workspace-skeleton.tsx（添加 testid）
- components/skeletons/chat-center-skeleton.tsx（添加 testid）
- docs/页面跳转优化实施记录.md（进度与总结）
- docs/技术深度调研报告.md（第3章 E2E、第4章监控扩展）

---

## 4. 前端性能监控与埋点（P1-2）

### 4.1 集成方案
- Metrics SDK：lib/metrics.ts（sendBeacon 优先，fetch keepalive 兜底；支持 sampleRate 与基础 tags）
- Web Vitals：LCP/INP/CLS/TTFB/FCP 统一上报（Metrics.setupWebVitals）
- 自定义指标：
  - login_to_interactive：从登录按钮点击到工作区可互动
  - route_transition_overlay_visible_dur：过渡遮罩可见时长（已接入）
  - workspace_skeleton_visible_dur / chat_center_skeleton_visible_dur：骨架可见时长（可在 skeleton 组件挂载/卸载时注入）
  - chunk_load_dur/error：动态 chunk 加载耗时/错误（可在 dynamic/fallback 周边埋点）
- 上报端点：/api/metrics（MVP，当前写 server log；后续接 APM/数据库）

### 4.2 关键代码片段（示例）
- 初始化与 Web Vitals：
```ts
// 在客户端根（如 layout 的客户端层）注入
useEffect(() => { Metrics.init({ app: 'zhidian-ai-platform', sampleRate: 1 }); Metrics.setupWebVitals() }, [])
```
- 登录 → 可互动：
```ts
Metrics.mark('login_click')
// Chat 中心 ready:
Metrics.mark('workspace_interactive')
Metrics.measure('login_to_interactive','login_click','workspace_interactive',{ tags:{ page:'workspace' } })
```
- 遮罩/骨架可见时长：
```ts
const tracker = Metrics.startEndTracker('route_transition_overlay'); tracker.start(); /* unmount */ tracker.end()
```

### 4.3 阈值建议（正常网）
- login_to_interactive < 2000ms
- route_transition_overlay_visible_dur < 800ms
- workspace_skeleton_visible_dur < 1500ms；慢网 < 3000ms
- chat_center_skeleton_visible_dur < 1200ms

### 4.4 APM 集成建议
- Sentry（@sentry/nextjs）或 Datadog RUM；从 /api/metrics 迁移/并行上报，建立可视化看板与报警。

---

## 5. E2E 自动化测试（P1-1）

### 5.1 目录结构建议
```
/e2e
  ├─ auth.spec.ts
  ├─ workspace.spec.ts
  ├─ protected-api.spec.ts
  └─ helpers.ts
/playwright.config.ts
```

### 5.2 playwright.config.ts 示例（要点）
```ts
export default defineConfig({
  testDir: './e2e',
  use: { baseURL: 'http://localhost:3000', trace: 'on-first-retry' },
  webServer: { command: 'pnpm dev', url: 'http://localhost:3000', reuseExistingServer: true }
})
```

### 5.3 用例要点（覆盖 T1–T4）
- 登录 → 遮罩 → /workspace 骨架 → Chat 内容就绪：
  - 断言 `data-testid="route-transition-overlay"` 可见
  - 断言 `data-testid="workspace-skeleton"` 可见，随后隐藏
  - 断言 `data-testid="chat-center-skeleton"`（慢网时更明显）
  - 断言 `data-testid="chat-center"` 可见
- 受保护接口校验：
  - 未登录访问 /workspace → 重定向 /login
  - 已登录调用 /api/chat → 200（使用 storageState 复用会话）
- 慢网模拟：对路由 `page.route('**/*', ...)` 注入延迟

> 详见：docs/技术深度调研报告.md 第3章（已给出完整示例）

---

## 6. 当前任务状态与下一步

### 6.1 已完成
- T1–T4 全部完成并在生产代码中落地
- E2E（文档与示例）：已完成文档编写与落地指南
- 监控与埋点（MVP）：SDK + API 上报端点 + 遮罩可见时长埋点接入

### 6.2 待完成/建议
- 在 InviteCodeAuth 登录按钮点击前注入 `Metrics.mark('login_click')`
- 在 SmartChatCenterV2 ready 时注入 `Metrics.mark('workspace_interactive')` 与 `Metrics.measure('login_to_interactive', ...)`
- 在 WorkspaceSkeleton/ChatCenterSkeleton 组件挂载/卸载处注入 `startEndTracker('..._skeleton')`
- 安装 web-vitals：`pnpm add web-vitals`
- 如上线后会话可见性稳定，移除 `router.refresh()` 或加环境开关
- P2：骨架屏设计模式规范与最短显示时长策略，统一组件库与用法

---

## 7. 快速验证清单（Smoke）

- 功能流：登录 → 遮罩 → /workspace 骨架 → 内容就绪（无白屏/闪烁）
- 慢网环境：遮罩与骨架稳定可见且平滑过渡
- 受保护：未登录访问 /workspace → /login；已登录 /api/chat → 200
- 监控：服务器日志出现 `[METRICS]` 事件；可见 route_transition_overlay_visible_dur
- E2E：可运行 `playwright test`（在添加测试目录后）并通过核心用例

---

## 8. 参考文档（内部）
- 页面跳转优化实施记录：docs/页面跳转优化实施记录.md
- 技术深度调研报告：docs/技术深度调研报告.md（E2E 第3章、监控第4章）

---

本文件将作为新会话的上下文基线使用，后续请在此基础上继续推进 P2（骨架屏设计模式）与监控/E2E 的进一步完善。
