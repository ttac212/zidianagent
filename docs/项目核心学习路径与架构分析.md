# æ™ºç‚¹AIå¹³å° - æ ¸å¿ƒæ¶æ„æ·±åº¦åˆ†æä¸å­¦ä¹ è·¯å¾„

> æœ¬æ–‡æ¡£æ—¨åœ¨å¸®åŠ©å¼€å‘è€…å¿«é€Ÿç†è§£é¡¹ç›®æ ¸å¿ƒæ¶æ„ï¼ŒæŒæ¡å…³é”®æŠ€æœ¯è·¯å¾„ï¼Œçªç ´ä»£ç ç†è§£ç“¶é¢ˆã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæ•°æ®æµå›¾](#ä¸€æ ¸å¿ƒæ•°æ®æµå›¾)
2. [å¿…è¯»æ–‡ä»¶æ¸…å•](#äºŒå¿…è¯»æ–‡ä»¶æ¸…å•æŒ‰å­¦ä¹ é¡ºåº)
3. [å…³é”®æ¦‚å¿µæ¸…å•](#ä¸‰å…³é”®æ¦‚å¿µæ¸…å•)
4. [ä»£ç ä¸­çš„é‡è¦æ¨¡å¼](#å››ä»£ç ä¸­çš„é‡è¦æ¨¡å¼)
5. [å­¦ä¹ è·¯å¾„å»ºè®®](#äº”å­¦ä¹ è·¯å¾„å»ºè®®)
6. [å¿«é€ŸæŸ¥æ‰¾æŠ€å·§](#å…­å¿«é€ŸæŸ¥æ‰¾ä»£ç åŠŸèƒ½çš„æŠ€å·§)
7. [æ¯å‘¨éªŒè¯ç›®æ ‡](#ä¸ƒæ¯å‘¨éªŒè¯ç›®æ ‡)

---

## ä¸€ã€æ ¸å¿ƒæ•°æ®æµå›¾

### 1.1 èŠå¤©æ¶ˆæ¯å®Œæ•´é“¾è·¯ï¼ˆä»ç”¨æˆ·è¾“å…¥åˆ°AIå“åº”ï¼‰

```
ç”¨æˆ·è¾“å…¥
  â†“
[å‰ç«¯] SmartChatCenterç»„ä»¶
  â†“
[å‰ç«¯Hook] useChatActions.sendMessage()
  â”œâ”€ åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ï¼ˆæœ¬åœ°IDç”Ÿæˆï¼‰
  â”œâ”€ å‘é€startedäº‹ä»¶ â†’ Reduceræ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  â”œâ”€ trimForChatAPI()è£å‰ªå†å²ä¸Šä¸‹æ–‡
  â””â”€ fetch('/api/chat', { messages, model, settings })
      â†“
[ä¸­é—´ä»¶] middleware.ts
  â”œâ”€ éªŒè¯JWT tokenï¼ˆNextAuthï¼‰
  â”œâ”€ é€Ÿç‡é™åˆ¶æ£€æŸ¥
  â””â”€ æ³¨å…¥userIdåˆ°header
      â†“
[APIè·¯ç”±] app/api/chat/route.ts
  â”œâ”€ 1. è®¤è¯éªŒè¯ï¼ˆgetTokenï¼‰
  â”œâ”€ 2. é€Ÿç‡é™åˆ¶æ£€æŸ¥ï¼ˆcheckRateLimitï¼‰
  â”œâ”€ 3. åŸå­æ€§é…é¢é¢„ç•™ï¼ˆQuotaManager.reserveTokensï¼‰
  â”œâ”€ 4. æœåŠ¡ç«¯ä¸Šä¸‹æ–‡è£å‰ªï¼ˆtrimForChatAPIï¼‰
  â”œâ”€ 5. å¯¹è¯å½’å±æƒéªŒè¯ï¼ˆPrismaæŸ¥è¯¢ï¼‰
  â”œâ”€ 6. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯ï¼ˆQuotaManager.commitTokensï¼‰
  â”œâ”€ 7. é€‰æ‹©AI Providerï¼ˆselectProviderï¼‰
  â”œâ”€ 8. æ„å»ºè¯·æ±‚ï¼ˆbuildChatRequestï¼‰
  â””â”€ 9. è°ƒç”¨AI APIï¼ˆfetch with SSEï¼‰
      â†“
[AI Provider] ZenMux/302.AI
  â””â”€ è¿”å›SSEæµå¼å“åº”
      â†“
[APIè·¯ç”±] SSE Transform Stream
  â”œâ”€ createSSETransformStreamè§£æå“åº”
  â”œâ”€ ç´¯ç§¯å®Œæ•´contentå’Œreasoning
  â””â”€ æµå¼ä¼ è¾“ç»™å®¢æˆ·ç«¯
      â†“
[å‰ç«¯Hook] processSSEStream()
  â”œâ”€ è§£æSSEäº‹ä»¶ï¼ˆparseSSEChunkï¼‰
  â”œâ”€ å‘é€chunkäº‹ä»¶ â†’ Reduceræ›´æ–°æµå¼å†…å®¹
  â”œâ”€ ç´¯ç§¯å®Œæ•´å“åº”
  â””â”€ å‘é€doneäº‹ä»¶ â†’ Reduceræ ‡è®°å®Œæˆ
      â†“
[APIè·¯ç”±] onCompleteå›è°ƒ
  â”œâ”€ ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯ï¼ˆQuotaManager.commitTokensï¼‰
  â”œâ”€ æ›´æ–°å¯¹è¯ç»Ÿè®¡ï¼ˆlastMessageAt, messageCountï¼‰
  â””â”€ è°ƒæ•´é…é¢å·®é¢ï¼ˆå®é™…token - é¢„ç•™tokenï¼‰
      â†“
[å‰ç«¯] React Queryç¼“å­˜æ›´æ–°
  â”œâ”€ setQueriesDataæ›´æ–°å¯¹è¯è¯¦æƒ…ç¼“å­˜
  â”œâ”€ setQueriesDataæ›´æ–°å¯¹è¯åˆ—è¡¨ç¼“å­˜
  â””â”€ UIè‡ªåŠ¨é‡æ¸²æŸ“æ˜¾ç¤ºæ–°æ¶ˆæ¯
```

### 1.2 è®¤è¯ç³»ç»Ÿæ•°æ®æµ

```
ç”¨æˆ·è®¿é—®é¡µé¢
  â†“
[ä¸­é—´ä»¶] middleware.ts
  â”œâ”€ æ£€æŸ¥è·¯å¾„æ˜¯å¦éœ€è¦è®¤è¯
  â””â”€ éªŒè¯JWT tokenï¼ˆgetTokenï¼‰
      â”œâ”€ æœ‰æ•ˆ â†’ ç»§ç»­è¯·æ±‚
      â””â”€ æ— æ•ˆ â†’ é‡å®šå‘åˆ°/login
          â†“
[ç™»å½•é¡µ] app/login/page.tsx
  â””â”€ ç”¨æˆ·è¾“å…¥é‚®ç®±+è®¤è¯ç 
      â†“
[NextAuth] signIn('credentials', { email, code })
  â†“
[è®¤è¯é…ç½®] auth.ts
  â””â”€ Credentials Provider â†’ authorize()
      â†“
[è®¤è¯ç­–ç•¥] auth/strategies/index.ts
  â”œâ”€ ç¯å¢ƒæ£€æµ‹ï¼ˆproduction vs developmentï¼‰
  â””â”€ é€‰æ‹©ç­–ç•¥
      â”œâ”€ å¼€å‘ç¯å¢ƒï¼šdevelopmentAuth
      â”‚   â”œâ”€ éªŒè¯DEV_LOGIN_CODE
      â”‚   â”œâ”€ æŸ¥è¯¢æˆ–åˆ›å»ºç”¨æˆ·ï¼ˆè‡ªåŠ¨æ³¨å†Œï¼‰
      â”‚   â””â”€ è¿”å›ç”¨æˆ·å¯¹è±¡
      â””â”€ ç”Ÿäº§ç¯å¢ƒï¼šproductionAuth
          â”œâ”€ éªŒè¯ADMIN_LOGIN_PASSWORD
          â”œâ”€ ä»…æŸ¥è¯¢å·²å­˜åœ¨ç”¨æˆ·ï¼ˆä¸è‡ªåŠ¨åˆ›å»ºï¼‰
          â””â”€ è¿”å›ç”¨æˆ·å¯¹è±¡æˆ–null
              â†“
[JWTå›è°ƒ] auth.ts â†’ jwt callback
  â”œâ”€ å°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥token
  â””â”€ è¿”å›åŒ…å«userIdã€roleã€é…é¢ç­‰çš„token
      â†“
[Sessionå›è°ƒ] auth.ts â†’ session callback
  â”œâ”€ ä»tokenæå–ä¿¡æ¯
  â””â”€ æ³¨å…¥åˆ°session.userä¾›å®¢æˆ·ç«¯è®¿é—®
```

### 1.3 é…é¢ç®¡ç†åŸå­æ€§æ•°æ®æµ

```
è¯·æ±‚åˆ°è¾¾ â†’ APIè·¯ç”±
  â†“
QuotaManager.reserveTokens(userId, estimatedTokens)
  â”œâ”€ checkAndResetMonthlyUsage()ï¼ˆè‡ªåŠ¨æœˆåº¦é‡ç½®ï¼‰
  â”œâ”€ åŸå­æ€§SQLæ›´æ–°ï¼ˆWHEREæ¡ä»¶ä¿è¯ä¸è¶…é™ï¼‰
  â”‚   UPDATE users
  â”‚   SET currentMonthUsage = currentMonthUsage + estimatedTokens
  â”‚   WHERE id = userId
  â”‚   AND currentMonthUsage + estimatedTokens <= monthlyTokenLimit
  â””â”€ è¿”å›ç»“æœ
      â”œâ”€ æˆåŠŸ â†’ ç»§ç»­æ‰§è¡Œ
      â””â”€ å¤±è´¥ â†’ è¿”å›429é”™è¯¯
          â†“
AIè°ƒç”¨å®Œæˆ â†’ è·å¾—å®é™…tokenä½¿ç”¨é‡
  â†“
QuotaManager.commitTokens(userId, actualTokens, estimatedTokens, messageData)
  â”œâ”€ è®¡ç®—å·®é¢ï¼šadjustment = actualTokens - estimatedTokens
  â”œâ”€ äº‹åŠ¡æ‰§è¡Œï¼š
  â”‚   â”œâ”€ åˆ›å»ºMessageè®°å½•ï¼ˆåŒ…å«promptTokensã€completionTokensï¼‰
  â”‚   â”œâ”€ åŸå­æ€§è°ƒæ•´ç”¨æˆ·é…é¢ï¼ˆæŒ‰å·®é¢å¢å‡ï¼‰
  â”‚   â””â”€ æ›´æ–°Conversationç»Ÿè®¡ï¼ˆmessageCount, totalTokensï¼‰
  â””â”€ æäº¤äº‹åŠ¡
      â†“
å¤±è´¥åœºæ™¯ â†’ QuotaManager.releaseTokens()
  â””â”€ åŸå­æ€§è¿”è¿˜é¢„ç•™é…é¢
      UPDATE users
      SET currentMonthUsage = currentMonthUsage - estimatedTokens
      WHERE id = userId AND currentMonthUsage >= estimatedTokens
```

---

## äºŒã€å¿…è¯»æ–‡ä»¶æ¸…å•ï¼ˆæŒ‰å­¦ä¹ é¡ºåºï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®æ¨¡å‹å’Œç±»å‹å®šä¹‰ï¼ˆç†è§£ç³»ç»Ÿéª¨æ¶ï¼‰

#### 1. `prisma/schema.prisma` - æ•°æ®åº“æ¨¡å‹å®šä¹‰
- **ä½œç”¨**ï¼šå®šä¹‰æ‰€æœ‰æ ¸å¿ƒå®ä½“å’Œå…³ç³»ï¼ˆUserã€Conversationã€Messageã€UsageStatsç­‰ï¼‰
- **é‡ç‚¹**ï¼šç†è§£å†—ä½™å­—æ®µè®¾è®¡ï¼ˆuserId in Messageã€lastMessageAt in Conversationï¼‰
- **å­¦ä¹ ç‚¹**ï¼šç´¢å¼•ä¼˜åŒ–ç­–ç•¥ã€JSONå­—æ®µçµæ´»å­˜å‚¨

#### 2. `types/chat.ts` - å‰ç«¯ç±»å‹å®šä¹‰
- **ä½œç”¨**ï¼šå®šä¹‰æ‰€æœ‰èŠå¤©ç›¸å…³çš„TypeScriptç±»å‹
- **é‡ç‚¹**ï¼šChatMessageã€Conversationã€ChatStateã€ChatActionã€ChatEventç±»å‹
- **å­¦ä¹ ç‚¹**ï¼šReducerçŠ¶æ€ç®¡ç†æ¨¡å¼ã€äº‹ä»¶é©±åŠ¨æ¶æ„

### ç¬¬äºŒé˜¶æ®µï¼šè®¤è¯å’Œå®‰å…¨ï¼ˆç†è§£æƒé™æ§åˆ¶ï¼‰

#### 3. `auth.ts` - NextAuthé…ç½®
- **ä½œç”¨**ï¼šé…ç½®è®¤è¯æä¾›å•†å’Œå›è°ƒ
- **é‡ç‚¹**ï¼šJWTç­–ç•¥ã€session/tokenæ‰©å±•ã€Credentials Provider
- **å­¦ä¹ ç‚¹**ï¼šç±»å‹æ‰©å±•ï¼ˆdeclare moduleï¼‰ã€åŒæ¨¡å¼è®¤è¯è®¾è®¡

#### 4. `auth/strategies/index.ts` - è®¤è¯ç­–ç•¥é€‰æ‹©å™¨
- **ä½œç”¨**ï¼šæ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©è®¤è¯ç­–ç•¥
- **é‡ç‚¹**ï¼šç­–ç•¥æ¨¡å¼å®ç°ã€å¼€å‘/ç”Ÿäº§ç¯å¢ƒéš”ç¦»
- **å­¦ä¹ ç‚¹**ï¼šç¯å¢ƒå˜é‡æ£€æŸ¥ã€å®‰å…¨é˜²æŠ¤

#### 5. `middleware.ts` - è¯·æ±‚æ‹¦æˆªå™¨
- **ä½œç”¨**ï¼šè·¯ç”±çº§æƒé™æ§åˆ¶å’ŒtokenéªŒè¯
- **é‡ç‚¹**ï¼šå…¬å¼€/å—ä¿æŠ¤è·¯å¾„é…ç½®ã€è§’è‰²æ£€æŸ¥
- **å­¦ä¹ ç‚¹**ï¼šNextJSä¸­é—´ä»¶æ¨¡å¼ã€headeræ³¨å…¥

### ç¬¬ä¸‰é˜¶æ®µï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆç†è§£èŠå¤©ç³»ç»Ÿï¼‰

#### 6. `app/api/chat/route.ts` - èŠå¤©APIè·¯ç”±ï¼ˆâ˜…æ ¸å¿ƒâ˜…ï¼‰
- **ä½œç”¨**ï¼šå¤„ç†èŠå¤©è¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- **é‡ç‚¹**ï¼š
  - è®¤è¯â†’é€Ÿç‡é™åˆ¶â†’é…é¢é¢„ç•™â†’æƒé™éªŒè¯â†’AIè°ƒç”¨â†’æµå¼å“åº”â†’é…é¢æäº¤
  - æŠ–éŸ³é“¾æ¥æ£€æµ‹å’ŒPipelineå¤„ç†
  - SSEæµå¼å¤„ç†å’ŒTransform Stream
- **å­¦ä¹ ç‚¹**ï¼šåŸå­æ€§æ“ä½œã€é”™è¯¯æ¢å¤ã€æµå¼æ¶æ„

#### 7. `hooks/use-chat-actions.ts` - å‰ç«¯èŠå¤©æ“ä½œHook
- **ä½œç”¨**ï¼šå°è£…æ¶ˆæ¯å‘é€ã€ä¸­æ­¢ã€SSEè§£æé€»è¾‘
- **é‡ç‚¹**ï¼š
  - AbortControllerç®¡ç†
  - äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆstartedâ†’chunkâ†’done/errorï¼‰
  - React Queryç¼“å­˜æ›´æ–°
- **å­¦ä¹ ç‚¹**ï¼šè‡ªå®šä¹‰Hookè®¾è®¡ã€æµå¼æ•°æ®å¤„ç†

#### 8. `components/chat/chat-reducer.ts` - èŠå¤©çŠ¶æ€ç®¡ç†
- **ä½œç”¨**ï¼šç»Ÿä¸€çš„èŠå¤©çŠ¶æ€Reducer
- **é‡ç‚¹**ï¼š
  - æ¶ˆæ¯çŠ¶æ€å­—æ®µï¼ˆstatus: pending/streaming/completed/errorï¼‰
  - PipelineçŠ¶æ€ç®¡ç†
  - SessionçŠ¶æ€æœº
- **å­¦ä¹ ç‚¹**ï¼šReduceræ¨¡å¼ã€çŠ¶æ€æœºè®¾è®¡

### ç¬¬å››é˜¶æ®µï¼šå…³é”®å·¥å…·åº“ï¼ˆç†è§£æŠ€æœ¯å®ç°ï¼‰

#### 9. `lib/chat/context-trimmer.ts` - ä¸Šä¸‹æ–‡è£å‰ªå™¨
- **ä½œç”¨**ï¼šå‰åç«¯å…±äº«çš„æ¶ˆæ¯è£å‰ªé€»è¾‘
- **é‡ç‚¹**ï¼š
  - Tokenä¼°ç®—ç®—æ³•ï¼ˆä¸­æ–‡1.5å­—ç¬¦/tokenã€è‹±æ–‡4å­—ç¬¦/tokenï¼‰
  - æŒ‰æ¨¡å‹åŠ¨æ€é…ç½®é™åˆ¶
  - ä¿ç•™æœ€æ–°æ¶ˆæ¯ç­–ç•¥
- **å­¦ä¹ ç‚¹**ï¼šå‰åç«¯é€»è¾‘å¤ç”¨ã€é˜²å¾¡æ€§ç¼–ç¨‹

#### 10. `lib/security/quota-manager.ts` - é…é¢ç®¡ç†å™¨ï¼ˆâ˜…æ ¸å¿ƒâ˜…ï¼‰
- **ä½œç”¨**ï¼šåŸå­æ€§Tokené…é¢ç®¡ç†
- **é‡ç‚¹**ï¼š
  - reserveTokens()é¢„ç•™é…é¢ï¼ˆåŸå­SQLï¼‰
  - commitTokens()æäº¤å®é™…ä½¿ç”¨é‡ï¼ˆäº‹åŠ¡ï¼‰
  - releaseTokens()å¤±è´¥å›æ»š
  - æœˆåº¦è‡ªåŠ¨é‡ç½®
- **å­¦ä¹ ç‚¹**ï¼šåŸå­æ“ä½œã€æ•°æ®åº“äº‹åŠ¡ã€å¹¶å‘å®‰å…¨

#### 11. `lib/utils/sse-parser.ts` - SSEè§£æå·¥å…·
- **ä½œç”¨**ï¼šè§£æServer-Sent Eventsæµå¼å“åº”
- **é‡ç‚¹**ï¼š
  - è·¨chunkæ•°æ®å®Œæ•´æ€§å¤„ç†
  - å¤šProvideræ ¼å¼å½’ä¸€åŒ–ï¼ˆOpenAI/Claude/302.AIï¼‰
  - TransformStreamå®ç°
- **å­¦ä¹ ç‚¹**ï¼šæµå¼è§£æã€UTF-8å¤šå­—èŠ‚å¤„ç†ã€å…¼å®¹æ€§è®¾è®¡

#### 12. `lib/ai/provider-manager.ts` - AIæä¾›å•†ç®¡ç†å™¨
- **ä½œç”¨**ï¼šå¤šAI ProvideræŠ½è±¡å’Œé€‰æ‹©
- **é‡ç‚¹**ï¼š
  - ä¼˜å…ˆçº§è·¯ç”±ï¼ˆZenMux â†’ 302.AIï¼‰
  - æ¨¡å‹IDè½¬æ¢
  - è¯·æ±‚æ„å»ºé€‚é…
- **å­¦ä¹ ç‚¹**ï¼šProvideræ¨¡å¼ã€é…ç½®é©±åŠ¨

### ç¬¬äº”é˜¶æ®µï¼šæ•°æ®æŸ¥è¯¢å’Œç¼“å­˜ï¼ˆç†è§£React Queryï¼‰

#### 13. `hooks/api/use-conversations-query.ts` - å¯¹è¯æŸ¥è¯¢Hooks
- **ä½œç”¨**ï¼šReact Queryå°è£…çš„å¯¹è¯æ•°æ®è·å–
- **é‡ç‚¹**ï¼š
  - queryKeyç»“æ„è®¾è®¡
  - æ•°æ®è½¬æ¢ï¼ˆAPI â†’ å‰ç«¯æ ¼å¼ï¼‰
  - ç¼“å­˜ç­–ç•¥ï¼ˆstaleTimeã€gcTimeï¼‰
- **å­¦ä¹ ç‚¹**ï¼šReact Queryæ¨¡å¼ã€æ•°æ®æ ‡å‡†åŒ–

#### 14. `lib/prisma.ts` - Prismaå®¢æˆ·ç«¯å•ä¾‹
- **ä½œç”¨**ï¼šæ•°æ®åº“è¿æ¥ç®¡ç†
- **é‡ç‚¹**ï¼š
  - å•ä¾‹æ¨¡å¼é˜²æ­¢è¿æ¥æ³„æ¼
  - SQLiteä¼˜åŒ–é…ç½®
  - å¼€å‘ç¯å¢ƒçƒ­é‡è½½å¤„ç†
- **å­¦ä¹ ç‚¹**ï¼šè¿æ¥æ± ç®¡ç†ã€ç¯å¢ƒé€‚é…

---

## ä¸‰ã€å…³é”®æ¦‚å¿µæ¸…å•

### 3.1 æ¶æ„æ¨¡å¼

#### 1. äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEvent-Driven Architectureï¼‰
- èŠå¤©æµç¨‹é€šè¿‡äº‹ä»¶é€šä¿¡ï¼š`started` â†’ `chunk` â†’ `done`/`error`
- å‰ç«¯é€šè¿‡`onEvent`å›è°ƒå¤„ç†äº‹ä»¶ï¼ŒReducerå“åº”çŠ¶æ€å˜åŒ–
- **ä¼˜ç‚¹**ï¼šè§£è€¦å‰åç«¯ã€æ”¯æŒæµå¼å¤„ç†ã€æ˜“äºæ‰©å±•

#### 2. Reduceræ¨¡å¼ï¼ˆFlux/Reduxï¼‰
- æ‰€æœ‰çŠ¶æ€å˜æ›´é€šè¿‡`dispatch(action)`è§¦å‘
- å•ä¸€æ•°æ®æºï¼ˆ`ChatState`ï¼‰
- æ—¶é—´æ—…è¡Œè°ƒè¯•ã€å¯é¢„æµ‹çš„çŠ¶æ€å˜æ›´

#### 3. åŸå­æ€§æ“ä½œï¼ˆAtomic Operationsï¼‰
- é…é¢ç®¡ç†ä½¿ç”¨SQLæ¡ä»¶æ›´æ–°ï¼š`WHERE currentUsage + delta <= limit`
- é¿å…ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰
- ç¡®ä¿å¹¶å‘å®‰å…¨

#### 4. ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰
- è®¤è¯ç­–ç•¥ï¼šå¼€å‘ç¯å¢ƒè‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼Œç”Ÿäº§ç¯å¢ƒä»…éªŒè¯
- AI Providerç­–ç•¥ï¼šæ ¹æ®æ¨¡å‹é€‰æ‹©æä¾›å•†
- å¯æ’æ‹”ã€æ˜“äºæµ‹è¯•

#### 5. æµå¼å¤„ç†ï¼ˆStreamingï¼‰
- SSEï¼ˆServer-Sent Eventsï¼‰ä¼ è¾“
- TransformStreamç®¡é“å¤„ç†
- é™ä½é¦–å­—å“åº”æ—¶é—´ï¼ˆTTFBï¼‰

### 3.2 æ•°æ®åº“è®¾è®¡ç†å¿µ

#### 1. å†—ä½™å­—æ®µä¼˜åŒ–æŸ¥è¯¢
- `Message.userId`ï¼šé¿å…JOINæŸ¥è¯¢é…é¢ç»Ÿè®¡
- `Conversation.lastMessageAt`ï¼šä¼˜åŒ–å¯¹è¯åˆ—è¡¨æ’åº
- `Conversation.messageCount/totalTokens`ï¼šé¿å…å®æ—¶èšåˆ

#### 2. ç´¢å¼•ç­–ç•¥
- å¤åˆç´¢å¼•ï¼š`@@index([userId, lastMessageAt(sort: Desc)])`
- è¦†ç›–æŸ¥è¯¢ï¼šå‡å°‘å›è¡¨
- å‰ç¼€åŒ¹é…ï¼šæ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢

#### 3. JSONå­—æ®µçµæ´»å­˜å‚¨
- `Conversation.metadata`ï¼šå›ºå®šæ ‡ç­¾ã€ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
- `Message.metadata`ï¼šæ¨ç†å†…å®¹ã€PipelineçŠ¶æ€
- é¿å…é¢‘ç¹schemaå˜æ›´

### 3.3 å‰ç«¯æŠ€æœ¯

#### 1. React Queryï¼ˆTanStack Query v5ï¼‰
- æœåŠ¡å™¨çŠ¶æ€ç®¡ç†
- è‡ªåŠ¨ç¼“å­˜ã€é‡è¯•ã€åå°æ›´æ–°
- ä¹è§‚æ›´æ–°ï¼ˆOptimistic Updatesï¼‰

#### 2. React 19ç‰¹æ€§
- useReducerå¤æ‚çŠ¶æ€ç®¡ç†
- Suspenseå¼‚æ­¥ç»„ä»¶
- Concurrent Modeå¹¶å‘æ¸²æŸ“

#### 3. TypeScriptä¸¥æ ¼æ¨¡å¼
- ç±»å‹å®‰å…¨
- IDEæ™ºèƒ½æç¤º
- ç¼–è¯‘æ—¶é”™è¯¯æ£€æµ‹

### 3.4 å®‰å…¨å’Œæ€§èƒ½

#### 1. JWTç­–ç•¥ï¼ˆStatelessï¼‰
- æ— éœ€æ•°æ®åº“sessionè¡¨
- æ°´å¹³æ‰©å±•å‹å¥½
- Tokenæœ‰æ•ˆæœŸæ§åˆ¶

#### 2. é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰
- é˜²æ­¢APIæ»¥ç”¨
- åˆ†å¸ƒå¼ï¼šUpstash Redis
- æœ¬åœ°ï¼šå†…å­˜Map

#### 3. é…é¢ç®¡ç†ï¼ˆQuota Managementï¼‰
- æœˆåº¦é‡ç½®è‡ªåŠ¨åŒ–
- å®æ—¶ç»Ÿè®¡
- åŸå­æ€§ä¿è¯

#### 4. è™šæ‹Ÿæ»šåŠ¨ï¼ˆVirtual Scrollingï¼‰
- 100+æ¶ˆæ¯è§¦å‘
- å‡å°‘DOMèŠ‚ç‚¹
- æå‡æ¸²æŸ“æ€§èƒ½

---

## å››ã€ä»£ç ä¸­çš„é‡è¦æ¨¡å¼

### 4.1 è®¾è®¡æ¨¡å¼

#### 1. å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰
```typescript
// lib/prisma.ts
const globalForPrisma = global as unknown as { prisma: PrismaClient }
export const prisma = globalForPrisma.prisma || new PrismaClient(...)
if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```
**ç”¨é€”**ï¼šç¡®ä¿æ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªPrismaå®¢æˆ·ç«¯å®ä¾‹ï¼Œé˜²æ­¢è¿æ¥æ³„æ¼ã€‚

#### 2. å·¥å‚æ¨¡å¼ï¼ˆFactoryï¼‰
```typescript
// lib/ai/provider-manager.ts
export function selectProvider(modelId: string): LLMProvider | null {
  if (modelId.includes('/')) return zenmux
  return providers[0]
}
```
**ç”¨é€”**ï¼šæ ¹æ®æ¨¡å‹IDåŠ¨æ€åˆ›å»ºä¸åŒçš„Providerå®ä¾‹ã€‚

#### 3. ç­–ç•¥æ¨¡å¼ï¼ˆStrategyï¼‰
```typescript
// auth/strategies/index.ts
export function selectAuthStrategy(): AuthStrategy {
  return isProduction ? productionAuth : developmentAuth
}
```
**ç”¨é€”**ï¼šè¿è¡Œæ—¶é€‰æ‹©è®¤è¯ç­–ç•¥ï¼Œé¿å…æ¡ä»¶åˆ†æ”¯ã€‚

#### 4. è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserverï¼‰
```typescript
// hooks/use-chat-actions.ts
onEvent?.({ type: 'chunk', content: delta })
```
**ç”¨é€”**ï¼šé€šè¿‡å›è°ƒé€šçŸ¥çŠ¶æ€å˜åŒ–ï¼Œè§£è€¦ç»„ä»¶å’Œä¸šåŠ¡é€»è¾‘ã€‚

#### 5. ä¸­é—´ä»¶æ¨¡å¼ï¼ˆMiddlewareï¼‰
```typescript
// middleware.ts
export default async function middleware(req: NextRequest) {
  // è®¤è¯æ£€æŸ¥ â†’ æƒé™éªŒè¯ â†’ æ³¨å…¥ä¸Šä¸‹æ–‡
}
```
**ç”¨é€”**ï¼šè¯·æ±‚æ‹¦æˆªã€æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆè®¤è¯ã€æ—¥å¿—ã€é™æµï¼‰ã€‚

### 4.2 æ¶æ„å†³ç­–

#### 1. å‰åç«¯ä¸Šä¸‹æ–‡è£å‰ªç»Ÿä¸€
**å†³ç­–**ï¼š`trimForChatAPI()`åŒæ—¶ç”¨äºå‰ç«¯å’ŒAPIè·¯ç”±

**ç†ç”±**ï¼š
- é¿å…é€»è¾‘é‡å¤
- é˜²æ­¢å®¢æˆ·ç«¯ç»•è¿‡é™åˆ¶
- ç¡®ä¿è¡Œä¸ºä¸€è‡´æ€§

#### 2. React Queryç¼“å­˜æ›´æ–°ç­–ç•¥
**å†³ç­–**ï¼šä½¿ç”¨`predicate`å‡½æ•°è€Œéç²¾ç¡®queryKeyåŒ¹é…

```typescript
queryClient.setQueriesData({
  predicate: (query) =>
    query.queryKey[0] === 'conversations' &&
    query.queryKey[1] === 'list'
}, updater)
```

**ç†ç”±**ï¼š
- æ•è·æ‰€æœ‰ç›¸å…³ç¼“å­˜ï¼ˆåŒ…æ‹¬å¸¦å‚æ•°çš„æŸ¥è¯¢ï¼‰
- é¿å…ç¼“å­˜ä¸ä¸€è‡´
- åˆ é™¤å¯¹è¯ååˆ·æ–°ä¸ä¼šæ•°æ®æ¢å¤

#### 3. æ¶ˆæ¯çŠ¶æ€å†…è”å­˜å‚¨
**å†³ç­–**ï¼š`ChatMessage.status`å­—æ®µç›´æ¥å­˜å‚¨çŠ¶æ€ï¼Œè€Œéåˆ†ç¦»çš„`isLoading`å’Œ`previewContent`

**ç†ç”±**ï¼š
- ç®€åŒ–çŠ¶æ€ç®¡ç†
- å‡å°‘é‡å¤å­˜å‚¨
- æå‡æ€§èƒ½ï¼ˆå‡å°‘é‡æ¸²æŸ“ï¼‰

#### 4. åŸå­æ€§é…é¢ç®¡ç†
**å†³ç­–**ï¼šä½¿ç”¨SQLæ¡ä»¶æ›´æ–°è€Œéè¯»-æ£€æŸ¥-å†™æ¨¡å¼

```typescript
UPDATE users
SET currentMonthUsage = currentMonthUsage + delta
WHERE id = userId AND currentMonthUsage + delta <= monthlyTokenLimit
```

**ç†ç”±**ï¼š
- é¿å…ç«æ€æ¡ä»¶
- æ•°æ®åº“çº§åŸå­ä¿è¯
- æ”¯æŒé«˜å¹¶å‘

#### 5. SSEæµå¼æ¶æ„
**å†³ç­–**ï¼šä½¿ç”¨Server-Sent Eventsè€ŒéWebSocket

**ç†ç”±**ï¼š
- å•å‘é€šä¿¡è¶³å¤Ÿï¼ˆæœåŠ¡å™¨æ¨é€ï¼‰
- HTTP/2å¤ç”¨è¿æ¥
- ç®€åŒ–éƒ¨ç½²ï¼ˆæ— éœ€WebSocketæ”¯æŒï¼‰
- è‡ªåŠ¨é‡è¿æœºåˆ¶

---

## äº”ã€å­¦ä¹ è·¯å¾„å»ºè®®

### ğŸ“… Week 1ï¼šç†è§£æ•°æ®éª¨æ¶ + è®¤è¯æµç¨‹ï¼ˆæ‰“åŸºç¡€ï¼‰

#### Day 1-2ï¼šæ•°æ®æ¨¡å‹ï¼ˆè¿™æ˜¯ç†è§£ä¸€åˆ‡çš„åŸºç¡€ï¼‰

**å¿…è¯»æ–‡ä»¶ï¼š**
1. `prisma/schema.prisma` - å®Œæ•´é˜…è¯»ï¼Œç”»å‡ºERå›¾

**å­¦ä¹ ç›®æ ‡ï¼š**
- ç†è§£4ä¸ªæ ¸å¿ƒè¡¨ï¼šUserã€Conversationã€Messageã€UsageStats
- è®°ä½å†—ä½™å­—æ®µçš„è®¾è®¡ç†ç”±ï¼š
  - `Message.userId` â†’ é¿å…JOINæŸ¥è¯¢é…é¢
  - `Conversation.lastMessageAt` â†’ ä¼˜åŒ–å¯¹è¯åˆ—è¡¨æ’åº
  - `Conversation.messageCount/totalTokens` â†’ å®æ—¶ç»Ÿè®¡

**éªŒè¯æ–¹å¼ï¼š**
```bash
pnpm db:studio  # æ‰“å¼€Prisma Studio
```
æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå¯¹è¯å’Œæ¶ˆæ¯ï¼Œè§‚å¯Ÿæ•°æ®å…³ç³»

---

#### Day 3-4ï¼šè®¤è¯ç³»ç»Ÿï¼ˆç†è§£æƒé™æ§åˆ¶ï¼‰

**å¿…è¯»æ–‡ä»¶ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š**
1. `auth.ts` - NextAuthé…ç½®
2. `auth/strategies/index.ts` - è®¤è¯ç­–ç•¥é€‰æ‹©
3. `middleware.ts` - è·¯ç”±ä¿æŠ¤

**å­¦ä¹ ç›®æ ‡ï¼š**
- ç†è§£JWT Tokençš„ç”Ÿå‘½å‘¨æœŸï¼š
  ```
  ç™»å½• â†’ authorize() â†’ jwt callback â†’ session callback â†’ å‰ç«¯session.user
  ```
- ç†è§£å¼€å‘/ç”Ÿäº§ç¯å¢ƒçš„åŒºåˆ«ï¼š
  - å¼€å‘ï¼šä»»æ„é‚®ç®± + `DEV_LOGIN_CODE`ï¼Œè‡ªåŠ¨åˆ›å»ºç”¨æˆ·
  - ç”Ÿäº§ï¼šé¢„å…ˆåˆ›å»ºçš„é‚®ç®± + `ADMIN_LOGIN_PASSWORD`

**éªŒè¯æ–¹å¼ï¼š**
```bash
# æµ‹è¯•ç™»å½•æµç¨‹
npx tsx scripts/create-user.ts test@test.com "æµ‹è¯•ç”¨æˆ·" USER 100000
# ç„¶åè®¿é—® http://localhost:3007/login ç™»å½•
```

---

### ğŸ“… Week 2ï¼šæ ¸å¿ƒèŠå¤©ç³»ç»Ÿï¼ˆé‡ç‚¹çªç ´ï¼‰

#### Day 5-7ï¼šèŠå¤©APIå®Œæ•´é“¾è·¯ï¼ˆâ˜…æœ€é‡è¦â˜…ï¼‰

**å¿…è¯»æ–‡ä»¶ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š**
1. `types/chat.ts` - å…ˆç†è§£æ•°æ®ç»“æ„
2. `lib/chat/context-trimmer.ts` - ç†è§£æ¶ˆæ¯è£å‰ªé€»è¾‘
3. `lib/security/quota-manager.ts` - ç†è§£é…é¢ç®¡ç†
4. `app/api/chat/route.ts` - å®Œæ•´APIè·¯ç”±ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰

**å­¦ä¹ ç­–ç•¥ï¼š**
åœ¨ `app/api/chat/route.ts` ä¸­ï¼Œæ‰¾åˆ°è¿™äº›å…³é”®ä»£ç å—å¹¶æ·»åŠ æ³¨é‡Šï¼š

```typescript
// æ­¥éª¤1ï¼šè®¤è¯éªŒè¯
const token = await getToken({ req })

// æ­¥éª¤2ï¼šé€Ÿç‡é™åˆ¶
await checkRateLimit(...)

// æ­¥éª¤3ï¼šé…é¢é¢„ç•™ï¼ˆåŸå­æ€§æ“ä½œï¼Œé˜²æ­¢è¶…é™ï¼‰
await quotaManager.reserveTokens(userId, estimatedTokens)

// æ­¥éª¤4ï¼šè£å‰ªä¸Šä¸‹æ–‡ï¼ˆé˜²æ­¢tokenè¶…é™ï¼‰
const trimmedMessages = trimForChatAPI(messages, modelId)

// æ­¥éª¤5ï¼šè°ƒç”¨AI API
const aiResponse = await fetch(...)

// æ­¥éª¤6ï¼šæµå¼å“åº”å¤„ç†
const transformStream = createSSETransformStream(...)

// æ­¥éª¤7ï¼šä¿å­˜æ¶ˆæ¯ï¼ˆåœ¨onCompleteå›è°ƒä¸­ï¼‰
await quotaManager.commitTokens(...)
```

**éªŒè¯æ–¹å¼ï¼š**
åœ¨APIè·¯ç”±ä¸­æ·»åŠ  `console.log`ï¼Œè§‚å¯Ÿæ¯ä¸ªæ­¥éª¤çš„æ•°æ®æµè½¬ï¼š
```typescript
console.log('æ­¥éª¤3: é¢„ç•™é…é¢', { userId, estimatedTokens })
console.log('æ­¥éª¤4: è£å‰ªåæ¶ˆæ¯æ•°', trimmedMessages.length)
console.log('æ­¥éª¤7: å®é™…ä½¿ç”¨', { actualTokens, adjustment })
```

---

#### Day 8-10ï¼šå‰ç«¯èŠå¤©Hooksï¼ˆç†è§£å‰ç«¯æ¶æ„ï¼‰

**å¿…è¯»æ–‡ä»¶ï¼ˆæŒ‰é¡ºåºï¼‰ï¼š**
1. `components/chat/chat-reducer.ts` - çŠ¶æ€ç®¡ç†
2. `hooks/use-chat-actions.ts` - æ¶ˆæ¯å‘é€Hook
3. `lib/utils/sse-parser.ts` - SSEè§£æå·¥å…·

**å­¦ä¹ ç›®æ ‡ï¼š**
- ç†è§£äº‹ä»¶é©±åŠ¨æ¶æ„ï¼š
  ```
  sendMessage() â†’ å‘é€startedäº‹ä»¶ â†’ Reduceræ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                â†’ æ¥æ”¶chunkäº‹ä»¶ â†’ Reduceræ›´æ–°æµå¼å†…å®¹
                â†’ æ¥æ”¶doneäº‹ä»¶ â†’ Reduceræ ‡è®°å®Œæˆ
  ```
- ç†è§£Reducerçš„actionç±»å‹ï¼š
  - `SEND_USER_MESSAGE` - æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  - `UPDATE_MESSAGE_STREAM` - æ›´æ–°æµå¼å†…å®¹ï¼ˆæ–°æ¶æ„ï¼‰
  - `REMOVE_MESSAGE` - åˆ é™¤æ¶ˆæ¯

**éªŒè¯æ–¹å¼ï¼š**
åœ¨ `use-chat-actions.ts` ä¸­æ·»åŠ æ—¥å¿—ï¼š
```typescript
const processSSEStream = async (reader, onEvent) => {
  while (true) {
    const { done, value } = await reader.read()
    console.log('SSEäº‹ä»¶:', value)  // è§‚å¯Ÿäº‹ä»¶æµ
    ...
  }
}
```

---

### ğŸ“… Week 3ï¼šè¿›é˜¶ä¸»é¢˜ï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€æ±‚é€‰æ‹©ï¼‰

#### å•†å®¶åˆ†æç³»ç»Ÿï¼ˆå¦‚æœä½ éœ€è¦ç»´æŠ¤è¿™éƒ¨åˆ†ï¼‰

**å…¥å£æ–‡ä»¶ï¼š**
- `app/api/merchants/[id]/route.ts` - å•†å®¶è¯¦æƒ…API
- `components/merchants/merchant-profile-card.tsx` - å‰ç«¯ç»„ä»¶

**å­¦ä¹ å»ºè®®ï¼š**
å•†å®¶ç³»ç»Ÿç›¸å¯¹ç‹¬ç«‹ï¼Œæš‚æ—¶å¯ä»¥è·³è¿‡ã€‚åªéœ€è¦çŸ¥é“ï¼š
- å®ƒä½¿ç”¨äº†å’ŒèŠå¤©ç³»ç»Ÿç›¸åŒçš„æŠ€æœ¯æ ˆï¼ˆReact Query + Prismaï¼‰
- æ ¸å¿ƒæ˜¯æ•°æ®é‡‡é›† + AIåˆ†æ

#### React Queryç¼“å­˜ç®¡ç†ï¼ˆé‡è¦ï¼Œé¿å…å¸¸è§bugï¼‰

**å¿…è¯»æ–‡ä»¶ï¼š**
- `hooks/api/use-conversations-query.ts`
- `hooks/api/use-conversation-mutations.ts`

**å…³é”®çŸ¥è¯†ç‚¹ï¼š**
```typescript
// âŒ é”™è¯¯ï¼šç²¾ç¡®åŒ¹é…ä¼šæ¼æ‰å¸¦å‚æ•°çš„æŸ¥è¯¢
queryClient.setQueriesData(
  { queryKey: ['conversations', 'list'] },
  updater
)

// âœ… æ­£ç¡®ï¼šä½¿ç”¨predicateåŒ¹é…æ‰€æœ‰ç›¸å…³æŸ¥è¯¢
queryClient.setQueriesData({
  predicate: (query) =>
    query.queryKey[0] === 'conversations' &&
    query.queryKey[1] === 'list'
}, updater)
```

---

## å…­ã€å¿«é€ŸæŸ¥æ‰¾ä»£ç åŠŸèƒ½çš„æŠ€å·§

### 1. ä»URLåæ¨ä»£ç ä½ç½®
```
è®¿é—®ï¼šhttp://localhost:3007/chat/abc123
ä»£ç ï¼šapp/chat/[id]/page.tsx

è®¿é—®ï¼šPOST http://localhost:3007/api/chat
ä»£ç ï¼šapp/api/chat/route.ts (export async function POST)
```

### 2. ä»æ•°æ®åº“å­—æ®µåæ¨ä¸šåŠ¡é€»è¾‘
æ‰“å¼€ `prisma/schema.prisma`ï¼Œæ‰¾åˆ°å­—æ®µï¼Œç„¶åå…¨å±€æœç´¢ï¼š
```bash
# ä¾‹å¦‚ï¼šæƒ³çŸ¥é“ lastMessageAt åœ¨å“ªé‡Œæ›´æ–°
Ctrl+Shift+F æœç´¢ "lastMessageAt"
```

### 3. ä»å‰ç«¯ç»„ä»¶åæ¨API
```typescript
// åœ¨ç»„ä»¶ä¸­çœ‹åˆ°è¿™ä¸ªHook
const { data } = useConversationsQuery()

// è·³è½¬åˆ° use-conversations-query.ts
// æ‰¾åˆ° queryFn: () => fetch('/api/conversations')

// ç„¶åæ‰“å¼€ app/api/conversations/route.ts
```

### 4. ä»ç±»å‹å®šä¹‰ç†è§£åŠŸèƒ½
```typescript
// types/chat.ts
export interface ChatMessage {
  id: string
  role: 'user' | 'assistant'
  content: string
  status: 'pending' | 'streaming' | 'completed' | 'error'  // çœ‹è¿™é‡Œï¼
}
```
ä» `status` å­—æ®µå¯ä»¥æ¨æ–­å‡ºæ¶ˆæ¯æœ‰4ç§çŠ¶æ€ï¼Œç„¶åæœç´¢è¿™äº›çŠ¶æ€çš„ä½¿ç”¨ã€‚

---

## ä¸ƒã€æ¯å‘¨éªŒè¯ç›®æ ‡

### Week 1éªŒè¯ï¼š
- [ ] èƒ½ç”»å‡ºæ•°æ®åº“ERå›¾
- [ ] èƒ½è§£é‡Šå¼€å‘/ç”Ÿäº§ç¯å¢ƒç™»å½•çš„åŒºåˆ«
- [ ] èƒ½æ‰‹åŠ¨åˆ›å»ºç”¨æˆ·å¹¶ç™»å½•

### Week 2éªŒè¯ï¼š
- [ ] èƒ½è§£é‡ŠèŠå¤©APIçš„7ä¸ªæ­¥éª¤
- [ ] èƒ½è§£é‡ŠåŸå­æ€§é…é¢ç®¡ç†çš„åŸç†
- [ ] èƒ½ç”»å‡ºå‰ç«¯äº‹ä»¶é©±åŠ¨çš„æµç¨‹å›¾

### Week 3éªŒè¯ï¼š
- [ ] èƒ½ä¿®å¤React Queryç¼“å­˜bug
- [ ] èƒ½æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹
- [ ] èƒ½ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢

---

## å…«ã€æ ¸å¿ƒæ–‡ä»¶ä¾èµ–å…³ç³»å›¾

```
[æ•°æ®å±‚]
prisma/schema.prisma
  â†“
lib/prisma.ts (Prisma Client)
  â†“
[ä¸šåŠ¡é€»è¾‘å±‚]
lib/security/quota-manager.ts â† ä¾èµ– prisma
lib/chat/context-trimmer.ts
lib/utils/sse-parser.ts
lib/ai/provider-manager.ts
  â†“
[APIå±‚]
app/api/chat/route.ts
  â”œâ”€ ä¾èµ– quota-manager
  â”œâ”€ ä¾èµ– context-trimmer
  â”œâ”€ ä¾èµ– sse-parser
  â””â”€ ä¾èµ– provider-manager
  â†“
[è®¤è¯å±‚]
auth/strategies/*.ts
  â†“
auth.ts (NextAuthé…ç½®)
  â†“
middleware.ts (è·¯ç”±ä¿æŠ¤)
  â†“
[å‰ç«¯å±‚]
types/chat.ts (ç±»å‹å®šä¹‰)
  â†“
components/chat/chat-reducer.ts (çŠ¶æ€ç®¡ç†)
  â†“
hooks/use-chat-actions.ts
  â”œâ”€ ä¾èµ– sse-parser
  â””â”€ ä¾èµ– context-trimmer
  â†“
hooks/api/use-conversations-query.ts (React Query)
  â†“
[UIç»„ä»¶]
components/chat/*.tsx
```

---

## ä¹ã€å­¦ä¹ å»ºè®®

### ğŸ’¡ å­¦ä¹ æ–¹æ³•

1. **ä¸è¦ä¸€æ¬¡æ€§è¯»å®Œæ‰€æœ‰ä»£ç **ï¼ŒæŒ‰ç…§ä¸Šé¢çš„é¡ºåºï¼Œæ¯å¤©ä¸“æ³¨1-2ä¸ªæ–‡ä»¶
2. **è¾¹è¯»è¾¹ç”»å›¾**ï¼Œç‰¹åˆ«æ˜¯æ•°æ®æµå›¾å’ŒçŠ¶æ€æœºå›¾
3. **åœ¨å…³é”®ä»£ç å¤„æ·»åŠ  console.log**ï¼Œè§‚å¯Ÿè¿è¡Œæ—¶çš„æ•°æ®
4. **ä¿®æ”¹ä»£ç å¹¶è§‚å¯Ÿç»“æœ**ï¼Œæ¯”å¦‚æ”¹å˜tokené™åˆ¶ã€æ·»åŠ æ–°å­—æ®µ
5. **é‡åˆ°ä¸æ‡‚çš„æ¦‚å¿µï¼Œå…ˆGoogle**ï¼ˆæ¯”å¦‚SSEã€Reducerã€React Queryï¼‰

### ğŸ“– æ¨èå­¦ä¹ èµ„æº

- **NextAuthæ–‡æ¡£**ï¼šhttps://next-auth.js.org/
- **React Queryæ•™ç¨‹**ï¼šhttps://tanstack.com/query/latest
- **PrismaæŒ‡å—**ï¼šhttps://www.prisma.io/docs
- **SSEåè®®**ï¼šhttps://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events

---

## åã€æ¶æ„äº®ç‚¹æ€»ç»“

1. **äº‹ä»¶é©±åŠ¨ + Reduceræ¨¡å¼**ï¼šè§£è€¦ç»„ä»¶ï¼Œæ”¯æŒå¤æ‚çŠ¶æ€ç®¡ç†
2. **åŸå­æ€§é…é¢ç®¡ç†**ï¼šå¹¶å‘å®‰å…¨ï¼Œæ— ç«æ€æ¡ä»¶
3. **å‰åç«¯é€»è¾‘å¤ç”¨**ï¼š`trimForChatAPI`é˜²æ­¢å®¢æˆ·ç«¯ç»•è¿‡
4. **æµå¼æ¶æ„**ï¼šSSEé™ä½é¦–å­—å“åº”æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
5. **ç­–ç•¥æ¨¡å¼è®¤è¯**ï¼šå¼€å‘/ç”Ÿäº§ç¯å¢ƒéš”ç¦»ï¼Œå®‰å…¨å¯æ§
6. **React Queryç¼“å­˜**ï¼šè‡ªåŠ¨ç®¡ç†æœåŠ¡å™¨çŠ¶æ€ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
7. **å†—ä½™å­—æ®µä¼˜åŒ–**ï¼šé¿å…å¤æ‚JOINæŸ¥è¯¢ï¼Œæå‡æ€§èƒ½
8. **å¤šProvideræŠ½è±¡**ï¼šæ”¯æŒæ— ç¼åˆ‡æ¢AIæä¾›å•†

---

## é™„å½•ï¼šå¸¸è§é—®é¢˜æ’æŸ¥

### åˆ é™¤å¯¹è¯ååˆ·æ–°é¡µé¢æ•°æ®æ¢å¤
**åŸå› **ï¼šReact Queryç¼“å­˜Keyä¸åŒ¹é…
**è§£å†³**ï¼šMutationä½¿ç”¨`predicate`å‡½æ•°åŒ¹é…æ‰€æœ‰ç›¸å…³æŸ¥è¯¢

### 401è®¤è¯é”™è¯¯è¢«é»˜è®¤ç©ºæ•°ç»„æ©ç›–
**åŸå› **ï¼šuseQueryè¿”å›å€¼è®¾ç½®äº†é»˜è®¤å€¼
**è§£å†³**ï¼šç§»é™¤é»˜è®¤å€¼ï¼Œåœ¨è¿”å›è¾¹ç•Œå¤„ç†ç©ºå€¼

### Invalid Date / RangeError
**åŸå› **ï¼šæ•°æ®åº“è¿”å›null/undefinedçš„æ—¶é—´æˆ³
**è§£å†³**ï¼šä½¿ç”¨`lib/utils/date-toolkit.ts`çš„å®‰å…¨è½¬æ¢å‡½æ•°

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æ›´æ–°æ—¶é—´**ï¼š2025-01-13
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
