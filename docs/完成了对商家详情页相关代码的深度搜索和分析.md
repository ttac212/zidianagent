       我已经完成了对商家详情页相关代码的深度搜索和分析。以下是详细的发现报告：
    
       ---
       1. 商家详情页主文件
    
       文件路径: D:\zdqidongxiangmu\app\merchants\[id]\page.tsx
    
       这是商家详情页的主组件，包含：
       - 数据加载：获取商家详情和内容列表
       - 核心功能：
         - 商家基本信息展示（名称、类型、位置、状态等）
         - 内容列表展示（支持搜索、排序、分页）
         - 数据统计卡片（总互动、点赞、评论、收藏、分享数）
         - 商家创作档案卡片（<MerchantProfileCard>）
         - 标签分析和数据导出功能
         - 管理员专用功能（即时同步、批量选择、转录）
    
       关键代码片段：
       // 获取商家详情
       const fetchMerchant = useCallback(async () => {
         const response = await fetch(`/api/merchants/${merchantId}`)
         const result = await response.json()
         const data = unwrapApiResponse<MerchantDetailResponse>(result)
         setMerchant(data.merchant)
       })
    
       // 获取商家内容
       const fetchContents = useCallback(async () => {
         const response = await fetch(`/api/merchants/${targetId}/contents?${params}`)
         const data = unwrapApiResponse<ContentListResponse>(result)
         setContents(data.contents || [])
       })
    
       ---
       2. API路由系统
    
       2.1 商家详情API
    
       文件路径: D:\zdqidongxiangmu\app\api\merchants\[id]\route.ts
    
       获取单个商家详情的API端点：
       - GET: 获取商家详情（支持可选内容列表）
       - PATCH: 更新商家信息（仅管理员）
    
       关键特性：
       - 支持includeContents参数控制是否返回内容列表
       - 支持contentLimit参数限制内容数量（1-50）
       - 返回MerchantDetailResponse类型数据
    
       2.2 商家内容API
    
       文件路径: D:\zdqidongxiangmu\app\api\merchants\[id]\contents\route.ts
    
       获取商家内容列表的API端点：
       - 支持过滤：搜索、内容类型、日期范围、是否有转录等
       - 支持排序：publishedAt、diggCount、commentCount、collectCount、shareCount、engagement
       - 分页支持：page和limit参数
       - 返回ContentListResponse类型数据
    
       2.3 TOP5洞察API（评论数据）
    
       文件路径: D:\zdqidongxiangmu\app\api\merchants\[id]\top-insights\route.ts
    
       这是加载评论数据的关键API：
    
       功能：获取近6个月内容的TOP5数据（按点赞数、评论数、互动评分排序）
    
       返回数据结构：
       {
         topLikes: TopInsightEntry[],      // 点赞数TOP5的内容
         topComments: TopInsightEntry[],   // 评论数TOP5的内容
         topEngagement: TopInsightEntry[], // 互动评分TOP5的内容
         totalContents: number,            // 近6个月总内容数
         dateRange: {
           from: string,  // ISO时间戳
           to: string
         }
       }
    
       TopInsightEntry结构：
       {
         id: string,
         title: string,
         diggCount: number,
         commentCount: number,
         collectCount: number,
         shareCount: number,
         engagementScore: number,           // 计算值：digg + comment*2 + collect*3 + share*4
         publishedAt: Date | string | null,
         shareUrl: string | null,
         comments: TopInsightComment[]      // 关联的评论（点赞最多的5条）
       }
    
       TopInsightComment结构：
       {
         id: string,
         text: string,
         diggCount: number,
         replyCount: number,
         createdAt: Date | string
       }
    
       ---
       3. React Query Hook（数据获取层）
    
       文件路径: D:\zdqidongxiangmu\hooks\api\use-merchant-top-insights.ts
    
       export function useMerchantTopInsights(merchantId: string) {
         return useQuery({
           queryKey: topInsightsKeys.detail(merchantId),
           queryFn: () => fetchTopInsights(merchantId),
           staleTime: 5 * 60 * 1000,  // 5分钟内数据新鲜
           gcTime: 10 * 60 * 1000,     // 10分钟后清除缓存
           retry: 1,
           enabled: Boolean(merchantId)
         })
       }
    
       // Query Key结构
       export const topInsightsKeys = {
         all: ['merchant-top-insights'] as const,
         detail: (merchantId: string) => [...topInsightsKeys.all, merchantId] as const
       }
    
       使用示例（来自merchant-profile-card.tsx）：
       const {
         data: topInsightsData,
         isLoading: isLoadingInsights,
         error: insightsError
       } = useMerchantTopInsights(merchantId)
    
       ---
       4. 评论展示组件
    
       4.1 ProfileAISection（profile-ai-section.tsx）
    
       文件路径: D:\zdqidongxiangmu\components\merchants\profile-ai-section.tsx
    
       这是处理评论数据展示的核心组件。
    
       Props接口：
       interface ProfileAISectionProps {
         merchantId: string                            // 商家ID，用于AI评论分析API调用
         brief: ProfileBrief | null
         aiGeneratedAt?: Date | string | null
         aiModelUsed?: string | null
         aiTokenUsed?: number
         commentInsights?: CommentInsights | null      // 评论洞察数据
         commentInsightsLoading?: boolean
         commentInsightsError?: Error | null
       }
    
       CommentInsights数据结构：
       export interface CommentInsights {
         topLikes: CommentInsightEntry[]
         topComments: CommentInsightEntry[]
         topEngagement: CommentInsightEntry[]
       }
    
       export interface CommentInsightEntry {
         id: string
         title: string
         diggCount: number
         commentCount: number
         engagementScore: number
         publishedAt?: Date | string | null
         comments: CommentInsightComment[]
       }
    
       export interface CommentInsightComment {
         id: string
         text: string
         diggCount: number
         replyCount: number
         createdAt: Date | string
       }
    
       核心功能：
       - 通过<CommentInsightsPanel>组件展示评论洞察
       - 支持3个标签页：点赞TOP5、评论TOP5、互动TOP5
       - 每个内容项显示：标题、发布时间、点赞数、评论数、互动评分
       - 支持展开查看关联评论内容
       - **新增：AI评论分析功能**（见下文VideoEntryWithAnalysis组件）

       评论展示逻辑（第399-422行）：
       {entry.comments.length > 0 ? (
         <details className="group text-xs">
           <summary className="cursor-pointer">
             查看评论内容 ({entry.comments.length})
           </summary>
           <ul className="mt-2 space-y-1">
             {entry.comments.map((comment) => (
               <li key={comment.id} className="rounded bg-muted/50 p-2">
                 <div className="flex items-center justify-between">
                   <span>赞 {formatNumber(comment.diggCount)}</span>
                   <span>回复 {formatNumber(comment.replyCount)}</span>
                 </div>
                 <p>{comment.text || '暂无评论内容'}</p>
               </li>
             ))}
           </ul>
         </details>
       ) : (
         <p>未抓取到评论内容</p>
       )}

       4.1.1 AI评论分析功能（VideoEntryWithAnalysis组件）

       文件位置：profile-ai-section.tsx 第343-487行

       这是ProfileAISection中最重要的子组件，为每个TOP5视频提供AI智能分析功能。

       核心特性：
       - 使用 `useMerchantCommentAnalysis` Hook调用AI分析API
       - 支持状态跟踪：analyzing（分析中）、completed（已完成）、error（错误）
       - 实时进度展示：带有百分比和详情的Progress组件
       - Markdown格式的分析报告展示

       关键代码：
       const { analyze, status, progress, result, error, isAnalyzing, hasError } = useMerchantCommentAnalysis()

       const handleAnalyze = () => {
         setShowAnalysis(true)
         analyze(merchantId, entry.id)  // 调用AI分析
       }

       AI分析按钮（第424-447行）：
       <Button
         size="sm"
         variant={showAnalysis ? 'outline' : 'default'}
         onClick={handleAnalyze}
         disabled={isAnalyzing}
       >
         {isAnalyzing ? (
           <>
             <Loader2 className="h-3 w-3 mr-1 animate-spin" />
             AI分析中...
           </>
         ) : (
           <>
             <Sparkles className="h-3 w-3 mr-1" />
             {showAnalyze ? '重新分析' : 'AI智能分析评论'}
           </>
         )}
       </Button>

       分析结果展示（第464-477行）：
       {showAnalysis && result && (
         <div className="mt-3 border border-primary/20 rounded-lg bg-primary/5 p-4">
           <div className="flex items-center gap-2 mb-3">
             <Sparkles className="h-4 w-4 text-primary" />
             <h4 className="font-medium text-sm">AI 分析结果</h4>
             <Badge variant="secondary" className="text-xs">
               {result.commentCount} 条评论
             </Badge>
           </div>
           <div className="prose prose-sm max-w-none text-sm text-muted-foreground whitespace-pre-wrap">
             {result.markdown}
           </div>
         </div>
       )}

       相关API：
       - Hook: /hooks/api/use-merchant-comment-analysis.ts
       - API端点: POST /api/merchants/[id]/contents/[contentId]/analyze
       - 功能：调用LLM分析视频评论，生成情感分析、核心话题、用户画像等结构化报告

    
       4.2 MerchantProfileCard（merchant-profile-card.tsx）
    
       文件路径: D:\zdqidongxiangmu\components\merchants\merchant-profile-card.tsx
    
       这是商家创作档案的主容器，协调TOP5数据的获取和展示。
    
       关键逻辑（第40-92行）：
       // 1. 使用Hook获取TOP5数据
       const {
         data: topInsightsData,
         isLoading: isLoadingInsights,
         error: insightsError
       } = useMerchantTopInsights(merchantId)
    
       // 2. 将TOP5数据转换为CommentInsights格式
       const commentInsights = useMemo<CommentInsights | null>(() => {
         if (!topInsightsData) return null
    
         return {
           topLikes: topInsightsData.topLikes.map(item => ({
             id: item.id,
             title: item.title,
             diggCount: item.diggCount,
             commentCount: item.commentCount,
             engagementScore: item.engagementScore,
             publishedAt: item.publishedAt,
             comments: item.comments  // 直接使用API返回的comments
           })),
           topComments: topInsightsData.topComments.map(item => ({...})),
           topEngagement: topInsightsData.topEngagement.map(item => ({...}))
         }
       }, [topInsightsData])
    
       // 3. 传递给ProfileAISection组件
       <ProfileAISection
         merchantId={merchantId}
         brief={parsed.brief}
         commentInsights={commentInsights}
         commentInsightsLoading={isLoadingInsights}
         commentInsightsError={topInsightsError}
       />
    
       ---
       5. 数据库模型（Prisma Schema）
    
       5.1 MerchantContent模型
    
       model MerchantContent {
         id                String                   @id @default(cuid())
         merchantId        String
         externalId        String
         title             String
         content           String?
         transcript        String?
         contentType       ContentType              @default(VIDEO)
         duration          String?
         shareUrl          String?
         hasTranscript     Boolean                  @default(false)
         diggCount         Int                      @default(0)
         commentCount      Int                      @default(0)
         collectCount      Int                      @default(0)
         shareCount        Int                      @default(0)
         totalEngagement   Int                      @default(0)       // 总互动量 = diggCount + commentCount + collectCount + shareCount
         // 新增字段（抖音平台关键指标）
         playCount         Int                      @default(0)       // 播放量 ⭐ 关键指标
         forwardCount      Int                      @default(0)       // 转发数
         likeRate          Float?                                     // 点赞率 (diggCount/playCount)
         commentRate       Float?                                     // 评论率
         completionRate    Float?                                     // 完播率
         avgWatchDuration  Int?                                       // 平均观看时长(秒)
         // 刷量检测
         isSuspicious      Boolean                  @default(false)   // 疑似刷量
         suspiciousReason  String?                                    // 标记原因
         tags              String                   @default("[]")    // 标签 (JSON数组)
         textExtra         String                   @default("[]")    // 额外文本信息 (JSON数组)
         publishedAt       DateTime?
         collectedAt       DateTime
         externalCreatedAt DateTime?                                  // 外部平台创建时间
         createdAt         DateTime                 @default(now())
         updatedAt         DateTime                 @updatedAt
         merchant          Merchant                 @relation(fields: [merchantId], references: [id], onDelete: Cascade)
         comments          MerchantContentComment[] // 关联的评论
         analysis          MerchantContentAnalysis?

         @@unique([externalId, merchantId])
         @@index([merchantId, publishedAt])
         @@index([merchantId, totalEngagement(sort: Desc)])  // 按总互动量排序优化
         @@index([merchantId, likeRate(sort: Desc)])         // 按真实互动率排序
         @@index([contentType])
         @@index([externalId])
         @@index([collectedAt])
         @@index([isSuspicious])
         @@map("merchant_contents")
       }
    
       5.2 MerchantContentComment模型（评论表）
    
       model MerchantContentComment {
         id          String          @id @default(cuid())
         contentId   String          // 关联的内容ID
         externalId  String          @unique // 抖音评论ID (cid)
         text        String          // 评论文本
         authorName  String?         // 评论者昵称
         authorUid   String?         // 评论者UID
         diggCount   Int             @default(0) // 评论点赞数
         replyCount  Int             @default(0) // 回复数
         isTop       Boolean         @default(false) // 是否置顶
         keywords    String          @default("[]") // 关键词提取 (JSON数组)
         createdAt   DateTime        // 评论创建时间
         collectedAt DateTime        @default(now()) // 采集时间
         content     MerchantContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
    
         @@index([contentId, diggCount(sort: Desc)]) // 按点赞数排序查询热门评论
         @@index([contentId, createdAt(sort: Desc)]) // 按时间排序查询最新评论
         @@map("merchant_content_comments")
       }
    
       ---
       6. 类型定义
    
       文件路径: D:\zdqidongxiangmu\types\merchant.ts
    
       // 从Prisma导入
       export type MerchantContentComment = PrismaMerchantContentComment
    
       export type MerchantContent = PrismaMerchantContent & {
         parsedTags?: string[]
         parsedTextExtra?: string[]
         comments?: MerchantContentComment[]  // 可选关联评论
       }
    
       export type MerchantWithDetails = PrismaMerchant & {
         category?: MerchantCategory | null
         contents?: MerchantContent[]
         _count?: {
           contents: number
         }
       }
    
       ---
       7. 数据流图
    
       MerchantDetailPage
         ├─ fetchMerchant()
         │  └─ GET /api/merchants/[id]
         │     └─ MerchantWithDetails (包含基本信息)
         │
         ├─ MerchantProfileCard
         │  ├─ useMerchantTopInsights(merchantId)
         │  │  └─ GET /api/merchants/[id]/top-insights
         │  │     ├─ topLikes (TOP5点赞内容 + 关联评论)
         │  │     ├─ topComments (TOP5评论内容 + 关联评论)
         │  │     └─ topEngagement (TOP5互动内容 + 关联评论)
         │  │
         │  └─ ProfileAISection
         │     ├─ ProfileBrief (AI生成的档案摘要)
         │     └─ CommentInsightsCard
         │        └─ 3个标签页展示评论洞察
         │
         └─ fetchContents()
            └─ GET /api/merchants/[id]/contents
               └─ MerchantContent[] (内容列表，可包含comments)
    
       ---
       8. 关键交互点
    
       | 页面位置   | 组件                                      | 数据来源                        | 功能             |
       |--------|-----------------------------------------|-----------------------------|----------------|
       | 商家创作档案 | MerchantProfileCard                     | useMerchantTopInsights Hook | 加载和管理TOP5洞察数据  |
       | 评论表现洞察 | ProfileAISection > CommentInsightsPanel | commentInsights Prop        | 展示3个标签页的评论分析   |
       | 评论详情   | CommentInsightsCard                     | entry.comments              | 展开查看具体评论内容     |
       | 内容列表   | MerchantDetailPage                      | fetchContents               | 获取全量内容（可选关联评论） |
    
       ---
       9. 重要发现
    
       1. 评论数据的两个来源：
         - TOP5洞察API（/api/merchants/[id]/top-insights）：用于商家创作档案的评论分析
         - 内容列表API（/api/merchants/[id]/contents）：可选地返回完整的评论列表
       2. 评论包含在TOP5查询中：每个TOP5项目都包含最多5条点赞最多的评论
       3. 评论展示是可折叠的：评论内容通过<details>元素实现，点击才展开
       4. 互动评分计算：diggCount + commentCount*2 + collectCount*3 + shareCount*4
       5. 评论数据库字段完整：包含评论文本、点赞数、回复数、作者信息、发布时间等
       6. **新增AI评论分析**：通过VideoEntryWithAnalysis组件，为每个TOP5视频提供LLM智能分析
       7. **刷量检测字段**：MerchantContent模型包含isSuspicious和suspiciousReason字段用于标记异常数据
       8. **播放量指标**：新增playCount字段，这是抖音平台最核心的内容效果指标
    
       ---
       10. 文件路径总结
    
       核心文件：
       ├─ 页面层
       │  ├─ /app/merchants/[id]/page.tsx（商家详情页）
       │  └─ /app/merchants/[id]/analytics/page.tsx（分析页面）
       │
       ├─ 组件层
       │  ├─ /components/merchants/merchant-profile-card.tsx（创作档案容器）
       │  ├─ /components/merchants/profile-ai-section.tsx（评论洞察展示）
       │  └─ /components/merchants/profile-custom-section.tsx（自定义内容）
       │
       ├─ API层
       │  ├─ /app/api/merchants/[id]/route.ts（商家详情API）
       │  ├─ /app/api/merchants/[id]/contents/route.ts（内容列表API）
       │  ├─ /app/api/merchants/[id]/top-insights/route.ts（TOP5洞察API）
       │  └─ /app/api/merchants/[id]/profile/route.ts（档案数据API）
       │
       ├─ Hook层
       │  ├─ /hooks/api/use-merchant-profile.ts
       │  ├─ /hooks/api/use-merchant-top-insights.ts（关键Hook - TOP5数据）
       │  ├─ /hooks/api/use-merchant-comment-analysis.ts（关键Hook - AI评论分析）
       │  └─ /hooks/api/use-merchant-benchmarks.ts
       │
       ├─ 类型层
       │  └─ /types/merchant.ts（所有商家相关类型）
       │
       └─ 数据库
          └─ /prisma/schema.prisma（MerchantContent、MerchantContentComment等模型）