# 抖音评论统计数据错误修复指南

## 问题描述

在评论分析Pipeline的 `fetch-statistics` 步骤中出现错误:

```
[COMMENTS_ANALYSIS] Pipeline failed: Error [DouyinCommentsPipelineStepError]: 获取统计数据失败
    at runDouyinCommentsPipeline (lib\douyin\comments-pipeline.ts:456:13)
```

## 问题根因分析

可能的原因包括:

1. **TikHub API返回格式变化** - API响应结构可能与类型定义不匹配
2. **网络或API错误** - TikHub服务可能返回了错误状态码
3. **视频ID无效** - 分享链接解析得到的视频ID可能不正确
4. **权限问题** - TikHub API Key权限不足或已过期
5. **统计数据为空** - 某些视频可能没有公开统计数据

## 修复措施

### 1. 增强错误日志 (已完成)

在 `lib/douyin/comments-pipeline.ts:430-493` 添加了详细的调试日志:

```typescript
// 记录API请求
console.log(`[COMMENTS_STATS] 正在获取视频统计数据，videoId: ${shareResult.videoId}`)

// 记录API响应结构
console.log('[COMMENTS_STATS] API响应:', JSON.stringify({
  hasStatistics: !!statsResponse.statistics,
  statisticsType: Array.isArray(statsResponse.statistics) ? 'Array' : typeof statsResponse.statistics,
  statisticsLength: statsResponse.statistics?.length,
  response: statsResponse
}, null, 2))

// 记录提取的数据
console.log(`[COMMENTS_STATS] 提取到统计数据:`, stats)

// 记录最终结果
console.log('[COMMENTS_STATS] 统计数据处理成功:', statistics)
```

### 2. 增强错误信息

现在错误会包含:
- 原始错误消息
- TikHub API错误码和详情
- 完整的API响应数据

```typescript
// 如果是TikHub API错误，提取详细信息
if (error && typeof error === 'object' && 'code' in error) {
  const apiError = error as any
  errorMessage = `TikHub API错误 (code: ${apiError.code}): ${apiError.message}`
  if (apiError.details) {
    console.error('[COMMENTS_STATS] API错误详情:', apiError.details)
  }
}
```

### 3. 数据验证增强

在抛出错误时包含完整响应:

```typescript
if (!statisticsList || statisticsList.length === 0) {
  const errorMsg = `TikHub API未返回统计数据。响应: ${JSON.stringify(statsResponse)}`
  console.error('[COMMENTS_STATS]', errorMsg)
  throw new Error(errorMsg)
}
```

## 诊断步骤

### 步骤1: 查看服务器日志

当错误再次发生时,在控制台中查找以下日志:

```
[COMMENTS_STATS] 正在获取视频统计数据，videoId: xxx
[COMMENTS_STATS] API响应: { ... }
[COMMENTS_STATS] 获取统计数据失败: ...
[COMMENTS_STATS] API错误详情: ...
```

### 步骤2: 使用测试脚本

运行测试脚本验证TikHub API连接:

```bash
npx tsx scripts/test-comments-statistics.ts
```

修改脚本中的 `testVideoId` 为实际出错的视频ID。

### 步骤3: 检查TikHub API配置

确认环境变量正确配置:

```env
TIKHUB_API_KEY=你的API密钥
```

验证API Key有效性:

```bash
npx tsx scripts/test-tikhub-api.ts
```

### 步骤4: 检查API响应格式

查看日志中的 `API响应` 内容,对比类型定义:

**期望的响应格式** (`lib/tikhub/types.ts:316-328`):

```typescript
{
  statistics: [{
    aweme_id: string
    comment_count: number
    digg_count: number
    download_count: number
    play_count: number
    share_count: number
    collect_count: number
    forward_count: number
  }]
  status_code: number
}
```

**实际响应可能的变体**:
- `statistics_list` 代替 `statistics`
- 空数组
- 错误对象

## 常见错误场景及解决方案

### 场景1: API Key无效或过期

**症状**:
```
TikHub API错误 (code: 401): Unauthorized
```

**解决方案**:
1. 检查 `.env.local` 中的 `TIKHUB_API_KEY`
2. 登录 TikHub 控制台验证API Key状态
3. 生成新的API Key并更新配置

### 场景2: 视频不存在或已删除

**症状**:
```
TikHub API未返回统计数据。响应: {"statistics":[],"status_code":0}
```

**解决方案**:
- 这是正常情况,视频可能已被删除
- 考虑添加友好的用户提示
- 跳过统计数据,使用视频详情中的基础数据

### 场景3: 速率限制

**症状**:
```
TikHub API错误 (code: 429): Rate limit exceeded
```

**解决方案**:
1. 检查 TikHub 使用量: `npx tsx scripts/test-tikhub-api.ts`
2. 等待限制重置
3. 考虑升级套餐或优化请求频率

### 场景4: 网络超时

**症状**:
```
获取统计数据失败
TypeError: fetch failed
```

**解决方案**:
1. 检查网络连接
2. 增加超时时间 (在 `lib/tikhub/config.ts` 中配置)
3. 启用重试机制 (已默认启用)

## 后续优化建议

### 1. 降级策略

当统计数据获取失败时,使用视频详情中的基础数据:

```typescript
// 如果统计API失败,尝试从视频详情中提取
statistics = {
  play_count: awemeDetail.statistics?.play_count || 0,
  digg_count: awemeDetail.statistics?.digg_count || 0,
  comment_count: awemeDetail.statistics?.comment_count || 0,
  // ...
}
```

### 2. 缓存机制

对于已获取的统计数据,缓存一段时间避免重复请求:

```typescript
// 使用Redis或内存缓存
const cacheKey = `douyin:stats:${videoId}`
const cached = await cache.get(cacheKey)
if (cached) return cached
```

### 3. 用户友好的错误提示

根据不同错误类型返回不同提示:

```typescript
switch (error.code) {
  case 401:
    return '配置错误,请联系管理员'
  case 404:
    return '视频不存在或已删除'
  case 429:
    return '请求过于频繁,请稍后重试'
  default:
    return '获取数据失败,请重试'
}
```

### 4. 监控和告警

添加错误监控:

```typescript
// 使用Sentry或其他监控工具
Sentry.captureException(error, {
  tags: {
    step: 'fetch-statistics',
    videoId: shareResult.videoId
  }
})
```

## 验证修复

修复后,通过以下方式验证:

1. **重现问题**
   - 使用相同的分享链接再次触发评论分析
   - 查看控制台日志,确认详细错误信息输出

2. **测试正常流程**
   ```bash
   # 使用一个已知有效的抖音视频链接
   # 在聊天界面发送: 分析评论 https://v.douyin.com/xxx
   ```

3. **测试边界情况**
   - 已删除的视频
   - 私密视频
   - 无评论的视频

## 相关文件

- `lib/douyin/comments-pipeline.ts` - 评论分析Pipeline主逻辑
- `lib/tikhub/client.ts` - TikHub API客户端
- `lib/tikhub/types.ts` - TikHub API类型定义
- `scripts/test-comments-statistics.ts` - 统计数据测试脚本

## 联系支持

如果问题持续存在:
1. 收集完整的错误日志
2. 检查TikHub API文档: https://docs.tikhub.io
3. 联系TikHub支持团队
