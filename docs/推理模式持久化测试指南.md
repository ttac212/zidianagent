# æ¨ç†æ¨¡å¼æŒä¹…åŒ–æµ‹è¯•æŒ‡å—

## ğŸ” è°ƒè¯•æ­¥éª¤

å·²ç»æ·»åŠ äº†å®Œæ•´çš„è°ƒè¯•æ—¥å¿—ï¼Œç°åœ¨è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæµ‹è¯•å’Œè°ƒè¯•ï¼š

---

## ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm dev
```

---

## ç¬¬äºŒæ­¥ï¼šæµ‹è¯•è®¾ç½®æŒä¹…åŒ– (localStorage)

### 2.1 æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·

- Chrome/Edge: F12 æˆ– Ctrl+Shift+I
- ç¡®ä¿Consoleæ ‡ç­¾é¡µæ‰“å¼€

### 2.2 æµ‹è¯•ä¿å­˜åŠŸèƒ½

1. åœ¨èŠå¤©ç•Œé¢ï¼Œå¯ç”¨æ¨ç†æ¨¡å¼ï¼ˆç‚¹å‡»"æ€è€ƒ"æŒ‰é’®ï¼‰
2. é€‰æ‹©æ¨ç†å¼ºåº¦ï¼ˆä½/ä¸­/é«˜ï¼‰
3. æŸ¥çœ‹æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   [SettingsStorage] Saving settings: { creativeMode: false, reasoning_effort: 'medium', reasoning: { enabled: true } }
   [SettingsStorage] Settings saved successfully
   ```

### 2.3 æµ‹è¯•åŠ è½½åŠŸèƒ½

1. åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
2. æŸ¥çœ‹æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   [SettingsStorage] Loading settings, raw value: {"creativeMode":false,"reasoning_effort":"medium","reasoning":{"enabled":true}}
   [SettingsStorage] Parsed settings: { ... }
   [SettingsStorage] Final merged settings: { ... }
   ```
3. æ£€æŸ¥æ¨ç†æ¨¡å¼è®¾ç½®æ˜¯å¦ä¿æŒï¼ˆæŒ‰é’®çŠ¶æ€åº”è¯¥ä¿æŒé€‰ä¸­ï¼‰

### 2.4 æ‰‹åŠ¨æ£€æŸ¥localStorage

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
localStorage.getItem('chatSettings')
```

åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```json
{"creativeMode":false,"reasoning_effort":"medium","reasoning":{"enabled":true}}
```

---

## ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•æ¨ç†å†…å®¹æŒä¹…åŒ– (æ•°æ®åº“)

### 3.1 å‘é€å¸¦æ¨ç†çš„æ¶ˆæ¯

1. ç¡®ä¿æ¨ç†æ¨¡å¼å·²å¯ç”¨
2. å‘é€ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼š
   ```
   è¯·åˆ†æï¼š100å¤©åæ˜¯æ˜ŸæœŸå‡ ï¼Ÿï¼ˆä»Šå¤©æ˜¯æ˜ŸæœŸä¸‰ï¼‰
   ```

### 3.2 ç›‘æ§æ§åˆ¶å°æ—¥å¿—

åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼ŒæŸ¥çœ‹æ§åˆ¶å°åº”è¯¥å‡ºç°ä»¥ä¸‹æ—¥å¿—åºåˆ—ï¼š

#### SSE Parseræ—¥å¿—ï¼š
```
[SSE Parser] Collecting reasoning chunk, total length: 123
[SSE Parser] Collecting reasoning chunk, total length: 456
...
[SSE Parser] Stream complete, content length: 1234, reasoning length: 890
```

#### Chat APIæ—¥å¿—ï¼š
```
[Chat API] Stream completion callback, content length: 1234, reasoning length: 890
[Chat API] Message saved with reasoning: true, effort: medium
```

#### QuotaManageræ—¥å¿—ï¼š
```
[QuotaManager] Adding reasoning to metadata, length: 890
[QuotaManager] Adding reasoningEffort to metadata: medium
[QuotaManager] Final metadata object: { reasoning: '...', reasoningEffort: 'medium' }
[QuotaManager] Message created with metadata: true
```

### 3.3 åˆ·æ–°é¡µé¢éªŒè¯

1. åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
2. æŸ¥çœ‹ä¹‹å‰å‘é€çš„æ¶ˆæ¯
3. æ¨ç†è¿‡ç¨‹åº”è¯¥ä¾ç„¶æ˜¾ç¤º
4. æŸ¥çœ‹æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   [Conversation API] Message msg_xxx has reasoning: true, effort: medium
   ```

---

## ç¬¬å››æ­¥ï¼šæ•°æ®åº“éªŒè¯

### 4.1 è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
npx tsx scripts/test-reasoning-persistence.ts
```

è¿™å°†æ˜¾ç¤ºæ•°æ®åº“ä¸­æœ€è¿‘5æ¡åŠ©æ‰‹æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ˜¯å¦åŒ…å«æ¨ç†å†…å®¹ã€‚

### 4.2 ä½¿ç”¨Prisma StudioæŸ¥çœ‹

```bash
npx prisma studio
```

1. æ‰“å¼€ `messages` è¡¨
2. æ‰¾åˆ°æœ€æ–°çš„ ASSISTANT æ¶ˆæ¯
3. æŸ¥çœ‹ `metadata` å­—æ®µ
4. åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
   ```json
   {
     "reasoning": "é¦–å…ˆåˆ†æé—®é¢˜...",
     "reasoningEffort": "medium"
   }
   ```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: è®¾ç½®åˆ·æ–°åä¸¢å¤±

**å¯èƒ½åŸå› **:
- localStorageè¢«ç¦ç”¨ï¼ˆæ— ç—•æ¨¡å¼ï¼‰
- æµè§ˆå™¨æ¸…é™¤äº†localStorage
- æ—¥å¿—æ˜¾ç¤ºä¿å­˜å¤±è´¥

**æ’æŸ¥**:
1. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ `[SettingsStorage]` ç›¸å…³é”™è¯¯
2. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦åœ¨æ— ç—•æ¨¡å¼
3. æ‰‹åŠ¨æµ‹è¯•ï¼š`localStorage.setItem('test', 'value'); localStorage.getItem('test')`

### é—®é¢˜2: æ¨ç†å†…å®¹æœªä¿å­˜åˆ°æ•°æ®åº“

**å¯èƒ½åŸå› **:
- APIæœªè¿”å›reasoningå­—æ®µ
- SSE parseræœªæ­£ç¡®è§£æ
- QuotaManageræœªä¿å­˜metadata

**æ’æŸ¥æ­¥éª¤**:

1. **æ£€æŸ¥SSEæ—¥å¿—**:
   - å¦‚æœæ²¡æœ‰çœ‹åˆ° `[SSE Parser] Collecting reasoning chunk`ï¼Œè¯´æ˜APIå“åº”ä¸­æ²¡æœ‰reasoningå­—æ®µ
   - å¯èƒ½ä½¿ç”¨çš„æ¨¡å‹ä¸æ”¯æŒæ¨ç†æ¨¡å¼

2. **æ£€æŸ¥Chat APIæ—¥å¿—**:
   - å¦‚æœçœ‹åˆ° `reasoning length: 0`ï¼Œè¯´æ˜SSE parseræ²¡æœ‰æ”¶é›†åˆ°reasoning
   - æ£€æŸ¥ä¸Šæ¸¸APIæ˜¯å¦æ­£ç¡®è¿”å›

3. **æ£€æŸ¥QuotaManageræ—¥å¿—**:
   - å¦‚æœæ²¡æœ‰çœ‹åˆ° `Adding reasoning to metadata`ï¼Œè¯´æ˜æ²¡æœ‰ä¼ é€’reasoningå‚æ•°
   - æ£€æŸ¥API routeæ˜¯å¦æ­£ç¡®ä¼ é€’

### é—®é¢˜3: æ¨ç†å†…å®¹æœªæ˜¾ç¤º

**å¯èƒ½åŸå› **:
- æ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼Œä½†å‰ç«¯æœªè¯»å–
- message-itemç»„ä»¶æœªæ¸²æŸ“reasoning

**æ’æŸ¥**:
1. æ£€æŸ¥Conversation APIæ—¥å¿—ï¼š`[Conversation API] Message xxx has reasoning: true`
2. å¦‚æœæ—¥å¿—æ˜¾ç¤º `has reasoning: false`ï¼Œä½†æ•°æ®åº“æœ‰æ•°æ®ï¼Œè¯´æ˜APIæ˜ å°„æœ‰é—®é¢˜
3. æ£€æŸ¥å‰ç«¯æ¶ˆæ¯å¯¹è±¡æ˜¯å¦åŒ…å«reasoningå­—æ®µï¼ˆåœ¨Consoleä¸­æ‰“å°messagesï¼‰

---

## è°ƒè¯•å‘½ä»¤é€ŸæŸ¥

```bash
# æŸ¥çœ‹localStorage
localStorage.getItem('chatSettings')

# æ¸…é™¤localStorageï¼ˆé‡ç½®æµ‹è¯•ï¼‰
localStorage.removeItem('chatSettings')

# æŸ¥çœ‹æ•°æ®åº“
npx prisma studio

# è¿è¡Œæµ‹è¯•è„šæœ¬
npx tsx scripts/test-reasoning-persistence.ts

# ç±»å‹æ£€æŸ¥
pnpm type-check

# ä»£ç æ£€æŸ¥
pnpm lint
```

---

## éœ€è¦æä¾›çš„ä¿¡æ¯

å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æ§åˆ¶å°æ—¥å¿—**ï¼šå®Œæ•´çš„ä»å‘é€æ¶ˆæ¯åˆ°æ¥æ”¶å“åº”çš„æ‰€æœ‰æ—¥å¿—
2. **æµ‹è¯•è„šæœ¬è¾“å‡º**ï¼š`npx tsx scripts/test-reasoning-persistence.ts` çš„å®Œæ•´è¾“å‡º
3. **localStorageå†…å®¹**ï¼š`localStorage.getItem('chatSettings')` çš„è¾“å‡º
4. **å…·ä½“é—®é¢˜æè¿°**ï¼š
   - è®¾ç½®æŒä¹…åŒ–å¤±è´¥ï¼Ÿè¿˜æ˜¯æ¨ç†å†…å®¹æŒä¹…åŒ–å¤±è´¥ï¼Ÿ
   - åˆ·æ–°å‰æ˜¯å¦èƒ½çœ‹åˆ°æ¨ç†å†…å®¹ï¼Ÿ
   - æ•°æ®åº“ä¸­æ˜¯å¦æœ‰reasoningå­—æ®µï¼Ÿ

---

## é¢„æœŸè¡Œä¸ºæ€»ç»“

âœ… **è®¾ç½®æŒä¹…åŒ–**ï¼š
- è°ƒæ•´æ¨ç†å¼ºåº¦åï¼Œåˆ·æ–°é¡µé¢è®¾ç½®ä¿æŒä¸å˜
- localStorageä¸­å¯ä»¥çœ‹åˆ°ä¿å­˜çš„è®¾ç½®

âœ… **æ¨ç†å†…å®¹æŒä¹…åŒ–**ï¼š
- å‘é€æ¨ç†æ¶ˆæ¯åï¼Œç«‹å³æ˜¾ç¤ºæ¨ç†è¿‡ç¨‹
- åˆ·æ–°é¡µé¢åï¼Œæ¨ç†è¿‡ç¨‹ä¾ç„¶å®Œæ•´æ˜¾ç¤º
- æ•°æ®åº“messagesè¡¨çš„metadataå­—æ®µåŒ…å«reasoning

âœ… **æ—¥å¿—è¾“å‡º**ï¼š
- æ¯ä¸ªç¯èŠ‚éƒ½æœ‰æ¸…æ™°çš„æ—¥å¿—è¾“å‡º
- å¯ä»¥è¿½è¸ªæ•°æ®ä»SSE â†’ API â†’ æ•°æ®åº“ â†’ å‰ç«¯çš„å®Œæ•´æµç¨‹
