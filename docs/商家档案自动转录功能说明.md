# 商家档案自动转录功能 - 完整说明

## 功能概述

当生成商家创作档案时，系统会自动检测视频内容的转录状态。如果发现超过30%的内容缺失转录，系统将：
1. 返回202状态码，提示需要先转录
2. 前端自动触发批量转录流程
3. 实时显示转录进度
4. 转录完成后自动重新生成档案

## 架构设计

### 模块划分

#### 1. 错误响应处理层 (`lib/api/profile/api-client.ts`)
**职责**：统一处理档案生成API的响应，封装202/200逻辑

**核心类型**：
```typescript
// 转录需求响应（202 Accepted）
interface TranscriptionRequiredResponse {
  statusCode: 202
  needsTranscription: true
  error: 'TRANSCRIPTION_REQUIRED'
  message: string
  data: {
    total: number
    missingCount: number
    missingPercentage: number
    contentsToTranscribe: TranscriptionContentInfo[]
  }
  hint: string
}

// 档案生成成功响应（200 OK）
interface ProfileGeneratedResponse {
  statusCode: 200
  needsTranscription: false
  data: {
    profile: MerchantProfile
    tokensUsed: number
    model: string
  }
}

// 联合类型
type GenerateProfileResult =
  | TranscriptionRequiredResponse
  | ProfileGeneratedResponse
```

**核心函数**：
```typescript
// 生成档案API调用
async function generateProfile(merchantId: string): Promise<GenerateProfileResult>

// 类型守卫：判断是否需要转录
function isTranscriptionRequired(result: GenerateProfileResult): result is TranscriptionRequiredResponse
```

#### 2. 批量转录Hook (`hooks/api/use-batch-transcription.ts`)
**职责**：封装SSE流式批量转录逻辑，管理转录状态

**返回值**：
```typescript
interface UseBatchTranscriptionReturn {
  startTranscription: (contentIds: string[]) => Promise<TranscriptionSummary>
  cancelTranscription: () => void
  isTranscribing: boolean
  progress: TranscriptionProgress
  error: string | null
}
```

**进度类型**：
```typescript
interface TranscriptionProgress {
  current: number    // 当前处理数量
  total: number      // 总数量
  message?: string   // 当前处理消息
}
```

**完成摘要**：
```typescript
interface TranscriptionSummary {
  total: number
  processed: number
  failed: number
  skipped: number
  failedItems: FailedTranscriptionItem[]
}
```

**SSE事件处理**：
- `start` - 转录开始，返回总数量
- `item` - 每个内容转录完成，更新进度
- `done` - 全部完成，返回摘要
- `error` - 转录失败，返回错误信息

#### 3. UI层组件

##### TranscriptionProgressPanel (`components/merchants/transcription-progress-panel.tsx`)
**职责**：实时显示转录进度，支持取消操作

**Props**：
```typescript
interface TranscriptionProgressPanelProps {
  progress: TranscriptionProgress
  isTranscribing: boolean
  error?: string | null
  onCancel: () => void
  compact?: boolean  // 紧凑模式
}
```

**显示内容**：
- 进度条（百分比）
- 当前处理数量（current/total）
- 当前处理消息
- 取消按钮
- 错误提示（如果有）

##### MerchantProfileCard (`components/merchants/merchant-profile-card.tsx`)
**重构改进**：
- 使用 `useBatchTranscription` hook 替代内联SSE逻辑
- 使用 `isTranscriptionRequired` 类型守卫判断响应
- 使用 `TranscriptionProgressPanel` 组件显示进度
- 简化状态管理（移除 `eventSource`、`transcribeProgress` 等本地状态）

## 完整流程

### 正常流程（无需转录）
```
用户点击"生成档案"
  → POST /api/merchants/[id]/profile/generate
  → 返回 200 OK
  → 前端更新缓存，显示成功
```

### 自动转录流程（缺失>30%）
```
用户点击"生成档案"
  → POST /api/merchants/[id]/profile/generate
  → 返回 202 Accepted (TRANSCRIPTION_REQUIRED)
  → 前端识别202响应
  → 自动调用 startTranscription(contentIds)
  → 显示 TranscriptionProgressPanel
  → SSE流式接收进度事件
    - start: 显示总数量
    - item: 更新进度条
    - done: 转录完成
  → 自动重新调用 generateProfile()
  → 返回 200 OK
  → 显示成功
```

### 异常处理流程

#### 1. 缺失<30%（直接生成）
```
POST /api/merchants/[id]/profile/generate
  → 跳过转录检查
  → 返回 200 OK
  → UI不显示转录面板
```

#### 2. 转录失败
```
SSE 转录流
  → error 事件触发
  → 关闭 EventSource
  → 显示错误提示
  → 停止自动重试
  → 用户可手动重试
```

#### 3. 用户取消转录
```
用户点击"取消转录"
  → cancelTranscription()
  → 关闭 EventSource
  → reject Promise
  → 停止生成流程
  → 显示"已取消"提示
```

#### 4. 转录后仍检测到缺失（重试次数超限）
```
第1次尝试：生成 → 202 → 转录 → 重新生成
第2次尝试：生成 → 202 → 转录 → 重新生成
第3次尝试：达到 MAX_GENERATE_ATTEMPTS
  → 显示"请手动补齐转录"
  → 停止自动重试
```

## 关键配置

### 转录检测阈值
```typescript
// lib/ai/profile-generator.ts
const TRANSCRIPTION_THRESHOLD = 0.3  // 30%缺失率
```

### 最大重试次数
```typescript
// components/merchants/merchant-profile-card.tsx
const MAX_GENERATE_ATTEMPTS = 2  // 最多2次自动重试
```

### 转录并发数
```typescript
// components/merchants/merchant-profile-card.tsx
const transcriptionOptions = {
  mode: 'force',       // 强制重新转录
  concurrent: 100,     // 并发数
  showToast: true      // 显示提示
}
```

## API路由

### 档案生成API
```
POST /api/merchants/[id]/profile/generate

成功响应（200）：
{
  "success": true,
  "data": {
    "profile": { ... },
    "tokensUsed": 1000,
    "model": "claude-3-5-haiku"
  }
}

转录需求响应（202）：
{
  "success": false,
  "error": "TRANSCRIPTION_REQUIRED",
  "message": "部分内容缺失转录",
  "statusCode": 202,
  "data": {
    "total": 10,
    "missingCount": 4,
    "missingPercentage": 40.0,
    "contentsToTranscribe": [
      {
        "id": "xxx",
        "title": "视频标题",
        "reason": "缺失转录"
      }
    ]
  },
  "hint": "请先转录缺失的内容，然后重新生成档案"
}
```

### 批量转录API（SSE）
```
GET /api/merchants/[id]/contents/batch-transcribe/stream?contentIds=xxx,yyy&mode=force&concurrent=100

SSE 事件流：
event: start
data: {"total": 10}

event: item
data: {"contentId": "xxx", "title": "...", "status": "success", "progress": {"processed": 1, "total": 10}}

event: item
data: {"contentId": "yyy", "title": "...", "status": "failed", "error": "...", "progress": {"processed": 2, "total": 10}}

event: done
data: {"summary": {"total": 10, "processed": 8, "failed": 2, "skipped": 0}}
```

## 测试验证

### 正常流程测试
1. 创建一个有10个视频的商家，其中8个已转录
2. 点击"生成档案"
3. 验证：缺失率<30%，直接生成成功，不显示转录面板

### 自动转录流程测试
1. 创建一个有10个视频的商家，其中只有3个已转录
2. 点击"生成档案"
3. 验证：
   - 返回202响应
   - 自动显示转录进度面板
   - 进度条实时更新
   - 转录完成后自动重新生成
   - 最终显示"档案生成成功"

### 异常情况测试
1. **转录失败**：模拟ASR服务不可用
   - 验证：显示错误提示，停止自动重试
2. **用户取消**：转录过程中点击"取消转录"
   - 验证：立即停止，显示"已取消"，不继续生成
3. **重试超限**：转录后仍检测到缺失（修改TRANSCRIPTION_THRESHOLD为0.1测试）
   - 验证：达到MAX_GENERATE_ATTEMPTS后显示"请手动补齐转录"

### 前端交互测试
1. 点击"生成档案"按钮
   - 验证：按钮变为禁用状态，显示"生成中..."
2. 转录过程中
   - 验证：按钮显示"转录中... (3/10)"
   - 验证：出现"取消转录"按钮
3. 转录完成后
   - 验证：按钮恢复正常，"取消转录"按钮消失

## 性能优化

### 1. 并发控制
- 转录并发数设为100，避免API限流
- SSE流式传输，减少内存占用

### 2. 进度更新节流
- TranscriptionProgressPanel使用React状态更新
- 避免频繁重渲染

### 3. 内存泄漏防护
- useEffect清理EventSource
- 组件卸载时自动取消转录

### 4. 错误恢复
- 转录失败项记录在failedItems数组
- 允许部分失败，不阻塞整体流程

## 开发文档

### 添加新的转录策略
1. 修改 `lib/ai/profile-generator.ts` 中的 `detectMissingTranscriptions()` 函数
2. 调整 `TRANSCRIPTION_THRESHOLD` 阈值
3. 更新 `TranscriptionContentInfo` 类型的 `reason` 字段

### 自定义进度显示
1. 修改 `TranscriptionProgressPanel` 组件的样式
2. 使用 `compact` prop 切换紧凑模式
3. 自定义进度条颜色（修改 `className`）

### 扩展SSE事件
1. 在 `useBatchTranscription` 中添加新的事件监听器
2. 更新 `TranscriptionProgress` 类型
3. 在 `TranscriptionProgressPanel` 中显示新字段

## 常见问题

### Q: 为什么返回202而不是200+字段？
A: HTTP 202 Accepted 语义明确表示"请求已接受，但需要额外操作"。这比200+字段更符合RESTful设计。

### Q: 如果转录时间很长，用户会不会等待很久？
A: SSE流式传输实时显示进度，用户可以随时取消。转录使用100并发，速度较快。

### Q: 转录失败后还会继续生成档案吗？
A: 会的。部分转录失败不会阻塞整体流程，但会在toast中提示用户有N条失败。

### Q: 如何修改最大重试次数？
A: 修改 `merchant-profile-card.tsx` 中的 `MAX_GENERATE_ATTEMPTS` 常量。

### Q: 如何禁用自动转录？
A: 修改 `profile-generator.ts`，将 `TRANSCRIPTION_THRESHOLD` 设为1.0（100%缺失才触发）。

## 更新日志

### 2025-01-XX - v1.0（当前版本）
- ✅ 创建独立的API客户端层（`lib/api/profile/api-client.ts`）
- ✅ 创建批量转录Hook（`hooks/api/use-batch-transcription.ts`）
- ✅ 创建转录进度面板组件（`components/merchants/transcription-progress-panel.tsx`）
- ✅ 重构 `MerchantProfileCard` 组件，解耦转录逻辑
- ✅ 完善TypeScript类型定义
- ✅ 通过所有类型检查和lint检查
- ✅ 编写完整文档

### 下一步计划
- [ ] 添加E2E测试（Playwright）
- [ ] 添加单元测试（Vitest）
- [ ] 支持转录进度持久化（刷新页面后恢复）
- [ ] 支持后台转录（关闭页面后继续）
- [ ] 添加转录历史记录查看
