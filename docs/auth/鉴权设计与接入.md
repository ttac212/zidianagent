# 鉴权设计与接入（NextAuth + Prisma + Middleware）

本文档记录了当前项目的鉴权架构、配置方法、关键改造点与测试步骤，便于团队成员复现与维护。

---

## 1. 总体架构

- NextAuth 作为统一的认证与会话管理框架
  - 开发期使用 Credentials Provider（email + DEV_LOGIN_CODE）
  - 后续可切换到 Email Magic Link 或 OAuth Provider
- Prisma 作为持久化层（User 自有表 + NextAuth Account/Session/VerificationToken）
- Middleware 进行路由保护（/workspace、/admin、/api/chat、/api/users、/api/admin）
- API 在服务端使用 next-auth/jwt 读取 token（统一从 token.sub 获取 userId）

---

## 2. 环境变量

- NEXTAUTH_URL=http://localhost:3000
- NEXTAUTH_SECRET=强随机字符串（生产必填）
- DEV_LOGIN_CODE=开发凭证（仅开发期设置；生产禁用）
- DATABASE_URL=数据库连接字符串

可参考 `.env.example`。

---

## 3. 关键文件

- `auth.ts`
  - 导出 `authOptions`（Credentials + PrismaAdapter + callbacks）
  - 会话策略当前使用 `jwt`，在 `callbacks.jwt/session` 中注入 `id/role/displayName/currentMonthUsage/monthlyTokenLimit`
- `app/api/auth/[...nextauth]/route.ts`
  - `NextAuth(authOptions)` 导出 GET/POST
- `middleware.ts`
  - 使用 `getToken({ req })` 校验认证与管理员权限
- `app/layout.tsx`
  - 使用 `<SessionProvider>`（客户端包装组件）
- `app/api/chat/route.ts`
  - 使用 `getToken` 获取 `userId`，拒绝信任请求体中的 `userId`
- `components/auth/invite-code-auth.tsx`
  - 注册成功后调用 `signIn('credentials', { email, code: DEV_LOGIN_CODE, redirect: false })` 自动登录
- `components/auth/user-menu.tsx`
  - 使用 `useSession()` 获取 `session.user`，退出 `signOut()`

---

## 4. 路由保护策略

- 受保护：`/workspace/:path*`, `/admin/:path*`, `/api/chat`, `/api/users/:path*`, `/api/admin/:path*`
- 放行：`/`, `/_next/**`, 静态资源, `/api/invite-codes/**`
- 管理路径：`/admin`, `/api/admin/**` 需 `role === 'ADMIN'`

---

## 5. API 接口加固规范

- 服务端以 `getToken({ req })` 为唯一认证来源
- 统一从 `token.sub` 推导 `userId`
- 对管理员接口强制校验 `token.role === 'ADMIN'`
- 客户端传入的 `userId` 一律不可信

---

## 6. Prisma 模型

- 增加 NextAuth 模型：`Account`, `Session`, `VerificationToken`
- `User` 增加 `emailVerified` 字段与反向关系 `accounts[]/sessions[]`
- 迁移命令：`npx prisma migrate dev -n add_nextauth_models`、`npx prisma generate`

---

## 7. 手动验证步骤（开发环境）

1) 准备 `.env`
   - `NEXTAUTH_URL`、`NEXTAUTH_SECRET`、`DEV_LOGIN_CODE`、`DATABASE_URL`
2) 启动应用：`pnpm dev`
3) 邀请码验证与注册
   - /api/invite-codes/verify -> 成功显示注册表单
   - /api/invite-codes/register -> 成功
   - 前端自动 `signIn('credentials', ...)` -> 跳转 `/workspace`
4) 路由访问
   - 未登录访问 `/workspace` -> 被 middleware 拦截回 `/`
   - 登录后访问 `/workspace` -> 正常
   - 非管理员访问 `/admin` -> 403/重定向
   - 管理员访问 `/admin` -> 正常
5) API 访问
   - 未认证调用 `/api/chat` -> 401
   - 已认证调用 `/api/chat` -> 200，后端使用 token.sub 作为 userId

---

## 8. 单元/集成测试建议

- callbacks.jwt/session：注入字段正确性
- middleware：受保护与管理员路径的行为（可用 Next.js 中间件测试框架或最小模拟）
- app/api/chat：无 token 401；有 token 200；禁止信任 body.userId

---

## 9. 风险与注意事项

- DEV_LOGIN_CODE：仅开发期启用；生产请禁用或移除 Credentials Provider
- Session 字段注入：仅注入必要字段，避免过大 token
- Prisma generate：Windows 下可能出现 EPERM，需关闭占用进程后重试
- 未来迁移：切换到 Email/OAuth 仅需替换 Provider 与回调策略

---

## 10. 常见问题

- Q: 为什么使用 jwt strategy？
  - A: 降低对 Session 表的读写依赖，减少 generate/migrate 异常对本地运行的影响；未来可切回 database strategy。
- Q: 如何显示用量配额？
  - A: 在 `callbacks.session` 注入配额字段，前端 `useSession()` 读取显示。

