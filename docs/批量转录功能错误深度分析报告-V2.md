# æ‰¹é‡è½¬å½•åŠŸèƒ½é”™è¯¯æ·±åº¦åˆ†ææŠ¥å‘Š V2

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
- âœ… åœ¨å¯¹è¯æ¨¡å—ï¼ˆ`/douyin-tool`ï¼‰ä¸­ä½¿ç”¨è½¬å½•åŠŸèƒ½**æ­£å¸¸å·¥ä½œ**
- âŒ åœ¨å•†å®¶ç®¡ç†é¡µé¢ä½¿ç”¨æ‰¹é‡è½¬å½•åŠŸèƒ½**å¤±è´¥**
- âš ï¸ **ä»…è½¬å½•ä¸€ä¸ªè§†é¢‘å°±å¤±è´¥**ï¼ˆæ’é™¤å¹¶å‘é—®é¢˜ï¼‰

é”™è¯¯ä¿¡æ¯ï¼š
```
è½¬å½•å†…å®¹ 116722ce-5060-4b74-90c1-b42cbad8824c å¤±è´¥: [TypeError: terminated] {
  [cause]: [Error [BodyTimeoutError]: Body Timeout Error] {
    code: 'UND_ERR_BODY_TIMEOUT'
  }
}

æ‰¹é‡è½¬å½•å¤±è´¥: TypeError: Invalid state: Controller is already closed
    at sendSSE (app\api\merchants\[id]\contents\batch-transcribe\stream\route.ts:24:14)
```

---

## å…³é”®å‘ç°

### æ¶æ„å¯¹æ¯”

| ç‰¹æ€§ | å¯¹è¯æ¨¡å—è½¬å½• (âœ… æˆåŠŸ) | æ‰¹é‡è½¬å½• (âŒ å¤±è´¥) |
|------|---------------------|------------------|
| **APIè·¯å¾„** | `/api/douyin/extract-text` | `/api/merchants/[id]/contents/batch-transcribe/stream` |
| **HTTPæ–¹æ³•** | POST | GET |
| **Next.js maxDuration** | **æœªè®¾ç½®** (æ— é™åˆ¶) | **300ç§’** |
| **Next.js dynamic** | æœªè®¾ç½® | `force-dynamic` |
| **å®¢æˆ·ç«¯å®ç°** | `fetch()` + ReadableStream | `EventSource` |
| **API Keyæ¥æº** | `DOUBAO_ASR_API_KEY \|\| LLM_API_KEY` | `LLM_API_KEY` |
| **GPT-4oè½¬å½•ä»£ç ** | å®Œå…¨ç›¸åŒ | å®Œå…¨ç›¸åŒ |

---

## æ ¹æœ¬åŸå› åˆ†æ

### ğŸ”´ æ ¸å¿ƒé—®é¢˜ï¼šNext.js maxDuration å¯¼è‡´çš„è¯·æ±‚æå‰ç»ˆæ­¢

#### æœºåˆ¶è§£æ

å½“Next.jsè·¯ç”±è®¾ç½®äº† `export const maxDuration = 300` åï¼š

1. **å…¨å±€æ‰§è¡Œæ—¶é—´é™åˆ¶**
   - Next.jsä¸ºæ•´ä¸ªè·¯ç”±å‡½æ•°è®¾ç½®300ç§’çš„æ‰§è¡Œæ—¶é—´é™åˆ¶
   - è¿™ä¸ä»…é™åˆ¶è·¯ç”±å‡½æ•°æœ¬èº«ï¼Œè¿˜å½±å“å…¶å†…éƒ¨çš„æ‰€æœ‰å¼‚æ­¥æ“ä½œ

2. **è‡ªåŠ¨ç»ˆæ­¢æœºåˆ¶**
   - å½“è·¯ç”±å·²è¿è¡Œæ¥è¿‘300ç§’æ—¶ï¼ŒNext.jsä¼š**è‡ªåŠ¨ç»ˆæ­¢**æ‰€æœ‰pendingçš„fetchè¯·æ±‚
   - è¿™é€šè¿‡å†…éƒ¨çš„AbortControllerå®ç°

3. **é”™è¯¯ä¼ æ’­é“¾**
   ```
   Next.jsè¶…æ—¶ç›‘æµ‹
     â†“
   ä¸­æ–­å†…éƒ¨fetchè¯·æ±‚
     â†“
   undiciæŠ›å‡º BodyTimeoutError
     â†“
   transcribeContentè¿”å›å¤±è´¥
     â†“
   sendSSEå°è¯•å†™å…¥å·²å…³é—­çš„controller
     â†“
   "Controller is already closed" é”™è¯¯
   ```

#### ä¸ºä»€ä¹ˆå•ä¸ªè§†é¢‘å°±ä¼šå¤±è´¥ï¼Ÿ

å•ä¸ªè§†é¢‘è½¬å½•çš„å®Œæ•´æµç¨‹è€—æ—¶ï¼š

```typescript
1. TikHubè·å–è§†é¢‘è¯¦æƒ…      2-5ç§’
2. ä¸‹è½½è§†é¢‘ (10-50MB)      10-60ç§’   âš ï¸
3. FFmpegæå–éŸ³é¢‘           5-15ç§’
4. GPT-4oè½¬å½• (éŸ³é¢‘â†’æ–‡å­—)  30-180ç§’  âš ï¸
5. Claudeä¼˜åŒ–æ–‡æ¡ˆ           10-40ç§’  âš ï¸
-------------------------------------------
æ€»è®¡                        57-300ç§’
```

**å…³é”®å˜é‡**ï¼š
- è§†é¢‘æ—¶é•¿ï¼šçŸ­è§†é¢‘30ç§’ vs é•¿è§†é¢‘3-5åˆ†é’Ÿ
- ç½‘ç»œé€Ÿåº¦ï¼šå¿«é€Ÿç½‘ç»œ vs æ…¢é€Ÿç½‘ç»œ
- GPT-4oè´Ÿè½½ï¼šAPIç¹å¿™æ—¶å“åº”æ›´æ…¢

**å…¸å‹å¤±è´¥åœºæ™¯**ï¼š
- è½¬å½•ä¸€ä¸ª3åˆ†é’Ÿçš„è§†é¢‘
- ä¸‹è½½è€—æ—¶ï¼š40ç§’ï¼ˆæ…¢é€Ÿç½‘ç»œï¼‰
- GPT-4oè½¬å½•ï¼š150ç§’ï¼ˆé•¿éŸ³é¢‘ï¼‰
- Claudeä¼˜åŒ–ï¼š35ç§’
- **æ€»è®¡ï¼š225ç§’ï¼Œæ¥è¿‘300ç§’é™åˆ¶**
- å¦‚æœå†æœ‰ä»»ä½•å»¶è¿Ÿï¼ˆç½‘ç»œæ³¢åŠ¨ã€APIé‡è¯•ï¼‰ï¼Œå°±ä¼šè¶…è¿‡300ç§’
- Next.jsæå‰ç»ˆæ­¢GPT-4oè¯·æ±‚ï¼ŒæŠ›å‡º `BodyTimeoutError`

---

### ğŸŸ  æ¬¡è¦é—®é¢˜ï¼šsendSSEå‡½æ•°ç¼ºå°‘çŠ¶æ€æ£€æŸ¥

```typescript
function sendSSE(
  controller: ReadableStreamDefaultController,
  event: string,
  data: any
) {
  const message = `event: ${event}\ndata: ${JSON.stringify(data)}\n\n`
  controller.enqueue(new TextEncoder().encode(message))  // âš ï¸ æ— çŠ¶æ€æ£€æŸ¥
}
```

**é—®é¢˜**ï¼š
- å½“controllerå·²å…³é—­æ—¶ï¼Œ`enqueue()` ä¼šæŠ›å‡ºå¼‚å¸¸
- å¯¼è‡´"Controller is already closed"é”™è¯¯

---

## ä¸ºä»€ä¹ˆå¯¹è¯æ¨¡å—è½¬å½•èƒ½æˆåŠŸï¼Ÿ

### å…³é”®å·®å¼‚ï¼šæ— maxDurationé™åˆ¶

`/api/douyin/extract-text` **æ²¡æœ‰è®¾ç½®** `maxDuration`ï¼Œå› æ­¤ï¼š

1. **å¼€å‘ç¯å¢ƒ**ï¼š
   - Next.js dev server æ²¡æœ‰ä¸¥æ ¼çš„è¶…æ—¶é™åˆ¶
   - å…è®¸è¯·æ±‚è¿è¡Œä»»æ„é•¿æ—¶é—´

2. **ç”Ÿäº§ç¯å¢ƒ**ï¼š
   - Vercelå…è´¹ç‰ˆé»˜è®¤10ç§’è¶…æ—¶ï¼ˆä½†æ­¤APIæœªéƒ¨ç½²åˆ°Vercelï¼‰
   - æœ¬åœ°/è‡ªå»ºæœåŠ¡å™¨ï¼šæ— é»˜è®¤è¶…æ—¶

3. **ç»“æœ**ï¼š
   - å³ä½¿GPT-4oè½¬å½•è€—æ—¶200ç§’ï¼Œä¹Ÿä¸ä¼šè¢«å¼ºåˆ¶ç»ˆæ­¢
   - è¯·æ±‚èƒ½å¤Ÿæ­£å¸¸å®Œæˆ

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç§»é™¤maxDurationé™åˆ¶ â­ æ¨èï¼ˆå¿«é€Ÿä¿®å¤ï¼‰

#### ä¿®æ”¹æ–‡ä»¶

`app/api/merchants/[id]/contents/batch-transcribe/stream/route.ts`

```diff
- export const maxDuration = 300 // 5åˆ†é’Ÿè¶…æ—¶
+ // ç§»é™¤maxDurationé™åˆ¶ï¼Œå…è®¸é•¿æ—¶é—´è½¬å½•ä»»åŠ¡
```

#### ä¼˜ç‚¹
- ç«‹å³è§£å†³é—®é¢˜
- ä¸å¯¹è¯æ¨¡å—è½¬å½•ä¿æŒä¸€è‡´
- å¼€å‘ç¯å¢ƒæ— é™åˆ¶ï¼Œç”Ÿäº§ç¯å¢ƒå¯é€šè¿‡vercel.jsoné…ç½®

#### ç¼ºç‚¹
- å¤±å»è¶…æ—¶ä¿æŠ¤ï¼Œå¯èƒ½å¯¼è‡´åƒµæ­»è¯·æ±‚å ç”¨èµ„æº

---

### æ–¹æ¡ˆ2ï¼šå¢åŠ maxDurationåˆ°æ›´å¤§å€¼

```typescript
export const maxDuration = 900 // 15åˆ†é’Ÿè¶…æ—¶ï¼ˆVercel Enterpriseæ”¯æŒï¼‰
```

#### é€‚ç”¨åœºæ™¯
- éœ€è¦ä¿ç•™è¶…æ—¶ä¿æŠ¤
- éƒ¨ç½²åœ¨æ”¯æŒé•¿æ—¶é—´æ‰§è¡Œçš„å¹³å°ï¼ˆVercel Enterpriseã€è‡ªå»ºæœåŠ¡å™¨ï¼‰

#### æ³¨æ„äº‹é¡¹
- Vercelå…è´¹ç‰ˆ/Proç‰ˆä¸æ”¯æŒè¶…è¿‡60ç§’
- éœ€è¦åœ¨ `vercel.json` ä¸­åŒæ­¥é…ç½®

---

### æ–¹æ¡ˆ3ï¼šä¸ºfetchè¯·æ±‚æ·»åŠ æ˜¾å¼è¶…æ—¶æ§åˆ¶ï¼ˆæ²»æ ‡ä¸æ²»æœ¬ï¼‰

```typescript
async function transcribeContent(...) {
  // ä¸ºGPT-4oè½¬å½•æ·»åŠ 2åˆ†é’Ÿè¶…æ—¶
  const abortController = new AbortController()
  const timeoutId = setTimeout(() => abortController.abort(), 120000)

  try {
    const asrResponse = await fetch('https://api.302.ai/v1/chat/completions', {
      method: 'POST',
      headers: {...},
      body: JSON.stringify({...}),
      signal: abortController.signal  // âš ï¸ æ·»åŠ signal
    })

    clearTimeout(timeoutId)

    const asrResult = await asrResponse.json()
    // ...
  } catch (error) {
    clearTimeout(timeoutId)

    if (error.name === 'AbortError') {
      return {
        contentId,
        status: 'failed',
        error: 'è½¬å½•è¶…æ—¶ï¼ˆè¶…è¿‡2åˆ†é’Ÿï¼‰ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡è¯•',
      }
    }
    throw error
  }
}
```

#### é—®é¢˜
- **æ— æ³•è§£å†³æ ¹æœ¬é—®é¢˜**ï¼šå³ä½¿è®¾ç½®2åˆ†é’Ÿè¶…æ—¶ï¼Œæ•´ä¸ªæµç¨‹ä»å¯èƒ½åœ¨5åˆ†é’Ÿå†…è¢«Next.jsç»ˆæ­¢
- åªæ˜¯æå‰æš´éœ²è¶…æ—¶ï¼Œè€Œä¸æ˜¯çœŸæ­£è§£å†³

---

### æ–¹æ¡ˆ4ï¼šæ”¹è¿›sendSSEå‡½æ•°ï¼ˆé˜²æ­¢äºŒæ¬¡å´©æºƒï¼‰

```typescript
function sendSSE(
  controller: ReadableStreamDefaultController,
  event: string,
  data: any
): boolean {
  try {
    // æ£€æŸ¥controlleræ˜¯å¦ä»ç„¶æ‰“å¼€
    if (controller.desiredSize === null) {
      console.warn('[SSE] Controllerå·²å…³é—­ï¼Œè·³è¿‡äº‹ä»¶:', event)
      return false
    }

    const message = `event: ${event}\ndata: ${JSON.stringify(data)}\n\n`
    controller.enqueue(new TextEncoder().encode(message))
    return true
  } catch (error) {
    console.error('[SSE] å‘é€äº‹ä»¶å¤±è´¥:', event, error)
    return false
  }
}
```

#### ä½¿ç”¨æ–¹å¼

```typescript
batchResults.forEach((result, index) => {
  // ... å¤„ç†é€»è¾‘ ...

  // æ£€æŸ¥å‘é€æ˜¯å¦æˆåŠŸ
  const sent = sendSSE(controller, 'item', {...})
  if (!sent) {
    console.warn('å®¢æˆ·ç«¯å·²æ–­å¼€ï¼Œåœæ­¢å‘é€è¿›åº¦')
    return // æå‰é€€å‡ºforEach
  }
})
```

#### ä¼˜ç‚¹
- é˜²æ­¢"Controller is already closed"é”™è¯¯
- ä¼˜é›…å¤„ç†å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
- ä¸ä¼šå½±å“æ ¸å¿ƒé€»è¾‘

---

## æ¨èå®æ–½æ–¹æ¡ˆ

### ç¬¬ä¸€æ­¥ï¼šç«‹å³ä¿®å¤ï¼ˆç§»é™¤maxDurationï¼‰

```typescript
// app/api/merchants/[id]/contents/batch-transcribe/stream/route.ts

import { NextRequest } from 'next/server'
import { getServerSession } from 'next-auth'
// ... å…¶ä»–å¯¼å…¥ ...

// âŒ åˆ é™¤è¿™ä¸€è¡Œ
// export const maxDuration = 300

/**
 * å‘é€ SSE äº‹ä»¶ï¼ˆæ”¹è¿›ç‰ˆï¼‰
 */
function sendSSE(
  controller: ReadableStreamDefaultController,
  event: string,
  data: any
): boolean {
  try {
    if (controller.desiredSize === null) {
      return false
    }
    const message = `event: ${event}\ndata: ${JSON.stringify(data)}\n\n`
    controller.enqueue(new TextEncoder().encode(message))
    return true
  } catch (error) {
    console.error('[æ‰¹é‡è½¬å½•] SSEå‘é€å¤±è´¥:', event, error)
    return false
  }
}

// ... å…¶ä½™ä»£ç ä¿æŒä¸å˜ ...
```

### ç¬¬äºŒæ­¥ï¼šæ”¹è¿›é”™è¯¯å¤„ç†

```typescript
batchResults.forEach((result, index) => {
  processed++

  let itemResult
  if (result.status === 'fulfilled') {
    itemResult = result.value
  } else {
    itemResult = {
      contentId: batch[index].id,
      status: 'failed' as const,
      error: result.reason?.message || 'æœªçŸ¥é”™è¯¯',
      title: batch[index].title,
    }
  }

  // ç»Ÿè®¡
  if (itemResult.status === 'success') {
    succeeded++
  } else if (itemResult.status === 'failed') {
    failed++
  }

  // â­ æ£€æŸ¥å‘é€çŠ¶æ€
  const sent = sendSSE(controller, 'item', {
    ...itemResult,
    progress: {
      processed,
      total: targetContents.length,
      succeeded,
      failed,
    },
  })

  // â­ å¦‚æœå®¢æˆ·ç«¯æ–­å¼€ï¼Œåœæ­¢å¤„ç†
  if (!sent) {
    console.warn('[æ‰¹é‡è½¬å½•] å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ï¼Œåœæ­¢å‘é€è¿›åº¦')
    return
  }
})
```

### ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—ï¼ˆå¯é€‰ï¼‰

```typescript
async function transcribeContent(
  contentId: string,
  merchantId: string,
  apiKey: string
): Promise<...> {
  const startTime = Date.now()
  console.log(`[è½¬å½•] å¼€å§‹å¤„ç†è§†é¢‘: ${contentId}`)

  try {
    // 1. è·å–å†…å®¹è¯¦æƒ…
    console.log(`[è½¬å½•] è·å–å†…å®¹è¯¦æƒ…...`)
    const content = await prisma.merchantContent.findUnique(...)

    // 2. è·å–è§†é¢‘è¯¦æƒ…
    console.log(`[è½¬å½•] è·å–TikHubè§†é¢‘è¯¦æƒ…...`)
    const videoDetail = await tikhubClient.getVideoDetail(...)

    // 3. ä¸‹è½½è§†é¢‘
    const downloadStart = Date.now()
    console.log(`[è½¬å½•] å¼€å§‹ä¸‹è½½è§†é¢‘...`)
    const downloadResult = await VideoProcessor.downloadVideo(...)
    console.log(`[è½¬å½•] è§†é¢‘ä¸‹è½½å®Œæˆï¼Œè€—æ—¶: ${Date.now() - downloadStart}ms`)

    // 4. æå–éŸ³é¢‘
    const extractStart = Date.now()
    console.log(`[è½¬å½•] å¼€å§‹æå–éŸ³é¢‘...`)
    const audioBuffer = await VideoProcessor.extractAudio(...)
    console.log(`[è½¬å½•] éŸ³é¢‘æå–å®Œæˆï¼Œè€—æ—¶: ${Date.now() - extractStart}ms`)

    // 5. GPT-4o è½¬å½•
    const asrStart = Date.now()
    console.log(`[è½¬å½•] å¼€å§‹GPT-4oè½¬å½•ï¼ŒéŸ³é¢‘å¤§å°: ${audioBuffer.length} bytes`)
    const asrResponse = await fetch('https://api.302.ai/v1/chat/completions', ...)
    const asrResult = await asrResponse.json()
    console.log(`[è½¬å½•] GPT-4oè½¬å½•å®Œæˆï¼Œè€—æ—¶: ${Date.now() - asrStart}ms`)

    // 6. Claude ä¼˜åŒ–
    const optimizeStart = Date.now()
    console.log(`[è½¬å½•] å¼€å§‹Claudeä¼˜åŒ–...`)
    const optimizedText = await optimizeTextWithLLM(...)
    console.log(`[è½¬å½•] Claudeä¼˜åŒ–å®Œæˆï¼Œè€—æ—¶: ${Date.now() - optimizeStart}ms`)

    console.log(`[è½¬å½•] è§†é¢‘å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶: ${Date.now() - startTime}ms`)

    return {
      contentId,
      status: 'success',
      transcript: optimizedText || transcribedText,
      textLength: (optimizedText || transcribedText).length,
    }
  } catch (error: any) {
    console.error(`[è½¬å½•] è§†é¢‘å¤„ç†å¤±è´¥ (${Date.now() - startTime}ms):`, error)
    return {
      contentId,
      status: 'failed',
      error: error.message || 'æœªçŸ¥é”™è¯¯',
    }
  }
}
```

---

## éªŒè¯æ–¹æ¡ˆ

### 1. ç¡®è®¤é—®é¢˜æ˜¯å¦ç”±maxDurationå¼•èµ·

#### æµ‹è¯•æ­¥éª¤

```bash
# 1. å¤‡ä»½å½“å‰ä»£ç 
git diff app/api/merchants/[id]/contents/batch-transcribe/stream/route.ts

# 2. ä¸´æ—¶ç§»é™¤maxDuration
# æ³¨é‡Šæ‰: export const maxDuration = 300

# 3. é‡å¯å¼€å‘æœåŠ¡å™¨
pnpm dev

# 4. åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•æ‰¹é‡è½¬å½•åŠŸèƒ½
# é€‰æ‹©ä¹‹å‰å¤±è´¥çš„åŒä¸€ä¸ªè§†é¢‘

# 5. è§‚å¯Ÿæ—¥å¿—è¾“å‡º
```

#### é¢„æœŸç»“æœ

- âœ… å¦‚æœæˆåŠŸï¼šç¡®è®¤é—®é¢˜æ˜¯maxDurationå¯¼è‡´
- âŒ å¦‚æœä»å¤±è´¥ï¼šè¯´æ˜æœ‰å…¶ä»–åŸå› 

### 2. å¯¹æ¯”ä¸åŒè§†é¢‘æ—¶é•¿çš„è½¬å½•ç»“æœ

| è§†é¢‘æ—¶é•¿ | é¢„æœŸè½¬å½•æ—¶é—´ | maxDuration=300 | maxDurationç§»é™¤ |
|---------|------------|----------------|----------------|
| 30ç§’    | 60-90ç§’    | âœ… æˆåŠŸ         | âœ… æˆåŠŸ         |
| 1åˆ†é’Ÿ   | 90-150ç§’   | âœ… æˆåŠŸ         | âœ… æˆåŠŸ         |
| 2åˆ†é’Ÿ   | 120-220ç§’  | âš ï¸ å¯èƒ½å¤±è´¥     | âœ… æˆåŠŸ         |
| 3åˆ†é’Ÿ   | 150-270ç§’  | âŒ å¤§æ¦‚ç‡å¤±è´¥   | âœ… æˆåŠŸ         |
| 5åˆ†é’Ÿ   | 200-350ç§’  | âŒ å¿…å®šå¤±è´¥     | âœ… æˆåŠŸ         |

---

## ç”Ÿäº§éƒ¨ç½²å»ºè®®

### Verceléƒ¨ç½²

å¦‚æœä½¿ç”¨Vercelï¼Œéœ€è¦åœ¨ `vercel.json` ä¸­é…ç½®ï¼š

```json
{
  "functions": {
    "app/api/merchants/[id]/contents/batch-transcribe/stream/route.ts": {
      "maxDuration": 300
    }
  }
}
```

**æ³¨æ„**ï¼š
- Vercel Hobby: æœ€å¤§10ç§’
- Vercel Pro: æœ€å¤§60ç§’
- Vercel Enterprise: æœ€å¤§900ç§’

**å»ºè®®**ï¼š
- å°†è½¬å½•ä»»åŠ¡æ”¹ä¸ºåå°Jobï¼ˆä½¿ç”¨Vercel Cronæˆ–ç¬¬ä¸‰æ–¹é˜Ÿåˆ—ï¼‰
- æˆ–ä½¿ç”¨è‡ªå»ºæœåŠ¡å™¨éƒ¨ç½²

### è‡ªå»ºæœåŠ¡å™¨/Dockeréƒ¨ç½²

æ— éœ€é™åˆ¶maxDurationï¼Œä½†å»ºè®®ï¼š

```typescript
// æ·»åŠ åˆç†çš„è¶…æ—¶é…ç½®
export const maxDuration = 900 // 15åˆ†é’Ÿ

// æˆ–å®Œå…¨ç§»é™¤ï¼Œä¾èµ–æ“ä½œç³»ç»Ÿçº§åˆ«çš„è¶…æ—¶
```

---

## æ€»ç»“

### é—®é¢˜æœ¬è´¨

**Next.jsçš„maxDurationé™åˆ¶è¿‡äºä¸¥æ ¼**ï¼Œå¯¼è‡´é•¿è€—æ—¶çš„è½¬å½•ä»»åŠ¡ï¼ˆç‰¹åˆ«æ˜¯é•¿è§†é¢‘ï¼‰åœ¨æ¥è¿‘300ç§’æ—¶è¢«å¼ºåˆ¶ç»ˆæ­¢ï¼ŒæŠ›å‡º`BodyTimeoutError`ã€‚

### æ ¸å¿ƒä¿®å¤

**ç§»é™¤maxDurationé™åˆ¶**ï¼Œä¸å¯¹è¯æ¨¡å—ä¿æŒä¸€è‡´ï¼Œå…è®¸è½¬å½•ä»»åŠ¡è‡ªç„¶å®Œæˆã€‚

### è¾…åŠ©æ”¹è¿›

1. æ”¹è¿›`sendSSE`å‡½æ•°ï¼Œé˜²æ­¢äºŒæ¬¡å´©æºƒ
2. æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
3. ç”Ÿäº§ç¯å¢ƒæ ¹æ®å¹³å°é€‰æ‹©åˆé€‚çš„è¶…æ—¶ç­–ç•¥

---

## é™„å½•ï¼šNext.js maxDuration å®˜æ–¹æ–‡æ¡£

> **maxDuration** specifies the maximum allowed duration for a route handler to execute before timing out.
>
> - Development: No default limit
> - Vercel Hobby: 10 seconds
> - Vercel Pro: 60 seconds
> - Vercel Enterprise: 900 seconds
> - Self-hosted: No default limit

æ¥æºï¼š[Next.js Route Segment Config](https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#maxduration)

---

## å‚è€ƒæ–‡ä»¶

- æˆåŠŸæ¡ˆä¾‹ï¼š`app/api/douyin/extract-text/route.ts`
- é—®é¢˜ä»£ç ï¼š`app/api/merchants/[id]/contents/batch-transcribe/stream/route.ts`
- å®¢æˆ·ç«¯å¯¹æ¯”ï¼š
  - `hooks/use-douyin-extraction.ts` (fetch)
  - `components/merchants/batch-transcribe-dialog.tsx` (EventSource)
- æµ‹è¯•è„šæœ¬ï¼š`scripts/test-transcript-flow.ts`
