# æ‰¹é‡è½¬å½•åŠŸèƒ½é”™è¯¯åˆ†ææŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

æ‰¹é‡è½¬å½•åŠŸèƒ½åœ¨å¤„ç†è§†é¢‘æ—¶å‡ºç°ä¸¤ä¸ªå…³é”®é”™è¯¯ï¼š

```
è½¬å½•å†…å®¹ 116722ce-5060-4b74-90c1-b42cbad8824c å¤±è´¥: [TypeError: terminated] {
  [cause]: [Error [BodyTimeoutError]: Body Timeout Error] {
    code: 'UND_ERR_BODY_TIMEOUT'
  }
}

æ‰¹é‡è½¬å½•å¤±è´¥: TypeError: Invalid state: Controller is already closed
    at sendSSE (app\api\merchants\[id]\contents\batch-transcribe\stream\route.ts:24:14)
```

---

## æ ¹æœ¬åŸå› åˆ†æ

### 1. **Body Timeout Error - è¯·æ±‚ä½“è¯»å–è¶…æ—¶**

#### é—®é¢˜æè¿°
åœ¨è½¬å½•å•ä¸ªè§†é¢‘æ—¶ï¼Œæ•´ä¸ªæµç¨‹è€—æ—¶è¾ƒé•¿ï¼š

```typescript
// å•ä¸ªè§†é¢‘è½¬å½•æµç¨‹ï¼ˆtranscribeContentå‡½æ•°ï¼‰
async function transcribeContent() {
  // 1. è·å–TikHubè§†é¢‘è¯¦æƒ…       - 2-5ç§’
  const videoDetail = await tikhubClient.getVideoDetail(...)

  // 2. ä¸‹è½½è§†é¢‘ï¼ˆå¯èƒ½å‡ MB-50MBï¼‰ - 5-30ç§’
  const videoBuffer = await VideoProcessor.downloadVideo(videoUrl, ...)

  // 3. æå–éŸ³é¢‘ï¼ˆFFmpegå¤„ç†ï¼‰    - 3-10ç§’
  const audioBuffer = await VideoProcessor.extractAudio(videoBuffer, ...)

  // 4. GPT-4oéŸ³é¢‘è½¬å½•           - 20-60ç§’ âš ï¸
  const asrResponse = await fetch('https://api.302.ai/v1/chat/completions', ...)

  // 5. Claudeä¼˜åŒ–æ–‡æ¡ˆ           - 10-30ç§’
  const optimizedText = await optimizeTextWithLLM(...)
}
```

**å…³é”®é—®é¢˜**ï¼šç¬¬4æ­¥çš„GPT-4oè½¬å½•è¯·æ±‚å¯èƒ½è€—æ—¶æé•¿ï¼ˆç‰¹åˆ«æ˜¯é•¿è§†é¢‘ï¼‰ï¼Œè€Œï¼š
- Node.js fetch çš„é»˜è®¤bodyè¯»å–è¶…æ—¶çº¦ä¸º **30-60ç§’**
- å½“è§†é¢‘è¾ƒé•¿ï¼ˆå¦‚3-5åˆ†é’Ÿï¼‰æ—¶ï¼ŒGPT-4oè½¬å½•å¯èƒ½è¶…è¿‡60ç§’
- å¯¼è‡´ `BodyTimeoutError`ï¼Œè¯·æ±‚è¢«å¼ºåˆ¶ç»ˆæ­¢

#### éªŒè¯ä¾æ®

å¯¹æ¯”é¡¹ç›®ä¸­æˆåŠŸè¿è¡Œçš„ `app/api/douyin/extract-text/route.ts`ï¼š
- å®ƒå¤„ç†**å•ä¸ªè§†é¢‘**ï¼Œæ•´ä¸ªæµç¨‹æœ‰SSEè¿›åº¦åé¦ˆ
- å®ƒåœ¨ä¸‹è½½æ­¥éª¤ä½¿ç”¨äº† `signal: req.signal` æ”¯æŒå®¢æˆ·ç«¯å–æ¶ˆ
- ä½†å®ƒ**åŒæ ·æ²¡æœ‰ä¸ºGPT-4oè½¬å½•è®¾ç½®æ˜¾å¼è¶…æ—¶**

è¿™æ„å‘³ç€ï¼š
- çŸ­è§†é¢‘ï¼ˆ<30ç§’éŸ³é¢‘ï¼‰ï¼šæˆåŠŸç‡é«˜
- ä¸­ç­‰è§†é¢‘ï¼ˆ30ç§’-2åˆ†é’Ÿï¼‰ï¼šå¯èƒ½è¶…æ—¶
- é•¿è§†é¢‘ï¼ˆ>2åˆ†é’Ÿï¼‰ï¼šå‡ ä¹å¿…å®šè¶…æ—¶

---

### 2. **Controller Already Closed - æµæ§åˆ¶å™¨çŠ¶æ€é”™è¯¯**

#### é—®é¢˜æè¿°

åœ¨ `batch-transcribe/stream/route.ts:470-502` çš„æ‰¹å¤„ç†é€»è¾‘ä¸­ï¼š

```typescript
const batchResults = await Promise.allSettled(promises)

batchResults.forEach((result, index) => {
  processed++

  // ... å¤„ç†ç»“æœ ...

  // é—®é¢˜ï¼šå³ä½¿controllerå·²å…³é—­ï¼Œè¿™é‡Œä»ä¼šæ‰§è¡Œ
  sendSSE(controller, 'item', {
    ...itemResult,
    progress: {...}
  })
})
```

**è§¦å‘æ¡ä»¶**ï¼š
1. æŸä¸ªè§†é¢‘è½¬å½•å‘ç”Ÿ `BodyTimeoutError`
2. Promise.allSettled æ•è·è¯¥é”™è¯¯ï¼Œä½†ä¸ä¼šä¸­æ–­forEachå¾ªç¯
3. å¦‚æœå®¢æˆ·ç«¯åœ¨è¶…æ—¶åæ–­å¼€SSEè¿æ¥ï¼Œcontrollerè¢«å…³é—­
4. åç»­çš„ `sendSSE()` è°ƒç”¨ä¼šå¤±è´¥ï¼š`Controller is already closed`

#### ä»£ç å±‚é¢çš„é—®é¢˜

```typescript
function sendSSE(
  controller: ReadableStreamDefaultController,
  event: string,
  data: any
) {
  const message = `event: ${event}\ndata: ${JSON.stringify(data)}\n\n`
  controller.enqueue(new TextEncoder().encode(message))  // âš ï¸ æ²¡æœ‰æ£€æŸ¥controllerçŠ¶æ€
}
```

`sendSSE` å‡½æ•°æ²¡æœ‰ï¼š
- æ£€æŸ¥ `controller` æ˜¯å¦ä»ç„¶æ‰“å¼€
- æ•è· `enqueue()` æŠ›å‡ºçš„å¼‚å¸¸
- æä¾›å¤±è´¥æ—¶çš„é™çº§å¤„ç†

---

## é¡¹ç›®ä¸­å·²æœ‰çš„æˆåŠŸæ–¹æ¡ˆå¯¹æ¯”

### âœ… æˆåŠŸæ¡ˆä¾‹ï¼š`app/api/douyin/extract-text/route.ts`

```typescript
export async function POST(req: NextRequest) {
  const stream = new ReadableStream({
    async start(controller) {
      try {
        // âœ… ä½¿ç”¨æœ¬åœ°å‡½æ•°å‘é€äº‹ä»¶
        const sendEvent = (type: string, data: any) => {
          controller.enqueue(
            encoder.encode(`data: ${JSON.stringify({ type, ...data })}\n\n`)
          )
        }

        // âœ… ä¸‹è½½æ­¥éª¤æ”¯æŒå®¢æˆ·ç«¯å–æ¶ˆ
        const downloadResult = await VideoProcessor.downloadVideo(videoUrl, videoInfo, {
          headers: requestHeaders,
          signal: req.signal,  // ä¼ é€’requestçš„abort signal
          onProgress: async (downloaded, total) => {
            sendEvent('progress', {...})
          }
        })

        // âŒ ä½†GPT-4oè½¬å½•åŒæ ·æ²¡æœ‰è¶…æ—¶æ§åˆ¶
        const asrResponse = await fetch('https://api.302.ai/v1/chat/completions', {
          // ç¼ºå°‘ signal å’Œ timeout
        })

        // âœ… æœ€åå…³é—­controller
        controller.close()
      } catch (error) {
        // âœ… é”™è¯¯å¤„ç†å®Œå–„
        sendEvent('error', { message: errorMessage })
        controller.close()
      }
    }
  })
}
```

**å…³é”®å·®å¼‚**ï¼š
- âœ… å•ä¸ªè§†é¢‘å¤„ç†ï¼Œæ€»è€—æ—¶å¯æ§
- âœ… æœ‰è¯¦ç»†çš„è¿›åº¦åé¦ˆ
- âœ… ä½¿ç”¨ try-catch åŒ…è£¹æ•´ä¸ªæµç¨‹
- âŒ ä½†åŒæ ·æ²¡æœ‰è§£å†³GPT-4oè½¬å½•è¶…æ—¶é—®é¢˜

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¸ºfetchè¯·æ±‚æ·»åŠ è¶…æ—¶æ§åˆ¶ â­ æ¨è

#### å®ç°æ–¹å¼

```typescript
async function transcribeContent(...) {
  // ... å‰ç½®æ­¥éª¤ ...

  // ä½¿ç”¨AbortControllerå®ç°è¶…æ—¶
  const transcribeTimeout = 120000 // 2åˆ†é’Ÿè¶…æ—¶
  const abortController = new AbortController()
  const timeoutId = setTimeout(() => abortController.abort(), transcribeTimeout)

  try {
    const asrResponse = await fetch('https://api.302.ai/v1/chat/completions', {
      method: 'POST',
      headers: {...},
      body: JSON.stringify({...}),
      signal: abortController.signal  // â­ å…³é”®ï¼šæ·»åŠ signal
    })

    clearTimeout(timeoutId)

    // ... å¤„ç†å“åº” ...
  } catch (error) {
    clearTimeout(timeoutId)

    if (error.name === 'AbortError') {
      return {
        contentId,
        status: 'failed',
        error: 'è½¬å½•è¶…æ—¶ï¼ˆè¶…è¿‡2åˆ†é’Ÿï¼‰',
      }
    }
    throw error
  }
}
```

#### ä¼˜ç‚¹
- ç²¾ç¡®æ§åˆ¶æ¯ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´
- é¿å…å› è¶…æ—¶å¯¼è‡´çš„èµ„æºæ³„æ¼
- é”™è¯¯ä¿¡æ¯æ›´æ˜ç¡®

---

### æ–¹æ¡ˆ2ï¼šæ”¹è¿›SSEå‘é€å‡½æ•°ï¼Œé˜²æ­¢å†™å…¥å·²å…³é—­çš„controller

```typescript
function sendSSE(
  controller: ReadableStreamDefaultController,
  event: string,
  data: any
) {
  // â­ æ£€æŸ¥controllerçŠ¶æ€
  try {
    if (controller.desiredSize === null) {
      console.warn('Controllerå·²å…³é—­ï¼Œè·³è¿‡å‘é€äº‹ä»¶:', event)
      return false
    }

    const message = `event: ${event}\ndata: ${JSON.stringify(data)}\n\n`
    controller.enqueue(new TextEncoder().encode(message))
    return true
  } catch (error) {
    console.error('å‘é€SSEäº‹ä»¶å¤±è´¥:', event, error)
    return false
  }
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```typescript
batchResults.forEach((result, index) => {
  // ... å¤„ç†é€»è¾‘ ...

  // â­ æ£€æŸ¥å‘é€æ˜¯å¦æˆåŠŸ
  const sent = sendSSE(controller, 'item', {...})
  if (!sent) {
    console.warn('å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ï¼Œåœæ­¢å‘é€è¿›åº¦')
    return // æå‰é€€å‡ºforEach
  }
})
```

---

### æ–¹æ¡ˆ3ï¼šé™ä½å¹¶å‘æ•°ï¼Œåˆ†æ‰¹å¤„ç†

å½“å‰é»˜è®¤å¹¶å‘æ•°ä¸º 100ï¼š

```typescript
const concurrent = parseInt(searchParams.get('concurrent') || '100')
```

**é—®é¢˜**ï¼š
- 100ä¸ªå¹¶å‘è½¬å½•ä»»åŠ¡ä¼šå¯¼è‡´ï¼š
  - å¤§é‡ç½‘ç»œè¯·æ±‚ï¼ˆä¸‹è½½è§†é¢‘ï¼‰
  - FFmpegè¿›ç¨‹æ•°è¿‡å¤šï¼ˆæå–éŸ³é¢‘ï¼‰
  - GPT-4o APIé™æµ
  - å†…å­˜å ç”¨è¿‡é«˜

**å»ºè®®**ï¼š

```typescript
// æ ¹æ®ä»»åŠ¡ç±»å‹è°ƒæ•´å¹¶å‘æ•°
const concurrent = Math.min(
  parseInt(searchParams.get('concurrent') || '5'),
  5  // æœ€å¤§ä¸è¶…è¿‡5ä¸ªå¹¶å‘
)
```

**åŸå› **ï¼š
- æ¯ä¸ªè½¬å½•ä»»åŠ¡åŒ…å«è§†é¢‘ä¸‹è½½ï¼ˆå¯èƒ½10-50MBï¼‰
- FFmpegéŸ³é¢‘æå–æ˜¯CPUå¯†é›†å‹
- GPT-4oè½¬å½•æ˜¯é•¿è€—æ—¶I/Oæ“ä½œ
- 5ä¸ªå¹¶å‘å·²ç»è¶³å¤Ÿåˆ©ç”¨èµ„æº

---

### æ–¹æ¡ˆ4ï¼šæ·»åŠ æ•´ä½“æµç¨‹çš„å¥åº·æ£€æŸ¥

```typescript
const stream = new ReadableStream({
  async start(controller) {
    let isAlive = true

    // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
    const healthCheck = setInterval(() => {
      try {
        if (controller.desiredSize === null) {
          isAlive = false
          clearInterval(healthCheck)
        }
      } catch {
        isAlive = false
        clearInterval(healthCheck)
      }
    }, 5000) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

    try {
      for (let i = 0; i < targetContents.length; i += concurrent) {
        // â­ æ£€æŸ¥è¿æ¥çŠ¶æ€
        if (!isAlive) {
          console.log('å®¢æˆ·ç«¯æ–­å¼€ï¼Œåœæ­¢æ‰¹é‡è½¬å½•')
          break
        }

        const batch = targetContents.slice(i, i + concurrent)
        // ... å¤„ç†æ‰¹æ¬¡ ...
      }
    } finally {
      clearInterval(healthCheck)
      controller.close()
    }
  }
})
```

---

## æœ€ä½³å®è·µæ€»ç»“

### âœ… æ¨èçš„å®Œæ•´æ”¹è¿›æ–¹æ¡ˆ

1. **ä¸ºæ‰€æœ‰é•¿è€—æ—¶fetchæ·»åŠ è¶…æ—¶æ§åˆ¶**
   - GPT-4oè½¬å½•ï¼š120ç§’è¶…æ—¶
   - Claudeä¼˜åŒ–ï¼š60ç§’è¶…æ—¶
   - TikHub APIï¼š30ç§’è¶…æ—¶

2. **æ”¹è¿›sendSSEå‡½æ•°**
   - æ£€æŸ¥controllerçŠ¶æ€
   - æ•è·enqueueå¼‚å¸¸
   - è¿”å›å¸ƒå°”å€¼æŒ‡ç¤ºæˆåŠŸ/å¤±è´¥

3. **é™ä½é»˜è®¤å¹¶å‘æ•°**
   - ä»100é™ä½åˆ°3-5
   - æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´

4. **æ·»åŠ è¿æ¥å¥åº·æ£€æŸ¥**
   - å®šæœŸæ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦æ–­å¼€
   - æå‰ç»ˆæ­¢æ— æ„ä¹‰çš„å¤„ç†

5. **æ”¹è¿›é”™è¯¯æ—¥å¿—**
   - è®°å½•æ¯ä¸ªå¤±è´¥è§†é¢‘çš„è¯¦ç»†ä¿¡æ¯
   - ä¾¿äºæ’æŸ¥é—®é¢˜

### âš ï¸ æ³¨æ„äº‹é¡¹

- **ä¸è¦ç›²ç›®å¢åŠ  `maxDuration`**ï¼šé—®é¢˜ä¸åœ¨äºNext.jså‡½æ•°è¶…æ—¶ï¼Œè€Œåœ¨äºfetchè¯·æ±‚è¶…æ—¶
- **æ§åˆ¶å¹¶å‘æ•°**ï¼šè§†é¢‘è½¬å½•æ˜¯èµ„æºå¯†é›†å‹ä»»åŠ¡ï¼Œé«˜å¹¶å‘ä¼šå¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š
- **ç›‘æ§GPT-4o APIå“åº”æ—¶é—´**ï¼šå¦‚æœAPIç»å¸¸è¶…æ—¶ï¼Œè€ƒè™‘åˆ‡æ¢åˆ°å…¶ä»–ASRæœåŠ¡æˆ–å¢åŠ é‡è¯•é€»è¾‘

---

## å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ–¹æ¡ˆ | å·¥ä½œé‡ | å½±å“èŒƒå›´ |
|-------|------|--------|---------|
| ğŸ”´ P0 | ä¸ºGPT-4oè½¬å½•æ·»åŠ è¶…æ—¶æ§åˆ¶ | ä½ | é«˜ |
| ğŸŸ  P1 | æ”¹è¿›sendSSEå‡½æ•°é˜²æ­¢crash | ä½ | ä¸­ |
| ğŸŸ¡ P2 | é™ä½é»˜è®¤å¹¶å‘æ•°åˆ°5 | æä½ | ä¸­ |
| ğŸŸ¢ P3 | æ·»åŠ è¿æ¥å¥åº·æ£€æŸ¥ | ä¸­ | ä½ |

---

## é™„å½•ï¼šé—®é¢˜å¤ç°æ­¥éª¤

1. é€‰æ‹©å¤šä¸ªé•¿è§†é¢‘ï¼ˆ>2åˆ†é’ŸéŸ³é¢‘ï¼‰è¿›è¡Œæ‰¹é‡è½¬å½•
2. è®¾ç½®å¹¶å‘æ•°ä¸º100
3. è§‚å¯Ÿæ—¥å¿—ï¼Œä¼šçœ‹åˆ°ï¼š
   - éƒ¨åˆ†è§†é¢‘å‡ºç° `BodyTimeoutError`
   - éšåå‡ºç° `Controller is already closed`
   - æ•´ä¸ªæ‰¹æ¬¡å¤±è´¥

---

## å‚è€ƒæ–‡ä»¶

- âœ… æˆåŠŸå®ç°ï¼š`app/api/douyin/extract-text/route.ts`
- âŒ é—®é¢˜ä»£ç ï¼š`app/api/merchants/[id]/contents/batch-transcribe/stream/route.ts`
- è§†é¢‘å¤„ç†ï¼š`lib/video/video-processor.ts`
- æµ‹è¯•è„šæœ¬ï¼š`scripts/test-transcript-flow.ts`
