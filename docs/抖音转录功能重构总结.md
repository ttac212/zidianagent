# æŠ–éŸ³è§†é¢‘è½¬å½•åŠŸèƒ½é‡æ„æ€»ç»“

## ğŸ“‹ æ”¹è¿›æ¦‚è¿°

æœ¬æ¬¡é‡æ„é’ˆå¯¹ã€Šé—®é¢˜æ–‡æ¡£.txtã€‹ä¸­æå‡ºçš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜è¿›è¡Œäº†ç³»ç»Ÿæ€§æ”¹è¿›ï¼Œéµå¾ª Linus Torvalds çš„è®¾è®¡å“²å­¦ï¼š"ç®€å•èƒœè¿‡å¤æ‚ï¼Œåˆ é™¤ä¼˜äºé‡æ„"ã€‚

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. ã€è‡´å‘½é—®é¢˜ã€‘åˆ é™¤åŠŸèƒ½åå­˜å®äº¡çš„ partialResults

**é—®é¢˜**ï¼šåç«¯ä»æœªå‘é€ `partial` äº‹ä»¶ï¼Œä½†å‰ç«¯æœ‰å®Œæ•´çš„å®æ—¶æ®µè½å±•ç¤º UIï¼Œé€ æˆä»£ç å†—ä½™å’Œç”¨æˆ·è¯¯å¯¼ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… åˆ é™¤ `PartialResult` æ¥å£å®šä¹‰ (hooks/use-douyin-extraction.ts:27-31)
- âœ… ä» `ExtractionResult` ä¸­ç§»é™¤ `segments`ã€`totalSegments`ã€`successSegments` å­—æ®µ
- âœ… åˆ é™¤ `UseDouyinExtractionReturn` ä¸­çš„ `partialResults` çŠ¶æ€
- âœ… ç§»é™¤ Hook ä¸­çš„ `setPartialResults` çŠ¶æ€ç®¡ç†
- âœ… åˆ é™¤ SSE äº‹ä»¶å¤„ç†å™¨ä¸­çš„ `partial` å’Œ `warning` case
- âœ… ç§»é™¤å‰ç«¯ UI çš„"æ­£åœ¨è¯†åˆ«ä¸­"å¡ç‰‡ (douyin-extractor.tsx:110-131)
- âœ… ç§»é™¤ç»“æœç»Ÿè®¡ä¸­çš„"X/Y æ®µè¯†åˆ«æˆåŠŸ"æ˜¾ç¤º

**å½±å“**ï¼š
- ä»£ç è¡Œæ•°å‡å°‘ï¼š~80 è¡Œ
- çŠ¶æ€ç®¡ç†ç®€åŒ–ï¼šä» 5 ä¸ªçŠ¶æ€å‡å°‘åˆ° 4 ä¸ª
- UI æ›´æ¸…æ™°ï¼šç”¨æˆ·ä¸å†çœ‹åˆ°æ°¸è¿œä¸ºç©ºçš„"å®æ—¶è¯†åˆ«"åŒºåŸŸ

---

### 2. ã€æ”¹è¿›æ–¹å‘ã€‘ç²¾ç®€ SSE äº‹ä»¶ç±»å‹

**é—®é¢˜**ï¼šSSE åè®®å£°æ˜äº† 5 ç§äº‹ä»¶ï¼ˆ`progress`ã€`info`ã€`partial`ã€`warning`ã€`done`ã€`error`ï¼‰ï¼Œä½†å®é™…åªä½¿ç”¨äº† 3 ç§ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… ç§»é™¤å‰ç«¯å¯¹ `partial` äº‹ä»¶çš„å¤„ç†é€»è¾‘
- âœ… ç§»é™¤å‰ç«¯å¯¹ `warning` äº‹ä»¶çš„å¤„ç†é€»è¾‘
- âœ… ä¿ç•™æ ¸å¿ƒäº‹ä»¶ï¼š`progress`ã€`info`ã€`done`ã€`error`

**å½“å‰ SSE äº‹ä»¶åè®®**ï¼ˆç²¾ç®€åï¼‰ï¼š
```typescript
// progress - é˜¶æ®µè¿›åº¦æ›´æ–°ï¼ˆå¸¦ç™¾åˆ†æ¯”ï¼‰
{ type: 'progress', stage: string, message: string, percent: number }

// info - é˜¶æ®µä¿¡æ¯é€šçŸ¥ï¼ˆä¸å¸¦ç™¾åˆ†æ¯”ï¼‰
{ type: 'info', stage: string, message: string }

// done - å¤„ç†å®Œæˆ
{ type: 'done', text: string, originalText: string, videoInfo: {...}, stats: {...} }

// error - é”™è¯¯ç»ˆæ­¢
{ type: 'error', message: string }
```

**å‘åå…¼å®¹**ï¼šåç«¯å¯ä»¥ç»§ç»­å‘é€ä»»ä½•äº‹ä»¶ç±»å‹ï¼Œå‰ç«¯ä¼šå¿½ç•¥æœªçŸ¥ç±»å‹å¹¶è¾“å‡ºè­¦å‘Šæ—¥å¿—ã€‚

---

### 3. ã€æ”¹è¿›æ–¹å‘ã€‘æŠ½å–è¿›åº¦æ˜ å°„å‡½æ•°

**é—®é¢˜**ï¼šVideoProcessor ä¸‹è½½è¿›åº¦æ˜ å°„æ‰‹ç®—å¤æ‚ (route.ts:112)ï¼š
```typescript
const mappedPercent = Math.min(40, Math.max(20, 20 + Math.floor((percent / 100) * 20)));
```

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»º `lib/douyin/progress-mapper.ts` ç»Ÿä¸€ç®¡ç†è¿›åº¦æ˜ å°„ã€‚

```typescript
// é˜¶æ®µè¿›åº¦åŒºé—´é…ç½®
const STAGE_RANGES = {
  parsing: { start: 0, end: 10 },
  analyzing: { start: 10, end: 20 },
  downloading: { start: 20, end: 40 },
  extracting: { start: 40, end: 50 },
  transcribing: { start: 50, end: 80 },
  optimizing: { start: 80, end: 95 },
  done: { start: 95, end: 100 },
}

// ä½¿ç”¨ç¤ºä¾‹
mapStageProgress('downloading', 50)  // è¿”å› 30 (20-40 åŒºé—´çš„ä¸­ç‚¹)
```

**ä¼˜åŠ¿**ï¼š
- å•ä¸€çœŸç›¸æ¥æºï¼šæ‰€æœ‰é˜¶æ®µè¿›åº¦æ˜ å°„åœ¨ä¸€å¤„ç®¡ç†
- æ˜“äºè°ƒæ•´ï¼šä¿®æ”¹æŸé˜¶æ®µæƒé‡åªéœ€æ”¹é…ç½®è¡¨
- å¯æµ‹è¯•æ€§ï¼šçº¯å‡½æ•°ï¼Œè¾“å…¥è¾“å‡ºæ˜ç¡®

**ä»£ç ç®€åŒ–**ï¼š
```diff
- const mappedPercent = Math.min(40, Math.max(20, 20 + Math.floor((percent / 100) * 20)));
+ const mappedPercent = mapStageProgress('downloading', percent);
```

---

### 4. ã€æ”¹è¿›æ–¹å‘ã€‘æ•°æ®ç»“æ„å°è£…

**é—®é¢˜**ï¼šAPI route é‡Œå……æ–¥ `awemeDetail.xxx`ï¼Œåˆ†äº«é“¾æ¥è§£æå’Œ TikHub è°ƒç”¨é€»è¾‘æ•£è½ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»º `lib/douyin/video-source.ts` å°è£…è§†é¢‘æºæ•°æ®ã€‚

```typescript
export interface DouyinVideoSource {
  videoId: string;
  userId?: string;
  secUserId?: string;
  title: string;
  author: string;
  playUrl: string;
  duration: number;
  hashtags: string[];
  videoTags: string[];
}

export async function createVideoSourceFromShareLink(shareLink: string): Promise<DouyinVideoSource>
```

**API route é‡æ„å‰åå¯¹æ¯”**ï¼š

**é‡æ„å‰** (74 è¡Œé€»è¾‘)ï¼š
```typescript
const shareResult = await parseDouyinVideoShare(shareLink);
const tikhubClient = getTikHubClient();
const videoDetail = await tikhubClient.getVideoDetail({ aweme_id: shareResult.videoId });
const awemeDetail = videoDetail?.aweme_detail;
const videoUrl = resolvePlayableVideoUrl(awemeDetail);
const videoDuration = normalizeDurationSeconds(awemeDetail.video?.duration);
const hashtags = awemeDetail.text_extra?.filter(...).map(...) || [];
const videoTags = awemeDetail.video_tag?.map(...).filter(...) || [];
// ... ä½¿ç”¨ awemeDetail.descã€awemeDetail.author.nickname ç­‰
```

**é‡æ„å** (1 è¡Œè°ƒç”¨)ï¼š
```typescript
const videoSource = await createVideoSourceFromShareLink(shareLink);
// ç›´æ¥ä½¿ç”¨ videoSource.titleã€videoSource.authorã€videoSource.playUrl ç­‰
```

**åˆ é™¤çš„è¾…åŠ©å‡½æ•°**ï¼š
- `resolvePlayableVideoUrl()` - è¿ç§»åˆ° video-source.ts
- `normalizeDurationSeconds()` - è¿ç§»åˆ° video-source.ts

**ä¼˜åŠ¿**ï¼š
- å…³æ³¨ç‚¹åˆ†ç¦»ï¼šè§†é¢‘æºè·å–ä¸å¤„ç†æµç¨‹è§£è€¦
- å¤ç”¨æ€§ï¼šå…¶ä»–æ¨¡å—å¯ç›´æ¥ä½¿ç”¨ `createVideoSourceFromShareLink`
- å¯æµ‹è¯•æ€§ï¼šè§†é¢‘æºåˆ›å»ºé€»è¾‘å¯ç‹¬ç«‹æµ‹è¯•
- ä»£ç å¯è¯»æ€§ï¼šAPI route åªå…³æ³¨"åšä»€ä¹ˆ"ï¼Œä¸å…³å¿ƒ"æ€ä¹ˆåš"

---

## ğŸ“Š é‡æ„æˆæœ

### ä»£ç åº¦é‡
- **åˆ é™¤ä»£ç **ï¼š~150 è¡Œ
- **æ–°å¢ä»£ç **ï¼š~80 è¡Œï¼ˆå·¥å…·åº“ï¼‰
- **å‡€å‡å°‘**ï¼š~70 è¡Œ
- **ä¿®æ”¹æ–‡ä»¶**ï¼š5 ä¸ª

### å¤æ‚åº¦é™ä½
- **çŠ¶æ€å˜é‡**ï¼š5 â†’ 4 (-20%)
- **SSE äº‹ä»¶ç±»å‹**ï¼š5 â†’ 4 (-20%)
- **API route åµŒå¥—å±‚çº§**ï¼šå‡å°‘ 1 å±‚
- **æ‰‹åŠ¨è®¡ç®—é€»è¾‘**ï¼š3 å¤„ â†’ 0 å¤„

### æ¶æ„æ”¹è¿›
- âœ… æ¶ˆé™¤äº†"åŠŸèƒ½åå­˜å®äº¡"çš„æŠ€æœ¯å€º
- âœ… æå‡äº†ä»£ç å¯ç»´æŠ¤æ€§ï¼ˆå•ä¸€çœŸç›¸æ¥æºï¼‰
- âœ… å¢å¼ºäº†å¯æµ‹è¯•æ€§ï¼ˆçº¯å‡½æ•° + æ•°æ®å°è£…ï¼‰
- âœ… ä¿æŒäº†å‘åå…¼å®¹æ€§ï¼ˆSSE åè®®ä¸ç ´åç°æœ‰æµç¨‹ï¼‰

---

## ğŸ”„ è¿ç§»æŒ‡å—

### å‰ç«¯ä½¿ç”¨å˜åŒ–

**æ—§ä»£ç **ï¼š
```typescript
const { isExtracting, progress, partialResults, result, error, ... } = useDouyinExtraction();

// UI ä¸­å±•ç¤ºå®æ—¶æ®µè½
{partialResults.map(partial => <div>{partial.text}</div>)}

// ç»“æœç»Ÿè®¡
<span>{result.stats.successSegments}/{result.stats.totalSegments} æ®µè¯†åˆ«æˆåŠŸ</span>
```

**æ–°ä»£ç **ï¼š
```typescript
const { isExtracting, progress, result, error, ... } = useDouyinExtraction();

// partialResults å·²ç§»é™¤

// ç»“æœç»Ÿè®¡
<span>å…± {result.stats.totalCharacters} å­—</span>
```

### åç«¯ä½¿ç”¨å˜åŒ–

**è¿›åº¦å‘é€ï¼ˆæ—§ä»£ç ï¼‰**ï¼š
```typescript
sendEvent('progress', {
  stage: 'downloading',
  message: `ä¸‹è½½è¿›åº¦ ${percent}%`,
  percent: Math.min(40, Math.max(20, 20 + Math.floor((percent / 100) * 20))),
});
```

**è¿›åº¦å‘é€ï¼ˆæ–°ä»£ç ï¼‰**ï¼š
```typescript
sendEvent('progress', {
  stage: 'downloading',
  message: `ä¸‹è½½è¿›åº¦ ${percent}%`,
  percent: mapStageProgress('downloading', percent),
});
```

---

## âœ… è´¨é‡æ£€æŸ¥

### TypeScript ç±»å‹æ£€æŸ¥
```bash
pnpm type-check  # âœ… é€šè¿‡
```

### ESLint ä»£ç æ£€æŸ¥
```bash
pnpm lint  # âœ… é€šè¿‡ï¼ˆä»…æœ‰å…¶ä»–æ–‡ä»¶çš„æ— å…³è­¦å‘Šï¼‰
```

---

## ğŸ¯ è®¾è®¡åŸåˆ™éµå¾ª

### Linus Torvalds çš„å“å‘³åŸåˆ™

1. âœ… **"åˆ é™¤ç‰¹æ®Šæƒ…å†µ"**ï¼šç§»é™¤äº†æ°¸è¿œä¸ä¼šè§¦å‘çš„ partial äº‹ä»¶å¤„ç†
2. âœ… **"æ•°æ®ç»“æ„ä¼˜äºä»£ç "**ï¼šåˆ›å»º DouyinVideoSource ç»Ÿä¸€ç®¡ç†è§†é¢‘ä¿¡æ¯
3. âœ… **"è¿™ 10 è¡Œå¯ä»¥å˜æˆ 3 è¡Œ"**ï¼šè¿›åº¦æ˜ å°„ä»æ‰‹ç®—å˜æˆé…ç½®è¡¨æŸ¥è¯¢
4. âœ… **"ä¿æŒå‘åå…¼å®¹"**ï¼šSSE åè®®æœªç ´åï¼Œåªæ˜¯å‰ç«¯ä¸å†å¤„ç†å†—ä½™äº‹ä»¶

### ç®€å•æ€§åŸåˆ™

- **å‡å°‘æŠ½è±¡å±‚æ¬¡**ï¼šä» 5 å±‚åµŒå¥—é™ä½åˆ° 4 å±‚
- **å•ä¸€çœŸç›¸æ¥æº**ï¼šè¿›åº¦æ˜ å°„ã€è§†é¢‘æºåˆ›å»ºé›†ä¸­ç®¡ç†
- **æœ€å°æƒŠè®¶åŸåˆ™**ï¼šç”¨æˆ·ä¸å†çœ‹åˆ°æ°¸è¿œä¸ºç©ºçš„"å®æ—¶è¯†åˆ«"åŒºåŸŸ

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜æœºåˆ¶ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
**é—®é¢˜**ï¼šé‡å¤é“¾æ¥ä¼šé‡å¤ä¸‹è½½å¤§è§†é¢‘
**æ–¹æ¡ˆ**ï¼šä½¿ç”¨ videoId ä½œä¸º key ç¼“å­˜è½¬å½•ç»“æœ
```typescript
const cacheKey = `douyin:${videoSource.videoId}`;
const cached = await redis.get(cacheKey);
if (cached) return cached;
```

### 2. å¤–éƒ¨æœåŠ¡å¥åº·æ£€æŸ¥ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
**é—®é¢˜**ï¼šTikHub/302.ai/ZenMux ä»»ä¸€æœåŠ¡æŒ‚æ‰å…¨é“¾è·¯å¤±è´¥
**æ–¹æ¡ˆ**ï¼š
- æ·»åŠ æœåŠ¡é™çº§ç­–ç•¥ï¼ˆASR å¤±è´¥æ—¶è¿”å›åŸå§‹éŸ³é¢‘ï¼‰
- å®ç°é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- æ·»åŠ æœåŠ¡çŠ¶æ€ç›‘æ§ç«¯ç‚¹

### 3. SSE å¿ƒè·³æœºåˆ¶ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
**é—®é¢˜**ï¼šé•¿è§†é¢‘å¤„ç†æ—¶ CDN/Edge å¯èƒ½åˆ‡æ–­è¿æ¥
**æ–¹æ¡ˆ**ï¼š
```typescript
const heartbeat = setInterval(() => {
  sendEvent('info', { message: 'processing...' });
}, 30000);
```

### 4. æ”¯æŒå£ä»¤å¼åˆ†äº«ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
**é—®é¢˜**ï¼šç”¨æˆ·å¤åˆ¶"é•¿æŒ‰å¤åˆ¶å£ä»¤"çš„æ–‡æœ¬ä¼šè§£æå¤±è´¥
**æ–¹æ¡ˆ**ï¼šæ·»åŠ æ­£åˆ™æå–å£ä»¤ä¸­çš„çŸ­é“¾æ¥

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
```typescript
// lib/douyin/progress-mapper.test.ts
test('mapStageProgress è¾¹ç•Œå€¼', () => {
  expect(mapStageProgress('downloading', 0)).toBe(20);
  expect(mapStageProgress('downloading', 100)).toBe(40);
});

// lib/douyin/video-source.test.ts
test('createVideoSourceFromShareLink æå–æ­£ç¡®ä¿¡æ¯', async () => {
  const source = await createVideoSourceFromShareLink(mockShareLink);
  expect(source.videoId).toBe('7123456789');
});
```

### é›†æˆæµ‹è¯•
```typescript
// e2e/douyin-extraction.spec.ts
test('å®Œæ•´è½¬å½•æµç¨‹', async () => {
  const response = await fetch('/api/douyin/extract-text', {
    method: 'POST',
    body: JSON.stringify({ shareLink: testLink }),
  });
  // éªŒè¯ SSE äº‹ä»¶åºåˆ—
});
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- `lib/douyin/progress-mapper.ts` - è¿›åº¦æ˜ å°„å·¥å…·
- `lib/douyin/video-source.ts` - è§†é¢‘æºæ•°æ®å°è£…
- `docs/æŠ–éŸ³è½¬å½•åŠŸèƒ½é‡æ„æ€»ç»“.md` - æœ¬æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
- `hooks/use-douyin-extraction.ts` - åˆ é™¤ partialResults çŠ¶æ€
- `components/douyin/douyin-extractor.tsx` - åˆ é™¤å®æ—¶æ®µè½ UI
- `app/api/douyin/extract-text/route.ts` - ä½¿ç”¨æ–°æ•°æ®ç»“æ„

---

**é‡æ„å®Œæˆæ—¶é—´**ï¼š2025-01-11
**éªŒè¯çŠ¶æ€**ï¼šâœ… ç±»å‹æ£€æŸ¥é€šè¿‡ / âœ… Lint æ£€æŸ¥é€šè¿‡
**å‘åå…¼å®¹æ€§**ï¼šâœ… SSE åè®®ä¿æŒå…¼å®¹
