# 商家客群分析功能 - 使用指南

## 功能概述

商家客群分析功能通过聚合多个TOP视频的评论数据，使用LLM智能分析商家的客群画像，包括地域分布、用户特征、消费行为等多维度洞察。

## 技术架构

### 数据持久化
- **数据库表**: `MerchantAudienceAnalysis`
- **关联关系**: `merchantId` (唯一键) → `Merchant`
- **存储内容**:
  - 聚合统计（分析视频数、评论数）
  - 地域分布（JSON格式）
  - LLM分析结果（客群画像、人口统计、行为特征、兴趣偏好、痛点、建议）
  - 完整Markdown报告

### Pipeline架构
- **文件**: `lib/merchant/audience-analysis-pipeline.ts`
- **5步流程**:
  1. 选择TOP视频（按评论数排序）
  2. 采集评论（TikHub API，包含 `ip_label` 地域数据）
  3. 聚合数据（统计地域分布）
  4. AI分析（LLM生成客群画像）
  5. 保存结果（持久化到数据库）
- **特点**:
  - SSE流式输出进度
  - 支持中止信号
  - 完整的错误处理

### API接口
- **POST** `/api/merchants/[id]/analyze-audience`
  - 执行客群分析
  - SSE流式返回进度和结果
  - 参数：
    - `topN`: 分析TOP N个视频（默认5，范围1-20）
    - `maxCommentsPerVideo`: 每个视频最多采集评论数（默认100，范围10-500）

- **GET** `/api/merchants/[id]/analyze-audience`
  - 查询已有的客群分析结果
  - 返回完整的分析数据和Markdown报告

### 前端Hook
- **执行分析**: `useMerchantAudienceAnalysis()`
  - 状态管理（idle/analyzing/completed/error）
  - 实时进度追踪
  - 流式Markdown接收
  - 取消和重置功能

- **查询结果**: `useMerchantAudienceData(merchantId)`
  - React Query缓存管理
  - 自动重试和错误处理
  - 5分钟缓存策略

## 使用方法

### 1. 命令行测试

```bash
# 测试单个商家的客群分析
npx tsx scripts/test-audience-analysis.ts <merchantId>

# 示例
npx tsx scripts/test-audience-analysis.ts cm3abc123xyz
```

测试脚本会：
- 验证商家存在性和评论数据
- 显示将要分析的TOP5视频
- 实时显示分析进度
- 输出完整的Markdown报告
- 验证数据库持久化

### 2. 前端集成示例

```typescript
import { useMerchantAudienceAnalysis, useMerchantAudienceData } from '@/hooks/api/use-merchant-audience-analysis'

function MerchantAudiencePage({ merchantId }: { merchantId: string }) {
  // 查询已有的分析结果
  const { data: existingAnalysis, isLoading } = useMerchantAudienceData(merchantId)

  // 执行新的分析
  const {
    analyze,
    status,
    progress,
    result,
    partialMarkdown,
    isAnalyzing
  } = useMerchantAudienceAnalysis()

  const handleAnalyze = () => {
    analyze(merchantId, {
      topN: 5,
      maxCommentsPerVideo: 100
    })
  }

  return (
    <div>
      {/* 显示已有分析结果 */}
      {existingAnalysis && (
        <div>
          <h2>客群分析报告</h2>
          <p>分析时间: {new Date(existingAnalysis.analyzedAt).toLocaleString()}</p>
          <p>分析视频数: {existingAnalysis.videosAnalyzed}</p>
          <p>评论样本数: {existingAnalysis.commentsAnalyzed}</p>

          {/* 地域分布 */}
          {existingAnalysis.locationStats && (
            <div>
              <h3>地域分布TOP5</h3>
              {existingAnalysis.locationStats.slice(0, 5).map((stat, i) => (
                <div key={i}>
                  {stat.location}: {stat.count}条 ({stat.percentage.toFixed(1)}%)
                </div>
              ))}
            </div>
          )}

          {/* 完整报告 */}
          <div dangerouslySetInnerHTML={{ __html: markdownToHtml(existingAnalysis.rawMarkdown) }} />
        </div>
      )}

      {/* 重新分析按钮 */}
      <button onClick={handleAnalyze} disabled={isAnalyzing}>
        {isAnalyzing ? '分析中...' : '重新分析客群'}
      </button>

      {/* 分析进度 */}
      {isAnalyzing && progress && (
        <div>
          <progress value={progress.percentage} max={100} />
          <p>{progress.label}: {progress.detail}</p>
        </div>
      )}

      {/* 实时分析内容 */}
      {isAnalyzing && partialMarkdown && (
        <div>
          <h3>分析中...</h3>
          <pre>{partialMarkdown}</pre>
        </div>
      )}

      {/* 分析结果 */}
      {result && (
        <div>
          <h3>分析完成</h3>
          <p>分析了 {result.videosAnalyzed} 个视频，{result.commentsAnalyzed} 条评论</p>
          <div dangerouslySetInnerHTML={{ __html: markdownToHtml(result.markdown) }} />
        </div>
      )}
    </div>
  )
}
```

## 数据流程

```
用户触发分析
    ↓
POST /api/merchants/[id]/analyze-audience
    ↓
runAudienceAnalysisPipeline()
    ├─ 1. 选择评论数TOP5的视频 (Prisma查询)
    ├─ 2. 调用TikHub API采集评论 (包含ip_label)
    ├─ 3. 聚合地域统计
    ├─ 4. 调用LLM分析客群画像
    └─ 5. 保存到MerchantAudienceAnalysis表
    ↓
SSE流式返回结果 → 前端实时展示
    ↓
React Query缓存更新
```

## 关键数据字段

### TikHub API评论数据
```typescript
interface DouyinComment {
  cid: string           // 评论ID
  text: string          // 评论文本
  user: {
    uid: string
    nickname: string
  }
  digg_count: number    // 点赞数
  reply_comment_total: number  // 回复数
  ip_label?: string     // ⭐ 地域标签（如"北京"）
  create_time: number   // 创建时间戳
}
```

### 地域统计数据
```typescript
interface LocationStat {
  location: string      // 地域名称
  count: number         // 评论数量
  percentage: number    // 占比（%）
}
```

### 分析结果结构
```typescript
interface AudienceAnalysisData {
  id: string
  merchantId: string
  videosAnalyzed: number
  commentsAnalyzed: number
  videoIds: string[]            // 参与分析的视频ID列表
  locationStats: LocationStat[] // 地域分布
  audienceProfile: any          // 综合客群画像
  demographics: any             // 人口统计
  behaviors: any                // 消费行为
  interests: any                // 兴趣偏好
  painPoints: any               // 用户痛点
  suggestions: any              // 改进建议
  rawMarkdown: string           // 完整Markdown报告
  analyzedAt: string
  modelUsed: string
  tokenUsed: number
}
```

## LLM分析维度

系统会指导LLM按以下6个维度分析客群：

1. **客群画像概览**
   - 核心客群特征总结
   - 主要用户群体画像

2. **地域分布分析**
   - 地域集中度特征
   - 不同地区用户差异
   - 地域营销建议

3. **用户需求分析**
   - 高频咨询问题
   - 核心购买动机
   - 决策关键因素

4. **用户行为特征**
   - 消费心理（价格敏感度、品质要求）
   - 购买决策流程
   - 互动偏好

5. **用户反馈的问题**
   - 常见疑虑和顾虑
   - 产品/服务改进方向

6. **营销建议**
   - 内容策略建议
   - 目标人群精准定位
   - 转化优化方向

## 注意事项

1. **数据依赖**
   - 商家必须有至少1个有评论的视频
   - 评论数据通过TikHub API实时获取（不依赖数据库中的评论记录）

2. **性能考虑**
   - 默认分析TOP5视频，每个视频最多100条评论
   - 总评论数可能达到500条，LLM分析耗时约10-20秒
   - 支持并发采集评论，但有500ms延迟避免API限流

3. **成本控制**
   - 使用ZenMux API（Claude Sonnet 4.5）
   - 单次分析约消耗3000-6000 tokens
   - 结果持久化，每个商家只保留最新一次分析

4. **错误处理**
   - 单个视频采集失败不影响整体流程
   - 支持AbortSignal中止分析
   - 所有错误通过SSE事件反馈给前端

## 后续优化方向

1. **数据库评论存储**
   - 当前依赖TikHub API实时采集
   - 可考虑增强`MerchantContentComment`表，存储`ip_label`字段
   - 支持离线分析，降低API依赖

2. **分析结果结构化**
   - 当前主要存储Markdown报告
   - 可以增强LLM prompt，返回结构化JSON
   - 存储到`demographics`、`behaviors`等字段

3. **历史趋势对比**
   - 当前只保留最新一次分析
   - 可以考虑保留历史记录，支持趋势对比

4. **定时自动分析**
   - 结合`Merchant.monitoringEnabled`配置
   - 定期自动更新客群画像

## 相关文件清单

### 核心实现
- `prisma/schema.prisma` - 数据库模型定义
- `lib/merchant/audience-analysis-pipeline.ts` - 分析Pipeline
- `app/api/merchants/[id]/analyze-audience/route.ts` - API路由
- `hooks/api/use-merchant-audience-analysis.ts` - React Hook

### 测试工具
- `scripts/test-audience-analysis.ts` - 命令行测试脚本

### 依赖服务
- `lib/tikhub/client.ts` - TikHub API客户端
- `lib/douyin/comments-pipeline.ts` - 评论处理参考实现
- `lib/merchant/comments-source-manager.ts` - 评论数据源管理

## 快速开始

```bash
# 1. 重启开发环境（应用数据库变更）
Ctrl+C  # 停止当前服务
pnpm db:generate
pnpm dev

# 2. 测试客群分析（替换为实际商家ID）
npx tsx scripts/test-audience-analysis.ts cm3abc123xyz

# 3. 查看分析结果
# 在浏览器访问商家详情页，查看客群分析卡片
```

## 疑难解答

**Q: 提示"商家暂无评论数据"？**
A: 需要先运行商家内容同步脚本，采集视频和评论数据。

**Q: 分析失败"ZENMUX_API_KEY未配置"？**
A: 在`.env.local`中配置`ZENMUX_API_KEY`环境变量。

**Q: 数据库迁移失败？**
A: Windows环境下需要停止开发服务器，然后运行`pnpm db:generate`。

**Q: 如何调整分析参数？**
A: 在调用`analyze()`时传入`topN`和`maxCommentsPerVideo`参数。

**Q: 如何查看历史分析记录？**
A: 当前每个商家只保留最新一次分析，可通过GET API查询。
