# æ™ºç‚¹AIå¹³å°æ•°æ®ä¼ é€’é“¾å®Œæ•´æŒ‡å—

> ç”Ÿæˆæ—¶é—´ï¼š2025-10-30
> ç‰ˆæœ¬ï¼šv1.0
> ä½œè€…ï¼šClaude Code æ¶æ„åˆ†æ

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [å‰ç«¯æ•°æ®æµ](#å‰ç«¯æ•°æ®æµ)
3. [åç«¯æ•°æ®æµ](#åç«¯æ•°æ®æµ)
4. [èŠå¤©ç³»ç»ŸSSEæµå¼æ•°æ®](#èŠå¤©ç³»ç»Ÿsseæµå¼æ•°æ®)
5. [ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ](#ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ)
6. [React Queryç¼“å­˜ç­–ç•¥](#react-queryç¼“å­˜ç­–ç•¥)
7. [æ•°æ®æµå¯è§†åŒ–](#æ•°æ®æµå¯è§†åŒ–)
8. [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)

---

## æ¶æ„æ¦‚è§ˆ

### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: Next.js 15 + React 19 + TypeScript
- **çŠ¶æ€ç®¡ç†**: React Query + useReducer + Context
- **åç«¯**: Next.js App Router API + Prisma ORM
- **æ•°æ®åº“**: SQLite (å¼€å‘) / PostgreSQL (ç”Ÿäº§)
- **å®æ—¶é€šä¿¡**: Server-Sent Events (SSE)

### æ¶æ„æ¨¡å¼
æ™ºç‚¹AIå¹³å°é‡‡ç”¨**æœåŠ¡ç«¯çŠ¶æ€ + æœ¬åœ°çŠ¶æ€åˆ†ç¦»**çš„æ··åˆæ¶æ„ï¼š
- **æœåŠ¡ç«¯çŠ¶æ€**: React Queryç®¡ç†APIæ•°æ®ã€ç¼“å­˜ã€åŒæ­¥
- **æœ¬åœ°çŠ¶æ€**: useReducerç®¡ç†å¤æ‚UIçŠ¶æ€ï¼ŒuseStateç®¡ç†ç®€å•çŠ¶æ€
- **å…¨å±€çŠ¶æ€**: Context APIç”¨äºè®¤è¯ã€ä¸»é¢˜ã€å­˜å‚¨ç­‰è·¨ç»„ä»¶çŠ¶æ€

---

## å‰ç«¯æ•°æ®æµ

### 1. é¡µé¢ç»„ä»¶æ•°æ®æµ

#### ä¸»è¦é¡µé¢æ•°æ®è·å–æ¨¡å¼

**å·¥ä½œå° (app/workspace/page.tsx)**
```
ç”¨æˆ·è®¿é—® â†’ SessionProvideréªŒè¯ â†’ useConversationsQueryè·å–å¯¹è¯åˆ—è¡¨
   â†“
SmartChatCenterç»„ä»¶
   â†“
Propsä¼ é€’: onSend, onDelete, onRenameç­‰8ä¸ªProps
   â†“
ChatHeaderã€ChatMessagesã€ChatInputå­ç»„ä»¶
```

**å•†å®¶ç®¡ç† (app/merchants/page.tsx)**
```
ç”¨æˆ·è®¿é—® â†’ ç›´æ¥fetch API â†’ useStateç®¡ç†æ•°æ®
   â†“
æœ¬åœ°çŠ¶æ€: merchants, categories, stats
   â†“
âš ï¸ é—®é¢˜: æœªä½¿ç”¨React Queryï¼Œæ•°æ®ç®¡ç†ä¸ä¸€è‡´
```

### 2. Propsä¼ é€’é—®é¢˜

**ä¸¥é‡Props Drillingæ¡ˆä¾‹**:
- `SmartChatCenter`: 8ä¸ªPropsï¼ˆ6ä¸ªå›è°ƒå‡½æ•°ï¼‰
- `ConversationItem`: 11ä¸ªPropsï¼ˆå…¨éƒ¨é€šè¿‡çˆ¶ç»„ä»¶ä¼ é€’ï¼‰

**ä¼ é€’é“¾æ·±åº¦**:
```
WorkspacePage (é¡¶å±‚)
  â†’ SmartChatCenter (ç¬¬2å±‚)
    â†’ ChatHeader (ç¬¬3å±‚)
      â†’ æ“ä½œæŒ‰é’®ç»„ä»¶ (ç¬¬4å±‚)
```

**å»ºè®®**: å¼•å…¥ChatContextç®¡ç†èŠå¤©ç›¸å…³çŠ¶æ€

### 3. çŠ¶æ€ç®¡ç†åˆ†å¸ƒ

**ç»Ÿè®¡æ•°æ®**:
- `useState`ä½¿ç”¨: 73å¤„ï¼Œåˆ†å¸ƒåœ¨22ä¸ªç»„ä»¶
- `useReducer`ä½¿ç”¨: 1å¤„ï¼ˆchat-reducerç»Ÿä¸€ç®¡ç†èŠå¤©çŠ¶æ€ï¼‰
- `Context`ä½¿ç”¨: 4å¤„ï¼ˆSessionã€Storageã€Networkã€Themeï¼‰

**è‰¯å¥½æ¨¡å¼**:
```typescript
// âœ… èŠå¤©çŠ¶æ€ç»Ÿä¸€ç®¡ç†
const [state, dispatch] = useReducer(chatReducer, initialState)

// âœ… React Queryç®¡ç†æœåŠ¡ç«¯çŠ¶æ€
const { data: conversations } = useConversationsQuery()
```

**é—®é¢˜æ¨¡å¼**:
```typescript
// âŒ æ•°æ®è·å–æ–¹å¼ä¸ç»Ÿä¸€
// èŠå¤©ç³»ç»Ÿ: React Query
// å•†å®¶ç³»ç»Ÿ: fetch + useState
// ç®¡ç†ç³»ç»Ÿ: Mockæ•°æ® + useState
```

### 4. è‡ªå®šä¹‰Hooksåˆ†å±‚

**æ•°æ®è·å–å±‚**:
- `useConversationsQuery()` - å¯¹è¯åˆ—è¡¨
- `useConversationQuery(id)` - å¯¹è¯è¯¦æƒ…
- `useModelState()` - æ¨¡å‹é€‰æ‹©

**ä¸šåŠ¡é€»è¾‘å±‚**:
- `useChatActions()` - èŠå¤©æ“ä½œï¼ˆå‘é€ã€ä¸­æ­¢ï¼‰
- `useConversations()` - å¯¹è¯ç®¡ç†åè°ƒå™¨

**UIè¡Œä¸ºå±‚**:
- `useSafeLocalStorage()` - æœ¬åœ°å­˜å‚¨
- `useRequireAuth()` - è®¤è¯æ£€æŸ¥

---

## åç«¯æ•°æ®æµ

### 1. APIè·¯ç”±æ¶æ„

**æ ¸å¿ƒAPIç«¯ç‚¹**:
```
/api/chat                          - SSEæµå¼èŠå¤©
/api/conversations                 - å¯¹è¯ç®¡ç†ï¼ˆåˆ—è¡¨ã€åˆ›å»ºï¼‰
/api/conversations/[id]            - å•å¯¹è¯æ“ä½œï¼ˆæ›´æ–°ã€åˆ é™¤ï¼‰
/api/merchants                     - å•†å®¶æ•°æ®
/api/douyin/analyze-comments       - æŠ–éŸ³è¯„è®ºåˆ†æ
/api/users/[id]/model-stats        - ç”¨é‡ç»Ÿè®¡
```

### 2. ä¸­é—´ä»¶å¤„ç†é“¾

**è¯·æ±‚å¤„ç†æµç¨‹**:
```
HTTPè¯·æ±‚
  â†“
middleware.ts (è®¤è¯ã€æƒé™ã€é™æµ)
  â†“ æ³¨å…¥ x-user-id å’Œ x-user-role è¯·æ±‚å¤´
API Route Handler
  â†“ Zodæ•°æ®éªŒè¯
ä¸šåŠ¡é€»è¾‘å¤„ç†
  â†“ Prismaæ•°æ®åº“æ“ä½œ
HTTPå“åº” (é€šè¿‡HttpResponseå·¥å…·ç±»)
```

**ä¸­é—´ä»¶åŠŸèƒ½**:
1. **JWTéªŒè¯**: NextAuth tokenéªŒè¯
2. **æƒé™æ§åˆ¶**: ç®¡ç†å‘˜è·¯å¾„æ£€æŸ¥
3. **é€Ÿç‡é™åˆ¶**: åˆ†å¸ƒå¼é™æµï¼ˆ30-60æ¬¡/åˆ†é’Ÿï¼‰
4. **ç”¨æˆ·æ³¨å…¥**: è‡ªåŠ¨æ³¨å…¥userIdåˆ°è¯·æ±‚å¤´

### 3. æ•°æ®åº“äº¤äº’æ¨¡å¼

**æ ¸å¿ƒæ¨¡å‹è®¾è®¡**:

**Useræ¨¡å‹** - é…é¢ç®¡ç†
```typescript
{
  monthlyTokenLimit: 100000,     // æœˆåº¦é…é¢
  currentMonthUsage: 0,          // å½“å‰ä½¿ç”¨é‡
  totalTokenUsed: 0,             // æ€»ä½¿ç”¨é‡
  role: 'USER' | 'ADMIN'         // ç”¨æˆ·è§’è‰²
}
```

**Conversationæ¨¡å‹** - å†—ä½™ä¼˜åŒ–
```typescript
{
  lastMessageAt: DateTime,       // å†—ä½™å­—æ®µï¼Œä¼˜åŒ–æ’åº
  totalTokens: Int,              // æ€»tokenæ•°
  messageCount: Int,             // æ¶ˆæ¯æ•°é‡
  metadata: Json                 // çµæ´»å…ƒæ•°æ®
}
```

**Messageæ¨¡å‹** - é¿å…JOIN
```typescript
{
  userId: String,                // å†—ä½™userIdï¼Œé¿å…JOIN
  promptTokens: Int,             // æç¤ºè¯tokens
  completionTokens: Int,         // å®Œæˆtokens
  metadata: Json                 // å­˜å‚¨æ¨ç†å†…å®¹ç­‰
}
```

**ä¼˜åŒ–ç­–ç•¥**:
- âœ… ç´¢å¼•ä¼˜åŒ–: `[userId, lastMessageAt]`
- âœ… æ•°æ®å†—ä½™: userIdå†—ä½™é¿å…JOIN
- âœ… JSONå­—æ®µ: çµæ´»å­˜å‚¨å…ƒæ•°æ®

### 4. åŸå­æ€§é…é¢ç®¡ç†

**QuotaManagerå…³é”®æ“ä½œ**:
```typescript
// 1. é¢„ç•™é…é¢ï¼ˆåŸå­æ“ä½œï¼‰
await prisma.$executeRaw`
  UPDATE users
  SET currentMonthUsage = currentMonthUsage + ${estimatedTokens}
  WHERE id = ${userId}
  AND currentMonthUsage + ${estimatedTokens} <= monthlyTokenLimit
`

// 2. æäº¤å®é™…ä½¿ç”¨é‡
await QuotaManager.commitTokens(userId, actualTokens, estimatedTokens)

// 3. å¤±è´¥æ—¶å›æ»š
await QuotaManager.releaseTokens(userId, estimatedTokens)
```

**æµç¨‹ä¿è¯**:
- âœ… åŸå­æ€§æ›´æ–°ï¼ˆé˜²æ­¢å¹¶å‘è¶…é¢ï¼‰
- âœ… å¼‚å¸¸å›æ»šï¼ˆè¯·æ±‚å¤±è´¥æ—¶é‡Šæ”¾é…é¢ï¼‰
- âœ… å®Œæ•´äº‹åŠ¡ï¼ˆæ¶ˆæ¯åˆ›å»º + é…é¢æ›´æ–°ï¼‰

### 5. æ•°æ®éªŒè¯å’Œè½¬æ¢

**Zod SchemaéªŒè¯**:
```typescript
// èŠå¤©è¯·æ±‚éªŒè¯
export const chatRequestSchema = z.object({
  conversationId: z.string().uuid().optional(),
  messages: z.array(chatMessageSchema)
    .min(1, 'è‡³å°‘éœ€è¦ä¸€æ¡æ¶ˆæ¯')
    .max(200, 'ä¸èƒ½è¶…è¿‡200æ¡æ¶ˆæ¯'),
  model: z.string().optional(),
  temperature: z.number().min(0).max(2).optional()
})

// ä½¿ç”¨ç¤ºä¾‹
const validated = chatRequestSchema.parse(requestBody)
```

**ä¸Šä¸‹æ–‡è£å‰ªå™¨**:
```typescript
// å‰åç«¯å…±äº«çš„è£å‰ªé€»è¾‘
export function trimForChatAPI(messages, modelId, creativeMode) {
  const config = getModelContextConfig(modelId, creativeMode)
  return trimMessageHistory(messages, config)
}
```

---

## èŠå¤©ç³»ç»ŸSSEæµå¼æ•°æ®

### 1. SSEæ¶æ„æµç¨‹

**å®Œæ•´æµç¨‹å›¾**:
```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†“
useChatActions.sendMessage()
  â†“
POST /api/chat (SSEè¯·æ±‚)
  â†“ åç«¯å¤„ç†
é…é¢é¢„ç•™ â†’ ä¸Šä¸‹æ–‡è£å‰ª â†’ æä¾›å•†é€‰æ‹© â†’ AIæœåŠ¡è°ƒç”¨
  â†“
SSEæµå¼å“åº” (started â†’ chunk â†’ done)
  â†“ å‰ç«¯å¤„ç†
processSSEStream() â†’ è§£æäº‹ä»¶ â†’ æ›´æ–°UIçŠ¶æ€
  â†“
æ¶ˆæ¯æŒä¹…åŒ– â†’ é…é¢è°ƒæ•´ â†’ ç¼“å­˜åŒæ­¥
```

### 2. äº‹ä»¶åè®®

**æ ‡å‡†äº‹ä»¶ç±»å‹**:
```typescript
type ChatEvent =
  | { type: 'started'; userMessage; pendingAssistantId }
  | { type: 'chunk'; content?; delta?; reasoning?; pendingAssistantId }
  | { type: 'done'; assistantMessage; finishedAt }
  | { type: 'error'; error; recoverable }
```

**äº‹ä»¶ç¤ºä¾‹**:
```json
// startedäº‹ä»¶
{"type":"started","requestId":"req-123","userMessage":{...}}

// chunkäº‹ä»¶
{"type":"chunk","requestId":"req-123","delta":"ä½ å¥½","reasoning":"æ€è€ƒä¸­..."}

// doneäº‹ä»¶
{"type":"done","requestId":"req-123","assistantMessage":{...}}
```

### 3. æ¶ˆæ¯çŠ¶æ€åŒæ­¥

**çŠ¶æ€ç”Ÿå‘½å‘¨æœŸ**:
```
pending â†’ streaming â†’ completed
   â†“           â†“
 error â†â”€â”€â”€â”€â”€ error
```

**çŠ¶æ€ç®¡ç†**:
```typescript
// ç»Ÿä¸€çš„æ¶ˆæ¯çŠ¶æ€ç®¡ç†
case 'UPDATE_MESSAGE_STREAM': {
  const { messageId, content, delta, status, reasoning } = action.payload
  return {
    ...state,
    history: {
      messages: state.history.messages.map(msg => {
        if (msg.id !== messageId) return msg

        // æ›´æ–°æ¶ˆæ¯å†…å®¹å’ŒçŠ¶æ€
        const updated = { ...msg, status }
        if (content !== undefined) {
          updated.content = content
        } else if (delta && status === 'streaming') {
          updated.content = (msg.content || '') + delta
        }
        if (reasoning) updated.reasoning = reasoning

        return updated
      })
    }
  }
}
```

### 4. AbortControllerä¸­æ­¢æ§åˆ¶

**åŸå­åŒ–ä¸­æ­¢æœºåˆ¶**:
```typescript
// åŸå­åŒ–ä¸­æ­¢ä¸Šä¸€ä¸ªè¯·æ±‚å¹¶åˆ›å»ºæ–°çš„æ§åˆ¶å™¨
const currentController = new AbortController()
const previousController = abortRef.current
abortRef.current = currentController  // å…ˆè®¾ç½®æ–°æ§åˆ¶å™¨
previousController?.abort()            // å†ä¸­æ­¢æ—§çš„

// æ¸…ç†æœºåˆ¶
useEffect(() => {
  return () => {
    abortRef.current?.abort()
    abortRef.current = null
  }
}, [])
```

### 5. æ€§èƒ½ä¼˜åŒ–

**æµå¼æ›´æ–°èŠ‚æµ**:
```typescript
// ä½¿ç”¨æ‰¹é‡èŠ‚æµå™¨ï¼Œçº¦60fpsæ›´æ–°é¢‘ç‡
const streamThrottle = createBatchStreamThrottle((updates) => {
  onEvent?.({
    type: 'chunk',
    content: updates.content || streamingContent,
    reasoning: updates.reasoning
  })
}, { maxWait: 16 })  // 16ms â‰ˆ 60fps
```

**è™šæ‹Ÿæ»šåŠ¨**:
- è¶…è¿‡100æ¡æ¶ˆæ¯è‡ªåŠ¨å¯ç”¨è™šæ‹Ÿæ»šåŠ¨
- ä¼˜åŒ–é•¿å¯¹è¯æ€§èƒ½
- å‡å°‘DOMèŠ‚ç‚¹æ•°é‡

---

## ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ

### 1. AIæœåŠ¡æä¾›å•†æ¶æ„

**å¤šå±‚çº§é™çº§ç­–ç•¥**:
```
ZenMux (ä¼˜å…ˆçº§1)
  â†’ æ¨ç†æ¨¡å‹ã€å¤šæ¨¡å‹èšåˆ
  â†“ (å¤±è´¥æ—¶é™çº§)
302.AI (ä¼˜å…ˆçº§2)
  â†’ é€šç”¨LLMã€ASRè½¬å½•
  â†“ (ç‰¹å®šæ¨¡å‹)
ä¸“ç”¨API Key
  â†’ Claudeä¸“ç”¨Key
  â†’ Geminiä¸“ç”¨Key
  â†’ OpenAIä¸“ç”¨Key
```

**æä¾›å•†é€‰æ‹©é€»è¾‘**:
```typescript
export function selectProvider(modelId: string): LLMProvider {
  // æ”¯æŒå¸¦å‰ç¼€çš„æ¨¡å‹ID (å¦‚ anthropic/claude-sonnet-4.5)
  if (modelId.includes('/')) {
    return providers.find(p => p.name === 'ZenMux')
  }

  // å¦åˆ™è¿”å›ä¼˜å…ˆçº§æœ€é«˜çš„æä¾›å•†
  return providers[0]
}
```

### 2. TikHubæŠ–éŸ³æ•°æ®é‡‡é›†

**å®Œæ•´æ•°æ®é‡‡é›†æµç¨‹**:
```
è§¦å‘å•†å®¶æ•°æ®åŒæ­¥
  â†“
TikHub Clientåˆå§‹åŒ–
  â†“
è·å–ç”¨æˆ·èµ„æ–™ (getUserProfile)
  â†“
è·å–ç”¨æˆ·è§†é¢‘åˆ—è¡¨ (getVideos)
  â†“
æ‰¹é‡å¤„ç†è§†é¢‘æ•°æ®
  â†“
æ•°æ®æ˜ å°„å’ŒéªŒè¯
  â†“
æ•°æ®åº“æ‰¹é‡æ’å…¥ (Merchant + MerchantContent)
  â†“
æ›´æ–°å•†å®¶èšåˆæ•°æ®
```

**é”™è¯¯å¤„ç†å’Œé‡è¯•**:
```typescript
const TIKHUB_RETRY_CONFIG = {
  maxRetries: 3,
  retryDelay: 1000,
  circuitBreaker: {
    failureThreshold: 5,      // è¿ç»­5æ¬¡å¤±è´¥è§¦å‘ç†”æ–­
    resetTimeout: 60000       // 60ç§’åå°è¯•æ¢å¤
  }
}
```

### 3. æŠ–éŸ³è§†é¢‘å¤„ç†æµæ°´çº¿

**7æ­¥éª¤å¤„ç†æµç¨‹**:
```
1. parse-link      â†’ è§£ææŠ–éŸ³é“¾æ¥
2. fetch-detail    â†’ è·å–è§†é¢‘è¯¦æƒ…
3. download-video  â†’ ä¸‹è½½è§†é¢‘æ–‡ä»¶
4. extract-audio   â†’ FFmpegæå–éŸ³é¢‘
5. transcribe      â†’ GPT-4o Audioè½¬å½•
6. optimize        â†’ Claudeä¼˜åŒ–æ–‡æ¡ˆ
7. summarize       â†’ æ±‡æ€»ç»“æœ
```

**æµå¼è¿›åº¦æ›´æ–°**:
```typescript
await processDouyinVideo(videoUrl, {
  onProgress: (step, progress) => {
    console.log(`æ­¥éª¤${step}: ${progress}%`)
  },
  onStepComplete: (step, result) => {
    console.log(`æ­¥éª¤${step}å®Œæˆ:`, result)
  }
})
```

### 4. ASRè½¬å½•æœåŠ¡

**æ™ºèƒ½æ–‡æ¡ˆä¼˜åŒ–é“¾**:
```
éŸ³é¢‘æ–‡ä»¶
  â†“
GPT-4o Audio (ä¸»è¦è½¬å½•)
  â†“ (å¤±è´¥æ—¶)
è±†åŒ…ASR (å¤‡é€‰æ–¹æ¡ˆ)
  â†“
Claude Sonnet 4.5 (æ–‡æ¡ˆä¼˜åŒ–)
  â†“ ç»“åˆè§†é¢‘å…ƒæ•°æ®
ä¼˜åŒ–åçš„æ–‡æ¡ˆï¼ˆçº é”™ã€ä¼˜åŒ–å¯è¯»æ€§ï¼‰
```

---

## React Queryç¼“å­˜ç­–ç•¥

### 1. æŸ¥è¯¢Keyè®¾è®¡

**å±‚æ¬¡åŒ–Keyç»“æ„**:
```typescript
export const conversationKeys = {
  all: ['conversations'],
  lists: () => ['conversations', 'list'],
  detail: (id) => ['conversations', 'detail', id],
  messages: (id) => ['conversations', 'messages', id]
}
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**:
```typescript
// åˆ—è¡¨æŸ¥è¯¢
['conversations', 'list', 'summary', { page: 1, limit: 20 }]

// è¯¦æƒ…æŸ¥è¯¢
['conversations', 'detail', 'conv-123']
['conversations', 'detail', { id: 'conv-123', params: { take: 50 } }]
```

### 2. ç¼“å­˜æ›´æ–°ç­–ç•¥

**åˆ›å»ºå¯¹è¯ï¼ˆä¹è§‚æ›´æ–°ï¼‰**:
```typescript
onMutate: async (newConversation) => {
  // ç«‹å³æ·»åŠ åˆ°æ‰€æœ‰ç›¸å…³åˆ—è¡¨ç¼“å­˜
  queryClient.setQueriesData({
    predicate: (query) =>
      query.queryKey[0] === 'conversations' &&
      query.queryKey[1] === 'list'
  }, (oldData) =>
    Array.isArray(oldData)
      ? [newConversation, ...oldData]
      : [newConversation]
  )

  // åŒæ—¶ç¼“å­˜è¯¦æƒ…
  queryClient.setQueryData(
    conversationKeys.detail(newConversation.id),
    newConversation
  )
}
```

**æ›´æ–°å¯¹è¯ï¼ˆé˜²å¾¡æ€§åˆå¹¶ï¼‰**:
```typescript
onSuccess: (updatedConversation) => {
  queryClient.setQueriesData({
    predicate: (query) =>
      query.queryKey[0] === 'conversations' &&
      query.queryKey[1] === 'list'
  }, (oldData) => {
    return oldData.map(conv => {
      if (conv.id !== updatedConversation.id) return conv

      // æ™ºèƒ½åˆå¹¶ï¼Œä¿ç•™APIæœªè¿”å›çš„å­—æ®µ
      const hasCompleteMetadata =
        updatedConversation.metadata?.messageCount !== undefined

      if (!hasCompleteMetadata && conv.metadata) {
        return {
          ...conv,
          ...updatedConversation,
          metadata: {
            ...conv.metadata,
            ...updatedConversation.metadata
          }
        }
      }

      return { ...conv, ...updatedConversation }
    })
  })
}
```

### 3. é”™è¯¯å¤„ç†å’Œå›æ»š

**ä¹è§‚æ›´æ–° + é”™è¯¯å›æ»š**:
```typescript
onMutate: async ({ id, updates }) => {
  // å–æ¶ˆç›¸å…³æŸ¥è¯¢ï¼Œé˜²æ­¢ç«æ€
  await queryClient.cancelQueries({
    predicate: (query) => matchesConversationDetailKey(query.queryKey, id)
  })

  // ä¿å­˜å¿«ç…§ç”¨äºå›æ»š
  const previousDetails = queryClient.getQueriesData({
    predicate: (query) => matchesConversationDetailKey(query.queryKey, id)
  })

  return { previousDetails }
}

onError: (err, { id }, context) => {
  // é”™è¯¯å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€
  if (context?.previousDetails) {
    context.previousDetails.forEach(([key, data]) => {
      queryClient.setQueryData(key, data)
    })
  }
}
```

### 4. ç¼“å­˜å¤±æ•ˆæœºåˆ¶

**å…¨å±€é…ç½®**:
```typescript
defaultOptions: {
  queries: {
    staleTime: 1000 * 60,         // 1åˆ†é’Ÿ
    gcTime: 1000 * 60 * 5,        // 5åˆ†é’Ÿ
    retry: 1,
    refetchOnWindowFocus: false,  // çª—å£èšç„¦ä¸åˆ·æ–°
    refetchOnMount: true,         // æŒ‚è½½æ—¶æ£€æŸ¥è¿‡æœŸ
    refetchOnReconnect: true      // ç½‘ç»œé‡è¿æ—¶åˆ·æ–°
  }
}
```

**ä¸»åŠ¨å¤±æ•ˆ**:
```typescript
// å·¥å…·å‡½æ•°
export function useInvalidateConversations() {
  return {
    invalidateAll: () =>
      queryClient.invalidateQueries({ queryKey: conversationKeys.all }),
    invalidateList: () =>
      queryClient.invalidateQueries({ queryKey: conversationKeys.lists() }),
    invalidateDetail: (id) =>
      queryClient.invalidateQueries({ queryKey: conversationKeys.detail(id) })
  }
}
```

---

## æ•°æ®æµå¯è§†åŒ–

### å®Œæ•´èŠå¤©è¯·æ±‚æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯æ•°æ®æµ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·åœ¨ChatInputè¾“å…¥æ¶ˆæ¯
         â†“
useChatActions.sendMessage()
         â†“
åˆ›å»ºAbortController (ä¸­æ­¢æ§åˆ¶)
         â†“
fetch POST /api/chat (SSEè¯·æ±‚)
         â†“
processSSEStream() è§£æSSEäº‹ä»¶
         â†“
dispatch({ type: 'UPDATE_MESSAGE_STREAM' })
         â†“
ChatMessagesç»„ä»¶æ›´æ–°UI

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸­é—´ä»¶é“¾                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HTTPè¯·æ±‚åˆ°è¾¾
         â†“
middleware.ts::NextAuth JWTéªŒè¯
         â†“
middleware.ts::é€Ÿç‡é™åˆ¶æ£€æŸ¥
         â†“
middleware.ts::æ³¨å…¥ x-user-id å’Œ x-user-role
         â†“
è·¯ç”±åˆ° /api/chat/route.ts

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åç«¯å¤„ç†æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

/api/chat/route.ts::POST handler
         â†“
Zod SchemaéªŒè¯è¯·æ±‚æ•°æ®
         â†“
QuotaManager.reserveTokens() é¢„ç•™é…é¢
         â†“
trimForChatAPI() ä¸Šä¸‹æ–‡è£å‰ª
         â†“
ProviderManager.selectProvider() é€‰æ‹©AIæä¾›å•†
         â†“
è°ƒç”¨AIæœåŠ¡ (ZenMux/302.AI/Claudeç­‰)
         â†“
SSEæµå¼å“åº” (started â†’ chunk â†’ chunk â†’ done)
         â†“
handleStreamCompletion() æ¶ˆæ¯æŒä¹…åŒ–
         â†“
QuotaManager.commitTokens() æäº¤å®é™…ä½¿ç”¨é‡

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®åº“æ“ä½œ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

prisma.$transaction()
         â†“
åˆ›å»ºMessageè®°å½• (promptTokens + completionTokens)
         â†“
æ›´æ–°Conversationç»Ÿè®¡ (lastMessageAt, messageCount, totalTokens)
         â†“
æ›´æ–°Useré…é¢ (currentMonthUsage)
         â†“
åˆ›å»ºUsageStatsç»Ÿè®¡è®°å½•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç¼“å­˜åŒæ­¥                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

onSuccesså›è°ƒè§¦å‘
         â†“
queryClient.setQueriesData() æ›´æ–°åˆ—è¡¨ç¼“å­˜
         â†“
queryClient.invalidateQueries() å¤±æ•ˆè¯¦æƒ…ç¼“å­˜
         â†“
UIè‡ªåŠ¨é‡æ–°æ¸²æŸ“
```

---

## æœ€ä½³å®è·µå»ºè®®

### 1. æ•°æ®è·å–

**âœ… æ¨è**:
```typescript
// ç»Ÿä¸€ä½¿ç”¨React Queryç®¡ç†æœåŠ¡ç«¯çŠ¶æ€
const { data: conversations } = useConversationsQuery()

// å¤æ‚æœ¬åœ°çŠ¶æ€ä½¿ç”¨useReducer
const [state, dispatch] = useReducer(chatReducer, initialState)
```

**âŒ é¿å…**:
```typescript
// ä¸è¦æ··ç”¨fetchå’ŒReact Query
const [data, setData] = useState(null)
useEffect(() => {
  fetch('/api/xxx').then(res => setData(res))
}, [])
```

### 2. Propsä¼ é€’

**âœ… æ¨è**:
```typescript
// è¶…è¿‡3å±‚ä¼ é€’åº”ä½¿ç”¨Context
const ChatContext = createContext()

// åœ¨é¡¶å±‚æä¾›
<ChatContext.Provider value={chatState}>
  <ChatMessages />
</ChatContext.Provider>

// åœ¨å­ç»„ä»¶æ¶ˆè´¹
const { messages, send } = useContext(ChatContext)
```

**âŒ é¿å…**:
```typescript
// é¿å…æ·±å±‚Props drilling
<Parent>
  <Child onSend={onSend} onDelete={onDelete} ... />  // 8ä¸ªProps
</Parent>
```

### 3. ç¼“å­˜æ›´æ–°

**âœ… æ¨è**:
```typescript
// ä½¿ç”¨predicateåŒ¹é…æ‰€æœ‰ç›¸å…³æŸ¥è¯¢
queryClient.setQueriesData({
  predicate: (query) =>
    query.queryKey[0] === 'conversations' &&
    query.queryKey[1] === 'list'
}, updater)
```

**âŒ é¿å…**:
```typescript
// ç²¾ç¡®åŒ¹é…ä¼šæ¼æ‰å¸¦å‚æ•°çš„æŸ¥è¯¢
queryClient.setQueryData(['conversations', 'list'], updater)
```

### 4. é”™è¯¯å¤„ç†

**âœ… æ¨è**:
```typescript
// ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å·¥å…·
import { HttpResponse } from '@/lib/api/http-response'

return HttpResponse.error('é…é¢ä¸è¶³', {
  statusCode: 403,
  errorCode: 'QUOTA_EXCEEDED'
})
```

**âŒ é¿å…**:
```typescript
// ä¸è¦ç›´æ¥æŠ›å‡ºé”™è¯¯å­—ç¬¦ä¸²
return NextResponse.json({ error: 'Error' }, { status: 500 })
```

### 5. SSEæµå¼å¤„ç†

**âœ… æ¨è**:
```typescript
// ä½¿ç”¨ç»Ÿä¸€çš„SSEè§£æå™¨
import { processSSEStream } from '@/lib/utils/sse-parser'

const fullContent = await processSSEStream(reader, {
  onMessage: (message) => { /* å¤„ç†æ¶ˆæ¯ */ },
  onError: (error) => { /* é”™è¯¯å¤„ç† */ }
})
```

**âŒ é¿å…**:
```typescript
// ä¸è¦æ‰‹åŠ¨è§£æSSEæµ
const text = await reader.read()
const lines = text.split('\n')
// ... å®¹æ˜“å‡ºé”™çš„æ‰‹åŠ¨è§£æ
```

### 6. é…é¢ç®¡ç†

**âœ… æ¨è**:
```typescript
// ä½¿ç”¨QuotaManagerçš„åŸå­æ“ä½œ
const quotaResult = await QuotaManager.reserveTokens(userId, estimatedTokens)
if (!quotaResult.success) {
  return HttpResponse.error('é…é¢ä¸è¶³', { statusCode: 403 })
}

// å®Œæˆåæäº¤å®é™…ä½¿ç”¨é‡
await QuotaManager.commitTokens(userId, actualTokens, estimatedTokens)
```

**âŒ é¿å…**:
```typescript
// ä¸è¦ç›´æ¥æ›´æ–°é…é¢ï¼ˆå¯èƒ½å¯¼è‡´å¹¶å‘é—®é¢˜ï¼‰
await prisma.user.update({
  where: { id: userId },
  data: { currentMonthUsage: { increment: tokens } }
})
```

---

## æ€»ç»“

æ™ºç‚¹AIå¹³å°çš„æ•°æ®ä¼ é€’é“¾è®¾è®¡ä½“ç°äº†è‰¯å¥½çš„å·¥ç¨‹å®è·µï¼š

### ä¼˜åŠ¿
âœ… **åˆ†å±‚æ¸…æ™°**: å‰ç«¯ã€åç«¯ã€æ•°æ®åº“å„å±‚èŒè´£æ˜ç¡®
âœ… **ç»Ÿä¸€ç®¡ç†**: React Queryç»Ÿä¸€ç¼“å­˜ï¼ŒQuotaManagerç»Ÿä¸€é…é¢
âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶
âœ… **æ€§èƒ½ä¼˜åŒ–**: èŠ‚æµã€è™šæ‹Ÿæ»šåŠ¨ã€ç¼“å­˜ä¼˜åŒ–

### æ”¹è¿›ç©ºé—´
ğŸ”„ **æ•°æ®ç®¡ç†ä¸€è‡´æ€§**: ç»Ÿä¸€ä½¿ç”¨React Query
ğŸ”„ **Propsä¼ é€’ä¼˜åŒ–**: å¼•å…¥Contextå‡å°‘Props drilling
ğŸ”„ **ç›‘æ§å’Œå¯è§‚æµ‹æ€§**: å¢å¼ºæ—¥å¿—å’Œæ€§èƒ½ç›‘æ§

æ•´ä½“è€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯ã€ç»“æ„æ¸…æ™°çš„ä¼ä¸šçº§æ•°æ®ä¼ é€’æ¶æ„ã€‚
