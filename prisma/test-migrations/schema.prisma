generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// --- NextAuth required models (Account, Session, VerificationToken) and emailVerified on User ---
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_in        Int?    @map("expires_in")
  token_type        String? @map("token_type")
  scope             String?
  id_token          String? @map("id_token")
  session_state     String? @map("session_state")
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}


model User {
  id                String         @id @default(cuid())
  email             String         @unique
  emailVerified     DateTime?
  username          String?        @unique
  displayName       String?
  avatar            String?
  role              UserRole       @default(USER)
  status            UserStatus     @default(ACTIVE)
  monthlyTokenLimit Int            @default(100000)
  currentMonthUsage Int            @default(0)
  totalTokenUsed    Int            @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastActiveAt      DateTime?
  accounts          Account[]
  conversations     Conversation[]
  messages          Message[]
  sessions          Session[]
  usageStats        UsageStats[]
  userSessions      UserSession[]

  // 优化索引
  @@index([status])
  @@index([role])
  @@index([lastActiveAt])
  @@index([createdAt])
  @@map("users")
}

model Conversation {
  id            String    @id @default(cuid())
  title         String    @default("新对话")
  userId        String
  modelId       String    @default("gpt-3.5-turbo")
  temperature   Float     @default(0.7)
  maxTokens     Int       @default(2000)
  contextAware  Boolean   @default(true)
  messageCount  Int       @default(0)
  totalTokens   Int       @default(0)
  metadata      Json?     // JSON存储灵活元数据（固定、标签等）
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]

  // 优化索引
  @@index([userId, lastMessageAt(sort: Desc)])
  @@index([createdAt])
  @@index([modelId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id               String       @id @default(cuid())
  conversationId   String
  userId           String
  role             MessageRole
  content          String
  originalContent  String?
  promptTokens     Int          @default(0)
  completionTokens Int          @default(0)
  modelId          String
  temperature      Float?
  finishReason     String?
  metadata         Json?
  createdAt        DateTime     @default(now())
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([role, createdAt])
  @@index([userId, createdAt])
  @@index([userId, modelId, createdAt])
  @@map("messages")
}

model UsageStats {
  id                   String   @id @default(cuid())
  userId               String
  date                 DateTime
  modelId              String   @default("_total")
  modelProvider        String?
  apiCalls             Int      @default(0)
  successfulCalls      Int      @default(0)
  failedCalls          Int      @default(0)
  promptTokens         Int      @default(0)
  completionTokens     Int      @default(0)
  conversationsCreated Int      @default(0)
  messagesCreated      Int      @default(0)
  totalActiveTime      Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, modelId])
  @@index([date])
  @@index([userId, date])
  @@index([modelId, date])
  @@index([modelProvider, date])
  @@map("usage_stats")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  sessionId String   @unique
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  lastPing  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([lastPing])
  @@map("user_sessions")
}

model SystemConfig {
  id          String     @id @default(cuid())
  key         String     @unique
  value       String
  type        ConfigType @default(STRING)
  description String?
  category    String?    @default("general")
  isReadonly  Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("system_configs")
}

model MerchantCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  color       String?    @default("#6366f1")
  sortOrder   Int        @default(0)
  icon        String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  merchants   Merchant[]

  @@map("merchant_categories")
}

model Merchant {
  id                String            @id @default(cuid())
  uid               String            @unique
  name              String
  description       String?
  categoryId        String?
  location          String?
  address           String?
  contactInfo       Json?
  businessType      BusinessType      @default(B2C)
  totalDiggCount    Int               @default(0)
  totalCommentCount Int               @default(0)
  totalCollectCount Int               @default(0)
  totalShareCount   Int               @default(0)
  totalContentCount Int               @default(0)
  dataSource        String            @default("douyin")
  lastCollectedAt   DateTime?
  status            MerchantStatus    @default(ACTIVE)
  isVerified        Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  contents          MerchantContent[]
  category          MerchantCategory? @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([location])
  @@index([status])
  @@index([uid])
  @@map("merchants")
}

model MerchantContent {
  id                String      @id @default(cuid())
  merchantId        String
  externalId        String
  title             String
  content           String?
  transcript        String?
  contentType       ContentType @default(VIDEO)
  duration          String?
  shareUrl          String?
  hasTranscript     Boolean     @default(false)
  diggCount         Int         @default(0)
  commentCount      Int         @default(0)
  collectCount      Int         @default(0)
  shareCount        Int         @default(0)
  tags              String      @default("[]")
  textExtra         String      @default("[]")
  publishedAt       DateTime?
  collectedAt       DateTime
  externalCreatedAt DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  merchant          Merchant    @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([externalId, merchantId])
  @@index([merchantId, publishedAt])
  @@index([contentType])
  @@index([externalId])
  @@index([collectedAt])
  @@map("merchant_contents")
}

enum UserRole {
  ADMIN
  USER
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  FUNCTION
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

enum BusinessType {
  B2B
  B2C
  B2B2C
}

enum MerchantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ContentType {
  VIDEO
  ARTICLE
  IMAGE
  AUDIO
  OTHER
}
