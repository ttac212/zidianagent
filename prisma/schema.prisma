generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// --- NextAuth required models (Account, Session, VerificationToken) and emailVerified on User ---
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_in        Int?    @map("expires_in")
  token_type        String? @map("token_type")
  scope             String?
  id_token          String? @map("id_token")
  session_state     String? @map("session_state")
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}


model User {
  id                String         @id @default(cuid())
  email             String         @unique
  emailVerified     DateTime?
  username          String?        @unique
  displayName       String?
  avatar            String?
  role              UserRole       @default(USER)
  status            UserStatus     @default(ACTIVE)
  monthlyTokenLimit Int            @default(100000)
  currentMonthUsage Int            @default(0)
  totalTokenUsed    Int            @default(0)
  lastResetAt       DateTime?      // 上次配额重置时间
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastActiveAt      DateTime?
  accounts          Account[]
  conversations     Conversation[]
  messages          Message[]
  sessions          Session[]
  usageStats        UsageStats[]
  merchantMembers   MerchantMember[]

  // 优化索引
  @@index([status])
  @@index([role])
  @@index([lastActiveAt])
  @@index([createdAt])
  @@map("users")
}

model Conversation {
  id            String    @id @default(cuid())
  title         String    @default("新对话")
  userId        String
  modelId       String    @default("gpt-3.5-turbo")
  temperature   Float     @default(0.7)
  maxTokens     Int       @default(2000)
  contextAware  Boolean   @default(true)
  messageCount  Int       @default(0)
  totalTokens   Int       @default(0)
  metadata      Json?     // JSON存储灵活元数据（固定、标签等）
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]

  // 优化索引
  @@index([userId, lastMessageAt(sort: Desc)])
  @@index([createdAt])
  @@index([modelId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id               String       @id @default(cuid())
  conversationId   String
  userId           String
  role             MessageRole
  content          String
  originalContent  String?
  promptTokens     Int          @default(0)
  completionTokens Int          @default(0)
  modelId          String
  temperature      Float?
  finishReason     String?
  metadata         Json?
  createdAt        DateTime     @default(now())
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([role, createdAt])
  @@index([userId, createdAt])
  @@index([userId, modelId, createdAt])
  @@map("messages")
}

model UsageStats {
  id                   String   @id @default(cuid())
  userId               String
  date                 DateTime
  modelId              String   @default("_total")
  modelProvider        String?
  apiCalls             Int      @default(0)
  successfulCalls      Int      @default(0)
  failedCalls          Int      @default(0)
  promptTokens         Int      @default(0)
  completionTokens     Int      @default(0)
  conversationsCreated Int      @default(0)
  messagesCreated      Int      @default(0)
  totalActiveTime      Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, modelId])
  @@index([date])
  @@index([userId, date])
  @@index([modelId, date])
  @@index([modelProvider, date])
  @@map("usage_stats")
}

model MerchantCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  color       String?    @default("#6366f1")
  sortOrder   Int        @default(0)
  icon        String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  merchants   Merchant[]

  @@map("merchant_categories")
}

model Merchant {
  id                String            @id @default(cuid())
  uid               String            @unique
  name              String
  description       String?
  categoryId        String?
  location          String?
  address           String?
  contactInfo       Json?
  businessType      BusinessType      @default(B2C)
  totalDiggCount    Int               @default(0)
  totalCommentCount Int               @default(0)
  totalCollectCount Int               @default(0)
  totalShareCount   Int               @default(0)
  totalEngagement   Int               @default(0)
  totalContentCount Int               @default(0)
  // 新增字段
  followerCount     Int               @default(0)       // 粉丝数
  totalPlayCount    BigInt            @default(0)       // 总播放量
  avgEngagementRate Float?                              // 平均互动率
  dataSource        String            @default("douyin")
  lastCollectedAt   DateTime?
  // 自动监控配置
  monitoringEnabled   Boolean         @default(false)   // 是否启用自动同步
  syncIntervalSeconds Int             @default(21600)   // 同步间隔（秒），默认6小时
  nextSyncAt          DateTime?                         // 下次同步时间
  status            MerchantStatus    @default(ACTIVE)
  isVerified        Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  contents          MerchantContent[]
  category          MerchantCategory? @relation(fields: [categoryId], references: [id])
  profile           MerchantProfile?
  members           MerchantMember[]
  benchmarks        MerchantBenchmark[] @relation("MerchantBenchmarks")
  benchmarkedBy     MerchantBenchmark[] @relation("BenchmarkFor")

  @@index([categoryId])
  @@index([location])
  @@index([status])
  @@index([uid])
  @@index([monitoringEnabled, nextSyncAt])  // Cron任务查询优化
  @@map("merchants")
}

model MerchantContent {
  id                String                   @id @default(cuid())
  merchantId        String
  externalId        String
  title             String
  content           String?
  transcript        String?
  contentType       ContentType              @default(VIDEO)
  duration          String?
  shareUrl          String?
  hasTranscript     Boolean                  @default(false)
  diggCount         Int                      @default(0)
  commentCount      Int                      @default(0)
  collectCount      Int                      @default(0)
  shareCount        Int                      @default(0)
  // 新增字段
  playCount         Int                      @default(0)       // 播放量 ⭐ 关键指标
  forwardCount      Int                      @default(0)       // 转发数
  likeRate          Float?                                     // 点赞率 (diggCount/playCount)
  commentRate       Float?                                     // 评论率
  completionRate    Float?                                     // 完播率
  avgWatchDuration  Int?                                       // 平均观看时长(秒)
  // 刷量检测
  isSuspicious      Boolean                  @default(false)   // 疑似刷量
  suspiciousReason  String?                                    // 标记原因
  tags              String                   @default("[]")
  textExtra         String                   @default("[]")
  publishedAt       DateTime?
  collectedAt       DateTime
  externalCreatedAt DateTime?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  merchant          Merchant                 @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  comments          MerchantContentComment[]

  @@unique([externalId, merchantId])
  @@index([merchantId, publishedAt])
  @@index([merchantId, likeRate(sort: Desc)])  // 按真实互动率排序
  @@index([contentType])
  @@index([externalId])
  @@index([collectedAt])
  @@index([isSuspicious])
  @@map("merchant_contents")
}

// 商家内容评论表
model MerchantContentComment {
  id          String          @id @default(cuid())
  contentId   String          // 关联的内容ID
  externalId  String          @unique // 抖音评论ID (cid)
  text        String          // 评论文本
  authorName  String?         // 评论者昵称
  authorUid   String?         // 评论者UID
  diggCount   Int             @default(0) // 评论点赞数
  replyCount  Int             @default(0) // 回复数
  isTop       Boolean         @default(false) // 是否置顶
  keywords    String          @default("[]") // 关键词提取 (JSON数组)
  createdAt   DateTime        // 评论创建时间
  collectedAt DateTime        @default(now()) // 采集时间
  content     MerchantContent @relation(fields: [contentId], references: [id], onDelete: Cascade)

  @@index([contentId, diggCount(sort: Desc)]) // 按点赞数排序查询热门评论
  @@index([contentId, createdAt(sort: Desc)]) // 按时间排序查询最新评论
  @@map("merchant_content_comments")
}

enum UserRole {
  ADMIN
  USER
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  FUNCTION
}

enum BusinessType {
  B2B
  B2C
  B2B2C
}

enum MerchantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ContentType {
  VIDEO
  ARTICLE
  IMAGE
  AUDIO
  OTHER
}

model MerchantProfile {
  id         String   @id @default(cuid())
  merchantId String   @unique
  merchant   Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  // === PART 1: 商家Brief(创作简报) ===
  briefIntro           String? // 商家介绍(3句话:是谁、做什么、有什么特点)
  briefSellingPoints   String? // 核心卖点(JSON数组:3-5个产品卖点)
  briefUsageScenarios  String? // 使用场景和痛点(JSON数组)
  briefAudienceProfile String? // 目标用户画像(年龄、性别、兴趣、消费习惯)
  briefBrandTone       String? // 品牌调性(正经/搞笑/温情/专业 + 具体描述)

  // === PART 2: 爆款分析 ===
  topContentAnalysis String? // TOP10爆款分析(JSON: 标题、开头、情绪点、互动数据)
  goldenThreeSeconds String? // 黄金3秒开头建议(基于历史数据的有效开头模板)
  emotionalTriggers  String? // 情绪点分析(笑点/痛点/爽点的分布)
  contentFormats     String? // 内容形式偏好(口播/剧情/对比/教程的占比)

  // === PART 3: 创作指南 ===
  trendingTopics String? // 热门话题和标签(当前适合的热点)
  tagStrategy    String? // 标签组合策略(高效标签组合建议)
  publishingTips String? // 发布策略(最佳时段、内容频率,JSON格式)

  // === 元数据 ===
  aiGeneratedAt DateTime? // AI生成时间
  aiModelUsed   String?   // 使用的模型ID
  aiTokenUsed   Int       @default(0) // 消耗的token数

  // === 用户编辑部分(永久保留) ===
  customBackground     String? // 商家背景故事(老板、创业历程等)
  customOfflineInfo    String? // 线下信息(实体店、地理优势等)
  customProductDetails String? // 产品详细信息(AI不知道的细节)
  customDosAndDonts    String? // 禁忌清单和必强调点(禁忌词、必须提及的点)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId])
  @@map("merchant_profiles")
}

// 商家成员表 - 用于商家权限管理
model MerchantMember {
  id         String             @id @default(cuid())
  merchantId String
  userId     String
  role       MerchantMemberRole @default(EDITOR)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  merchant   Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([merchantId, userId])
  @@index([userId])
  @@index([merchantId])
  @@map("merchant_members")
}

enum MerchantMemberRole {
  OWNER  // 拥有者（完全控制权）
  ADMIN  // 管理员（可管理成员）
  EDITOR // 编辑者（可编辑内容）
  VIEWER // 查看者（只读权限）
}

// 商家对标账号关联表 - 多对多关系
model MerchantBenchmark {
  id          String   @id @default(cuid())
  merchantId  String   // 签约商家ID
  benchmarkId String   // 对标账号ID（也是Merchant）
  notes       String?  // 对标备注
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  merchant  Merchant @relation("MerchantBenchmarks", fields: [merchantId], references: [id], onDelete: Cascade)
  benchmark Merchant @relation("BenchmarkFor", fields: [benchmarkId], references: [id], onDelete: Cascade)

  @@unique([merchantId, benchmarkId])
  @@index([merchantId])
  @@index([benchmarkId])
  @@map("merchant_benchmarks")
}
