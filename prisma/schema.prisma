generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// --- NextAuth required models (Account, Session, VerificationToken) and emailVerified on User ---
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_in        Int?    @map("expires_in")
  token_type        String? @map("token_type")
  scope             String?
  id_token          String? @map("id_token")
  session_state     String? @map("session_state")
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model User {
  id                  String           @id @default(cuid())
  email               String           @unique
  emailVerified       DateTime?
  username            String?          @unique
  displayName         String?
  avatar              String?
  role                UserRole         @default(USER)
  status              UserStatus       @default(ACTIVE)
  monthlyTokenLimit   Int              @default(100000)
  currentMonthUsage   Int              @default(0)
  totalTokenUsed      Int              @default(0)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  lastActiveAt        DateTime?
  accounts            Account[]
  conversations       Conversation[]
  messages            Message[]
  sessions            Session[]
  usageStats          UsageStats[]
  userSessions        UserSession[]
  merchantMemberships MerchantMember[]

  // 优化索引
  @@index([status])
  @@index([role])
  @@index([lastActiveAt])
  @@index([createdAt])
  @@map("users")
}

model Conversation {
  id            String    @id @default(cuid())
  title         String    @default("新对话")
  userId        String
  modelId       String    @default("gpt-3.5-turbo")
  temperature   Float     @default(0.7)
  maxTokens     Int       @default(2000)
  contextAware  Boolean   @default(true)
  messageCount  Int       @default(0)
  totalTokens   Int       @default(0)
  metadata      Json? // JSON存储灵活元数据（固定、标签等）
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]

  // 优化索引
  @@index([userId, lastMessageAt(sort: Desc)])
  @@index([createdAt])
  @@index([modelId])
  @@index([updatedAt])
  @@map("conversations")
}

model Message {
  id               String       @id @default(cuid())
  conversationId   String
  userId           String
  role             MessageRole
  content          String
  originalContent  String?
  promptTokens     Int          @default(0)
  completionTokens Int          @default(0)
  modelId          String
  temperature      Float?
  finishReason     String?
  metadata         Json?
  createdAt        DateTime     @default(now())
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([role, createdAt])
  @@index([userId, createdAt])
  @@index([userId, modelId, createdAt])
  @@map("messages")
}

model UsageStats {
  id                   String   @id @default(cuid())
  userId               String
  date                 DateTime
  modelId              String   @default("_total")
  modelProvider        String?
  apiCalls             Int      @default(0)
  successfulCalls      Int      @default(0)
  failedCalls          Int      @default(0)
  promptTokens         Int      @default(0)
  completionTokens     Int      @default(0)
  conversationsCreated Int      @default(0)
  messagesCreated      Int      @default(0)
  totalActiveTime      Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, modelId])
  @@index([date])
  @@index([userId, date])
  @@index([modelId, date])
  @@index([modelProvider, date])
  @@map("usage_stats")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  sessionId String   @unique
  ipAddress String?
  userAgent String?
  isActive  Boolean  @default(true)
  lastPing  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([lastPing])
  @@map("user_sessions")
}

model SystemConfig {
  id          String     @id @default(cuid())
  key         String     @unique
  value       String
  type        ConfigType @default(STRING)
  description String?
  category    String?    @default("general")
  isReadonly  Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("system_configs")
}

model MerchantCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  color       String?    @default("#6366f1")
  sortOrder   Int        @default(0)
  icon        String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  merchants   Merchant[]

  @@map("merchant_categories")
}

model Merchant {
  id                String                @id @default(cuid())
  uid               String                @unique
  name              String
  description       String?
  categoryId        String?
  location          String?
  address           String?
  contactInfo       Json?
  businessType      BusinessType          @default(B2C)
  totalDiggCount    Int                   @default(0)
  totalCommentCount Int                   @default(0)
  totalCollectCount Int                   @default(0)
  totalShareCount   Int                   @default(0)
  totalContentCount Int                   @default(0)
  dataSource        String                @default("douyin")
  lastCollectedAt   DateTime?
  status            MerchantStatus        @default(ACTIVE)
  isVerified        Boolean               @default(false)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  contents          MerchantContent[]
  category          MerchantCategory?     @relation(fields: [categoryId], references: [id])
  members           MerchantMember[]
  promptAssets      MerchantPromptAsset[]
  referenceAssets   ReferenceAsset[]
  creativeBatches   CreativeBatch[]

  @@index([categoryId])
  @@index([location])
  @@index([status])
  @@index([uid])
  @@map("merchants")
}

model MerchantMember {
  id         String             @id @default(cuid())
  merchantId String
  userId     String
  role       MerchantMemberRole @default(EDITOR)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  merchant   Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([merchantId, userId], map: "merchant_member_unique")
  @@index([userId], map: "merchant_member_user_idx")
  @@map("merchant_members")
}

model MerchantContent {
  id                String      @id @default(cuid())
  merchantId        String
  externalId        String
  title             String
  content           String?
  transcript        String?
  contentType       ContentType @default(VIDEO)
  duration          String?
  shareUrl          String?
  hasTranscript     Boolean     @default(false)
  diggCount         Int         @default(0)
  commentCount      Int         @default(0)
  collectCount      Int         @default(0)
  shareCount        Int         @default(0)
  tags              String      @default("[]")
  textExtra         String      @default("[]")
  publishedAt       DateTime?
  collectedAt       DateTime
  externalCreatedAt DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  merchant          Merchant    @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([externalId, merchantId])
  @@index([merchantId, publishedAt])
  @@index([contentType])
  @@index([externalId])
  @@index([collectedAt])
  @@map("merchant_contents")
}

model MerchantPromptAsset {
  id               String                @id @default(cuid())
  merchantId       String
  type             PromptAssetType
  title            String
  version          Int
  parentId         String?
  content          String?
  referenceAssetId String?
  metadata         Json?
  isActive         Boolean               @default(false)
  createdBy        String
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  merchant         Merchant              @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  parent           MerchantPromptAsset?  @relation("PromptAssetParent", fields: [parentId], references: [id], onDelete: SetNull)
  children         MerchantPromptAsset[] @relation("PromptAssetParent")
  referenceAsset   ReferenceAsset?       @relation("PromptAssetAttachment", fields: [referenceAssetId], references: [id], onDelete: SetNull)
  batchLinks       CreativeBatchAsset[]  @relation("PromptAssetBatchLinks")

  @@unique([merchantId, type, version], map: "merchant_prompt_assets_type_version_key")
  @@index([merchantId, type, createdAt], map: "merchant_prompt_assets_type_created_idx")
  @@map("merchant_prompt_assets")
}

model ReferenceAsset {
  id               String                @id @default(cuid())
  merchantId       String
  kind             ReferenceKind
  sourceMeta       Json?
  originalText     String
  ocrText          String?
  summary          String?
  isDefaultEnabled Boolean               @default(true)
  createdBy        String
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  merchant         Merchant              @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  promptAssets     MerchantPromptAsset[] @relation("PromptAssetAttachment")
  batchLinks       CreativeBatchAsset[]  @relation("ReferenceAssetBatchLinks")

  @@index([merchantId, kind, createdAt], map: "reference_assets_kind_created_idx")
  @@map("reference_assets")
}

model CreativeBatch {
  id            String                @id @default(cuid())
  merchantId    String
  parentBatchId String?
  status        CreativeBatchStatus   @default(QUEUED)
  modelId       String                @default("claude-sonnet-4-5-20250929")
  statusVersion Int                   @default(1)
  startedAt     DateTime?
  completedAt   DateTime?
  triggeredBy   String
  errorCode     String?
  errorMessage  String?
  tokenUsage    Json?
  metadata      Json?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  archivedAt    DateTime?
  merchant      Merchant              @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  parent        CreativeBatch?        @relation("BatchParent", fields: [parentBatchId], references: [id], onDelete: SetNull)
  children      CreativeBatch[]       @relation("BatchParent")
  assets        CreativeBatchAsset[]
  copies        CreativeCopy[]
  exceptions    GenerationException[]

  @@index([merchantId, createdAt], map: "creative_batches_merchant_created_idx")
  @@index([status, createdAt], map: "creative_batches_status_created_idx")
  @@map("creative_batches")
}

model CreativeBatchAsset {
  id               String               @id @default(cuid())
  batchId          String
  role             CreativeAssetRole
  promptAssetId    String?
  referenceAssetId String?
  isEnabled        Boolean              @default(true)
  sortOrder        Int                  @default(0)
  batch            CreativeBatch        @relation(fields: [batchId], references: [id], onDelete: Cascade)
  promptAsset      MerchantPromptAsset? @relation("PromptAssetBatchLinks", fields: [promptAssetId], references: [id], onDelete: SetNull)
  referenceAsset   ReferenceAsset?      @relation("ReferenceAssetBatchLinks", fields: [referenceAssetId], references: [id], onDelete: SetNull)

  @@index([batchId, role, sortOrder], map: "creative_batch_assets_role_order_idx")
  @@index([promptAssetId], map: "creative_batch_assets_prompt_idx")
  @@index([referenceAssetId], map: "creative_batch_assets_reference_idx")
  @@map("creative_batch_assets")
}

model CreativeCopy {
  id                String                 @id @default(cuid())
  batchId           String
  sequence          Int                    // CHECK constraint: value must be between 1 and 5 (enforced at DB level)
  markdownContent   String
  rawModelOutput    Json?
  userOverride      String?
  state             CreativeCopyState      @default(DRAFT)
  regeneratedFromId String?
  editedBy          String?
  editedAt          DateTime?
  contentVersion    Int                    @default(1)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  batch             CreativeBatch          @relation(fields: [batchId], references: [id], onDelete: Cascade)
  regeneratedFrom   CreativeCopy?          @relation("CopyRegeneration", fields: [regeneratedFromId], references: [id], onDelete: SetNull)
  regenerations     CreativeCopy[]         @relation("CopyRegeneration")
  revisions         CreativeCopyRevision[]
  exceptions        GenerationException[]

  @@unique([batchId, sequence], map: "creative_copies_batch_sequence_unique")
  @@index([batchId, sequence], map: "creative_copies_batch_sequence_idx")
  @@index([regeneratedFromId], map: "creative_copies_regenerated_idx")
  @@map("creative_copies")
}

model CreativeCopyRevision {
  id        String         @id @default(cuid())
  copyId    String
  version   Int
  content   String
  source    RevisionSource
  note      String?
  createdBy String
  createdAt DateTime       @default(now())
  copy      CreativeCopy   @relation(fields: [copyId], references: [id], onDelete: Cascade)

  @@unique([copyId, version], map: "creative_copy_revisions_unique")
  @@map("creative_copy_revisions")
}

model GenerationException {
  id              String          @id @default(cuid())
  batchId         String
  copyId          String?
  errorCode       String?
  errorDetail     Json?
  requestPayload  Json?
  responsePayload Json?
  status          ExceptionStatus @default(OPEN)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  batch           CreativeBatch   @relation(fields: [batchId], references: [id], onDelete: Cascade)
  copy            CreativeCopy?   @relation(fields: [copyId], references: [id], onDelete: SetNull)

  @@index([batchId, status], map: "generation_exceptions_batch_status_idx")
  @@map("generation_exceptions")
}

enum UserRole {
  ADMIN
  USER
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
  FUNCTION
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

enum BusinessType {
  B2B
  B2C
  B2B2C
}

enum MerchantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum ContentType {
  VIDEO
  ARTICLE
  IMAGE
  AUDIO
  OTHER
}

enum MerchantMemberRole {
  OWNER
  EDITOR
  VIEWER
}

enum PromptAssetType {
  REPORT
  PROMPT
  ATTACHMENT
}

enum ReferenceKind {
  TOPIC
  BENCHMARK
  RAW_ATTACHMENT
}

enum CreativeBatchStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  PARTIAL_SUCCESS  // 部分成功：生成了 1-4 条文案，少于 5 条
  FAILED
  ARCHIVED
}

enum CreativeAssetRole {
  REPORT
  PROMPT
  ATTACHMENT
  TOPIC
  BENCHMARK
}

enum CreativeCopyState {
  DRAFT
  APPROVED
  REJECTED
}

enum RevisionSource {
  MODEL
  USER
}

enum ExceptionStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
}
