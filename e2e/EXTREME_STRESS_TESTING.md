# 300并发极限压力测试指南

## 📋 概述

基于深度项目调研设计的300并发极限压力测试框架，专门针对项目的架构特点和性能瓶颈进行优化。

## 🔍 架构调研发现

### 关键瓶颈
- **SQLite数据库**: 并发能力有限，是主要性能瓶颈
- **速率限制器**: AUTH API仅10 req/min，严格限制高频访问
- **内存存储**: 速率限制使用Map存储，高并发时压力大

### 有利条件
- **E2E模式优势**: Playwright自动跳过认证流程
- **中间件缓存**: 5分钟token缓存机制提升性能
- **Turbopack优化**: 开发环境编译速度提升

## 🚀 测试策略

### 分层压力测试设计
1. **Phase 1**: 静态资源极限并发 (避开数据库)
2. **Phase 2**: 健康检查API压力 (轻量级API)
3. **Phase 3**: 混合负载压力 (综合测试)

### 渐进式加压
- **安全模式**: 150并发，30 workers
- **标准模式**: 300并发，50 workers  
- **极限模式**: 300并发，100 workers

## ⚡ 快速开始

### 1. 安全测试 (推荐首次运行)
```bash
pnpm test:e2e:extreme:safe
```
- 150并发用户
- 30个worker进程
- 适合初次验证系统承载能力

### 2. 标准极限测试
```bash
pnpm test:e2e:extreme
```
- 300并发用户
- 50个worker进程
- 平衡性能和稳定性

### 3. 完整极限测试
```bash
pnpm test:e2e:extreme:full
```
- 300并发用户
- 100个worker进程
- 最大压力测试

### 4. 调试模式
```bash
pnpm test:e2e:extreme:debug
```
- 50并发用户
- 10个worker进程
- 支持调试和问题排查

## 📊 测试指标

### 性能指标
- **总操作数**: 所有并发用户的总请求数
- **成功率**: 成功操作 / 总操作数
- **响应时间**: 平均、最快、最慢响应时间
- **吞吐量**: 每秒处理的操作数
- **错误率**: 失败操作的比例和类型

### 系统资源监控
- **CPU使用率**: 实时和平均CPU占用
- **内存使用**: 堆内存使用情况
- **网络指标**: RPS和字节传输率
- **并发连接**: 活跃连接数

## 📈 结果解析

### 性能等级评估
- **🚀 优秀**: 成功率≥90%，平均响应时间<1000ms
- **✅ 良好**: 成功率≥75%，平均响应时间<3000ms  
- **⚠️ 一般**: 成功率≥60%，平均响应时间<5000ms
- **❌ 较差**: 低于一般标准，需要架构优化

### 瓶颈分析
系统自动检测：
- **CPU瓶颈**: 使用率>80%
- **内存瓶颈**: 使用率>85%
- **网络瓶颈**: 错误率>10%

## 🔧 优化建议

### 基于调研的架构优化
1. **数据库升级**: SQLite → PostgreSQL/MySQL
2. **缓存层**: 引入Redis缓存
3. **连接池**: 实施数据库连接池
4. **速率限制**: 调整或禁用开发环境限制

### 性能优化
1. **CDN部署**: 加速静态资源
2. **代码分割**: 减少首次加载时间
3. **懒加载**: 按需加载组件
4. **压缩优化**: Gzip/Brotli压缩

## 📁 文件结构

```
e2e/
├── extreme-stress.spec.ts           # 主测试文件
├── stress-monitor.ts                # 监控工具
├── EXTREME_STRESS_TESTING.md       # 说明文档
└── test-results/
    ├── extreme-stress-results.json # 测试结果
    └── extreme-stress-monitor-*.json # 监控报告
```

## ⚙️ 配置文件

### playwright-extreme.config.ts
专门的极限测试配置：
- 禁用截图、视频、追踪提升性能
- 优化浏览器启动参数
- 增加内存限制
- 仅使用Chromium减少资源消耗

### 环境变量
```bash
CONCURRENT_WORKERS=300    # 并发数
E2E_TEST_MODE=true       # E2E测试模式
PLAYWRIGHT_TEST=true     # Playwright标识
EXTREME_STRESS_MODE=true # 极限测试模式
```

## 🚨 注意事项

### 系统资源要求
- **内存**: 推荐16GB+
- **CPU**: 推荐8核+
- **磁盘**: SSD推荐，足够空间存储日志

### 测试环境
- 确保没有其他重负载程序运行
- 关闭不必要的浏览器窗口
- 监控系统资源使用情况

### 安全考虑
- 仅在开发/测试环境运行
- 不要在生产环境执行极限测试
- 测试后检查系统资源恢复情况

## 📊 示例输出

```
🔥 === 300并发极限压力测试总体报告 ===
并发测试用户: 300
总操作数: 15,420
成功操作: 13,156
失败操作: 2,264
整体成功率: 85.32%
平均响应时间: 2,145ms
错误总数: 89
系统性能评级: ✅ 良好 - 系统性能稳定
```

## 🤝 问题排查

### 常见问题
1. **内存不足**: 减少CONCURRENT_WORKERS数量
2. **端口冲突**: 确保3007端口可用
3. **超时错误**: 增加timeout设置
4. **权限错误**: 检查文件写入权限

### 调试技巧
1. 使用debug模式降低并发数
2. 查看test-results目录的详细日志
3. 监控系统资源使用情况
4. 逐步增加并发数定位问题

## 📚 相关文档

- [Playwright并发测试](https://playwright.dev/docs/test-parallel)
- [性能测试最佳实践](https://web.dev/performance/)
- [Node.js内存管理](https://nodejs.org/en/docs/guides/diagnostics/memory/)

---

**⚡ 极限压力测试框架 v1.0**  
*专为项目初期性能验证和瓶颈识别设计*