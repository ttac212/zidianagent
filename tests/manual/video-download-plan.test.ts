import { describe, expect, it } from 'vitest'

const DESIGN_NOTE = `å•è¯·æ±‚æ•´æ®µä¸‹è½½åœ¨å¤§æ–‡ä»¶ä¸æŠ–åŠ¨ç½‘ç»œä¸‹æµªè´¹å¸¦å®½ã€å†…å­˜ï¼›æœåŠ¡ç«¯å·²æ”¯æŒ Rangeï¼Œåˆ†å—å¹¶å‘+æµå¼å¤„ç†èƒ½æŠŠç“¶é¢ˆç æ‰ï¼Œè¿˜èƒ½ä¿æŒç°æœ‰æ¥å£å›é€€ï¼Œç¬¦åˆâ€œåˆ«ç ´åç”¨æˆ·ç©ºé—´â€ã€‚

ã€å…³é”®æ´å¯Ÿã€‘

- æ•°æ®ç»“æ„ï¼šVideoInfo åªæä¾› sizeï¼ŒChunkInfo å·²ç»å­˜åœ¨å´æ²¡è¢«ç®¡é“åˆ©ç”¨ï¼›videoBuffer/audioBuffer ä¸€æŠŠæŠ“åœ¨å†…å­˜é‡Œï¼Œæ˜¯å½“å‰æ€§èƒ½ç“¶é¢ˆã€‚
- å¤æ‚åº¦ï¼šä¸‹è½½è·¯å¾„å…¨å†™æ­»åœ¨ VideoProcessor.downloadChunk ä¸ runDouyinPipeline (lib/douyin/pipeline.ts:278 èµ·ã€app/api/douyin/extract-text/route.ts:98 èµ·)ï¼Œé€»è¾‘åˆ†æ”¯å°‘ä½†ç¼ºä¹å±‚æ¬¡ï¼Œå¯¼è‡´æ— æ³•åŒºåˆ†â€œè®¡åˆ’â€â€œä»»åŠ¡â€â€œç»“æœâ€ã€‚
- é£é™©ç‚¹ï¼šå¹¶å‘ Range è¦å°Šé‡æŠ–éŸ³ CDN çš„é™æµï¼›è‹¥æœåŠ¡å™¨å› 200ï¼ˆä¸æ”¯æŒ Rangeï¼‰ï¼Œç°æœ‰ downloadChunk ä¹Ÿå¾—ç»§ç»­å¯ç”¨ï¼›æµå¼æ”¹é€ ä¸èƒ½æ‰“ç¢ extractAudio ç°æœ‰ Buffer APIã€‚

ã€Linuså¼æ–¹æ¡ˆã€‘

1. å…ˆç®€åŒ–æ•°æ®ç»“æ„ï¼šæ–°å¢ VideoDownloadPlanï¼ˆè®°å½• chunk å¤§å°ã€å¹¶å‘ã€æ˜¯å¦æ”¯æŒ Rangeï¼‰ï¼ŒDownloadTaskï¼ˆindex/start/end/retryï¼‰ï¼Œç”¨å®ƒæ›¿æ¢æ»¡å¤©é£çš„è£¸å‚æ•°ï¼›è®© generateChunks æ”¯æŒæŒ‰ç…§ plan.chunkSize è¾“å‡ºå…ƒæ•°æ®ã€‚
2. æ¶ˆé™¤ç‰¹æ®Šæƒ…å†µï¼šåœ¨ getVideoInfo ä¹‹åé›†ä¸­åšä¸€æ¬¡èƒ½åŠ›æ¢æµ‹ï¼ˆHEADâ†’Range 0-0ï¼‰ï¼Œè®°ä¸‹ accept-rangesã€etagï¼›ä¸‹è½½æµç¨‹é‡Œåªæ ¹æ® plan.supportsRange åˆ†æˆâ€œå¤šæ®µâ€æˆ–â€œå•æ®µâ€ä¸¤æ¡æ¸…æ™°è·¯å¾„ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½å¡ ifã€‚
3. å®ç°æœ€ç¬¨ä½†æœ€æ¸…æ™°çš„æµæ°´çº¿ï¼š
   - é»˜è®¤ chunk 4MBï¼Œå¯é…ç½®ï¼›ç”¨è‡ªå†™ä»»åŠ¡æ± ï¼ˆé˜Ÿåˆ— + æœ€å¤š 4â€“5 ä¸ª workerï¼‰æ¨è¿› fetchï¼Œå¤±è´¥ä»»åŠ¡é‡è¯• 2 æ¬¡ï¼Œå…¨éƒ¨å¤±è´¥å†æŠ¥é”™ã€‚
   - æ¯ä¸ª chunk ä¸‹è½½å®Œç«‹å³å†™å…¥ chunks[index]ï¼Œæœ€åæŒ‰ index æ’åº Buffer.concat å¾—åˆ°å®Œæ•´è§†é¢‘ï¼›åŒæ—¶æä¾› downloadToStreamï¼Œç”¨ PassThrough æŒ‰åº push Bufferï¼Œç›´æ¥å–‚ç»™ createAudioExtractionStreamï¼Œé¿å…å·¨å‹ videoBufferã€‚
   - è®°å½•ä¸‹è½½è¿›åº¦ï¼ˆå­—èŠ‚ç´¯è®¡ï¼‰ï¼ŒæŠŠè¿›åº¦å›ä¼ ç»™ emitProgress æ›¿ä»£ç°åœ¨çš„å›ºå®šç™¾åˆ†æ¯”é­”æ•°ã€‚
4. ç¡®ä¿é›¶ç ´åï¼šä¿ç•™ç°æœ‰ downloadChunkï¼ˆç»™è€ä»£ç /å›é€€ç”¨ï¼‰ï¼Œå¯¹å¤–æ–°å¢ downloadVideoï¼ˆè¿”å› Bufferï¼‰å’Œ downloadVideoStreamï¼ˆè¿”å› Readableï¼‰ï¼›å½“æœåŠ¡å™¨ä¸æ”¯æŒ Range æˆ– chunk å¤±è´¥æ¬¡æ•°è¶…é™æ—¶è‡ªåŠ¨é™çº§åˆ°åŸå…ˆçš„æ•´æ®µä¸‹è½½ï¼Œæ¥å£è¡Œä¸ºä¸å˜ã€‚

ã€å“å‘³è¯„åˆ†ã€‘
ğŸŸ¡ å‡‘åˆ â€”â€” ä»£ç å¹²å‡€ä½†åœç•™åœ¨æœ€åŸºç¡€å®ç°ï¼Œæ²¡æŠŠå·²æœ‰çš„ ChunkInfo ç”¨èµ·æ¥ã€‚

ã€è‡´å‘½é—®é¢˜ã€‘

- VideoProcessor.downloadChunk (lib/video/video-processor.ts:272) æ¯æ¬¡éƒ½å¡ Range å¤´ï¼ŒæœåŠ¡ç«¯è‹¥åªå› 200 å°±æ•´æ®µä¸‹ï¼Œç»“æœè¿˜æ˜¯ä¸€æ¬¡æ€§å æ»¡å†…å­˜ï¼›runDouyinPipeline (lib/douyin/pipeline.ts:286) ä¸ extract-text è·¯ç”± (app/api/douyin/extract-text/route.ts:104) ç›´æ¥æŠŠæ•´ä¸ªè§†é¢‘æ‹‰è¿› Bufferï¼Œå‡ ç™¾ MB æ—¶ä¼šæŠŠ Node è¿›ç¨‹æ‹–æ­»ã€‚

ã€æ”¹è¿›æ–¹å‘ã€‘

- â€œæŠŠè¿™ä¸ªç‰¹æ®Šæƒ…å†µæ¶ˆé™¤æ‰â€ï¼šæŠŠ Range æ”¯æŒæ¢æµ‹ä¸‹æ²‰åˆ°ä¸‹è½½è®¡åˆ’é‡Œï¼Œä¸è¦åœ¨è°ƒç”¨ç‚¹é‡å¤ ifã€‚
- â€œè¿™10è¡Œå¯ä»¥å˜æˆ3è¡Œâ€ï¼šæŠŠ downloadâ†’concatâ†’extract è¿™å¥—æµç¨‹å°è£…æˆä¸€ä¸ª orchestrationï¼Œè®©è°ƒç”¨ä¾§åªå…³å¿ƒâ€œæˆ‘è¦ Buffer è¿˜æ˜¯æµâ€ã€‚
- â€œæ•°æ®ç»“æ„é”™äº†ï¼Œåº”è¯¥æ˜¯...â€ ç”¨ VideoDownloadPlan è¯´æ¸… chunk å¤§å°ã€å¹¶å‘ã€å›é€€ç­–ç•¥ï¼Œåˆ«å†å¾€å‡½æ•°é‡Œå¡ä¸€å¨è£¸å‚æ•°ã€‚`

describe.skip('video download refactor design guardrail', () => {
  it('ä¿ç•™è®¾è®¡æ‘˜è¦ï¼Œå¿…è¦æ—¶å¯ç”¨äºäººå·¥æ ¡éªŒ', () => {
    expect(DESIGN_NOTE).toContain('åˆ†å—å¹¶å‘+æµå¼å¤„ç†')
    expect(DESIGN_NOTE).toContain('VideoDownloadPlan')
  })
})
