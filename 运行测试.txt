PS D:\zdqidongxiangmu> npm run test:run

> my-zhidian-project@0.1.0 test:run
> vitest run


 RUN  v3.2.4 D:/zdqidongxiangmu

 âœ“ tests/workspace-fix.test.ts (1 test) 2ms
 âœ“ tests/auth.test.ts (1 test) 2ms
 âœ“ tests/middleware.test.ts (3 tests) 2ms
 âœ“ tests/chat/conversation-id-flow.test.ts (4 tests) 3ms
 âœ“ tests/chat/update-conversation-error-handling.test.ts (3 tests) 3ms
 âœ“ tests/chat/copy-functionality.test.ts (36 tests | 16 skipped) 7ms
stderr | tests/key-manager-refactor.test.ts > Key Manager é‡æ„éªŒè¯ > æœªçŸ¥æ¨¡å‹å¤„ç† > æ²¡æœ‰ä»»ä½• Key æ—¶åº”è¯¥è¿”å›ç©ºå­—ç¬¦ä¸²
[KeyManager] No API key found for model: unknown-model

stderr | tests/key-manager-refactor.test.ts > Key Manager é‡æ„éªŒè¯ > è¾¹ç•Œæƒ…å†µ > å¤§å°å†™æ•æ„ŸåŒ¹é…
[KeyManager] No API key found for model: Claude-opus

 âœ“ tests/chat/sse-error-lifecycle.test.ts (5 tests) 5ms
 âœ“ tests/lifecycle-metrics.test.ts (10 tests) 3ms
 âœ“ tests/key-manager-refactor.test.ts (15 tests) 4ms
 âœ“ tests/date-toolkit.test.ts (28 tests) 9ms
 âœ“ tests/chat/chat-reducer-pagination.test.ts (2 tests) 4ms
 âœ“ tests/batch-repositories.test.ts (7 tests) 83ms
 âœ“ tests/api-model-validation.test.ts (9 tests | 4 skipped) 138ms
stderr | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > ç­–ç•¥é€‰æ‹© > ç”Ÿäº§ç¯å¢ƒæ£€æµ‹åˆ° DEV_LOGIN_CODE åº”è¯¥è¿”å› å¤±è´¥ç­–ç•¥
âš ï¸  DEV_LOGIN_CODE detected in production environment!
âš ï¸  Remove DEV_LOGIN_CODE from production .env file

stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > å‡­è¯éªŒè¯ > ç¼ºå°‘ email åº”è¯¥è¿”å› null
[Auth] Missing credentials

stderr | tests/lifecycle-manager.test.ts > Lifecycle Manager - å®šæ—¶å™¨å›æ”¶æµ‹è¯• > ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨æ ¸å¿ƒåŠŸèƒ½ > æ¸…ç†å‡½æ•°æŠ›å‡ºé”™ è¯¯æ—¶åº”è¯¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ¸…ç†
[Lifecycle] Cleanup error: Error: Test error
    at D:\zdqidongxiangmu\tests\lifecycle-manager.test.ts:166:44
    at mockCall (file:///D:/zdqidongxiangmu/node_modules/.pnpm/@vitest+spy@3.2.4/node_modules/@vitest/spy/dist/index.js:96:15)
    at spy (file:///D:/zdqidongxiangmu/node_modules/.pnpm/tinyspy@4.0.3/node_modules/tinyspy/dist/index.js:47:103)
    at D:\zdqidongxiangmu\lib\lifecycle-manager.ts:100:9
    at Set.forEach (<anonymous>)
    at GlobalLifecycle.cleanup (D:\zdqidongxiangmu\lib\lifecycle-manager.ts:98:19)
    at D:\zdqidongxiangmu\tests\lifecycle-manager.test.ts:173:30
    at Proxy.assertThrows (file:///D:/zdqidongxiangmu/node_modules/.pnpm/chai@5.3.3/node_modules/chai/index.js:2767:5)
    at Proxy.methodWrapper (file:///D:/zdqidongxiangmu/node_modules/.pnpm/chai@5.3.3/node_modules/chai/index.js:1686:25)
    at Proxy.<anonymous> (file:///D:/zdqidongxiangmu/node_modules/.pnpm/@vitest+expect@3.2.4/node_modules/@vitest/expect/dist/index.js:1088:12)

stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > å‡­è¯éªŒè¯ > ç¼ºå°‘ code åº”è¯¥è¿”å› null
[Auth] Missing credentials

stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > å‡­è¯éªŒè¯ > æ— æ•ˆé‚®ç®±æ ¼å¼åº”è¯¥è¿”å› null
[DevAuth] Invalid email format

stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > å¼€å‘ç¯å¢ƒè®¤è¯è¡Œä¸º > é”™è¯¯çš„å¼€å‘ç åº”è¯¥å¤±è´¥
[DevAuth] Invalid dev code

 âœ“ tests/lifecycle-manager.test.ts (10 tests) 13ms
stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > å¼€å‘ç¯å¢ƒè®¤è¯è¡Œä¸º > ä¸å­˜åœ¨çš„ç”¨æˆ·åº”è¯¥è‡ªåŠ¨åˆ›å»º
[DevAuth] Creating new user: newuser@example.com

stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > ç”Ÿäº§ç¯å¢ƒè®¤è¯è¡Œä¸º > é”™è¯¯çš„å¯†ç åº”è¯¥å¤±è´¥
[ProdAuth] Invalid password

stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > ç”Ÿäº§ç¯å¢ƒè®¤è¯è¡Œä¸º > ä¸å­˜åœ¨çš„ç”¨æˆ·åº”è¯¥å¤±è´¥ï¼ˆä¸è‡ªåŠ¨åˆ› å»ºï¼‰
[ProdAuth] User not found: nonexistent@example.com

stderr | tests/security-critical.test.ts > å…³é”®å®‰å…¨æ£€æŸ¥ > æ¨¡å‹é…ç½®å®‰å…¨ > åº”è¯¥æœ‰åˆç†çš„ä¸Šä¸‹æ–‡çª—å£é…ç½®
[Config] Model gemini-2.5-pro configured tokens (992000) exceeds safe limit (500000)

stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > ç”Ÿäº§ç¯å¢ƒè®¤è¯è¡Œä¸º > æœªéªŒè¯é‚®ç®±çš„ç”¨æˆ·åº”è¯¥å¤±è´¥
[ProdAuth] Email not verified: user@example.com

stdout | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > ç”Ÿäº§ç¯å¢ƒè®¤è¯è¡Œä¸º > é ACTIVE çŠ¶æ€ç”¨æˆ·åº”è¯¥å¤±è´¥
[ProdAuth] User not active: user@example.com

 âœ“ tests/security-critical.test.ts (7 tests) 164ms
stderr | tests/auth-strategies-refactor.test.ts > Auth ç­–ç•¥é‡æ„éªŒè¯ > é”™è¯¯å¤„ç† > æ•°æ®åº“é”™è¯¯åº”è¯¥è¿”å› null
[DevAuth] Error: Error: Database error
    at D:\zdqidongxiangmu\tests\auth-strategies-refactor.test.ts:305:59
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at file:///D:/zdqidongxiangmu/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:752:20

 âœ“ tests/auth-strategies-refactor.test.ts (15 tests) 33ms
 âœ“ tests/http-response.test.ts (24 tests) 14ms
stderr | tests/api-chat-linus.test.ts > Linuså¼èŠå¤©APIé‡æ„æµ‹è¯• > POST /api/chat > åº”è¯¥éªŒè¯å•è¡¨å†™å…¥æ‰¿è¯º
[QuotaManager] Release failed - potential negative balance: userId=test-user-id, tokens=1000
[QuotaManager] Current usage: undefined

 âœ“ tests/api/creative-copies.test.ts (4 tests) 136ms
 âœ“ tests/api/creative-copy-regenerate.test.ts (2 tests) 138ms
 âœ“ tests/chat-hooks-refactor.test.ts (13 tests) 36ms
stdout | tests/lib/auth/merchant-access.test.ts > hasMerchantAccess - Permission Revocation > ensureMerchantMembership creates an owner record exactly once
prisma:error
Invalid `prisma.merchantMember.create()` invocation:


Unique constraint failed on the fields: (`merchantId`,`userId`)

 âœ“ tests/lib/auth/merchant-access.test.ts (7 tests) 44ms
 âœ“ tests/api/creative-batches.test.ts (5 tests) 174ms
stderr | tests/api-chat-linus.test.ts > Linuså¼èŠå¤©APIé‡æ„æµ‹è¯• > POST /api/chat > åº”è¯¥æ­£ç¡®å¤„ç†é…é¢è¶…é™
[QuotaManager] Reserve tokens failed: QuotaExceededError: æœˆåº¦é…é¢ä¸è¶³
    at D:\zdqidongxiangmu\lib\security\quota-manager.ts:69:19
    at Object.<anonymous> (D:\zdqidongxiangmu\tests\api-chat-linus.test.ts:244:16) {
  currentUsage: 95000,
  limit: 10000,
  requestedTokens: 1000
}

stdout | tests/api-chat-linus.test.ts > æ¶æ„ç®€åŒ–éªŒè¯ > æ–°APIåº”è¯¥æ¯”æ—§APIç®€æ´å¾—å¤š
ğŸ“Š ä»£ç ç®€åŒ–: 52.7% (393 â†’ 186 è¡Œ)

 âœ“ tests/api-chat-linus.test.ts (6 tests) 122ms

 Test Files  23 passed (23)
      Tests  197 passed | 20 skipped (217)
   Start at  18:30:00
   Duration  2.18s (transform 2.32s, setup 9.26s, collect 3.55s, tests 1.14s, environment 19.71s, prepare 3.65s)