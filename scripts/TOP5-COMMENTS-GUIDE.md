# TOP5视频评论采集脚本使用指南

## 📋 脚本列表

### 1. 预览脚本 - `preview-merchants-top5-status.ts`
**用途**：查看所有商家的TOP5评论数据采集状态，不执行实际采集

**使用方法**：
```bash
npx tsx scripts/preview-merchants-top5-status.ts
```

**输出示例**：
```
📦 1. 韶关装修可可         | 内容: 145 | TOP5:8 | 缺评论:0 | ✅ 已有数据
📦 2. 某某商家             | 内容:  89 | TOP5:7 | 缺评论:3 | ❌ 需要采集
```

---

### 2. 单商家采集脚本 - `enhance-top5-videos.ts`
**用途**：为指定商家采集TOP5视频评论（点赞/评论/互动评分）

**使用方法**：
```bash
npx tsx scripts/enhance-top5-videos.ts <商家ID>
```

**特点**：
- 自动去重TOP5视频
- 跳过已有评论的视频
- 每个视频采集100条评论
- 执行速度快（仅处理5-10个视频）

**示例**：
```bash
npx tsx scripts/enhance-top5-videos.ts cmh33vnos001awt3806ooqd3o
```

---

### 3. 批量采集脚本 - `batch-enhance-all-merchants.ts`
**用途**：批量处理所有商家的TOP5视频评论

**使用方法**：
```bash
npx tsx scripts/batch-enhance-all-merchants.ts
```

**特点**：
- 自动遍历所有商家
- 跳过已有评论数据的商家
- 显示详细进度和统计
- 自动限流（商家间延迟3秒，视频间延迟2秒）

**输出示例**：
```
╔══════════════════════════════════════════════════╗
║   批量采集所有商家TOP5视频评论数据              ║
╚══════════════════════════════════════════════════╝

🔌 连接TikHub API...
✅ API连接成功

📋 查询商家列表...
找到 15 个商家

进度: [1/15]
====================================================================
📦 商家: 韶关装修可可
   总内容数: 145
====================================================================
   ✅ 所有TOP5视频已有评论数据，跳过

进度: [2/15]
====================================================================
📦 商家: 某某商家
   总内容数: 89
====================================================================
   找到 3 个视频需要采集评论

   [1/3] [LIKES]
      视频标题...
      ID: 7510180005852122418
      ✅ 成功采集 100 条评论
   ...

   📊 统计: 成功 3/3, 采集 280 条评论
```

---

### 4. 验证脚本 - `verify-top5-comments.ts`
**用途**：验证指定商家的TOP5 API数据结构

**使用方法**：
```bash
npx tsx scripts/verify-top5-comments.ts
```

**输出**：显示点赞TOP5、评论TOP5、互动评分TOP5的评论数据情况

---

## 📖 推荐使用流程

### 方式1：先预览，再批量处理
```bash
# 1. 查看哪些商家需要采集
npx tsx scripts/preview-merchants-top5-status.ts

# 2. 批量处理所有商家
npx tsx scripts/batch-enhance-all-merchants.ts
```

### 方式2：单个商家处理
```bash
# 为特定商家采集TOP5评论
npx tsx scripts/enhance-top5-videos.ts <商家ID>
```

---

## ⚠️ 注意事项

1. **API限流**：
   - TikHub API有速率限制
   - 脚本已内置延迟保护（视频间2秒，商家间3秒）
   - 建议分批处理大量商家

2. **数据去重**：
   - 脚本自动跳过已有评论的视频
   - 重复运行是安全的

3. **环境变量**：
   - 确保 `.env.local` 中配置了 `TIKHUB_API_KEY`
   - API密钥需要有足够的配额

4. **执行时间**：
   - 单商家：约1-2分钟（5个视频）
   - 批量处理：取决于商家数量（10个商家约20-30分钟）

---

## 📊 数据说明

### TOP5分类
脚本会采集三个维度的TOP5视频：
1. **点赞TOP5**：按 `diggCount` 排序
2. **评论TOP5**：按 `commentCount` 排序
3. **互动评分TOP5**：按综合评分排序
   - 公式：`点赞×1 + 评论×2 + 收藏×3 + 分享×4`

### 评论数量
- 每个视频采集最多100条评论
- 按点赞数排序（热门评论优先）

### 刷量检测
脚本会自动检测疑似刷量视频，并标记：
- `isSuspicious`: 是否疑似刷量
- `suspiciousReason`: 刷量原因说明

---

## 🛠️ 故障排查

### 错误：TikHub API key is required
```bash
# 解决方案：检查环境变量
cat .env.local | grep TIKHUB_API_KEY
```

### 错误：Bad Request
- 可能原因：视频已删除或不可访问
- 脚本会自动跳过失败的视频

### 评论数量少于100
- 正常现象：该视频的评论总数不足100条
- 脚本会采集所有可用评论

---

## 📝 日志说明

### 成功标记
- ✅ 成功采集
- ✓ 已有数据（跳过）

### 错误标记
- ❌ 采集失败
- ⚠️ 警告信息

### 统计信息
- 📊 数据统计
- 💬 评论数量
- 📦 商家信息
